import{j as e}from"./ui-CuzVkv4o.js";import{r as x}from"./vendor-Dit9F4CM.js";import{s as D,C,a as P,u as I,b as T,B as y,R as O,P as U}from"./index-BhmEvnf0.js";import{u as G}from"./useGames-B21QXS2f.js";import{U as _}from"./UnifiedGameCard-CwU5LYci.js";import{S as n}from"./skeleton-DkMKzT_z.js";import"./useMutation-BqTsTPA3.js";import"./ImageWithFallback-Ba8Vz0S_.js";import"./useGameJoinToggle-QoOJ0--0.js";import"./dateUtils-But3d3jk.js";import"./calendar-ByY_J1PI.js";import"./map-pin-qWmmcoik.js";import"./users-e7lhM7WU.js";function R(){const[w,h]=x.useState([]),[u,i]=x.useState(0),[k,m]=x.useState(!0),[S,f]=x.useState(null);return x.useEffect(()=>{let o,p,l;return(async()=>{try{l=setTimeout(()=>{console.warn("Presence initialization timeout - WebSocket connection failed"),m(!1),f("Connection failed"),h([{id:"1",name:"Player 1",avatar:"",lastSeen:new Date().toISOString()},{id:"2",name:"Player 2",avatar:"",lastSeen:new Date().toISOString()},{id:"3",name:"Player 3",avatar:"",lastSeen:new Date().toISOString()}]),i(3)},3e3);const{data:{user:d}}=await D.auth.getUser();if(!d){clearTimeout(l),m(!1),h([{id:"1",name:"Demo User 1",avatar:"",lastSeen:new Date().toISOString()},{id:"2",name:"Demo User 2",avatar:"",lastSeen:new Date().toISOString()}]),i(2);return}const{data:r}=await D.from("users").select("full_name, username, avatar_url").eq("id",d.id).single();try{o=D.channel("online-users",{config:{presence:{key:d.id}}})}catch(a){console.error("Failed to create presence channel:",a),clearTimeout(l),m(!1),f("Connection failed"),h([{id:"1",name:"Offline User 1",avatar:"",lastSeen:new Date().toISOString()},{id:"2",name:"Offline User 2",avatar:"",lastSeen:new Date().toISOString()}]),i(2);return}o.on("presence",{event:"sync"},()=>{try{const a=o.presenceState();console.log("Presence sync:",a);const c=Object.keys(a).map(s=>{const t=a[s][0];return{id:s,name:t.name||"Anonymous",avatar:t.avatar,lastSeen:new Date().toISOString()}});console.log("Online users:",c),h(c),i(c.length),m(!1)}catch(a){console.error("Presence sync error:",a),m(!1)}}).on("presence",{event:"join"},({key:a,newPresences:c})=>{console.log("User joined:",a,c)}).on("presence",{event:"leave"},({key:a,leftPresences:c})=>{console.log("User left:",a,c)}),await o.subscribe(async a=>{console.log("Presence subscription status:",a),a==="SUBSCRIBED"?(clearTimeout(l),await o.track({user_id:d.id,name:r?.full_name||r?.username||"Anonymous",avatar:r?.avatar_url,online_at:new Date().toISOString()}),p=setInterval(async()=>{try{await o.track({user_id:d.id,name:r?.full_name||r?.username||"Anonymous",avatar:r?.avatar_url,online_at:new Date().toISOString()})}catch(c){console.error("Presence heartbeat error:",c)}},6e4)):a==="CHANNEL_ERROR"&&(clearTimeout(l),f("Presence channel error"),m(!1))})}catch(d){console.error("Failed to initialize presence:",d),clearTimeout(l),f("Failed to initialize presence system"),m(!1)}})(),()=>{l&&clearTimeout(l),p&&clearInterval(p),o&&o.unsubscribe()}},[]),{onlineUsers:w,onlineCount:u,isLoading:k,error:S}}function A(){return e.jsx(C,{className:"w-full",children:e.jsx(P,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(n,{className:"h-5 w-3/4"}),e.jsx(n,{className:"h-4 w-1/2"})]}),e.jsx(n,{className:"h-8 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{className:"h-4 w-4"}),e.jsx(n,{className:"h-4 w-2/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{className:"h-4 w-4"}),e.jsx(n,{className:"h-4 w-1/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{className:"h-4 w-4"}),e.jsx(n,{className:"h-4 w-1/4"})]})]}),e.jsx(n,{className:"h-4 w-full"}),e.jsx(n,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx(n,{className:"h-6 w-20"}),e.jsx(n,{className:"h-8 w-16"})]})]})})})}function V(){const w=I(),{user:h}=T(),{data:u=[],isLoading:i,error:k,refetch:m}=G(),[S,f]=x.useState(!1),[o,p]=x.useState(!1);x.useMemo(()=>h?.preferences?.sports??[],[h]);const{onlineCount:l,isLoading:b}=R(),d=s=>{w(`/game/${s}`)},r=x.useMemo(()=>{const s=new Date,t=new Date(s);t.setDate(s.getDate()-s.getDay()),t.setHours(0,0,0,0);const g=new Date(t);g.setDate(t.getDate()+6),g.setHours(23,59,59,999);const N=u.filter(v=>{const j=new Date(v.date);return j>=t&&j<=g}).length;return{totalGames:u.length,thisWeekGames:N,onlinePlayers:l}},[u,l]),a=async()=>{if(!S){p(!1),f(!0);try{await m()}finally{f(!1)}}},c=u.map(s=>{const t=new Date(s.date),g=new Date,N=new Date(g);N.setDate(N.getDate()+1);let v="future",j=t.getTime();return t.toDateString()===g.toDateString()?(v="today",j=0):t.toDateString()===N.toDateString()&&(v="tomorrow",j=1),{...s,category:v,sortOrder:j,gameDate:t}}).sort((s,t)=>s.sortOrder!==t.sortOrder?s.sortOrder-t.sortOrder:s.gameDate.getTime()-t.gameDate.getTime());return i&&u.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading games..."})]})}):o&&u.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Connection issues detected. Showing sample games."}),e.jsxs(y,{onClick:a,variant:"outline",children:[e.jsx(O,{className:"w-4 h-4 mr-2"})," Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"TribeUp"}),e.jsx("p",{className:"text-muted-foreground",children:"Find your next game"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(y,{onClick:()=>w("/create-game"),className:"bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Create Game"]})})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Upcoming Games"}),e.jsxs(y,{variant:"outline",size:"sm",onClick:a,disabled:i,className:"hidden md:flex",children:[e.jsx(O,{className:`w-4 h-4 mr-2 ${i?"animate-spin":""}`}),"Refresh"]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:a,disabled:i,className:"md:hidden","aria-label":"Refresh games",children:e.jsx(O,{className:`w-4 h-4 ${i?"animate-spin":""}`})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:i?Array.from({length:6}).map((s,t)=>e.jsx(A,{},t)):c.map(s=>e.jsx("div",{children:e.jsx(_,{game:s,variant:"simple",onSelect:()=>d(s.id)})},s.id))})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-4",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 sticky top-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Quick Stats"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Games"}),e.jsx("span",{className:"font-semibold",children:r.totalGames})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Players Online"}),e.jsx("span",{className:"font-semibold",children:b?"...":r.onlinePlayers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"This Week"}),e.jsx("span",{className:"font-semibold",children:r.thisWeekGames})]})]})]})}),e.jsx("div",{className:"lg:col-span-4 space-y-6",children:e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-1 gap-4",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:b?"...":r.onlinePlayers}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Players Online"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:r.thisWeekGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"This Week"})]})]})})]})})})}export{V as default};
//# sourceMappingURL=HomeScreen-BTk1J7VO.js.map
