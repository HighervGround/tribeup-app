{"version":3,"file":"useGames-Dqy-33SO.js","sources":["../../src/hooks/useGames.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { SupabaseService } from '../lib/supabaseService';\nimport { useAppStore } from '../store/appStore';\nimport { toast } from 'sonner';\n\n// Query keys\nexport const gameKeys = {\n  all: ['games'] as const,\n  lists: () => [...gameKeys.all, 'list'] as const,\n  list: (filters: Record<string, any>) => [...gameKeys.lists(), { filters }] as const,\n  details: () => [...gameKeys.all, 'detail'] as const,\n  detail: (id: string) => [...gameKeys.details(), id] as const,\n  participants: (id: string) => [...gameKeys.detail(id), 'participants'] as const,\n};\n\n// Hook for fetching games\nexport function useGames() {\n  const { user } = useAppStore();\n  \n  return useQuery({\n    queryKey: gameKeys.lists(),\n    queryFn: async () => {\n      console.log('üîç Fetching games with React Query');\n      const games = await SupabaseService.getGames();\n      console.log('‚úÖ Games fetched:', games.length);\n      return games;\n    },\n    staleTime: 2 * 60 * 1000, // 2 minutes\n    gcTime: 5 * 60 * 1000, // 5 minutes (was cacheTime in v4)\n    enabled: !!user, // Only fetch when user is authenticated\n  });\n}\n\n// Hook for fetching a single game\nexport function useGame(gameId: string) {\n  return useQuery({\n    queryKey: gameKeys.detail(gameId),\n    queryFn: async () => {\n      return await SupabaseService.getGameById(gameId);\n    },\n    enabled: !!gameId,\n  });\n}\n\n// Hook for fetching game participants\nexport function useGameParticipants(gameId: string) {\n  return useQuery({\n    queryKey: gameKeys.participants(gameId),\n    queryFn: () => SupabaseService.getGameParticipants(gameId),\n    enabled: !!gameId,\n    staleTime: 1 * 60 * 1000, // 1 minute\n  });\n}\n\n// Hook for joining a game\nexport function useJoinGame() {\n  const queryClient = useQueryClient();\n  const { user } = useAppStore();\n\n  return useMutation({\n    mutationFn: async (gameId: string) => {\n      console.log('üîß Joining game:', gameId);\n      await SupabaseService.joinGame(gameId);\n    },\n    onMutate: async (gameId) => {\n      // Cancel outgoing refetches for all related queries\n      await queryClient.cancelQueries({ queryKey: gameKeys.lists() });\n      await queryClient.cancelQueries({ queryKey: gameKeys.detail(gameId) });\n      await queryClient.cancelQueries({ queryKey: gameKeys.participants(gameId) });\n      \n      // Snapshot previous values\n      const previousGames = queryClient.getQueryData(gameKeys.lists());\n      const previousGame = queryClient.getQueryData(gameKeys.detail(gameId));\n      const previousParticipants = queryClient.getQueryData(gameKeys.participants(gameId));\n      \n      // Optimistically update games list\n      queryClient.setQueryData(gameKeys.lists(), (old: any) => {\n        if (!old) return old;\n        return old.map((game: any) => \n          game.id === gameId \n            ? { \n                ...game, \n                isJoined: true, \n                currentPlayers: Math.min(game.currentPlayers + 1, game.maxPlayers)\n              }\n            : game\n        );\n      });\n\n      // Optimistically update game detail\n      queryClient.setQueryData(gameKeys.detail(gameId), (old: any) => {\n        if (!old) return old;\n        return {\n          ...old,\n          isJoined: true,\n          currentPlayers: Math.min(old.currentPlayers + 1, old.maxPlayers)\n        };\n      });\n\n      // Optimistically update participants list\n      if (user) {\n        queryClient.setQueryData(gameKeys.participants(gameId), (old: any) => {\n          if (!old) return [{ id: user.id, name: user.name, avatar: user.avatar }];\n          const isAlreadyJoined = old.some((p: any) => p.id === user.id);\n          if (isAlreadyJoined) return old;\n          return [...old, { id: user.id, name: user.name, avatar: user.avatar }];\n        });\n      }\n      \n      return { previousGames, previousGame, previousParticipants };\n    },\n    onError: (error, gameId, context) => {\n      console.error('‚ùå Join game error:', error);\n      \n      // Rollback on error\n      if (context?.previousGames) {\n        queryClient.setQueryData(gameKeys.lists(), context.previousGames);\n      }\n      if (context?.previousGame) {\n        queryClient.setQueryData(gameKeys.detail(gameId), context.previousGame);\n      }\n      if (context?.previousParticipants) {\n        queryClient.setQueryData(gameKeys.participants(gameId), context.previousParticipants);\n      }\n      \n      toast.error('Failed to join game', {\n        description: 'Please try again later',\n      });\n    },\n    onSuccess: (_, gameId) => {\n      console.log('‚úÖ Successfully joined game:', gameId);\n      \n      // Force refetch to ensure UI is updated with latest data\n      queryClient.refetchQueries({ queryKey: gameKeys.detail(gameId) });\n      queryClient.refetchQueries({ queryKey: gameKeys.participants(gameId) });\n      queryClient.refetchQueries({ queryKey: gameKeys.lists() });\n      \n      // Also invalidate to mark as stale\n      queryClient.invalidateQueries({ queryKey: gameKeys.detail(gameId) });\n      queryClient.invalidateQueries({ queryKey: gameKeys.participants(gameId) });\n      queryClient.invalidateQueries({ queryKey: gameKeys.lists() });\n      \n      // Toast removed - components handle their own success feedback\n    },\n  });\n}\n\n// Hook for leaving a game\nexport function useLeaveGame() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (gameId: string) => {\n      console.log('üîß Leaving game:', gameId);\n      await SupabaseService.leaveGame(gameId);\n    },\n    onMutate: async (gameId) => {\n      // Cancel outgoing refetches for all related queries\n      await queryClient.cancelQueries({ queryKey: gameKeys.lists() });\n      await queryClient.cancelQueries({ queryKey: gameKeys.detail(gameId) });\n      await queryClient.cancelQueries({ queryKey: gameKeys.participants(gameId) });\n      \n      // Snapshot previous values\n      const previousGames = queryClient.getQueryData(gameKeys.lists());\n      const previousGame = queryClient.getQueryData(gameKeys.detail(gameId));\n      const previousParticipants = queryClient.getQueryData(gameKeys.participants(gameId));\n      \n      // Optimistically update games list\n      queryClient.setQueryData(gameKeys.lists(), (old: any) => {\n        if (!old) return old;\n        return old.map((game: any) => \n          game.id === gameId \n            ? { \n                ...game, \n                isJoined: false, \n                currentPlayers: Math.max(game.currentPlayers - 1, 0)\n              }\n            : game\n        );\n      });\n\n      // Optimistically update game detail\n      queryClient.setQueryData(gameKeys.detail(gameId), (old: any) => {\n        if (!old) return old;\n        return {\n          ...old,\n          isJoined: false,\n          currentPlayers: Math.max(old.currentPlayers - 1, 0)\n        };\n      });\n\n      // Optimistically update participants list by removing current user\n      const { user } = useAppStore.getState();\n      if (user) {\n        queryClient.setQueryData(gameKeys.participants(gameId), (old: any) => {\n          if (!old) return [];\n          return old.filter((p: any) => p.id !== user.id);\n        });\n      }\n      \n      return { previousGames, previousGame, previousParticipants };\n    },\n    onError: (error, gameId, context) => {\n      console.error('‚ùå Leave game error:', error);\n      \n      // Rollback on error\n      if (context?.previousGames) {\n        queryClient.setQueryData(gameKeys.lists(), context.previousGames);\n      }\n      if (context?.previousGame) {\n        queryClient.setQueryData(gameKeys.detail(gameId), context.previousGame);\n      }\n      if (context?.previousParticipants) {\n        queryClient.setQueryData(gameKeys.participants(gameId), context.previousParticipants);\n      }\n      \n      toast.error('Failed to leave game', {\n        description: 'Please try again later',\n      });\n    },\n    onSuccess: (_, gameId) => {\n      console.log('‚úÖ Successfully left game:', gameId);\n      \n      // Force refetch to ensure UI is updated with latest data\n      queryClient.refetchQueries({ queryKey: gameKeys.detail(gameId) });\n      queryClient.refetchQueries({ queryKey: gameKeys.participants(gameId) });\n      queryClient.refetchQueries({ queryKey: gameKeys.lists() });\n      \n      // Also invalidate to mark as stale\n      queryClient.invalidateQueries({ queryKey: gameKeys.detail(gameId) });\n      queryClient.invalidateQueries({ queryKey: gameKeys.participants(gameId) });\n      queryClient.invalidateQueries({ queryKey: gameKeys.lists() });\n      \n      // Toast removed - components handle their own success feedback\n    },\n  });\n}\n\n// Hook for creating a game\nexport function useCreateGame() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (gameData: any) => {\n      console.log('üîß Creating game:', gameData);\n      return await SupabaseService.createGame(gameData);\n    },\n    onSuccess: (newGame) => {\n      console.log('‚úÖ Game created successfully:', newGame.id);\n      \n      // Invalidate games list to refetch\n      queryClient.invalidateQueries({ queryKey: gameKeys.lists() });\n      \n      toast.success('Game created!', {\n        description: 'Your game is now live',\n      });\n    },\n    onError: (error) => {\n      console.error('‚ùå Create game error:', error);\n      \n      toast.error('Failed to create game', {\n        description: 'Please try again later',\n      });\n    },\n  });\n}\n"],"names":["gameKeys","filters","id","useGames","user","useAppStore","useQuery","games","SupabaseService","useGame","gameId","useGameParticipants","useJoinGame","queryClient","useQueryClient","useMutation","previousGames","previousGame","previousParticipants","old","game","p","error","context","toast","_","useLeaveGame"],"mappings":"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"}