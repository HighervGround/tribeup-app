import{j as e}from"./ui-Bqrh-KgM.js";import{r as s,e as a}from"./vendor-CVaDA-xz.js";import{u as t,s as n,C as r,a as i,B as l}from"./index-DY_-g0lH.js";import{a as c,R as o,P as d}from"./utils-CfrcxnCJ.js";import{u as m}from"./useGames-DXf6rKqX.js";import{U as u}from"./UnifiedGameCard-iUmRfKcf.js";import{S as x}from"./skeleton-BoseYTwL.js";import"./data-D6RrWw63.js";import"./ImageWithFallback-B7gg3TPo.js";import"./useGameJoinToggle-3UeAyFpa.js";import"./dateUtils-DKSG3jUc.js";const h=c(e=>({onlineUsers:{},channelStatus:"closed",usePolling:!1,isLoading:!0,error:null,setOnlineUsers:s=>e({onlineUsers:s}),setChannelStatus:s=>e({channelStatus:s}),setUsePolling:s=>e({usePolling:s}),setLoading:s=>e({isLoading:s}),setError:s=>e({error:s})}));function g(){const{user:e}=t(),{onlineUsers:a,channelStatus:r,usePolling:i,isLoading:l,error:c,setOnlineUsers:o,setChannelStatus:d,setUsePolling:m,setLoading:u,setError:x}=h(),g=s.useRef(null),j=s.useRef(null),f=async()=>{if(g.current)return;m(!0);const s=async()=>{try{if(!e?.id)return;await n.from("user_presence").upsert({user_id:e.id,name:e.name,avatar:e.avatar,last_seen:(new Date).toISOString(),is_online:!0});const{data:s}=await n.from("user_presence").select("*").gte("last_seen",new Date(Date.now()-3e5).toISOString());if(s){const e={};s.forEach(s=>{e[s.user_id]={user_id:s.user_id,name:s.name||"Anonymous",avatar:s.avatar||"",last_seen:s.last_seen,status:"online"}}),o(e),x(null)}}catch(s){x("Polling failed")}};await s(),g.current=window.setInterval(s,3e4)},p=()=>{g.current&&(window.clearInterval(g.current),g.current=null),m(!1)};return s.useEffect(()=>{if(!e?.id)return u(!1),void o({});u(!0);try{(()=>{if(!e?.id)return;const s=n.channel("global-presence",{config:{presence:{key:e.id}}});j.current=s,s.on("presence",{event:"sync"},()=>{const e=s.presenceState(),a=Object.keys(e).reduce((s,a)=>{const t=e[a][0];return s[a]={user_id:a,name:t.name||"Anonymous",avatar:t.avatar||"",last_seen:(new Date).toISOString(),status:"online"},s},{});o(a),u(!1),x(null)}).on("presence",{event:"join"},({key:e,newPresences:s})=>{}).on("presence",{event:"leave"},({key:e,leftPresences:s})=>{}).subscribe(async a=>{"SUBSCRIBED"===a?(d("joined"),p(),await s.track({name:e.name,avatar:e.avatar,online_at:(new Date).toISOString()}),await n.from("user_presence").upsert({user_id:e.id,name:e.name,avatar:e.avatar,last_seen:(new Date).toISOString(),is_online:!0})):"CHANNEL_ERROR"===a?(d("error"),x("Realtime connection failed"),f()):"CLOSED"===a?(d("closed"),f()):d("joining")})})()}catch(s){f()}return()=>{j.current&&j.current.unsubscribe(),p(),d("closed")}},[e?.id]),{onlineUsers:Object.values(a),onlineCount:Object.keys(a).length,isLoading:l,error:c,isRealtime:"joined"===r,isPolling:i,connectionStatus:r}}function j(){return e.jsx(r,{className:"w-full",children:e.jsx(i,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(x,{className:"h-5 w-3/4"}),e.jsx(x,{className:"h-4 w-1/2"})]}),e.jsx(x,{className:"h-8 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-4 w-4"}),e.jsx(x,{className:"h-4 w-2/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-4 w-4"}),e.jsx(x,{className:"h-4 w-1/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-4 w-4"}),e.jsx(x,{className:"h-4 w-1/4"})]})]}),e.jsx(x,{className:"h-4 w-full"}),e.jsx(x,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx(x,{className:"h-6 w-20"}),e.jsx(x,{className:"h-8 w-16"})]})]})})})}function f(){const n=a(),{user:r}=t(),{data:i=[],isLoading:c,error:x,refetch:h}=m(),[f,p]=s.useState(!1),[N,v]=s.useState(!1);s.useMemo(()=>r?.preferences?.sports??[],[r]);const{onlineCount:w,isLoading:b}=g(),y=s.useMemo(()=>{const e=new Date,s=new Date(e);s.setDate(e.getDate()-e.getDay()),s.setHours(0,0,0,0);const a=new Date(s);a.setDate(s.getDate()+6),a.setHours(23,59,59,999);const t=i.filter(e=>{const t=new Date(e.date);return t>=s&&t<=a}).length;return{totalGames:i.length,thisWeekGames:t,onlinePlayers:w}},[i,w]),S=async()=>{if(!f){v(!1),p(!0);try{await h()}finally{p(!1)}}},D=i.map(e=>{const s=new Date(e.date),a=new Date,t=new Date(a);t.setDate(t.getDate()+1);let n="future",r=s.getTime();return s.toDateString()===a.toDateString()?(n="today",r=0):s.toDateString()===t.toDateString()&&(n="tomorrow",r=1),{...e,category:n,sortOrder:r,gameDate:s}}).sort((e,s)=>e.sortOrder!==s.sortOrder?e.sortOrder-s.sortOrder:e.gameDate.getTime()-s.gameDate.getTime());return c&&0===i.length?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading games..."})]})}):N&&0===i.length?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Connection issues detected. Showing sample games."}),e.jsxs(l,{onClick:S,variant:"outline",children:[e.jsx(o,{className:"w-4 h-4 mr-2"})," Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"TribeUp"}),e.jsx("p",{className:"text-muted-foreground",children:"Find your next game"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(l,{onClick:()=>n("/create-game"),className:"bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"Create Game"]})})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Upcoming Games"}),e.jsxs(l,{variant:"outline",size:"sm",onClick:S,disabled:c,className:"hidden md:flex",children:[e.jsx(o,{className:"w-4 h-4 mr-2 "+(c?"animate-spin":"")}),"Refresh"]}),e.jsx(l,{variant:"ghost",size:"sm",onClick:S,disabled:c,className:"md:hidden","aria-label":"Refresh games",children:e.jsx(o,{className:"w-4 h-4 "+(c?"animate-spin":"")})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:c?Array.from({length:6}).map((s,a)=>e.jsx(j,{},a)):D.map(s=>e.jsx("div",{children:e.jsx(u,{game:s,variant:"simple",onSelect:()=>{return e=s.id,void n(`/game/${e}`);var e}})},s.id))})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-4",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 sticky top-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Quick Stats"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Games"}),e.jsx("span",{className:"font-semibold",children:y.totalGames})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Players Online"}),e.jsx("span",{className:"font-semibold",children:b?"...":y.onlinePlayers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"This Week"}),e.jsx("span",{className:"font-semibold",children:y.thisWeekGames})]})]})]})}),e.jsx("div",{className:"lg:col-span-4 space-y-6",children:e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-1 gap-4",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:b?"...":y.onlinePlayers}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Players Online"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:y.thisWeekGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"This Week"})]})]})})]})})})}export{f as default};
//# sourceMappingURL=HomeScreen-DadnCdyn.js.map
