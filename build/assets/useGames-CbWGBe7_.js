import{u as e,d as t,e as a}from"./data-BwpJIDKS.js";import{r}from"./vendor-CVaDA-xz.js";import{u as s,S as i}from"./index-C1rAQj-O.js";import{t as o}from"./utils-e0hEqRVR.js";class n{static CORRUPTION_MARKERS={LAST_SUCCESSFUL_LOAD:"tribeup_last_successful_load",CORRUPTION_COUNT:"tribeup_corruption_count",FORCE_CLEAN_FLAG:"tribeup_force_clean",APP_VERSION:"tribeup_app_version"};static MAX_CORRUPTION_COUNT=3;static CORRUPTION_TIMEOUT=3e4;static CURRENT_VERSION="1.0.0";static async detectCorruption(){const e={hasForceCleanFlag:this.hasForceCleanFlag(),hasVersionMismatch:this.hasVersionMismatch(),hasRepeatedFailures:this.hasRepeatedFailures(),hasStaleAuthTokens:await this.hasStaleAuthTokens(),hasCorruptedStorage:this.hasCorruptedStorage()},t=Object.values(e).some(Boolean);return t?this.incrementCorruptionCount():this.resetCorruptionCount(),t}static async cleanAllCaches(){try{Object.keys(localStorage).forEach(e=>{(e.startsWith("supabase")||e.startsWith("tribeup")||e.startsWith("sb-"))&&localStorage.removeItem(e)}),sessionStorage.clear();try{if("indexedDB"in window){const t=["supabase-cache","workbox-precache","tribeup-cache"];for(const a of t)try{indexedDB.deleteDatabase(a)}catch(e){}}}catch(e){}if("caches"in window)try{const e=await caches.keys();await Promise.all(e.map(async e=>{await caches.delete(e)}))}catch(e){}if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map(async e=>{await e.unregister()}))}catch(e){}this.markSuccessfulLoad(),this.setAppVersion()}catch(t){throw t}}static hasForceCleanFlag(){return"true"===localStorage.getItem(this.CORRUPTION_MARKERS.FORCE_CLEAN_FLAG)}static hasVersionMismatch(){const e=localStorage.getItem(this.CORRUPTION_MARKERS.APP_VERSION);return null!==e&&e!==this.CURRENT_VERSION}static hasRepeatedFailures(){return parseInt(localStorage.getItem(this.CORRUPTION_MARKERS.CORRUPTION_COUNT)||"0")>=this.MAX_CORRUPTION_COUNT}static async hasStaleAuthTokens(){try{const t=Object.keys(localStorage).filter(e=>e.startsWith("supabase")||e.startsWith("sb-"));for(const a of t){const t=localStorage.getItem(a);if(t)try{const e=JSON.parse(t);if(e.access_token&&"string"!=typeof e.access_token)return!0;if(e.expires_at&&isNaN(new Date(1e3*e.expires_at).getTime()))return!0}catch(e){return!0}}return!1}catch(t){return!0}}static hasCorruptedStorage(){try{const e="tribeup_storage_test",t="test_value_"+Date.now();localStorage.setItem(e,t);const a=localStorage.getItem(e);return localStorage.removeItem(e),a!==t}catch(e){return!0}}static markSuccessfulLoad(){localStorage.setItem(this.CORRUPTION_MARKERS.LAST_SUCCESSFUL_LOAD,Date.now().toString())}static setAppVersion(){localStorage.setItem(this.CORRUPTION_MARKERS.APP_VERSION,this.CURRENT_VERSION)}static incrementCorruptionCount(){const e=parseInt(localStorage.getItem(this.CORRUPTION_MARKERS.CORRUPTION_COUNT)||"0");localStorage.setItem(this.CORRUPTION_MARKERS.CORRUPTION_COUNT,(e+1).toString())}static resetCorruptionCount(){localStorage.removeItem(this.CORRUPTION_MARKERS.CORRUPTION_COUNT)}static forceCleanOnNextLoad(){localStorage.setItem(this.CORRUPTION_MARKERS.FORCE_CLEAN_FLAG,"true")}static clearForceCleanFlag(){localStorage.removeItem(this.CORRUPTION_MARKERS.FORCE_CLEAN_FLAG)}static async autoDetectAndClean(){return!!(await this.detectCorruption())&&(await this.cleanAllCaches(),this.clearForceCleanFlag(),!0)}}"undefined"!=typeof window&&(window.cacheCorruptionDetector=n,window.forceCleanCache=()=>n.forceCleanOnNextLoad());const c={all:["games"],lists:()=>[...c.all,"list"],list:e=>[...c.lists(),{filters:e}],details:()=>[...c.all,"detail"],detail:e=>[...c.details(),e],participants:e=>[...c.detail(e),"participants"]};function u(){const{user:a}=s(),u=e();return r.useEffect(()=>{u.removeQueries({queryKey:c.lists(),predicate:e=>e.isStale()}),u.invalidateQueries({queryKey:c.lists()})},[a?.id,u]),t({queryKey:c.lists(),queryFn:async()=>{const e=performance.now();try{const e=await i.getGames();performance.now();return e}catch(t){performance.now();if((t instanceof Error?t.message:String(t))?.includes("timeout")){const e=parseInt(sessionStorage.getItem("tribeup_timeout_count")||"0")+1;sessionStorage.setItem("tribeup_timeout_count",e.toString()),e>=2&&(n.forceCleanOnNextLoad(),o.error("Loading issues detected",{description:"Refreshing to clear corrupted cache...",duration:3e3}),setTimeout(()=>{window.location.reload()},3e3))}throw t}},staleTime:12e4,gcTime:3e5,retry:(e,t)=>!(t.message?.includes("timeout")&&e>=1)&&(!t.message?.includes("JWT")&&!t.message?.includes("auth")&&e<2),retryDelay:e=>Math.min(1e3*Math.pow(2,e),5e3),refetchOnMount:!1,refetchOnWindowFocus:!1,refetchOnReconnect:!0,meta:{errorMessage:"Failed to load games. Please refresh the page."}})}function l(e){return t({queryKey:c.detail(e),queryFn:async()=>await i.getGameById(e),enabled:!!e,staleTime:12e4,gcTime:3e5,retry:3,retryDelay:e=>Math.min(1e3*2**e,3e4),meta:{errorMessage:"Failed to load game details"}})}function p(e){return t({queryKey:c.participants(e),queryFn:async()=>await i.getGameParticipants(e),enabled:!!e,staleTime:6e4,gcTime:3e5,retry:3,retryDelay:e=>Math.min(1e3*2**e,3e4),meta:{errorMessage:"Failed to load game participants"}})}function m(){const t=e(),{user:r}=s();return a({mutationFn:async e=>{await i.joinGame(e)},onMutate:async e=>{await t.cancelQueries({queryKey:c.lists()}),await t.cancelQueries({queryKey:c.detail(e)}),await t.cancelQueries({queryKey:c.participants(e)});const a=t.getQueryData(c.lists()),s=t.getQueryData(c.detail(e)),i=t.getQueryData(c.participants(e));return t.setQueryData(c.lists(),t=>t?t.map(t=>t.id===e?{...t,isJoined:!0,currentPlayers:Math.min(t.currentPlayers+1,t.maxPlayers)}:t):t),t.setQueryData(c.detail(e),e=>e?{...e,isJoined:!0,currentPlayers:Math.min(e.currentPlayers+1,e.maxPlayers)}:e),r&&t.setQueryData(c.participants(e),e=>{if(!e)return[{id:r.id,name:r.name,avatar:r.avatar}];return e.some(e=>e.id===r.id)?e:[...e,{id:r.id,name:r.name,avatar:r.avatar}]}),{previousGames:a,previousGame:s,previousParticipants:i}},onError:(e,a,r)=>{r?.previousGames&&t.setQueryData(c.lists(),r.previousGames),r?.previousGame&&t.setQueryData(c.detail(a),r.previousGame),r?.previousParticipants&&t.setQueryData(c.participants(a),r.previousParticipants),o.error("Failed to join game",{description:"Please try again later"})},onSuccess:(e,a)=>{t.invalidateQueries({queryKey:c.detail(a)}),t.invalidateQueries({queryKey:c.participants(a)}),t.invalidateQueries({queryKey:c.lists()})}})}function y(){const t=e();return a({mutationFn:async e=>{await i.leaveGame(e)},onMutate:async e=>{await t.cancelQueries({queryKey:c.lists()}),await t.cancelQueries({queryKey:c.detail(e)}),await t.cancelQueries({queryKey:c.participants(e)});const a=t.getQueryData(c.lists()),r=t.getQueryData(c.detail(e)),i=t.getQueryData(c.participants(e));t.setQueryData(c.lists(),t=>t?t.map(t=>t.id===e?{...t,isJoined:!1,currentPlayers:Math.max(t.currentPlayers-1,0)}:t):t),t.setQueryData(c.detail(e),e=>e?{...e,isJoined:!1,currentPlayers:Math.max(e.currentPlayers-1,0)}:e);const{user:o}=s.getState();return o&&t.setQueryData(c.participants(e),e=>e?e.filter(e=>e.id!==o.id):[]),{previousGames:a,previousGame:r,previousParticipants:i}},onError:(e,a,r)=>{r?.previousGames&&t.setQueryData(c.lists(),r.previousGames),r?.previousGame&&t.setQueryData(c.detail(a),r.previousGame),r?.previousParticipants&&t.setQueryData(c.participants(a),r.previousParticipants),o.error("Failed to leave game",{description:"Please try again later"})},onSuccess:(e,a)=>{t.invalidateQueries({queryKey:c.detail(a)}),t.invalidateQueries({queryKey:c.participants(a)}),t.invalidateQueries({queryKey:c.lists()})}})}export{l as a,p as b,m as c,y as d,c as g,u};
//# sourceMappingURL=useGames-CbWGBe7_.js.map
