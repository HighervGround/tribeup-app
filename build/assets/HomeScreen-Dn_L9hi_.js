import{j as e}from"./ui-CuzVkv4o.js";import{r as m}from"./vendor-Dit9F4CM.js";import{s as k,C as P,a as G,u as T,b as U,B as b,R as O,P as _}from"./index-RcbufgnR.js";import{u as I}from"./useGames-CR7Qf6lm.js";import{U as R}from"./UnifiedGameCard-VbcnQ8Zg.js";import{S as r}from"./skeleton-Ti8LYYOv.js";import"./useMutation-BCOebnYM.js";import"./ImageWithFallback-Ba8Vz0S_.js";import"./useGameJoinToggle-DTdg_KEM.js";import"./dateUtils-But3d3jk.js";import"./calendar-CmJEM6gn.js";import"./map-pin-CHKzuRIh.js";import"./users-BTv1k2s6.js";function A(){const[w,h]=m.useState([]),[x,l]=m.useState(0),[C,u]=m.useState(!0),[S,g]=m.useState(null);return m.useEffect(()=>{let c,p,o;return(async()=>{try{o=setTimeout(()=>{console.warn("Presence initialization timeout"),u(!1),g("Failed to connect to presence system"),h([{id:"1",name:"Player 1",avatar:"",lastSeen:new Date().toISOString()},{id:"2",name:"Player 2",avatar:"",lastSeen:new Date().toISOString()}]),l(2)},5e3);const{data:{user:d}}=await k.auth.getUser();if(!d){clearTimeout(o),u(!1),h([{id:"1",name:"Demo User 1",avatar:"",lastSeen:new Date().toISOString()},{id:"2",name:"Demo User 2",avatar:"",lastSeen:new Date().toISOString()}]),l(2);return}const{data:n}=await k.from("users").select("full_name, username, avatar_url").eq("id",d.id).single();c=k.channel("online_users",{config:{presence:{key:d.id}}}),c.on("presence",{event:"sync"},()=>{try{const a=c.presenceState();console.log("Presence sync:",a);const i=Object.keys(a).map(y=>{const s=a[y][0];return{id:y,name:s.name||"Anonymous",avatar:s.avatar,lastSeen:new Date().toISOString()}});console.log("Online users:",i),h(i),l(i.length),u(!1)}catch(a){console.error("Presence sync error:",a),u(!1)}}).on("presence",{event:"join"},({key:a,newPresences:i})=>{console.log("User joined:",a,i)}).on("presence",{event:"leave"},({key:a,leftPresences:i})=>{console.log("User left:",a,i)}),await c.subscribe(async a=>{console.log("Presence subscription status:",a),a==="SUBSCRIBED"?(clearTimeout(o),await c.track({user_id:d.id,name:n?.full_name||n?.username||"Anonymous",avatar:n?.avatar_url,online_at:new Date().toISOString()}),p=setInterval(async()=>{try{await c.track({user_id:d.id,name:n?.full_name||n?.username||"Anonymous",avatar:n?.avatar_url,online_at:new Date().toISOString()})}catch(i){console.error("Presence heartbeat error:",i)}},6e4)):a==="CHANNEL_ERROR"&&(clearTimeout(o),g("Presence channel error"),u(!1))})}catch(d){console.error("Failed to initialize presence:",d),clearTimeout(o),g("Failed to initialize presence system"),u(!1)}})(),()=>{o&&clearTimeout(o),p&&clearInterval(p),c&&c.unsubscribe()}},[]),{onlineUsers:w,onlineCount:x,isLoading:C,error:S}}function z(){return e.jsx(P,{className:"w-full",children:e.jsx(G,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(r,{className:"h-5 w-3/4"}),e.jsx(r,{className:"h-4 w-1/2"})]}),e.jsx(r,{className:"h-8 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4"}),e.jsx(r,{className:"h-4 w-2/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4"}),e.jsx(r,{className:"h-4 w-1/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4"}),e.jsx(r,{className:"h-4 w-1/4"})]})]}),e.jsx(r,{className:"h-4 w-full"}),e.jsx(r,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx(r,{className:"h-6 w-20"}),e.jsx(r,{className:"h-8 w-16"})]})]})})})}function X(){const w=T(),{user:h}=U(),{data:x=[],isLoading:l,error:C,refetch:u}=I(),[S,g]=m.useState(!1),[c,p]=m.useState(!1);m.useMemo(()=>h?.preferences?.sports??[],[h]);const{onlineCount:o,isLoading:D}=A(),d=s=>{w(`/game/${s}`)},n=m.useMemo(()=>{const s=new Date,t=new Date(s);t.setDate(s.getDate()-s.getDay()),t.setHours(0,0,0,0);const f=new Date(t);f.setDate(t.getDate()+6),f.setHours(23,59,59,999);const N=x.filter(v=>{const j=new Date(v.date);return j>=t&&j<=f}).length;return{totalGames:x.length,thisWeekGames:N,onlinePlayers:o}},[x,o]),a=async()=>{if(!S){p(!1),g(!0);try{await u()}finally{g(!1)}}},i=()=>{w("/create")},y=x.map(s=>{const t=new Date(s.date),f=new Date,N=new Date(f);N.setDate(N.getDate()+1);let v="future",j=t.getTime();return t.toDateString()===f.toDateString()?(v="today",j=0):t.toDateString()===N.toDateString()&&(v="tomorrow",j=1),{...s,category:v,sortOrder:j,gameDate:t}}).sort((s,t)=>s.sortOrder!==t.sortOrder?s.sortOrder-t.sortOrder:s.gameDate.getTime()-t.gameDate.getTime());return l&&x.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading games..."})]})}):c&&x.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Connection issues detected. Showing sample games."}),e.jsxs(b,{onClick:a,variant:"outline",children:[e.jsx(O,{className:"w-4 h-4 mr-2"})," Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"TribeUp"}),e.jsx("p",{className:"text-muted-foreground",children:"Find your next game"})]}),e.jsx(b,{onClick:i,size:"icon",className:"md:hidden","aria-label":"Create new game",children:e.jsx(_,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6 lg:hidden",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:n.totalGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Active Games"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:D?"...":n.onlinePlayers}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Players Online"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:n.thisWeekGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"This Week"})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Upcoming Games"}),e.jsxs(b,{variant:"outline",size:"sm",onClick:a,disabled:l,className:"hidden md:flex",children:[e.jsx(O,{className:`w-4 h-4 mr-2 ${l?"animate-spin":""}`}),"Refresh"]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:a,disabled:l,className:"md:hidden","aria-label":"Refresh games",children:e.jsx(O,{className:`w-4 h-4 ${l?"animate-spin":""}`})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:l?Array.from({length:6}).map((s,t)=>e.jsx(z,{},t)):y.map(s=>e.jsx("div",{children:e.jsx(R,{game:s,variant:"simple",onSelect:()=>d(s.id)})},s.id))})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-4",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 sticky top-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Quick Stats"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Games"}),e.jsx("span",{className:"font-semibold",children:n.totalGames})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Players Online"}),e.jsx("span",{className:"font-semibold",children:D?"...":n.onlinePlayers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"This Week"}),e.jsx("span",{className:"font-semibold",children:n.thisWeekGames})]})]})]})})]})})})}export{X as default};
//# sourceMappingURL=HomeScreen-Dn_L9hi_.js.map
