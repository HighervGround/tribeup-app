Project Path: src

Source Tree:

```txt
src
‚îú‚îÄ‚îÄ domains
‚îÇ   ‚îú‚îÄ‚îÄ games
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ActivityLikeButton.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ActivityMapPreview.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AttendeeList.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CampusEmptyState.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CreateGame.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CreateRecurringGame.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ EnhancedGameChat.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GameCardSkeleton.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GameChat.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GameDetails.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ HomeScreen.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ InviteModal.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ NoGamesFound.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PostGameRatingModal.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PublicGamePage.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ QuickJoinModal.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RSVPSection.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SearchDiscovery.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ShareGameModal.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SportPicker.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ UnifiedGameCard.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ WaitlistManager.tsx
‚îÇ   ‚îú‚îÄ‚îÄ locations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ EnhancedMapView.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GoogleMapView.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ InteractiveRoutePlanner.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ LocationPermissionModal.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ LocationPicker.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ MapView.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RouteDisplayMap.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ VenueRatingModal.tsx
‚îÇ   ‚îú‚îÄ‚îÄ tribes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CreateTribe.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeCard.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeChat.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeDetail.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeEdit.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeGames.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeList.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TribeMembers.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TribeStatistics.tsx
‚îÇ   ‚îú‚îÄ‚îÄ users
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AccessibilitySettings.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AccountDeletionSection.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AchievementBadge.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AchievementNotification.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AchievementProgressIndicator.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AchievementScore.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DataExportSection.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EditProfile.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FeedbackButton.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FeedbackPage.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FriendList.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InviteFriends.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LeaderboardPage.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationSettings.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Onboarding.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OnboardingGameBrowse.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OnboardingGameCreate.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OtherUserProfile.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlayerCard.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Settings.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SimplePhotoUpload.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SimpleSurvey.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserProfile.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserTestingSurvey.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pages
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AchievementsPage.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ FollowersPage.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ FollowingPage.tsx
‚îÇ   ‚îî‚îÄ‚îÄ weather
‚îÇ       ‚îî‚îÄ‚îÄ components
‚îÇ           ‚îî‚îÄ‚îÄ WeatherWidget.tsx
‚îú‚îÄ‚îÄ pages
‚îÇ   ‚îú‚îÄ‚îÄ AuthCallback.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DesignSystemShowcase.tsx
‚îÇ   ‚îú‚îÄ‚îÄ PublicHomeScreen.tsx
‚îÇ   ‚îî‚îÄ‚îÄ PublicHomeScreen_old.tsx
‚îî‚îÄ‚îÄ shared
    ‚îî‚îÄ‚îÄ components
        ‚îú‚îÄ‚îÄ common
        ‚îÇ   ‚îú‚îÄ‚îÄ AdminDashboard.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ CacheClearButton.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ CalendarIntegration.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ ConfirmDeleteModal.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ DesignSystem.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ EmptyState.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ ErrorBoundary.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ FloatingActionButton.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ NavigationTest.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ NetworkStatus.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ NotificationCenter.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ OAuthPerformanceMonitor.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ OnlinePlayersWidget.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ QueryErrorBoundary.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ RouteTracker.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ SimpleCalendarButton.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ avatar-stack.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ chat-message.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ current-user-avatar.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ realtime-avatar-stack.tsx
        ‚îÇ   ‚îî‚îÄ‚îÄ realtime-chat.tsx
        ‚îú‚îÄ‚îÄ examples
        ‚îÇ   ‚îú‚îÄ‚îÄ CurrentUserAvatarExample.tsx
        ‚îÇ   ‚îî‚îÄ‚îÄ RealtimeAvatarStackExample.tsx
        ‚îú‚îÄ‚îÄ figma
        ‚îÇ   ‚îî‚îÄ‚îÄ ImageWithFallback.tsx
        ‚îú‚îÄ‚îÄ layout
        ‚îÇ   ‚îú‚îÄ‚îÄ AppContent.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ BottomNavigation.tsx
        ‚îÇ   ‚îú‚îÄ‚îÄ DesktopLayout.tsx
        ‚îÇ   ‚îî‚îÄ‚îÄ MobileLayout.tsx
        ‚îî‚îÄ‚îÄ ui
            ‚îú‚îÄ‚îÄ GameCapacity.tsx
            ‚îú‚îÄ‚îÄ accordion.tsx
            ‚îú‚îÄ‚îÄ alert-dialog.tsx
            ‚îú‚îÄ‚îÄ alert.tsx
            ‚îú‚îÄ‚îÄ aspect-ratio.tsx
            ‚îú‚îÄ‚îÄ avatar.tsx
            ‚îú‚îÄ‚îÄ badge.tsx
            ‚îú‚îÄ‚îÄ breadcrumb.tsx
            ‚îú‚îÄ‚îÄ button.tsx
            ‚îú‚îÄ‚îÄ calendar.tsx
            ‚îú‚îÄ‚îÄ card.tsx
            ‚îú‚îÄ‚îÄ carousel.tsx
            ‚îú‚îÄ‚îÄ chart.tsx
            ‚îú‚îÄ‚îÄ checkbox.tsx
            ‚îú‚îÄ‚îÄ clickable-avatar.tsx
            ‚îú‚îÄ‚îÄ collapsible.tsx
            ‚îú‚îÄ‚îÄ command.tsx
            ‚îú‚îÄ‚îÄ context-menu.tsx
            ‚îú‚îÄ‚îÄ dialog.tsx
            ‚îú‚îÄ‚îÄ drawer.tsx
            ‚îú‚îÄ‚îÄ dropdown-menu.tsx
            ‚îú‚îÄ‚îÄ empty-state-enhanced.tsx
            ‚îú‚îÄ‚îÄ empty-state.tsx
            ‚îú‚îÄ‚îÄ facepile.tsx
            ‚îú‚îÄ‚îÄ feed
            ‚îÇ   ‚îú‚îÄ‚îÄ FeedCard.tsx
            ‚îÇ   ‚îî‚îÄ‚îÄ FeedItem.tsx
            ‚îú‚îÄ‚îÄ form.tsx
            ‚îú‚îÄ‚îÄ hover-card.tsx
            ‚îú‚îÄ‚îÄ input-otp.tsx
            ‚îú‚îÄ‚îÄ input.tsx
            ‚îú‚îÄ‚îÄ label.tsx
            ‚îú‚îÄ‚îÄ leaderboard
            ‚îÇ   ‚îú‚îÄ‚îÄ Leaderboard.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ LeaderboardHeader.tsx
            ‚îÇ   ‚îî‚îÄ‚îÄ LeaderboardRow.tsx
            ‚îú‚îÄ‚îÄ loading-skeleton.tsx
            ‚îú‚îÄ‚îÄ loading-spinner.tsx
            ‚îú‚îÄ‚îÄ menubar.tsx
            ‚îú‚îÄ‚îÄ navigation-menu.tsx
            ‚îú‚îÄ‚îÄ pagination.tsx
            ‚îú‚îÄ‚îÄ popover.tsx
            ‚îú‚îÄ‚îÄ progress.tsx
            ‚îú‚îÄ‚îÄ pull-to-refresh.tsx
            ‚îú‚îÄ‚îÄ radio-group.tsx
            ‚îú‚îÄ‚îÄ resizable.tsx
            ‚îú‚îÄ‚îÄ scroll-area.tsx
            ‚îú‚îÄ‚îÄ select.tsx
            ‚îú‚îÄ‚îÄ separator.tsx
            ‚îú‚îÄ‚îÄ sheet.tsx
            ‚îú‚îÄ‚îÄ sidebar.tsx
            ‚îú‚îÄ‚îÄ skeleton.tsx
            ‚îú‚îÄ‚îÄ slider.tsx
            ‚îú‚îÄ‚îÄ sonner.tsx
            ‚îú‚îÄ‚îÄ stats
            ‚îÇ   ‚îú‚îÄ‚îÄ ProgressCard.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ StatCard.tsx
            ‚îÇ   ‚îî‚îÄ‚îÄ StatGroup.tsx
            ‚îú‚îÄ‚îÄ switch.tsx
            ‚îú‚îÄ‚îÄ table.tsx
            ‚îú‚îÄ‚îÄ tabs.tsx
            ‚îú‚îÄ‚îÄ textarea.tsx
            ‚îú‚îÄ‚îÄ theme-toggle.tsx
            ‚îú‚îÄ‚îÄ toggle-group.tsx
            ‚îú‚îÄ‚îÄ toggle.tsx
            ‚îú‚îÄ‚îÄ tooltip.tsx
            ‚îî‚îÄ‚îÄ wizard
                ‚îú‚îÄ‚îÄ Wizard.tsx
                ‚îú‚îÄ‚îÄ WizardProgress.tsx
                ‚îî‚îÄ‚îÄ WizardStep.tsx

```

`domains/games/components/ActivityLikeButton.tsx`:

```tsx
import { useState } from 'react';
import { Heart } from 'lucide-react';
import { Button } from '@/shared/components/ui/button';
import { ActivityLikeService } from '@/domains/games/services/activityLikeService';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';

interface ActivityLikeButtonProps {
  activityId: string;
  variant?: 'default' | 'minimal';
  showCount?: boolean;
}

export function ActivityLikeButton({ 
  activityId, 
  variant = 'default',
  showCount = true 
}: ActivityLikeButtonProps) {
  const queryClient = useQueryClient();
  const [isAnimating, setIsAnimating] = useState(false);

  // Get like status
  const { data: isLiked = false } = useQuery({
    queryKey: ['activityLike', activityId],
    queryFn: () => ActivityLikeService.isLiked(activityId),
    staleTime: 5 * 60 * 1000, // 5 minutes
  });

  // Get like count
  const { data: likeCount = 0 } = useQuery({
    queryKey: ['activityLikeCount', activityId],
    queryFn: () => ActivityLikeService.getLikeCount(activityId),
    staleTime: 2 * 60 * 1000, // 2 minutes
  });

  // Toggle like mutation
  const toggleLikeMutation = useMutation({
    mutationFn: () => ActivityLikeService.toggleLike(activityId),
    onMutate: async () => {
      // Optimistic update
      await queryClient.cancelQueries({ queryKey: ['activityLike', activityId] });
      await queryClient.cancelQueries({ queryKey: ['activityLikeCount', activityId] });

      const previousIsLiked = queryClient.getQueryData(['activityLike', activityId]);
      const previousCount = queryClient.getQueryData(['activityLikeCount', activityId]);

      queryClient.setQueryData(['activityLike', activityId], !isLiked);
      queryClient.setQueryData(['activityLikeCount', activityId], (old: number = 0) => 
        isLiked ? Math.max(0, old - 1) : old + 1
      );

      setIsAnimating(true);
      setTimeout(() => setIsAnimating(false), 300);

      return { previousIsLiked, previousCount };
    },
    onError: (err, _variables, context) => {
      // Rollback on error
      if (context) {
        queryClient.setQueryData(['activityLike', activityId], context.previousIsLiked);
        queryClient.setQueryData(['activityLikeCount', activityId], context.previousCount);
      }
      toast.error('Failed to update like');
    },
    onSuccess: (data) => {
      // Update with server response
      queryClient.setQueryData(['activityLike', activityId], data.isLiked);
      queryClient.setQueryData(['activityLikeCount', activityId], data.likeCount);
    },
  });

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    toggleLikeMutation.mutate();
  };

  if (variant === 'minimal') {
    return (
      <button
        onClick={handleClick}
        className={`flex items-center gap-1.5 text-sm transition-all ${
          isLiked 
            ? 'text-red-500 hover:text-red-600' 
            : 'text-muted-foreground hover:text-foreground'
        }`}
        aria-label={isLiked ? 'Unlike activity' : 'Like activity'}
      >
        <Heart 
          className={`w-4 h-4 transition-all ${
            isLiked ? 'fill-current' : ''
          } ${isAnimating ? 'scale-125' : ''}`}
        />
        {showCount && likeCount > 0 && (
          <span>{likeCount}</span>
        )}
      </button>
    );
  }

  return (
    <Button
      variant="ghost"
      size="sm"
      onClick={handleClick}
      className={`flex items-center gap-1.5 ${
        isLiked 
          ? 'text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-950/20' 
          : 'text-muted-foreground hover:text-foreground'
      }`}
      aria-label={isLiked ? 'Unlike activity' : 'Like activity'}
      disabled={toggleLikeMutation.isPending}
    >
      <Heart 
        className={`w-4 h-4 transition-all ${
          isLiked ? 'fill-current' : ''
        } ${isAnimating ? 'scale-125' : ''}`}
      />
      {showCount && (
        <span className="text-sm font-medium">{likeCount || 0}</span>
      )}
    </Button>
  );
}


```

`domains/games/components/ActivityMapPreview.tsx`:

```tsx
import { useEffect, useRef, useState } from 'react';
import { MapPin } from 'lucide-react';
import { loadGoogleMapsApi } from '@/domains/locations/services/googleMapsLoader';

interface ActivityMapPreviewProps {
  latitude: number;
  longitude: number;
  location?: string;
  className?: string;
  onClick?: () => void;
}

/**
 * Small map preview thumbnail for activity cards
 * Only shows if activity has specific coordinates
 * Safe pattern: map initialized once, cleaned up properly
 */
export function ActivityMapPreview({
  latitude,
  longitude,
  location,
  className = '',
  onClick,
}: ActivityMapPreviewProps) {
  const containerRef = useRef<HTMLDivElement | null>(null);
  const mapRef = useRef<google.maps.Map | null>(null);
  const markerRef = useRef<google.maps.Marker | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [loadError, setLoadError] = useState<string | null>(null);

  // Initialize map only once when container is ready
  useEffect(() => {
    if (!containerRef.current) return;
    if (mapRef.current) return; // already initialized

    const initMap = async () => {
      try {
        const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY;
        if (!apiKey) {
          setLoadError('Map unavailable');
          setIsLoading(false);
          return;
        }

        await loadGoogleMapsApi(apiKey);
        
        if (!containerRef.current || !window.google) return;

        // Initialize map
        const map = new google.maps.Map(containerRef.current, {
          center: { lat: latitude, lng: longitude },
          zoom: 15,
          disableDefaultUI: true,
          zoomControl: false,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
          styles: [
            {
              featureType: 'all',
              elementType: 'labels',
              stylers: [{ visibility: 'off' }],
            },
            {
              featureType: 'poi',
              stylers: [{ visibility: 'off' }],
            },
          ],
        });

        // Add marker
        const marker = new google.maps.Marker({
          position: { lat: latitude, lng: longitude },
          map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#FA4616',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
          },
        });

        mapRef.current = map;
        markerRef.current = marker;
        setIsLoading(false);
      } catch (error) {
        console.error('Error loading map preview:', error);
        setLoadError('Map unavailable');
        setIsLoading(false);
      }
    };

    initMap();
  }, []); // Only run once on mount

  // Update marker position when coordinates change
  useEffect(() => {
    if (!mapRef.current || !markerRef.current) return;

    const newPosition = { lat: latitude, lng: longitude };
    mapRef.current.setCenter(newPosition);
    markerRef.current.setPosition(newPosition);
  }, [latitude, longitude]);

  // Full cleanup on unmount
  useEffect(() => {
    return () => {
      // Clean up marker safely
      if (markerRef.current) {
        try {
          markerRef.current.setMap(null);
        } catch (e) {
          // Ignore errors - marker may already be cleaned up
        }
        markerRef.current = null;
      }
      
      // Clear map reference (Google Maps will handle DOM cleanup)
      mapRef.current = null;
    };
  }, []);

  if (loadError) {
    return (
      <div
        onClick={onClick}
        className={`w-full h-24 rounded-lg border border-border bg-muted flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity ${className}`}
        role="button"
        tabIndex={0}
        aria-label={`Location: ${location || 'activity location'}`}
        onKeyDown={(e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            onClick?.();
          }
        }}
      >
        <div className="text-center">
          <MapPin className="w-5 h-5 mx-auto text-muted-foreground mb-1" />
          <p className="text-xs text-muted-foreground">{location?.split(',')[0] || 'Location'}</p>
        </div>
      </div>
    );
  }

  return (
    <div
      onClick={onClick}
      className={`w-full h-24 rounded-lg overflow-hidden border border-border cursor-pointer hover:opacity-80 transition-opacity bg-muted relative ${className}`}
      role="button"
      tabIndex={0}
      aria-label={`Map preview for ${location || 'activity location'}`}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          onClick?.();
        }
      }}
    >
      {/* Map container - stable ref, never re-parented */}
      <div 
        ref={containerRef}
        className="w-full h-full"
        style={{ minHeight: '96px' }}
      />
      {isLoading && (
        <div className="absolute inset-0 flex items-center justify-center bg-muted/80 z-10">
          <div className="text-xs text-muted-foreground">Loading map...</div>
        </div>
      )}
    </div>
  );
}


```

`domains/games/components/AttendeeList.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Badge } from '@/shared/components/ui/badge';
import { ScrollArea } from '@/shared/components/ui/scroll-area';
import { Facepile, FacepileUser } from '@/shared/components/ui/facepile';
import { PlayerCard } from '@/domains/users/components/PlayerCard';
import { Users, UserPlus, ChevronDown, ChevronUp } from 'lucide-react';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/shared/components/ui/collapsible';

export type RSVPStatus = 'going' | 'maybe' | 'not_going';

export interface Attendee {
  id?: string;
  name: string;
  avatar?: string | null;
  email?: string;
  status: RSVPStatus;
  isHost?: boolean;
  isOrganizer?: boolean;
  joinedAt?: string;
}

export interface AttendeeListProps extends React.HTMLAttributes<HTMLDivElement> {
  attendees: Attendee[];
  maxPlayers?: number;
  currentPlayers?: number;
  showFacepile?: boolean;
  showFullList?: boolean;
  onInvite?: () => void;
  onAttendeeClick?: (attendee: Attendee) => void;
  currentUserId?: string;
  className?: string;
}

/**
 * Attendee List Component
 * 
 * Displays game attendees with facepile, RSVP status, and full list view.
 * 
 * @example
 * ```tsx
 * <AttendeeList
 *   attendees={attendees}
 *   maxPlayers={20}
 *   currentPlayers={15}
 *   showFacepile
 *   onInvite={() => openInviteModal()}
 * />
 * ```
 */
export function AttendeeList({
  attendees,
  maxPlayers,
  currentPlayers,
  showFacepile = true,
  showFullList = true,
  onInvite,
  onAttendeeClick,
  currentUserId,
  className,
  ...props
}: AttendeeListProps) {
  const [isExpanded, setIsExpanded] = React.useState(false);

  // Group attendees by status
  const going = attendees.filter((a) => a.status === 'going');
  const maybe = attendees.filter((a) => a.status === 'maybe');
  const notGoing = attendees.filter((a) => a.status === 'not_going');

  // Convert to FacepileUser format
  const facepileUsers: FacepileUser[] = going.map((attendee) => ({
    id: attendee.id,
    name: attendee.name,
    image: attendee.avatar || undefined,
    email: attendee.email,
  }));

  const handleAttendeeClick = (attendee: Attendee) => {
    if (onAttendeeClick) {
      onAttendeeClick(attendee);
    }
  };

  return (
    <div className={cn('space-y-4', className)} {...props}>
      {/* Facepile Section */}
      {showFacepile && going.length > 0 && (
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Users className="size-4 text-muted-foreground" />
              <span className="text-sm font-medium">
                {going.length} {going.length === 1 ? 'player' : 'players'} going
                {maxPlayers && ` (${currentPlayers || going.length}/${maxPlayers})`}
              </span>
            </div>
            {onInvite && (
              <Button
                type="button"
                variant="default"
                size="sm"
                onClick={onInvite}
                className="bg-primary text-primary-foreground hover:bg-primary/90"
              >
                <UserPlus className="size-3 mr-1" />
                Invite
              </Button>
            )}
          </div>
          <Facepile
            users={facepileUsers}
            maxVisible={5}
            size="md"
            onUserClick={(user) => {
              const attendee = going.find((a) => a.id === user.id);
              if (attendee) {
                handleAttendeeClick(attendee);
              }
            }}
          />
        </div>
      )}

      {/* Full List Section */}
      {showFullList && (
        <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>
          <CollapsibleTrigger asChild>
            <Button
              type="button"
              variant="ghost"
              className="w-full justify-between"
            >
              <span className="text-sm font-medium">
                {isExpanded ? 'Hide' : 'Show'} full list ({attendees.length})
              </span>
              {isExpanded ? (
                <ChevronUp className="size-4" />
              ) : (
                <ChevronDown className="size-4" />
              )}
            </Button>
          </CollapsibleTrigger>
          <CollapsibleContent>
            <Card className="mt-2">
              <CardHeader className="pb-3">
                <CardTitle className="text-base">All Attendees</CardTitle>
              </CardHeader>
              <CardContent className="p-0">
                <ScrollArea className="h-[300px]">
                  <div className="divide-y divide-border">
                    {/* Going */}
                    {going.length > 0 && (
                      <div className="p-3 space-y-2">
                        <div className="flex items-center gap-2 mb-2">
                          <Badge variant="default" className="text-xs">
                            Going ({going.length})
                          </Badge>
                        </div>
                        {going.map((attendee) => (
                          <div
                            key={attendee.id || attendee.name}
                            className="flex items-center gap-3 p-2 rounded-md hover:bg-muted/50 transition-colors cursor-pointer"
                            onClick={() => handleAttendeeClick(attendee)}
                          >
                            <PlayerCard
                              player={{
                                id: attendee.id,
                                name: attendee.name,
                                avatar: attendee.avatar,
                                isCurrentUser: attendee.id === currentUserId,
                              }}
                              variant="compact"
                              showStats={false}
                              showActions={false}
                              onViewProfile={() => handleAttendeeClick(attendee)}
                            />
                            {attendee.isHost && (
                              <Badge variant="secondary" className="text-xs">
                                Host
                              </Badge>
                            )}
                            {attendee.isOrganizer && (
                              <Badge variant="outline" className="text-xs">
                                Organizer
                              </Badge>
                            )}
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Maybe */}
                    {maybe.length > 0 && (
                      <div className="p-3 space-y-2 border-t border-border">
                        <div className="flex items-center gap-2 mb-2">
                          <Badge variant="secondary" className="text-xs">
                            Maybe ({maybe.length})
                          </Badge>
                        </div>
                        {maybe.map((attendee) => (
                          <div
                            key={attendee.id || attendee.name}
                            className="flex items-center gap-3 p-2 rounded-md hover:bg-muted/50 transition-colors cursor-pointer"
                            onClick={() => handleAttendeeClick(attendee)}
                          >
                            <PlayerCard
                              player={{
                                id: attendee.id,
                                name: attendee.name,
                                avatar: attendee.avatar,
                                isCurrentUser: attendee.id === currentUserId,
                              }}
                              variant="compact"
                              showStats={false}
                              showActions={false}
                              onViewProfile={() => handleAttendeeClick(attendee)}
                            />
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Not Going */}
                    {notGoing.length > 0 && (
                      <div className="p-3 space-y-2 border-t border-border">
                        <div className="flex items-center gap-2 mb-2">
                          <Badge variant="outline" className="text-xs">
                            Not Going ({notGoing.length})
                          </Badge>
                        </div>
                        {notGoing.map((attendee) => (
                          <div
                            key={attendee.id || attendee.name}
                            className="flex items-center gap-3 p-2 rounded-md hover:bg-muted/50 transition-colors cursor-pointer opacity-60"
                            onClick={() => handleAttendeeClick(attendee)}
                          >
                            <PlayerCard
                              player={{
                                id: attendee.id,
                                name: attendee.name,
                                avatar: attendee.avatar,
                                isCurrentUser: attendee.id === currentUserId,
                              }}
                              variant="compact"
                              showStats={false}
                              showActions={false}
                              onViewProfile={() => handleAttendeeClick(attendee)}
                            />
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </ScrollArea>
              </CardContent>
            </Card>
          </CollapsibleContent>
        </Collapsible>
      )}
    </div>
  );
}


```

`domains/games/components/CampusEmptyState.tsx`:

```tsx
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Plus, MapPin, Users, Calendar } from 'lucide-react';
import { brandColors } from '@/shared/config/theme';

interface CampusEmptyStateProps {
  onCreateGame: () => void;
  onExploreVenues?: () => void;
  title?: string;
  description?: string;
  showCampusCTA?: boolean;
}

export function CampusEmptyState({
  onCreateGame,
  onExploreVenues,
  title = "No activities yet",
  description = "Be the first to create an activity at your favorite UF spot!",
  showCampusCTA = true
}: CampusEmptyStateProps) {
  return (
    <div className="col-span-full">
      <Card className="bg-gradient-to-br from-orange-50 to-blue-50 dark:from-orange-950/20 dark:to-blue-950/20 border-orange-200 dark:border-orange-800">
        <CardContent className="p-8 text-center">
          {/* UF Campus Icon */}
          <div className="w-20 h-20 bg-gradient-to-br from-orange-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <MapPin className="w-10 h-10 text-white" />
          </div>

          {/* Title and Description */}
          <h3 className="text-xl font-semibold text-foreground mb-2">
            {title}
          </h3>
          <p className="text-muted-foreground mb-6 max-w-md mx-auto">
            {description}
          </p>

          {/* CTA Buttons */}
          <div className="flex flex-col sm:flex-row gap-3 justify-center mb-6">
            <Button
              onClick={onCreateGame}
              className="gap-2 text-white hover:opacity-90"
              style={{ 
                backgroundColor: brandColors.primary, 
                borderColor: brandColors.primary
              }}
            >
              <Plus className="w-4 h-4" />
              Create Your First Activity
            </Button>

            {showCampusCTA && onExploreVenues && (
              <Button
                variant="outline"
                onClick={onExploreVenues}
                className="border-orange-200 text-orange-700 hover:bg-orange-50 dark:border-orange-800 dark:text-orange-300 dark:hover:bg-orange-950/20"
              >
                <MapPin className="w-4 h-4 mr-2" />
                Explore Campus Venues
              </Button>
            )}
          </div>

          {/* Campus Tips */}
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-8">
            <div className="text-center">
              <div className="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <Calendar className="w-6 h-6 text-orange-600" />
              </div>
              <h4 className="font-medium text-sm mb-1">Pick Your Time</h4>
              <p className="text-xs text-muted-foreground">Weekdays after 5pm or weekends work great</p>
            </div>

            <div className="text-center">
              <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <Users className="w-6 h-6 text-blue-600" />
              </div>
              <h4 className="font-medium text-sm mb-1">Start Small</h4>
              <p className="text-xs text-muted-foreground">Begin with 4-6 players for better turnout</p>
            </div>

            <div className="text-center">
              <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <MapPin className="w-6 h-6 text-green-600" />
              </div>
              <h4 className="font-medium text-sm mb-1">Choose Popular Spots</h4>
              <p className="text-xs text-muted-foreground">Student Rec, Flavet Field, Lake Alice</p>
            </div>
          </div>

          {/* UF Pride */}
          <div className="mt-8 pt-6 border-t border-orange-200 dark:border-orange-800">
            <p className="text-sm text-muted-foreground">
              üéì <strong>Go Gators!</strong> Join the growing community of UF students playing sports together.
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/games/components/CreateGame.tsx`:

```tsx
import React, { useState, useEffect, useRef } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Progress } from '@/shared/components/ui/progress';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { ArrowLeft, CheckCircle, Loader2, MapPin, Clock, Users, DollarSign, AlertCircle, Navigation } from 'lucide-react';
import { InteractiveRoutePlanner } from '@/domains/locations/components/InteractiveRoutePlanner';
import { toast } from 'sonner';
import { useAppStore } from '@/store/appStore';
import { SupabaseService } from '@/core/database/supabaseService';
import { useLocationSearch } from '@/domains/locations/hooks/useLocationSearch';
import { useGeolocation } from '@/domains/locations/hooks/useGeolocation';
import { systemConfig } from '@/core/config/systemConfig';
import { SportPicker, DEFAULT_SPORTS } from '@/domains/games/components';
import { useUserTribes } from '@/domains/tribes/hooks/useTribes';
import { analyticsService } from '@/core/analytics/analyticsService';

interface FormData {
  sport: string;
  title: string;
  description: string;
  date: string;
  time: string;
  duration: string;
  location: string;
  latitude: number | null;
  longitude: number | null;
  maxPlayers: string;
  cost: string;
  requirements: string;
  skillLevel: string;
  minEloRating: string;
  maxEloRating: string;
  minReputation: string;
  competitiveMode: boolean;
  tribeId: string;
}

const sportOptions = [
  { value: 'basketball', label: 'Basketball', icon: 'üèÄ' },
  { value: 'soccer', label: 'Soccer', icon: '‚öΩ' },
  { value: 'tennis', label: 'Tennis', icon: 'üéæ' },
  { value: 'pickleball', label: 'Pickleball', icon: 'ü•í' },
  { value: 'volleyball', label: 'Volleyball', icon: 'üèê' },
  { value: 'football', label: 'Football', icon: 'üèà' },
  { value: 'baseball', label: 'Baseball', icon: '‚öæ' },
  { value: 'running', label: 'Running', icon: 'üèÉ' },
  { value: 'cycling', label: 'Cycling', icon: 'üö¥' },
  { value: 'swimming', label: 'Swimming', icon: 'üèä' },
  { value: 'hiking', label: 'Hiking', icon: 'ü•æ' },
  { value: 'rock_climbing', label: 'Rock Climbing', icon: 'üßó' },
];

const steps = [
  { id: 1, title: 'Activity Details', fields: ['sport', 'location', 'title', 'date', 'time', 'duration'] },
  { id: 2, title: 'Players & Cost', fields: ['maxPlayers', 'cost'] },
  { id: 3, title: 'Review & Create', fields: [] },
];

// Quick times default values (will be loaded from system config)
const DEFAULT_QUICK_TIMES = [
  '09:00', '12:00', '15:00', '17:00', '18:00', '19:00', '20:00', '21:00'
];

function CreateGame() {
  const navigate = useNavigate();
  const location = useLocation();
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [submitError, setSubmitError] = useState<string | null>(null);
  const [showLocationSuggestions, setShowLocationSuggestions] = useState(false);
  const [quickTimes, setQuickTimes] = useState<string[]>(DEFAULT_QUICK_TIMES);
  
  // Location hooks
  const { latitude: userLat, longitude: userLng, error: geoError } = useGeolocation();
  const { searchLocations, loading: isLocationLoading, suggestions, geocodeLocation } = useLocationSearch();
  const { user } = useAppStore();
  const navigationRef = useRef<HTMLDivElement>(null);
  const [navigationHeight, setNavigationHeight] = useState(0);
  const { data: userTribes } = useUserTribes(user?.id);

  // Smart defaults
  const getDefaultDate = () => {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    return tomorrow.toISOString().split('T')[0];
  };
  
  const [formData, setFormData] = useState({
    title: '',
    sport: '',
    date: getDefaultDate(), // Default to tomorrow
    time: '',
    duration: '60', // Will be updated from system config
    location: '',
    latitude: null as number | null,
    longitude: null as number | null,
    maxPlayers: '10', // Will be updated from system config
    cost: 'FREE',
    imageUrl: '',
    plannedRoute: null as any,
    tribeId: '',
    skillLevel: '' // Optional skill level
  });

  // Read tribeId from navigation state (when coming from TribeGames)
  useEffect(() => {
    const state = location.state as { tribeId?: string } | null;
    if (state?.tribeId) {
      setFormData(prev => ({
        ...prev,
        tribeId: state.tribeId || ''
      }));
    }
  }, [location.state]);

  // Load system configuration on component mount
  useEffect(() => {
    const loadSystemConfig = async () => {
      try {
        // Load quick time slots from system config
        const timeSlots = await systemConfig.get<string[]>('quick_time_slots', [
          '09:00', '12:00', '15:00', '17:00', '18:00', '19:00', '20:00', '21:00'
        ]);
        setQuickTimes(timeSlots || DEFAULT_QUICK_TIMES);

        // Load default max players
        const defaultMaxPlayers = await systemConfig.get<number>('max_players_per_game', 10);
        
        setFormData(prev => ({
          ...prev,
          maxPlayers: (defaultMaxPlayers || 10).toString()
        }));
      } catch (error) {
        console.error('Error loading system config:', error);
        // Ensure we have fallback values even if config loading fails
        setQuickTimes(DEFAULT_QUICK_TIMES);
        setFormData(prev => ({
          ...prev,
          maxPlayers: '10'
        }));
      }
    };

    loadSystemConfig();
  }, []);

  // Update sport-specific defaults when sport changes (only if duration hasn't been manually set)
  useEffect(() => {
    const updateSportDefaults = async () => {
      if (formData.sport) {
        try {
          const defaultDuration = await systemConfig.get(
            `sport_${formData.sport}_duration`, 
            60
          );
          
          // Only update duration if it's still the default value (60) or empty
          // This prevents overriding user's manual input
          setFormData(prev => {
            const currentDuration = parseInt(prev.duration) || 60;
            const shouldUpdateDuration = currentDuration === 60 || !prev.duration;
            
            return {
              ...prev,
              duration: shouldUpdateDuration 
                ? (defaultDuration ? defaultDuration.toString() : '60')
                : prev.duration // Keep user's manual input
            };
          });
        } catch (error) {
          console.error('Error loading sport defaults:', error);
        }
      }
    };

    updateSportDefaults();
  }, [formData.sport]);

  // Sport-based defaults
  const sportDefaults = {
    basketball: { maxPlayers: 10 },
    soccer: { maxPlayers: 22 },
    football: { maxPlayers: 22 },
    tennis: { maxPlayers: 4 },
    volleyball: { maxPlayers: 12 },
    baseball: { maxPlayers: 18 },
    hockey: { maxPlayers: 12 },
    badminton: { maxPlayers: 4 },
    pickleball: { maxPlayers: 4 },
    golf: { maxPlayers: 4 },
    running: { maxPlayers: 20 },
    cycling: { maxPlayers: 15 },
    hiking: { maxPlayers: 20 },
    swimming: { maxPlayers: 8 },
    yoga: { maxPlayers: 15 },
    crossfit: { maxPlayers: 12 }
  };

  // Smart time suggestions based on current time and day
  const getSmartTimes = () => {
    const now = new Date();
    const currentHour = now.getHours();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6;
    
    if (isWeekend) {
      // Weekend: suggest morning and afternoon times
      return ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
    } else {
      // Weekday: suggest evening times after work
      if (currentHour < 17) {
        return ['17:00', '18:00', '19:00', '20:00', '21:00'];
      } else {
        return ['18:00', '19:00', '20:00', '21:00'];
      }
    }
  };
  
  const popularTimes = getSmartTimes();

  // Recent locations (stored in localStorage)
  const [recentLocations, setRecentLocations] = useState<string[]>(() => {
    try {
      return JSON.parse(localStorage.getItem('recentGameLocations') || '[]');
    } catch {
      return [];
    }
  });

  // Recent sports (stored in localStorage)
  const [recentSports, setRecentSports] = useState<string[]>(() => {
    try {
      return JSON.parse(localStorage.getItem('recentSports') || '[]');
    } catch {
      return [];
    }
  });

  // Handle sport selection and track recent
  const handleSportSelect = (sport: { value: string; label: string; icon: string }) => {
    handleInputChange('sport', sport.value);
    
    // Track recent sports
    const updated = [sport.value, ...recentSports.filter(s => s !== sport.value)].slice(0, 5);
    setRecentSports(updated);
    try {
      localStorage.setItem('recentSports', JSON.stringify(updated));
    } catch (e) {
      console.error('Failed to save recent sports:', e);
    }
  };

  // Note: Removed auto-populate location to avoid interfering with user input
  // Users can manually click the location button to use their current location
  // This prevents the location field from being auto-filled and interfering with search suggestions

  useEffect(() => {
    if (!user) {
      navigate('/auth');
    }
  }, [user, navigate]);

  // Dynamic navigation height calculation
  useEffect(() => {
    const updateNavigationHeight = () => {
      if (navigationRef.current) {
        const height = navigationRef.current.offsetHeight;
        setNavigationHeight(height);
      }
    };

    updateNavigationHeight();
    window.addEventListener('resize', updateNavigationHeight);
    
    return () => window.removeEventListener('resize', updateNavigationHeight);
  }, [currentStep, isSubmitting]);

  const generateGameTitle = (sport: string, time: string, location: string) => {
    if (!sport || !time || !location) return '';
    
    const hour = parseInt(time.split(':')[0]);
    let timeOfDay = 'Morning';
    if (hour >= 12 && hour < 17) timeOfDay = 'Afternoon';
    else if (hour >= 17) timeOfDay = 'Evening';
    
    // Smart location extraction - prioritize venue names over addresses
    const extractSmartLocationName = (fullLocation: string): string => {
      const parts = fullLocation.split(',').map(p => p.trim());
      
      // If the first part looks like a venue name (not a street address), use it
      const firstPart = parts[0];
      
      // Check if first part starts with a number (likely a street address)
      if (!/^\d/.test(firstPart)) {
        // First part doesn't start with a number, likely a venue name
        return firstPart;
      }
      
      // Common landmark/venue keywords that should be prioritized
      const landmarkKeywords = [
        'park', 'center', 'centre', 'court', 'field', 'stadium', 'gym', 'club', 
        'recreation', 'community', 'sports', 'athletic', 'fitness', 'plaza', 
        'square', 'beach', 'lake', 'river', 'trail', 'complex', 'facility',
        'ymca', 'school', 'university', 'college', 'library', 'museum'
      ];
      
      // Look for parts that contain landmark keywords
      for (const part of parts) {
        const lowerPart = part.toLowerCase();
        if (landmarkKeywords.some(keyword => lowerPart.includes(keyword))) {
          return part;
        }
      }
      
      // Look for parts that are likely business names (contain common business words)
      const businessKeywords = [
        'starbucks', 'mcdonalds', 'walmart', 'target', 'costco', 'whole foods',
        'restaurant', 'cafe', 'coffee', 'hotel', 'mall', 'store', 'shop'
      ];
      
      for (const part of parts) {
        const lowerPart = part.toLowerCase();
        if (businessKeywords.some(keyword => lowerPart.includes(keyword))) {
          return part;
        }
      }
      
      // If it's a street address, clean it up
      const cleanedPart = firstPart
        .replace(/^\d+\s+/, '') // Remove leading numbers (street addresses)
        .replace(/\s+(st|street|ave|avenue|rd|road|blvd|boulevard|dr|drive|ln|lane|way|ct|court)$/i, '') // Remove street suffixes
        .trim();
      
      return cleanedPart || firstPart;
    };
    
    const locationName = extractSmartLocationName(location);
    const sportName = sport.charAt(0).toUpperCase() + sport.slice(1);
    
    const templates = [
      `${timeOfDay} ${sportName} at ${locationName}`,
      `${sportName} Game - ${locationName}`,
      `${timeOfDay} ${sportName} Session`,
      `${locationName} ${sportName} Meetup`,
      `${sportName} @ ${locationName}`,
    ];
    
    return templates[Math.floor(Math.random() * templates.length)];
  };

  // Track if user has manually edited the title
  const [titleManuallyEdited, setTitleManuallyEdited] = useState(false);

  // Auto-generate title when sport, time, and location are all filled
  useEffect(() => {
    // Always auto-generate title when all required fields are present (unless user manually edited)
    if (formData.sport && formData.time && formData.location && !titleManuallyEdited) {
      const autoTitle = generateGameTitle(formData.sport, formData.time, formData.location);
      if (autoTitle) {
        setFormData(prev => {
          // Only update if it's different or empty
          if (!prev.title || prev.title !== autoTitle) {
            return { ...prev, title: autoTitle };
          }
          return prev;
        });
      }
    }
  }, [formData.sport, formData.time, formData.location, titleManuallyEdited]);

  const checkForDuplicateGame = async (sport: string, date: string, time: string, location: string): Promise<string | null> => {
    if (!sport || !date || !time || !location) return null;
    
    try {
      const games = await SupabaseService.getGames();
      const duplicates = games.filter(game => {
        const sameDate = game.date === date;
        const sameTime = Math.abs(new Date(`2000-01-01T${game.time}`).getTime() - new Date(`2000-01-01T${time}`).getTime()) < 3600000; // Within 1 hour
        const sameSport = game.sport.toLowerCase() === sport.toLowerCase();
        const sameLocation = game.location.toLowerCase().includes(location.toLowerCase()) || location.toLowerCase().includes(game.location.toLowerCase());
        
        return sameDate && sameTime && sameSport && sameLocation;
      });
      
      if (duplicates.length > 0) {
        return `Similar ${sport} game already exists at ${location} on ${date} around ${time}`;
      }
      
      return null;
    } catch (error) {
      console.error('Error checking duplicates:', error);
      return null;
    }
  };

  const validateField = (name: string, value: string): string | null => {
    switch (name) {
      case 'date':
        if (!value) return null;
        const today = new Date();
        const chosen = new Date(value + 'T00:00:00');
        if (chosen < new Date(today.toDateString())) {
          return 'Date cannot be in the past';
        }
        return null;
        
      case 'time':
        if (!value) return null;
        const hour = parseInt(value.split(':')[0]);
        if (hour < 6 || hour > 23) {
          return 'Unusual time - games typically happen 6 AM - 11 PM';
        }
        if (hour >= 2 && hour <= 5) {
          return 'Did you mean PM instead of AM?';
        }
        return null;
        
      case 'maxPlayers':
        if (!value) return null;
        const num = parseInt(value);
        if (num < 2) return 'Need at least 2 players';
        if (num > 100) return 'That seems like a lot of players - double check?';
        
        // Smart capacity check based on sport
        const sportLower = formData.sport?.toLowerCase();
        if (sportLower === 'tennis' && num > 4) return 'Tennis usually has 2-4 players';
        if (sportLower === 'basketball' && num > 10) return 'Basketball usually has 6-10 players';
        if (sportLower === 'soccer' && num > 22) return 'Soccer usually has up to 22 players';
        
        return null;
        
      case 'location':
        if (!value) return null;
        if (value.length < 3) return 'Location too short';
        if (value.toLowerCase().includes('ocean') || value.toLowerCase().includes('sea')) {
          return 'Are you sure this location is correct?';
        }
        if (value.toLowerCase().includes('home') || value.toLowerCase().includes('house')) {
          return 'Consider using a public venue for safety';
        }
        return null;
        
      case 'cost':
        if (!value) return null;
        const cost = parseFloat(value);
        if (cost < 0) return 'Cost cannot be negative';
        if (cost > 500) return 'That seems expensive - double check?';
        return null;
        
      case 'duration':
        if (!value) return null;
        const duration = parseInt(value);
        if (duration < 15) return 'Duration should be at least 15 minutes';
        if (duration > 480) return 'Duration seems too long - max 8 hours';
        if (duration > 240) return 'That\'s a long game - are you sure?';
        return null;
        
      default:
        return null;
    }
  };

  const handleInputChange = (name: string, value: string) => {
    // Log duration changes specifically
    if (name === 'duration') {
      console.log('[CreateGame] Duration changed:', {
        oldValue: formData.duration,
        newValue: value,
        valueType: typeof value
      });
    }
    
    // Log skill level changes
    if (name === 'skillLevel') {
      console.log('[CreateGame] Skill level changed:', {
        oldValue: formData.skillLevel,
        newValue: value,
        valueType: typeof value,
        isEmpty: value === '',
        isNone: value === 'none'
      });
    }
    
    setFormData(prev => {
      const newData = { ...prev, [name]: value };
      
      // Auto-generate title when sport, time, or location changes
      // Always auto-generate when all three are present (unless user manually edited title)
      if (name !== 'title') {
        const updatedSport = name === 'sport' ? value : prev.sport;
        const updatedTime = name === 'time' ? value : prev.time;
        const updatedLocation = name === 'location' ? value : prev.location;
        
        // Auto-generate if: field changed is sport/time/location, and we have all required fields
        if ((name === 'sport' || name === 'time' || name === 'location') && 
            updatedSport && updatedTime && updatedLocation && !titleManuallyEdited) {
          const newAutoTitle = generateGameTitle(updatedSport, updatedTime, updatedLocation);
          if (newAutoTitle) {
            newData.title = newAutoTitle;
          }
        }
      } else {
        // User is editing title manually
        setTitleManuallyEdited(true);
      }
      
      // Auto-set max players based on sport
      if (name === 'sport' && sportDefaults[value.toLowerCase()]) {
        const sportDefault = sportDefaults[value.toLowerCase()];
        newData.maxPlayers = (sportDefault?.maxPlayers || 10).toString();
      }
      
      // Save location to recent locations
      if (name === 'location' && value.trim()) {
        const updated = [value, ...recentLocations.filter(loc => loc !== value)].slice(0, 5);
        setRecentLocations(updated);
        localStorage.setItem('recentGameLocations', JSON.stringify(updated));
        
      }
      
      return newData;
    });
    
    // Real-time validation
    const fieldError = validateField(name, value);
    setErrors(prev => {
      if (fieldError) {
        return { ...prev, [name]: fieldError };
      } else {
        const { [name]: _removed, ...rest } = prev;
        return rest;
      }
    });

    // Check for duplicate games when all key fields are filled
    if (name === 'location' && formData.sport && formData.date && formData.time && value) {
      checkForDuplicateGame(formData.sport, formData.date, formData.time, value).then(duplicateError => {
        if (duplicateError) {
          setErrors(prev => ({ ...prev, duplicate: duplicateError }));
        } else {
          setErrors(prev => {
            const { duplicate: _removed, ...rest } = prev;
            return rest;
          });
        }
      });
    }
    
    // Note: Removed auto-advance to give users full control over form progression
    // Users can manually click "Next" when ready to proceed
  };
  
  const isStepComplete = (step: number): boolean => {
    const stepFields = steps[step - 1]?.fields || [];
    const isComplete = stepFields.every(field => {
      const value = formData[field as keyof typeof formData];
      return value != null && value.toString().trim() !== '';
    });
    
    console.log('[CreateGame] isStepComplete - Step:', step, 'Fields:', stepFields, 'Complete:', isComplete, 'FormData:', formData);
    return isComplete;
  };

  const validateCurrentStep = (): boolean => {
    const stepErrors: Record<string, string> = {};
    if (currentStep === 1) {
      if (!formData.sport) stepErrors.sport = 'Please select an activity type.';
      if (!formData.location.trim()) stepErrors.location = 'Location is required.';
      if (!formData.title || formData.title.trim().length === 0) stepErrors.title = 'Activity title is required.';
      if (!formData.date) stepErrors.date = 'Please choose a date.';
      if (!formData.time) stepErrors.time = 'Please choose a time.';
      if (!formData.duration) stepErrors.duration = 'Please set a duration.';
      if (formData.date) {
        const today = new Date();
        const chosen = new Date(formData.date + 'T00:00:00');
        if (chosen < new Date(today.toDateString())) {
          stepErrors.date = 'Date cannot be in the past.';
        }
      }
      if (formData.duration) {
        const duration = parseInt(formData.duration);
        if (duration < 15) stepErrors.duration = 'Duration should be at least 15 minutes.';
        if (duration > 480) stepErrors.duration = 'Duration seems too long - max 8 hours.';
      }
    }
    if (currentStep === 2) {
      const mp = parseInt(formData.maxPlayers, 10);
      if (!formData.maxPlayers) stepErrors.maxPlayers = 'Max players is required.';
      else if (Number.isNaN(mp) || mp <= 0) stepErrors.maxPlayers = 'Enter a valid number greater than 0.';
      if (!formData.cost) stepErrors.cost = 'Please select a cost option.';
    }
    // Step 3 is now "Review & Create" - no validation needed
    
    setErrors(stepErrors);
    return Object.keys(stepErrors).length === 0;
  };

  const handleNext = () => {
    if (!validateCurrentStep()) return;
    if (currentStep < steps.length) setCurrentStep(currentStep + 1);
  };

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    } else {
      navigate(-1);
    }
  };

  const handleSubmit = async () => {
    if (!validateCurrentStep()) return;
    setIsSubmitting(true);
    setSubmitError(null);
    try {
      const { user } = useAppStore.getState();
      if (!user) {
        toast.error('You must be logged in to create an activity');
        navigate('/login');
        return;
      }

      // Parse duration more carefully to avoid losing user input
      const parsedDuration = parseInt(String(formData.duration).trim(), 10);
      const finalDuration = Number.isNaN(parsedDuration) ? 60 : Math.max(1, parsedDuration);

      // Auto-generate title if empty or just whitespace
      let finalTitle = formData.title?.trim() || '';
      if (!finalTitle && formData.sport && formData.time && formData.location) {
        finalTitle = generateGameTitle(formData.sport, formData.time, formData.location);
      }
      // Fallback if still empty (shouldn't happen, but just in case)
      if (!finalTitle) {
        finalTitle = `${formData.sport || 'Game'} at ${formData.location || 'Location'}`;
      }

      // Build payload object with proper types
      let plannedRoute = null;
      if (formData.plannedRoute) {
        try {
          plannedRoute = typeof formData.plannedRoute === 'string' 
            ? JSON.parse(formData.plannedRoute) 
            : formData.plannedRoute;
        } catch (e) {
          console.warn('Invalid planned_route JSON, omitting:', e);
          plannedRoute = null;
        }
      }

      const payload = {
        title: finalTitle,
        sport: formData.sport,
        date: formData.date,
        time: formData.time,
        duration: finalDuration,
        location: formData.location,
        latitude: formData.latitude ? Number(formData.latitude) : null,
        longitude: formData.longitude ? Number(formData.longitude) : null,
        maxPlayers: parseInt(String(formData.maxPlayers).trim(), 10) || 10,
        cost: formData.cost || 'Free',
        description: '', // Default empty description
        imageUrl: formData.imageUrl || null,
        plannedRoute: plannedRoute,
        tribeId: formData.tribeId || undefined,
        skillLevel: formData.skillLevel && formData.skillLevel.trim() !== '' ? formData.skillLevel.trim() : undefined
      };
      
      console.log('üìù [CreateGame] Payload skillLevel:', {
        formDataSkillLevel: formData.skillLevel,
        payloadSkillLevel: payload.skillLevel,
        type: typeof formData.skillLevel
      });
      
      const createdGame = await SupabaseService.createGame(payload as any);
      toast.success('Activity created successfully!');
      
      // Track game creation event
      if (createdGame?.id) {
        analyticsService.trackEvent('create_game', {
          game_id: createdGame.id,
          sport: payload.sport,
          max_players: payload.maxPlayers,
          has_tribe: !!payload.tribeId,
        });
      }
      
      navigate('/');
    } catch (error) {
      console.error('Error creating game:', error);
      let errorMessage = 'Failed to create activity. Please try again.';
      if (error instanceof Error) {
        errorMessage = error.message;
        // Show more detailed error in console for debugging
        console.error('Detailed error:', {
          message: error.message,
          stack: error.stack
        });
      }
      setSubmitError(errorMessage);
      toast.error(errorMessage);
    } finally {
      setIsSubmitting(false);
    }
  };

  const progress = (currentStep / steps.length) * 100;
  const selectedSport = sportOptions.find(sport => sport.value === formData.sport);

  const renderField = (name: string, label: string, type: string = 'text', options?: Array<{ value: string; label: string; icon?: React.ReactNode }>) => {
    const value = formData[name as keyof typeof formData] as string;
    const error = errors[name];
    const isValid = value && !error;

    if (type === 'select') {
      return (
        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground">{label}</label>
          <select 
            value={value} 
            onChange={(e) => handleInputChange(name, e.target.value)}
            className={`w-full p-3 border rounded-lg transition-colors bg-background text-foreground ${
              error ? 'border-destructive bg-destructive/10' : 
              isValid ? 'border-green-500 bg-green-50 dark:bg-green-950/50 dark:border-green-400' : 
              'border-input hover:border-ring focus:border-ring focus:ring-2 focus:ring-ring/20'
            }`}
          >
            <option value="" className="bg-background text-foreground">Select {label.toLowerCase()}</option>
            {options?.map((option) => (
              <option key={option.value} value={option.value} className="bg-background text-foreground">
                {option.label}
              </option>
            ))}
          </select>
          {error && <p className="text-sm text-destructive flex items-center gap-1">
            <span>‚ö†Ô∏è</span> {error}
          </p>}
          {isValid && !error && <p className="text-sm text-green-600 dark:text-green-400 flex items-center gap-1">
            <span>‚úÖ</span> Looks good!
          </p>}
        </div>
      );
    } else if (type === 'textarea') {
      return (
        <div className="space-y-2">
          <label className="text-sm font-medium flex items-center gap-2">
            {label}
            {steps[currentStep - 1].fields.includes(name) && (
              <span className="text-destructive">*</span>
            )}
          </label>
          <Textarea
            value={value}
            onChange={(e) => handleInputChange(name, e.target.value)}
            placeholder={`Enter ${label.toLowerCase()}`}
            className={`resize-none ${error ? 'border-destructive' : ''}`}
            rows={3}
          />
          {error && (
            <p className="text-sm text-destructive">{error}</p>
          )}
        </div>
      );
    } else {
      return (
        <div className="space-y-2">
          <label className="text-sm font-medium flex items-center gap-2">
            {label}
            {steps[currentStep - 1].fields.includes(name) && (
              <span className="text-destructive">*</span>
            )}
          </label>
          <Input
            type={type}
            value={formData[name]}
            onChange={(e) => handleInputChange(name, e.target.value)}
            placeholder={`Enter ${label.toLowerCase()}`}
            min={type === 'date' ? new Date().toISOString().split('T')[0] : undefined}
            className={`transition-colors ${
              error ? 'border-red-500 bg-red-50' : 
              isValid ? 'border-green-500 bg-green-50' : 
              'border-gray-300'
            }`}
          />
          {error && <p className="text-sm text-red-500 dark:text-red-400 flex items-center gap-1">
            <span>‚ö†Ô∏è</span> {error}
          </p>}
          {isValid && !error && <p className="text-sm text-green-600 dark:text-green-400 flex items-center gap-1">
            <span>‚úÖ</span> Looks good!
          </p>}
        </div>
      );
    }
  };

  return (
    <div className="min-h-screen bg-background" style={{ paddingBottom: `${navigationHeight + 16}px` }}>
      <div className="max-w-2xl mx-auto px-4 py-6">
        {/* Header */}
        <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
          <div className="flex items-center justify-between px-4 py-4">
            <div className="flex items-center gap-4">
              <Button variant="ghost" size="icon" onClick={handleBack}>
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div>
                <h1 className="text-xl font-bold">Create Activity</h1>
                <p className="text-sm text-muted-foreground">
                  Step {currentStep} of {steps.length}: {steps[currentStep - 1].title}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Progress Bar */}
        <div className="px-4 pb-4">
          <Progress value={progress} className="h-2" />
        </div>
      </div>

      <div className="px-4 pt-6" style={{ paddingBottom: `${navigationHeight + 16}px` }}>
        {/* Selected Sport Preview */}
        {selectedSport && (
          <div className="mb-6">
            <Card>
              <CardContent className="pt-6">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center text-2xl">
                    {selectedSport.icon}
                  </div>
                  <div>
                    <h3 className="font-semibold">{formData.title || 'New Activity'}</h3>
                    <p className="text-sm text-muted-foreground">{selectedSport.label}</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Form Steps */}
        {currentStep === 1 && (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <div className="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center text-primary font-semibold text-sm">
                    1
                  </div>
                  What & When
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Sport Selection */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-foreground mb-3">
                    Sport <span className="text-destructive">*</span>
                  </label>
                  <SportPicker
                    sports={DEFAULT_SPORTS}
                    selectedSport={formData.sport}
                    onSportSelect={handleSportSelect}
                    showSearch={true}
                    showRecent={true}
                    recentSports={recentSports}
                    gridCols={3}
                    size="md"
                    allowCustom={true}
                  />
                  {errors.sport && (
                    <p className="text-sm text-destructive mt-2">{errors.sport}</p>
                  )}
                </div>

                {/* Location Input Field */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-foreground">
                    Location <span className="text-destructive">*</span>
                  </label>
                  <div className="relative">
                    <Input
                      value={formData.location}
                      onChange={(e) => {
                        handleInputChange('location', e.target.value);
                        if (e.target.value.length > 2) {
                          searchLocations(e.target.value, userLat || undefined, userLng || undefined);
                          setShowLocationSuggestions(true);
                        } else {
                          setShowLocationSuggestions(false);
                        }
                      }}
                      placeholder="Enter location or address"
                      className={errors.location ? 'border-destructive' : ''}
                    />
                    <div className="absolute right-3 top-1/2 transform -translate-y-1/2 flex gap-2">
                      {isLocationLoading && <Loader2 className="w-4 h-4 animate-spin text-muted-foreground" />}
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        className="h-6 w-6 p-0"
                        onClick={async () => {
                          if (userLat && userLng) {
                            try {
                              const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLng}`
                              );
                              const data = await response.json();
                              const address = data.display_name || `${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
                              setFormData(prev => ({
                                ...prev,
                                location: address,
                                latitude: userLat,
                                longitude: userLng
                              }));
                              setShowLocationSuggestions(false);
                            } catch (error) {
                              console.error('Error getting current location:', error);
                            }
                          }
                        }}
                        title={userLat && userLng ? "Use my current location" : geoError || "Location not available"}
                        disabled={!userLat || !userLng}
                      >
                        <Navigation className="w-4 h-4" />
                      </Button>
                    </div>
                  </div>
                  {showLocationSuggestions && suggestions.length > 0 && (
                    <div className="absolute z-50 w-full mt-1 bg-background border border-border rounded-md shadow-lg max-h-60 overflow-auto">
                      {suggestions.map((suggestion, index) => (
                        <button
                          key={index}
                          type="button"
                          className="w-full text-left px-4 py-2 hover:bg-muted flex items-center gap-2"
                          onClick={async () => {
                            const coords = await geocodeLocation(suggestion.description);
                            setFormData(prev => ({
                              ...prev,
                              location: suggestion.description,
                              latitude: coords?.lat || null,
                              longitude: coords?.lng || null
                            }));
                            setShowLocationSuggestions(false);
                            // Generate auto title when location is selected
                            if (formData.sport && formData.time) {
                              const autoTitle = generateGameTitle(formData.sport, formData.time, suggestion.description);
                              if (autoTitle) {
                                setFormData(prev => ({ ...prev, title: autoTitle }));
                              }
                            }
                          }}
                        >
                          <MapPin className="w-4 h-4 text-muted-foreground" />
                          <span className="text-sm">{suggestion.description}</span>
                        </button>
                      ))}
                    </div>
                  )}
                  {errors.location && (
                    <p className="text-sm text-destructive">{errors.location}</p>
                  )}
                </div>

                {/* Tribe Selection (Optional) */}
                {userTribes && userTribes.length > 0 && (
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-foreground">
                      Tribe (Optional)
                    </label>
                    <Select
                      value={formData.tribeId || undefined}
                      onValueChange={(value) => handleInputChange('tribeId', value === 'none' ? '' : value)}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select a tribe (optional)" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="none">No tribe</SelectItem>
                        {userTribes.map((tribe) => (
                          <SelectItem key={tribe.id} value={tribe.id}>
                            {tribe.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <p className="text-xs text-muted-foreground">
                      Link this activity to one of your tribes
                    </p>
                  </div>
                )}

                {renderField('date', 'Date', 'date')}
                
                {/* Quick Time Selection */}
                <div className="space-y-3">
                  <label className="block text-sm font-medium text-foreground">
                    Time <span className="text-destructive">*</span>
                  </label>
                  
                  {/* Quick Time Buttons */}
                  <div className="grid grid-cols-4 gap-2">
                    {((quickTimes && quickTimes.length > 0) ? quickTimes : DEFAULT_QUICK_TIMES).map((timeOption) => (
                      <button
                        key={timeOption}
                        type="button"
                        onClick={() => handleInputChange('time', timeOption)}
                        className={`px-2 py-2 text-xs rounded-md border transition-colors ${
                          formData.time === timeOption
                            ? 'bg-primary text-primary-foreground border-primary'
                            : 'bg-background text-foreground border-input hover:bg-muted hover:border-ring'
                        }`}
                      >
                        {/* Convert 24-hour to 12-hour for display */}
                        {new Date(`2000-01-01T${timeOption}:00`).toLocaleTimeString('en-US', {
                          hour: 'numeric',
                          minute: '2-digit',
                          hour12: true
                        })}
                      </button>
                    ))}
                  </div>
                  
                  {/* Custom Time Input */}
                  <div className="space-y-1">
                    <label className="text-xs text-muted-foreground">Or enter custom time:</label>
                    <Input
                      type="time"
                      value={formData.time}
                      onChange={(e) => handleInputChange('time', e.target.value)}
                      className={errors.time ? 'border-destructive' : ''}
                      placeholder="Select time"
                    />
                  </div>
                  
                  {errors.time && (
                    <p className="text-sm text-destructive">{errors.time}</p>
                  )}
                </div>

                {/* Activity Title - Auto-generated but editable */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-foreground">
                    Activity Title <span className="text-destructive">*</span>
                  </label>
                  <Input
                    value={formData.title}
                    onChange={(e) => handleInputChange('title', e.target.value)}
                    placeholder={formData.sport && formData.time && formData.location ? "Auto-generated from sport, location, and time" : "Will auto-generate from sport, location, and time"}
                    className={errors.title ? 'border-destructive' : ''}
                  />
                  {errors.title && (
                    <p className="text-sm text-destructive">{errors.title}</p>
                  )}
                  {formData.sport && formData.time && formData.location && formData.title && !errors.title && (
                    <p className="text-xs text-muted-foreground">‚ú® Auto-generated from your sport, location, and time (you can edit if needed)</p>
                  )}
                  {(!formData.sport || !formData.time || !formData.location) && (
                    <p className="text-xs text-muted-foreground">Fill in sport, location, and time to auto-generate title</p>
                  )}
                </div>

                {/* Duration Selection */}
                <div className="space-y-3">
                  <label className="block text-sm font-medium text-foreground">
                    Duration <span className="text-destructive">*</span>
                  </label>
                  
                  {/* Quick Duration Buttons */}
                  <div className="grid grid-cols-4 gap-2">
                    {['30', '60', '90', '120'].map((durationOption) => (
                      <button
                        key={durationOption}
                        type="button"
                        onClick={() => handleInputChange('duration', durationOption)}
                        className={`px-2 py-2 text-xs rounded-md border transition-colors ${
                          formData.duration === durationOption
                            ? 'bg-primary text-primary-foreground border-primary'
                            : 'bg-background text-foreground border-input hover:bg-muted hover:border-ring'
                        }`}
                      >
                        {durationOption} min
                      </button>
                    ))}
                  </div>
                  
                  {/* Custom Duration Input */}
                  <div className="space-y-1">
                    <label className="text-xs text-muted-foreground">Or enter custom duration (minutes):</label>
                    <Input
                      type="number"
                      value={formData.duration}
                      onChange={(e) => handleInputChange('duration', e.target.value)}
                      className={errors.duration ? 'border-destructive' : ''}
                      placeholder="Duration in minutes"
                      min="15"
                      max="480"
                    />
                  </div>
                  
                  {errors.duration && (
                    <p className="text-sm text-destructive">{errors.duration}</p>
                  )}
                </div>

                {/* Skill Level Selection (Optional) */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-foreground">
                    Skill Level <span className="text-xs text-muted-foreground font-normal">(Optional)</span>
                  </label>
                  <Select 
                    value={formData.skillLevel || 'none'} 
                    onValueChange={(value) => handleInputChange('skillLevel', value === 'none' ? '' : value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="All Levels" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">All Levels</SelectItem>
                      <SelectItem value="beginner">Beginner</SelectItem>
                      <SelectItem value="intermediate">Intermediate</SelectItem>
                      <SelectItem value="advanced">Advanced</SelectItem>
                    </SelectContent>
                  </Select>
                  <p className="text-xs text-muted-foreground">
                    Help players find games that match their skill level
                  </p>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {currentStep === 2 && (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <div className="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center text-primary font-semibold text-sm">
                    2
                  </div>
                  Players & Cost
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {renderField('maxPlayers', 'Max Players', 'number')}
                
                {/* Cost Selection */}
                <div className="space-y-2">
                  <label className="text-sm font-medium text-foreground">
                    Cost <span className="text-destructive">*</span>
                  </label>
                  <Select value={formData.cost} onValueChange={(value) => handleInputChange('cost', value)}>
                    <SelectTrigger className={errors.cost ? 'border-destructive' : ''}>
                      <SelectValue placeholder="Select cost" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="FREE">Free</SelectItem>
                      <SelectItem value="$5">$5 per person</SelectItem>
                      <SelectItem value="$10">$10 per person</SelectItem>
                      <SelectItem value="$15">$15 per person</SelectItem>
                      <SelectItem value="$20">$20 per person</SelectItem>
                      <SelectItem value="custom">Custom amount</SelectItem>
                    </SelectContent>
                  </Select>
                  {errors.cost && (
                    <p className="text-sm text-destructive flex items-center gap-1">
                      <span>‚ö†Ô∏è</span> {errors.cost}
                    </p>
                  )}
                  {formData.cost && !errors.cost && (
                    <p className="text-sm text-green-600 dark:text-green-400 flex items-center gap-1">
                      <span>‚úÖ</span> Looks good!
                    </p>
                  )}
                </div>

                {/* Route Planning for Running/Hiking/Cycling */}
                {['running', 'hiking', 'cycling'].includes(formData.sport.toLowerCase()) && (
                  <div className="space-y-2 mt-6">
                    <label className="block text-sm font-medium text-foreground flex items-center gap-2">
                      <Navigation className="w-4 h-4" />
                      Plan Route (Optional)
                    </label>
                    <div className="border rounded-lg p-4 bg-muted/50 space-y-3">
                      {formData.plannedRoute ? (
                        <div className="space-y-3">
                          <div className="p-3 bg-green-50 dark:bg-green-950 rounded border border-green-200 dark:border-green-800">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm font-medium text-green-900 dark:text-green-100">
                                  ‚úì Route saved
                                </p>
                                <p className="text-xs text-green-700 dark:text-green-300">
                                  {formData.plannedRoute.path?.length || 0} waypoints ‚Ä¢ {formData.plannedRoute.distance || 'Distance calculated on save'}
                                </p>
                              </div>
                              <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                onClick={() => {
                                  setFormData(prev => ({ ...prev, plannedRoute: null }));
                                }}
                                className="text-xs"
                              >
                                Clear
                              </Button>
                            </div>
                          </div>
                        </div>
                      ) : (
                        formData.latitude && formData.longitude ? (
                          <InteractiveRoutePlanner
                            centerLat={formData.latitude}
                            centerLng={formData.longitude}
                            onRouteSave={(route) => {
                              console.log('üíæ [CreateGame] Route saved callback:', route);
                              setFormData(prev => {
                                const updated = { ...prev, plannedRoute: route };
                                console.log('üíæ [CreateGame] Updated formData with route:', updated.plannedRoute);
                                return updated;
                              });
                            }}
                            sport={formData.sport}
                          />
                        ) : (
                          <p className="text-sm text-muted-foreground">
                            Please set your game location above first, then you can plan your route.
                          </p>
                        )
                      )}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        )}

        {currentStep === 3 && (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <div className="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center text-primary font-semibold text-sm">
                    3
                  </div>
                  Review & Create
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Game Summary */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Game Summary</h3>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Sport:</span>
                        <span className="text-sm">{selectedSport?.icon} {selectedSport?.label}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Date:</span>
                        <span className="text-sm">{formData.date}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Time:</span>
                        <span className="text-sm">
                          {formData.time ? new Date(`2000-01-01T${formData.time}:00`).toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                          }) : ''}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Duration:</span>
                        <span className="text-sm">{formData.duration} minutes</span>
                      </div>
                      {formData.skillLevel && (
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-muted-foreground">Skill Level:</span>
                          <span className="text-sm capitalize">{formData.skillLevel}</span>
                        </div>
                      )}
                    </div>
                    
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Location:</span>
                        <span className="text-sm">{formData.location}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Max Players:</span>
                        <span className="text-sm">{formData.maxPlayers}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-muted-foreground">Cost:</span>
                        <span className="text-sm">{formData.cost}</span>
                      </div>
                      {/* Min reputation removed - not stored in database */}
                    </div>
                  </div>

                  {/* ELO Requirements removed - not stored in database */}
                </div>

                {/* Ready to Create Alert */}
                <Alert>
                  <CheckCircle className="h-4 w-4" />
                  <AlertDescription>
                    Ready to create "{formData.title}" for {formData.maxPlayers} players 
                    on {formData.date} at {formData.time ? new Date(`2000-01-01T${formData.time}:00`).toLocaleTimeString('en-US', {
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    }) : ''}?
                  </AlertDescription>
                </Alert>
                
                {errors.duplicate && (
                  <div className="mt-2">
                    <p className="text-sm text-yellow-700 mt-1">{errors.duplicate}</p>
                    <p className="text-xs text-yellow-600 mt-2">You can still create this game if it's intentional.</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        )}
        
        {/* Submit Error Display */}
        {submitError && (
          <div className="mt-4">
            <Alert variant="destructive">
              <AlertDescription>{submitError}</AlertDescription>
            </Alert>
          </div>
        )}
      </div>

      {/* Mobile Navigation */}
      <div ref={navigationRef} className="fixed bottom-0 left-0 right-0 bg-background/95 backdrop-blur-sm border-t border-border safe-area-inset-bottom z-50">
        <div className="px-4 py-3 pb-safe">
          {/* Step Indicator for Mobile */}
          <div className="flex justify-center mb-3 sm:hidden">
            <div className="flex items-center gap-2">
              {steps.map((step, index) => (
                <div key={step.id} className="flex items-center">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium transition-colors ${
                    currentStep === step.id 
                      ? 'bg-primary text-primary-foreground' 
                      : currentStep > step.id 
                        ? 'bg-green-500 text-white' 
                        : 'bg-muted text-muted-foreground'
                  }`}>
                    {currentStep > step.id ? '‚úì' : step.id}
                  </div>
                  {index < steps.length - 1 && (
                    <div className={`w-8 h-0.5 mx-1 ${
                      currentStep > step.id ? 'bg-green-500' : 'bg-muted'
                    }`} />
                  )}
                </div>
              ))}
            </div>
          </div>
          
          {/* Navigation Buttons */}
          <div className="flex justify-between items-center gap-3">
            {currentStep > 1 ? (
              <Button 
                variant="outline" 
                onClick={handleBack}
                className="min-h-[48px] px-4 sm:px-6 flex-1 max-w-[120px] touch-manipulation text-sm sm:text-base"
                size="lg"
              >
                <ArrowLeft className="w-4 h-4 mr-1 sm:mr-2" />
                <span className="hidden sm:inline">Previous</span>
                <span className="sm:hidden">Back</span>
              </Button>
            ) : (
              <Button 
                variant="ghost" 
                onClick={() => navigate(-1)}
                className="min-h-[48px] px-4 touch-manipulation text-sm sm:text-base"
                size="lg"
              >
                Cancel
              </Button>
            )}
            
            {/* Progress indicator for larger screens */}
            <div className="hidden sm:flex items-center gap-2 text-sm text-muted-foreground">
              Step {currentStep} of {steps.length}
            </div>
            
            {currentStep < steps.length ? (
              <Button 
                onClick={handleNext}
                disabled={!isStepComplete(currentStep) || Object.keys(errors).some(key => key !== 'duplicate')}
                className="min-h-[48px] px-4 sm:px-6 flex-1 max-w-[120px] touch-manipulation text-sm sm:text-base"
                size="lg"
              >
                <span className="hidden sm:inline">Continue</span>
                <span className="sm:hidden">Next</span>
                <ArrowLeft className="w-4 h-4 ml-1 sm:ml-2 rotate-180" />
              </Button>
            ) : (
              <Button 
                onClick={handleSubmit}
                disabled={!isStepComplete(currentStep) || Object.keys(errors).some(key => key !== 'duplicate') || isSubmitting}
                className="min-h-[48px] px-4 sm:px-6 flex-1 max-w-[140px] touch-manipulation text-sm sm:text-base"
                size="lg"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-1 sm:mr-2 animate-spin" />
                    <span className="hidden sm:inline">Creating...</span>
                    <span className="sm:hidden">Wait...</span>
                  </>
                ) : (
                  <>
                    <CheckCircle className="w-4 h-4 mr-1 sm:mr-2" />
                    <span className="hidden sm:inline">Create Activity</span>
                    <span className="sm:hidden">Create</span>
                  </>
                )}
              </Button>
            )}
          </div>
          
          {/* Validation Status for Mobile */}
          {!isStepComplete(currentStep) && (
            <div className="mt-2 text-center">
              <p className="text-xs text-muted-foreground">
                Complete required fields to continue
              </p>
            </div>
          )}
          
        </div>
      </div>
    </div>
  );
}

export default CreateGame;
```

`domains/games/components/CreateRecurringGame.tsx`:

```tsx
import React, { useState } from 'react';
import { Calendar, Clock, MapPin, Users, DollarSign, Repeat, Save } from 'lucide-react';
import { SupabaseService } from '@/core/database/supabaseService';
import { useAppStore } from '@/store/appStore';

interface CreateRecurringGameProps {
  onSuccess?: (templateId: string) => void;
  onCancel?: () => void;
}

export const CreateRecurringGame: React.FC<CreateRecurringGameProps> = ({
  onSuccess,
  onCancel
}) => {
  const { user } = useAppStore();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const [formData, setFormData] = useState({
    title: '',
    sport: 'basketball',
    location: '',
    latitude: undefined as number | undefined,
    longitude: undefined as number | undefined,
    cost: 'Free',
    maxPlayers: 10,
    duration: 60,
    description: '',
    imageUrl: '',
    recurrenceType: 'weekly' as 'weekly' | 'biweekly' | 'monthly',
    dayOfWeek: 1, // Monday
    dayOfMonth: 1,
    timeOfDay: '18:00',
    startDate: new Date().toISOString().split('T')[0],
    endDate: '',
    maxOccurrences: undefined as number | undefined
  });

  const sports = [
    'basketball', 'soccer', 'tennis', 'volleyball', 'baseball', 'football',
    'hockey', 'golf', 'swimming', 'running', 'cycling', 'hiking', 'other'
  ];

  const daysOfWeek = [
    { value: 0, label: 'Sunday' },
    { value: 1, label: 'Monday' },
    { value: 2, label: 'Tuesday' },
    { value: 3, label: 'Wednesday' },
    { value: 4, label: 'Thursday' },
    { value: 5, label: 'Friday' },
    { value: 6, label: 'Saturday' }
  ];

  const handleInputChange = (field: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
    setError(null);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!user) {
      setError('Please sign in to create recurring games');
      return;
    }

    if (!formData.title.trim()) {
      setError('Please enter a game title');
      return;
    }

    if (!formData.location.trim()) {
      setError('Please enter a location');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const templateData = {
        title: formData.title.trim(),
        sport: formData.sport,
        location: formData.location.trim(),
        latitude: formData.latitude,
        longitude: formData.longitude,
        cost: formData.cost,
        maxPlayers: formData.maxPlayers,
        description: formData.description.trim(),
        imageUrl: formData.imageUrl.trim() || undefined,
        recurrenceType: formData.recurrenceType,
        dayOfWeek: formData.recurrenceType !== 'monthly' ? formData.dayOfWeek : undefined,
        dayOfMonth: formData.recurrenceType === 'monthly' ? formData.dayOfMonth : undefined,
        timeOfDay: formData.timeOfDay,
        startDate: formData.startDate,
        endDate: formData.endDate || undefined,
        maxOccurrences: formData.maxOccurrences
      };

      const templateId = await SupabaseService.createRecurringTemplate(templateData);
      onSuccess?.(templateId);
    } catch (err: any) {
      setError(err.message || 'Failed to create recurring game template');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center space-x-2">
          <Repeat className="w-6 h-6 text-blue-600" />
          <h2 className="text-2xl font-bold text-gray-900">Create Recurring Game</h2>
        </div>
        {onCancel && (
          <button
            onClick={onCancel}
            className="text-gray-500 hover:text-gray-700"
          >
            ‚úï
          </button>
        )}
      </div>

      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
          <p className="text-sm text-red-600">{error}</p>
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Basic Game Info */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Game Title *
            </label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => handleInputChange('title', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Weekly Basketball Pickup"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Sport *
            </label>
            <select
              value={formData.sport}
              onChange={(e) => handleInputChange('sport', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              {sports.map(sport => (
                <option key={sport} value={sport}>
                  {sport.charAt(0).toUpperCase() + sport.slice(1)}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            <MapPin className="w-4 h-4 inline mr-1" />
            Location *
          </label>
          <input
            type="text"
            value={formData.location}
            onChange={(e) => handleInputChange('location', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Community Center Gym"
            required
          />
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              <Users className="w-4 h-4 inline mr-1" />
              Max Players
            </label>
            <input
              type="number"
              min="2"
              max="100"
              value={formData.maxPlayers}
              onChange={(e) => handleInputChange('maxPlayers', parseInt(e.target.value))}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              <DollarSign className="w-4 h-4 inline mr-1" />
              Cost
            </label>
            <select
              value={formData.cost}
              onChange={(e) => handleInputChange('cost', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="Free">Free</option>
              <option value="$5">$5</option>
              <option value="$10">$10</option>
              <option value="$15">$15</option>
              <option value="$20">$20</option>
              <option value="$25">$25</option>
            </select>
          </div>
        </div>

        {/* Recurrence Settings */}
        <div className="border-t pt-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">Recurrence Settings</h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Repeat Pattern
              </label>
              <select
                value={formData.recurrenceType}
                onChange={(e) => handleInputChange('recurrenceType', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="weekly">Weekly</option>
                <option value="biweekly">Every 2 Weeks</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>

            {formData.recurrenceType !== 'monthly' ? (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Day of Week
                </label>
                <select
                  value={formData.dayOfWeek}
                  onChange={(e) => handleInputChange('dayOfWeek', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  {daysOfWeek.map(day => (
                    <option key={day.value} value={day.value}>
                      {day.label}
                    </option>
                  ))}
                </select>
              </div>
            ) : (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Day of Month
                </label>
                <input
                  type="number"
                  min="1"
                  max="31"
                  value={formData.dayOfMonth}
                  onChange={(e) => handleInputChange('dayOfMonth', parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                <Clock className="w-4 h-4 inline mr-1" />
                Time
              </label>
              <input
                type="time"
                value={formData.timeOfDay}
                onChange={(e) => handleInputChange('timeOfDay', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                <Calendar className="w-4 h-4 inline mr-1" />
                Start Date
              </label>
              <input
                type="date"
                value={formData.startDate}
                onChange={(e) => handleInputChange('startDate', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                min={new Date().toISOString().split('T')[0]}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                End Date (Optional)
              </label>
              <input
                type="date"
                value={formData.endDate}
                onChange={(e) => handleInputChange('endDate', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                min={formData.startDate}
              />
            </div>
          </div>

          <div className="mt-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Max Occurrences (Optional)
            </label>
            <input
              type="number"
              min="1"
              max="100"
              value={formData.maxOccurrences || ''}
              onChange={(e) => handleInputChange('maxOccurrences', e.target.value ? parseInt(e.target.value) : undefined)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Leave empty for unlimited"
            />
            <p className="text-xs text-gray-500 mt-1">
              Alternative to end date - limit total number of games created
            </p>
          </div>
        </div>

        {/* Description */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Description
          </label>
          <textarea
            value={formData.description}
            onChange={(e) => handleInputChange('description', e.target.value)}
            rows={3}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Regular pickup game for all skill levels..."
          />
        </div>

        {/* Preview */}
        <div className="bg-blue-50 border border-blue-200 rounded-md p-4">
          <h4 className="text-sm font-medium text-blue-900 mb-2">Preview</h4>
          <p className="text-sm text-blue-800">
            This will create "{formData.title}" every{' '}
            {formData.recurrenceType === 'weekly' ? 'week' : 
             formData.recurrenceType === 'biweekly' ? '2 weeks' : 'month'} on{' '}
            {formData.recurrenceType !== 'monthly' 
              ? daysOfWeek.find(d => d.value === formData.dayOfWeek)?.label
              : `the ${formData.dayOfMonth}${formData.dayOfMonth === 1 ? 'st' : formData.dayOfMonth === 2 ? 'nd' : formData.dayOfMonth === 3 ? 'rd' : 'th'}`
            } at {formData.timeOfDay}.
            {formData.endDate && ` Games will run until ${formData.endDate}.`}
            {formData.maxOccurrences && ` Limited to ${formData.maxOccurrences} total games.`}
          </p>
        </div>

        {/* Submit Buttons */}
        <div className="flex items-center justify-end space-x-4 pt-6 border-t">
          {onCancel && (
            <button
              type="button"
              onClick={onCancel}
              className="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200"
            >
              Cancel
            </button>
          )}
          <button
            type="submit"
            disabled={loading}
            className="flex items-center space-x-2 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <Save className="w-4 h-4" />
            <span>{loading ? 'Creating...' : 'Create Recurring Game'}</span>
          </button>
        </div>
      </form>
    </div>
  );
};

```

`domains/games/components/EnhancedGameChat.tsx`:

```tsx
import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { MessageSquare, Send } from 'lucide-react';
import { useAppStore } from '@/store/appStore';
import { supabase } from '@/core/database/supabase';
import { formatDistanceToNow } from 'date-fns';
import { cn } from '@/shared/utils/utils';
import { NoMessagesEmptyState } from '@/shared/components/common/EmptyState';
interface ChatMessage {
  id: string;
  game_id: string;
  user_id: string;
  message: string;
  created_at: string;
  user?: {
    name: string;
    avatar?: string;
  };
}

interface EnhancedGameChatProps {
  gameId: string;
  className?: string;
}

export function EnhancedGameChat({ gameId, className = '' }: EnhancedGameChatProps) {
  const { user } = useAppStore();
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [isSending, setIsSending] = useState(false);
  const [isConnected, setIsConnected] = useState(false);
  const [isLoadingMore, setIsLoadingMore] = useState(false);
  const [hasMoreMessages, setHasMoreMessages] = useState(true);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const messagesContainerRef = useRef<HTMLDivElement>(null);
  const channelRef = useRef<any>(null);
  const oldestMessageRef = useRef<string | null>(null);

  // Enhanced scroll to bottom - scrolls only the chat container, not the page
  const scrollToBottom = useCallback(() => {
    // Use scrollTop on the container instead of scrollIntoView to prevent page scrolling
    if (messagesContainerRef.current) {
      messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
    }
  }, []);

  // Load initial messages
  useEffect(() => {
    const loadMessages = async () => {
      try {
        setIsLoading(true);
        setHasMoreMessages(true);
        oldestMessageRef.current = null;
        
        // Load the most recent 10 messages
        const { data: messagesData, error } = await supabase
          .from('chat_messages_with_author')
          .select('id, game_id, user_id, message, created_at, display_name, username, avatar_url')
          .eq('game_id', gameId)
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) {
          console.error('‚ùå Error loading messages:', error);
          const storedMessages = localStorage.getItem(`chat-${gameId}`);
          if (storedMessages) {
            const parsed = JSON.parse(storedMessages);
            setMessages(parsed);
          }
          return;
        }

        if (!messagesData || messagesData.length === 0) {
          setMessages([]);
          setHasMoreMessages(false);
          return;
        }

        // Check if there are more messages
        setHasMoreMessages(messagesData.length === 10);
        
        // Store oldest message timestamp for pagination
        if (messagesData.length > 0) {
          oldestMessageRef.current = messagesData[messagesData.length - 1].created_at;
        }

        // Reverse to show oldest first (newest at bottom) for proper chat display
        const reversedMessages = [...messagesData].reverse();

        // Transform messages
        const transformedMessages: ChatMessage[] = reversedMessages.map((msg: any) => {
          const authorName = msg.display_name || 'Player';
          return {
            id: msg.id,
            game_id: msg.game_id,
            user_id: msg.user_id,
            message: msg.message,
            created_at: msg.created_at,
            user: {
              name: authorName,
              avatar: msg.avatar_url || ''
            }
          };
        });
          
        setMessages(transformedMessages);
        console.log('‚úÖ [EnhancedGameChat] Loaded messages from database:', transformedMessages.length);
      } catch (error) {
        console.error('Error loading messages:', error);
      } finally {
        setIsLoading(false);
      }
    };

    loadMessages();
  }, [gameId]);

  // Load more messages when scrolling to top
  const loadOlderMessages = useCallback(async () => {
    if (isLoadingMore || !hasMoreMessages || !oldestMessageRef.current) return;

    try {
      setIsLoadingMore(true);
      
      const { data: messagesData, error } = await supabase
        .from('chat_messages_with_author')
        .select('id, game_id, user_id, message, created_at, display_name, username, avatar_url')
        .eq('game_id', gameId)
        .lt('created_at', oldestMessageRef.current)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error) {
        console.error('‚ùå Error loading older messages:', error);
        return;
      }

      if (!messagesData || messagesData.length === 0) {
        setHasMoreMessages(false);
        return;
      }

      // Check if there are more messages
      setHasMoreMessages(messagesData.length === 10);
      
      // Update oldest message timestamp
      if (messagesData.length > 0) {
        oldestMessageRef.current = messagesData[messagesData.length - 1].created_at;
      }

      // Reverse to show oldest first
      const reversedMessages = [...messagesData].reverse();

      // Transform messages
      const transformedMessages: ChatMessage[] = reversedMessages.map((msg: any) => {
        const authorName = msg.display_name || 'Player';
        return {
          id: msg.id,
          game_id: msg.game_id,
          user_id: msg.user_id,
          message: msg.message,
          created_at: msg.created_at,
          user: {
            name: authorName,
            avatar: msg.avatar_url || ''
          }
        };
      });

      // Preserve scroll position by prepending older messages
      if (messagesContainerRef.current) {
        const previousScrollHeight = messagesContainerRef.current.scrollHeight;
        setMessages(prev => [...transformedMessages, ...prev]);
        
        // Restore scroll position after new messages are rendered
        requestAnimationFrame(() => {
          if (messagesContainerRef.current) {
            const newScrollHeight = messagesContainerRef.current.scrollHeight;
            messagesContainerRef.current.scrollTop = newScrollHeight - previousScrollHeight;
          }
        });
      } else {
        setMessages(prev => [...transformedMessages, ...prev]);
      }
    } catch (error) {
      console.error('Error loading older messages:', error);
    } finally {
      setIsLoadingMore(false);
    }
  }, [gameId, isLoadingMore, hasMoreMessages]);

  // Handle scroll to load more messages
  useEffect(() => {
    const container = messagesContainerRef.current;
    if (!container) return;

    const handleScroll = () => {
      // Load more when scrolled to top (within 50px)
      if (container.scrollTop < 50 && hasMoreMessages && !isLoadingMore) {
        loadOlderMessages();
      }
    };

    // Use passive listener for better mobile performance
    container.addEventListener('scroll', handleScroll, { passive: true });
    return () => container.removeEventListener('scroll', handleScroll);
  }, [hasMoreMessages, isLoadingMore, loadOlderMessages]);

  // Enhanced real-time subscription with presence tracking
  useEffect(() => {
    if (!gameId || !user) return;

    console.log('üîó Setting up enhanced chat realtime for game:', gameId);

    // Create channel for game chat with presence tracking
    const channel = supabase
      .channel(`game-chat-${gameId}`)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_messages',
        filter: `game_id=eq.${gameId}`
      }, async (payload: any) => {
        console.log('üí¨ New chat message from database:', payload);
        
        // Fetch message with author info using chat_messages_with_author view
        const { data: fullMessage, error: fetchError } = await supabase
          .from('chat_messages_with_author')
          .select('id, game_id, user_id, message, created_at, display_name, username, avatar_url')
          .eq('id', payload.new.id)
          .single();

        if (fetchError || !fullMessage) {
          console.error('‚ùå Error fetching full message with author:', fetchError);
          return;
        }

        if (fullMessage.user_id) {
          // display_name is now a generated column, always present
          const authorName = fullMessage.display_name || 'Player';
          const newMsg: ChatMessage = {
            id: fullMessage.id,
            game_id: fullMessage.game_id,
            user_id: fullMessage.user_id,
            message: fullMessage.message,
            created_at: fullMessage.created_at,
            user: {
              name: authorName,
              avatar: fullMessage.avatar_url || ''
            }
          };
          
          // Add message if it's not already in the local state
          setMessages(prev => {
            const exists = prev.some(msg => msg.id === newMsg.id);
            if (!exists) {
              console.log('‚úÖ Adding new message to chat:', newMsg.message, 'from:', newMsg.user?.name);
              return [...prev, newMsg];
            }
            return prev;
          });
          setTimeout(scrollToBottom, 100);
        }
      })
      .subscribe(async (status: string) => {
        console.log('üì° Enhanced chat subscription status:', status);
        if (status === 'SUBSCRIBED') {
          setIsConnected(true);
        }
      });

    channelRef.current = channel;

    return () => {
      console.log('üîå Unsubscribing from enhanced chat:', gameId);
      if (channelRef.current) {
        channelRef.current.unsubscribe();
      }
    };
  }, [gameId, user, scrollToBottom]);

  // Auto-scroll when messages change
  useEffect(() => {
    scrollToBottom();
  }, [messages, scrollToBottom]);

  const sendMessage = async () => {
    if (!newMessage.trim() || isSending) return;

    setIsSending(true);
    
    try {
      // Prepare insert payload
      const insertPayload = {
        game_id: gameId,
        message: newMessage.trim()
      };

      // Log exact POST payload for debugging
      console.log('üì§ [Chat] POST /rest/v1/chat_messages');
      console.log('üì¶ [Chat] Payload:', JSON.stringify(insertPayload, null, 2));
      console.log('üîó [Chat] gameId:', gameId);
      console.log('üí¨ [Chat] message:', newMessage.trim());

      // Save message to database
      // Note: user_id is automatically set by database trigger from auth.uid()
      // Required fields: game_id, message
      // Do NOT request nested author fields in insert select - use view for that
      const { data: savedMessage, error: saveError } = await supabase
        .from('chat_messages')
        .insert(insertPayload)
        .select('id, game_id, user_id, message, created_at')
        .single();

      if (saveError) {
        console.error('‚ùå [Chat] Error saving message to database:', saveError);
        console.error('‚ùå [Chat] Error details:', {
          code: saveError.code,
          message: saveError.message,
          details: saveError.details,
          hint: saveError.hint,
          status: (saveError as any).status,
          statusText: (saveError as any).statusText
        });
        console.error('‚ùå [Chat] Failed payload was:', JSON.stringify(insertPayload, null, 2));
        throw saveError;
      }

      console.log('‚úÖ Message saved to database:', savedMessage);

      // Fetch author info from users table for the saved message
      let authorName = user?.name || 'You';
      let authorAvatar = user?.avatar || '';
      
      if (savedMessage.user_id) {
        const { data: authorProfile, error: authorError } = await supabase
          .from('users')
          .select('full_name, username, avatar_url')
          .eq('id', savedMessage.user_id)
          .single();
        
        if (!authorError && authorProfile) {
          authorName = authorProfile.full_name?.trim() || authorProfile.username?.trim() || user?.name || 'You';
          authorAvatar = authorProfile.avatar_url || user?.avatar || '';
        }
      }

      // Transform and add to local state immediately for sender
      const newMsg: ChatMessage = {
        id: savedMessage.id,
        game_id: savedMessage.game_id,
        user_id: savedMessage.user_id,
        message: savedMessage.message,
        created_at: savedMessage.created_at,
        user: {
          name: authorName,
          avatar: authorAvatar
        }
      };

      setMessages(prev => [...prev, newMsg]);
      setNewMessage('');
      setTimeout(scrollToBottom, 100);
      
    } catch (error) {
      console.error('Error sending message:', error);
      alert('Failed to send message. Please try again.');
    } finally {
      setIsSending(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  // Group consecutive messages from same user
  const groupedMessages = useMemo(() => {
    const grouped: Array<{ messages: ChatMessage[]; user: ChatMessage['user']; user_id: string }> = [];
    
    messages.forEach((message) => {
      const lastGroup = grouped[grouped.length - 1];
      if (lastGroup && lastGroup.user_id === message.user_id) {
        lastGroup.messages.push(message);
      } else {
        grouped.push({
          messages: [message],
          user: message.user,
          user_id: message.user_id
        });
      }
    });
    
    return grouped;
  }, [messages]);

  if (!user) {
    return (
      <Card className={className}>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <MessageSquare className="w-5 h-5" />
            Activity Chat
          </CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground text-center py-4">
            Please sign in to join the chat
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className={className}>
      <CardHeader>
        <CardTitle className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <MessageSquare className="w-5 h-5" />
            Activity Chat
            {messages.length > 0 && (
              <span className="text-sm font-normal text-muted-foreground">
                ({messages.length} messages)
              </span>
            )}
          </div>
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            <div className={cn("w-2 h-2 rounded-full", isConnected ? "bg-green-500" : "bg-gray-400")} />
            <span>{isConnected ? 'Connected' : 'Connecting...'}</span>
          </div>
        </CardTitle>
      </CardHeader>
      <CardContent className="p-0">
        {/* Messages Area */}
        <div ref={messagesContainerRef} className="h-64 overflow-y-auto p-4 space-y-4">
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <div className="text-muted-foreground">Loading messages...</div>
            </div>
          ) : messages.length === 0 ? (
            <div className="flex items-center justify-center h-full">
              <NoMessagesEmptyState />
            </div>
          ) : (
            groupedMessages.map((group, groupIndex) => (
              <div key={`group-${groupIndex}`} className="space-y-1">
                {group.messages.map((message, messageIndex) => {
                  const isOwnMessage = message.user_id === user.id;
                  const showHeader = messageIndex === 0;
                  
                  return (
                    <div
                      key={message.id}
                      className={cn(
                        "flex gap-3 animate-in fade-in slide-in-from-bottom-2 duration-300",
                        isOwnMessage ? "flex-row-reverse" : ""
                      )}
                    >
                      {showHeader && (
                        <Avatar className="w-8 h-8 flex-shrink-0">
                          {message.user?.avatar && (
                            <AvatarImage src={message.user.avatar} />
                          )}
                          <AvatarFallback className="text-xs">
                            {message.user?.name?.charAt(0)?.toUpperCase() || 'U'}
                          </AvatarFallback>
                        </Avatar>
                      )}
                      {!showHeader && <div className="w-8" />}
                      
                      <div className={cn("flex-1 max-w-[70%]", isOwnMessage ? "text-right" : "")}>
                        {showHeader && !isOwnMessage && (
                          <div className="flex items-center gap-2 text-xs mb-1">
                            <span className="font-medium">{message.user?.name || 'Unknown'}</span>
                            <span className="text-muted-foreground">
                              {formatDistanceToNow(new Date(message.created_at), { addSuffix: true })}
                            </span>
                          </div>
                        )}
                        
                        <div
                          className={cn(
                            "rounded-xl px-3 py-2 text-sm w-fit",
                            isOwnMessage
                              ? "bg-primary text-primary-foreground ml-auto"
                              : "bg-muted"
                          )}
                        >
                          {message.message}
                        </div>
                        
                        {isOwnMessage && showHeader && (
                          <div className="text-xs text-muted-foreground mt-1">
                            {formatDistanceToNow(new Date(message.created_at), { addSuffix: true })}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            ))
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Enhanced Input Area */}
        <div className="border-t p-4">
          <div className="flex gap-2">
            <Input
              value={newMessage}
              onChange={(e) => setNewMessage(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder={isConnected ? "Type a message..." : "Connecting..."}
              disabled={isSending || !isConnected}
              className={cn(
                "flex-1 rounded-full transition-all duration-300",
                newMessage.trim() ? "pr-12" : ""
              )}
            />
            {newMessage.trim() && (
              <Button
                onClick={sendMessage}
                disabled={!newMessage.trim() || isSending || !isConnected}
                size="sm"
                className="rounded-full aspect-square animate-in fade-in slide-in-from-right-2 duration-300"
              >
                <Send className="w-4 h-4" />
              </Button>
            )}
          </div>
          {/* Connection status removed - already shown in header */}
        </div>
      </CardContent>
    </Card>
  );
}

```

`domains/games/components/GameCardSkeleton.tsx`:

```tsx
import { Card, CardContent } from '@/shared/components/ui/card';
import { Skeleton } from '@/shared/components/ui/skeleton';

export function GameCardSkeleton() {
  return (
    <Card className="w-full">
      <CardContent className="p-4">
        <div className="space-y-3">
          {/* Header */}
          <div className="flex items-start justify-between">
            <div className="space-y-2 flex-1">
              <Skeleton className="h-5 w-3/4" />
              <Skeleton className="h-4 w-1/2" />
            </div>
            <Skeleton className="h-8 w-16" />
          </div>
          
          {/* Location and time */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Skeleton className="h-4 w-4" />
              <Skeleton className="h-4 w-2/3" />
            </div>
            <div className="flex items-center gap-2">
              <Skeleton className="h-4 w-4" />
              <Skeleton className="h-4 w-1/3" />
            </div>
            <div className="flex items-center gap-2">
              <Skeleton className="h-4 w-4" />
              <Skeleton className="h-4 w-1/4" />
            </div>
          </div>
          
          {/* Description */}
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-3/4" />
          
          {/* Footer */}
          <div className="flex items-center justify-between pt-2">
            <Skeleton className="h-6 w-20" />
            <Skeleton className="h-8 w-16" />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

export function GameDetailsSkeleton() {
  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border">
        <div className="flex items-center justify-between p-4">
          <Skeleton className="h-8 w-8" />
          <div className="flex gap-2">
            <Skeleton className="h-8 w-8" />
            <Skeleton className="h-8 w-8" />
            <Skeleton className="h-8 w-8" />
          </div>
        </div>
      </div>

      <div className="px-4 py-6 space-y-6">
        {/* Hero Image */}
        <Skeleton className="h-48 w-full rounded-lg" />
        
        {/* Basic Info */}
        <div className="space-y-4">
          <div className="space-y-2">
            <Skeleton className="h-8 w-3/4" />
            <Skeleton className="h-4 w-1/2" />
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Skeleton className="h-4 w-16" />
              <Skeleton className="h-4 w-24" />
            </div>
            <div className="space-y-2">
              <Skeleton className="h-4 w-16" />
              <Skeleton className="h-4 w-20" />
            </div>
          </div>
        </div>
        
        {/* Description */}
        <div className="space-y-2">
          <Skeleton className="h-4 w-20" />
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-3/4" />
        </div>
        
        {/* Join Button */}
        <Skeleton className="h-12 w-full" />
        
        {/* Players List */}
        <div className="space-y-4">
          <Skeleton className="h-6 w-32" />
          <div className="space-y-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="flex items-center gap-3">
                <Skeleton className="h-10 w-10 rounded-full" />
                <div className="space-y-2 flex-1">
                  <Skeleton className="h-4 w-24" />
                  <Skeleton className="h-3 w-16" />
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
```

`domains/games/components/GameChat.tsx`:

```tsx
// Enhanced GameChat with realtime features and presence tracking
export { EnhancedGameChat as GameChat } from './EnhancedGameChat';

// Legacy GameChat component (backup available as GameChat.backup.tsx)
// This file now exports the enhanced version for improved functionality

```

`domains/games/components/GameDetails.tsx`:

```tsx
import React, { useState, useEffect, useMemo } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback } from '@/shared/components/ui/avatar';
import { ClickableAvatar } from '@/shared/components/ui/clickable-avatar';
import { Separator } from '@/shared/components/ui/separator';
import { GameChat } from './GameChat';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { SimpleCalendarButton } from '@/shared/components/common/SimpleCalendarButton';
import { WeatherWidget } from '@/domains/weather/components/WeatherWidget';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/shared/components/ui/dropdown-menu';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/shared/components/ui/dialog';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { 
  ArrowLeft, 
  Calendar, 
  MapPin, 
  Users, 
  MessageCircle, 
  Share, 
  Flag, 
  Clock,
  DollarSign,
  Star,
  Navigation,
  Loader2,
  Edit3,
  Route,
  Mountain,
  Trash2,
  MoreVertical,
  RefreshCw,
  Copy,
} from 'lucide-react';
import { ImageWithFallback } from '@/shared/components/figma/ImageWithFallback';
import { useAppStore } from '@/store/appStore';
import { useGame, useGameParticipants, gameKeys } from '@/domains/games/hooks/useGames';
import { useGameParticipantsRealtime } from '@/domains/games/hooks/useGameParticipants';
import { useGameJoinToggle } from '@/domains/games/hooks/useGameJoinToggle';
import { useQueryClient } from '@tanstack/react-query';
import { useDeepLinks } from '@/shared/hooks/useDeepLinks';
import { QuickJoinModal } from './QuickJoinModal';
import { ShareGameModal } from './ShareGameModal';
import { PostGameRatingModal } from './PostGameRatingModal';
import { RouteDisplayMap } from '@/domains/locations/components/RouteDisplayMap';
import { RSVPSection, AttendeeList, type Attendee, type RSVPStatus } from '@/domains/games/components';
import { Facepile } from '@/shared/components/ui';
import { toast } from 'sonner';
import { SupabaseService } from '@/core/database/supabaseService';
import { supabase } from '@/core/database/supabase';
import { formatEventHeader, formatCalendarInfo, formatTimeString, formatCost } from '@/shared/utils/dateUtils';

function GameDetails() {
  console.log(' GAMEDETAILS COMPONENT LOADED - CACHE REFRESH WORKED!');
  console.log('üî• GAMEDETAILS COMPONENT LOADED - CACHE REFRESH WORKED!');
  const navigate = useNavigate();
  const { gameId } = useParams();
  const { user } = useAppStore();
  const queryClient = useQueryClient();
  
  // Helper function for difficulty color coding
  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'Easy': return 'bg-green-100 text-green-800';
      case 'Moderate': return 'bg-yellow-100 text-yellow-800';
      case 'Hard': return 'bg-orange-100 text-orange-800';
      case 'Expert': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  // Use React Query for game data and mutations
  const { data: game, isLoading, error: gameError } = useGame(gameId || '');
  const { data: participants = [], isLoading: loadingPlayers, error: participantsError, refetch: refetchParticipants } = useGameParticipants(gameId || '');
  const { toggleJoin, isLoading: actionLoading, getButtonText } = useGameJoinToggle();
  
  // Set up realtime subscription for participants updates
  useGameParticipantsRealtime(gameId || null);
  
  // Add timeout for loading states to prevent infinite loading
  const [loadingTimeout, setLoadingTimeout] = useState(false);
  
  useEffect(() => {
    if (isLoading || loadingPlayers) {
      const timeout = setTimeout(() => {
        setLoadingTimeout(true);
        console.warn('‚è∞ Loading timeout reached for GameDetails');
      }, 15000); // 15 second timeout
      
      return () => clearTimeout(timeout);
    } else {
      setLoadingTimeout(false);
    }
  }, [isLoading, loadingPlayers]);

  // Ensure participants are refetched when gameId changes
  useEffect(() => {
    if (gameId) {
      console.log('üîÑ GameDetails: gameId changed, participants should refetch:', gameId);
      // Force refetch participants when gameId changes
      refetchParticipants();
    }
  }, [gameId, refetchParticipants]);

  const { shareGame, navigateToChat, navigateToUser, generateGameUrl } = useDeepLinks();
  const [showFullDescription, setShowFullDescription] = useState(false);
  const [showQuickJoin, setShowQuickJoin] = useState(false);
  const [showInvite, setShowInvite] = useState(false);
  const [showEditDialog, setShowEditDialog] = useState(false);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [showRatingModal, setShowRatingModal] = useState(false);
  const [editActionLoading, setEditActionLoading] = useState(false);
  const [editFormData, setEditFormData] = useState<{
    title: string;
    description: string;
    location: string;
    date: string;
    time: string;
    duration: number | string;
    maxPlayers: number;
    cost: string;
    skillLevel?: string;
  }>({
    title: '',
    description: '',
    location: '',
    date: '',
    time: '',
    duration: 60,
    maxPlayers: 0,
    cost: '',
    skillLevel: ''
  });
  const [deleteReason, setDeleteReason] = useState('');
  const [capacity, setCapacity] = useState<any | null>(null);
  const [rsvpError, setRsvpError] = useState<string | null>(null);
  
  // Load initial capacity stats
  useEffect(() => {
    let cancelled = false;
    (async () => {
      if (!gameId) return;
      try {
        const { data, error } = await supabase
          .from('game_rsvp_stats')
          .select('*')
          .eq('game_id', gameId)
          .single();
        if (!cancelled && !error && data) {
          setCapacity(data);
        }
      } catch (err) {
        // Ignore errors, capacity is optional
      }
    })();
    return () => { cancelled = true; };
  }, [gameId]);

  // Refresh capacity when participants change
  useEffect(() => {
    if (!gameId) return;
    let cancelled = false;
    (async () => {
      try {
        const { data, error } = await supabase
          .from('game_rsvp_stats')
          .select('*')
          .eq('game_id', gameId)
          .single();
        if (!cancelled && !error && data) {
          setCapacity(data);
        }
      } catch (err) {
        // Ignore errors
      }
    })();
    return () => { cancelled = true; };
  }, [gameId, participants.length]);

  // Auto-join game if redirected from public page
  useEffect(() => {
    const autoJoinGameId = localStorage.getItem('autoJoinGame');
    
    if (autoJoinGameId && gameId && autoJoinGameId === gameId && game && user) {
      // Check if user is already a participant
      const isParticipant = participants.some(p => p.id === user.id);
      
      if (!isParticipant && !actionLoading) {
        console.log('üéØ Auto-joining game from public page redirect:', gameId);
        
        // Clear the auto-join flag immediately to prevent duplicate attempts
        localStorage.removeItem('autoJoinGame');
        
        // Auto-join the game
        toggleJoin(gameId, false).then(() => {
          toast.success('Successfully joined the game!');
          // Refresh participants list
          refetchParticipants();
        }).catch((error) => {
          console.error('Auto-join failed:', error);
          toast.error('Failed to join game. You can try joining manually.');
        });
      } else if (isParticipant) {
        // User is already in the game, just clear the flag
        console.log('‚úÖ User already in game, clearing auto-join flag');
        localStorage.removeItem('autoJoinGame');
      }
    }
  }, [gameId, game, user, participants, actionLoading, toggleJoin, refetchParticipants]);
  
  // Process participants data to mark the host correctly
  const players = useMemo(() => {
    if (!participants || !game) return [];
    return participants.map(player => ({
      ...player,
      isHost: player.id === game?.creator_id
    }));
  }, [participants, game?.creator_id]);

  // Convert players to Attendee format for RSVPSection
  const attendees: Attendee[] = useMemo(() => {
    if (!players || !game) return [];
    return players.map(player => ({
      id: player.id,
      name: player.name,
      avatar: player.avatar,
      email: player.email,
      status: 'going' as RSVPStatus, // All current participants are "going"
      isHost: player.isHost || player.id === game?.creator_id,
      isOrganizer: player.isHost || player.id === game?.creator_id,
      isGuest: player.isGuest || false,
      joinedAt: player.joinedAt,
    }));
  }, [players, game?.creator_id]);

  // Get current user's RSVP status
  const userRSVPStatus: RSVPStatus | undefined = useMemo(() => {
    if (!user?.id || !game?.isJoined) return undefined;
    return 'going';
  }, [user?.id, game?.isJoined]);

  // Debug logging (moved after players and attendees are defined)
  useEffect(() => {
    console.log('üìä GameDetails participants data:', {
      participants,
      participantsLength: participants?.length,
      loadingPlayers,
      participantsError,
      gameId,
      playersLength: players?.length,
      attendeesLength: attendees?.length
    });
  }, [participants, loadingPlayers, participantsError, gameId, players, attendees]);
  
  // Force refetch participants on mount if empty and not loading
  useEffect(() => {
    if (gameId && !loadingPlayers && participants.length === 0 && !participantsError) {
      console.log('üîÑ GameDetails: Participants empty, forcing refetch');
      refetchParticipants();
    }
  }, [gameId, loadingPlayers, participants.length, participantsError, refetchParticipants]);

  // Handle RSVP status change
  const handleRSVPChange = async (status: RSVPStatus) => {
    if (!gameId || !user?.id || !game) return;
    
    try {
      setRsvpError(null);
      
      if (status === 'going' && !game.isJoined) {
        // Join the game
        await toggleJoin(game);
        toast.success('Successfully joined the activity!');
      } else if (status !== 'going' && game.isJoined) {
        // Leave the game
        await toggleJoin(game);
        toast.success('Left the activity');
      }
      
      // Refresh capacity stats after RSVP change
      try {
        const { data, error } = await supabase
          .from('game_rsvp_stats')
          .select('*')
          .eq('game_id', gameId)
          .single();
        if (!error && data) {
          setCapacity(data);
        }
      } catch (err) {
        // Ignore capacity refresh errors
      }
      
      // Refetch participants to ensure UI is in sync
      refetchParticipants();
    } catch (error: any) {
      console.error('Failed to update RSVP:', error);
      const errorMessage = error?.message || 'Failed to update RSVP status';
      setRsvpError(errorMessage);
      toast.error(errorMessage);
    }
  };

  // Debug: Log route data structure
  useEffect(() => {
    if (game?.plannedRoute) {
      console.log('üó∫Ô∏è [GameDetails] Planned route data:', game.plannedRoute);
      console.log('üó∫Ô∏è [GameDetails] Route keys:', Object.keys(game.plannedRoute));
    }
  }, [game?.plannedRoute]);

  // Debug: Log game data including duration
  useEffect(() => {
    if (game) {
      console.log('üéÆ [GameDetails] Game data:', {
        id: game.id,
        duration: game.duration,
        durationType: typeof game.duration,
        durationValue: game.duration
      });
    }
  }, [game?.duration]);

  // Precompute formatted date/time labels for header and calendar
  const headerInfo = useMemo(() => {
    if (!game) return { label: '', aria: '' };
    return formatEventHeader(game.date, game.time);
  }, [game?.date, game?.time]);

  const calendarInfo = useMemo(() => {
    if (!game) return { date: '', time: '' };
    return formatCalendarInfo(game.date, game.time);
  }, [game?.date, game?.time]);

  // Capacity data - prioritize game data from games_with_counts view
  // This ensures we use the correct total_players from the view
  const capacityData = useMemo(() => {
    // Primary: Use game data from games_with_counts view (most accurate)
    if (game?.totalPlayers !== undefined && game?.totalPlayers !== null) {
      return {
        totalPlayers: game.totalPlayers,
        maxPlayers: game.maxPlayers ?? 0,
        availableSpots: game.availableSpots ?? Math.max(0, (game.maxPlayers ?? 0) - (game.totalPlayers ?? 0))
      };
    }
    // Fallback: Use capacity stats if game data not available
    if (capacity) {
      return {
        totalPlayers: capacity.total_rsvps ?? 0,
        maxPlayers: capacity.capacity ?? game?.maxPlayers ?? 0,
        availableSpots: capacity.capacity_remaining ?? 0
      };
    }
    // Final fallback: Use participants count
    return {
      totalPlayers: participants?.length ?? 0,
      maxPlayers: game?.maxPlayers ?? 0,
      availableSpots: Math.max(0, (game?.maxPlayers ?? 0) - (participants?.length ?? 0))
    };
  }, [game?.totalPlayers, game?.maxPlayers, game?.availableSpots, capacity, participants?.length]);

  const isFull = capacityData.availableSpots === 0;
  const tags: string[] | undefined = game ? (game as any).tags : undefined;

  // Check if current user is the game creator
  const isGameCreator = user && game && (game.creatorId === user.id || game.createdBy === user.id);
  
  // Debug logging for dropdown visibility (development only)
  if (process.env.NODE_ENV === 'development') {
    console.log('üîç Dropdown Debug:', {
      user: user?.id,
      game: game?.id,
      creatorId: game?.creatorId,
      createdBy: game?.createdBy,
      isGameCreator: isGameCreator,
      showDropdown: isGameCreator,
      canEdit: user?.id === game?.creatorId
    });
  }

  // Check if game is completed and user participated
  const isGameCompleted = useMemo(() => {
    if (!game) return false;
    const gameDateTime = new Date(`${game.date} ${game.time}`);
    const now = new Date();
    return gameDateTime < now;
  }, [game?.date, game?.time]);

  const userParticipated = useMemo(() => {
    if (!user || !game) return false;
    return game.isJoined || isGameCreator;
  }, [user, game?.isJoined, isGameCreator]);

  // Show rating modal for completed games where user participated
  // DISABLED: Rating system tables/functions don't exist yet
  // useEffect(() => {
  //   if (isGameCompleted && userParticipated && user && !showRatingModal && gameId) {
  //     // Check if user has already rated this game
  //     const checkExistingRating = async () => {
  //       try {
  //         const reviews = await SupabaseService.getGameReviews(gameId);
  //         const userReview = reviews.find(review => review.reviewer_id === user.id);
  //         
  //         if (!userReview) {
  //           setShowRatingModal(true);
  //         }
  //       } catch (error) {
  //         // No existing review found, show modal
  //         setShowRatingModal(true);
  //       }
  //     };
  //     
  //     checkExistingRating();
  //   }
  // }, [isGameCompleted, userParticipated, user, gameId, showRatingModal]);
  
  // Handle loading and error states - AFTER all hooks
  if ((isLoading || loadingPlayers) && !loadingTimeout) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4" />
          <p className="text-muted-foreground">Loading game details...</p>
          <p className="text-xs text-muted-foreground mt-2">
            If this takes too long, try refreshing the page
          </p>
        </div>
      </div>
    );
  }

  // Handle timeout or errors
  if (loadingTimeout || gameError || participantsError) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center max-w-md mx-auto p-6">
          <div className="mb-4">
            <Flag className="w-12 h-12 mx-auto text-muted-foreground mb-2" />
            <h2 className="text-xl font-semibold mb-2">Loading Issues</h2>
            <p className="text-muted-foreground mb-4">
              {loadingTimeout 
                ? "The activity is taking too long to load. This might be due to database connection issues."
                : "There was an error loading the activity details."
              }
            </p>
            {(gameError || participantsError) && (
              <p className="text-xs text-red-500 mb-4">
                Error: {gameError?.message || participantsError?.message}
              </p>
            )}
          </div>
          <div className="space-y-2">
            <Button onClick={async () => {
              // Clear all caches and refetch
              await queryClient.resetQueries();
              await queryClient.refetchQueries();
            }} className="w-full">
              <RefreshCw className="w-4 h-4 mr-2" />
              Refresh Data
            </Button>
            <Button variant="outline" onClick={() => navigate('/')} className="w-full">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Home
            </Button>
          </div>
        </div>
      </div>
    );
  }
  
  if (!game) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl mb-4">Activity not found</h1>
          <p className="text-muted-foreground mb-4">The activity you're looking for doesn't exist or has been removed.</p>
          <Button onClick={() => navigate('/')}>Go Home</Button>
        </div>
      </div>
    );
  }


  const handleJoinLeave = async () => {
    // Prevent multiple rapid clicks
    if (actionLoading || !game) return;
    
    try {
      setRsvpError(null);
      
      // Check authentication status
      const { data: { user: authUser } } = await supabase.auth.getUser();
      
      // If user is not authenticated, show quick join modal
      if (!authUser) {
        console.log('üë§ User not authenticated, showing login modal');
        setShowQuickJoin(true);
        return;
      }
      
      // User is authenticated, proceed with join/leave
      console.log('‚úÖ User authenticated, proceeding with join/leave');
      await toggleJoin(game);
      
      // Refresh capacity stats after join/leave
      try {
        const { data, error } = await supabase
          .from('game_rsvp_stats')
          .select('*')
          .eq('game_id', gameId)
          .single();
        if (!error && data) {
          setCapacity(data);
        }
      } catch (err) {
        // Ignore capacity refresh errors
      }
      
      // Refetch participants to ensure UI is in sync
      refetchParticipants();
    } catch (error: any) {
      console.error('Failed to join/leave game:', error);
      const errorMessage = error?.message || 'Failed to update game status';
      setRsvpError(errorMessage);
      toast.error(errorMessage);
    }
  };

  const handleQuickJoinSuccess = async () => {
    console.log('üéâ Quick join success, attempting to join game');
    setShowQuickJoin(false);
    
    // Wait a moment for auth state to propagate
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Verify user is now authenticated
    const { data: { user: authUser } } = await supabase.auth.getUser();
    
    if (authUser && gameId && game) {
      console.log('‚úÖ User authenticated after signup, joining game:', gameId);
      
      // IMPORTANT: Use 'joined' not 'going' - 'going' is UI-only RSVP status
      const participantStatus = 'joined' as const;
      console.log(`üìù Quick join: inserting with status "${participantStatus}"`);
      
      // Join the game - use upsert to handle duplicates gracefully
      const { error } = await supabase
        .from('game_participants')
        .upsert(
          {
            game_id: gameId,
            user_id: authUser.id, // Explicitly include user_id
            status: participantStatus // Database expects: 'joined' | 'left' | 'completed' | 'no_show'
          },
          {
            onConflict: 'game_id,user_id'
          }
        );
      
      if (error) {
        // Check if it's a duplicate error (which is actually fine)
        if (error.code === '23505') {
          console.log('‚úÖ User already in game (duplicate), proceeding anyway');
          toast.success('Welcome! You\'re joining the game.');
          // Invalidate queries to update UI
          await queryClient.invalidateQueries({ queryKey: gameKeys.detail(gameId || '') });
          await queryClient.invalidateQueries({ queryKey: gameKeys.participants(gameId || '') });
          await queryClient.invalidateQueries({ queryKey: gameKeys.lists() });
          refetchParticipants();
        } else {
          console.error('‚ùå Failed to join game after signup:', error);
          toast.error('Failed to join game. Please try clicking Join again.');
        }
      } else {
        console.log('‚úÖ Successfully joined game after signup');
        toast.success('Welcome! You\'ve successfully joined the game.');
        
        // Invalidate and refetch game data
        await queryClient.invalidateQueries({ queryKey: gameKeys.detail(gameId || '') });
        await queryClient.invalidateQueries({ queryKey: gameKeys.participants(gameId || '') });
        await queryClient.invalidateQueries({ queryKey: gameKeys.lists() });
        refetchParticipants();
      }
    } else {
      console.warn('‚ö†Ô∏è User not authenticated after quick join success');
      toast.error('Please log in and try joining again');
    }
  };

  const handleBack = () => {
    navigate(-1);
  };

  const handleChat = () => {
    navigateToChat('game', gameId!);
  };


  const handleShare = async () => {
    setShowInvite(true);
  };

  const handleCopyLink = async () => {
    if (!gameId) return;
    
    try {
      const gameUrl = generateGameUrl(gameId);
      await navigator.clipboard.writeText(gameUrl);
      toast.success('Link copied to clipboard!', {
        description: 'Share this link with others to invite them to the game',
      });
    } catch (error) {
      console.error('Failed to copy link:', error);
      toast.error('Failed to copy link', {
        description: 'Please try again',
      });
    }
  };

  const handleDirections = () => {
    const address = game.location || "Location not specified";
    const encodedAddress = encodeURIComponent(address);
    
    // Try to open in native maps app first, fallback to Google Maps
    const mapsUrl = `https://maps.google.com/maps?q=${encodedAddress}&t=m&z=16`;
    
    try {
      // For mobile devices, try to open native maps
      if (navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)) {
        const nativeUrl = `maps://maps.google.com/maps?q=${encodedAddress}`;
        window.location.href = nativeUrl;
        
        // Fallback to web maps if native doesn't open
        setTimeout(() => {
          window.open(mapsUrl, '_blank');
        }, 1000);
      } else {
        window.open(mapsUrl, '_blank');
      }
      
      toast.success('Opening directions...');
    } catch (error) {
      toast.error('Failed to open directions');
    }
  };

  const handleAddToCalendar = () => {
    if (!game) return;
    
    // Create event details
    const gameDateTime = new Date(`${game.date}T${game.time}`);
    const endDateTime = new Date(gameDateTime);
    
    // Use game duration if available, otherwise default to 2 hours
    const durationMinutes = typeof game.duration === 'number' 
      ? game.duration 
      : parseInt(String(game.duration)) || 120; // Default to 2 hours if not available
    endDateTime.setMinutes(endDateTime.getMinutes() + durationMinutes);
    
    const title = `${game.sport}: ${game.title}`;
    const description = `Join us for ${game.sport}!\n\n${game.description || ''}\n\nMax Players: ${game.maxPlayers || (game as any).max_players}\nCost: ${game.cost || 'Free'}`;
    const location = game.location;
    
    // Format dates (YYYYMMDDTHHMMSSZ)
    const formatDate = (date: Date) => date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    
    // Detect device and use appropriate calendar
    const userAgent = navigator.userAgent;
    
    if (/iPhone|iPad|iPod/.test(userAgent)) {
      // iOS - Create .ics file and try to open with Calendar app
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//TribeUp//TribeUp Social Sports//EN',
        'BEGIN:VEVENT',
        `UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@tribeup.app`,
        `DTSTART:${formatDate(gameDateTime)}`,
        `DTEND:${formatDate(endDateTime)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        `DTSTAMP:${formatDate(new Date())}`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      const blob = new Blob([icsContent], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      
      // Try to open with Calendar app
      window.location.href = url;
      
      // Cleanup after a delay
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      
    } else if (/Android/.test(userAgent)) {
      // Android - Use Google Calendar
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(gameDateTime)}/${formatDate(endDateTime)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
      window.open(googleUrl, '_blank');
      
    } else if (/Mac/.test(userAgent)) {
      // macOS - Create .ics file for Calendar app
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//TribeUp//TribeUp Social Sports//EN',
        'BEGIN:VEVENT',
        `UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@tribeup.app`,
        `DTSTART:${formatDate(gameDateTime)}`,
        `DTEND:${formatDate(endDateTime)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        `DTSTAMP:${formatDate(new Date())}`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
    } else {
      // Default - Google Calendar for all other devices
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(gameDateTime)}/${formatDate(endDateTime)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
      window.open(googleUrl, '_blank');
    }
  };

  const handleEditGame = () => {
    console.log('üö® [EDIT] Edit button clicked!');
    console.log('üö® [EDIT] Game object:', game);
    console.log('üö® [EDIT] Game duration:', game.duration, typeof game.duration);
    
    const formData = {
      title: game.title || '',
      description: game.description || '',
      location: game.location || '',
      date: game.date || '',
      time: game.time || '',
      duration: Number(game.duration) || 60,
      maxPlayers: game.maxPlayers || 0,
      cost: game.cost || '',
      skillLevel: game.skillLevel || ''
    };
    
    console.log('üö® [EDIT] Setting form data:', formData);
    setEditFormData(formData);
    setShowEditDialog(true);
    console.log('üö® [EDIT] Dialog should be open now');
  };

  const handleSaveEdit = async () => {
    if (!gameId) return;
    
    console.log('üö® [SAVE] Save button clicked!');
    console.log('üö® [SAVE] Current form data:', editFormData);
    console.log('üö® [SAVE] Duration specifically:', {
      value: editFormData.duration,
      type: typeof editFormData.duration,
      isNumber: typeof editFormData.duration === 'number',
      isValid: !isNaN(Number(editFormData.duration))
    });
    
    // Harden parsing and validation - no silent fallbacks
    const rawDuration = String(editFormData.duration ?? '').trim();
    const parsedDuration = Number.parseInt(rawDuration, 10);
    
    if (!rawDuration || Number.isNaN(parsedDuration) || parsedDuration <= 0) {
      toast.error('Please enter a valid duration in minutes (minimum 1 minute)');
      return;
    }
    
    console.log('[Edit] Parsed duration:', {
      raw: rawDuration,
      parsed: parsedDuration,
      isValid: !Number.isNaN(parsedDuration) && parsedDuration > 0
    });
    
    setEditActionLoading(true);
    try {
      const updatePayload = {
        ...editFormData,
        duration: parsedDuration // Ensure we use the parsed number
      };
      
      console.log('[Edit] Update payload:', updatePayload);
      
      await SupabaseService.updateGame(gameId, updatePayload);
      
      // Verify the update worked by fetching the updated row
      const { data: updatedGame } = await supabase
        .from('games')
        .select('id, duration_minutes, duration')
        .eq('id', gameId)
        .single();
      
      console.log('[Edit] Updated row from DB:', updatedGame);
      
      toast.success('Game updated successfully');
      setShowEditDialog(false);
      
      // Invalidate and refetch game data to update the UI
      await queryClient.invalidateQueries({ queryKey: gameKeys.detail(gameId || '') });
      await queryClient.invalidateQueries({ queryKey: gameKeys.lists() });
      // Optionally refetch immediately for instant update
      await queryClient.refetchQueries({ queryKey: gameKeys.detail(gameId || '') });
    } catch (error: any) {
      console.error('[Edit] Update failed:', error);
      console.error('[Edit] Full error details:', {
        error,
        message: error?.message,
        details: error?.details,
        hint: error?.hint,
        code: error?.code
      });
      toast.error('Failed to update game', {
        description: error.message || 'Please try again later'
      });
    } finally {
      setEditActionLoading(false);
    }
  };

  const handleDeleteGame = async () => {
    if (!gameId) return;
    
    setEditActionLoading(true);
    try {
      await SupabaseService.deleteGame(gameId, deleteReason);
      toast.success('Game cancelled successfully');
      setShowDeleteDialog(false);
      navigate('/');
    } catch (error: any) {
      toast.error('Failed to cancel game', {
        description: error.message || 'Please try again later'
      });
    } finally {
      setEditActionLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-background" style={{ overflowAnchor: 'none' } as React.CSSProperties}>
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="flex items-center justify-between px-4 py-4">
          <div className="flex items-center gap-4">
            <Button 
              variant="ghost" 
              size="icon" 
              onClick={handleBack}
              aria-label="Go back"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div role="text" aria-label={`Event: ${game.title}. ${headerInfo.aria}`}>
              <h1 className="text-xl font-semibold line-clamp-2">{game.title}</h1>
              <p className="text-sm text-muted-foreground">{headerInfo.label}</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Button 
              variant="ghost" 
              size="icon" 
              onClick={handleCopyLink}
              data-action="copy-link"
              aria-label="Copy game link"
              title="Copy game link to clipboard"
            >
              <Copy className="w-5 h-5" />
            </Button>
            <Button 
              variant="ghost" 
              size="icon" 
              onClick={handleShare}
              data-action="share"
              aria-label="Share activity"
              title="Share activity (U)"
            >
              <Share className="w-5 h-5" />
            </Button>
            <DropdownMenu onOpenChange={(open) => console.log('Dropdown open state:', open)}>
              <DropdownMenuTrigger asChild>
                <div>
                  <Button 
                    variant="ghost" 
                    size="icon"
                    aria-label="Game options"
                    onClick={(e) => {
                      console.log('Dropdown trigger clicked', e);
                      e.stopPropagation();
                    }}
                    style={{ display: isGameCreator ? 'flex' : 'none' }}
                  >
                    <MoreVertical className="w-5 h-5" />
                  </Button>
                </div>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end" className="z-[99999] relative">
                <DropdownMenuItem onClick={(e) => {
                  console.log('üö® DROPDOWN EDIT CLICKED!');
                  e.stopPropagation();
                  handleEditGame();
                }}>
                  <Edit3 className="w-4 h-4 mr-2" />
                  Edit Activity
                </DropdownMenuItem>
                <DropdownMenuItem 
                  onClick={(e) => {
                    console.log('Delete activity clicked');
                    e.stopPropagation();
                    setShowDeleteDialog(true);
                  }}
                  className="text-destructive focus:text-destructive"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Cancel Activity
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
            <Button 
              variant="ghost" 
              size="icon"
              aria-label="Report game"
            >
              <Flag className="w-5 h-5" />
            </Button>
          </div>
        </div>

      </div>

      <div className="px-4 py-6 space-y-6" id="main-content">
        {/* Hero Image & Basic Info */}
        <Card>
          {game.imageUrl && (
            <div className="relative">
              <div className="aspect-video overflow-hidden rounded-t-lg">
                <ImageWithFallback
                  src={game.imageUrl}
                  alt={`${game.sport} game`}
                  className="w-full h-full object-cover"
                />
              </div>
              <div className="absolute top-4 right-4 flex flex-col gap-2 items-end">
                <Badge className={`${game.sportColor} text-white border-none`}>
                  {game.sport}
                </Badge>
                {game.skillLevel && (
                  <Badge variant="outline" className="capitalize bg-background/90 backdrop-blur-sm">
                    {game.skillLevel}
                  </Badge>
                )}
              </div>
            </div>
          )}
          {!game.imageUrl && (
            <div className="p-4 border-b flex items-center gap-2 flex-wrap">
              <Badge className={`${game.sportColor} text-white border-none`}>
                {game.sport}
              </Badge>
              {game.skillLevel && (
                <Badge variant="outline" className="capitalize">
                  {game.skillLevel}
                </Badge>
              )}
            </div>
          )}
          
          <CardContent className="p-6">
            {/* Game Info Grid - even grid layout matching PublicGamePage */}
            <div className="grid grid-cols-2 gap-6 mb-6">
              {/* Players */}
              <div className="flex items-start gap-3">
                <Users className="w-5 h-5 text-muted-foreground mt-0.5" />
                <div className="flex-1">
                  <div className="font-medium mb-1">
                    {capacityData.totalPlayers}/{capacityData.maxPlayers} players
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {capacityData && capacityData.availableSpots > 0 ? (
                      <span className="text-green-600 dark:text-green-400">
                        {capacityData.availableSpots} spot{capacityData.availableSpots !== 1 ? 's' : ''} available
                      </span>
                    ) : (
                      'Capacity'
                    )}
                  </div>
                </div>
              </div>
              
              {/* Cost */}
              <div className="flex items-start gap-3">
                <DollarSign className="w-5 h-5 text-muted-foreground mt-0.5" />
                <div className="flex-1">
                  <div className="font-medium mb-1">{formatCost(game.cost)}</div>
                  <div className="text-sm text-muted-foreground">Cost</div>
                </div>
              </div>
              
              {/* Location */}
              <div className="flex items-start gap-3">
                <MapPin className="w-5 h-5 text-muted-foreground mt-0.5" />
                <div className="flex-1 min-w-0">
                  <button
                    onClick={handleDirections}
                    className="text-left hover:opacity-80 transition-opacity cursor-pointer group w-full"
                  >
                    <div className="font-medium mb-1 group-hover:text-primary">
                      {(() => {
                        if (!game.location) return 'Location TBD';
                        // Parse address and show only street address + neighborhood
                        const parts = game.location.split(',').map((s: string) => s.trim());
                        // Skip first part if it's a single word/sport name (like "NBA")
                        // Show street number + street name (usually parts 1-2 or 2-3)
                        const startIdx = parts[0] && parts[0].length < 5 && !parts[0].match(/\d/) ? 1 : 0;
                        // Take street address (usually 2 parts: number + street name)
                        // Plus one more part for neighborhood if available
                        return parts.slice(startIdx, startIdx + 3).join(', ');
                      })()}
                    </div>
                    <div className="text-sm text-muted-foreground">Location</div>
                  </button>
                </div>
              </div>
              
              {/* Date and Time */}
              <button
                onClick={handleAddToCalendar}
                className="flex items-start gap-3 text-left hover:opacity-80 transition-opacity cursor-pointer group w-full"
              >
                <Calendar className="w-5 h-5 text-muted-foreground mt-0.5 group-hover:text-primary" />
                <div className="flex-1">
                  <div className="font-medium mb-1 group-hover:text-primary">{calendarInfo.date}</div>
                  <div className="text-sm text-muted-foreground">{formatTimeString(game.time)}</div>
                </div>
              </button>
            </div>

            {/* Tags */}
            <div className="flex flex-wrap gap-2 mb-6">
              {Array.isArray(tags) && tags.map((tag: string) => (
                <Badge key={tag} variant="secondary">{tag}</Badge>
              ))}
            </div>

            {/* Join Button */}
            <Button
              onClick={handleJoinLeave}
              disabled={(!game.isJoined && isFull) || actionLoading}
              className="w-full h-12"
              variant={game.isJoined ? 'outline' : 'default'}
              data-action="join-game"
              title={`${game.isJoined ? 'Leave' : 'Join'} game (J)`}
            >
              {actionLoading ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  {game.isJoined ? 'Leaving...' : 'Joining...'}
                </>
              ) : isFull && !game.isJoined ? (
                `Game is Full (${capacityData.totalPlayers}/${capacityData.maxPlayers})`
              ) : !user ? (
                'Join Game - Sign Up'
              ) : (
                getButtonText(game)
              )}
            </Button>

            {/* Calendar Integration */}
            <SimpleCalendarButton 
              game={game} 
              variant="outline" 
              size="default"
              className="w-full h-12"
            />
          </CardContent>
        </Card>

        {/* Location */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <MapPin className="w-5 h-5" />
              Location
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <div>
                  {(() => {
                    if (!game.location) return 'Location TBD';
                    // Parse address and show street address + neighborhood + city + state (but not county/zip/country)
                    const parts = game.location.split(',').map((s: string) => s.trim());
                    // Skip first part if it's a single word/sport name (like "NBA")
                    const startIdx = parts[0] && parts[0].length < 5 && !parts[0].match(/\d/) ? 1 : 0;
                    
                    // Find where to stop - exclude county, zip, country
                    // Look for patterns like "County", zip codes (5 digits), "United States"
                    let endIdx = parts.length;
                    for (let i = startIdx; i < parts.length; i++) {
                      const part = parts[i].toLowerCase();
                      if (
                        part.includes('county') ||
                        part.includes('community board') ||
                        /^\d{5}$/.test(part) || // Zip code
                        part.includes('united states') ||
                        part === 'usa'
                      ) {
                        endIdx = i;
                        break;
                      }
                    }
                    
                    // Take up to 5 parts (street + neighborhood + city + state)
                    const maxParts = Math.min(5, endIdx - startIdx);
                    return parts.slice(startIdx, startIdx + maxParts).join(', ');
                  })()}
                </div>
              </div>
              
              <div 
                className="aspect-video bg-muted rounded-lg flex items-center justify-center"
                style={{ 
                  contain: 'layout',
                  overflowAnchor: 'none',
                } as React.CSSProperties}
              >
                {(game.latitude && game.longitude) || game.location ? (
                  <iframe
                    src={`https://www.google.com/maps/embed/v1/place?key=${(import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY || ''}&q=${
                      game.latitude && game.longitude 
                        ? `${game.latitude},${game.longitude}` 
                        : encodeURIComponent(game.location)
                    }&zoom=15`}
                    width="100%"
                    height="100%"
                    style={{ border: 0 }}
                    allowFullScreen
                    loading="lazy"
                    referrerPolicy="no-referrer-when-downgrade"
                    className="rounded-lg"
                    title="Game location map"
                  />
                ) : (
                  <div className="text-center text-muted-foreground">
                    <MapPin className="w-8 h-8 mx-auto mb-2" />
                    <p>Map not available</p>
                  </div>
                )}
              </div>
              
              <Button 
                variant="outline" 
                className="w-full"
                onClick={handleDirections}
                data-action="directions"
                title="Get directions (L)"
              >
                <Navigation className="w-4 h-4 mr-2" />
                Get Directions
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Weather */}
        {((game.latitude && game.longitude) || game.location) && (
          <WeatherWidget
            latitude={game.latitude}
            longitude={game.longitude}
            location={game.location}
            duration={game.duration || 60}
            sport={game.sport}
            gameDateTime={(() => {
              // Create proper datetime from game date and time
              const dateStr = game.date; // e.g., "2024-10-12"
              const timeStr = game.time; // e.g., "14:30" or "2:30 PM"
              
              console.log(`üéÆ Raw game data: date="${dateStr}", time="${timeStr}"`);
              
              // Handle different time formats
              let hour, minute;
              if (timeStr && timeStr.includes(':')) {
                const timeParts = timeStr.split(':');
                hour = parseInt(timeParts[0]);
                minute = parseInt(timeParts[1].split(' ')[0]); // Remove AM/PM if present
                
                // Handle AM/PM format
                if (timeStr.toLowerCase().includes('pm') && hour !== 12) {
                  hour += 12;
                } else if (timeStr.toLowerCase().includes('am') && hour === 12) {
                  hour = 0;
                }
              } else {
                console.warn(`üéÆ Invalid time format: "${timeStr}", using 12:00 PM`);
                hour = 12; // Default fallback
                minute = 0;
              }
              
              // Create date in local timezone to avoid UTC conversion issues
              const gameDateTime = new Date(dateStr + 'T00:00:00');
              gameDateTime.setHours(hour, minute, 0, 0);
              
              console.log(`üéÆ Parsed DateTime: ${dateStr} ${timeStr} ‚Üí ${gameDateTime.toISOString()}`);
              console.log(`üéÆ Local time: ${gameDateTime.toLocaleString()}`);
              console.log(`üéÆ Current time: ${new Date().toLocaleString()}`);
              
              const hoursDiff = (gameDateTime.getTime() - new Date().getTime()) / (1000 * 60 * 60);
              console.log(`üéÆ Time difference: ${hoursDiff > 0 ? `${Math.round(hoursDiff)} hours in future` : `${Math.round(Math.abs(hoursDiff))} hours in past`}`);
              
              return gameDateTime;
            })()}
          />
        )}

        {/* Planned Route - for running, hiking, cycling */}
        {(() => {
          const isRouteSport = ['running', 'hiking', 'cycling'].includes(game.sport.toLowerCase());
          const hasRoute = !!game.plannedRoute;
          
          console.log('üó∫Ô∏è [GameDetails] Route check:', {
            sport: game.sport,
            isRouteSport,
            hasRoute,
            plannedRoute: game.plannedRoute,
            routeType: typeof game.plannedRoute,
            routeKeys: game.plannedRoute ? Object.keys(game.plannedRoute) : []
          });
          
          if (!isRouteSport) return null;
          
          return hasRoute ? (
            <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Navigation className="w-5 h-5" />
                Planned Route
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {game.plannedRoute.name && (
                  <div>
                    <h4 className="font-medium mb-1">{game.plannedRoute.name}</h4>
                    {game.plannedRoute.description && (
                      <p className="text-sm text-muted-foreground">{game.plannedRoute.description}</p>
                    )}
                  </div>
                )}
                
                {/* Enhanced Route Analysis Display */}
                {game.plannedRoute.analysis ? (
                  <div className="space-y-4">
                    {/* Route Metrics */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Route className="w-5 h-5 mx-auto mb-2 text-blue-600" />
                        <p className="text-sm text-muted-foreground">Distance</p>
                        <p className="font-semibold">{game.plannedRoute.analysis.distance}</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Clock className="w-5 h-5 mx-auto mb-2 text-green-600" />
                        <p className="text-sm text-muted-foreground">Est. Time</p>
                        <p className="font-semibold">{game.plannedRoute.analysis.duration}</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Mountain className="w-5 h-5 mx-auto mb-2 text-orange-600" />
                        <p className="text-sm text-muted-foreground">Elevation Gain</p>
                        <p className="font-semibold">{game.plannedRoute.analysis.elevationGain}m</p>
                      </div>
                      <div className="text-center p-3 bg-muted/50 rounded-lg">
                        <Badge className={getDifficultyColor(game.plannedRoute.analysis.difficulty)}>
                          {game.plannedRoute.analysis.difficulty}
                        </Badge>
                        <p className="text-sm text-muted-foreground mt-1">Difficulty</p>
                      </div>
                    </div>

                    {/* Additional Route Details */}
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <span className="text-muted-foreground">Max Elevation:</span>
                        <span className="ml-2 font-medium">{game.plannedRoute.analysis.maxElevation}m</span>
                      </div>
                      <div>
                        <span className="text-muted-foreground">Avg Gradient:</span>
                        <span className="ml-2 font-medium">{game.plannedRoute.analysis.avgGradient}%</span>
                      </div>
                      <div>
                        <span className="text-muted-foreground">Elevation Loss:</span>
                        <span className="ml-2 font-medium">{game.plannedRoute.analysis.elevationLoss}m</span>
                      </div>
                      <div>
                        <span className="text-muted-foreground">Waypoints:</span>
                        <span className="ml-2 font-medium">{game.plannedRoute.path?.length || 0}</span>
                      </div>
                    </div>
                  </div>
                ) : (
                  /* Fallback to basic distance display */
                  (game.plannedRoute.distance || game.plannedRoute.distance_meters || game.plannedRoute.distance_km) && (
                    <div className="flex items-center gap-4 text-sm">
                      <div>
                        <span className="font-medium">
                          {(() => {
                            if (game.plannedRoute.distance) return game.plannedRoute.distance;
                            if (game.plannedRoute.distance_meters) return `${(game.plannedRoute.distance_meters / 1000).toFixed(2)} km`;
                            if (game.plannedRoute.distance_km) return `${game.plannedRoute.distance_km} km`;
                            return 'N/A';
                          })()}
                        </span>
                        <span className="text-muted-foreground ml-1">distance</span>
                      </div>
                    </div>
                  )
                )}
                
                {/* Interactive Route Map */}
                {game.plannedRoute.path && game.plannedRoute.path.length > 0 ? (
                  <div className="mt-4">
                    <h4 className="text-sm font-medium mb-2">Route Map</h4>
                    <RouteDisplayMap 
                      waypoints={game.plannedRoute.path}
                      sport={game.sport}
                      analysis={game.plannedRoute.analysis || undefined}
                    />
                  </div>
                ) : (
                  /* Fallback: Show route path/coordinates using Google Maps Static API only if no interactive map */
                  (() => {
                    // Try different path structures
                    const path = game.plannedRoute.coordinates || game.plannedRoute.waypoints;
                  
                  if (path && Array.isArray(path) && path.length > 0) {
                    // Normalize coordinate format helper
                    const getLat = (p: any): number | null => {
                      if (!p) return null;
                      if (typeof p === 'number') return p;
                      if (p.lat !== undefined) return p.lat;
                      if (p.latitude !== undefined) return p.latitude;
                      if (Array.isArray(p)) return p[1];
                      return null;
                    };
                    
                    const getLng = (p: any): number | null => {
                      if (!p) return null;
                      if (typeof p === 'number') return p;
                      if (p.lng !== undefined) return p.lng;
                      if (p.lon !== undefined) return p.lon;
                      if (p.longitude !== undefined) return p.longitude;
                      if (Array.isArray(p)) return p[0];
                      return null;
                    };
                    
                    // Filter out invalid coordinates
                    const validPath = path
                      .map(p => ({ lat: getLat(p), lng: getLng(p) }))
                      .filter(p => p.lat !== null && p.lng !== null) as Array<{ lat: number; lng: number }>;
                    
                    if (validPath.length < 2) {
                      return (
                        <div className="text-sm text-muted-foreground">
                          Route path requires at least 2 valid coordinates.
                        </div>
                      );
                    }
                    
                    // Calculate total distance
                    const calculateDistance = (p1: { lat: number; lng: number }, p2: { lat: number; lng: number }): number => {
                      const R = 6371; // Earth's radius in km
                      const lat1 = p1.lat * Math.PI / 180;
                      const lat2 = p2.lat * Math.PI / 180;
                      const dLat = lat2 - lat1;
                      const dLon = (p2.lng - p1.lng) * Math.PI / 180;
                      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2);
                      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                      return R * c;
                    };
                    
                    let totalDistance = 0;
                    for (let i = 0; i < validPath.length - 1; i++) {
                      totalDistance += calculateDistance(validPath[i], validPath[i + 1]);
                    }
                    
                    // Build Google Maps Static API URL with path
                    const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY || '';
                    const pathStr = validPath.map(p => `${p.lat},${p.lng}`).join('|');
                    
                    // Calculate center and zoom for the map
                    const lats = validPath.map(p => p.lat);
                    const lngs = validPath.map(p => p.lng);
                    const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
                    const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;
                    const latDiff = Math.max(...lats) - Math.min(...lats);
                    const lngDiff = Math.max(...lngs) - Math.min(...lngs);
                    const maxDiff = Math.max(latDiff, lngDiff);
                    // Calculate zoom level (zoomed in more - higher zoom values)
                    let zoom = 16; // Default to higher zoom
                    if (maxDiff > 0.1) zoom = 12;
                    else if (maxDiff > 0.05) zoom = 13;
                    else if (maxDiff > 0.02) zoom = 14;
                    else if (maxDiff > 0.01) zoom = 15;
                    else if (maxDiff > 0.005) zoom = 16;
                    else zoom = 17; // Very zoomed in for small routes
                    
                    const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=600x400&maptype=roadmap&zoom=${zoom}&path=weight:5|color:0x0000ff|${pathStr}&markers=color:green|label:S|${validPath[0].lat},${validPath[0].lng}&markers=color:red|label:E|${validPath[validPath.length - 1].lat},${validPath[validPath.length - 1].lng}&key=${apiKey}`;
                    
                    return (
                      <>
                        {/* Show calculated distance if not already shown */}
                        {totalDistance > 0 && !game.plannedRoute.distance && !game.plannedRoute.distance_meters && !game.plannedRoute.distance_km && (
                          <div className="flex items-center gap-4 text-sm mb-4">
                            <div>
                              <span className="font-medium">{totalDistance.toFixed(2)} km</span>
                              <span className="text-muted-foreground ml-1">distance</span>
                            </div>
                          </div>
                        )}
                        <div className="aspect-video bg-muted rounded-lg overflow-hidden">
                          <a 
                            href={(() => {
                              // Determine travel mode based on sport
                              const sportLower = game.sport.toLowerCase();
                              let mode = 'walking'; // default
                              if (sportLower === 'cycling') {
                                mode = 'bicycling';
                              } else if (sportLower === 'running' || sportLower === 'hiking' || sportLower === 'walking') {
                                mode = 'walking';
                              }
                              // Use Google Maps directions URL with correct travel mode
                              const first = validPath[0];
                              const last = validPath[validPath.length - 1];
                              const waypoints = validPath.slice(1, -1);
                              const waypointStr = waypoints.length > 0 
                                ? `/${waypoints.map(p => `${p.lat},${p.lng}`).join('/')}`
                                : '';
                              return `https://www.google.com/maps/dir/${first.lat},${first.lng}${waypointStr}/${last.lat},${last.lng}/data=!3m1!4b1!4m2!4m1!3e2?mode=${mode}`;
                            })()}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="block w-full h-full"
                          >
                            <img
                              src={staticMapUrl}
                              alt="Route map"
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                console.error('Failed to load static map, falling back to interactive map');
                                // Fallback to interactive iframe
                                const first = validPath[0];
                                const last = validPath[validPath.length - 1];
                                const waypoints = validPath.slice(1, -1);
                                const waypointStr = waypoints.length > 0 
                                  ? `&waypoints=${waypoints.map(p => `${p.lat},${p.lng}`).join('|')}`
                                  : '';
                                const iframeSrc = `https://www.google.com/maps/embed/v1/directions?key=${apiKey}&origin=${first.lat},${first.lng}&destination=${last.lat},${last.lng}${waypointStr}&zoom=${zoom}`;
                                (e.target as HTMLImageElement).style.display = 'none';
                                const container = (e.target as HTMLElement).parentElement;
                                if (container) {
                                  container.innerHTML = `<iframe src="${iframeSrc}" width="100%" height="100%" style="border:0" allowfullscreen loading="lazy"></iframe>`;
                                }
                              }}
                            />
                          </a>
                        </div>
                      </>
                    );
                  }
                  
                  // Fallback: Try polyline if available
                  if (game.plannedRoute.polyline) {
                    const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY || '';
                    const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=600x400&maptype=roadmap&path=weight:5|color:0x0000ff|enc:${encodeURIComponent(game.plannedRoute.polyline)}&key=${apiKey}`;
                    
                    return (
                      <div className="aspect-video bg-muted rounded-lg overflow-hidden">
                        <img
                          src={staticMapUrl}
                          alt="Route map"
                          className="w-full h-full object-cover"
                        />
                      </div>
                    );
                  }
                  
                  return null;
                })()
                )}
                
                {/* Fallback message if no route data available */}
                {!game.plannedRoute.path && !game.plannedRoute.polyline && !game.plannedRoute.coordinates && !game.plannedRoute.waypoints && (
                  <div className="text-sm text-muted-foreground">
                    No route path available for display.
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
          ) : (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Navigation className="w-5 h-5" />
                  Planned Route
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-sm text-muted-foreground">
                  No route has been planned for this {game.sport} activity.
                </div>
              </CardContent>
            </Card>
          );
        })()}

        {/* Description */}
        <Card>
          <CardHeader>
            <CardTitle>About This Activity</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <p className={`text-sm leading-relaxed ${!showFullDescription ? 'line-clamp-3' : ''}`}>
                {game.description}
              </p>
              {game.description.length > 150 && (
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={() => setShowFullDescription(!showFullDescription)}
                  className="p-0 h-auto"
                >
                  {showFullDescription ? 'Show less' : 'Show more'}
                </Button>
              )}
              
              <div>
                <h4 className="mb-2">Requirements</h4>
                <ul className="space-y-1">
                  {['Athletic shoes required', 'Bring water bottle', 'No experience necessary'].map((req, index) => (
                    <li key={index} className="text-sm text-muted-foreground flex items-start gap-2">
                      <span className="w-1 h-1 bg-muted-foreground rounded-full mt-2 flex-shrink-0"></span>
                      {req}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Host Information */}
        <Card>
          <CardHeader>
            <CardTitle>Activity Host</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="flex items-center gap-3">
                  <ClickableAvatar
                    userId={game.creatorId || game.creatorData?.id}
                    src={game.creatorData?.avatar}
                    alt={game.creatorData?.name || game.createdBy || 'Unknown'}
                    size="md"
                  />
                  <div>
                    <button 
                      onClick={() => navigateToUser(game.creatorId || game.creatorData?.id)}
                      className="hover:text-primary transition-colors cursor-pointer font-medium"
                      data-action="view-profile"
                    >
                      {game.creatorData?.name || game.createdBy || 'Unknown'}
                    </button>
                    {/* Rating temporarily hidden during early testing phase */}
                    {/* <div className="flex items-center gap-1 text-sm text-muted-foreground">
                      <Star className="w-3 h-3 fill-current text-warning" />
                      {game.creatorData?.rating || '4.5'}
                    </div> */}
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* RSVP Error Alert */}
        {rsvpError && (
          <Alert variant="destructive">
            <AlertDescription>{rsvpError}</AlertDescription>
          </Alert>
        )}

        {/* RSVP Section */}
        <RSVPSection
          attendees={attendees}
          currentUserId={user?.id}
          userRSVPStatus={userRSVPStatus}
          maxPlayers={capacityData.maxPlayers}
          currentPlayers={capacityData.totalPlayers}
          onRSVPChange={handleRSVPChange}
          onInvite={() => setShowInvite(true)}
          onAttendeeClick={(attendee) => {
            console.log('üéØ [GameDetails] onAttendeeClick called:', { attendee });
            // Navigate to user profile if attendee has a valid user ID
            if (attendee?.id && typeof attendee.id === 'string' && !attendee.id.startsWith('guest-') && !attendee.id.startsWith('temp-')) {
              try {
                console.log('üöÄ [GameDetails] Navigating to user:', attendee.id);
                navigateToUser(attendee.id);
              } catch (error) {
                console.error('‚ùå [GameDetails] Failed to navigate to user profile:', error);
                toast.error('Could not open user profile.');
              }
            } else {
              console.warn('‚ö†Ô∏è [GameDetails] Invalid attendee ID:', attendee?.id);
              toast.info('Cannot open profile for this attendee.');
            }
          }}
          showFullList={true}
        />

        {/* Join Status Alert */}
        {game.isJoined && (
          <Alert className="border-success text-success-foreground">
            <AlertDescription>
              You're joined! See you on the field!
            </AlertDescription>
          </Alert>
        )}
      </div>

      {/* Activity Chat */}
      <div className="lg:col-span-4">
        <GameChat gameId={gameId!} />
      </div>

      {/* Quick Join Modal */}
      <QuickJoinModal
        isOpen={showQuickJoin}
        onClose={() => setShowQuickJoin(false)}
        gameTitle={game.title}
        gameId={game.id}
        onJoinSuccess={handleQuickJoinSuccess}
      />

      {/* Share Activity Modal */}
      <ShareGameModal
        isOpen={showInvite}
        onClose={() => setShowInvite(false)}
        game={game}
      />

      {/* Edit Game Dialog */}
      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>Edit Game</DialogTitle>
            <DialogDescription>
              Make changes to your game. Participants will be notified of any updates.
            </DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            <div className="space-y-2">
              <label htmlFor="edit-title" className="text-sm font-medium">
                Title
              </label>
              <Input
                id="edit-title"
                value={editFormData.title}
                onChange={(e) => setEditFormData(prev => ({ ...prev, title: e.target.value }))}
                placeholder="Game title"
              />
            </div>
            <div className="space-y-2">
              <label htmlFor="edit-description" className="text-sm font-medium">
                Description
              </label>
              <Textarea
                id="edit-description"
                value={editFormData.description}
                onChange={(e) => setEditFormData(prev => ({ ...prev, description: e.target.value }))}
                placeholder="Game description"
                rows={3}
              />
            </div>
            <div className="space-y-2">
              <label htmlFor="edit-location" className="text-sm font-medium">
                Location
              </label>
              <Input
                id="edit-location"
                value={editFormData.location}
                onChange={(e) => setEditFormData(prev => ({ ...prev, location: e.target.value }))}
                placeholder="Game location"
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <label htmlFor="edit-date" className="text-sm font-medium">
                  Date
                </label>
                <Input
                  id="edit-date"
                  type="date"
                  value={editFormData.date}
                  onChange={(e) => setEditFormData(prev => ({ ...prev, date: e.target.value }))}
                />
              </div>
              <div className="space-y-2">
                <label htmlFor="edit-time" className="text-sm font-medium">
                  Time
                </label>
                <Input
                  id="edit-time"
                  type="time"
                  value={editFormData.time}
                  onChange={(e) => setEditFormData(prev => ({ ...prev, time: e.target.value }))}
                />
              </div>
            </div>
            <div className="space-y-2">
              <label htmlFor="edit-duration" className="text-sm font-medium">
                Duration (minutes)
              </label>
              <Input
                id="edit-duration"
                type="number"
                min="1"
                max="480"
                step="1"
                value={editFormData.duration}
                onChange={(e) => {
                  const rawValue = e.target.value;
                  console.log('[Edit] Duration input changed:', {
                    rawValue,
                    currentState: editFormData.duration
                  });
                  
                  // Store as number for consistency with form state
                  const numValue = parseInt(rawValue, 10);
                  setEditFormData(prev => ({ 
                    ...prev, 
                    duration: isNaN(numValue) ? '' : numValue // Use empty string for invalid, not fallback
                  }));
                }}
                placeholder="Enter duration in minutes"
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <label htmlFor="edit-maxPlayers" className="text-sm font-medium">
                  Max Players
                </label>
                <Input
                  id="edit-maxPlayers"
                  type="number"
                  min="2"
                  max="50"
                  value={editFormData.maxPlayers}
                  onChange={(e) => setEditFormData(prev => ({ ...prev, maxPlayers: parseInt(e.target.value) || 0 }))}
                />
              </div>
              <div className="space-y-2">
                <label htmlFor="edit-cost" className="text-sm font-medium">
                  Cost
                </label>
                <Input
                  id="edit-cost"
                  value={editFormData.cost}
                  onChange={(e) => setEditFormData(prev => ({ ...prev, cost: e.target.value }))}
                  placeholder="FREE or $10"
                />
              </div>
            </div>
            <div className="space-y-2">
              <label htmlFor="edit-skillLevel" className="text-sm font-medium">
                Skill Level <span className="text-xs text-muted-foreground font-normal">(Optional)</span>
              </label>
              <Select 
                value={editFormData.skillLevel || 'none'} 
                onValueChange={(value) => setEditFormData(prev => ({ ...prev, skillLevel: value === 'none' ? '' : value }))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="All Levels" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">All Levels</SelectItem>
                  <SelectItem value="beginner">Beginner</SelectItem>
                  <SelectItem value="intermediate">Intermediate</SelectItem>
                  <SelectItem value="advanced">Advanced</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowEditDialog(false)}>
              Cancel
            </Button>
            <Button onClick={handleSaveEdit} disabled={editActionLoading}>
              {editActionLoading ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Saving...
                </>
              ) : (
                'Save Changes'
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Activity Dialog */}
      <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>Cancel Activity</DialogTitle>
            <DialogDescription>
              This action cannot be undone. All participants will be notified of the cancellation.
            </DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            <div className="space-y-2">
              <label htmlFor="delete-reason" className="text-sm font-medium">
                Reason for cancellation (optional)
              </label>
              <Textarea
                id="delete-reason"
                value={deleteReason}
                onChange={(e) => setDeleteReason(e.target.value)}
                placeholder="Let participants know why the activity is cancelled..."
                rows={3}
              />
            </div>
          </div>
          <DialogFooter>
            <Button 
              variant="outline" 
              onClick={() => setShowDeleteDialog(false)}
              className="border-border bg-background hover:bg-muted"
            >
              Keep Activity
            </Button>
            <Button 
              variant="destructive" 
              onClick={handleDeleteGame} 
              disabled={editActionLoading}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {editActionLoading ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Cancelling...
                </>
              ) : (
                'Cancel Activity'
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Post Game Rating Modal */}
      <PostGameRatingModal
        isOpen={showRatingModal}
        onClose={() => setShowRatingModal(false)}
        gameId={gameId!}
        gameTitle={game?.title || ''}
        players={players}
      />
    </div>
  );
}

export default GameDetails;
```

`domains/games/components/HomeScreen.tsx`:

```tsx
import { useState, useEffect, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { RefreshCw, MapPin, Users as UsersIcon, Flame, Clock, UserPlus, Calendar as CalendarIcon, Plus, Bell } from 'lucide-react';
import { useAppStore } from '@/store/appStore';
import { useGamesWithCreators } from '@/domains/games/hooks/useGamesWithCreators';
import { useLocation } from '@/domains/locations/hooks/useLocation';
import { useAllGamesRealtime } from '@/domains/games/hooks/useGameRealtime';
import { UnifiedGameCard } from './UnifiedGameCard';
import { GameCardSkeleton } from './GameCardSkeleton';
import { FeedbackButton } from '@/domains/users/components/FeedbackButton';
import { Badge } from '@/shared/components/ui/badge';
import { CampusEmptyState } from './CampusEmptyState';
import { useActivityFilters } from '@/domains/games/hooks/useActivityFilters';
import { useNotifications } from '@/domains/users/hooks/useNotifications';
import { brandColors } from '@/shared/config/theme';
import { useActivityGrouping } from '@/domains/games/hooks/useActivityGrouping';
import { NoFriendsEmptyState } from '@/shared/components/common/EmptyState';




function HomeScreen() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { games, userById, usersLoaded, loading: isLoading, error, refetch } = useGamesWithCreators();
  const [refreshing, setRefreshing] = useState(false);
  const [forceTimeout, setForceTimeout] = useState(false);
  const [showFollowingOnly, setShowFollowingOnly] = useState(false);
  
  // Location services for distance calculations
  const { currentLocation, permission, requestLocation, getFormattedDistanceTo, getDistanceTo } = useLocation();
  // Real-time updates for all games
  useAllGamesRealtime();
  
  // Notifications for badge
  const notifications = useNotifications();
  const unreadCount = notifications?.unreadCount || 0;
  
  // Filter activities
  const { filteredGames, gamesFriendCounts } = useActivityFilters({
    games,
    showFollowingOnly,
  });
  
  // Group and sort activities
  const { sortedGames, gamesBySection } = useActivityGrouping({
    games: filteredGames,
    gamesFriendCounts,
  });
  
  // Force timeout if loading takes too long
  useEffect(() => {
    if (isLoading) {
      const timeout = setTimeout(() => {
        setForceTimeout(true);
      }, 20000);
      
      return () => {
        clearTimeout(timeout);
        setForceTimeout(false);
      };
    }
  }, [isLoading]);
  
  // Game selection handler
  const handleGameSelect = (gameId: string) => {
    navigate(`/game/${gameId}`);
  };
  
  // Refetch handler to pass to game cards
  const handleGameUpdate = async () => {
    // Refetch games after join/leave mutation completes
    await refetch();
  };
  

  // Calculate basic stats
  const stats = useMemo(() => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    // Games available today
    const gamesToday = games.filter(game => {
      // Parse YYYY-MM-DD in local timezone consistently
      const [year, month, day] = game.date.split('-').map(Number);
      const gameDate = new Date(year, month - 1, day);
      return gameDate.getTime() === today.getTime();
    }).length;
    
    // Games nearby (within 10km)
    const gamesNearby = currentLocation ? games.filter(game => {
      if (!game.latitude || !game.longitude) return false;
      const distanceKm = getDistanceTo({ latitude: game.latitude, longitude: game.longitude }, 'km');
      return distanceKm !== null && distanceKm <= 10; // Within 10km
    }).length : 0;
    
    // Games user has created
    const gamesCreated = games.filter(game => game.creatorId === user?.id).length;
    
    // Games with people you follow
    const gamesWithFollowing = games.filter(game => {
      const followerCount = gamesFriendCounts?.[game.id] || 0;
      return followerCount > 0;
    }).length;

    return {
      totalGames: games.length,
      gamesToday,
      gamesNearby,
      gamesCreated,
      gamesWithFriends: gamesWithFollowing // Keep key name for backward compatibility
    };
  }, [games, user, currentLocation, getDistanceTo, gamesFriendCounts]);

  // No need for manual loading with React Query


  // Disabled realtime to prevent WebSocket connection issues
  // useEffect(() => {
  //   let timeoutId: NodeJS.Timeout;
  //   
  //   const sub = SupabaseService.subscribeToAllGames((payload) => {
  //     console.log('[Realtime] games INSERT received', payload?.new?.id || '');
  //     
  //     // Debounce realtime updates to avoid excessive API calls
  //     clearTimeout(timeoutId);
  //     timeoutId = setTimeout(async () => {
  //       try {
  //         const data = feedMode === 'recommended'
  //           ? await SupabaseService.getRecommendedGames(userPreferredSports)
  //           : await SupabaseService.getGames();
  //         setGames(data);
  //       } catch (error) {
  //         console.error('[Realtime] Failed to refresh games:', error);
  //       }
  //     }, 1000);
  //   });
  //   
  //   return () => {
  //     clearTimeout(timeoutId);
  //     try { sub.unsubscribe(); } catch {}
  //   };
  //   // eslint-disable-next-line react-hooks/exhaustive-deps
  // }, [feedMode, userPreferredSports.join?.('|') ?? '']);

  // No need for manual loading state cleanup with React Query


  // loadGames function removed - using React Query instead

  const handleRefresh = async () => {
    if (refreshing) return; // Prevent multiple concurrent refreshes
    
    setRefreshing(true);
    try {
      await refetch(); // React Query's refetch
    } finally {
      setRefreshing(false);
    }
  };


  // Show loading state with timeout handling
  if (isLoading && games.length === 0 && !forceTimeout) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center space-y-4">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Loading activities...</p>
          <p className="text-xs text-muted-foreground/70">
            {refreshing ? 'Refreshing...' : 'This should only take a moment'}
          </p>
          <Button 
            variant="outline" 
            size="sm" 
            onClick={() => {
              setForceTimeout(false);
              refetch();
            }}
          >
            Refresh Now
          </Button>
        </div>
      </div>
    );
  }
  
  // Show error state
  if ((!!error || error || forceTimeout) && games.length === 0) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center space-y-4">
          <div className="text-destructive text-lg font-semibold">
            {forceTimeout ? 'Loading Timeout' : 'Connection Error'}
          </div>
          <p className="text-muted-foreground max-w-md">
            {forceTimeout 
              ? 'Activities are taking too long to load. This might be a network or server issue.'
              : error?.message || 'Unable to load activities. Please check your connection.'}
          </p>
          <div className="flex gap-2 justify-center">
            <Button 
              onClick={() => {
                setForceTimeout(false);
                refetch();
              }}
            >
              <RefreshCw className="w-4 h-4 mr-2" />
              Try Again
            </Button>
          </div>
        </div>
      </div>
    );
  }


  return (
    <div className="min-h-screen bg-background">
      <div className="max-w-3xl mx-auto p-4 md:p-6">
        <div className="w-full">
          {/* Main Content - Single Column Feed */}
          <div className="w-full">
            {/* Header */}
            <div className="relative mb-6">
              <div className="absolute inset-0 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent rounded-2xl -z-10" />
              <div className="flex items-center justify-between p-4 md:p-6">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold bg-gradient-to-r from-foreground to-foreground/80 bg-clip-text text-transparent">
                    TribeUp
                  </h1>
                  <p className="text-muted-foreground text-sm">Find your next activity</p>
                </div>
                <div className="flex gap-2">
                  {/* Quick Create Button */}
                  <Button
                    onClick={() => navigate('/app/create')}
                    size="sm"
                    className="gap-2"
                    style={{
                      backgroundColor: brandColors.primary,
                      borderColor: brandColors.primary,
                    }}
                  >
                    <Plus className="w-4 h-4" />
                    <span className="hidden sm:inline">Create</span>
                  </Button>
                  
                  {/* Notifications Button */}
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => navigate('/app/notifications')}
                    className="relative"
                  >
                    <Bell className="w-4 h-4" />
                    {unreadCount > 0 && (
                      <Badge 
                        variant="destructive" 
                        className="absolute -top-1 -right-1 h-4 w-4 p-0 text-[10px] flex items-center justify-center min-w-[16px] rounded-full"
                      >
                        {unreadCount > 99 ? '99+' : unreadCount}
                      </Badge>
                    )}
                    <span className="hidden sm:inline ml-2">Notifications</span>
                  </Button>
                  
                  <FeedbackButton variant="outline" size="default" />
                </div>
              </div>
            </div>

            {/* Activities List Header */}
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-lg md:text-xl font-bold">Upcoming Activities</h2>
                <p className="text-xs text-muted-foreground">
                  {sortedGames.length} {sortedGames.length === 1 ? 'activity' : 'activities'} available
                </p>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={handleRefresh}
                disabled={isLoading}
                className="hidden md:flex shadow-sm hover:shadow-md transition-shadow"
              >
                <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                Refresh
              </Button>
              <Button
                variant="ghost"
                size="sm"
                onClick={handleRefresh}
                disabled={isLoading}
                className="md:hidden"
                aria-label="Refresh games"
              >
                <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
              </Button>
            </div>

            {/* Filters */}
            <div className="flex gap-2 mb-4 flex-wrap">
              <Button
                variant={showFollowingOnly ? "default" : "outline"}
                size="sm"
                onClick={() => setShowFollowingOnly(!showFollowingOnly)}
                className="gap-2 shadow-sm hover:shadow-md transition-all"
              >
                <UserPlus className="w-4 h-4" />
                Following
              </Button>
              {showFollowingOnly && (
                <Button
                  variant="secondary"
                  size="sm"
                  onClick={() => {
                    setShowFollowingOnly(false);
                  }}
                  className="gap-2"
                >
                  Clear Filters
                </Button>
              )}
            </div>

            {/* Activity Feed - Single Column Strava-Style */}
            <div className="space-y-6">
              {isLoading ? (
                // Show skeleton loading
                <div className="space-y-6">
                  {Array.from({ length: 6 }).map((_, index) => (
                    <GameCardSkeleton key={index} />
                  ))}
                </div>
              ) : sortedGames.length > 0 ? (
                <div className="space-y-6">
                  {sortedGames.map((game, index) => {
                    // Add subtle date divider for first game in each time period
                    const prevGame = index > 0 ? sortedGames[index - 1] : null;
                    const showDateDivider = !prevGame || prevGame.category !== game.category;
                    
                    return (
                      <div key={game.id}>
                        {/* Subtle Date Divider */}
                        {showDateDivider && (
                          <div className="flex items-center gap-3 mb-4 mt-2">
                            <div className="flex-1 h-px bg-border" />
                            <span className="text-xs font-medium text-muted-foreground uppercase tracking-wide">
                              {game.category === 'today' ? 'Today' : 
                               game.category === 'tomorrow' ? 'Tomorrow' : 
                               game.category === 'thisWeek' ? 'This Week' : 
                               'Upcoming'}
                            </span>
                            <div className="flex-1 h-px bg-border" />
                          </div>
                        )}
                        
                        <UnifiedGameCard
                          game={game}
                          variant="strava"
                          onSelect={() => handleGameSelect(game.id)}
                          onJoinLeave={handleGameUpdate}
                          distance={
                            currentLocation && game.latitude && game.longitude
                              ? getFormattedDistanceTo(
                                  { latitude: game.latitude, longitude: game.longitude },
                                  'mi'
                                )
                              : null
                          }
                        />
                      </div>
                    );
                  })}
                </div>
              ) : showFollowingOnly ? (
                // Special empty state for following filter
                <div className="col-span-full">
                  <div className="bg-card rounded-lg shadow-sm border border-border">
                    <NoFriendsEmptyState 
                      onFindFriends={() => navigate('/profile#following')}
                      onExploreGames={() => setShowFollowingOnly(false)}
                    />
                  </div>
                </div>
              ) : (
                    <CampusEmptyState
                      onCreateGame={() => navigate('/app/create')}
                      onExploreVenues={() => navigate('/app/search')}
                      title="No activities yet"
                      description="Be the first to create an activity!"
                    />
              )}
            </div>
          </div>

        </div>
      </div>
      
    </div>
  );
}

export default HomeScreen;

```

`domains/games/components/InviteModal.tsx`:

```tsx
import React, { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { X, Copy, Share2, MessageCircle, Mail, Users, Check } from 'lucide-react';
import { toast } from 'sonner';

interface InviteModalProps {
  isOpen: boolean;
  onClose: () => void;
  gameTitle: string;
  gameId: string;
  gameDate: string;
  gameTime: string;
  gameLocation: string;
  sport: string;
}

export function InviteModal({ 
  isOpen, 
  onClose, 
  gameTitle, 
  gameId, 
  gameDate, 
  gameTime, 
  gameLocation, 
  sport 
}: InviteModalProps) {
  const [copied, setCopied] = useState(false);
  const [selectedContacts, setSelectedContacts] = useState<string[]>([]);

  if (!isOpen) return null;

  const gameUrl = `${window.location.origin}/public/game/${gameId}`;
  const shareText = `üèÉ‚Äç‚ôÇÔ∏è Join me for ${sport}!\n\n"${gameTitle}"\nüìÖ ${gameDate} at ${gameTime}\nüìç ${gameLocation}\n\nTap to RSVP: ${gameUrl}`;

  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(gameUrl);
      setCopied(true);
      toast.success('Link copied to clipboard!');
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      toast.error('Failed to copy link');
    }
  };

  const handleNativeShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: `Join me for ${sport}!`,
          text: shareText,
          url: gameUrl,
        });
        toast.success('Shared successfully!');
      } catch (error) {
        // User cancelled or error occurred
        handleCopyLink(); // Fallback to copy
      }
    } else {
      handleCopyLink(); // Fallback for browsers without native share
    }
  };

  const handleSMS = () => {
    const smsUrl = `sms:?body=${encodeURIComponent(shareText)}`;
    window.open(smsUrl, '_blank');
    toast.success('SMS app opened!');
  };

  const handleEmail = () => {
    const subject = encodeURIComponent(`Join me for ${sport} - ${gameTitle}`);
    const body = encodeURIComponent(`Hi!\n\nI'm organizing a ${sport} game and would love for you to join!\n\n${gameTitle}\nüìÖ ${gameDate} at ${gameTime}\nüìç ${gameLocation}\n\nClick here to RSVP: ${gameUrl}\n\nSee you there!\n`);
    const emailUrl = `mailto:?subject=${subject}&body=${body}`;
    window.open(emailUrl, '_blank');
    toast.success('Email app opened!');
  };

  const handleWhatsApp = () => {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
    window.open(whatsappUrl, '_blank');
    toast.success('WhatsApp opened!');
  };

  const quickInviteOptions = [
    {
      name: 'Copy Link',
      icon: copied ? Check : Copy,
      action: handleCopyLink,
      description: 'Copy shareable link',
      color: copied ? 'text-green-600' : 'text-blue-600'
    },
    {
      name: 'Share',
      icon: Share2,
      action: handleNativeShare,
      description: 'Use device share menu',
      color: 'text-purple-600'
    },
    {
      name: 'Text Message',
      icon: MessageCircle,
      action: handleSMS,
      description: 'Send via SMS',
      color: 'text-green-600'
    },
    {
      name: 'Email',
      icon: Mail,
      action: handleEmail,
      description: 'Send via email',
      color: 'text-red-600'
    },
    {
      name: 'WhatsApp',
      icon: Users,
      action: handleWhatsApp,
      description: 'Share on WhatsApp',
      color: 'text-green-500'
    }
  ];

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <Card className="w-full max-w-md">
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle className="text-lg">Invite Friends</CardTitle>
          <Button variant="ghost" size="icon" onClick={onClose}>
            <X className="w-4 h-4" />
          </Button>
        </CardHeader>
        
        <CardContent className="space-y-6">
          {/* Game Preview */}
          <div className="bg-muted/50 rounded-lg p-4 space-y-2">
            <div className="flex items-center gap-2">
              <Badge variant="secondary">{sport}</Badge>
              <h3 className="font-semibold text-sm">{gameTitle}</h3>
            </div>
            <div className="text-xs text-muted-foreground space-y-1">
              <div>üìÖ {gameDate} at {gameTime}</div>
              <div>üìç {gameLocation}</div>
            </div>
          </div>

          {/* Share Link */}
          <div className="space-y-2">
            <label className="text-sm font-medium">Game Link</label>
            <div className="flex gap-2">
              <Input 
                value={gameUrl} 
                readOnly 
                className="text-xs"
              />
              <Button 
                variant="outline" 
                size="icon" 
                onClick={handleCopyLink}
                className={copied ? 'text-green-600' : ''}
              >
                {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
              </Button>
            </div>
          </div>

          {/* Quick Share Options */}
          <div className="space-y-3">
            <label className="text-sm font-medium">Quick Invite</label>
            <div className="grid grid-cols-2 gap-2">
              {quickInviteOptions.map((option) => (
                <Button
                  key={option.name}
                  variant="outline"
                  className="h-auto p-3 flex flex-col items-center gap-2"
                  onClick={option.action}
                >
                  <option.icon className={`w-5 h-5 ${option.color}`} />
                  <div className="text-center">
                    <div className="text-xs font-medium">{option.name}</div>
                    <div className="text-xs text-muted-foreground">{option.description}</div>
                  </div>
                </Button>
              ))}
            </div>
          </div>

          {/* Share Message Preview */}
          <div className="space-y-2">
            <label className="text-sm font-medium">Message Preview</label>
            <div className="bg-muted/30 rounded-lg p-3 text-xs text-muted-foreground border-l-2 border-primary/20">
              {shareText}
            </div>
          </div>

          <div className="text-xs text-muted-foreground text-center">
            Anyone with the link can view and join this game
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/games/components/NoGamesFound.tsx`:

```tsx
import React from 'react';
import { NoGamesFound as NoGamesFoundEnhanced } from '@/shared/components/ui/empty-state-enhanced';
import { Calendar, MapPin } from 'lucide-react';

interface NoGamesFoundProps {
  onCreateGame: () => void;
  onExplore?: () => void;
}

export function NoGamesFound({ onCreateGame, onExplore }: NoGamesFoundProps) {
  return (
    <NoGamesFoundEnhanced
      onCreateGame={onCreateGame}
      onExplore={onExplore}
    />
  );
}


```

`domains/games/components/PostGameRatingModal.tsx`:

```tsx
import React, { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Badge } from '@/shared/components/ui/badge';
import { Textarea } from '@/shared/components/ui/textarea';
import { Separator } from '@/shared/components/ui/separator';
import { 
  Dialog, 
  DialogContent, 
  DialogDescription, 
  DialogHeader, 
  DialogTitle 
} from '@/shared/components/ui/dialog';
import { Star, Users, Trophy, MessageCircle, CheckCircle } from 'lucide-react';
import { SupabaseService } from '@/core/database/supabaseService';
import { useAchievements } from '@/domains/users/hooks/useAchievements';
import { toast } from 'sonner';

interface Player {
  id: string;
  name: string;
  avatar?: string;
  isHost: boolean;
}

interface PostGameRatingModalProps {
  isOpen: boolean;
  onClose: () => void;
  gameId: string;
  gameTitle: string;
  players: Player[];
}

interface GameRating {
  overall: number;
  organization: number;
  skillLevel: number;
  fun: number;
  reviewText: string;
  wouldPlayAgain: boolean;
  recommendToOthers: boolean;
}

interface PlayerRating {
  playerId: string;
  skill: number;
  sportsmanship: number;
  communication: number;
  feedback: string;
}

export function PostGameRatingModal({ 
  isOpen, 
  onClose, 
  gameId, 
  gameTitle, 
  players 
}: PostGameRatingModalProps) {
  const { checkForNewAchievements } = useAchievements();
  const [step, setStep] = useState<'game' | 'players' | 'complete'>('game');
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const [gameRating, setGameRating] = useState<GameRating>({
    overall: 0,
    organization: 0,
    skillLevel: 0,
    fun: 0,
    reviewText: '',
    wouldPlayAgain: true,
    recommendToOthers: true
  });

  const [playerRatings, setPlayerRatings] = useState<PlayerRating[]>(
    players.map(player => ({
      playerId: player.id,
      skill: 0,
      sportsmanship: 0,
      communication: 0,
      feedback: ''
    }))
  );

  const StarRating = ({ 
    rating, 
    onRatingChange, 
    label 
  }: { 
    rating: number; 
    onRatingChange: (rating: number) => void; 
    label: string;
  }) => (
    <div className="space-y-2">
      <label className="text-sm font-medium">{label}</label>
      <div className="flex gap-1">
        {[1, 2, 3, 4, 5].map((star) => (
          <button
            key={star}
            type="button"
            onClick={() => onRatingChange(star)}
            className="p-1 hover:scale-110 transition-transform"
          >
            <Star
              className={`w-6 h-6 ${
                star <= rating
                  ? 'fill-yellow-400 text-yellow-400'
                  : 'text-gray-300 hover:text-yellow-400'
              }`}
            />
          </button>
        ))}
      </div>
    </div>
  );

  const handleGameRatingSubmit = async () => {
    if (gameRating.overall === 0) {
      toast.error('Please provide an overall rating');
      return;
    }

    try {
      setIsSubmitting(true);
      await SupabaseService.submitGameReview({
        gameId,
        overallRating: gameRating.overall,
        organizationRating: gameRating.organization || undefined,
        skillLevelRating: gameRating.skillLevel || undefined,
        funRating: gameRating.fun || undefined,
        reviewText: gameRating.reviewText || undefined,
        wouldPlayAgain: gameRating.wouldPlayAgain,
        recommendToOthers: gameRating.recommendToOthers
      });

      setStep('players');
    } catch (error) {
      console.error('Failed to submit game rating:', error);
      toast.error('Failed to submit rating. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handlePlayerRatingsSubmit = async () => {
    const validRatings = playerRatings.filter(rating => 
      rating.skill > 0 && rating.sportsmanship > 0 && rating.communication > 0
    );

    if (validRatings.length === 0) {
      setStep('complete');
      return;
    }

    try {
      setIsSubmitting(true);
      
      await Promise.all(
        validRatings.map(rating =>
          SupabaseService.submitPlayerRating({
            gameId,
            ratedPlayerId: rating.playerId,
            skillRating: rating.skill,
            sportsmanshipRating: rating.sportsmanship,
            communicationRating: rating.communication,
            feedbackText: rating.feedback || undefined
          })
        )
      );

      setStep('complete');
    } catch (error) {
      console.error('Failed to submit player ratings:', error);
      toast.error('Failed to submit player ratings. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleComplete = async () => {
    // Check for new achievements after rating
    await checkForNewAchievements();
    onClose();
  };

  const updatePlayerRating = (playerId: string, field: keyof PlayerRating, value: any) => {
    setPlayerRatings(prev =>
      prev.map(rating =>
        rating.playerId === playerId
          ? { ...rating, [field]: value }
          : rating
      )
    );
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Trophy className="w-5 h-5 text-primary" />
            Rate Your Experience
          </DialogTitle>
          <DialogDescription>
            Help improve the community by rating {gameTitle}
          </DialogDescription>
        </DialogHeader>

        {step === 'game' && (
          <div className="space-y-6">
            <div className="text-center">
              <h3 className="text-lg font-semibold mb-2">How was the game?</h3>
              <p className="text-sm text-muted-foreground">Your feedback helps other players</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <StarRating
                rating={gameRating.overall}
                onRatingChange={(rating) => setGameRating(prev => ({ ...prev, overall: rating }))}
                label="Overall Rating *"
              />
              
              <StarRating
                rating={gameRating.organization}
                onRatingChange={(rating) => setGameRating(prev => ({ ...prev, organization: rating }))}
                label="Organization"
              />
              
              <StarRating
                rating={gameRating.skillLevel}
                onRatingChange={(rating) => setGameRating(prev => ({ ...prev, skillLevel: rating }))}
                label="Skill Level Match"
              />
              
              <StarRating
                rating={gameRating.fun}
                onRatingChange={(rating) => setGameRating(prev => ({ ...prev, fun: rating }))}
                label="Fun Factor"
              />
            </div>

            <div className="space-y-3">
              <label className="text-sm font-medium">Additional Comments</label>
              <Textarea
                placeholder="Share your experience with other players..."
                value={gameRating.reviewText}
                onChange={(e) => setGameRating(prev => ({ ...prev, reviewText: e.target.value }))}
                className="min-h-[80px]"
              />
            </div>

            <div className="flex gap-4">
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={gameRating.wouldPlayAgain}
                  onChange={(e) => setGameRating(prev => ({ ...prev, wouldPlayAgain: e.target.checked }))}
                  className="rounded"
                />
                <span className="text-sm">I'd play again</span>
              </label>
              
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={gameRating.recommendToOthers}
                  onChange={(e) => setGameRating(prev => ({ ...prev, recommendToOthers: e.target.checked }))}
                  className="rounded"
                />
                <span className="text-sm">Recommend to others</span>
              </label>
            </div>

            <div className="flex gap-3">
              <Button variant="outline" onClick={onClose} className="flex-1">
                Skip
              </Button>
              <Button 
                onClick={handleGameRatingSubmit} 
                disabled={isSubmitting || gameRating.overall === 0}
                className="flex-1"
              >
                {isSubmitting ? 'Submitting...' : 'Next: Rate Players'}
              </Button>
            </div>
          </div>
        )}

        {step === 'players' && (
          <div className="space-y-6">
            <div className="text-center">
              <h3 className="text-lg font-semibold mb-2">Rate Your Fellow Players</h3>
              <p className="text-sm text-muted-foreground">Optional but helps build a better community</p>
            </div>

            <div className="space-y-6">
              {players.map((player) => {
                const rating = playerRatings.find(r => r.playerId === player.id);
                if (!rating) return null;

                return (
                  <Card key={player.id}>
                    <CardHeader className="pb-3">
                      <div className="flex items-center gap-3">
                        <Avatar>
                          {player.avatar && <AvatarImage src={player.avatar} alt={player.name} />}
                          <AvatarFallback>{player.name.charAt(0)}</AvatarFallback>
                        </Avatar>
                        <div className="flex-1">
                          <div className="font-medium">{player.name}</div>
                          {player.isHost && (
                            <Badge variant="secondary" className="text-xs">Host</Badge>
                          )}
                        </div>
                      </div>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <StarRating
                          rating={rating.skill}
                          onRatingChange={(r) => updatePlayerRating(player.id, 'skill', r)}
                          label="Skill Level"
                        />
                        <StarRating
                          rating={rating.sportsmanship}
                          onRatingChange={(r) => updatePlayerRating(player.id, 'sportsmanship', r)}
                          label="Sportsmanship"
                        />
                        <StarRating
                          rating={rating.communication}
                          onRatingChange={(r) => updatePlayerRating(player.id, 'communication', r)}
                          label="Communication"
                        />
                      </div>
                      
                      <Textarea
                        placeholder="Optional feedback for this player..."
                        value={rating.feedback}
                        onChange={(e) => updatePlayerRating(player.id, 'feedback', e.target.value)}
                        className="min-h-[60px]"
                      />
                    </CardContent>
                  </Card>
                );
              })}
            </div>

            <div className="flex gap-3">
              <Button variant="outline" onClick={() => setStep('complete')} className="flex-1">
                Skip Player Ratings
              </Button>
              <Button 
                onClick={handlePlayerRatingsSubmit} 
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? 'Submitting...' : 'Submit Ratings'}
              </Button>
            </div>
          </div>
        )}

        {step === 'complete' && (
          <div className="text-center space-y-6 py-8">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto">
              <CheckCircle className="w-8 h-8 text-green-600" />
            </div>
            
            <div>
              <h3 className="text-lg font-semibold mb-2">Thanks for your feedback!</h3>
              <p className="text-muted-foreground">
                Your ratings help make TribeUp better for everyone
              </p>
            </div>

            <div className="bg-muted/50 rounded-lg p-4">
              <div className="flex items-center justify-center gap-2 text-sm text-muted-foreground">
                <Trophy className="w-4 h-4" />
                <span>Check your profile for any new achievements!</span>
              </div>
            </div>

            <Button onClick={handleComplete} className="w-full">
              Done
            </Button>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}

```

`domains/games/components/PublicGamePage.tsx`:

```tsx
import { useState, useEffect, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Separator } from '@/shared/components/ui/separator';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { 
  Calendar, 
  MapPin, 
  Users, 
  Share2,
  ExternalLink,
  CheckCircle,
  LogIn,
  Mail,
  Chrome,
  Navigation,
  DollarSign
} from 'lucide-react';
import { toast } from 'sonner';
import { usePublicGame } from '@/domains/games/hooks/usePublicGame';
import { supabase } from '@/core/database/supabase';
import { SupabaseService } from '@/core/database/supabaseService';
import { GameCapacityLine } from '@/shared/components/ui/GameCapacity';
import { env } from '@/core/config/envUtils';
import { brandColors } from '@/shared/config/theme';
import { SimpleCalendarButton } from '@/shared/components/common/SimpleCalendarButton';
import { formatCalendarInfo, formatTimeString, formatCost } from '@/shared/utils/dateUtils';
import { ImageWithFallback } from '@/shared/components/figma/ImageWithFallback';

export default function PublicGamePage() {
  const { gameId } = useParams();
  const navigate = useNavigate();
  const { data: game, isLoading: gameLoading } = usePublicGame(gameId || '');
  const loading = gameLoading;
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isJoining, setIsJoining] = useState(false);
  const [hasJoined, setHasJoined] = useState(false);
  const [joiningError, setJoiningError] = useState<string | null>(null);
  const [capacity, setCapacity] = useState<any | null>(null);

  // Check authentication status and redirect authenticated users to app
  useEffect(() => {
    const checkAuth = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      const authenticated = !!session;
      setIsAuthenticated(authenticated);
      
      // Redirect authenticated users to the full app game page
      if (authenticated && gameId) {
        console.log('Authenticated user detected, redirecting to app game page');
        navigate(`/app/game/${gameId}`);
      }
    };
    checkAuth();

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event: any, session: any) => {
      const authenticated = !!session;
      setIsAuthenticated(authenticated);
      
      // Redirect authenticated users to the full app game page
      if (authenticated && gameId) {
        console.log('User authenticated, redirecting to app game page');
        navigate(`/app/game/${gameId}`);
      }
    });

    return () => subscription.unsubscribe();
  }, [gameId, navigate]);

  // Check if user has already joined
  useEffect(() => {
    const checkJoined = async () => {
      if (!isAuthenticated || !gameId) return;
      
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from('game_participants')
          .select('*')
          .eq('game_id', gameId)
          .eq('user_id', user.id)
          .single();

        if (data && !error) {
          setHasJoined(true);
        }
      } catch (err) {
        // User not joined yet
      }
    };

    if (isAuthenticated) {
      checkJoined();
    }
  }, [isAuthenticated, gameId]);

  // Initial stats load
  useEffect(() => {
    let cancelled = false;
    (async () => {
      if (!gameId) return;
      try {
        const { data, error } = await supabase
          .from('game_rsvp_stats')
          .select('*')
          .eq('game_id', gameId)
          .single();
        if (!cancelled && !error && data) {
          setCapacity(data);
        }
      } catch {}
    })();
    return () => { cancelled = true; };
  }, [gameId]);

  const handleJoinGame = async () => {
    // This function should never be called since authenticated users are auto-redirected
    // But just in case, handle it gracefully
    if (!gameId) return;
    toast.info('Please sign in to join this game');
  };

  const handleSignInWithGoogle = async () => {
    if (!gameId) return;

    try {
      // Store the intended destination for post-auth redirect and auto-join intent
      localStorage.setItem('authRedirect', `/app/game/${gameId}`);
      localStorage.setItem('autoJoinGame', gameId);

      const redirectUrl = `${env.APP_URL}/auth/callback`;
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: redirectUrl,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          }
        }
      });

      if (error) throw error;
      // OAuth will redirect automatically
    } catch (error: any) {
      console.error('OAuth error:', error);
      localStorage.removeItem('authRedirect');
      localStorage.removeItem('autoJoinGame');
      toast.error('Failed to initiate sign in. Please try again.');
    }
  };

  const handleSignInWithEmail = () => {
    if (!gameId) return;
    // Store the intended destination and auto-join intent
    localStorage.setItem('authRedirect', `/app/game/${gameId}`);
    localStorage.setItem('autoJoinGame', gameId);
    // Add method=email to auto-show email form on auth page
    navigate('/auth?redirect=' + encodeURIComponent(`/app/game/${gameId}`) + '&method=email');
  };

  const handleShare = async () => {
    const shareUrl = window.location.href;
    
    if (navigator.share) {
      try {
        await navigator.share({
          title: `Join ${game?.title}`,
          text: `${game?.sport} game at ${game?.location}`,
          url: shareUrl
        });
      } catch (error) {
        // User cancelled share
      }
    } else {
      // Fallback to clipboard
      try {
        await navigator.clipboard.writeText(shareUrl);
        toast.success('Game link copied to clipboard!');
      } catch (error) {
        toast.error('Failed to copy link');
      }
    }
  };

  const handleJoinApp = () => {
    navigate('/auth?redirect=' + encodeURIComponent(window.location.pathname));
  };

  const handleAddToCalendar = () => {
    if (!game) return;
    
    // Create event details
    const gameDateTime = new Date(`${game.date}T${game.time}`);
    const endDateTime = new Date(gameDateTime);
    endDateTime.setHours(endDateTime.getHours() + 2); // Default 2 hours
    
    const title = `${game.sport}: ${game.title}`;
    const description = `Join us for ${game.sport}!\n\n${game.description || ''}\n\nMax Players: ${game.maxPlayers || (game as any).max_players}\nCost: ${game.cost || 'Free'}`;
    const location = game.location;
    
    // Format dates (YYYYMMDDTHHMMSSZ)
    const formatDate = (date: Date) => date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    
    // Detect device and use appropriate calendar
    const userAgent = navigator.userAgent;
    
    if (/iPhone|iPad|iPod/.test(userAgent)) {
      // iOS - Create .ics file and try to open with Calendar app
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//TribeUp//TribeUp Social Sports//EN',
        'BEGIN:VEVENT',
        `UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@tribeup.app`,
        `DTSTART:${formatDate(gameDateTime)}`,
        `DTEND:${formatDate(endDateTime)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        `DTSTAMP:${formatDate(new Date())}`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      const blob = new Blob([icsContent], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      
      // Try to open with Calendar app
      window.location.href = url;
      
      // Cleanup after a delay
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      
    } else if (/Android/.test(userAgent)) {
      // Android - Use Google Calendar
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(gameDateTime)}/${formatDate(endDateTime)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
      window.open(googleUrl, '_blank');
      
    } else if (/Mac/.test(userAgent)) {
      // macOS - Create .ics file for Calendar app
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//TribeUp//TribeUp Social Sports//EN',
        'BEGIN:VEVENT',
        `UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@tribeup.app`,
        `DTSTART:${formatDate(gameDateTime)}`,
        `DTEND:${formatDate(endDateTime)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        `DTSTAMP:${formatDate(new Date())}`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
    } else {
      // Default - Google Calendar for all other devices
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(gameDateTime)}/${formatDate(endDateTime)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
      window.open(googleUrl, '_blank');
    }
  };

  const handleDirections = () => {
    const address = game.location || "Location not specified";
    const encodedAddress = encodeURIComponent(address);
    
    // Try to open in native maps app first, fallback to Google Maps
    const mapsUrl = `https://maps.google.com/maps?q=${encodedAddress}&t=m&z=16`;
    
    try {
      // For mobile devices, try to open native maps
      if (navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)) {
        const nativeUrl = `maps://maps.google.com/maps?q=${encodedAddress}`;
        window.location.href = nativeUrl;
        
        // Fallback after a delay if native app doesn't open
        setTimeout(() => {
          window.open(mapsUrl, '_blank');
        }, 500);
      } else {
        // Desktop - open in new tab
        window.open(mapsUrl, '_blank');
      }
    } catch (error) {
      // Final fallback
      window.open(mapsUrl, '_blank');
    }
  };

  // Capacity data - prioritize game data from games_with_counts view
  // This ensures we use the correct total_players from the view
  const capacityData = useMemo(() => {
    // Primary: Use game data from games_with_counts view (most accurate)
    if (game?.totalPlayers !== undefined && game?.totalPlayers !== null) {
      return {
        totalPlayers: game.totalPlayers,
        maxPlayers: game.maxPlayers ?? 0,
        availableSpots: game.availableSpots ?? Math.max(0, (game.maxPlayers ?? 0) - (game.totalPlayers ?? 0))
      };
    }
    // Fallback: Use capacity stats if game data not available
    if (capacity) {
      return {
        totalPlayers: capacity.total_rsvps ?? 0,
        maxPlayers: capacity.capacity ?? game?.maxPlayers ?? 0,
        availableSpots: capacity.capacity_remaining ?? 0
      };
    }
    // Final fallback
    return {
      totalPlayers: 0,
      maxPlayers: game?.maxPlayers ?? 0,
      availableSpots: game?.maxPlayers ?? 0
    };
  }, [game?.totalPlayers, game?.maxPlayers, game?.availableSpots, capacity]);

  if (loading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Loading game details...</p>
        </div>
      </div>
    );
  }

  if (!game) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6 text-center">
            <h2 className="text-xl font-semibold mb-2">Game Not Found</h2>
            <p className="text-muted-foreground mb-4">
              This game may have been cancelled or the link is invalid.
            </p>
            <Button onClick={() => navigate('/')}>
              Browse Other Games
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="bg-card border-b">
        <div className="max-w-2xl mx-auto px-4 py-6">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                <span className="text-primary-foreground font-bold">T</span>
              </div>
              <div>
                <h1 className="font-bold text-lg">TribeUp</h1>
                <p className="text-sm text-muted-foreground">Social Sports</p>
              </div>
            </div>
            <Button variant="outline" size="sm" onClick={handleJoinApp}>
              <ExternalLink className="w-4 h-4 mr-2" />
              Join App
            </Button>
          </div>
        </div>
      </div>

      <div className="max-w-2xl mx-auto px-4 py-8">
        {/* Game Details */}
        <Card className="mb-8">
          {game.imageUrl && (
            <div className="aspect-video overflow-hidden">
              <ImageWithFallback
                src={game.imageUrl}
                alt={game.title}
                className="w-full h-full object-cover"
              />
            </div>
          )}
          {!game.imageUrl && (
            <div className="p-4 border-b flex items-center gap-2 flex-wrap">
              <Badge className={`${(game as any).sportColor || 'bg-primary'} text-white border-none`}>
                {game.sport}
              </Badge>
              {(game as any).skillLevel && (
                <Badge variant="outline" className="capitalize">
                  {(game as any).skillLevel}
                </Badge>
              )}
            </div>
          )}
          
          <CardHeader>
            <div className="flex items-start justify-between gap-4">
              <div className="flex-1">
                <CardTitle className="text-2xl mb-2">{game.title}</CardTitle>
                {game.imageUrl && (
                  <div className="flex items-center gap-2 flex-wrap">
                    <Badge className={`${(game as any).sportColor || 'bg-primary'} text-white border-none`}>
                      {game.sport}
                    </Badge>
                    {(game as any).skillLevel && (
                      <Badge variant="outline" className="capitalize">
                        {(game as any).skillLevel}
                      </Badge>
                    )}
                  </div>
                )}
              </div>
              <Button variant="outline" size="sm" onClick={handleShare}>
                <Share2 className="w-4 h-4 mr-2" />
                Share
              </Button>
            </div>
          </CardHeader>
          
          <CardContent className="p-6">
            {/* Game Info Grid - even grid layout */}
            <div className="grid grid-cols-2 gap-6 mb-6">
              {/* Players */}
              <div className="flex items-start gap-3">
                <Users className="w-5 h-5 text-muted-foreground mt-0.5" />
                <div className="flex-1">
                  <div className="font-medium mb-1">
                    {capacityData ? (
                      <>
                        {capacityData.totalPlayers}/{capacityData.maxPlayers} players
                      </>
                    ) : (
                      <>
                        {game?.totalPlayers ?? 0}/{game?.maxPlayers ?? 0} players
                      </>
                    )}
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {capacityData && capacityData.availableSpots > 0 ? (
                      <span className="text-green-600 dark:text-green-400">
                        {capacityData.availableSpots} spot{capacityData.availableSpots !== 1 ? 's' : ''} available
                      </span>
                    ) : (
                      'Capacity'
                    )}
                  </div>
                </div>
              </div>
              
              {/* Cost */}
              <div className="flex items-start gap-3">
                <DollarSign className="w-5 h-5 text-muted-foreground mt-0.5" />
                <div className="flex-1">
                  <div className="font-medium mb-1">{formatCost(game.cost)}</div>
                  <div className="text-sm text-muted-foreground">Cost</div>
                </div>
              </div>
              
              {/* Location */}
              <div className="flex items-start gap-3">
                <MapPin className="w-5 h-5 text-muted-foreground mt-0.5" />
                <div className="flex-1 min-w-0">
                  <button
                    onClick={handleDirections}
                    className="text-left hover:opacity-80 transition-opacity cursor-pointer group w-full"
                  >
                    <div className="font-medium mb-1 group-hover:text-primary">
                      {(() => {
                        if (!game.location) return 'Location TBD';
                        // Parse address and show only street address + neighborhood
                        const parts = game.location.split(',').map((s: string) => s.trim());
                        // Skip first part if it's a single word/sport name (like "NBA")
                        // Show street number + street name (usually parts 1-2 or 2-3)
                        const startIdx = parts[0] && parts[0].length < 5 && !parts[0].match(/\d/) ? 1 : 0;
                        // Take street address (usually 2 parts: number + street name)
                        // Plus one more part for neighborhood if available
                        return parts.slice(startIdx, startIdx + 3).join(', ');
                      })()}
                    </div>
                    <div className="text-sm text-muted-foreground">Location</div>
                  </button>
                </div>
              </div>
              
              {/* Date and Time */}
              <button
                onClick={handleAddToCalendar}
                className="flex items-start gap-3 text-left hover:opacity-80 transition-opacity cursor-pointer group w-full"
              >
                <Calendar className="w-5 h-5 text-muted-foreground mt-0.5 group-hover:text-primary" />
                <div className="flex-1">
                  <div className="font-medium mb-1 group-hover:text-primary">{formatCalendarInfo(game.date, game.time)?.date || game.date}</div>
                  <div className="text-sm text-muted-foreground">{formatTimeString(game.time)}</div>
                </div>
              </button>
            </div>

            {/* Buttons */}
            <div className="flex gap-2 pt-4 border-t">
              <Button 
                variant="outline" 
                size="sm"
                className="flex-1"
                onClick={handleDirections}
              >
                <Navigation className="w-4 h-4 mr-2" />
                Get Directions
              </Button>
              <SimpleCalendarButton 
                game={game} 
                variant="outline" 
                size="sm"
                className="flex-1"
              />
            </div>
            
            {game.description && (
              <>
                <Separator className="my-6" />
                <div>
                  <h3 className="font-medium mb-2">About this activity</h3>
                  <p className="text-muted-foreground">{game.description}</p>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Join Section */}
        {hasJoined ? (
          <Alert className="mb-8">
            <CheckCircle className="h-4 w-4" />
            <AlertDescription>
              <strong>You're all set!</strong> You've successfully joined this activity. 
              You'll receive updates about this game.
              {capacityData && (
                <div className="mt-1 text-sm text-muted-foreground">
                  {capacityData.totalPlayers}/{capacityData.maxPlayers} players, {capacityData.availableSpots} spots available
                </div>
              )}
            </AlertDescription>
          </Alert>
        ) : (
          <Card 
            className="mb-8 border"
            style={{
              background: `linear-gradient(to bottom, rgba(232, 90, 43, 0.03), rgba(232, 90, 43, 0.01))`,
              borderColor: `${brandColors.primary}30`
            }}>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <LogIn className="w-5 h-5" style={{ color: brandColors.primary }} />
                Join this Activity
              </CardTitle>
            </CardHeader>
            <CardContent>
              {capacityData && (
                <div className="mb-4">
                  <GameCapacityLine
                    totalPlayers={capacityData.totalPlayers}
                    maxPlayers={capacityData.maxPlayers}
                    availableSpots={capacityData.availableSpots}
                  />
                </div>
              )}
              
              {isAuthenticated ? (
                <div className="space-y-4">
                  <Button 
                    onClick={handleJoinGame}
                    disabled={isJoining}
                    className="w-full"
                    style={{
                      backgroundColor: brandColors.primary || '#FA4616',
                      borderColor: brandColors.primary || '#FA4616'
                    }}>
                    {isJoining ? 'Joining...' : 'Join Activity'}
                  </Button>
                  
                  <SimpleCalendarButton 
                    game={game} 
                    variant="outline" 
                    size="default"
                    className="w-full"
                  />
                  
                  {joiningError && (
                    <Alert variant="destructive">
                      <AlertDescription>{joiningError}</AlertDescription>
                    </Alert>
                  )}
                </div>
              ) : (
                <div className="space-y-4">
                  <p className="text-sm text-muted-foreground mb-4">
                    Sign in to join this activity and connect with other players.
                  </p>
                  
                  <Button
                    onClick={handleSignInWithGoogle}
                    variant="outline"
                    className="w-full"
                  >
                    <Chrome className="w-4 h-4 mr-2" />
                    Continue with Google
                  </Button>
                  
                  <Button
                    onClick={handleSignInWithEmail}
                    variant="outline"
                    className="w-full"
                  >
                    <Mail className="w-4 h-4 mr-2" />
                    Continue with Email
                  </Button>
                  
                  <p className="text-xs text-muted-foreground text-center">
                    By joining, you'll receive updates about this activity.
                  </p>
                </div>
              )}
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}

```

`domains/games/components/QuickJoinModal.tsx`:

```tsx
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { X, Mail, User, Phone, Lock } from 'lucide-react';
import { toast } from 'sonner';
import { useSimpleAuth } from '@/core/auth/SimpleAuthProvider';

interface QuickJoinModalProps {
  isOpen: boolean;
  onClose: () => void;
  gameTitle: string;
  gameId: string;
  onJoinSuccess: () => void;
}

export function QuickJoinModal({ isOpen, onClose, gameTitle, gameId, onJoinSuccess }: QuickJoinModalProps) {
  const { signUp, signIn, signInWithOAuth } = useSimpleAuth();
  const [mode, setMode] = useState<'signup' | 'login'>('signup');
  const [step, setStep] = useState<'form' | 'verify'>('form');
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    password: ''
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  if (!isOpen) return null;

  const handleQuickSignup = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      // Create account with minimal info
      const result = await signUp(formData.email, 'temp-password-' + Date.now(), {
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        pendingGameId: gameId // Store which game they want to join
      });
      
      // If signup was successful and user is immediately authenticated (some providers do this)
      if (result?.session) {
        console.log('‚úÖ User authenticated immediately after signup');
        toast.success('Account created! Joining game...');
        onJoinSuccess(); // Call success callback to join the game
      } else {
        // Email verification required
        setStep('verify');
        toast.success('Account created! Check your email to verify and join the game.');
      }
    } catch (error: any) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const result = await signIn(formData.email, formData.password);
      
      if (result?.session) {
        console.log('‚úÖ User logged in successfully');
        toast.success('Logged in! Joining game...');
        onJoinSuccess(); // Call success callback to join the game
      } else {
        setError('Login failed. Please check your credentials.');
      }
    } catch (error: any) {
      console.error('‚ùå Login failed:', error);
      setError(error.message || 'Login failed. Please check your credentials.');
    } finally {
      setLoading(false);
    }
  };

  const handleSocialLogin = async (provider: 'google') => {
    try {
      setLoading(true);
      const result = await signInWithOAuth(provider, { pendingGameId: gameId });
      
      // If OAuth was successful, call the success callback
      if (result) {
        console.log('‚úÖ OAuth login successful, joining game');
        toast.success(`Signed in with ${provider}! Joining game...`);
        onJoinSuccess(); // Call success callback to join the game
      } else {
        toast.info('Redirecting to login...');
        onClose();
      }
    } catch (error: any) {
      console.error('‚ùå Social login failed:', error);
      toast.error(error.message || 'Social login failed');
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <Card className="w-full max-w-md">
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle className="text-lg">
            {step === 'form' ? (mode === 'signup' ? `Join "${gameTitle}"` : 'Login to Join') : 'Check Your Email'}
          </CardTitle>
          <Button variant="ghost" size="icon" onClick={onClose}>
            <X className="w-4 h-4" />
          </Button>
        </CardHeader>
        
        <CardContent>
          {step === 'form' ? (
            <div className="space-y-4">
              {/* Social Login Options */}
              <div className="space-y-2">
                <Button 
                  variant="outline" 
                  className="w-full"
                  onClick={() => handleSocialLogin('google')}
                  disabled={loading}
                >
                  <svg className="w-4 h-4 mr-2" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Continue with Google
                </Button>
                
              </div>

              <div className="relative">
                <div className="absolute inset-0 flex items-center">
                  <span className="w-full border-t" />
                </div>
                <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-background px-2 text-muted-foreground">Or continue with email</span>
                </div>
              </div>

              {/* Signup/Login Form */}
              {mode === 'signup' ? (
                <form onSubmit={handleQuickSignup} className="space-y-3">
                  <div className="relative">
                    <Input
                      type="text"
                      placeholder="Your name"
                      value={formData.name}
                      onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                      required
                      className="pl-10"
                    />
                    <User className="w-4 h-4 absolute left-3 top-3 text-muted-foreground" />
                  </div>
                  
                  <div className="relative">
                    <Input
                      type="email"
                      placeholder="Email address"
                      value={formData.email}
                      onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                      required
                      className="pl-10"
                    />
                    <Mail className="w-4 h-4 absolute left-3 top-3 text-muted-foreground" />
                  </div>
                  
                  <div className="relative">
                    <Input
                      type="tel"
                      placeholder="Phone (optional)"
                      value={formData.phone}
                      onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}
                      className="pl-10"
                    />
                    <Phone className="w-4 h-4 absolute left-3 top-3 text-muted-foreground" />
                  </div>

                  {error && (
                    <Alert variant="destructive">
                      <AlertDescription>{error}</AlertDescription>
                    </Alert>
                  )}

                  <Button type="submit" className="w-full" disabled={loading}>
                    {loading ? 'Creating Account...' : 'Join Game'}
                  </Button>
                  
                  <p className="text-xs text-muted-foreground text-center">
                    By joining, you agree to our{' '}
                    <Link to="/legal/terms" className="text-primary hover:underline">
                      Terms of Service
                    </Link>
                    {' '}and{' '}
                    <Link to="/legal/privacy" className="text-primary hover:underline">
                      Privacy Policy
                    </Link>
                  </p>
                  
                  <Button 
                    type="button" 
                    variant="link" 
                    className="w-full"
                    onClick={() => {
                      setMode('login');
                      setError('');
                    }}
                  >
                    Already have an account? Log in
                  </Button>
                </form>
              ) : (
                <form onSubmit={handleLogin} className="space-y-3">
                  <div className="relative">
                    <Input
                      type="email"
                      placeholder="Email address"
                      value={formData.email}
                      onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                      required
                      className="pl-10"
                    />
                    <Mail className="w-4 h-4 absolute left-3 top-3 text-muted-foreground" />
                  </div>
                  
                  <div className="relative">
                    <Input
                      type="password"
                      placeholder="Password"
                      value={formData.password}
                      onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                      required
                      className="pl-10"
                    />
                    <Lock className="w-4 h-4 absolute left-3 top-3 text-muted-foreground" />
                  </div>

                  {error && (
                    <Alert variant="destructive">
                      <AlertDescription>{error}</AlertDescription>
                    </Alert>
                  )}

                  <Button type="submit" className="w-full" disabled={loading}>
                    {loading ? 'Logging in...' : 'Login & Join Game'}
                  </Button>
                  
                  <Button 
                    type="button" 
                    variant="link" 
                    className="w-full"
                    onClick={() => {
                      setMode('signup');
                      setError('');
                    }}
                  >
                    Don't have an account? Sign up
                  </Button>
                </form>
              )}
            </div>
          ) : (
            <div className="text-center space-y-4">
              <div className="w-16 h-16 mx-auto bg-primary/10 rounded-full flex items-center justify-center">
                <Mail className="w-8 h-8 text-primary" />
              </div>
              <div>
                <h3 className="font-semibold mb-2">Check your email</h3>
                <p className="text-sm text-muted-foreground">
                  We sent a verification link to <strong>{formData.email}</strong>
                </p>
                <p className="text-sm text-muted-foreground mt-2">
                  Click the link to verify your account and automatically join "{gameTitle}"
                </p>
              </div>
              <Button variant="outline" onClick={onClose} className="w-full">
                Got it
              </Button>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/games/components/RSVPSection.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Badge } from '@/shared/components/ui/badge';
import { Facepile } from '@/shared/components/ui/facepile';
import { AttendeeList, Attendee, RSVPStatus } from './AttendeeList';
import { UserPlus, CheckCircle } from 'lucide-react';

export interface RSVPSectionProps extends React.HTMLAttributes<HTMLDivElement> {
  attendees: Attendee[];
  currentUserId?: string;
  userRSVPStatus?: RSVPStatus;
  maxPlayers?: number;
  currentPlayers?: number;
  onRSVPChange?: (status: RSVPStatus) => void;
  onInvite?: () => void;
  onAttendeeClick?: (attendee: Attendee) => void;
  showFullList?: boolean;
  className?: string;
}

/**
 * RSVP Section Component
 * 
 * Displays RSVP options and attendee list with facepile integration.
 * Based on Strava's event RSVP patterns.
 * 
 * @example
 * ```tsx
 * <RSVPSection
 *   attendees={attendees}
 *   userRSVPStatus="going"
 *   onRSVPChange={(status) => updateRSVP(status)}
 *   onInvite={() => openInviteModal()}
 * />
 * ```
 */
export function RSVPSection({
  attendees,
  currentUserId,
  userRSVPStatus,
  maxPlayers,
  currentPlayers,
  onRSVPChange,
  onInvite,
  onAttendeeClick,
  showFullList = true,
  className,
  ...props
}: RSVPSectionProps) {
  const going = attendees.filter((a) => a.status === 'going');

  return (
    <Card className={cn(className)} {...props}>
      <CardContent className="p-4 space-y-4">
        {/* Facepile of Going Attendees */}
        {going.length > 0 && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <CheckCircle className="size-4 text-success" />
                <span className="text-sm font-medium">
                  {going.length} {going.length === 1 ? 'person' : 'people'} going
                </span>
                {maxPlayers && (
                  <Badge variant="secondary" className="text-xs">
                    {currentPlayers || going.length}/{maxPlayers}
                  </Badge>
                )}
              </div>
              {onInvite && (
                <Button
                  type="button"
                  variant="default"
                  size="sm"
                  onClick={onInvite}
                  className="bg-primary text-primary-foreground hover:bg-primary/90"
                >
                  <UserPlus className="size-3 mr-1" />
                  Invite
                </Button>
              )}
            </div>
            <Facepile
              users={going.map((a) => ({
                id: a.id,
                name: a.name,
                image: a.avatar || undefined,
                email: a.email,
              }))}
              maxVisible={5}
              size="md"
              onUserClick={(user) => {
                const attendee = going.find((a) => a.id === user.id);
                if (attendee && onAttendeeClick) {
                  onAttendeeClick(attendee);
                }
              }}
            />
          </div>
        )}

        {/* Full Attendee List */}
        {showFullList && (
          <AttendeeList
            attendees={attendees}
            maxPlayers={maxPlayers}
            currentPlayers={currentPlayers}
            showFacepile={false}
            onInvite={onInvite}
            onAttendeeClick={onAttendeeClick}
            currentUserId={currentUserId}
          />
        )}
      </CardContent>
    </Card>
  );
}


```

`domains/games/components/SearchDiscovery.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { SupabaseService } from '@/core/database/supabaseService';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Badge } from '@/shared/components/ui/badge';
import { ArrowLeft, Search, SlidersHorizontal, Plus } from 'lucide-react';
import { useAppStore } from '@/store/appStore';
import { useGames } from '@/domains/games/hooks/useGames';
import { UnifiedGameCard } from './UnifiedGameCard';
import { GameCardSkeleton } from './GameCardSkeleton';
import { formatTimeString } from '@/shared/utils/dateUtils';
import { EmptyStateEnhanced } from '@/shared/components/ui/empty-state-enhanced';



const sportFilters = [
  { name: 'All Sports', value: 'all' },
  { name: 'Basketball', value: 'basketball' },
  { name: 'Soccer', value: 'soccer' },
  { name: 'Tennis', value: 'tennis' },
  { name: 'Pickleball', value: 'pickleball' },
  { name: 'Volleyball', value: 'volleyball' },
  { name: 'Flag Football', value: 'flag football' },
  { name: 'Baseball', value: 'baseball' },
  { name: 'Golf', value: 'golf' },
  { name: 'Hockey', value: 'hockey' },
  { name: 'Rugby', value: 'rugby' },
  { name: 'Swimming', value: 'swimming' },
  { name: 'Rock Climbing', value: 'rock_climbing' },
  { name: 'Hiking', value: 'hiking' },
];

const skillLevelFilters = [
  { name: 'All Levels', value: 'all' },
  { name: 'Beginner', value: 'beginner' },
  { name: 'Intermediate', value: 'intermediate' },
  { name: 'Advanced', value: 'advanced' },
];

// Using UnifiedGameCard component for consistency

function SearchDiscovery() {
  const navigate = useNavigate();
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedSport, setSelectedSport] = useState('all');
  const [selectedSkillLevel, setSelectedSkillLevel] = useState('all');
  const [showFilters, setShowFilters] = useState(false);
  // Use React Query for consistent data loading
  const { data: games = [], isLoading: loading, error } = useGames();

  // Debug: Log games with skill levels
  useEffect(() => {
    if (games.length > 0 && import.meta.env.DEV) {
      const gamesWithSkillLevel = games.filter(g => g.skillLevel);
      console.log('üîç [SearchDiscovery] Games with skill level:', {
        total: games.length,
        withSkillLevel: gamesWithSkillLevel.length,
        skillLevels: gamesWithSkillLevel.map(g => ({ id: g.id, title: g.title, skillLevel: g.skillLevel }))
      });
    }
  }, [games]);

  const handleGameSelect = (gameId: string) => {
    navigate(`/game/${gameId}`);
  };

  const handleBack = () => {
    navigate(-1);
  };

  // Get sport color helper
  const getSportColor = (sport: string) => {
    const colors = {
      'Basketball': 'bg-orange-500',
      'Soccer': 'bg-green-500',
      'Tennis': 'bg-yellow-500',
      'Pickleball': 'bg-purple-500',
      'Volleyball': 'bg-blue-500',
      'Flag Football': 'bg-red-500',
      'Baseball': 'bg-amber-600',
      'Golf': 'bg-emerald-600',
      'Hockey': 'bg-slate-600',
      'Rugby': 'bg-indigo-600'
    };
    return colors[sport as keyof typeof colors] || 'bg-gray-500';
  };

  // Filter games
  const filteredResults = games
    .map(game => ({
      ...game,
      sportColor: getSportColor(game.sport),
      imageUrl: game.imageUrl || ''
      // DON'T overwrite totalPlayers/maxPlayers - they're already correct from the query
    }))
    .filter(game => {
      // Robust search that includes description and handles null values
      const q = searchQuery.toLowerCase().trim();
      const fields = [game.title, game.sport, game.location, game.description];
      const matchesSearch = !q || fields.some(f => f?.toLowerCase().trim().includes(q));
      
      // Robust sport filter with case-insensitive comparison
      const matchesSport = selectedSport === 'all' || 
                          game.sport?.toLowerCase().trim() === selectedSport.toLowerCase().trim();
      
      // Skill level filter - show games that match the selected level
      // When "All Levels" is selected, show all games (including those without skill level)
      // When a specific level is selected, only show games with that exact skill level
      const gameSkillLevel = game.skillLevel?.toLowerCase().trim();
      const selectedLevel = selectedSkillLevel.toLowerCase().trim();
      const matchesSkillLevel = selectedLevel === 'all' || 
                               (gameSkillLevel && gameSkillLevel === selectedLevel);
      
      return matchesSearch && matchesSport && matchesSkillLevel;
    });

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="flex items-center gap-4 px-4 py-4">
          <Button variant="ghost" size="icon" onClick={handleBack}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input
              id="search-games"
              name="search-games"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search activities, sports, locations..."
              className="pl-10"
            />
          </div>
          <Button 
            variant="outline" 
            size="icon"
            onClick={() => setShowFilters(!showFilters)}
          >
            <SlidersHorizontal className="w-4 h-4" />
          </Button>
        </div>

        {/* Filter Bar */}
        {showFilters && (
          <div className="px-4 pb-4 space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-sm font-medium mb-2 block">Sort by</label>
                <select className="w-full p-2 border rounded-md">
                  <option value="distance">Distance</option>
                  <option value="time">Time</option>
                  <option value="players">Players Needed</option>
                  <option value="cost">Cost</option>
                </select>
              </div>
              <div>
                <label className="text-sm font-medium mb-2 block">Date</label>
                <select className="w-full p-2 border rounded-md">
                  <option value="">Any time</option>
                  <option value="today">Today</option>
                  <option value="tomorrow">Tomorrow</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                </select>
              </div>
            </div>
          </div>
        )}

        {/* Sport Filter Chips */}
        <div className="px-4 pb-4">
          <div className="flex gap-2 overflow-x-auto pb-2">
            {sportFilters.map((sport) => (
              <Badge
                key={sport.value}
                variant={selectedSport === sport.value ? "default" : "outline"}
                className="cursor-pointer whitespace-nowrap"
                onClick={() => setSelectedSport(sport.value)}
              >
                {sport.name}
              </Badge>
            ))}
          </div>
        </div>

        {/* Skill Level Filter Chips */}
        <div className="px-4 pb-3 border-b border-border">
          <div className="flex items-center gap-2 mb-2">
            <span className="text-xs font-medium text-muted-foreground">Skill Level:</span>
          </div>
          <div className="flex gap-2 overflow-x-auto pb-2">
            {skillLevelFilters.map((level) => (
              <Badge
                key={level.value}
                variant={selectedSkillLevel === level.value ? "default" : "outline"}
                className="cursor-pointer whitespace-nowrap"
                onClick={() => setSelectedSkillLevel(level.value)}
              >
                {level.name}
              </Badge>
            ))}
          </div>
        </div>
      </div>

      <div className="px-4 py-6">
        {/* Results Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h2 className="text-lg font-semibold">
              {filteredResults.length} {filteredResults.length === 1 ? 'activity' : 'activities'} found
            </h2>
            {searchQuery && (
              <p className="text-sm text-muted-foreground">
                Results for "{searchQuery}"
              </p>
            )}
          </div>
        </div>

        {/* Results List */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {loading ? (
            // Show skeleton loading
            Array.from({ length: 6 }).map((_, index) => (
              <GameCardSkeleton key={index} />
            ))
          ) : (
            filteredResults.map((game) => (
              <UnifiedGameCard
                key={game.id}
                game={game}
                variant="simple"
                onSelect={() => handleGameSelect(game.id)}
              />
            ))
          )}
        </div>

        {!loading && filteredResults.length === 0 && (
          <EmptyStateEnhanced
            variant="no-results"
            title="No activities found"
            description="Try adjusting your search or filters to find what you're looking for."
            primaryAction={{
              label: "Clear Filters",
              onClick: () => {
                setSearchQuery('');
                setSelectedSport('all');
                setSelectedSkillLevel('all');
              },
              variant: "outline",
            }}
            secondaryAction={{
              label: "Create Activity",
              onClick: () => navigate('/app/create'),
              icon: <Plus className="size-4" />,
            }}
          />
        )}
      </div>
    </div>
  );
}

export default SearchDiscovery;
```

`domains/games/components/ShareGameModal.tsx`:

```tsx
import { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Separator } from '@/shared/components/ui/separator';
import { 
  Share2, 
  Copy, 
  Mail, 
  MessageSquare, 
  Calendar,
  MapPin,
  Users,
  Clock
} from 'lucide-react';
import { toast } from 'sonner';
import { formatTimeString } from '@/shared/utils/dateUtils';

interface ShareGameModalProps {
  game: any;
  isOpen: boolean;
  onClose: () => void;
}

export function ShareGameModal({ game, isOpen, onClose }: ShareGameModalProps) {
  const [copied, setCopied] = useState(false);
  
  if (!isOpen) return null;

  const gameDetailsUrl = `${window.location.origin}/public/game/${game.id}`;
  const shareText = `Join me for ${game.sport} at ${game.location} on ${game.date}!`;

  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(gameDetailsUrl);
      setCopied(true);
      toast.success('Link copied to clipboard!');
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      toast.error('Failed to copy link');
    }
  };

  const handleNativeShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: `Join ${game.title}`,
          text: shareText,
          url: gameDetailsUrl
        });
      } catch (error) {
        // User cancelled share
      }
    } else {
      handleCopyLink();
    }
  };

  const handleEmailShare = () => {
    const subject = encodeURIComponent(`Join me for ${game.sport}!`);
    const body = encodeURIComponent(`
Hi!

I'm organizing a ${game.sport} game and would love for you to join:

üìç ${game.location}
üìÖ ${game.date} at ${formatTimeString(game.time)}
üí∞ ${game.cost || 'Free'}
üë• ${game.totalPlayers ?? 0}/${game.maxPlayers ?? 0} players

${game.description ? game.description + '\n\n' : ''}View game details: ${gameDetailsUrl}

Hope to see you there!
    `.trim());
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
  };

  const handleSMSShare = () => {
    const message = encodeURIComponent(`${shareText} View details: ${gameDetailsUrl}`);
    window.open(`sms:?body=${message}`);
  };

  const handleWhatsAppShare = () => {
    const message = encodeURIComponent(`${shareText} View details: ${gameDetailsUrl}`);
    window.open(`https://wa.me/?text=${message}`);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Share2 className="w-5 h-5" />
            Share Activity
          </CardTitle>
        </CardHeader>
        
        <CardContent className="space-y-6">
          {/* Game Preview */}
          <div className="bg-muted/50 rounded-lg p-4">
            <h3 className="font-semibold mb-2">{game.title}</h3>
            <div className="space-y-2 text-sm">
              <div className="flex items-center gap-2">
                <Badge variant="secondary">{game.sport}</Badge>
              </div>
              <div className="flex items-center gap-2 text-muted-foreground">
                <MapPin className="w-4 h-4" />
                <span>{game.location}</span>
              </div>
              <div className="flex items-center gap-2 text-muted-foreground">
                <Calendar className="w-4 h-4" />
                <span>{game.date}</span>
              </div>
              <div className="flex items-center gap-2 text-muted-foreground">
                <Clock className="w-4 h-4" />
                <span>{formatTimeString(game.time)}</span>
              </div>
              <div className="flex items-center gap-2 text-muted-foreground">
                <Users className="w-4 h-4" />
                <span>{game.totalPlayers ?? 0}/{game.maxPlayers ?? 0} players</span>
              </div>
            </div>
          </div>

          {/* Share Link */}
          <div>
            <label className="text-sm font-medium mb-2 block">
              Activity Link
            </label>
            <div className="flex gap-2">
              <Input
                value={gameDetailsUrl}
                readOnly
                className="flex-1"
              />
              <Button
                variant="outline"
                size="sm"
                onClick={handleCopyLink}
                className={copied ? 'bg-green-50 text-green-700' : ''}
              >
                <Copy className="w-4 h-4" />
              </Button>
            </div>
            <p className="text-xs text-muted-foreground mt-2">
              Anyone can view this activity. Sign up to join!
            </p>
          </div>

          <Separator />

          {/* Share Options */}
          <div>
            <h4 className="text-sm font-medium mb-3">Share via</h4>
            <div className="grid grid-cols-2 gap-3">
              <Button
                variant="outline"
                onClick={handleNativeShare}
                className="flex items-center gap-2"
              >
                <Share2 className="w-4 h-4" />
                Share
              </Button>
              
              <Button
                variant="outline"
                onClick={handleEmailShare}
                className="flex items-center gap-2"
              >
                <Mail className="w-4 h-4" />
                Email
              </Button>
              
              <Button
                variant="outline"
                onClick={handleSMSShare}
                className="flex items-center gap-2"
              >
                <MessageSquare className="w-4 h-4" />
                SMS
              </Button>
              
              <Button
                variant="outline"
                onClick={handleWhatsAppShare}
                className="flex items-center gap-2"
              >
                <MessageSquare className="w-4 h-4" />
                WhatsApp
              </Button>
            </div>
          </div>

          {/* Actions */}
          <div className="flex gap-3">
            <Button variant="outline" onClick={onClose} className="flex-1">
              Close
            </Button>
            <Button onClick={handleCopyLink} className="flex-1">
              <Copy className="w-4 h-4 mr-2" />
              Copy Link
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/games/components/SportPicker.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Input } from '@/shared/components/ui/input';
import { Badge } from '@/shared/components/ui/badge';
import { Button } from '@/shared/components/ui/button';
import { ScrollArea } from '@/shared/components/ui/scroll-area';
import { Search, X, Clock, Star } from 'lucide-react';
import { getSportColor } from '@/shared/config/designTokens';

export interface Sport {
  value: string;
  label: string;
  icon: string;
  color?: string;
}

export const DEFAULT_SPORTS: Sport[] = [
  { value: 'basketball', label: 'Basketball', icon: 'üèÄ', color: '#FA4616' },
  { value: 'soccer', label: 'Soccer', icon: '‚öΩ', color: '#22884C' },
  { value: 'tennis', label: 'Tennis', icon: 'üéæ', color: '#0021A5' },
  { value: 'pickleball', label: 'Pickleball', icon: 'ü•í', color: '#22884C' },
  { value: 'volleyball', label: 'Volleyball', icon: 'üèê', color: '#F2A900' },
  { value: 'football', label: 'Football', icon: 'üèà', color: '#6A2A60' },
  { value: 'baseball', label: 'Baseball', icon: '‚öæ', color: '#D32737' },
  { value: 'running', label: 'Running', icon: 'üèÉ', color: '#FA4616' },
  { value: 'cycling', label: 'Cycling', icon: 'üö¥', color: '#22884C' },
  { value: 'swimming', label: 'Swimming', icon: 'üèä', color: '#0021A5' },
  { value: 'hiking', label: 'Hiking', icon: 'ü•æ', color: '#22884C' },
  { value: 'rock_climbing', label: 'Rock Climbing', icon: 'üßó', color: '#FA4616' },
];

export interface SportPickerProps {
  sports?: Sport[];
  selectedSport?: string;
  onSportSelect: (sport: Sport) => void;
  showSearch?: boolean;
  showRecent?: boolean;
  showFavorites?: boolean;
  recentSports?: string[];
  favoriteSports?: string[];
  onToggleFavorite?: (sport: string) => void;
  className?: string;
  maxRecent?: number;
  gridCols?: 2 | 3 | 4;
  size?: 'sm' | 'md' | 'lg';
  allowCustom?: boolean; // Enable creation of a custom sport when search does not match
}

/**
 * Sport Picker Component - Strava-inspired sport selection
 * 
 * Displays sports in a grid layout with search, recent selections, and favorites support.
 * 
 * @example
 * ```tsx
 * <SportPicker
 *   selectedSport="basketball"
 *   onSportSelect={(sport) => setSelectedSport(sport.value)}
 *   showSearch
 *   showRecent
 *   recentSports={['basketball', 'soccer']}
 * />
 * ```
 */
export function SportPicker({
  sports = DEFAULT_SPORTS,
  selectedSport,
  onSportSelect,
  showSearch = true,
  showRecent = true,
  showFavorites = false,
  recentSports = [],
  favoriteSports = [],
  onToggleFavorite,
  className,
  maxRecent = 5,
  gridCols = 3,
  size = 'md',
  allowCustom = false,
}: SportPickerProps) {
  const [searchQuery, setSearchQuery] = React.useState('');
  const [focusedIndex, setFocusedIndex] = React.useState<number | null>(null);
  const searchInputRef = React.useRef<HTMLInputElement>(null);
  const gridRef = React.useRef<HTMLDivElement>(null);

  // Filter sports based on search query
  const filteredSports = React.useMemo(() => {
    if (!searchQuery.trim()) return sports;
    const query = searchQuery.toLowerCase();
    return sports.filter(
      (sport) =>
        sport.label.toLowerCase().includes(query) ||
        sport.value.toLowerCase().includes(query)
    );
  }, [sports, searchQuery]);

  // Get recent sports (limited to maxRecent)
  const recentSportsList = React.useMemo(() => {
    if (!showRecent || !recentSports.length) return [];
    return recentSports
      .slice(0, maxRecent)
      .map((value) => sports.find((s) => s.value === value))
      .filter((sport): sport is Sport => sport !== undefined);
  }, [recentSports, sports, maxRecent, showRecent]);

  // Get favorite sports
  const favoriteSportsList = React.useMemo(() => {
    if (!showFavorites || !favoriteSports.length) return [];
    return favoriteSports
      .map((value) => sports.find((s) => s.value === value))
      .filter((sport): sport is Sport => sport !== undefined);
  }, [favoriteSports, sports, showFavorites]);

  // Handle keyboard navigation
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
      e.preventDefault();
      const allItems = [...(favoriteSportsList || []), ...(recentSportsList || []), ...filteredSports];
      if (allItems.length === 0) return;

      let newIndex = focusedIndex ?? -1;
      if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
        newIndex = newIndex < allItems.length - 1 ? newIndex + 1 : 0;
      } else {
        newIndex = newIndex > 0 ? newIndex - 1 : allItems.length - 1;
      }
      setFocusedIndex(newIndex);
    } else if (e.key === 'Enter' && focusedIndex !== null) {
      const allItems = [...(favoriteSportsList || []), ...(recentSportsList || []), ...filteredSports];
      if (allItems[focusedIndex]) {
        onSportSelect(allItems[focusedIndex]);
        setFocusedIndex(null);
      }
    } else if (e.key === 'Escape') {
      setSearchQuery('');
      setFocusedIndex(null);
      searchInputRef.current?.blur();
    }
  };

  const handleSportClick = (sport: Sport) => {
    onSportSelect(sport);
    setFocusedIndex(null);
  };

  const handleToggleFavorite = (e: React.MouseEvent, sport: Sport) => {
    e.stopPropagation();
    if (onToggleFavorite) {
      onToggleFavorite(sport.value);
    }
  };

  const gridColsClass = {
    2: 'grid-cols-2',
    3: 'grid-cols-3',
    4: 'grid-cols-4',
  }[gridCols];

  const sizeClasses = {
    sm: {
      card: 'p-2',
      icon: 'text-lg',
      label: 'text-xs',
    },
    md: {
      card: 'p-2',
      icon: 'text-xl',
      label: 'text-sm',
    },
    lg: {
      card: 'p-3',
      icon: 'text-2xl',
      label: 'text-base',
    },
  }[size];

  const renderSportCard = (sport: Sport, index: number, isFavorite = false) => {
    const isSelected = selectedSport === sport.value;
    const isFocused = focusedIndex === index;
    const isInFavorites = favoriteSports.includes(sport.value);

    return (
      <button
        key={sport.value}
        type="button"
        onClick={() => handleSportClick(sport)}
        onKeyDown={handleKeyDown}
        className={cn(
          'relative flex flex-col items-center justify-center gap-2 rounded-lg border-2 transition-all duration-200',
          sizeClasses.card,
          isSelected
            ? 'border-primary bg-primary/10 shadow-medium'
            : 'border-border bg-card hover:border-primary/50 hover:bg-muted/50 hover:shadow-subtle',
          isFocused && 'ring-2 ring-primary ring-offset-2',
          'focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2'
        )}
        aria-label={`Select ${sport.label}`}
        aria-pressed={isSelected}
        tabIndex={0}
      >
        {/* Sport Icon */}
        <div className={cn(sizeClasses.icon)} role="img" aria-label={sport.label}>
          {sport.icon}
        </div>

        {/* Sport Label */}
        <span className={cn('font-medium', sizeClasses.label)}>{sport.label}</span>

        {/* Selected Indicator */}
        {isSelected && (
          <div className="absolute top-1 right-1 size-2 rounded-full bg-primary" />
        )}

        {/* Favorite Toggle */}
        {showFavorites && onToggleFavorite && (
          <button
            type="button"
            onClick={(e) => handleToggleFavorite(e, sport)}
            className={cn(
              'absolute top-1 left-1 p-1 rounded-full transition-colors',
              'hover:bg-background/80 focus:outline-none focus:ring-2 focus:ring-primary',
              isInFavorites ? 'text-warning' : 'text-muted-foreground'
            )}
            aria-label={isInFavorites ? `Remove ${sport.label} from favorites` : `Add ${sport.label} to favorites`}
            tabIndex={-1}
          >
            <Star className={cn('size-3', isInFavorites && 'fill-current')} />
          </button>
        )}
      </button>
    );
  };

  return (
    <div className={cn('space-y-4', className)}>
      {/* Search Input */}
      {showSearch && (
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground pointer-events-none z-10" />
          <Input
            ref={searchInputRef}
            type="text"
            placeholder="Search sports..."
            value={searchQuery}
            onChange={(e) => {
              setSearchQuery(e.target.value);
              setFocusedIndex(null);
            }}
            onKeyDown={handleKeyDown}
            className="pl-10 pr-9"
            aria-label="Search sports"
          />
          {searchQuery && (
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-1 top-1/2 -translate-y-1/2 size-6"
              onClick={() => {
                setSearchQuery('');
                searchInputRef.current?.focus();
              }}
              aria-label="Clear search"
            >
              <X className="size-3" />
            </Button>
          )}
        </div>
      )}

      <ScrollArea className="h-[320px]">
        <div className="space-y-4 pr-3">
          {/* Favorites Section */}
          {showFavorites && favoriteSportsList.length > 0 && (
            <div className="space-y-3">
              <div className="flex items-center gap-2">
                <Star className="size-4 text-warning fill-current" />
                <h3 className="text-sm font-semibold">Favorites</h3>
              </div>
              <div className={cn('grid gap-2', gridColsClass)}>
                {favoriteSportsList.map((sport, index) =>
                  renderSportCard(sport, index, true)
                )}
              </div>
            </div>
          )}

          {/* Recent Section */}
          {showRecent && recentSportsList.length > 0 && (
            <div className="space-y-3">
              <div className="flex items-center gap-2">
                <Clock className="size-4 text-muted-foreground" />
                <h3 className="text-sm font-semibold">Recent</h3>
              </div>
              <div className={cn('grid gap-2', gridColsClass)}>
                {recentSportsList.map((sport, index) =>
                  renderSportCard(
                    sport,
                    (favoriteSportsList?.length || 0) + index,
                    false
                  )
                )}
              </div>
            </div>
          )}

          {/* All Sports Section */}
          <div className="space-y-3">
            {(!showFavorites || favoriteSportsList.length === 0) &&
              (!showRecent || recentSportsList.length === 0) && (
                <h3 className="text-sm font-semibold">Select a Sport</h3>
              )}
            {filteredSports.length > 0 ? (
              <div className={cn('grid gap-2', gridColsClass)}>
                {filteredSports.map((sport, index) =>
                  renderSportCard(
                    sport,
                    (favoriteSportsList?.length || 0) +
                      (recentSportsList?.length || 0) +
                      index,
                    false
                  )
                )}
              </div>
            ) : (
              <div className="py-8 text-center text-muted-foreground space-y-3">
                <p>No sports found matching "{searchQuery}"</p>
                <div className="flex justify-center gap-2">
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => setSearchQuery('')}
                  >
                    Clear
                  </Button>
                  {allowCustom && searchQuery.trim().length >= 2 && (
                    <Button
                      type="button"
                      variant="default"
                      size="sm"
                      onClick={() => {
                        const raw = searchQuery.trim();
                        const value = raw
                          .toLowerCase()
                          .replace(/[^a-z0-9]+/g, '_')
                          .replace(/^_+|_+$/g, '');
                        const customSport: Sport = {
                          value,
                          label: raw,
                          icon: '‚ú®',
                          color: getSportColor(value)
                        };
                        onSportSelect(customSport);
                      }}
                    >
                      Use "{searchQuery}" as custom sport
                    </Button>
                  )}
                </div>
                {allowCustom && (
                  <p className="text-xs text-muted-foreground">Custom sports are saved for this activity only.</p>
                )}
              </div>
            )}
          </div>
        </div>
      </ScrollArea>
    </div>
  );
}

/**
 * Simple Sport Picker - No search, recent, or favorites
 */
export function SimpleSportPicker({
  sports = DEFAULT_SPORTS,
  selectedSport,
  onSportSelect,
  className,
  gridCols = 3,
  size = 'md',
}: Omit<SportPickerProps, 'showSearch' | 'showRecent' | 'showFavorites'>) {
  return (
    <SportPicker
      sports={sports}
      selectedSport={selectedSport}
      onSportSelect={onSportSelect}
      showSearch={false}
      showRecent={false}
      showFavorites={false}
      className={className}
      gridCols={gridCols}
      size={size}
    />
  );
}


```

`domains/games/components/UnifiedGameCard.tsx`:

```tsx
import React, { useState, useRef } from 'react';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Button } from '@/shared/components/ui/button';
import { Avatar, AvatarFallback } from '@/shared/components/ui/avatar';
import { ClickableAvatar } from '@/shared/components/ui/clickable-avatar';
import { ImageWithFallback } from '@/shared/components/figma/ImageWithFallback';
import { MapPin, Calendar, Users, Clock, Star, ChevronRight } from 'lucide-react';
import { ActivityLikeButton } from './ActivityLikeButton';
import { ActivityMapPreview } from './ActivityMapPreview';
import { useGameCard } from '@/domains/games/hooks/useGameCard';
import { formatTimeString, formatCost, formatEventHeader } from '@/shared/utils/dateUtils';
import { GameCapacity } from '@/shared/components/ui/GameCapacity';
import { SimpleCalendarButton } from '@/shared/components/common/SimpleCalendarButton';

interface Game {
  id: string;
  title: string;
  sport: string;
  sportColor?: string;
  location: string;
  date: string;
  time: string;
  description: string;
  imageUrl?: string;
  currentPlayers: number;
  maxPlayers: number;
  totalPlayers?: number;
  availableSpots?: number;
  isJoined: boolean;
  cost?: string;
  category?: string;
  followerCount?: number;
  skillLevel?: 'beginner' | 'intermediate' | 'advanced' | 'mixed';
  host?: {
    id?: string;
    name: string;
    avatar?: string;
  };
  rating?: number;
  [key: string]: any;
}

interface UnifiedGameCardProps {
  game: Game;
  variant?: 'full' | 'simple' | 'compact' | 'strava';
  showImage?: boolean;
  showJoinButton?: boolean;
  onSelect?: (gameId: string) => void;
  onJoinLeave?: (gameId: string) => void;
  distance?: string | null; // Distance in formatted string (e.g., "2.3 mi")
  friendAvatars?: string[]; // Optional friend/participant avatar URLs
}

/**
 * Unified GameCard component that handles all game card variants
 * Replaces SimpleGameCard components in HomeScreen and SearchDiscovery
 */
export function UnifiedGameCard({
  game,
  variant = 'simple',
  showImage = false,
  showJoinButton = true,
  onSelect,
  onJoinLeave,
  distance = null,
  friendAvatars = []
}: UnifiedGameCardProps) {
  const [isHovered, setIsHovered] = useState(false);
  const [swipeOffset, setSwipeOffset] = useState(0);
  const [isSwipeJoining, setIsSwipeJoining] = useState(false);
  const touchStartX = useRef<number | null>(null);
  const touchStartY = useRef<number | null>(null);
  const cardRef = useRef<HTMLDivElement>(null);

  const {
    handleCardClick,
    handleJoinClick,
    isLoading,
    getButtonText,
    getButtonVariant,
    getCategoryBadge,
    getPlayerCount,
    getJoinStatus,
    game: currentGame // Use the game from hook which has cache updates
  } = useGameCard(game, { onSelect, onJoinLeave });
  
  // Use currentGame from hook (with cache updates) instead of prop
  const gameToRender = currentGame || game;

  // Touch gesture handlers for swipe-to-join
  const handleTouchStart = (e: React.TouchEvent) => {
    if (gameToRender.isJoined) return; // Don't allow swipe if already joined

    touchStartX.current = e.touches[0].clientX;
    touchStartY.current = e.touches[0].clientY;
    setSwipeOffset(0);
    setIsSwipeJoining(false);
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    if (touchStartX.current === null || gameToRender.isJoined) return;

    const currentX = e.touches[0].clientX;
    const currentY = e.touches[0].clientY;
    const deltaX = currentX - touchStartX.current;
    const deltaY = currentY - touchStartY.current;

    // Only respond to horizontal swipes (more horizontal than vertical)
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
      e.preventDefault(); // Prevent scrolling when swiping
      const newOffset = Math.max(0, Math.min(deltaX, 80)); // Max 80px swipe
      setSwipeOffset(newOffset);
      setIsSwipeJoining(newOffset > 40); // Trigger join at 40px
    }
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    if (touchStartX.current === null || gameToRender.isJoined) {
      setSwipeOffset(0);
      setIsSwipeJoining(false);
      touchStartX.current = null;
      touchStartY.current = null;
      return;
    }

    const currentX = e.changedTouches[0].clientX;
    const deltaX = currentX - touchStartX.current;

    // If swiped far enough, trigger join
    if (deltaX > 60 && !gameToRender.isJoined && !isLoading) {
      // Add haptic feedback
      if ('vibrate' in navigator) {
        navigator.vibrate(100);
      }

      // Trigger join
      handleJoinClick(e as any);
      setIsSwipeJoining(false);
    }

    // Reset swipe state
    setSwipeOffset(0);
    setIsSwipeJoining(false);
    touchStartX.current = null;
    touchStartY.current = null;
  };

  // Full variant (original GameCard)
  if (variant === 'full') {
    return (
      <div
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
      >
        <Card 
          className={`overflow-hidden cursor-pointer transition-all duration-200 ease-out ${
            isHovered ? 'shadow-medium' : 'shadow-subtle'
          }`}
          onClick={handleCardClick}
        >
          <div className="relative overflow-hidden">
            {gameToRender.imageUrl ? (
              <div className="aspect-video overflow-hidden">
                <ImageWithFallback
                  src={gameToRender.imageUrl}
                  alt={gameToRender.sport}
                  className="w-full h-full object-cover transition-transform duration-300 ease-out"
                />
              </div>
            ) : (
              <div className="h-16 bg-gradient-to-r from-blue-50 to-purple-50 flex items-center justify-center">
                <Badge variant="secondary" className="text-sm">
                  {gameToRender.sport}
                </Badge>
              </div>
            )}
            
            {/* Gradient overlay on hover */}
            <div
              className={`absolute inset-0 bg-gradient-to-t from-black/20 to-transparent transition-opacity duration-200 ${
                isHovered ? 'opacity-10' : 'opacity-0'
              }`}
            />
            
            {/* Date/Time Block - Top Left */}
            <div className="absolute top-3 left-3 bg-background/95 backdrop-blur-sm rounded-lg px-3 py-2 min-w-[80px]">
              <div className="flex items-center gap-1 mb-1">
                <Calendar className="w-3 h-3 text-muted-foreground" />
                <span className="text-xs text-muted-foreground">{formatEventHeader(gameToRender.date, gameToRender.time).date}</span>
              </div>
              <div className="text-sm font-medium">{formatTimeString(gameToRender.time)}</div>
            </div>

            {/* Sport Tag - Top Right */}
            <div className="absolute top-3 right-3 flex flex-col gap-1 items-end">
              <Badge className={`${gameToRender.sportColor || 'bg-primary'} text-white border-none`}>
                {gameToRender.sport}
              </Badge>
              {gameToRender.skillLevel && (
                <Badge variant="outline" className="text-xs capitalize bg-background/90 backdrop-blur-sm">
                  {gameToRender.skillLevel}
                </Badge>
              )}
            </div>

            {/* Join status indicator */}
            {/* Use gameToRender from useGameCard hook which has cache updates */}
            {gameToRender.isJoined && (
              <div className="absolute bottom-3 right-3 w-6 h-6 bg-success rounded-full flex items-center justify-center">
                <div className="w-2 h-2 bg-white rounded-full" />
              </div>
            )}
          </div>

          <CardContent className="p-4">
            <div className="space-y-3">
              <div>
                <h3 className="font-semibold text-lg mb-1">{gameToRender.title}</h3>
                <div className="flex items-center gap-2 flex-wrap mb-2">
                  <div className="flex items-center gap-2 text-sm text-muted-foreground">
                    <MapPin className="w-4 h-4" />
                    <span>{gameToRender.location}</span>
                  </div>
                  {gameToRender.skillLevel && (
                    <Badge variant="outline" className="text-xs capitalize">
                      {gameToRender.skillLevel}
                    </Badge>
                  )}
                </div>
              </div>
              
              {/* Host info */}
              {gameToRender.host && (
                <div className="flex items-center gap-2 text-sm">
                  <ClickableAvatar
                    userId={gameToRender.host.id}
                    src={gameToRender.host.avatar}
                    alt={gameToRender.host.name}
                    size="xs"
                  />
                  <span className="text-muted-foreground">Hosted by {gameToRender.host.name}</span>
                </div>
              )}
              
              <div className="flex items-center justify-between">
                <GameCapacity
                  totalPlayers={gameToRender.totalPlayers}
                  maxPlayers={gameToRender.maxPlayers}
                  availableSpots={gameToRender.availableSpots}
                />
                
                <div className="flex gap-2">
                  {showJoinButton && (
                    <Button 
                      size="sm" 
                      variant={getButtonVariant(gameToRender)}
                      onClick={handleJoinClick}
                      className="transition-all duration-200 flex-1"
                      disabled={isLoading || (gameToRender.totalPlayers >= gameToRender.maxPlayers && !gameToRender.isJoined)}
                    >
                      {gameToRender.totalPlayers >= gameToRender.maxPlayers && !gameToRender.isJoined ? 'Game Full' : getButtonText(gameToRender)}
                    </Button>
                  )}
                  <SimpleCalendarButton 
                    game={gameToRender} 
                    className="flex-shrink-0"
                  />
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Strava variant - Image-first design with statistics overlay
  if (variant === 'strava') {
    return (
      <div
        ref={cardRef}
        className="bg-card rounded-xl overflow-hidden border border-border cursor-pointer hover:shadow-lg transition-all duration-200 ease-out group"
        onClick={handleCardClick}
      >
        {/* Hero Image - Only show if there's an actual image */}
        {gameToRender.imageUrl && (
          <div className="relative w-full aspect-video overflow-hidden bg-gradient-to-br from-primary/20 to-primary/5">
            <ImageWithFallback
              src={gameToRender.imageUrl}
              alt={gameToRender.title}
              className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
            />
            
            {/* Gradient Overlay for text readability */}
            <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent z-0" />
            
            {/* User Avatar + Name Overlay - Top Left */}
            {gameToRender.host && (
              <div className="absolute top-3 left-3 flex items-center gap-2 z-10">
                <ClickableAvatar
                  userId={gameToRender.host.id}
                  src={gameToRender.host.avatar}
                  alt={gameToRender.host.name}
                  size="sm"
                  className="ring-2 ring-white/50"
                />
                <span className="text-white font-medium text-sm drop-shadow-lg">
                  {gameToRender.host.name}
                </span>
              </div>
            )}
            
            {/* Statistics Overlay - Bottom */}
            <div className="absolute bottom-0 left-0 right-0 p-3 z-10">
              <div className="flex items-center justify-between gap-2 flex-wrap text-xs">
                <div className="flex items-center gap-2 flex-wrap">
                  {/* Players Stat */}
                  <div className="flex items-center gap-1.5 bg-black/40 backdrop-blur-sm rounded-lg px-2 py-1.5">
                    <Users className="w-3.5 h-3.5 text-white" />
                    <span className="text-white font-semibold">
                      {gameToRender.totalPlayers}/{gameToRender.maxPlayers}
                    </span>
                  </div>
                  
                  {/* Time Stat */}
                  <div className="flex items-center gap-1.5 bg-black/40 backdrop-blur-sm rounded-lg px-2 py-1.5">
                    <Clock className="w-3.5 h-3.5 text-white" />
                    <span className="text-white font-semibold">
                      {formatTimeString(gameToRender.time)}
                    </span>
                  </div>
                  
                  {/* Location Stat */}
                  <div className="flex items-center gap-1.5 bg-black/40 backdrop-blur-sm rounded-lg px-2 py-1.5">
                    <MapPin className="w-3.5 h-3.5 text-white" />
                    <span className="text-white font-semibold truncate max-w-[100px]">
                      {gameToRender.location.split(',')[0]}
                    </span>
                  </div>
                </div>
                
                {/* Host Avatar */}
                {gameToRender.host && (
                  <div className="flex items-center gap-1.5">
                    <ClickableAvatar
                      userId={gameToRender.host.id}
                      src={gameToRender.host.avatar}
                      alt={gameToRender.host.name}
                      size="xs"
                      className="ring-2 ring-white/50"
                    />
                    <span className="text-white font-medium text-xs drop-shadow-lg">{gameToRender.host.name}</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
        
        {/* Stats bar when no image - inline with content */}
        {!gameToRender.imageUrl && (
          <div className="bg-gradient-to-br from-primary/10 to-primary/5 p-3">
            <div className="flex items-center justify-between gap-2 flex-wrap text-xs">
              <div className="flex items-center gap-2 flex-wrap">
                {/* Players Stat */}
                <div className="flex items-center gap-1.5 bg-card/60 backdrop-blur-sm rounded-lg px-2 py-1.5 border border-border/50">
                  <Users className="w-3.5 h-3.5" />
                  <span className="font-semibold">
                    {gameToRender.totalPlayers}/{gameToRender.maxPlayers}
                  </span>
                </div>
                
                {/* Time Stat */}
                <div className="flex items-center gap-1.5 bg-card/60 backdrop-blur-sm rounded-lg px-2 py-1.5 border border-border/50">
                  <Clock className="w-3.5 h-3.5" />
                  <span className="font-semibold">
                    {formatTimeString(gameToRender.time)}
                  </span>
                </div>
                
                {/* Location Stat */}
                <div className="flex items-center gap-1.5 bg-card/60 backdrop-blur-sm rounded-lg px-2 py-1.5 border border-border/50">
                  <MapPin className="w-3.5 h-3.5" />
                  <span className="font-semibold truncate max-w-[100px]">
                    {gameToRender.location.split(',')[0]}
                  </span>
                </div>
              </div>
              
              {/* Host Avatar */}
              {gameToRender.host && (
                <div className="flex items-center gap-1.5">
                  <ClickableAvatar
                    userId={gameToRender.host.id}
                    src={gameToRender.host.avatar}
                    alt={gameToRender.host.name}
                    size="xs"
                  />
                  <span className="text-xs font-medium">{gameToRender.host.name}</span>
                </div>
              )}
            </div>
          </div>
        )}
        
        {/* Card Content */}
        <div className="p-4">
          <div className="flex items-start justify-between mb-3">
            <div className="flex-1 min-w-0">
              <h3 className="font-bold text-lg mb-1 truncate">{gameToRender.title}</h3>
              <div className="flex items-center gap-2 flex-wrap">
                <Badge variant="secondary" className="text-xs">
                  {gameToRender.sport}
                </Badge>
                {gameToRender.skillLevel && (
                  <Badge variant="outline" className="text-xs capitalize">
                    {gameToRender.skillLevel}
                  </Badge>
                )}
                {gameToRender.cost && (
                  <Badge variant="outline" className="text-xs">
                    {formatCost(gameToRender.cost)}
                  </Badge>
                )}
              </div>
            </div>
          </div>
          
          {/* Description */}
          {gameToRender.description && (
            <p className="text-sm text-muted-foreground line-clamp-2 mb-4">
              {gameToRender.description}
            </p>
          )}
          
          {/* Map Preview - Only if coordinates exist */}
          {gameToRender.latitude && gameToRender.longitude && (
            <div className="mb-4 rounded-lg overflow-hidden">
              <ActivityMapPreview
                latitude={gameToRender.latitude}
                longitude={gameToRender.longitude}
                location={gameToRender.location}
                className="h-40 w-full"
                onClick={() => handleCardClick()}
              />
            </div>
          )}
          
          {/* Footer with Join Button */}
          {showJoinButton && (
            <div className="flex items-center justify-between pt-3 border-t border-border">
              <div className="flex items-center gap-4 text-sm text-muted-foreground">
                <ActivityLikeButton 
                  activityId={gameToRender.id} 
                  variant="minimal"
                  showCount={true}
                />
                {gameToRender.followerCount && gameToRender.followerCount > 0 && (
                  <div className="flex items-center gap-1">
                    <Users className="w-4 h-4" />
                    <span>{gameToRender.followerCount}</span>
                  </div>
                )}
              </div>
              
              <Button
                onClick={(e) => {
                  e.stopPropagation();
                  if ('vibrate' in navigator) {
                    navigator.vibrate(50);
                  }
                  handleJoinClick(e);
                }}
                disabled={isLoading || (gameToRender.totalPlayers >= gameToRender.maxPlayers && !gameToRender.isJoined)}
                size="sm"
                variant={gameToRender.isJoined ? "destructive" : "default"}
                className="font-semibold"
              >
                {isLoading ? (
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin" />
                    <span>Joining...</span>
                  </div>
                ) : (
                  gameToRender.totalPlayers >= gameToRender.maxPlayers && !gameToRender.isJoined
                    ? 'Full'
                    : getButtonText(gameToRender)
                )}
              </Button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Simple variant (for HomeScreen and SearchDiscovery) - Optimized for less scrolling
  return (
    <div
      ref={cardRef}
      className={`bg-card rounded-md p-3 border border-border/60 cursor-pointer shadow-sm hover:shadow-lg hover:border-primary/30 transition-colors duration-150 relative overflow-hidden group ${
        swipeOffset > 0 ? 'transition-none' : ''
      }`}
      style={{
        transform: swipeOffset > 0 ? `translateX(${swipeOffset}px)` : undefined,
      }}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      onClick={handleCardClick}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
    >
      {/* Swipe indicator background */}
      {swipeOffset > 0 && !gameToRender.isJoined && (
        <div className="absolute inset-0 bg-primary/10 flex items-center justify-start pl-4">
          <div className="flex items-center gap-2 text-primary">
            <ChevronRight className="w-5 h-5" />
            <span className="font-medium text-sm">Swipe to join</span>
          </div>
        </div>
      )}

      {/* Card content */}
      <div className="relative z-10">
        {/* Header with title and category badge */}
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1 pr-3 min-w-0">
            <div className="flex items-center gap-2 mb-1.5">
              <h3 className="font-semibold text-sm truncate leading-tight text-foreground">{gameToRender.title}</h3>
              {getCategoryBadge() && (
                <span className={`inline-block text-xs px-2 py-0.5 rounded-full font-medium whitespace-nowrap shadow-sm ${getCategoryBadge()?.className}`}>
                  {getCategoryBadge()?.text}
                </span>
              )}
            </div>
            <div className="flex items-center gap-2 flex-wrap">
              <span className="text-xs text-muted-foreground font-medium">{gameToRender.sport}</span>
              {gameToRender.skillLevel && (
                <Badge variant="outline" className="text-xs capitalize">
                  {gameToRender.skillLevel}
                </Badge>
              )}
              {gameToRender.cost && (
                <Badge variant="secondary" className="text-xs font-semibold">
                  {formatCost(gameToRender.cost)}
                </Badge>
              )}
              {distance && (
                <span className="text-[10px] text-muted-foreground ml-auto flex items-center gap-1"><MapPin className="w-3 h-3" />{distance}</span>
              )}
            </div>
          </div>
          <div className="text-right flex-shrink-0 flex flex-col items-end gap-1">
            {/* Follower count indicator */}
            {(gameToRender.followerCount && gameToRender.followerCount > 0) && (
              <div className="flex items-center gap-1 text-xs text-muted-foreground">
                <Users className="w-3.5 h-3.5 text-muted-foreground" />
                <span>{gameToRender.followerCount} follower{gameToRender.followerCount !== 1 ? 's' : ''}</span>
              </div>
            )}
            <GameCapacity
              totalPlayers={gameToRender.totalPlayers}
              maxPlayers={gameToRender.maxPlayers}
              availableSpots={gameToRender.availableSpots}
              className="text-sm justify-end"
            />
          </div>
        </div>
      
        {/* Game details - Condensed */}
        <div className="space-y-1 text-xs text-muted-foreground mb-2">
          <div className="flex items-center gap-1.5 truncate">
            <MapPin className="w-3 h-3 flex-shrink-0 text-muted-foreground" />
            <span className="truncate">{gameToRender.location}</span>
          </div>
          <div className="flex items-center gap-1.5">
            <Clock className="w-3 h-3 flex-shrink-0 text-muted-foreground" />
            <span>{gameToRender.date} at {formatTimeString(gameToRender.time)}</span>
          </div>
        </div>
      
        {/* Truncated description */}
        {gameToRender.description && (
          <p className="text-[11px] text-muted-foreground line-clamp-2 mb-2">
            {gameToRender.description}
          </p>
        )}

        {/* Friend/participant avatars */}
        {friendAvatars.length > 0 && (
          <div className="flex items-center mb-2">
            <div className="flex -space-x-2">
              {friendAvatars.slice(0,3).map((src, i) => (
                <Avatar key={i} className="w-6 h-6 border border-border bg-muted">
                  {src ? <img src={src} alt="" className="w-6 h-6 rounded-full object-cover" /> : <AvatarFallback className="text-[10px]">?</AvatarFallback>}
                </Avatar>
              ))}
            </div>
            <span className="text-[10px] text-muted-foreground ml-2">
              {friendAvatars.length} friend{friendAvatars.length !== 1 ? 's' : ''} here
            </span>
          </div>
        )}
      
        {/* Footer with join button */}
        {showJoinButton && (
          <div className="flex items-center justify-end gap-2">
            {getJoinStatus() && (
              <span className={`inline-block text-xs ${getJoinStatus()?.className}`}>
                {getJoinStatus()?.text}
              </span>
            )}

            <Button
              onClick={(e) => {
                e.stopPropagation();
                // Add haptic feedback for mobile
                if ('vibrate' in navigator) {
                  navigator.vibrate(50);
                }
                handleJoinClick(e);
              }}
              disabled={isLoading || (gameToRender.isJoined && getButtonVariant(gameToRender) === 'secondary')}
              size="sm"
              variant={getButtonVariant(gameToRender) === 'secondary' ? 'secondary' : (gameToRender.isJoined ? "destructive" : "default")}
              className={`font-semibold transition-all duration-200 ${
                getButtonVariant(gameToRender) === 'secondary'
                  ? 'opacity-60 cursor-not-allowed'
                  : gameToRender.isJoined
                  ? 'bg-destructive text-destructive-foreground hover:bg-destructive/90'
                  : 'bg-primary text-primary-foreground hover:bg-primary/90'
              }`}
              title={getButtonVariant(gameToRender) === 'secondary' ? "You created this activity" : undefined}
            >
              {isLoading ? (
                <div className="flex items-center gap-1">
                  <div className="w-3 h-3 border border-current border-t-transparent rounded-full animate-spin" />
                  <span className="text-xs">Joining...</span>
                </div>
              ) : (
                getButtonText(gameToRender)
              )}
            </Button>
          </div>
        )}
      </div>
    </div>
  );
}

export default UnifiedGameCard;

```

`domains/games/components/WaitlistManager.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { Clock, Users, AlertCircle, CheckCircle, X } from 'lucide-react';
import { SupabaseService } from '@/core/database/supabaseService';
import { useAppStore } from '@/store/appStore';

interface WaitlistEntry {
  id: string;
  position: number;
  joinedAt: string;
  status: 'waiting' | 'notified' | 'expired' | 'joined';
  expiresAt?: string;
  user: {
    id: string;
    name: string;
    username: string;
    avatarUrl?: string;
  };
}

interface WaitlistManagerProps {
  gameId: string;
  isGameFull: boolean;
  currentPlayers: number;
  maxPlayers: number;
  isUserJoined: boolean;
  onGameJoin?: () => void;
}

export const WaitlistManager: React.FC<WaitlistManagerProps> = ({
  gameId,
  isGameFull,
  currentPlayers,
  maxPlayers,
  isUserJoined,
  onGameJoin
}) => {
  const { user } = useAppStore();
  const [waitlist, setWaitlist] = useState<WaitlistEntry[]>([]);
  const [userWaitlistStatus, setUserWaitlistStatus] = useState<{
    isOnWaitlist: boolean;
    position?: number;
    status?: string;
  }>({ isOnWaitlist: false });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showWaitlist, setShowWaitlist] = useState(false);

  useEffect(() => {
    if (gameId) {
      loadWaitlistData();
    }
  }, [gameId]);

  const loadWaitlistData = async () => {
    try {
      const [waitlistData, userStatus] = await Promise.all([
        SupabaseService.getGameWaitlist(gameId),
        user ? SupabaseService.getUserWaitlistStatus(gameId) : Promise.resolve({ isOnWaitlist: false })
      ]);
      
      setWaitlist(waitlistData);
      setUserWaitlistStatus(userStatus);
    } catch (err) {
      console.error('Error loading waitlist data:', err);
      setError('Failed to load waitlist information');
    }
  };

  const handleJoinWaitlist = async () => {
    if (!user) {
      setError('Please sign in to join the waitlist');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const result = await SupabaseService.joinWaitlist(gameId);
      if (result.success) {
        await loadWaitlistData();
        // Show success message
        setError(null);
      }
    } catch (err: any) {
      setError(err.message || 'Failed to join waitlist');
    } finally {
      setLoading(false);
    }
  };

  const handleLeaveWaitlist = async () => {
    setLoading(true);
    setError(null);

    try {
      const result = await SupabaseService.leaveWaitlist(gameId);
      if (result.success) {
        await loadWaitlistData();
        setError(null);
      }
    } catch (err: any) {
      setError(err.message || 'Failed to leave waitlist');
    } finally {
      setLoading(false);
    }
  };

  const handleJoinFromWaitlist = async () => {
    setLoading(true);
    setError(null);

    try {
      const result = await SupabaseService.joinFromWaitlist(gameId);
      if (result.success) {
        await loadWaitlistData();
        onGameJoin?.();
        setError(null);
      }
    } catch (err: any) {
      setError(err.message || 'Failed to join game from waitlist');
    } finally {
      setLoading(false);
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'waiting':
        return <Clock className="w-4 h-4 text-yellow-500" />;
      case 'notified':
        return <AlertCircle className="w-4 h-4 text-blue-500" />;
      case 'expired':
        return <X className="w-4 h-4 text-red-500" />;
      case 'joined':
        return <CheckCircle className="w-4 h-4 text-green-500" />;
      default:
        return <Clock className="w-4 h-4 text-gray-500" />;
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'waiting':
        return 'Waiting';
      case 'notified':
        return 'Notified';
      case 'expired':
        return 'Expired';
      case 'joined':
        return 'Joined';
      default:
        return 'Unknown';
    }
  };

  const formatTimeRemaining = (expiresAt: string) => {
    const now = new Date();
    const expires = new Date(expiresAt);
    const diff = expires.getTime() - now.getTime();
    
    if (diff <= 0) return 'Expired';
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    if (hours > 0) {
      return `${hours}h ${minutes}m remaining`;
    }
    return `${minutes}m remaining`;
  };

  // Don't show waitlist manager if game isn't full and user isn't on waitlist
  if (!isGameFull && !userWaitlistStatus.isOnWaitlist && waitlist.length === 0) {
    return null;
  }

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-4 mt-4">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center space-x-2">
          <Users className="w-5 h-5 text-gray-600" />
          <h3 className="text-lg font-semibold text-gray-900">
            Waitlist ({waitlist.length})
          </h3>
        </div>
        {waitlist.length > 0 && (
          <button
            onClick={() => setShowWaitlist(!showWaitlist)}
            className="text-sm text-blue-600 hover:text-blue-800"
          >
            {showWaitlist ? 'Hide' : 'Show'} Waitlist
          </button>
        )}
      </div>

      {error && (
        <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
          <p className="text-sm text-red-600">{error}</p>
        </div>
      )}

      {/* User's waitlist status */}
      {userWaitlistStatus.isOnWaitlist && (
        <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-2">
              {getStatusIcon(userWaitlistStatus.status || 'waiting')}
              <span className="text-sm font-medium text-blue-900">
                You're #{userWaitlistStatus.position} on the waitlist
              </span>
            </div>
            <div className="flex items-center space-x-2">
              {userWaitlistStatus.status === 'notified' && (
                <button
                  onClick={handleJoinFromWaitlist}
                  disabled={loading}
                  className="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 disabled:opacity-50"
                >
                  Join Game
                </button>
              )}
              <button
                onClick={handleLeaveWaitlist}
                disabled={loading}
                className="px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 disabled:opacity-50"
              >
                Leave Waitlist
              </button>
            </div>
          </div>
          {userWaitlistStatus.status === 'notified' && (
            <p className="text-xs text-blue-700 mt-1">
              A spot is available! You have 24 hours to join.
            </p>
          )}
        </div>
      )}

      {/* Join waitlist button */}
      {isGameFull && !isUserJoined && !userWaitlistStatus.isOnWaitlist && user && (
        <div className="mb-4">
          <button
            onClick={handleJoinWaitlist}
            disabled={loading}
            className="w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? 'Joining...' : 'Join Waitlist'}
          </button>
          <p className="text-xs text-gray-600 mt-1 text-center">
            You'll be notified if a spot opens up
          </p>
        </div>
      )}

      {/* Game capacity info */}
      <div className="mb-4 p-3 bg-gray-50 rounded-md">
        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">Game Capacity:</span>
          <span className="font-medium text-gray-900">
            {currentPlayers}/{maxPlayers} players
          </span>
        </div>
        {isGameFull && (
          <div className="mt-1">
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div 
                className="bg-red-500 h-2 rounded-full" 
                style={{ width: '100%' }}
              />
            </div>
            <p className="text-xs text-red-600 mt-1">Game is full</p>
          </div>
        )}
      </div>

      {/* Waitlist entries */}
      {showWaitlist && waitlist.length > 0 && (
        <div className="space-y-2">
          <h4 className="text-sm font-medium text-gray-700 mb-2">Waitlist Queue</h4>
          {waitlist.map((entry) => (
            <div
              key={entry.id}
              className="flex items-center justify-between p-2 bg-gray-50 rounded-md"
            >
              <div className="flex items-center space-x-3">
                <span className="text-sm font-medium text-gray-900 w-6">
                  #{entry.position}
                </span>
                {entry.user.avatarUrl ? (
                  <img
                    src={entry.user.avatarUrl}
                    alt={entry.user.name}
                    className="w-6 h-6 rounded-full"
                  />
                ) : (
                  <div className="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center">
                    <span className="text-xs text-gray-600">
                      {entry.user.name.charAt(0).toUpperCase()}
                    </span>
                  </div>
                )}
                <span className="text-sm text-gray-900">{entry.user.name}</span>
              </div>
              <div className="flex items-center space-x-2">
                {entry.status === 'notified' && entry.expiresAt && (
                  <span className="text-xs text-blue-600">
                    {formatTimeRemaining(entry.expiresAt)}
                  </span>
                )}
                <div className="flex items-center space-x-1">
                  {getStatusIcon(entry.status)}
                  <span className="text-xs text-gray-600">
                    {getStatusText(entry.status)}
                  </span>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Empty waitlist message */}
      {waitlist.length === 0 && isGameFull && (
        <div className="text-center py-4">
          <Users className="w-8 h-8 text-gray-400 mx-auto mb-2" />
          <p className="text-sm text-gray-600">No one is on the waitlist yet</p>
          {!isUserJoined && user && (
            <p className="text-xs text-gray-500 mt-1">Be the first to join!</p>
          )}
        </div>
      )}
    </div>
  );
};

```

`domains/locations/components/EnhancedMapView.tsx`:

```tsx
import React, { useEffect, useRef, useState, useCallback } from 'react';
import { loadGoogleMapsApi } from '@/domains/locations/services/googleMapsLoader';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { 
  MapPin, 
  Navigation, 
  Crosshair, 
  Plus, 
  Minus,
  RotateCcw,
  Users,
  Clock,
  DollarSign,
  Star,
  Cloud,
  Sun,
  CloudRain,
  Filter,
  Settings
} from 'lucide-react';
import { useLocation, LocationCoordinates, calculateDistance, formatDistance } from '@/domains/locations/hooks/useLocation';
import { VenueService, Venue, VenueRecommendation, VenueFilter } from '@/domains/locations/services/venueService';
import { WeatherService, WeatherData } from '@/domains/locations/services/weatherService';
import { LocationNotificationService } from '@/domains/locations/services/locationNotificationService';
import { toast } from 'sonner';

export interface MapGame {
  id: string;
  title: string;
  sport: string;
  location: LocationCoordinates;
  locationName: string;
  date: string;
  time: string;
  players: number;
  maxPlayers: number;
  cost: string;
  difficulty: string;
  venue_type?: 'indoor' | 'outdoor' | 'mixed';
}

interface EnhancedMapViewProps {
  games?: MapGame[];
  selectedGameId?: string;
  onGameSelect?: (gameId: string) => void;
  onLocationSelect?: (location: LocationCoordinates) => void;
  onVenueSelect?: (venue: Venue) => void;
  showCurrentLocation?: boolean;
  showGameMarkers?: boolean;
  showVenueMarkers?: boolean;
  allowLocationSelection?: boolean;
  center?: LocationCoordinates;
  zoom?: number;
  className?: string;
  sport?: string;
  gameDateTime?: Date;
}

interface MapFilters {
  venueType: 'all' | 'indoor' | 'outdoor' | 'mixed';
  weatherOptimized: boolean;
  minRating: number;
  maxDistance: number;
  showRecommendations: boolean;
}

function EnhancedMapView({
  games = [],
  selectedGameId,
  onGameSelect,
  onLocationSelect,
  onVenueSelect,
  showCurrentLocation = true,
  showGameMarkers = true,
  showVenueMarkers = true,
  allowLocationSelection = false,
  center,
  zoom = 13,
  className = '',
  sport,
  gameDateTime
}: EnhancedMapViewProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const googleMapRef = useRef<google.maps.Map | null>(null);
  const gameMarkersRef = useRef<google.maps.Marker[]>([]);
  const venueMarkersRef = useRef<google.maps.Marker[]>([]);
  const infoWindowRef = useRef<google.maps.InfoWindow | null>(null);
  const currentLocationMarkerRef = useRef<google.maps.Marker | null>(null);
  
  const [isMapLoaded, setIsMapLoaded] = useState(false);
  const [mapError, setMapError] = useState<string | null>(null);
  const [venues, setVenues] = useState<Venue[]>([]);
  const [venueRecommendations, setVenueRecommendations] = useState<VenueRecommendation[]>([]);
  const [weather, setWeather] = useState<WeatherData | null>(null);
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState<MapFilters>({
    venueType: 'all',
    weatherOptimized: true,
    minRating: 0,
    maxDistance: 25,
    showRecommendations: true
  });
  
  const {
    currentLocation,
    isLoading: locationLoading,
    error: locationError,
    requestLocation
  } = useLocation();

  const mapCenter = center || currentLocation || { latitude: 29.6516, longitude: -82.3248 };

  // Initialize Google Maps
  useEffect(() => {
    const initMap = async () => {
      try {
        console.log('Initializing Enhanced Google Maps...');
        const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY || '';
        
        if (!apiKey) {
          throw new Error('Google Maps API key not found. Please set VITE_GOOGLE_MAPS_API_KEY in your environment variables.');
        }
        
        await loadGoogleMapsApi(apiKey);
        
        if (!mapRef.current) {
          console.error('Map container ref not available');
          return;
        }

        const map = new google.maps.Map(mapRef.current, {
          center: { lat: mapCenter.latitude, lng: mapCenter.longitude },
          zoom: zoom,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true,
          zoomControl: false,
          styles: [
            {
              featureType: 'poi.sports_complex',
              elementType: 'labels',
              stylers: [{ visibility: 'on' }]
            },
            {
              featureType: 'poi.park',
              elementType: 'labels',
              stylers: [{ visibility: 'on' }]
            }
          ]
        });

        googleMapRef.current = map;
        setIsMapLoaded(true);
        console.log('Enhanced Google Map initialized successfully');

        // Add click listener for location selection
        if (allowLocationSelection) {
          map.addListener('click', (event: google.maps.MapMouseEvent) => {
            if (event.latLng && onLocationSelect) {
              const location = {
                latitude: event.latLng.lat(),
                longitude: event.latLng.lng()
              };
              onLocationSelect(location);
            }
          });
        }

      } catch (error) {
        console.error('Error loading Enhanced Google Maps:', error);
        setMapError(`Failed to load Google Maps: ${error instanceof Error ? error.message : 'Unknown error'}`);
      }
    };

    initMap();
  }, [mapCenter.latitude, mapCenter.longitude, zoom, allowLocationSelection, onLocationSelect]);

  // Load venues and recommendations when location changes
  useEffect(() => {
    if (currentLocation && showVenueMarkers) {
      loadVenuesAndRecommendations();
    }
  }, [currentLocation, sport, gameDateTime, filters, showVenueMarkers]);

  // Load weather data
  useEffect(() => {
    if (currentLocation && gameDateTime) {
      loadWeatherData();
    }
  }, [currentLocation, gameDateTime]);

  const loadVenuesAndRecommendations = async () => {
    if (!currentLocation) return;

    try {
      // Load nearby venues
      const nearbyVenues = await VenueService.getVenuesNearLocation(
        currentLocation,
        filters.maxDistance
      );

      // Apply filters
      let filteredVenues = nearbyVenues;
      
      if (filters.venueType !== 'all') {
        filteredVenues = filteredVenues.filter(v => v.venue_type === filters.venueType);
      }
      
      if (filters.minRating > 0) {
        filteredVenues = filteredVenues.filter(v => v.average_rating >= filters.minRating);
      }

      setVenues(filteredVenues);

      // Load sport-specific recommendations if sport is provided
      if (sport && gameDateTime && filters.showRecommendations) {
        const recommendations = await VenueService.getVenueRecommendations(
          currentLocation,
          sport,
          gameDateTime,
          {
            venue_type: filters.venueType !== 'all' ? filters.venueType : undefined,
            max_distance_km: filters.maxDistance,
            min_rating: filters.minRating
          }
        );
        setVenueRecommendations(recommendations);
      }
    } catch (error) {
      console.error('Error loading venues:', error);
      toast.error('Failed to load venue data');
    }
  };

  const loadWeatherData = async () => {
    if (!currentLocation || !gameDateTime) return;

    try {
      const weatherData = await WeatherService.getGameWeather(
        currentLocation.latitude,
        currentLocation.longitude,
        gameDateTime
      );
      setWeather(weatherData);
    } catch (error) {
      console.error('Error loading weather:', error);
    }
  };

  // Update current location marker
  useEffect(() => {
    if (!googleMapRef.current || !showCurrentLocation || !currentLocation) return;

    if (currentLocationMarkerRef.current) {
      currentLocationMarkerRef.current.setMap(null);
    }

    const marker = new google.maps.Marker({
      position: { lat: currentLocation.latitude, lng: currentLocation.longitude },
      map: googleMapRef.current,
      title: 'Your Location',
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#4285F4',
        fillOpacity: 1,
        strokeColor: '#ffffff',
        strokeWeight: 2
      }
    });

    currentLocationMarkerRef.current = marker;
  }, [currentLocation, showCurrentLocation]);

  // Update game markers
  useEffect(() => {
    if (!googleMapRef.current || !showGameMarkers) return;

    gameMarkersRef.current.forEach(marker => marker.setMap(null));
    gameMarkersRef.current = [];

    if (!infoWindowRef.current) {
      infoWindowRef.current = new google.maps.InfoWindow();
    }

    games.forEach(game => {
      const marker = new google.maps.Marker({
        position: { lat: game.location.latitude, lng: game.location.longitude },
        map: googleMapRef.current,
        title: game.title,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: getSportColor(game.sport),
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 2
        }
      });

      marker.addListener('click', () => {
        if (onGameSelect) {
          onGameSelect(game.id);
        }
        showGameInfoWindow(game, marker);
      });

      gameMarkersRef.current.push(marker);
    });
  }, [games, showGameMarkers, currentLocation, onGameSelect]);

  // Update venue markers
  useEffect(() => {
    if (!googleMapRef.current || !showVenueMarkers) return;

    venueMarkersRef.current.forEach(marker => marker.setMap(null));
    venueMarkersRef.current = [];

    const venuesToShow = filters.showRecommendations && venueRecommendations.length > 0 
      ? venueRecommendations.map(r => r.venue)
      : venues;

    venuesToShow.forEach((venue, index) => {
      const isRecommended = filters.showRecommendations && 
        venueRecommendations.some(r => r.venue.id === venue.id);
      
      const marker = new google.maps.Marker({
        position: { lat: venue.latitude, lng: venue.longitude },
        map: googleMapRef.current,
        title: venue.name,
        icon: {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
          scale: isRecommended ? 8 : 6,
          fillColor: getVenueColor(venue.venue_type, isRecommended),
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 1,
          rotation: 0
        }
      });

      marker.addListener('click', () => {
        if (onVenueSelect) {
          onVenueSelect(venue);
        }
        showVenueInfoWindow(venue, marker, isRecommended);
      });

      venueMarkersRef.current.push(marker);
    });
  }, [venues, venueRecommendations, filters, showVenueMarkers, onVenueSelect]);

  const showGameInfoWindow = (game: MapGame, marker: google.maps.Marker) => {
    const distance = currentLocation ? calculateDistance(
      currentLocation.latitude,
      currentLocation.longitude,
      game.location.latitude,
      game.location.longitude
    ) : null;

    const weatherIcon = weather ? getWeatherIcon(weather.condition) : '';
    const weatherSuitability = weather && game.venue_type === 'outdoor' 
      ? (weather.isOutdoorFriendly ? '‚úÖ Good weather' : '‚ö†Ô∏è Check weather')
      : '';

    const content = `
      <div class="p-3 max-w-xs">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-medium text-sm">${game.title}</h4>
          <span class="text-xs bg-gray-100 px-2 py-1 rounded">${game.sport}</span>
        </div>
        <div class="space-y-1 text-xs text-gray-600">
          <div class="flex items-center gap-1">
            <span>üïí</span>
            <span>${game.time}</span>
          </div>
          <div class="flex items-center gap-1">
            <span>üë•</span>
            <span>{game.players}/{game.maxPlayers} players</span>
          </div>
          ${game.cost !== 'Free' ? `
            <div class="flex items-center gap-1">
              <span>üí∞</span>
              <span>${game.cost}</span>
            </div>
          ` : ''}
          <div class="flex items-center gap-1">
            <span>üìç</span>
            <span>${game.locationName}</span>
          </div>
          ${distance ? `
            <div class="flex items-center gap-1">
              <span>üìè</span>
              <span>${formatDistance(distance)} away</span>
            </div>
          ` : ''}
          ${weatherSuitability ? `
            <div class="flex items-center gap-1">
              <span>${weatherIcon}</span>
              <span>${weatherSuitability}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;

    infoWindowRef.current?.setContent(content);
    infoWindowRef.current?.open(googleMapRef.current, marker);
  };

  const showVenueInfoWindow = (venue: Venue, marker: google.maps.Marker, isRecommended: boolean) => {
    const distance = currentLocation ? calculateDistance(
      currentLocation.latitude,
      currentLocation.longitude,
      venue.latitude,
      venue.longitude
    ) : null;

    const recommendation = venueRecommendations.find(r => r.venue.id === venue.id);
    const stars = '‚≠ê'.repeat(Math.floor(venue.average_rating));

    const content = `
      <div class="p-3 max-w-sm">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-medium text-sm">${venue.name}</h4>
          ${isRecommended ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Recommended</span>' : ''}
        </div>
        <div class="space-y-1 text-xs text-gray-600">
          <div class="flex items-center gap-1">
            <span>üèüÔ∏è</span>
            <span class="capitalize">${venue.venue_type} venue</span>
          </div>
          <div class="flex items-center gap-1">
            <span>${stars}</span>
            <span>${venue.average_rating.toFixed(1)} (${venue.total_ratings} reviews)</span>
          </div>
          <div class="flex items-center gap-1">
            <span>üèÉ</span>
            <span>${venue.supported_sports.slice(0, 3).join(', ')}</span>
          </div>
          ${distance ? `
            <div class="flex items-center gap-1">
              <span>üìè</span>
              <span>${formatDistance(distance)} away</span>
            </div>
          ` : ''}
          ${recommendation ? `
            <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
              <div class="font-medium text-blue-800">Why recommended:</div>
              <div class="text-blue-600">${recommendation.reasons.slice(0, 2).join(', ')}</div>
            </div>
          ` : ''}
        </div>
      </div>
    `;

    infoWindowRef.current?.setContent(content);
    infoWindowRef.current?.open(googleMapRef.current, marker);
  };

  const getSportColor = (sport: string): string => {
    const colors = {
      'Basketball': '#FF6B35',
      'Soccer': '#4CAF50', 
      'Tennis': '#FFC107',
      'Volleyball': '#2196F3',
      'Football': '#9C27B0',
      'Baseball': '#FF5722',
      'Pickleball': '#E91E63',
      'Golf': '#4CAF50',
      'Hockey': '#607D8B',
      'Rugby': '#795548'
    };
    return colors[sport as keyof typeof colors] || '#6B7280';
  };

  const getVenueColor = (venueType: string, isRecommended: boolean): string => {
    const baseColors = {
      'indoor': '#3B82F6',
      'outdoor': '#10B981',
      'mixed': '#8B5CF6'
    };
    
    const color = baseColors[venueType as keyof typeof baseColors] || '#6B7280';
    return isRecommended ? '#F59E0B' : color; // Gold for recommended venues
  };

  const getWeatherIcon = (condition: string): string => {
    const iconMap: Record<string, string> = {
      'Clear': '‚òÄÔ∏è',
      'Clouds': '‚òÅÔ∏è',
      'Rain': 'üåßÔ∏è',
      'Drizzle': 'üå¶Ô∏è',
      'Thunderstorm': '‚õàÔ∏è',
      'Snow': '‚ùÑÔ∏è',
      'Mist': 'üå´Ô∏è',
      'Fog': 'üå´Ô∏è',
      'Haze': 'üå´Ô∏è'
    };
    return iconMap[condition] || 'üå§Ô∏è';
  };

  const centerOnCurrentLocation = useCallback(() => {
    if (currentLocation && googleMapRef.current) {
      googleMapRef.current.setCenter({ lat: currentLocation.latitude, lng: currentLocation.longitude });
      googleMapRef.current.setZoom(15);
      toast.success('Centered on your location');
    } else {
      requestLocation();
    }
  }, [currentLocation, requestLocation]);

  const zoomIn = useCallback(() => {
    if (googleMapRef.current) {
      const currentZoom = googleMapRef.current.getZoom() || 13;
      googleMapRef.current.setZoom(Math.min(currentZoom + 1, 20));
    }
  }, []);

  const zoomOut = useCallback(() => {
    if (googleMapRef.current) {
      const currentZoom = googleMapRef.current.getZoom() || 13;
      googleMapRef.current.setZoom(Math.max(currentZoom - 1, 1));
    }
  }, []);

  const resetView = useCallback(() => {
    if (googleMapRef.current) {
      const center = currentLocation || { latitude: 29.6516, longitude: -82.3248 };
      googleMapRef.current.setCenter({ lat: center.latitude, lng: center.longitude });
      googleMapRef.current.setZoom(13);
    }
  }, [currentLocation]);

  const handleFilterChange = (newFilters: Partial<MapFilters>) => {
    setFilters(prev => ({ ...prev, ...newFilters }));
  };

  if (mapError) {
    return (
      <div className={`relative ${className}`}>
        <div className="flex items-center justify-center h-64 bg-muted rounded-lg">
          <div className="text-center">
            <MapPin className="w-16 h-16 mx-auto mb-4 text-muted-foreground" />
            <h3 className="text-lg font-medium mb-2">Map Unavailable</h3>
            <p className="text-sm text-muted-foreground">{mapError}</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={`relative overflow-hidden rounded-lg ${className}`}>
      {/* Map Container */}
      <div
        ref={mapRef}
        className="relative w-full h-full min-h-[300px] md:min-h-[400px]"
        role="application"
        aria-label="Enhanced Interactive Google Map showing games, venues, and recommendations"
      />

      {/* Loading State */}
      {(!isMapLoaded || locationLoading) && (
        <div className="absolute inset-0 flex items-center justify-center bg-muted/50 backdrop-blur-sm z-10">
          <LoadingSpinner size="lg" text="Loading enhanced map..." />
        </div>
      )}

      {/* Weather Info */}
      {weather && (
        <div className="absolute top-2 left-2 md:top-4 md:left-4 z-30">
          <Card className="bg-background/95 backdrop-blur-sm">
            <CardContent className="p-2">
              <div className="flex items-center gap-2 text-xs">
                <span className="text-lg">{getWeatherIcon(weather.condition)}</span>
                <div>
                  <div className="font-medium">{weather.temperature}¬∞F</div>
                  <div className="text-muted-foreground">{weather.condition}</div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Map Controls */}
      <div className="absolute top-2 right-2 md:top-4 md:right-4 flex flex-col gap-1 md:gap-2 z-30">
        {/* Filter Toggle */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={() => setShowFilters(!showFilters)}
          aria-label="Toggle filters"
        >
          <Filter className="w-3 h-3 md:w-4 md:h-4" />
        </Button>

        {/* Zoom Controls */}
        <div className="flex flex-col gap-1">
          <Button
            variant="outline"
            size="icon"
            className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
            onClick={zoomIn}
            aria-label="Zoom in"
          >
            <Plus className="w-3 h-3 md:w-4 md:h-4" />
          </Button>
          <Button
            variant="outline"
            size="icon"
            className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
            onClick={zoomOut}
            aria-label="Zoom out"
          >
            <Minus className="w-3 h-3 md:w-4 md:h-4" />
          </Button>
        </div>

        {/* Current Location */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={centerOnCurrentLocation}
          disabled={locationLoading}
          aria-label="Center on current location"
        >
          {locationLoading ? (
            <LoadingSpinner size="sm" />
          ) : (
            <Crosshair className="w-3 h-3 md:w-4 md:h-4" />
          )}
        </Button>

        {/* Reset View */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={resetView}
          aria-label="Reset map view"
        >
          <RotateCcw className="w-3 h-3 md:w-4 md:h-4" />
        </Button>
      </div>

      {/* Filters Panel */}
      {showFilters && (
        <div className="absolute top-16 right-2 md:top-20 md:right-4 z-30">
          <Card className="bg-background/95 backdrop-blur-sm w-64">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">Map Filters</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div>
                <label className="text-xs font-medium">Venue Type</label>
                <select
                  value={filters.venueType}
                  onChange={(e) => handleFilterChange({ venueType: e.target.value as any })}
                  className="w-full mt-1 text-xs border rounded px-2 py-1"
                >
                  <option value="all">All Venues</option>
                  <option value="indoor">Indoor Only</option>
                  <option value="outdoor">Outdoor Only</option>
                  <option value="mixed">Mixed Venues</option>
                </select>
              </div>
              
              <div>
                <label className="text-xs font-medium">Min Rating</label>
                <select
                  value={filters.minRating}
                  onChange={(e) => handleFilterChange({ minRating: Number(e.target.value) })}
                  className="w-full mt-1 text-xs border rounded px-2 py-1"
                >
                  <option value={0}>Any Rating</option>
                  <option value={3}>3+ Stars</option>
                  <option value={4}>4+ Stars</option>
                  <option value={4.5}>4.5+ Stars</option>
                </select>
              </div>

              <div>
                <label className="text-xs font-medium">Max Distance: {filters.maxDistance}km</label>
                <input
                  type="range"
                  min="5"
                  max="50"
                  value={filters.maxDistance}
                  onChange={(e) => handleFilterChange({ maxDistance: Number(e.target.value) })}
                  className="w-full mt-1"
                />
              </div>

              <div className="flex items-center gap-2">
                <input
                  type="checkbox"
                  id="weatherOptimized"
                  checked={filters.weatherOptimized}
                  onChange={(e) => handleFilterChange({ weatherOptimized: e.target.checked })}
                />
                <label htmlFor="weatherOptimized" className="text-xs">Weather Optimized</label>
              </div>

              <div className="flex items-center gap-2">
                <input
                  type="checkbox"
                  id="showRecommendations"
                  checked={filters.showRecommendations}
                  onChange={(e) => handleFilterChange({ showRecommendations: e.target.checked })}
                />
                <label htmlFor="showRecommendations" className="text-xs">Show Recommendations</label>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Stats Badges */}
      <div className="absolute bottom-2 left-2 md:bottom-4 md:left-4 flex gap-2 z-30">
        {showGameMarkers && games.length > 0 && (
          <Badge variant="secondary" className="bg-background/95 backdrop-blur-sm text-xs">
            üéÆ {games.length} game{games.length !== 1 ? 's' : ''}
          </Badge>
        )}
        {showVenueMarkers && venues.length > 0 && (
          <Badge variant="secondary" className="bg-background/95 backdrop-blur-sm text-xs">
            üèüÔ∏è {venues.length} venue{venues.length !== 1 ? 's' : ''}
          </Badge>
        )}
        {venueRecommendations.length > 0 && filters.showRecommendations && (
          <Badge variant="secondary" className="bg-yellow-100 text-yellow-800 text-xs">
            ‚≠ê {venueRecommendations.length} recommended
          </Badge>
        )}
      </div>
    </div>
  );
}

export default EnhancedMapView;

```

`domains/locations/components/GoogleMapView.tsx`:

```tsx
import React, { useEffect, useRef, useState, useCallback } from 'react';
import { loadGoogleMapsApi } from '@/domains/locations/services/googleMapsLoader';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { 
  MapPin, 
  Navigation, 
  Crosshair, 
  Plus, 
  Minus,
  RotateCcw,
  Users,
  Clock,
  DollarSign
} from 'lucide-react';
import { useLocation, LocationCoordinates, calculateDistance, formatDistance } from '@/domains/locations/hooks/useLocation';
import { toast } from 'sonner';

export interface MapGame {
  id: string;
  title: string;
  sport: string;
  location: LocationCoordinates;
  locationName: string;
  date: string;
  time: string;
  players: number;
  maxPlayers: number;
  cost: string;
  difficulty: string;
}

interface GoogleMapViewProps {
  games?: MapGame[];
  selectedGameId?: string;
  onGameSelect?: (gameId: string) => void;
  onLocationSelect?: (location: LocationCoordinates) => void;
  showCurrentLocation?: boolean;
  showGameMarkers?: boolean;
  allowLocationSelection?: boolean;
  center?: LocationCoordinates;
  zoom?: number;
  className?: string;
}

function GoogleMapView({
  games = [],
  selectedGameId,
  onGameSelect,
  onLocationSelect,
  showCurrentLocation = true,
  showGameMarkers = true,
  allowLocationSelection = false,
  center,
  zoom = 13,
  className = ''
}: GoogleMapViewProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const googleMapRef = useRef<google.maps.Map | null>(null);
  const markersRef = useRef<google.maps.Marker[]>([]);
  const infoWindowRef = useRef<google.maps.InfoWindow | null>(null);
  const currentLocationMarkerRef = useRef<google.maps.Marker | null>(null);
  
  const [isMapLoaded, setIsMapLoaded] = useState(false);
  const [mapError, setMapError] = useState<string | null>(null);
  
  const {
    currentLocation,
    isLoading: locationLoading,
    error: locationError,
    requestLocation
  } = useLocation();

  const mapCenter = center || currentLocation || { latitude: 29.6516, longitude: -82.3248 };

  // Initialize Google Maps
  useEffect(() => {
    const initMap = async () => {
      try {
        console.log('Initializing Google Maps...');
        const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY || '';
        console.log('Using API key:', apiKey ? 'API key present' : 'No API key found');
        
        if (!apiKey) {
          throw new Error('Google Maps API key not found. Please set VITE_GOOGLE_MAPS_API_KEY in your environment variables.');
        }
        
        await loadGoogleMapsApi(apiKey);
        console.log('Google Maps API loaded successfully');
        
        if (!mapRef.current) {
          console.error('Map container ref not available');
          return;
        }

        console.log('Creating Google Map instance...');
        const map = new google.maps.Map(mapRef.current, {
          center: { lat: mapCenter.latitude, lng: mapCenter.longitude },
          zoom: zoom,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true,
          zoomControl: false, // We'll use custom controls
          styles: [
            {
              featureType: 'poi',
              elementType: 'labels',
              stylers: [{ visibility: 'on' }]
            }
          ]
        });

        googleMapRef.current = map;
        setIsMapLoaded(true);
        console.log('Google Map initialized successfully');

        // Add click listener for location selection
        if (allowLocationSelection) {
          map.addListener('click', (event: google.maps.MapMouseEvent) => {
            if (event.latLng && onLocationSelect) {
              const location = {
                latitude: event.latLng.lat(),
                longitude: event.latLng.lng()
              };
              onLocationSelect(location);
            }
          });
        }

      } catch (error) {
        console.error('Error loading Google Maps:', error);
        setMapError(`Failed to load Google Maps: ${error instanceof Error ? error.message : 'Unknown error'}`);
      }
    };

    initMap();
  }, [mapCenter.latitude, mapCenter.longitude, zoom, allowLocationSelection, onLocationSelect]);

  // Update current location marker
  useEffect(() => {
    if (!googleMapRef.current || !showCurrentLocation || !currentLocation) return;

    // Remove existing current location marker
    if (currentLocationMarkerRef.current) {
      currentLocationMarkerRef.current.setMap(null);
    }

    // Add new current location marker
    const marker = new google.maps.Marker({
      position: { lat: currentLocation.latitude, lng: currentLocation.longitude },
      map: googleMapRef.current,
      title: 'Your Location',
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#4285F4',
        fillOpacity: 1,
        strokeColor: '#ffffff',
        strokeWeight: 2
      }
    });

    currentLocationMarkerRef.current = marker;
  }, [currentLocation, showCurrentLocation]);

  // Update game markers
  useEffect(() => {
    if (!googleMapRef.current || !showGameMarkers) return;

    // Clear existing markers
    markersRef.current.forEach(marker => marker.setMap(null));
    markersRef.current = [];

    // Create info window
    if (!infoWindowRef.current) {
      infoWindowRef.current = new google.maps.InfoWindow();
    }

    // Add game markers
    games.forEach(game => {
      const marker = new google.maps.Marker({
        position: { lat: game.location.latitude, lng: game.location.longitude },
        map: googleMapRef.current,
        title: game.title,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: getSportColor(game.sport),
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 2
        }
      });

      // Add click listener
      marker.addListener('click', () => {
        if (onGameSelect) {
          onGameSelect(game.id);
        }

        // Show info window
        const distance = currentLocation ? calculateDistance(
          currentLocation.latitude,
          currentLocation.longitude,
          game.location.latitude,
          game.location.longitude
        ) : null;

        const content = `
          <div class="p-3 max-w-xs">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-medium text-sm">${game.title}</h4>
              <span class="text-xs bg-gray-100 px-2 py-1 rounded">${game.sport}</span>
            </div>
            <div class="space-y-1 text-xs text-gray-600">
              <div class="flex items-center gap-1">
                <span>üïí</span>
                <span>${game.time}</span>
              </div>
              <div class="flex items-center gap-1">
                <span>üë•</span>
                <span>{game.players}/{game.maxPlayers} players</span>
              </div>
              ${game.cost !== 'Free' ? `
                <div class="flex items-center gap-1">
                  <span>üí∞</span>
                  <span>${game.cost}</span>
                </div>
              ` : ''}
              <div class="flex items-center gap-1">
                <span>üìç</span>
                <span>${game.locationName}</span>
              </div>
              ${distance ? `
                <div class="flex items-center gap-1">
                  <span>üìè</span>
                  <span>${formatDistance(distance)} away</span>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        infoWindowRef.current?.setContent(content);
        infoWindowRef.current?.open(googleMapRef.current, marker);
      });

      markersRef.current.push(marker);
    });
  }, [games, showGameMarkers, currentLocation, onGameSelect]);

  const getSportColor = (sport: string): string => {
    const colors = {
      'Basketball': '#FF6B35',
      'Soccer': '#4CAF50', 
      'Tennis': '#FFC107',
      'Volleyball': '#2196F3',
      'Football': '#9C27B0',
      'Baseball': '#FF5722',
      'Pickleball': '#E91E63',
      'Golf': '#4CAF50',
      'Hockey': '#607D8B',
      'Rugby': '#795548'
    };
    return colors[sport as keyof typeof colors] || '#6B7280';
  };

  const centerOnCurrentLocation = useCallback(() => {
    if (currentLocation && googleMapRef.current) {
      googleMapRef.current.setCenter({ lat: currentLocation.latitude, lng: currentLocation.longitude });
      googleMapRef.current.setZoom(15);
      toast.success('Centered on your location');
    } else {
      requestLocation();
    }
  }, [currentLocation, requestLocation]);

  const zoomIn = useCallback(() => {
    if (googleMapRef.current) {
      const currentZoom = googleMapRef.current.getZoom() || 13;
      googleMapRef.current.setZoom(Math.min(currentZoom + 1, 20));
    }
  }, []);

  const zoomOut = useCallback(() => {
    if (googleMapRef.current) {
      const currentZoom = googleMapRef.current.getZoom() || 13;
      googleMapRef.current.setZoom(Math.max(currentZoom - 1, 1));
    }
  }, []);

  const resetView = useCallback(() => {
    if (googleMapRef.current) {
      const center = currentLocation || { latitude: 29.6516, longitude: -82.3248 };
      googleMapRef.current.setCenter({ lat: center.latitude, lng: center.longitude });
      googleMapRef.current.setZoom(13);
    }
  }, [currentLocation]);

  if (mapError) {
    return (
      <div className={`relative ${className}`}>
        <div className="flex items-center justify-center h-64 bg-muted rounded-lg">
          <div className="text-center">
            <MapPin className="w-16 h-16 mx-auto mb-4 text-muted-foreground" />
            <h3 className="text-lg font-medium mb-2">Map Unavailable</h3>
            <p className="text-sm text-muted-foreground">{mapError}</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={`relative overflow-hidden rounded-lg ${className}`}>
      {/* Map Container */}
      <div
        ref={mapRef}
        className="relative w-full h-full min-h-[300px] md:min-h-[400px]"
        role="application"
        aria-label="Interactive Google Map showing games and locations"
      />

      {/* Loading State */}
      {(!isMapLoaded || locationLoading) && (
        <div className="absolute inset-0 flex items-center justify-center bg-muted/50 backdrop-blur-sm z-10">
          <LoadingSpinner size="lg" text="Loading map..." />
        </div>
      )}

      {/* Map Controls */}
      <div className="absolute top-2 right-2 md:top-4 md:right-4 flex flex-col gap-1 md:gap-2 z-30">
        {/* Zoom Controls */}
        <div className="flex flex-col gap-1">
          <Button
            variant="outline"
            size="icon"
            className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
            onClick={zoomIn}
            aria-label="Zoom in"
          >
            <Plus className="w-3 h-3 md:w-4 md:h-4" />
          </Button>
          <Button
            variant="outline"
            size="icon"
            className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
            onClick={zoomOut}
            aria-label="Zoom out"
          >
            <Minus className="w-3 h-3 md:w-4 md:h-4" />
          </Button>
        </div>

        {/* Current Location */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={centerOnCurrentLocation}
          disabled={locationLoading}
          aria-label="Center on current location"
        >
          {locationLoading ? (
            <LoadingSpinner size="sm" />
          ) : (
            <Crosshair className="w-3 h-3 md:w-4 md:h-4" />
          )}
        </Button>

        {/* Reset View */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={resetView}
          aria-label="Reset map view"
        >
          <RotateCcw className="w-3 h-3 md:w-4 md:h-4" />
        </Button>
      </div>

      {/* Game Count Badge */}
      {showGameMarkers && games.length > 0 && (
        <div className="absolute top-2 left-2 md:top-4 md:left-4 z-30">
          <Badge variant="secondary" className="bg-background/95 backdrop-blur-sm text-xs">
            {games.length} game{games.length !== 1 ? 's' : ''}
          </Badge>
        </div>
      )}
    </div>
  );
}

export default GoogleMapView;

```

`domains/locations/components/InteractiveRoutePlanner.tsx`:

```tsx
import React, { useEffect, useRef, useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { toast } from 'sonner';
import { X, Navigation, Mountain, Clock, Route, TrendingUp } from 'lucide-react';
import { computeRoute, decodePolyline } from '@/domains/locations/services/routesApi';
import { loadGoogleMapsApi } from '@/domains/locations/services/googleMapsLoader';

interface Waypoint {
  lat: number;
  lng: number;
  address?: string;
  marker?: google.maps.Marker;
  elevation?: number;
}

interface RouteAnalysis {
  distance: string;
  duration: string;
  elevationGain: number;
  elevationLoss: number;
  difficulty: 'Easy' | 'Moderate' | 'Hard' | 'Expert';
  maxElevation: number;
  minElevation: number;
  avgGradient: number;
}

interface InteractiveRoutePlannerProps {
  centerLat: number;
  centerLng: number;
  onRouteSave: (route: {
    path: Array<{ lat: number; lng: number }>;
    distance: string;
    name: string;
    polyline?: string;
    analysis?: RouteAnalysis;
  }) => void;
  sport: string;
}

export function InteractiveRoutePlanner({ centerLat, centerLng, onRouteSave, sport }: InteractiveRoutePlannerProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<google.maps.Map | null>(null);
  const elevationServiceRef = useRef<google.maps.ElevationService | null>(null);
  const [waypoints, setWaypoints] = useState<Waypoint[]>([]);
  const directionsServiceRef = useRef<google.maps.DirectionsService | null>(null);
  const directionsRendererRef = useRef<google.maps.DirectionsRenderer | null>(null);
  const [mapLoaded, setMapLoaded] = useState(false);
  const [routeAnalysis, setRouteAnalysis] = useState<RouteAnalysis | null>(null);
  const [elevationProfile, setElevationProfile] = useState<number[]>([]);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const polylineRef = useRef<google.maps.Polyline | null>(null);

  // Sport-specific travel mode mapping
  const getTravelMode = (sportType: string): google.maps.TravelMode => {
    switch (sportType.toLowerCase()) {
      case 'cycling':
      case 'bike':
        return google.maps.TravelMode.BICYCLING;
      case 'running':
      case 'hiking':
      case 'walking':
        return google.maps.TravelMode.WALKING;
      default:
        return google.maps.TravelMode.WALKING;
    }
  };

  // Calculate difficulty based on distance, elevation gain, and sport
  const calculateDifficulty = (distanceKm: number, elevationGain: number, sportType: string): 'Easy' | 'Moderate' | 'Hard' | 'Expert' => {
    const sportLower = sportType.toLowerCase();
    
    if (sportLower === 'cycling') {
      if (distanceKm < 10 && elevationGain < 100) return 'Easy';
      if (distanceKm < 25 && elevationGain < 300) return 'Moderate';
      if (distanceKm < 50 && elevationGain < 800) return 'Hard';
      return 'Expert';
    } else {
      // Running/hiking
      if (distanceKm < 3 && elevationGain < 50) return 'Easy';
      if (distanceKm < 8 && elevationGain < 200) return 'Moderate';
      if (distanceKm < 15 && elevationGain < 500) return 'Hard';
      return 'Expert';
    }
  };

  // Estimate duration based on sport and terrain
  const estimateDuration = (distanceKm: number, elevationGain: number, sportType: string): string => {
    const sportLower = sportType.toLowerCase();
    let baseSpeed: number; // km/h
    
    if (sportLower === 'cycling') {
      baseSpeed = 20; // Base cycling speed (12.4 mph)
      const elevationPenalty = elevationGain * 0.01; // 1% slower per 100m elevation
      baseSpeed *= (1 - elevationPenalty);
    } else if (sportLower === 'running') {
      baseSpeed = 9.66; // Base running speed (6 mph)
      const elevationPenalty = elevationGain * 0.02; // 2% slower per 100m elevation
      baseSpeed *= (1 - elevationPenalty);
    } else {
      // Walking/hiking
      baseSpeed = 4.83; // Base walking speed (3 mph)
      const elevationPenalty = elevationGain * 0.025; // 2.5% slower per 100m elevation for hiking
      baseSpeed *= (1 - elevationPenalty);
    }
    
    const hours = distanceKm / Math.max(baseSpeed, 3); // Minimum 3 km/h
    const minutes = Math.round(hours * 60);
    
    if (minutes < 60) {
      return `${minutes} min`;
    } else {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return m > 0 ? `${h}h ${m}m` : `${h}h`;
    }
  };

  const getSportColor = (sportType: string): string => {
    const colors = {
      'cycling': '#3b82f6',
      'running': '#ef4444', 
      'hiking': '#10b981',
      'walking': '#6b7280'
    };
    return colors[sportType.toLowerCase() as keyof typeof colors] || '#6b7280';
  };

  const calculateElevationGain = (elevations: number[]): number => {
    let gain = 0;
    for (let i = 1; i < elevations.length; i++) {
      const diff = elevations[i] - elevations[i - 1];
      if (diff > 0) gain += diff;
    }
    return gain;
  };

  const calculateElevationLoss = (elevations: number[]): number => {
    let loss = 0;
    for (let i = 1; i < elevations.length; i++) {
      const diff = elevations[i - 1] - elevations[i];
      if (diff > 0) loss += diff;
    }
    return loss;
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'Easy': return 'bg-green-100 text-green-800';
      case 'Moderate': return 'bg-yellow-100 text-yellow-800';
      case 'Hard': return 'bg-orange-100 text-orange-800';
      case 'Expert': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  useEffect(() => {
    const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY;
    if (!apiKey || !mapRef.current) return;

    loadGoogleMapsApi(apiKey).then(() => {
      if (!mapRef.current) return;

      const map = new google.maps.Map(mapRef.current, {
        center: { lat: centerLat, lng: centerLng },
        zoom: 18,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
      });

      mapInstanceRef.current = map;
      directionsServiceRef.current = new google.maps.DirectionsService();
      elevationServiceRef.current = new google.maps.ElevationService();
      // Suppress default markers and info windows to avoid car icon and route info box
      directionsRendererRef.current = new google.maps.DirectionsRenderer({ 
        map, 
        suppressMarkers: true,
        suppressInfoWindows: true, // This hides the route info box with car icon
        preserveViewport: true
      });
      setMapLoaded(true);

      // Click handler to add waypoints - use refs to avoid stale closures
      let clickListener: google.maps.MapsEventListener | null = null;
      
      const setupClickHandler = () => {
        if (clickListener) {
          google.maps.event.removeListener(clickListener);
        }
        
        clickListener = map.addListener('click', async (e: google.maps.MapMouseEvent) => {
          if (!e.latLng) return;

          const lat = e.latLng.lat();
          const lng = e.latLng.lng();

          // Get elevation data first
          let elevation = 0;
          if (elevationServiceRef.current) {
            try {
              const elevationResult = await new Promise<google.maps.ElevationResult[]>((resolve, reject) => {
                elevationServiceRef.current!.getElevationForLocations({
                  locations: [{ lat, lng }]
                }, (results, status) => {
                  if (status === 'OK' && results) {
                    resolve(results);
                  } else {
                    reject(new Error(`Elevation request failed: ${status}`));
                  }
                });
              });
              elevation = elevationResult[0]?.elevation || 0;
            } catch (error) {
              console.warn('Failed to get elevation data:', error);
            }
          }

          // Geocode to get address
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ location: { lat, lng } }, (results, status) => {
            const address = status === 'OK' && results && results[0]
              ? results[0].formatted_address
              : `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            setWaypoints(prev => {
              const newIndex = prev.length;
              const newWaypoint: Waypoint = {
                lat,
                lng,
                address,
                elevation,
              };

              // Create enhanced marker with sport-specific color
              const marker = new google.maps.Marker({
                position: { lat, lng },
                map,
                draggable: true,
                label: {
                  text: String(newIndex + 1),
                  color: 'white',
                  fontWeight: 'bold',
                },
                title: `Waypoint ${newIndex + 1}\nElevation: ${Math.round(elevation)}m`,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 10,
                  fillColor: getSportColor(sport),
                  fillOpacity: 1,
                  strokeColor: 'white',
                  strokeWeight: 2,
                },
              });

              // Update waypoint position when marker is dragged
              marker.addListener('dragend', (e: google.maps.MapMouseEvent) => {
                if (!e.latLng) return;
                const newLat = e.latLng.lat();
                const newLng = e.latLng.lng();
                
                // Geocode new position
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat: newLat, lng: newLng } }, (results, status) => {
                  const newAddress = status === 'OK' && results && results[0]
                    ? results[0].formatted_address
                    : `${newLat.toFixed(4)}, ${newLng.toFixed(4)}`;

                  setWaypoints(current => {
                    const updated = current.map((wp, idx) => 
                      idx === newIndex ? { ...wp, lat: newLat, lng: newLng, address: newAddress, marker } : wp
                    );
                    // Recalculate route after drag using refs
                    setTimeout(() => {
                      if (directionsServiceRef.current && directionsRendererRef.current) {
                        calculateRouteWithServices(updated, directionsServiceRef.current, directionsRendererRef.current);
                      }
                    }, 100);
                    return updated;
                  });
                });
              });

              const updated = [...prev, { ...newWaypoint, marker }];
              
              // Calculate and analyze route
              setTimeout(() => {
                if (updated.length >= 2) {
                  analyzeRoute(updated);
                } else if (directionsServiceRef.current && directionsRendererRef.current) {
                  calculateRouteWithServices(updated, directionsServiceRef.current, directionsRendererRef.current);
                }
              }, 100);
              
              toast.success(`Waypoint ${updated.length} added (${Math.round(elevation)}m elevation)`);
              return updated;
            });
          });
        });
      };
      
      setupClickHandler();

    }).catch((error) => {
      console.error('Error loading Google Maps:', error);
      toast.error('Failed to load map');
    });
  }, []);

  // Update route when waypoints change
  useEffect(() => {
    if (waypoints.length > 0 && directionsServiceRef.current && directionsRendererRef.current) {
      calculateRouteWithServices(waypoints, directionsServiceRef.current, directionsRendererRef.current);
    }
  }, [waypoints.length]);

  // Analyze route with elevation data
  const analyzeRoute = async (points: Waypoint[]) => {
    if (points.length < 2 || !elevationServiceRef.current || !directionsServiceRef.current) return;
    
    setIsAnalyzing(true);
    
    try {
      // Calculate route using Google Directions
      const origin = { lat: centerLat, lng: centerLng };
      const waypoints_gm = points.map(p => ({
        location: { lat: p.lat, lng: p.lng },
        stopover: true
      }));

      const result = await new Promise<google.maps.DirectionsResult>((resolve, reject) => {
        directionsServiceRef.current!.route({
          origin,
          destination: origin,
          waypoints: waypoints_gm,
          optimizeWaypoints: true,
          travelMode: getTravelMode(sport),
        }, (result, status) => {
          if (status === 'OK' && result) {
            resolve(result);
          } else {
            reject(new Error(`Route calculation failed: ${status}`));
          }
        });
      });

      // Extract route path for elevation analysis
      const routePath: google.maps.LatLng[] = [];
      result.routes[0].legs.forEach(leg => {
        leg.steps.forEach(step => {
          step.path?.forEach(point => routePath.push(point));
        });
      });

      // Get elevation profile along the route
      const elevationResult = await new Promise<google.maps.ElevationResult[]>((resolve, reject) => {
        elevationServiceRef.current!.getElevationAlongPath({
          path: routePath,
          samples: 50
        }, (results, status) => {
          if (status === 'OK' && results) {
            resolve(results);
          } else {
            reject(new Error(`Elevation request failed: ${status}`));
          }
        });
      });

      const elevations = elevationResult.map(point => point.elevation);
      setElevationProfile(elevations);

      // Calculate route analysis
      const totalDistance = result.routes[0].legs.reduce((sum, leg) => sum + (leg.distance?.value || 0), 0);
      const distanceKm = totalDistance / 1000;
      const distanceMiles = totalDistance / 1609.34;
      
      const maxElevation = Math.max(...elevations);
      const minElevation = Math.min(...elevations);
      const elevationGain = calculateElevationGain(elevations);
      const elevationLoss = calculateElevationLoss(elevations);
      const avgGradient = (elevationGain / (distanceKm * 1000)) * 100;
      
      const difficulty = calculateDifficulty(distanceKm, elevationGain, sport);
      const duration = estimateDuration(distanceKm, elevationGain, sport);
      
      const analysis: RouteAnalysis = {
        distance: `${distanceMiles.toFixed(2)} mi (${distanceKm.toFixed(2)} km)`,
        duration,
        elevationGain: Math.round(elevationGain),
        elevationLoss: Math.round(elevationLoss),
        difficulty,
        maxElevation: Math.round(maxElevation),
        minElevation: Math.round(minElevation),
        avgGradient: Number(avgGradient.toFixed(1))
      };
      
      setRouteAnalysis(analysis);
      
      // Draw route on map
      if (polylineRef.current) {
        polylineRef.current.setMap(null);
      }
      
      polylineRef.current = new google.maps.Polyline({
        path: routePath,
        geodesic: true,
        strokeColor: getSportColor(sport),
        strokeOpacity: 1.0,
        strokeWeight: 4,
        map: mapInstanceRef.current,
      });
      
    } catch (error) {
      console.error('Route analysis failed:', error);
      toast.error('Failed to analyze route');
    } finally {
      setIsAnalyzing(false);
    }
  };

  const calculateRouteWithServices = async (
    points: Waypoint[], 
    service: google.maps.DirectionsService, 
    renderer: google.maps.DirectionsRenderer
  ) => {
    if (!mapInstanceRef.current || points.length === 0) return;

    const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY;
    if (!apiKey) {
      toast.error('Google Maps API key not found');
      return;
    }

    const origin = { lat: centerLat, lng: centerLng };
    const travelMode = sport.toLowerCase();

    try {
      // Use Routes API v2 for better optimization
      const waypoints = points.map(p => ({ lat: p.lat, lng: p.lng }));
      
      const routesResponse = await computeRoute(
        apiKey,
        origin,
        origin, // Loop back to start
        waypoints,
        travelMode as 'cycling' | 'running' | 'walking',
        true // optimize waypoints
      );

      if (routesResponse.routes && routesResponse.routes.length > 0) {
        const route = routesResponse.routes[0];
        const encodedPolyline = route.polyline.encodedPolyline;
        
        // Decode polyline to draw on map
        const path = decodePolyline(encodedPolyline);
        
        // Convert to Google Maps format for display
        const googlePath = path.map(p => new google.maps.LatLng(p.lat, p.lng));
        
        // Draw polyline on map
        if (!polylineRef.current) {
          polylineRef.current = new google.maps.Polyline({
            path: googlePath,
            geodesic: true,
            strokeColor: '#3b82f6',
            strokeOpacity: 1.0,
            strokeWeight: 5,
            map: mapInstanceRef.current,
          });
        } else {
          polylineRef.current.setPath(googlePath);
        }

        // Clear directions renderer since we're using custom polyline
        renderer.setDirections({ routes: [] });
      }
    } catch (error: any) {
      console.error('‚ùå Routes API error:', error);
      
      // Fallback to Directions API if Routes API fails
      console.log('‚ö†Ô∏è Falling back to Directions API...');
      const waypoints_gm = points.map(p => ({
        location: { lat: p.lat, lng: p.lng },
        stopover: true
      }));

      // Ensure we use the correct travel mode - not DRIVING
      let mode: google.maps.TravelMode;
      const sportLower = sport.toLowerCase();
      if (sportLower === 'cycling') {
        mode = google.maps.TravelMode.BICYCLING;
      } else if (sportLower === 'running' || sportLower === 'hiking' || sportLower === 'walking') {
        mode = google.maps.TravelMode.WALKING;
      } else {
        // Default to WALKING, never DRIVING
        mode = google.maps.TravelMode.WALKING;
        console.warn(`‚ö†Ô∏è Unknown sport "${sport}", defaulting to WALKING mode`);
      }

      service.route({
        origin,
        destination: origin,
        waypoints: waypoints_gm,
        optimizeWaypoints: true,
        travelMode: mode,
      }, (result, status) => {
        if (status === 'OK' && result) {
          renderer.setDirections(result);
        } else {
          console.error('‚ùå Directions request failed:', status);
          if (status === 'REQUEST_DENIED') {
            toast.error('Routes API or Directions API not enabled. Enable "Routes API" in Google Cloud Console.');
          } else {
            toast.error(`Route calculation failed: ${status}`);
          }
        }
      });
    }
  };

  const removeWaypoint = (index: number) => {
    const waypoint = waypoints[index];
    if (waypoint.marker) {
      waypoint.marker.setMap(null);
    }
    const updated = waypoints.filter((_, i) => i !== index);
    setWaypoints(updated);
    
    // Update marker labels
    updated.forEach((wp, idx) => {
      if (wp.marker && wp.marker.getLabel()) {
        wp.marker.setLabel({
          text: String(idx + 1),
          color: 'white',
          fontWeight: 'bold',
        });
      }
    });
    
    if (updated.length === 0) {
      if (directionsRendererRef.current) {
        directionsRendererRef.current.setDirections({ routes: [] });
      }
      // Clear custom polyline when no waypoints
      if (polylineRef.current) {
        polylineRef.current.setMap(null);
        polylineRef.current = null;
      }
    } else if (directionsServiceRef.current && directionsRendererRef.current) {
      calculateRouteWithServices(updated, directionsServiceRef.current, directionsRendererRef.current);
    }
  };

  const handleSave = async () => {
    if (waypoints.length === 0) {
      toast.error('Add at least one waypoint to create a route');
      return;
    }

    if (!routeAnalysis) {
      toast.error('Route analysis not complete. Please wait for analysis to finish.');
      return;
    }

    console.log('üíæ Saving enhanced route with analysis:', { waypoints: waypoints.length, analysis: routeAnalysis });

    const routeData = {
      path: waypoints.map(wp => ({ lat: wp.lat, lng: wp.lng })),
      distance: routeAnalysis.distance,
      name: `${sport} route`,
      analysis: routeAnalysis
    };

    onRouteSave(routeData);
    toast.success('Enhanced route saved with elevation analysis!');
  };

  const clearAll = () => {
    waypoints.forEach(wp => {
      if (wp.marker) {
        wp.marker.setMap(null);
      }
    });
    setWaypoints([]);
    setRouteAnalysis(null);
    setElevationProfile([]);
    if (directionsRendererRef.current) {
      try {
        directionsRendererRef.current.setDirections({ routes: [] } as any);
      } catch (error) {
        console.warn('Error clearing directions:', error);
      }
    }
    // Clear custom polyline too
    if (polylineRef.current) {
      polylineRef.current.setMap(null);
      polylineRef.current = null;
    }
  };

  return (
    <div className="space-y-4">
      <p className="text-sm text-muted-foreground">
        Click on the map to add waypoints for your {sport} route. Advanced elevation analysis included.
      </p>
      
      <div className="border rounded-lg overflow-hidden">
        <div ref={mapRef} className="aspect-video w-full" />
        
        {!mapLoaded && (
          <div className="absolute inset-0 flex items-center justify-center bg-muted">
            <div className="text-sm text-muted-foreground">Loading enhanced map...</div>
          </div>
        )}
      </div>

      {/* Route Analysis */}
      {routeAnalysis && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="w-5 h-5" />
              Route Analysis
              {isAnalyzing && <div className="text-sm text-muted-foreground">Analyzing...</div>}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div className="text-center">
                <Route className="w-6 h-6 mx-auto mb-2 text-blue-600" />
                <p className="text-sm text-muted-foreground">Distance</p>
                <p className="font-semibold">{routeAnalysis.distance}</p>
              </div>
              <div className="text-center">
                <Clock className="w-6 h-6 mx-auto mb-2 text-green-600" />
                <p className="text-sm text-muted-foreground">Est. Time</p>
                <p className="font-semibold">{routeAnalysis.duration}</p>
              </div>
              <div className="text-center">
                <Mountain className="w-6 h-6 mx-auto mb-2 text-orange-600" />
                <p className="text-sm text-muted-foreground">Elevation Gain</p>
                <p className="font-semibold">{routeAnalysis.elevationGain}m</p>
              </div>
              <div className="text-center">
                <Badge className={getDifficultyColor(routeAnalysis.difficulty)}>
                  {routeAnalysis.difficulty}
                </Badge>
                <p className="text-sm text-muted-foreground mt-1">Difficulty</p>
              </div>
            </div>
            
            {/* Elevation Profile */}
            {elevationProfile.length > 0 && (
              <div className="mt-4">
                <h4 className="text-sm font-medium mb-2">Elevation Profile</h4>
                <div className="h-20 w-full bg-gradient-to-r from-green-100 to-red-100 rounded-lg p-2 relative">
                  <svg className="w-full h-full">
                    <polyline
                      fill="none"
                      stroke={getSportColor(sport)}
                      strokeWidth="2"
                      points={elevationProfile.map((elevation, index) => {
                        const x = (index / (elevationProfile.length - 1)) * 100;
                        const normalizedElevation = ((elevation - routeAnalysis.minElevation) / 
                          (routeAnalysis.maxElevation - routeAnalysis.minElevation)) * 80 + 10;
                        return `${x},${100 - normalizedElevation}`;
                      }).join(' ')}
                    />
                  </svg>
                </div>
                <div className="flex justify-between text-xs text-muted-foreground mt-1">
                  <span>Start</span>
                  <span>Avg Gradient: {routeAnalysis.avgGradient}%</span>
                  <span>End</span>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {waypoints.length > 0 && (
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <div className="text-xs font-medium">Waypoints ({waypoints.length}):</div>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={clearAll}
              className="text-xs h-7"
            >
              Clear All
            </Button>
          </div>
          <div className="space-y-1 max-h-32 overflow-y-auto">
            {waypoints.map((wp, index) => (
              <div key={index} className="flex gap-2 items-center text-xs bg-muted/50 p-2 rounded">
                <span className="text-muted-foreground w-6">{index + 1}.</span>
                <span className="flex-1 truncate">{wp.address || `${wp.lat.toFixed(4)}, ${wp.lng.toFixed(4)}`}</span>
                {wp.elevation && (
                  <span className="text-muted-foreground">{Math.round(wp.elevation)}m</span>
                )}
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={() => removeWaypoint(index)}
                  className="text-xs h-6 w-6 p-0"
                >
                  <X className="w-3 h-3" />
                </Button>
              </div>
            ))}
          </div>
        </div>
      )}

      <Button
        type="button"
        variant="default"
        size="sm"
        onClick={handleSave}
        disabled={waypoints.length === 0 || !mapLoaded}
        className="w-full"
      >
        <Navigation className="w-4 h-4 mr-2" />
        Save Route {waypoints.length > 0 && `(${waypoints.length} waypoints)`}
      </Button>
    </div>
  );
}


```

`domains/locations/components/LocationPermissionModal.tsx`:

```tsx
import React from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/shared/components/ui/dialog';
import { Button } from '@/shared/components/ui/button';
import { MapPin, Shield, Users, Eye, X } from 'lucide-react';

interface LocationPermissionModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onAllow: () => void;
  onDeny: () => void;
}

interface BenefitItemProps {
  icon: React.ReactNode;
  title: string;
  description: string;
}

function BenefitItem({ icon, title, description }: BenefitItemProps) {
  return (
    <div className="flex items-start gap-3">
      <div className="flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
        {icon}
      </div>
      <div>
        <h4 className="font-medium text-sm">{title}</h4>
        <p className="text-xs text-muted-foreground">{description}</p>
      </div>
    </div>
  );
}

export function LocationPermissionModal({
  open,
  onOpenChange,
  onAllow,
  onDeny,
}: LocationPermissionModalProps) {
  const handleAllow = () => {
    console.log('üîç LocationPermissionModal: Allow button clicked');
    onOpenChange(false); // Close modal first
    onAllow(); // Then trigger the permission request
  };

  const handleDeny = () => {
    console.log('üîç LocationPermissionModal: Deny button clicked');
    onOpenChange(false); // Close modal
    onDeny();
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md max-h-[90vh] overflow-y-auto">
        <DialogHeader className="text-center sm:text-center">
          <div className="mx-auto mb-4 w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center">
            <MapPin className="w-8 h-8 text-primary" />
          </div>
          <DialogTitle className="text-xl">Enable Location Access</DialogTitle>
          <DialogDescription className="text-base">
            TribeUp uses your location to help you find sports activities and players near you.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <h4 className="font-semibold text-sm text-center mb-3">Why we need your location</h4>
          
          <div className="space-y-4">
            <BenefitItem
              icon={<Users className="w-5 h-5 text-primary" />}
              title="Find Nearby Games"
              description="Discover pickup games and sports activities happening close to you in real-time."
            />
            
            <BenefitItem
              icon={<MapPin className="w-5 h-5 text-primary" />}
              title="Sort by Distance"
              description="See games sorted by how far they are, making it easy to find convenient locations."
            />
            
            <BenefitItem
              icon={<Eye className="w-5 h-5 text-primary" />}
              title="Local Recommendations"
              description="Get personalized suggestions for venues and activities in your area."
            />
          </div>
        </div>

        <div className="bg-muted/50 rounded-lg p-3">
          <div className="flex items-start gap-2">
            <Shield className="w-4 h-4 text-muted-foreground mt-0.5 flex-shrink-0" />
            <div className="text-xs text-muted-foreground">
              <p className="font-medium mb-1">Your Privacy Matters</p>
              <ul className="space-y-0.5 list-disc list-inside">
                <li>Your exact location is never shared with other users</li>
                <li>Location data is only used to find nearby activities</li>
                <li>You can disable location access anytime in settings</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="flex flex-col gap-2 pt-4">
          <Button variant="default" onClick={handleAllow} className="w-full" size="lg">
            <MapPin className="w-4 h-4 mr-2" />
            Allow Location Access
          </Button>
          <Button variant="ghost" onClick={handleDeny} className="w-full">
            <X className="w-4 h-4 mr-2" />
            Not Now
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}

```

`domains/locations/components/LocationPicker.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Input } from '@/shared/components/ui/input';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { ScrollArea } from '@/shared/components/ui/scroll-area';
import GoogleMapView from './GoogleMapView';
import { MapPin, Search, Clock, Star, Navigation } from 'lucide-react';

export interface Location {
  id?: string;
  name: string;
  address: string;
  latitude: number;
  longitude: number;
  distance?: number;
  isFavorite?: boolean;
  isRecent?: boolean;
}

export interface LocationPickerProps extends React.HTMLAttributes<HTMLDivElement> {
  selectedLocation?: Location;
  onLocationSelect: (location: Location) => void;
  showMap?: boolean;
  showSearch?: boolean;
  showRecent?: boolean;
  showFavorites?: boolean;
  recentLocations?: Location[];
  favoriteLocations?: Location[];
  onToggleFavorite?: (location: Location) => void;
  currentLocation?: { latitude: number; longitude: number };
  className?: string;
}

/**
 * Location Picker Component
 * 
 * Enhanced location picker with map, search, recent locations, and favorites.
 * Based on Strava's location picker patterns.
 * 
 * @example
 * ```tsx
 * <LocationPicker
 *   selectedLocation={location}
 *   onLocationSelect={(loc) => setLocation(loc)}
 *   showMap
 *   showSearch
 *   recentLocations={recent}
 *   onToggleFavorite={(loc) => toggleFavorite(loc)}
 * />
 * ```
 */
export function LocationPicker({
  selectedLocation,
  onLocationSelect,
  showMap = true,
  showSearch = true,
  showRecent = true,
  showFavorites = true,
  recentLocations = [],
  favoriteLocations = [],
  onToggleFavorite,
  currentLocation,
  className,
  ...props
}: LocationPickerProps) {
  const [searchQuery, setSearchQuery] = React.useState('');
  const [isSearching, setIsSearching] = React.useState(false);
  const [searchResults, setSearchResults] = React.useState<Location[]>([]);

  // Filter locations based on search
  const filteredRecent = React.useMemo(() => {
    if (!searchQuery.trim()) return recentLocations;
    const query = searchQuery.toLowerCase();
    return recentLocations.filter(
      (loc) =>
        loc.name.toLowerCase().includes(query) ||
        loc.address.toLowerCase().includes(query)
    );
  }, [recentLocations, searchQuery]);

  const filteredFavorites = React.useMemo(() => {
    if (!searchQuery.trim()) return favoriteLocations;
    const query = searchQuery.toLowerCase();
    return favoriteLocations.filter(
      (loc) =>
        loc.name.toLowerCase().includes(query) ||
        loc.address.toLowerCase().includes(query)
    );
  }, [favoriteLocations, searchQuery]);

  const handleSearch = async (query: string) => {
    if (!query.trim()) {
      setSearchResults([]);
      setIsSearching(false);
      return;
    }

    setIsSearching(true);
    // TODO: Implement actual location search API call
    // For now, just filter existing locations
    setTimeout(() => {
      setSearchResults([]);
      setIsSearching(false);
    }, 500);
  };

  const handleLocationClick = (location: Location) => {
    onLocationSelect(location);
  };

  const handleToggleFavorite = (e: React.MouseEvent, location: Location) => {
    e.stopPropagation();
    if (onToggleFavorite) {
      onToggleFavorite(location);
    }
  };

  const formatDistance = (distance?: number): string => {
    if (!distance) return '';
    if (distance < 1000) return `${Math.round(distance)}m`;
    return `${(distance / 1000).toFixed(1)}km`;
  };

  const renderLocationItem = (location: Location, showDistance = true) => (
    <div
      key={location.id || location.name}
      className={cn(
        'flex items-center gap-3 p-3 rounded-lg border border-border cursor-pointer',
        'hover:bg-muted/50 hover:border-primary/50 transition-all',
        selectedLocation?.id === location.id && 'border-primary bg-primary/5'
      )}
      onClick={() => handleLocationClick(location)}
    >
      <div className="flex-shrink-0">
        <MapPin className="size-5 text-primary" />
      </div>
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <span className="font-medium truncate">{location.name}</span>
          {location.isFavorite && (
            <Star className="size-3 fill-warning text-warning" />
          )}
        </div>
        <p className="text-sm text-muted-foreground truncate">
          {location.address}
        </p>
        {showDistance && location.distance && (
          <p className="text-xs text-muted-foreground mt-1">
            {formatDistance(location.distance)} away
          </p>
        )}
      </div>
      {onToggleFavorite && (
        <Button
          type="button"
          variant="ghost"
          size="icon"
          className="flex-shrink-0"
          onClick={(e) => handleToggleFavorite(e, location)}
        >
          <Star
            className={cn(
              'size-4',
              location.isFavorite && 'fill-warning text-warning'
            )}
          />
        </Button>
      )}
    </div>
  );

  return (
    <div className={cn('space-y-4', className)} {...props}>
      {/* Search */}
      {showSearch && (
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground" />
          <Input
            type="text"
            placeholder="Search locations..."
            value={searchQuery}
            onChange={(e) => {
              setSearchQuery(e.target.value);
              handleSearch(e.target.value);
            }}
            className="pl-9"
          />
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        {/* Map */}
        {showMap && (
          <div className="space-y-2">
            <h3 className="text-sm font-semibold">Map</h3>
            <Card>
              <CardContent className="p-0">
                <div className="h-[400px] rounded-lg overflow-hidden">
                  <GoogleMapView
                    center={
                      selectedLocation
                        ? {
                            latitude: selectedLocation.latitude,
                            longitude: selectedLocation.longitude,
                          }
                        : currentLocation
                        ? { latitude: currentLocation.latitude, longitude: currentLocation.longitude }
                        : undefined
                    }
                    allowLocationSelection
                    onLocationSelect={(location) => {
                      onLocationSelect({
                        name: 'Selected Location',
                        address: `${location.latitude}, ${location.longitude}`,
                        latitude: location.latitude,
                        longitude: location.longitude,
                      });
                    }}
                  />
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Location List */}
        <div className="space-y-4">
          <ScrollArea className="h-[400px]">
            <div className="space-y-4 pr-4">
              {/* Search Results */}
              {isSearching && (
                <div className="text-center text-muted-foreground py-8">
                  Searching...
                </div>
              )}

              {searchQuery && searchResults.length === 0 && !isSearching && (
                <div className="text-center text-muted-foreground py-8">
                  No locations found
                </div>
              )}

              {searchQuery &&
                searchResults.length > 0 &&
                searchResults.map((location) => renderLocationItem(location))}

              {/* Favorites */}
              {!searchQuery && showFavorites && filteredFavorites.length > 0 && (
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <Star className="size-4 text-warning fill-current" />
                    <h3 className="text-sm font-semibold">Favorites</h3>
                  </div>
                  <div className="space-y-2">
                    {filteredFavorites.map((location) =>
                      renderLocationItem(location)
                    )}
                  </div>
                </div>
              )}

              {/* Recent */}
              {!searchQuery && showRecent && filteredRecent.length > 0 && (
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <Clock className="size-4 text-muted-foreground" />
                    <h3 className="text-sm font-semibold">Recent</h3>
                  </div>
                  <div className="space-y-2">
                    {filteredRecent.map((location) =>
                      renderLocationItem(location)
                    )}
                  </div>
                </div>
              )}

              {/* Current Location */}
              {!searchQuery && currentLocation && (
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <Navigation className="size-4 text-primary" />
                    <h3 className="text-sm font-semibold">Current Location</h3>
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    className="w-full justify-start"
                    onClick={() => {
                      if (currentLocation) {
                        onLocationSelect({
                          name: 'Current Location',
                          address: 'Using your current location',
                          latitude: currentLocation.latitude,
                          longitude: currentLocation.longitude,
                        });
                      }
                    }}
                  >
                    <Navigation className="size-4 mr-2" />
                    Use Current Location
                  </Button>
                </div>
              )}
            </div>
          </ScrollArea>
        </div>
      </div>
    </div>
  );
}


```

`domains/locations/components/MapView.tsx`:

```tsx
import React, { useState, useEffect, useRef, useCallback } from 'react';

import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { EmptyState } from '@/shared/components/ui/empty-state';
import { 
  MapPin, 
  Navigation, 
  Crosshair, 
  Layers, 
  Plus, 
  Minus,
  RotateCcw,
  Filter,
  Users,
  Clock,
  DollarSign
} from 'lucide-react';
import { useLocation, LocationCoordinates, calculateDistance, formatDistance } from '@/domains/locations/hooks/useLocation';
import { useGames } from '@/domains/locations/hooks/useGames';
import { toast } from 'sonner';

export interface MapGame {
  id: string;
  title: string;
  sport: string;
  location: LocationCoordinates;
  locationName: string;
  date: string;
  time: string;
  players: number;
  maxPlayers: number;
  cost: string;
  difficulty: string;
}

interface MapViewProps {
  games?: MapGame[];
  selectedGameId?: string;
  onGameSelect?: (gameId: string) => void;
  onLocationSelect?: (location: LocationCoordinates) => void;
  showCurrentLocation?: boolean;
  showGameMarkers?: boolean;
  allowLocationSelection?: boolean;
  center?: LocationCoordinates;
  zoom?: number;
  className?: string;
}

// Simple map implementation (in a real app, you'd use Google Maps, Mapbox, etc.)
function MapView({
  games = [],
  selectedGameId,
  onGameSelect,
  onLocationSelect,
  showCurrentLocation = true,
  showGameMarkers = true,
  allowLocationSelection = false,
  center,
  zoom = 13,
  className = ''
}: MapViewProps) {
  const allGames = useGames();
  const {
    currentLocation,
    isLoading: locationLoading,
    error: locationError,
    requestLocation,
    getFormattedDistanceTo
  } = useLocation();

  const [mapCenter, setMapCenter] = useState<LocationCoordinates>(
    center || currentLocation || { latitude: 29.6516, longitude: -82.3248 } // Gainesville, FL
  );
  const [mapZoom, setMapZoom] = useState(zoom);
  const [isMapLoaded, setIsMapLoaded] = useState(false);
  const [selectedLocation, setSelectedLocation] = useState<LocationCoordinates | null>(null);
  const [hoveredGameId, setHoveredGameId] = useState<string | null>(null);
  const [showSatellite, setShowSatellite] = useState(false);

  const mapRef = useRef<HTMLDivElement>(null);

  // Convert games to map games - prioritize passed games, fallback to store games
  const sourceGames = games.length > 0 ? games : allGames;
  console.log('MapView: Source games count:', sourceGames.length);
  
  const mapGames: MapGame[] = sourceGames
    .filter((game: any) => {
      // Only include games that have valid coordinates
      const hasCoords = game.latitude && game.longitude;
      if (!hasCoords) {
        console.log(`MapView: Game "${game.title}" missing coordinates:`, {
          latitude: game.latitude,
          longitude: game.longitude,
          location: game.location
        });
      }
      return hasCoords;
    })
    .map((game: any) => ({
      id: game.id,
      title: game.title,
      sport: game.sport,
      location: {
        latitude: game.latitude,
        longitude: game.longitude
      },
      locationName: typeof game.location === 'string' ? game.location : 'Unknown Location',
      date: game.date,
      time: game.time,
      players: game.totalPlayers || 0, // Use totalPlayers from games_with_counts
      maxPlayers: game.maxPlayers || 0,
      cost: game.cost || 'Free',
      difficulty: game.difficulty || 'Beginner'
    }));
    
  console.log('MapView: Games with coordinates:', mapGames.length);

  // Update map center when current location changes
  useEffect(() => {
    if (currentLocation && !center) {
      setMapCenter(currentLocation);
    }
  }, [currentLocation, center]);

  // Simulate map loading
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsMapLoaded(true);
    }, 1000);

    return () => clearTimeout(timer);
  }, []);

  const centerOnCurrentLocation = useCallback(() => {
    if (currentLocation) {
      setMapCenter(currentLocation);
      setMapZoom(15);
      toast.success('Centered on your location');
    } else {
      requestLocation();
    }
  }, [currentLocation, requestLocation]);

  const centerOnGame = useCallback((game: MapGame) => {
    setMapCenter(game.location);
    setMapZoom(16);
    if (onGameSelect) {
      onGameSelect(game.id);
    }
  }, [onGameSelect]);

  const handleMapClick = useCallback((event: React.MouseEvent<HTMLDivElement>) => {
    if (!allowLocationSelection) return;

    const rect = event.currentTarget.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    // Convert pixel coordinates to lat/lng (simplified)
    const scaleFactor = Math.pow(2, mapZoom - 10) * 1000;
    const lat = mapCenter.latitude + (y - rect.height / 2) * -0.001 / scaleFactor;
    const lng = mapCenter.longitude + (x - rect.width / 2) * 0.001 / scaleFactor;

    const location = { latitude: lat, longitude: lng };
    setSelectedLocation(location);

    if (onLocationSelect) {
      onLocationSelect(location);
    }
  }, [allowLocationSelection, mapCenter, mapZoom, onLocationSelect]);

  const handleMapTouch = useCallback((event: React.TouchEvent<HTMLDivElement>) => {
    if (!allowLocationSelection || event.touches.length !== 1) return;

    const rect = event.currentTarget.getBoundingClientRect();
    const touch = event.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;

    // Convert pixel coordinates to lat/lng (simplified)
    const scaleFactor = Math.pow(2, mapZoom - 10) * 1000;
    const lat = mapCenter.latitude + (y - rect.height / 2) * -0.001 / scaleFactor;
    const lng = mapCenter.longitude + (x - rect.width / 2) * 0.001 / scaleFactor;

    const location = { latitude: lat, longitude: lng };
    setSelectedLocation(location);

    if (onLocationSelect) {
      onLocationSelect(location);
    }
  }, [allowLocationSelection, mapCenter, mapZoom, onLocationSelect]);

  const zoomIn = useCallback(() => {
    setMapZoom(prev => Math.min(prev + 1, 18));
  }, []);

  const zoomOut = useCallback(() => {
    setMapZoom(prev => Math.max(prev - 1, 1));
  }, []);

  const resetView = useCallback(() => {
    if (currentLocation) {
      setMapCenter(currentLocation);
    }
    setMapZoom(13);
    setSelectedLocation(null);
  }, [currentLocation]);

  const getSportColor = (sport: string): string => {
    const colors = {
      'Basketball': 'bg-sport-basketball',
      'Soccer': 'bg-sport-soccer', 
      'Tennis': 'bg-sport-tennis',
      'Volleyball': 'bg-sport-volleyball',
      'Football': 'bg-sport-football',
      'Baseball': 'bg-sport-baseball'
    };
    return colors[sport as keyof typeof colors] || 'bg-primary';
  };

  if (locationError) {
    return (
      <div className={`relative ${className}`}>
        <EmptyState
          icon={<MapPin className="w-16 h-16" />}
          title="Location Access Required"
          description="Please enable location access to view the map and find nearby games."
          action={{
            label: "Enable Location",
            onClick: requestLocation
          }}
        />
      </div>
    );
  }

  return (
    <div className={`relative overflow-hidden rounded-lg ${className}`}>
      {/* Map Container */}
      <div
        ref={mapRef}
        className={`relative w-full h-full min-h-[300px] md:min-h-[400px] cursor-crosshair transition-all duration-300 ${
          showSatellite ? 'bg-gray-800' : 'bg-green-100'
        }`}
        onClick={handleMapClick}
        onTouchEnd={handleMapTouch}
        role="application"
        aria-label="Interactive map showing games and locations"
      >
        {/* Loading State */}
        {(!isMapLoaded || locationLoading) && (
          <div className="absolute inset-0 flex items-center justify-center bg-muted/50 backdrop-blur-sm z-10">
            <LoadingSpinner size="lg" text="Loading map..." />
          </div>
        )}

        {/* Interactive Map Implementation */}
        <div className="absolute inset-0">
          {/* OpenStreetMap Tile Layer */}
          <div 
            className="w-full h-full bg-cover bg-center"
            style={{
              backgroundImage: showSatellite 
                ? `url('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${mapZoom}/${Math.floor((90 - mapCenter.latitude) * Math.pow(2, mapZoom) / 360)}/${Math.floor((mapCenter.longitude + 180) * Math.pow(2, mapZoom) / 360)}')`
                : `url('https://tile.openstreetmap.org/${mapZoom}/${Math.floor((mapCenter.longitude + 180) * Math.pow(2, mapZoom) / 360)}/${Math.floor((90 - mapCenter.latitude) * Math.pow(2, mapZoom) / 360)}.png')`
            }}
          />
          
          {/* Map Grid Overlay */}
          <div 
            className="absolute inset-0 opacity-20"
            style={{
              backgroundImage: 'linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)',
              backgroundSize: '20px 20px'
            }}
          />
          
          {/* Street Pattern Overlay */}
          <div 
            className="absolute inset-0 opacity-10"
            style={{
              backgroundImage: showSatellite 
                ? 'none'
                : `url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000' fill-opacity='0.1'%3E%3Cpath d='M20 20h20v20H20z'/%3E%3Cpath d='M0 0h20v20H0z'/%3E%3C/g%3E%3C/svg%3E")`
            }}
          />
        </div>

        {/* Current Location Marker */}
        {showCurrentLocation && currentLocation && (
          <div
            className="absolute z-20"
            style={{
              left: '50%',
              top: '50%',
              transform: 'translate(-50%, -50%)'
            }}
          >
            <div className="relative">
              <div className="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg" />
              <div className="absolute inset-0 w-4 h-4 bg-blue-500 rounded-full animate-ping opacity-30" />
              <div className="absolute -top-1 -left-1 w-6 h-6 bg-blue-500/20 rounded-full animate-pulse" />
            </div>
          </div>
        )}

        {/* Game Markers */}
        {showGameMarkers && mapGames.map((game, index) => {
          const isSelected = selectedGameId === game.id;
          const isHovered = hoveredGameId === game.id;
          const distance = currentLocation ? calculateDistance(
            currentLocation.latitude,
            currentLocation.longitude,
            game.location.latitude,
            game.location.longitude
          ) : null;

          // Calculate marker position based on actual coordinates
          const latDiff = game.location.latitude - mapCenter.latitude;
          const lngDiff = game.location.longitude - mapCenter.longitude;
          
          // Convert lat/lng differences to pixel positions using Web Mercator projection
          const scaleFactor = Math.pow(2, mapZoom) / 360;
          const pixelX = 50 + (lngDiff * scaleFactor * 100);
          const pixelY = 50 - (latDiff * scaleFactor * 100);
          
          // Clamp to map bounds with padding
          const clampedX = Math.max(5, Math.min(95, pixelX));
          const clampedY = Math.max(5, Math.min(95, pixelY));
          
          // Only show markers that are within reasonable bounds
          const isVisible = pixelX >= -10 && pixelX <= 110 && pixelY >= -10 && pixelY <= 110;

          return (
            <div
              key={game.id}
              className="absolute z-10 cursor-pointer"
              style={{
                left: `${clampedX}%`,
                top: `${clampedY}%`
              }}
              onClick={(e) => {
                e.stopPropagation();
                centerOnGame(game);
              }}
              onMouseEnter={() => setHoveredGameId(game.id)}
              onMouseLeave={() => setHoveredGameId(null)}
            >
              <div className={`relative ${isSelected || isHovered ? 'z-30' : 'z-10'}`}>
                {/* Marker */}
                <div className={`
                  w-8 h-8 rounded-full border-2 border-white shadow-lg flex items-center justify-center
                  ${getSportColor(game.sport)} ${isSelected ? 'ring-2 ring-primary' : ''}
                  transition-all duration-200
                `}>
                  <Users className="w-4 h-4 text-white" />
                </div>

                {/* Game Info Popup */}
                {(isSelected || isHovered) && (
                  <div
                    className={`absolute z-40 ${
                      clampedY > 70 ? 'bottom-full mb-2' : 'top-full mt-2'
                    } left-1/2 transform -translate-x-1/2`}
                  >
                    <Card className="w-64 max-w-[calc(100vw-2rem)] shadow-lg border-2 bg-background/95 backdrop-blur-sm">
                      <CardContent className="p-3">
                        <div className="space-y-2">
                          <div className="flex items-center justify-between">
                            <h4 className="font-medium truncate">{game.title}</h4>
                            <Badge variant="secondary" className="text-xs flex-shrink-0">
                              {game.sport}
                            </Badge>
                          </div>
                          
                          <div className="flex items-center gap-2 text-sm text-muted-foreground flex-wrap">
                            <div className="flex items-center gap-1">
                              <Clock className="w-3 h-3" />
                              <span className="truncate">{game.time}</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <Users className="w-3 h-3" />
                              <span>{game.players}/{game.maxPlayers} players</span>
                            </div>
                            {game.cost !== 'Free' && (
                              <div className="flex items-center gap-1">
                                <DollarSign className="w-3 h-3" />
                                <span className="truncate">{game.cost}</span>
                              </div>
                            )}
                          </div>

                          <div className="flex items-center justify-between text-xs text-muted-foreground">
                            <span className="truncate mr-2">
                              {game.locationName}
                            </span>
                            {distance && (
                              <span className="flex-shrink-0">
                                {formatDistance(distance)} away
                              </span>
                            )}
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                )}
              </div>
            </div>
          );
        })}

        {/* Selected Location Marker */}
        {selectedLocation && allowLocationSelection && (
          <div
            className="absolute z-20"
            style={{
              left: '60%',
              top: '45%',
              transform: 'translate(-50%, -50%)'
            }}
          >
            <div className="flex flex-col items-center">
              <MapPin className="w-8 h-8 text-destructive drop-shadow-lg" />
              <div className="mt-1 px-2 py-1 bg-white rounded shadow text-xs">
                Selected Location
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Map Controls */}
      <div className="absolute top-2 right-2 md:top-4 md:right-4 flex flex-col gap-1 md:gap-2 z-30">
        {/* Layer Toggle */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={() => setShowSatellite(!showSatellite)}
          aria-label={showSatellite ? "Switch to map view" : "Switch to satellite view"}
        >
          <Layers className="w-3 h-3 md:w-4 md:h-4" />
        </Button>

        {/* Zoom Controls */}
        <div className="flex flex-col gap-1">
          <Button
            variant="outline"
            size="icon"
            className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
            onClick={zoomIn}
            aria-label="Zoom in"
          >
            <Plus className="w-3 h-3 md:w-4 md:h-4" />
          </Button>
          <Button
            variant="outline"
            size="icon"
            className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
            onClick={zoomOut}
            aria-label="Zoom out"
          >
            <Minus className="w-3 h-3 md:w-4 md:h-4" />
          </Button>
        </div>

        {/* Current Location */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={centerOnCurrentLocation}
          disabled={locationLoading}
          aria-label="Center on current location"
        >
          {locationLoading ? (
            <LoadingSpinner size="sm" />
          ) : (
            <Crosshair className="w-3 h-3 md:w-4 md:h-4" />
          )}
        </Button>

        {/* Reset View */}
        <Button
          variant="outline"
          size="icon"
          className="bg-background/95 backdrop-blur-sm h-8 w-8 md:h-10 md:w-10"
          onClick={resetView}
          aria-label="Reset map view"
        >
          <RotateCcw className="w-3 h-3 md:w-4 md:h-4" />
        </Button>
      </div>

      {/* Map Legend */}
      <div className="absolute bottom-2 left-2 md:bottom-4 md:left-4 z-30">
        <Card className="bg-background/95 backdrop-blur-sm">
          <CardContent className="p-2 md:p-3">
            <div className="text-xs space-y-1">
              <div className="font-medium mb-1 md:mb-2 text-xs md:text-sm">Legend</div>
              <div className="flex items-center gap-1 md:gap-2">
                <div className="w-2 h-2 md:w-3 md:h-3 bg-blue-500 rounded-full" />
                <span className="text-xs">You</span>
              </div>
              <div className="flex items-center gap-1 md:gap-2">
                <div className="w-2 h-2 md:w-3 md:h-3 bg-primary rounded-full" />
                <span className="text-xs">Games</span>
              </div>
              {selectedLocation && (
                <div className="flex items-center gap-1 md:gap-2">
                  <MapPin className="w-2 h-2 md:w-3 md:h-3 text-destructive" />
                  <span className="text-xs">Selected</span>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Game Count Badge */}
      {showGameMarkers && mapGames.length > 0 && (
        <div className="absolute top-2 left-2 md:top-4 md:left-4 z-30">
          <Badge variant="secondary" className="bg-background/95 backdrop-blur-sm text-xs">
            {mapGames.length} game{mapGames.length !== 1 ? 's' : ''}
          </Badge>
        </div>
      )}
    </div>
  );
}

export default MapView;
```

`domains/locations/components/RouteDisplayMap.tsx`:

```tsx
import React, { useEffect, useRef } from 'react';
import { loadGoogleMapsApi } from '@/domains/locations/services/googleMapsLoader';
import { Card, CardContent } from '@/shared/components/ui/card';

interface RouteDisplayMapProps {
  waypoints: Array<{ lat: number; lng: number }>;
  sport: string;
  analysis?: {
    distance: string;
    duration: string;
    elevationGain: number;
    difficulty: string;
  };
}

export const RouteDisplayMap: React.FC<RouteDisplayMapProps> = ({ 
  waypoints, 
  sport, 
  analysis 
}) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<google.maps.Map | null>(null);
  const markersRef = useRef<google.maps.Marker[]>([]);
  const polylineRef = useRef<google.maps.Polyline | null>(null);

  // Sport-specific colors
  const getSportColor = (sportType: string): string => {
    const colors = {
      'cycling': '#3b82f6',
      'running': '#ef4444', 
      'hiking': '#10b981',
      'walking': '#6b7280'
    };
    return colors[sportType.toLowerCase() as keyof typeof colors] || '#6b7280';
  };

  useEffect(() => {
    const initMap = async () => {
      if (!mapRef.current || waypoints.length === 0) return;

      try {
        const apiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY;
        if (!apiKey) {
          console.error('Google Maps API key not found');
          return;
        }

        await loadGoogleMapsApi(apiKey);

        // Calculate center and bounds
        const bounds = new google.maps.LatLngBounds();
        waypoints.forEach(point => {
          bounds.extend(new google.maps.LatLng(point.lat, point.lng));
        });

        const center = bounds.getCenter();

        // Create map
        const map = new google.maps.Map(mapRef.current, {
          center: { lat: center.lat(), lng: center.lng() },
          zoom: 15,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
          zoomControl: true,
        });

        mapInstanceRef.current = map;

        // Fit map to show all waypoints
        map.fitBounds(bounds);

        // Clear existing markers
        markersRef.current.forEach(marker => marker.setMap(null));
        markersRef.current = [];

        // Add waypoint markers
        waypoints.forEach((point, index) => {
          const marker = new google.maps.Marker({
            position: { lat: point.lat, lng: point.lng },
            map: map,
            title: `Waypoint ${index + 1}`,
            label: {
              text: (index + 1).toString(),
              color: 'white',
              fontWeight: 'bold'
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: getSportColor(sport),
              fillOpacity: 1,
              strokeColor: 'white',
              strokeWeight: 2,
            },
          });

          markersRef.current.push(marker);
        });

        // Calculate and draw route using Google Directions API to follow roads
        if (waypoints.length > 1) {
          const directionsService = new google.maps.DirectionsService();
          
          // Determine travel mode based on sport
          const getTravelMode = (sportType: string): google.maps.TravelMode => {
            switch (sportType.toLowerCase()) {
              case 'cycling':
              case 'bike':
                return google.maps.TravelMode.BICYCLING;
              case 'running':
              case 'hiking':
              case 'walking':
                return google.maps.TravelMode.WALKING;
              default:
                return google.maps.TravelMode.WALKING;
            }
          };

          // Create waypoints for directions (first is origin, last is destination, rest are waypoints)
          const origin = waypoints[0];
          const destination = waypoints[waypoints.length - 1];
          const waypointsForDirections = waypoints.slice(1, -1).map(point => ({
            location: new google.maps.LatLng(point.lat, point.lng),
            stopover: true
          }));

          directionsService.route({
            origin: new google.maps.LatLng(origin.lat, origin.lng),
            destination: new google.maps.LatLng(destination.lat, destination.lng),
            waypoints: waypointsForDirections,
            optimizeWaypoints: false, // Keep original order
            travelMode: getTravelMode(sport),
          }, (result, status) => {
            if (status === 'OK' && result) {
              // Clear existing polyline
              if (polylineRef.current) {
                polylineRef.current.setMap(null);
              }

              // Extract the route path
              const routePath: google.maps.LatLng[] = [];
              result.routes[0].legs.forEach(leg => {
                leg.steps.forEach(step => {
                  step.path?.forEach(point => routePath.push(point));
                });
              });

              // Draw the route polyline following roads
              polylineRef.current = new google.maps.Polyline({
                path: routePath,
                geodesic: true,
                strokeColor: getSportColor(sport),
                strokeOpacity: 1.0,
                strokeWeight: 4,
                map: map,
              });
            } else {
              console.warn('Directions request failed:', status);
              // Fallback to straight lines if directions fail
              const routePath = waypoints.map(point => 
                new google.maps.LatLng(point.lat, point.lng)
              );

              if (polylineRef.current) {
                polylineRef.current.setMap(null);
              }

              polylineRef.current = new google.maps.Polyline({
                path: routePath,
                geodesic: true,
                strokeColor: getSportColor(sport),
                strokeOpacity: 0.7,
                strokeWeight: 3,
                map: map,
              });
            }
          });
        }

      } catch (error) {
        console.error('Error loading route map:', error);
      }
    };

    initMap();

    // Cleanup
    return () => {
      markersRef.current.forEach(marker => marker.setMap(null));
      if (polylineRef.current) {
        polylineRef.current.setMap(null);
      }
    };
  }, [waypoints, sport]);

  if (waypoints.length === 0) {
    return (
      <Card>
        <CardContent className="p-4">
          <div className="text-sm text-muted-foreground text-center">
            No route waypoints available to display.
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardContent className="p-0">
        <div className="relative">
          <div 
            ref={mapRef} 
            className="w-full h-64 md:h-80 rounded-lg"
            style={{ minHeight: '300px' }}
          />
          
          {/* Route info overlay */}
          {analysis && (
            <div className="absolute top-2 left-2 bg-white/95 backdrop-blur-sm rounded-lg p-2 shadow-lg">
              <div className="text-xs space-y-1">
                <div className="font-medium">{analysis.distance}</div>
                <div className="text-muted-foreground">{analysis.duration}</div>
                <div className="text-muted-foreground">+{analysis.elevationGain}m</div>
              </div>
            </div>
          )}
          
          {/* Waypoint count */}
          <div className="absolute top-2 right-2 bg-white/95 backdrop-blur-sm rounded-lg px-2 py-1 shadow-lg">
            <div className="text-xs font-medium">
              {waypoints.length} waypoint{waypoints.length !== 1 ? 's' : ''}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

```

`domains/locations/components/VenueRatingModal.tsx`:

```tsx
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/shared/components/ui/dialog';
import { Button } from '@/shared/components/ui/button';
import { Textarea } from '@/shared/components/ui/textarea';
import { Star, MapPin, Clock, Car, Accessibility, Sparkles } from 'lucide-react';
import { VenueService, Venue } from '@/domains/locations/services/venueService';
import { toast } from 'sonner';

interface VenueRatingModalProps {
  venue: Venue | null;
  isOpen: boolean;
  onClose: () => void;
  onRatingSubmitted?: () => void;
}

interface RatingCriteria {
  overall: number;
  facilities: number;
  cleanliness: number;
  accessibility: number;
  parking: number;
}

function VenueRatingModal({ venue, isOpen, onClose, onRatingSubmitted }: VenueRatingModalProps) {
  const [ratings, setRatings] = useState<RatingCriteria>({
    overall: 0,
    facilities: 0,
    cleanliness: 0,
    accessibility: 0,
    parking: 0
  });
  const [review, setReview] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleRatingChange = (criteria: keyof RatingCriteria, rating: number) => {
    setRatings(prev => ({ ...prev, [criteria]: rating }));
  };

  const handleSubmit = async () => {
    if (!venue) return;

    // Validate that at least overall rating is provided
    if (ratings.overall === 0) {
      toast.error('Please provide an overall rating');
      return;
    }

    // Set default values for unrated criteria
    const finalRatings = {
      overall: ratings.overall,
      facilities: ratings.facilities || ratings.overall,
      cleanliness: ratings.cleanliness || ratings.overall,
      accessibility: ratings.accessibility || ratings.overall,
      parking: ratings.parking || ratings.overall
    };

    setIsSubmitting(true);

    try {
      await VenueService.addVenueRating(
        venue.id,
        finalRatings.overall,
        finalRatings.facilities,
        finalRatings.cleanliness,
        finalRatings.accessibility,
        finalRatings.parking,
        review.trim() || undefined
      );

      toast.success('Rating submitted successfully!');
      
      // Reset form
      setRatings({
        overall: 0,
        facilities: 0,
        cleanliness: 0,
        accessibility: 0,
        parking: 0
      });
      setReview('');
      
      onRatingSubmitted?.();
      onClose();
    } catch (error) {
      console.error('Error submitting rating:', error);
      toast.error('Failed to submit rating. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const renderStarRating = (
    label: string,
    icon: React.ReactNode,
    criteria: keyof RatingCriteria,
    description?: string
  ) => {
    const currentRating = ratings[criteria];
    
    return (
      <div className="space-y-2">
        <div className="flex items-center gap-2">
          {icon}
          <div>
            <div className="font-medium text-sm">{label}</div>
            {description && (
              <div className="text-xs text-muted-foreground">{description}</div>
            )}
          </div>
        </div>
        <div className="flex gap-1">
          {[1, 2, 3, 4, 5].map((star) => (
            <button
              key={star}
              type="button"
              onClick={() => handleRatingChange(criteria, star)}
              className={`p-1 rounded transition-colors ${
                star <= currentRating
                  ? 'text-yellow-500 hover:text-yellow-600'
                  : 'text-gray-300 hover:text-yellow-400'
              }`}
            >
              <Star
                className="w-6 h-6"
                fill={star <= currentRating ? 'currentColor' : 'none'}
              />
            </button>
          ))}
          {currentRating > 0 && (
            <span className="ml-2 text-sm text-muted-foreground">
              {currentRating} star{currentRating !== 1 ? 's' : ''}
            </span>
          )}
        </div>
      </div>
    );
  };

  if (!venue) return null;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Star className="w-5 h-5 text-yellow-500" />
            Rate {venue.name}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-6 py-4">
          {/* Venue Info */}
          <div className="bg-muted/50 rounded-lg p-3">
            <div className="font-medium">{venue.name}</div>
            <div className="text-sm text-muted-foreground flex items-center gap-1 mt-1">
              <MapPin className="w-3 h-3" />
              {venue.address}
            </div>
            <div className="text-sm text-muted-foreground capitalize mt-1">
              {venue.venue_type} venue ‚Ä¢ {venue.supported_sports.slice(0, 3).join(', ')}
            </div>
          </div>

          {/* Overall Rating */}
          <div className="border-b pb-4">
            {renderStarRating(
              'Overall Rating',
              <Star className="w-4 h-4 text-yellow-500" />,
              'overall',
              'Your overall experience at this venue'
            )}
          </div>

          {/* Detailed Ratings */}
          <div className="space-y-4">
            <div className="text-sm font-medium text-muted-foreground">
              Rate specific aspects (optional):
            </div>

            {renderStarRating(
              'Facilities',
              <Sparkles className="w-4 h-4 text-blue-500" />,
              'facilities',
              'Quality of courts, fields, equipment'
            )}

            {renderStarRating(
              'Cleanliness',
              <Sparkles className="w-4 h-4 text-green-500" />,
              'cleanliness',
              'Restrooms, locker rooms, general upkeep'
            )}

            {renderStarRating(
              'Accessibility',
              <Accessibility className="w-4 h-4 text-purple-500" />,
              'accessibility',
              'Ease of access for all users'
            )}

            {renderStarRating(
              'Parking',
              <Car className="w-4 h-4 text-orange-500" />,
              'parking',
              'Availability and convenience of parking'
            )}
          </div>

          {/* Review Text */}
          <div className="space-y-2">
            <label className="text-sm font-medium">
              Review (Optional)
            </label>
            <Textarea
              placeholder="Share your experience at this venue..."
              value={review}
              onChange={(e) => setReview(e.target.value)}
              rows={3}
              maxLength={500}
            />
            <div className="text-xs text-muted-foreground text-right">
              {review.length}/500 characters
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={isSubmitting}>
            Cancel
          </Button>
          <Button 
            onClick={handleSubmit} 
            disabled={ratings.overall === 0 || isSubmitting}
          >
            {isSubmitting ? 'Submitting...' : 'Submit Rating'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

export default VenueRatingModal;

```

`domains/tribes/components/CreateTribe.tsx`:

```tsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useCreateTribe } from '../hooks/useTribes';
import { useAppStore } from '@/store/appStore';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Label } from '@/shared/components/ui/label';
import { Switch } from '@/shared/components/ui/switch';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/shared/components/ui/select';
import { ArrowLeft } from 'lucide-react';
import { toast } from 'sonner';
import { DEFAULT_SPORTS } from '@/domains/games/components/SportPicker';

export function CreateTribe() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const createTribe = useCreateTribe();

  const [formData, setFormData] = useState({
    name: '',
    description: '',
    activity: '',
    is_public: true,
    location: '',
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!user?.id) {
      toast.error('You must be logged in to create a tribe');
      navigate('/login');
      return;
    }

    if (!formData.name.trim() || !formData.activity) {
      toast.error('Please fill in all required fields');
      return;
    }

    try {
      const newTribe = await createTribe.mutateAsync({
        name: formData.name.trim(),
        description: formData.description.trim() || null,
        activity: formData.activity,
        is_public: formData.is_public,
        location: formData.location.trim() || null,
        creator_id: user.id,
      });

      navigate(`/tribe/${newTribe.id}`);
    } catch (error) {
      console.error('Error creating tribe:', error);
    }
  };

  return (
    <div className="space-y-6 p-4 md:p-6 max-w-2xl mx-auto">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" onClick={() => navigate('/app/tribes')}>
          <ArrowLeft className="w-4 h-4" />
        </Button>
        <h1 className="text-2xl font-bold">Create New Tribe</h1>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Tribe Information</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="name">
                Tribe Name <span className="text-destructive">*</span>
              </Label>
              <Input
                id="name"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="e.g., UF Basketball Club"
                maxLength={50}
                required
              />
              <p className="text-xs text-muted-foreground">
                {formData.name.length}/50 characters
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="activity">
                Primary Activity <span className="text-destructive">*</span>
              </Label>
              <Select
                value={formData.activity}
                onValueChange={(value) => setFormData({ ...formData, activity: value })}
                required
              >
                <SelectTrigger id="activity" className="w-full">
                  {formData.activity ? (
                    <span className="flex items-center gap-2">
                      <span>
                        {DEFAULT_SPORTS.find((s) => s.value === formData.activity)?.icon}
                      </span>
                      <SelectValue>
                        {DEFAULT_SPORTS.find((s) => s.value === formData.activity)?.label}
                      </SelectValue>
                    </span>
                  ) : (
                    <SelectValue placeholder="Select an activity" />
                  )}
                </SelectTrigger>
                <SelectContent>
                  {DEFAULT_SPORTS.map((sport) => (
                    <SelectItem key={sport.value} value={sport.value}>
                      <span className="flex items-center gap-2">
                        <span className="text-base">{sport.icon}</span>
                        <span>{sport.label}</span>
                      </span>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="Tell people about your tribe..."
                maxLength={500}
                rows={4}
              />
              <p className="text-xs text-muted-foreground">
                {formData.description.length}/500 characters
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="location">Location (Optional)</Label>
              <Input
                id="location"
                value={formData.location}
                onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                placeholder="e.g., Gainesville, FL"
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="space-y-0.5">
                <Label htmlFor="is_public">Public Tribe</Label>
                <p className="text-sm text-muted-foreground">
                  Anyone can find and join this tribe
                </p>
              </div>
              <Switch
                id="is_public"
                checked={formData.is_public}
                onCheckedChange={(checked) =>
                  setFormData({ ...formData, is_public: checked })
                }
              />
            </div>
          </CardContent>
        </Card>

        <div className="flex gap-4">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/app/tribes')}
            className="flex-1"
          >
            Cancel
          </Button>
          <Button type="submit" disabled={createTribe.isPending} className="flex-1">
            {createTribe.isPending ? 'Creating...' : 'Create Tribe'}
          </Button>
        </div>
      </form>
    </div>
  );
}

export default CreateTribe;


```

`domains/tribes/components/TribeCard.tsx`:

```tsx
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Button } from '@/shared/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Users, MapPin, Calendar } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { useAppStore } from '@/store/appStore';
import { useTribeJoinToggle, useTribeMembership } from '../hooks/useTribeMembers';
import { Tribe } from '../services/tribeService';
import { cn } from '@/shared/utils/utils';

interface TribeCardProps {
  tribe: Tribe & {
    creator?: {
      id: string;
      display_name: string | null;
      username: string | null;
      avatar_url: string | null;
    };
  };
  showJoinButton?: boolean;
  onSelect?: (tribeId: string) => void;
}

export function TribeCard({ tribe, showJoinButton = true, onSelect }: TribeCardProps) {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { data: isMember = false } = useTribeMembership(tribe.id, user?.id);
  const { toggle, isLoading } = useTribeJoinToggle();

  const handleCardClick = () => {
    if (onSelect) {
      onSelect(tribe.id);
    } else {
      navigate(`/app/tribe/${tribe.id}`);
    }
  };

  const handleJoinClick = async (e: React.MouseEvent) => {
    e.stopPropagation();
    if (!user?.id) {
      navigate('/login');
      return;
    }
    await toggle(tribe.id, user.id, isMember);
  };

  return (
    <Card
      className="cursor-pointer hover:shadow-md hover:border-primary/20 transition-all duration-200"
      onClick={handleCardClick}
      role="button"
      tabIndex={0}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleCardClick();
        }
      }}
      aria-label={`View ${tribe.name} tribe details`}
    >
      <CardContent className="p-4">
        <div className="space-y-3">
          {/* Header */}
          <div className="flex items-start gap-3">
            <Avatar className="w-12 h-12">
              <AvatarImage src={tribe.avatar_url || undefined} alt={tribe.name} />
              <AvatarFallback className="bg-primary/10 text-primary">
                {tribe.name.substring(0, 2).toUpperCase()}
              </AvatarFallback>
            </Avatar>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <h3 className="font-semibold text-lg truncate">{tribe.name}</h3>
                {!tribe.is_public && (
                  <Badge variant="secondary" className="text-xs">
                    Private
                  </Badge>
                )}
              </div>
              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Badge variant="outline" className="text-xs">
                  {tribe.activity}
                </Badge>
                {tribe.location && (
                  <>
                    <MapPin className="w-3 h-3" />
                    <span className="truncate">{tribe.location}</span>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* Description */}
          {tribe.description && (
            <p className="text-sm text-muted-foreground line-clamp-2">{tribe.description}</p>
          )}

          {/* Stats */}
          <div className="flex items-center gap-4 text-sm text-muted-foreground">
            <div className="flex items-center gap-1">
              <Users className="w-4 h-4" />
              <span>{tribe.member_count} members</span>
            </div>
            {tribe.game_count > 0 && (
              <div className="flex items-center gap-1">
                <Calendar className="w-4 h-4" />
                <span>{tribe.game_count} games</span>
              </div>
            )}
          </div>

          {/* Actions */}
          {showJoinButton && user && (
            <Button
              size="sm"
              variant={isMember ? 'outline' : 'default'}
              onClick={handleJoinClick}
              disabled={isLoading}
              className="w-full"
            >
              {isMember ? 'Leave Tribe' : 'Join Tribe'}
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

export default TribeCard;


```

`domains/tribes/components/TribeChat.tsx`:

```tsx
import { useState, useRef, useEffect } from 'react';
import { useTribeChat } from '../hooks/useTribeChat';
import { useTribeChannels, useCreateChannel, useUpdateChannel, useDeleteChannel } from '../hooks/useTribeChannels';
import { useAppStore } from '@/store/appStore';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Input } from '@/shared/components/ui/input';
import { Button } from '@/shared/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Send, Plus, Edit2, Trash2 } from 'lucide-react';
import { cn } from '@/shared/utils/utils';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/shared/components/ui/dialog';
import { Label } from '@/shared/components/ui/label';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/shared/components/ui/dropdown-menu';
import { MoreVertical } from 'lucide-react';
import { NoMessagesEmptyState } from '@/shared/components/common/EmptyState';

// Simple relative time formatter
function formatRelativeTime(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

interface TribeChatProps {
  channelId: string;
  tribeId: string;
  canManage?: boolean;
}

export function TribeChat({ channelId, tribeId, canManage = false }: TribeChatProps) {
  const { user } = useAppStore();
  const { data: channels } = useTribeChannels(tribeId);
  const [message, setMessage] = useState('');
  const [selectedChannel, setSelectedChannel] = useState(channelId);
  const [showCreateChannel, setShowCreateChannel] = useState(false);
  const [newChannelName, setNewChannelName] = useState('');
  const [editingChannel, setEditingChannel] = useState<string | null>(null);
  const [editChannelName, setEditChannelName] = useState('');
  const [isLoadingMore, setIsLoadingMore] = useState(false);
  const [hasMoreMessages, setHasMoreMessages] = useState(true);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const messagesContainerRef = useRef<HTMLDivElement>(null);
  const oldestMessageRef = useRef<string | null>(null);
  
  const { messages, sendMessage, isSending } = useTribeChat(selectedChannel);
  const createChannel = useCreateChannel();
  const updateChannel = useUpdateChannel();
  const deleteChannel = useDeleteChannel();

  const scrollToBottom = () => {
    if (messagesContainerRef.current) {
      messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
    }
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    setSelectedChannel(channelId);
    setHasMoreMessages(true);
    oldestMessageRef.current = null;
  }, [channelId]);

  // Update oldest message ref when messages change
  useEffect(() => {
    if (messages.length > 0) {
      oldestMessageRef.current = messages[0].created_at;
      // Check if we have more messages (if we got exactly 10, there might be more)
      setHasMoreMessages(messages.length === 10);
    }
  }, [messages]);

  // Load older messages when scrolling to top
  const loadOlderMessages = async () => {
    if (isLoadingMore || !hasMoreMessages || !oldestMessageRef.current || !selectedChannel) return;

    try {
      setIsLoadingMore(true);
      
      const { TribeChannelService } = await import('../services/tribeChannelService');
      const olderMessages = await TribeChannelService.getChannelMessages(
        selectedChannel,
        10,
        oldestMessageRef.current
      );

      if (olderMessages.length === 0) {
        setHasMoreMessages(false);
        return;
      }

      setHasMoreMessages(olderMessages.length === 10);
      
      if (olderMessages.length > 0) {
        oldestMessageRef.current = olderMessages[0].created_at;
      }

      // Note: Since messages come from a hook, we can't directly update them here
      // The hook will need to be updated to support loading more messages
      // For now, this function is set up but won't actually update the messages
      // TODO: Update useTribeChat hook to support loading more messages
      console.log('Loaded older messages:', olderMessages.length);
    } catch (error) {
      console.error('Error loading older messages:', error);
    } finally {
      setIsLoadingMore(false);
    }
  };

  // Handle scroll to load more messages
  useEffect(() => {
    if (!selectedChannel) return;

    const container = messagesContainerRef.current;
    if (!container) return;

    const handleScroll = () => {
      // Load more when scrolled to top (within 50px)
      if (container.scrollTop < 50 && hasMoreMessages && !isLoadingMore) {
        loadOlderMessages();
      }
    };

    // Use passive listener for better mobile performance
    container.addEventListener('scroll', handleScroll, { passive: true });
    
    return () => {
      container.removeEventListener('scroll', handleScroll);
    };
  }, [hasMoreMessages, isLoadingMore, selectedChannel, loadOlderMessages]);

  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!message.trim() || isSending) return;

    await sendMessage(message);
    setMessage('');
  };

  const currentChannel = channels?.find((c) => c.id === selectedChannel);
  const hasChannels = channels && channels.length > 0;

  const handleCreateChannel = async () => {
    if (!newChannelName.trim() || !user?.id) return;
    try {
      const newChannel = await createChannel.mutateAsync({
        tribe_id: tribeId,
        name: newChannelName.trim(),
        type: 'custom',
        created_by: user.id,
      });
      setNewChannelName('');
      setShowCreateChannel(false);
      // Auto-select the newly created channel
      if (newChannel) {
        setSelectedChannel(newChannel.id);
      }
    } catch (error) {
      // Error handled by hook
    }
  };

  const handleUpdateChannel = async (channelId: string) => {
    if (!editChannelName.trim()) return;
    try {
      await updateChannel.mutateAsync({
        channelId,
        updates: { name: editChannelName.trim() },
      });
      setEditingChannel(null);
      setEditChannelName('');
    } catch (error) {
      // Error handled by hook
    }
  };

  const handleDeleteChannel = async (channelId: string) => {
    if (window.confirm('Are you sure you want to delete this channel? This cannot be undone.')) {
      try {
        await deleteChannel.mutateAsync(channelId);
        if (selectedChannel === channelId && channels && channels.length > 1) {
          setSelectedChannel(channels.find((c) => c.id !== channelId)?.id || channelId);
        }
      } catch (error) {
        // Error handled by hook
      }
    }
  };

  return (
    <div className="flex flex-col" style={{ height: '600px', minHeight: '600px' }}>
      {/* Channel Selector */}
      <div className="flex gap-2 mb-4 items-center">
        <div className="flex gap-2 overflow-x-auto pb-2 flex-1 items-center [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
          {channels && channels.length > 0 && (
            <>
              {channels.map((channel) => (
                <div key={channel.id} className="flex items-center gap-1 flex-shrink-0">
                  {editingChannel === channel.id ? (
                    <div className="flex items-center gap-1">
                      <Input
                        value={editChannelName}
                        onChange={(e) => setEditChannelName(e.target.value)}
                        onBlur={() => {
                          if (editChannelName.trim()) {
                            handleUpdateChannel(channel.id);
                          } else {
                            setEditingChannel(null);
                          }
                        }}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && editChannelName.trim()) {
                            handleUpdateChannel(channel.id);
                          } else if (e.key === 'Escape') {
                            setEditingChannel(null);
                            setEditChannelName('');
                          }
                        }}
                        className="h-8 w-32"
                        autoFocus
                      />
                    </div>
                  ) : (
                    <div className="flex items-center gap-1">
                      <Button
                        variant={selectedChannel === channel.id ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setSelectedChannel(channel.id)}
                        className="whitespace-nowrap"
                      >
                        {channel.name}
                      </Button>
                      {canManage && channel.type === 'custom' && (
                        <DropdownMenu>
                          <DropdownMenuTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-8 w-8">
                              <MoreVertical className="w-3 h-3" />
                            </Button>
                          </DropdownMenuTrigger>
                          <DropdownMenuContent align="end">
                            <DropdownMenuItem onClick={() => {
                              setEditingChannel(channel.id);
                              setEditChannelName(channel.name);
                            }}>
                              <Edit2 className="w-4 h-4 mr-2" />
                              Rename
                            </DropdownMenuItem>
                            <DropdownMenuItem
                              className="text-destructive"
                              onClick={() => handleDeleteChannel(channel.id)}
                            >
                              <Trash2 className="w-4 h-4 mr-2" />
                              Delete
                            </DropdownMenuItem>
                          </DropdownMenuContent>
                        </DropdownMenu>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </>
          )}
        </div>
        {canManage && (
          <Dialog open={showCreateChannel} onOpenChange={setShowCreateChannel}>
            <DialogTrigger asChild>
              <Button variant="default" size="sm" className="gap-2 flex-shrink-0 whitespace-nowrap">
                <Plus className="w-4 h-4" />
                <span className="hidden sm:inline">New Channel</span>
                <span className="sm:hidden">New</span>
              </Button>
            </DialogTrigger>
            <DialogContent>
              <DialogHeader>
                <DialogTitle>Create New Channel</DialogTitle>
                <DialogDescription>
                  Create a new channel for your tribe members to chat in.
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4 py-4">
                <div className="space-y-2">
                  <Label htmlFor="channel-name">Channel Name</Label>
                  <Input
                    id="channel-name"
                    value={newChannelName}
                    onChange={(e) => setNewChannelName(e.target.value)}
                    placeholder="e.g., Game Planning"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && newChannelName.trim()) {
                        handleCreateChannel();
                      }
                    }}
                    autoFocus
                  />
                </div>
              </div>
              <DialogFooter>
                <Button variant="outline" onClick={() => setShowCreateChannel(false)}>
                  Cancel
                </Button>
                <Button onClick={handleCreateChannel} disabled={!newChannelName.trim()}>
                  Create
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        )}
      </div>

      {/* Messages */}
      <Card className="flex-1 flex flex-col min-h-0">
        <CardContent className="flex-1 flex flex-col p-0 min-h-0">
          {!hasChannels ? (
            <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
              <p className="text-muted-foreground mb-4">No channels yet</p>
              {canManage && (
                <p className="text-sm text-muted-foreground mb-4">
                  Create your first channel to start chatting with tribe members
                </p>
              )}
            </div>
          ) : !selectedChannel ? (
            <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
              <p className="text-muted-foreground">Select a channel to view messages</p>
            </div>
          ) : (
            <>
              <div 
                ref={messagesContainerRef} 
                className="flex-1 overflow-y-auto p-4 min-h-0"
              >
                {messages.length === 0 ? (
                  <NoMessagesEmptyState isChannel={true} />
                ) : (
                  <div className="space-y-1">
                    {isLoadingMore && (
                      <div className="flex items-center justify-center py-2">
                        <div className="text-xs text-muted-foreground">Loading older messages...</div>
                      </div>
                    )}
                    {messages.map((msg: any, index: number) => {
                      const prevMsg = index > 0 ? messages[index - 1] : null;
                      const timeDiff = prevMsg && msg.created_at && prevMsg.created_at
                        ? new Date(msg.created_at).getTime() - new Date(prevMsg.created_at).getTime()
                        : Infinity;
                      const showHeader = !prevMsg || prevMsg.user_id !== msg.user_id || timeDiff > 300000; // 5 minutes
                      const isOwnMessage = user && msg.user_id === user.id;
                      
                      return (
                        <div 
                          key={msg.id} 
                          className={cn(
                            "flex gap-3",
                            isOwnMessage ? "flex-row-reverse" : ""
                          )}
                        >
                          {showHeader ? (
                            <Avatar className="w-8 h-8 flex-shrink-0">
                              <AvatarImage src={msg.avatar_url || undefined} />
                              <AvatarFallback>
                                {(() => {
                                  const displayName = msg.display_name && !msg.display_name.includes('@') 
                                    ? msg.display_name 
                                    : msg.username || user?.email?.split('@')[0] || 'U';
                                  return displayName.substring(0, 2).toUpperCase();
                                })()}
                              </AvatarFallback>
                            </Avatar>
                          ) : (
                            <div className="w-8" />
                          )}
                          <div className={cn("flex-1 max-w-[70%]", isOwnMessage ? "text-right" : "")}>
                            {showHeader && !isOwnMessage && (
                              <div className="flex items-center gap-2 text-xs mb-1">
                                <span className="font-medium">
                                  {(() => {
                                    // Prioritize display_name (full name) over username
                                    if (msg.display_name && !msg.display_name.includes('@')) {
                                      return msg.display_name;
                                    }
                                    // Fallback to username if no proper display name
                                    if (msg.username) {
                                      return msg.username;
                                    }
                                    if (user && msg.user_id === user.id) {
                                      return user.email?.split('@')[0] || 'You';
                                    }
                                    return msg.user_id ? 'User' : 'Anonymous';
                                  })()}
                                </span>
                                <span className="text-muted-foreground">
                                  {msg.created_at ? formatRelativeTime(msg.created_at) : ''}
                                </span>
                              </div>
                            )}
                            <div
                              className={cn(
                                "rounded-xl px-3 py-2 text-sm w-fit",
                                isOwnMessage
                                  ? "bg-primary text-primary-foreground ml-auto"
                                  : "bg-muted"
                              )}
                            >
                              {msg.message}
                            </div>
                            {isOwnMessage && showHeader && (
                              <div className="text-xs text-muted-foreground mt-1">
                                {msg.created_at ? formatRelativeTime(msg.created_at) : ''}
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                    <div ref={messagesEndRef} />
                  </div>
                )}
              </div>

              {/* Message Input */}
              <form onSubmit={handleSend} className="border-t p-4">
                <div className="flex gap-2">
                  <Input
                    value={message}
                    onChange={(e) => setMessage(e.target.value)}
                    placeholder={`Message ${currentChannel?.name || 'channel'}...`}
                    disabled={isSending || !selectedChannel}
                  />
                  <Button type="submit" disabled={!message.trim() || isSending || !selectedChannel} size="icon">
                    <Send className="w-4 h-4" />
                  </Button>
                </div>
              </form>
            </>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

export default TribeChat;


```

`domains/tribes/components/TribeDetail.tsx`:

```tsx
import { useParams, useNavigate } from 'react-router-dom';
import { useTribe } from '../hooks/useTribes';
import { useTribeRealtime } from '../hooks/useTribeRealtime';
import { useTribeMembership, useTribeRole, useTribeJoinToggle } from '../hooks/useTribeMembers';
import { useTribeChannels } from '../hooks/useTribeChannels';
import { useTribeStatistics } from '../hooks/useTribeStatistics';
import { useAppStore } from '@/store/appStore';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/shared/components/ui/tabs';
import { ArrowLeft, Users, Calendar, MessageCircle, Settings, MapPin } from 'lucide-react';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { TribeChat } from './TribeChat';
import { TribeMembers } from './TribeMembers';
import { TribeGames } from './TribeGames';
import { TribeStatistics } from './TribeStatistics';

export function TribeDetail() {
  const { tribeId } = useParams<{ tribeId: string }>();
  const navigate = useNavigate();
  const { user } = useAppStore();

  const { data: tribe, isLoading } = useTribe(tribeId || '');
  const { data: isMember = false } = useTribeMembership(tribeId || '', user?.id);
  const { data: userRole } = useTribeRole(tribeId || '', user?.id);
  const { data: channels } = useTribeChannels(tribeId || '');
  const { data: statistics } = useTribeStatistics(tribeId || '');
  const { toggle, isLoading: isToggling } = useTribeJoinToggle();

  useTribeRealtime(tribeId || '');

  const handleJoinLeave = async () => {
    if (!user?.id || !tribeId) return;
    await toggle(tribeId, user.id, isMember);
  };

  const canManage = userRole === 'admin' || userRole === 'moderator' || tribe?.created_by === user?.id;

  if (isLoading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <LoadingSpinner size="lg" />
      </div>
    );
  }

  if (!tribe) {
    return (
      <div className="p-4">
        <Button variant="ghost" onClick={() => navigate('/app/tribes')} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Back to Tribes
        </Button>
        <Card>
          <CardContent className="py-12 text-center">
            <p className="text-muted-foreground">Tribe not found</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  const defaultChannel = channels?.find((c) => c.type === 'general') || channels?.[0];

  return (
    <div className="space-y-6 p-4 md:p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4">
        <div className="flex items-center gap-2 w-full sm:w-auto">
          <Button variant="ghost" size="icon" onClick={() => navigate('/app/tribes')}>
            <ArrowLeft className="w-4 h-4" />
          </Button>
          <div className="flex-1 min-w-0">
            <h1 className="text-xl sm:text-2xl font-bold truncate">{tribe.name}</h1>
            <p className="text-sm sm:text-base text-muted-foreground truncate">{tribe.description || 'No description'}</p>
          </div>
        </div>
        <div className="flex items-center gap-2 w-full sm:w-auto sm:ml-auto">
          {user && (
            <Button
              variant={isMember ? 'outline' : 'default'}
              onClick={handleJoinLeave}
              disabled={isToggling}
              className="flex-1 sm:flex-initial text-sm"
            >
              <span className="hidden sm:inline">{isMember ? 'Leave Tribe' : 'Join Tribe'}</span>
              <span className="sm:hidden">{isMember ? 'Leave' : 'Join'}</span>
            </Button>
          )}
          {canManage && (
            <Button 
              variant="outline" 
              onClick={() => navigate(`/tribe/${tribeId}/edit`)}
              size="icon"
              className="sm:size-auto sm:px-3"
            >
              <Settings className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Settings</span>
            </Button>
          )}
        </div>
      </div>

      {/* Cover Image */}
      {tribe.cover_image_url && (
        <div className="relative h-48 w-full rounded-lg overflow-hidden">
          <img
            src={tribe.cover_image_url}
            alt={tribe.name}
            className="w-full h-full object-cover"
          />
        </div>
      )}

      {/* Tribe Info */}
      <Card>
        <CardContent className="p-6">
          <div className="flex items-start gap-4">
            <Avatar className="w-16 h-16">
              <AvatarImage src={tribe.avatar_url || undefined} alt={tribe.name} />
              <AvatarFallback className="bg-primary/10 text-primary text-xl">
                {tribe.name.substring(0, 2).toUpperCase()}
              </AvatarFallback>
            </Avatar>
            <div className="flex-1 space-y-2">
              <div className="flex items-center gap-2 flex-wrap">
                <Badge>{tribe.activity}</Badge>
                {!tribe.is_public && <Badge variant="secondary">Private</Badge>}
                {tribe.location && (
                  <div className="flex items-center gap-1 text-sm text-muted-foreground">
                    <MapPin className="w-4 h-4" />
                    <span>{tribe.location}</span>
                  </div>
                )}
              </div>
              <div className="flex items-center gap-4 text-sm text-muted-foreground">
                <div className="flex items-center gap-1">
                  <Users className="w-4 h-4" />
                  <span>{tribe.member_count} members</span>
                </div>
                <div className="flex items-center gap-1">
                  <Calendar className="w-4 h-4" />
                  <span>{tribe.game_count} games</span>
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Tabs */}
      <Tabs defaultValue="chat" className="space-y-4">
        <div className="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0 [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
          <TabsList className="w-full sm:w-fit min-w-full sm:min-w-0 inline-flex">
            <TabsTrigger value="chat" className="!flex-shrink-0 sm:!flex-1 whitespace-nowrap min-w-[60px]">
              <MessageCircle className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Chat</span>
            </TabsTrigger>
            <TabsTrigger value="members" className="!flex-shrink-0 sm:!flex-1 whitespace-nowrap min-w-[80px]">
              <Users className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Members</span>
              <span className="sm:ml-1">({tribe.member_count})</span>
            </TabsTrigger>
            <TabsTrigger value="games" className="!flex-shrink-0 sm:!flex-1 whitespace-nowrap min-w-[80px]">
              <Calendar className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Games</span>
              <span className="sm:ml-1">({tribe.game_count})</span>
            </TabsTrigger>
            <TabsTrigger value="stats" className="!flex-shrink-0 sm:!flex-1 whitespace-nowrap min-w-[60px]">
              <Settings className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Statistics</span>
            </TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="chat">
          <TribeChat 
            channelId={defaultChannel?.id || ''} 
            tribeId={tribeId || ''} 
            canManage={canManage} 
          />
        </TabsContent>

        <TabsContent value="members">
          <TribeMembers tribeId={tribeId || ''} canManage={canManage} />
        </TabsContent>

        <TabsContent value="games">
          <TribeGames tribeId={tribeId || ''} />
        </TabsContent>

        <TabsContent value="stats">
          <TribeStatistics tribeId={tribeId || ''} statistics={statistics} />
        </TabsContent>
      </Tabs>
    </div>
  );
}

export default TribeDetail;


```

`domains/tribes/components/TribeEdit.tsx`:

```tsx
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useTribe } from '../hooks/useTribes';
import { useUpdateTribe, useDeleteTribe } from '../hooks/useTribes';
import { useTribeRole } from '../hooks/useTribeMembers';
import { useAppStore } from '@/store/appStore';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Label } from '@/shared/components/ui/label';
import { Switch } from '@/shared/components/ui/switch';
import { ArrowLeft, Trash2, Upload, X } from 'lucide-react';
import { toast } from 'sonner';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { DEFAULT_SPORTS } from '@/domains/games/components/SportPicker';
import { supabase } from '@/core/database/supabase';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/shared/components/ui/alert-dialog';

export function TribeEdit() {
  const { tribeId } = useParams<{ tribeId: string }>();
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { data: tribe, isLoading } = useTribe(tribeId || '');
  const { data: userRole } = useTribeRole(tribeId || '', user?.id);
  const updateTribe = useUpdateTribe();
  const deleteTribe = useDeleteTribe();

  const [formData, setFormData] = useState({
    name: '',
    description: '',
    activity: '',
    is_public: true,
    location: '',
  });

  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [coverFile, setCoverFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [coverPreview, setCoverPreview] = useState<string | null>(null);

  useEffect(() => {
    if (tribe) {
      setFormData({
        name: tribe.name || '',
        description: tribe.description || '',
        activity: tribe.activity || '',
        is_public: tribe.is_public ?? true,
        location: tribe.location || '',
      });
      setAvatarPreview(tribe.avatar_url || null);
      setCoverPreview(tribe.cover_image_url || null);
    }
  }, [tribe]);

  const canEdit = userRole === 'admin' || tribe?.creator_id === user?.id;

  if (isLoading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <LoadingSpinner size="lg" />
      </div>
    );
  }

  if (!tribe) {
    return (
      <div className="p-4">
        <Button variant="ghost" onClick={() => navigate('/app/tribes')} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Back to Tribes
        </Button>
        <Card>
          <CardContent className="py-12 text-center">
            <p className="text-muted-foreground">Tribe not found</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!canEdit) {
    return (
      <div className="p-4">
        <Button variant="ghost" onClick={() => navigate(`/tribe/${tribeId}`)} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Back to Tribe
        </Button>
        <Card>
          <CardContent className="py-12 text-center">
            <p className="text-muted-foreground">You don't have permission to edit this tribe</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setAvatarPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleCoverChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setCoverFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setCoverPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const uploadImage = async (file: File, path: string): Promise<string | null> => {
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Math.random()}.${fileExt}`;
      const filePath = `${path}/${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('tribes')
        .upload(filePath, file);

      if (uploadError) throw uploadError;

      const { data } = supabase.storage.from('tribes').getPublicUrl(filePath);
      return data.publicUrl;
    } catch (error) {
      console.error('Error uploading image:', error);
      return null;
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.name.trim() || !formData.activity) {
      toast.error('Please fill in all required fields');
      return;
    }

    try {
      let avatarUrl = tribe.avatar_url;
      let coverUrl = tribe.cover_image_url;

      // Upload images if new files selected
      if (avatarFile) {
        const uploaded = await uploadImage(avatarFile, `avatars/${tribeId}`);
        if (uploaded) avatarUrl = uploaded;
      }

      if (coverFile) {
        const uploaded = await uploadImage(coverFile, `covers/${tribeId}`);
        if (uploaded) coverUrl = uploaded;
      }

      await updateTribe.mutateAsync({
        tribeId: tribeId!,
        updates: {
          name: formData.name.trim(),
          description: formData.description.trim() || null,
          activity: formData.activity,
          is_public: formData.is_public,
          location: formData.location.trim() || null,
          avatar_url: avatarUrl || null,
          cover_image_url: coverUrl || null,
        },
      });

      navigate(`/tribe/${tribeId}`);
    } catch (error) {
      console.error('Error updating tribe:', error);
    }
  };

  const handleDelete = async () => {
    try {
      await deleteTribe.mutateAsync(tribeId!);
      toast.success('Tribe deleted');
      navigate('/app/tribes');
    } catch (error) {
      console.error('Error deleting tribe:', error);
    }
  };

  return (
    <div className="space-y-6 p-4 md:p-6 max-w-2xl mx-auto">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" onClick={() => navigate(`/tribe/${tribeId}`)}>
          <ArrowLeft className="w-4 h-4" />
        </Button>
        <h1 className="text-2xl font-bold">Edit Tribe</h1>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Images */}
        <Card>
          <CardHeader>
            <CardTitle>Images</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Cover Image */}
            <div className="space-y-2">
              <Label>Cover Image</Label>
              <div className="relative h-32 w-full rounded-lg overflow-hidden border border-border">
                {coverPreview ? (
                  <>
                    <img src={coverPreview} alt="Cover" className="w-full h-full object-cover" />
                    <Button
                      type="button"
                      variant="destructive"
                      size="icon"
                      className="absolute top-2 right-2"
                      onClick={() => {
                        setCoverFile(null);
                        setCoverPreview(tribe.cover_image_url || null);
                      }}
                    >
                      <X className="w-4 h-4" />
                    </Button>
                  </>
                ) : (
                  <div className="w-full h-full flex items-center justify-center bg-muted">
                    <Upload className="w-8 h-8 text-muted-foreground" />
                  </div>
                )}
              </div>
              <Input
                type="file"
                accept="image/*"
                onChange={handleCoverChange}
                className="cursor-pointer"
              />
            </div>

            {/* Avatar */}
            <div className="space-y-2">
              <Label>Avatar</Label>
              <div className="flex items-center gap-4">
                <div className="relative w-24 h-24 rounded-full overflow-hidden border border-border">
                  {avatarPreview ? (
                    <>
                      <img src={avatarPreview} alt="Avatar" className="w-full h-full object-cover" />
                      <Button
                        type="button"
                        variant="destructive"
                        size="icon"
                        className="absolute top-0 right-0"
                        onClick={() => {
                          setAvatarFile(null);
                          setAvatarPreview(tribe.avatar_url || null);
                        }}
                      >
                        <X className="w-3 h-3" />
                      </Button>
                    </>
                  ) : (
                    <div className="w-full h-full flex items-center justify-center bg-muted">
                      <Upload className="w-6 h-6 text-muted-foreground" />
                    </div>
                  )}
                </div>
                <Input
                  type="file"
                  accept="image/*"
                  onChange={handleAvatarChange}
                  className="cursor-pointer flex-1"
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Basic Info */}
        <Card>
          <CardHeader>
            <CardTitle>Tribe Information</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="name">
                Tribe Name <span className="text-destructive">*</span>
              </Label>
              <Input
                id="name"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="e.g., UF Basketball Club"
                maxLength={50}
                required
              />
              <p className="text-xs text-muted-foreground">{formData.name.length}/50 characters</p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="activity">
                Primary Activity <span className="text-destructive">*</span>
              </Label>
              <select
                id="activity"
                value={formData.activity}
                onChange={(e) => setFormData({ ...formData, activity: e.target.value })}
                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                required
              >
                <option value="">Select an activity</option>
                {DEFAULT_SPORTS.map((sport) => (
                  <option key={sport.value} value={sport.value}>
                    {sport.icon} {sport.label}
                  </option>
                ))}
              </select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="Tell people about your tribe..."
                maxLength={500}
                rows={4}
              />
              <p className="text-xs text-muted-foreground">
                {formData.description.length}/500 characters
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="location">Location (Optional)</Label>
              <Input
                id="location"
                value={formData.location}
                onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                placeholder="e.g., Gainesville, FL"
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="space-y-0.5">
                <Label htmlFor="is_public">Public Tribe</Label>
                <p className="text-sm text-muted-foreground">
                  Anyone can find and join this tribe
                </p>
              </div>
              <Switch
                id="is_public"
                checked={formData.is_public}
                onCheckedChange={(checked) => setFormData({ ...formData, is_public: checked })}
              />
            </div>
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex gap-4">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate(`/tribe/${tribeId}`)}
            className="flex-1"
          >
            Cancel
          </Button>
          <Button type="submit" disabled={updateTribe.isPending} className="flex-1">
            {updateTribe.isPending ? 'Saving...' : 'Save Changes'}
          </Button>
        </div>

        {/* Delete Tribe */}
        {tribe.creator_id === user?.id && (
          <Card className="border-destructive">
            <CardHeader>
              <CardTitle className="text-destructive">Danger Zone</CardTitle>
            </CardHeader>
            <CardContent>
              <AlertDialog>
                <AlertDialogTrigger asChild>
                  <Button variant="destructive" type="button">
                    <Trash2 className="w-4 h-4 mr-2" />
                    Delete Tribe
                  </Button>
                </AlertDialogTrigger>
                <AlertDialogContent>
                  <AlertDialogHeader>
                    <AlertDialogTitle>Are you sure?</AlertDialogTitle>
                    <AlertDialogDescription>
                      This will permanently delete the tribe and all its data. This action cannot be undone.
                    </AlertDialogDescription>
                  </AlertDialogHeader>
                  <AlertDialogFooter>
                    <AlertDialogCancel>Cancel</AlertDialogCancel>
                    <AlertDialogAction onClick={handleDelete} className="bg-destructive text-destructive-foreground">
                      Delete
                    </AlertDialogAction>
                  </AlertDialogFooter>
                </AlertDialogContent>
              </AlertDialog>
            </CardContent>
          </Card>
        )}
      </form>
    </div>
  );
}

export default TribeEdit;


```

`domains/tribes/components/TribeGames.tsx`:

```tsx
import { useTribeGames } from '../hooks/useTribeGames';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Calendar, MapPin, Users, Plus } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { formatEventHeader } from '@/shared/utils/dateUtils';
import { EmptyState } from '@/shared/components/common/EmptyState';

interface TribeGamesProps {
  tribeId: string;
}

export function TribeGames({ tribeId }: TribeGamesProps) {
  const navigate = useNavigate();
  const { data: games, isLoading } = useTribeGames(tribeId);

  const handleCreateGame = () => {
    // Navigate to create game with tribeId in state
    navigate('/create', { state: { tribeId } });
  };

  if (isLoading) {
    return (
      <div className="flex justify-center py-12">
        <LoadingSpinner />
      </div>
    );
  }

  if (!games || games.length === 0) {
    return (
      <Card>
        <CardContent className="p-0">
          <EmptyState
            variant="no-games"
            title="No games in this tribe yet"
            description="Be the first to organize a game for your tribe members!"
            primaryAction={{
              label: 'Create Game',
              onClick: handleCreateGame,
              icon: <Plus className="w-4 h-4" />,
            }}
            size="md"
          />
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      <div className="flex justify-end">
        <Button onClick={handleCreateGame} className="gap-2">
          <Plus className="w-4 h-4" />
          Create Game for Tribe
        </Button>
      </div>

      {games.map((game: any) => (
        <Card
          key={game.id}
          className="cursor-pointer hover:shadow-md transition-shadow"
          onClick={() => navigate(`/game/${game.id}`)}
        >
          <CardContent className="p-4">
            <div className="space-y-2">
              <h3 className="font-semibold">{game.title}</h3>
              <div className="flex items-center gap-4 text-sm text-muted-foreground">
                <div className="flex items-center gap-1">
                  <Calendar className="w-4 h-4" />
                  <span>{formatEventHeader(game.date, game.time).label}</span>
                </div>
                <div className="flex items-center gap-1">
                  <MapPin className="w-4 h-4" />
                  <span>{game.location}</span>
                </div>
                <div className="flex items-center gap-1">
                  <Users className="w-4 h-4" />
                  <span>
                    {game.current_players || 0}/{game.max_players}
                  </span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

export default TribeGames;


```

`domains/tribes/components/TribeList.tsx`:

```tsx
import { useState } from 'react';
import { useTribes, useSearchTribes } from '../hooks/useTribes';
import { TribeCard } from './TribeCard';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Search, Plus } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { EmptyStateEnhanced } from '@/shared/components/ui/empty-state-enhanced';
import { DEFAULT_SPORTS } from '@/domains/games/components/SportPicker';

export function TribeList() {
  const navigate = useNavigate();
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedActivity, setSelectedActivity] = useState<string | undefined>();

  const { data: tribes, isLoading } = useTribes(selectedActivity);
  const { data: searchResults, isLoading: isSearching } = useSearchTribes(
    searchQuery,
    selectedActivity
  );

  const displayTribes = searchQuery.length >= 2 ? searchResults : tribes;
  const isLoadingData = searchQuery.length >= 2 ? isSearching : isLoading;

  return (
    <div className="space-y-6 p-4 md:p-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Tribes</h1>
          <p className="text-muted-foreground">Join communities for your favorite activities</p>
        </div>
        <Button onClick={() => navigate('/tribe/create')}>
          <Plus className="w-4 h-4 mr-2" />
          Create Tribe
        </Button>
      </div>

      {/* Search and Filters */}
      <div className="space-y-4">
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
          <Input
            placeholder="Search tribes..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="pl-10"
          />
        </div>

        {/* Activity filter */}
        <div className="flex gap-2 flex-wrap">
          <Button
            variant={selectedActivity === undefined ? 'default' : 'outline'}
            size="sm"
            onClick={() => setSelectedActivity(undefined)}
          >
            All Activities
          </Button>
          {DEFAULT_SPORTS.map((sport) => (
            <Button
              key={sport.value}
              variant={selectedActivity === sport.value ? 'default' : 'outline'}
              size="sm"
              onClick={() => setSelectedActivity(sport.value)}
            >
              {sport.icon} {sport.label}
            </Button>
          ))}
        </div>
      </div>

      {/* Tribes Grid */}
      {isLoadingData ? (
        <div className="flex justify-center py-12">
          <LoadingSpinner size="lg" />
        </div>
      ) : displayTribes && displayTribes.length > 0 ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {displayTribes.map((tribe) => (
            <TribeCard key={tribe.id} tribe={tribe} />
          ))}
        </div>
      ) : (
        <EmptyStateEnhanced
          variant={searchQuery.length >= 2 ? 'no-results' : 'no-data'}
          title={searchQuery.length >= 2 ? 'No tribes found' : 'No tribes yet'}
          description={
            searchQuery.length >= 2
              ? 'Try adjusting your search or filters to find what you\'re looking for.'
              : 'Be the first to create a tribe and start building your community!'
          }
          primaryAction={
            searchQuery.length >= 2
              ? {
                  label: 'Clear Search',
                  onClick: () => setSearchQuery(''),
                  variant: 'outline',
                }
              : {
                  label: 'Create Tribe',
                  onClick: () => navigate('/tribe/create'),
                  icon: <Plus className="w-4 h-4" />,
                }
          }
        />
      )}
    </div>
  );
}

export default TribeList;


```

`domains/tribes/components/TribeMembers.tsx`:

```tsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTribeMembers } from '../hooks/useTribeMembers';
import { useRemoveMember, useUpdateMemberRole } from '../hooks/useTribeMembers';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Badge } from '@/shared/components/ui/badge';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/shared/components/ui/dialog';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/shared/components/ui/dropdown-menu';
import { MoreVertical, Crown, Shield, User, UserPlus, Search, Loader2 } from 'lucide-react';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { useUserSearch } from '@/domains/users/hooks/useFriends';
import { toast } from 'sonner';
import { supabase } from '@/core/database/supabase';
import { useQueryClient } from '@tanstack/react-query';
import { EmptyState } from '@/shared/components/common/EmptyState';
import { useAppStore } from '@/store/appStore';

// Simple relative time formatter
function formatRelativeTime(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

interface TribeMembersProps {
  tribeId: string;
  canManage: boolean;
}

export function TribeMembers({ tribeId, canManage }: TribeMembersProps) {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { data: members, isLoading } = useTribeMembers(tribeId);
  const updateRole = useUpdateMemberRole();
  const removeMember = useRemoveMember();
  const queryClient = useQueryClient();
  const [showInviteDialog, setShowInviteDialog] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [isInviting, setIsInviting] = useState(false);

  const handleMemberClick = (userId: string) => {
    // Route normalization: if user clicks their own card, redirect to own profile route
    if (userId === user?.id) {
      navigate('/app/profile/me');
    } else {
      navigate(`/app/user/${userId}`);
    }
  };
  
  const { data: searchResults, isLoading: isSearching } = useUserSearch(
    searchQuery,
    searchQuery.length > 2
  );

  const memberIds = new Set(members?.map(m => m.user_id) || []);
  const filteredResults = searchResults?.filter(user => !memberIds.has(user.id)) || [];

  const getRoleIcon = (role: string) => {
    switch (role) {
      case 'admin':
        return <Crown className="w-3 h-3" />;
      case 'moderator':
        return <Shield className="w-3 h-3" />;
      default:
        return <User className="w-3 h-3" />;
    }
  };

  const getRoleColor = (role: string) => {
    switch (role) {
      case 'admin':
        return 'bg-yellow-500/20 text-yellow-600 dark:text-yellow-400 border-yellow-500/30';
      case 'moderator':
        return 'bg-blue-500/20 text-blue-600 dark:text-blue-400 border-blue-500/30';
      default:
        return 'bg-muted text-foreground border-border';
    }
  };

  if (isLoading) {
    return (
      <div className="flex justify-center py-12">
        <LoadingSpinner />
      </div>
    );
  }

  if (!members || members.length === 0) {
    return (
      <Card>
        <CardContent className="p-0">
          <EmptyState
            variant="no-friends"
            title="No members yet"
            description="Invite members to grow your tribe community!"
            size="md"
          />
        </CardContent>
      </Card>
    );
  }

  const handleInviteUser = async (userId: string) => {
    if (isInviting) return;
    
    try {
      setIsInviting(true);
      
      // Check if user is already a member
      if (memberIds.has(userId)) {
        toast.error('User is already a member of this tribe');
        return;
      }

      // Add user to tribe (for now, directly add as member since there's no invitation system)
      const { error } = await supabase
        .from('tribe_members')
        .insert({
          tribe_id: tribeId,
          user_id: userId,
          role: 'member',
          status: 'active',
        });

      if (error) throw error;

      toast.success('User added to tribe!');
      
      // Refresh members list
      queryClient.invalidateQueries({ queryKey: ['tribes', tribeId, 'members', 'list'] });
    } catch (error: any) {
      console.error('Error inviting user:', error);
      toast.error('Failed to invite user', {
        description: error.message || 'Please try again',
      });
    } finally {
      setIsInviting(false);
    }
  };

  return (
    <div className="space-y-4">
      {canManage && (
        <div className="flex justify-end">
          <Dialog open={showInviteDialog} onOpenChange={setShowInviteDialog}>
            <DialogTrigger asChild>
              <Button variant="default" className="gap-2">
                <UserPlus className="w-4 h-4" />
                Invite Members
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md max-h-[80vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle className="flex items-center gap-2">
                  <UserPlus className="w-5 h-5" />
                  Invite Members to Tribe
                </DialogTitle>
                <DialogDescription>
                  Search for users by name or username to invite to this tribe
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
                  <Input
                    placeholder="Search users by name..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-9"
                  />
                </div>
                
                {isSearching ? (
                  <div className="flex justify-center py-8">
                    <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
                  </div>
                ) : searchQuery.length > 2 && filteredResults.length === 0 ? (
                  <EmptyState
                    variant="no-results"
                    title="No users found"
                    description="Try a different search term to find users."
                    size="sm"
                  />
                ) : searchQuery.length > 2 && filteredResults.length > 0 ? (
                  <div className="space-y-2 max-h-[400px] overflow-y-auto">
                    {filteredResults.map((user) => (
                      <div
                        key={user.id}
                        className="flex items-center justify-between p-3 border border-border rounded-lg hover:bg-muted/50 transition-colors"
                      >
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                          <Avatar className="w-10 h-10 flex-shrink-0">
                            <AvatarImage src={user.avatar_url || undefined} />
                            <AvatarFallback>
                              {(user.display_name || user.username || 'U').charAt(0).toUpperCase()}
                            </AvatarFallback>
                          </Avatar>
                          <div className="flex-1 min-w-0">
                            <h4 className="font-medium text-sm truncate">
                              {(() => {
                                // Prioritize username over display_name if display_name looks like an email
                                const displayName = user.display_name || '';
                                const isEmail = displayName.includes('@');
                                if (user.username) {
                                  return user.username;
                                }
                                if (displayName && !isEmail) {
                                  return displayName;
                                }
                                return 'User';
                              })()}
                            </h4>
                            {user.display_name && user.display_name !== user.username && !user.display_name.includes('@') && (
                              <p className="text-xs text-muted-foreground truncate mt-1">
                                {user.display_name}
                              </p>
                            )}
                            {user.username && (
                              <p className="text-xs text-muted-foreground truncate mt-1">
                                @{user.username}
                              </p>
                            )}
                            {!user.username && !user.display_name && user.bio && (
                              <p className="text-xs text-muted-foreground truncate mt-1">
                                {user.bio}
                              </p>
                            )}
                          </div>
                        </div>
                        <Button
                          size="sm"
                          onClick={() => handleInviteUser(user.id)}
                          disabled={isInviting}
                          className="flex-shrink-0 ml-2"
                        >
                          {isInviting ? (
                            <Loader2 className="w-3 h-3 animate-spin" />
                          ) : (
                            <>
                              <UserPlus className="w-3 h-3 mr-1" />
                              Invite
                            </>
                          )}
                        </Button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <p className="text-sm text-muted-foreground">
                      Start typing to search for users
                    </p>
                  </div>
                )}
              </div>
              <DialogFooter>
                <Button variant="outline" onClick={() => {
                  setShowInviteDialog(false);
                  setSearchQuery('');
                }}>
                  Close
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        </div>
      )}

      <div className="space-y-2">
        {members.map((member) => (
        <Card 
          key={member.id}
          className="cursor-pointer hover:shadow-md hover:border-primary/20 transition-all duration-200"
          onClick={() => handleMemberClick(member.user_id)}
          role="button"
          tabIndex={0}
          onKeyDown={(e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleMemberClick(member.user_id);
            }
          }}
          aria-label={`View ${member.display_name || member.username || 'member'}'s profile`}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Avatar>
                  <AvatarImage src={member.avatar_url || undefined} />
                  <AvatarFallback>
                    {member.display_name?.substring(0, 2).toUpperCase() || 'U'}
                  </AvatarFallback>
                </Avatar>
                <div>
                  <div className="flex items-center gap-2">
                    <span className="font-medium">
                      {(() => {
                        // Prioritize display_name (full name), then fallback to username
                        const displayName = member.display_name;
                        const username = member.username;
                        
                        // Check if display_name looks like an email (should use username instead)
                        const isEmail = displayName?.includes('@');
                        
                        // Prefer display_name (full name) if it exists and doesn't look like an email
                        if (displayName && !isEmail) {
                          return displayName;
                        }
                        // Fallback to username if no proper display name
                        if (username) {
                          return username;
                        }
                        // Try to get from email if available
                        if ((member as any).email) {
                          const email = (member as any).email as string;
                          return email.split('@')[0];
                        }
                        return 'Anonymous';
                      })()}
                    </span>
                    <Badge variant="outline" className={`${getRoleColor(member.role)} border`}>
                      {getRoleIcon(member.role)}
                      <span className="ml-1 capitalize">{member.role}</span>
                    </Badge>
                  </div>
                  <p className="text-sm text-muted-foreground">
                    Joined {member.joined_at ? formatRelativeTime(member.joined_at) : ''}
                  </p>
                </div>
              </div>

              {canManage && member.role !== 'admin' && (
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button 
                      variant="ghost" 
                      size="icon"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <MoreVertical className="w-4 h-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    {member.role === 'member' && (
                      <DropdownMenuItem
                        onClick={() =>
                          updateRole.mutate({
                            tribeId,
                            memberId: member.user_id,
                            role: 'moderator',
                          })
                        }
                      >
                        Make Moderator
                      </DropdownMenuItem>
                    )}
                    {member.role === 'moderator' && (
                      <DropdownMenuItem
                        onClick={() =>
                          updateRole.mutate({
                            tribeId,
                            memberId: member.user_id,
                            role: 'member',
                          })
                        }
                      >
                        Remove Moderator
                      </DropdownMenuItem>
                    )}
                    <DropdownMenuItem
                      className="text-destructive"
                      onClick={() =>
                        removeMember.mutate({
                          tribeId,
                          memberId: member.user_id,
                        })
                      }
                    >
                      Remove Member
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              )}
            </div>
          </CardContent>
        </Card>
        ))}
      </div>
    </div>
  );
}

export default TribeMembers;


```

`domains/tribes/components/TribeStatistics.tsx`:

```tsx
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Users, Calendar, TrendingUp } from 'lucide-react';

interface TribeStatisticsProps {
  tribeId: string;
  statistics: any;
}

export function TribeStatistics({ statistics }: TribeStatisticsProps) {
  if (!statistics) {
    return (
      <Card>
        <CardContent className="py-12 text-center">
          <p className="text-muted-foreground">No statistics available</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
      <Card className="min-w-0">
        <CardHeader className="pb-2 px-3 md:px-6 pt-3 md:pt-6">
          <CardTitle className="text-xs md:text-sm font-medium text-muted-foreground truncate">Members</CardTitle>
        </CardHeader>
        <CardContent className="px-3 md:px-6 pb-3 md:pb-6">
          <div className="flex items-center gap-2 min-w-0">
            <Users className="w-4 h-4 md:w-5 md:h-5 text-primary flex-shrink-0" />
            <div className="min-w-0 flex-1">
              <div className="text-xl md:text-2xl font-bold truncate">{statistics.active_member_count || statistics.member_count}</div>
              <p className="text-xs text-muted-foreground truncate">Active members</p>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card className="min-w-0">
        <CardHeader className="pb-2 px-3 md:px-6 pt-3 md:pt-6">
          <CardTitle className="text-xs md:text-sm font-medium text-muted-foreground truncate">Games</CardTitle>
        </CardHeader>
        <CardContent className="px-3 md:px-6 pb-3 md:pb-6">
          <div className="flex items-center gap-2 min-w-0">
            <Calendar className="w-4 h-4 md:w-5 md:h-5 text-primary flex-shrink-0" />
            <div className="min-w-0 flex-1">
              <div className="text-xl md:text-2xl font-bold truncate">{statistics.actual_game_count || statistics.game_count}</div>
              <p className="text-xs text-muted-foreground truncate">Games organized</p>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card className="min-w-0 sm:col-span-2 md:col-span-1">
        <CardHeader className="pb-2 px-3 md:px-6 pt-3 md:pt-6">
          <CardTitle className="text-xs md:text-sm font-medium text-muted-foreground truncate">Activity</CardTitle>
        </CardHeader>
        <CardContent className="px-3 md:px-6 pb-3 md:pb-6">
          <div className="flex items-center gap-2 min-w-0">
            <TrendingUp className="w-4 h-4 md:w-5 md:h-5 text-primary flex-shrink-0" />
            <div className="min-w-0 flex-1">
              <div className="text-xl md:text-2xl font-bold truncate">
                {statistics.next_game_date ? 'Upcoming' : 'None'}
              </div>
              <p className="text-xs text-muted-foreground truncate">Next game</p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

export default TribeStatistics;


```

`domains/users/components/AccessibilitySettings.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Switch } from '@/shared/components/ui/switch';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { Separator } from '@/shared/components/ui/separator';
import { Badge } from '@/shared/components/ui/badge';
import { 
  ArrowLeft,
  Eye,
  Type,
  Contrast,
  Volume2,
  Zap,
  MousePointer,
  Users,
  Palette,
  Sun,
  Moon,
  Monitor
} from 'lucide-react';
import { toast } from 'sonner';

interface AccessibilityPreferences {
  highContrast: boolean;
  largeText: boolean;
  reducedMotion: boolean;
  colorBlindFriendly: boolean;
  screenReader: boolean;
  focusIndicators: boolean;
  theme: 'light' | 'dark' | 'auto';
  fontSize: 'normal' | 'large' | 'extra-large';
  contrastLevel: 'normal' | 'high' | 'maximum';
}

const defaultPreferences: AccessibilityPreferences = {
  highContrast: false,
  largeText: false,
  reducedMotion: false,
  colorBlindFriendly: false,
  screenReader: false,
  focusIndicators: true,
  theme: 'auto',
  fontSize: 'normal',
  contrastLevel: 'normal',
};

function AccessibilitySettings() {
  const navigate = useNavigate();
  const [preferences, setPreferences] = useState<AccessibilityPreferences>(defaultPreferences);
  const [hasChanges, setHasChanges] = useState(false);

  useEffect(() => {
    // Load saved preferences from localStorage
    const saved = localStorage.getItem('accessibility-preferences');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        setPreferences({ ...defaultPreferences, ...parsed });
      } catch (error) {
        console.error('Failed to load accessibility preferences:', error);
      }
    }

    // Detect system preferences
    const detectSystemPreferences = () => {
      const updates: Partial<AccessibilityPreferences> = {};
      
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        updates.reducedMotion = true;
      }
      
      if (window.matchMedia('(prefers-contrast: high)').matches) {
        updates.highContrast = true;
        updates.contrastLevel = 'high';
      }
      
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        updates.theme = 'dark';
      }

      if (Object.keys(updates).length > 0) {
        setPreferences(prev => ({ ...prev, ...updates }));
      }
    };

    detectSystemPreferences();
  }, []);

  const updatePreference = <K extends keyof AccessibilityPreferences>(
    key: K, 
    value: AccessibilityPreferences[K]
  ) => {
    setPreferences(prev => ({ ...prev, [key]: value }));
    setHasChanges(true);
  };

  const applyPreferences = () => {
    const root = document.documentElement;
    
    // Apply theme
    if (preferences.theme === 'dark') {
      root.classList.add('dark');
      root.classList.remove('light');
    } else if (preferences.theme === 'light') {
      root.classList.add('light');
      root.classList.remove('dark');
    } else {
      // Auto - follow system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      root.classList.toggle('dark', prefersDark);
      root.classList.toggle('light', !prefersDark);
    }

    // Apply high contrast
    root.classList.toggle('high-contrast', preferences.highContrast);
    
    // Apply large text
    root.classList.toggle('large-text', preferences.largeText);
    
    // Apply colorblind friendly colors
    root.classList.toggle('colorblind-friendly', preferences.colorBlindFriendly);
    
    // Apply reduced motion
    if (preferences.reducedMotion) {
      root.style.setProperty('--duration-fast', '0ms');
      root.style.setProperty('--duration-normal', '0ms');
      root.style.setProperty('--duration-slow', '0ms');
    } else {
      root.style.removeProperty('--duration-fast');
      root.style.removeProperty('--duration-normal');
      root.style.removeProperty('--duration-slow');
    }

    // Save to localStorage
    localStorage.setItem('accessibility-preferences', JSON.stringify(preferences));
    
    toast.success('Accessibility settings applied', {
      description: 'Your preferences have been saved',
    });
    
    setHasChanges(false);
  };

  const resetToDefaults = () => {
    setPreferences(defaultPreferences);
    setHasChanges(true);
    toast('Settings reset to defaults', {
      description: 'Click Apply to save changes',
    });
  };

  const preferenceSections = [
    {
      title: 'Visual Accessibility',
      icon: Eye,
      items: [
        {
          key: 'highContrast' as const,
          label: 'High Contrast Mode',
          description: 'Increases contrast for better visibility',
          type: 'switch' as const,
        },
        {
          key: 'largeText' as const,
          label: 'Large Text',
          description: 'Increases text size throughout the app',
          type: 'switch' as const,
        },
        {
          key: 'colorBlindFriendly' as const,
          label: 'Color Blind Friendly',
          description: 'Uses alternative color schemes for better distinction',
          type: 'switch' as const,
        },
        {
          key: 'theme' as const,
          label: 'Theme',
          description: 'Choose your preferred color theme',
          type: 'select' as const,
          options: [
            { value: 'auto', label: 'Auto (System)', icon: Monitor },
            { value: 'light', label: 'Light', icon: Sun },
            { value: 'dark', label: 'Dark', icon: Moon },
          ],
        },
      ],
    },
    {
      title: 'Motion & Animation',
      icon: Zap,
      items: [
        {
          key: 'reducedMotion' as const,
          label: 'Reduce Motion',
          description: 'Reduces animations and transitions',
          type: 'switch' as const,
        },
      ],
    },
    {
      title: 'Navigation & Interaction',
      icon: MousePointer,
      items: [
        {
          key: 'focusIndicators' as const,
          label: 'Enhanced Focus Indicators',
          description: 'More visible focus outlines',
          type: 'switch' as const,
        },
        {
          key: 'screenReader' as const,
          label: 'Screen Reader Optimizations',
          description: 'Enhanced compatibility with screen readers',
          type: 'switch' as const,
        },
      ],
    },
  ];

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div
        className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10"
      >
        <div className="flex items-center justify-between px-4 py-4">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" onClick={() => navigate(-1)} aria-label="Go back">
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div>
              <h1 className="text-xl font-semibold">Accessibility</h1>
              <p className="text-sm text-muted-foreground">
                Customize your experience
              </p>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            {hasChanges && (
              <Badge variant="secondary" className="animate-pulse-once">
                Changes pending
              </Badge>
            )}
            <Button
              variant="outline"
              size="sm"
              onClick={resetToDefaults}
            >
              Reset
            </Button>
            <Button
              size="sm"
              onClick={applyPreferences}
              disabled={!hasChanges}
            >
              Apply Changes
            </Button>
          </div>
        </div>
      </div>

      <div className="px-4 py-6 space-y-8 max-w-4xl mx-auto">
        {/* Quick Preview */}
        <div>
          <Card className={`${preferences.highContrast ? 'border-2 border-foreground' : ''}`}>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Palette className="w-5 h-5" />
                Preview
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <h4 className="font-semibold">Sample Game Card</h4>
                  <div className="p-4 border rounded-lg bg-card">
                    <div className="flex items-center gap-2 mb-2">
                      <div className="w-8 h-8 bg-sport-basketball rounded-full" />
                      <div>
                        <div className="font-medium">Basketball Game</div>
                        <div className="text-sm text-muted-foreground">Today 6:00 PM</div>
                      </div>
                    </div>
                    <Button size="sm" className="w-full">Join Game</Button>
                  </div>
                </div>
                
                <div className="space-y-2">
                  <h4 className="font-semibold">Text Sizes</h4>
                  <div className="space-y-1">
                    <div className="text-sm">Small text example</div>
                    <div className="text-base">Normal text example</div>
                    <div className="text-lg">Large text example</div>
                  </div>
                </div>
                
                <div className="space-y-2">
                  <h4 className="font-semibold">Color Contrast</h4>
                  <div className="space-y-2">
                    <div className="flex gap-2">
                      <div className="w-6 h-6 bg-primary rounded" />
                      <div className="w-6 h-6 bg-secondary rounded" />
                      <div className="w-6 h-6 bg-success rounded" />
                    </div>
                    <div className="text-sm text-muted-foreground">
                      Sport color indicators
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Settings Sections */}
        {preferenceSections.map((section, sectionIndex) => (
          <div
            key={section.title}
          >
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <section.icon className="w-5 h-5" />
                  {section.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {section.items.map((item, itemIndex) => (
                  <div key={item.key}>
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="font-medium">{item.label}</div>
                        <div className="text-sm text-muted-foreground">
                          {item.description}
                        </div>
                      </div>
                      
                      <div className="flex-shrink-0">
                        {item.type === 'switch' ? (
                          <Switch
                            checked={preferences[item.key] as boolean}
                            onCheckedChange={(checked) => updatePreference(item.key, checked)}
                            aria-label={item.label}
                          />
                        ) : item.type === 'select' && item.options ? (
                          <Select
                            value={preferences[item.key] as string}
                            onValueChange={(value) => updatePreference(item.key, value)}
                          >
                            <SelectTrigger className="w-32">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              {item.options.map((option) => (
                                <SelectItem key={option.value} value={option.value}>
                                  <div className="flex items-center gap-2">
                                    {option.icon && <option.icon className="w-4 h-4" />}
                                    {option.label}
                                  </div>
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        ) : null}
                      </div>
                    </div>
                    {itemIndex < section.items.length - 1 && <Separator className="mt-6" />}
                  </div>
                ))}
              </CardContent>
            </Card>
          </div>
        ))}

        {/* System Detection */}
        <div>
          <Card>
            <CardHeader>
              <CardTitle>System Preferences Detected</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid gap-4">
                {[
                  {
                    label: 'Prefers Reduced Motion',
                    detected: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
                    applied: preferences.reducedMotion,
                  },
                  {
                    label: 'Prefers High Contrast',
                    detected: window.matchMedia('(prefers-contrast: high)').matches,
                    applied: preferences.highContrast,
                  },
                  {
                    label: 'Prefers Dark Mode',
                    detected: window.matchMedia('(prefers-color-scheme: dark)').matches,
                    applied: preferences.theme === 'dark',
                  },
                ].map((item) => (
                  <div key={item.label} className="flex items-center justify-between">
                    <span className="text-sm">{item.label}</span>
                    <div className="flex items-center gap-2">
                      <Badge variant={item.detected ? 'default' : 'outline'}>
                        {item.detected ? 'Detected' : 'Not detected'}
                      </Badge>
                      <Badge variant={item.applied ? 'secondary' : 'outline'}>
                        {item.applied ? 'Applied' : 'Not applied'}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Help Section */}
        <div>
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="w-5 h-5" />
                Need Help?
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <p className="text-sm text-muted-foreground">
                  TribeUp is committed to providing an accessible experience for all users. 
                  If you encounter any accessibility issues or have suggestions for improvement, 
                  please let us know.
                </p>
                
                <div className="flex flex-wrap gap-3">
                  <Button variant="outline" size="sm">
                    Contact Support
                  </Button>
                  <Button variant="outline" size="sm">
                    Accessibility Guide
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}

export default AccessibilitySettings;
```

`domains/users/components/AccountDeletionSection.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { ConfirmDeleteModal } from '@/shared/components/common/ConfirmDeleteModal';
import { deleteUserAccount } from '@/domains/users/services/accountDeletion';
import { useAppStore } from '@/store/appStore';
import { toast } from 'sonner';
import { Trash2, AlertTriangle } from 'lucide-react';

export function AccountDeletionSection() {
  const navigate = useNavigate();
  const { user, setUser } = useAppStore();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);

  const handleDeleteAccount = async () => {
    if (isDeleting) return;
    
    setIsDeleting(true);
    
    try {
      const result = await deleteUserAccount();
      
      if (result.success) {
        // Clear the app state
        setUser(null);
        
        toast.success('Your account has been deleted successfully');
        
        // Navigate to the public home page
        navigate('/', { replace: true });
      } else {
        toast.error(result.error || 'Failed to delete account. Please try again.');
        setIsModalOpen(false);
      }
    } catch (error) {
      console.error('Account deletion error:', error);
      toast.error('An unexpected error occurred. Please try again later.');
      setIsModalOpen(false);
    } finally {
      setIsDeleting(false);
    }
  };

  const deletionConsequences = [
    'Your profile and all personal information',
    'All games you have created',
    'Your game participation history',
    'All chat messages you have sent',
    'Your tribe memberships and created tribes',
    'All notifications and activity history',
    'Your friends and connections',
  ];

  return (
    <Card className="border-destructive/50">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-destructive">
          <Trash2 className="w-5 h-5" aria-hidden="true" />
          Danger Zone
        </CardTitle>
        <CardDescription>
          Irreversible and destructive actions
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <Alert variant="destructive" className="bg-destructive/10 border-destructive/30">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            Deleting your account will permanently remove all your data, including your profile, 
            games, messages, and activity history. This action cannot be undone.
          </AlertDescription>
        </Alert>
        
        <div className="flex flex-col gap-3">
          <p className="text-sm text-muted-foreground">
            Once you delete your account, there is no going back. Please be certain.
          </p>
          
          <Button
            variant="destructive"
            onClick={() => setIsModalOpen(true)}
            className="w-full sm:w-auto"
            disabled={isDeleting}
          >
            <Trash2 className="w-4 h-4 mr-2" aria-hidden="true" />
            Delete Account
          </Button>
        </div>

        <ConfirmDeleteModal
          open={isModalOpen}
          onOpenChange={setIsModalOpen}
          onConfirm={handleDeleteAccount}
          title="Delete Your Account?"
          description="This action is permanent and cannot be undone. All your data will be immediately and irreversibly deleted."
          confirmationText="DELETE"
          confirmationPlaceholder="Type DELETE to confirm"
          isLoading={isDeleting}
          consequences={deletionConsequences}
        />
      </CardContent>
    </Card>
  );
}

```

`domains/users/components/AchievementBadge.tsx`:

```tsx
import React from 'react';
import { Badge } from '@/shared/components/ui/badge';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/shared/components/ui/tooltip';
import { Trophy, Star, Crown, Target, Handshake, User } from 'lucide-react';

interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  category: string;
  points: number;
  earned_at?: string;
}

interface AchievementBadgeProps {
  achievement: Achievement;
  size?: 'sm' | 'md' | 'lg';
  showTooltip?: boolean;
  variant?: 'default' | 'outline' | 'secondary';
  showScore?: boolean;
  layout?: 'compact' | 'card';
}

const getAchievementIcon = (iconName: string) => {
  switch (iconName) {
    case 'trophy':
      return 'üèÜ';
    case 'star':
      return '‚≠ê';
    case 'handshake':
      return 'ü§ù';
    case 'runner':
      return 'üèÉ';
    case 'crown':
      return 'üëë';
    default:
      return 'üéØ';
  }
};

const getCategoryIcon = (category: string) => {
  switch (category) {
    case 'engagement':
      return <Target className="w-3 h-3" />;
    case 'milestone':
      return <Trophy className="w-3 h-3" />;
    case 'hosting':
      return <Crown className="w-3 h-3" />;
    case 'social':
      return <Star className="w-3 h-3" />;
    default:
      return <Trophy className="w-3 h-3" />;
  }
};

const getCategoryColor = (category: string) => {
  switch (category) {
    case 'engagement':
      return 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900 dark:text-blue-300';
    case 'milestone':
      return 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900 dark:text-yellow-300';
    case 'hosting':
      return 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900 dark:text-purple-300';
    case 'social':
      return 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900 dark:text-green-300';
    default:
      return 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-900 dark:text-gray-300';
  }
};

export function AchievementBadge({ 
  achievement, 
  size = 'md', 
  showTooltip = true,
  variant = 'default',
  showScore = true,
  layout = 'compact'
}: AchievementBadgeProps) {
  const sizeClasses = {
    sm: layout === 'card' ? 'text-xs p-2 gap-1' : 'text-xs px-1.5 py-0.5 gap-1',
    md: layout === 'card' ? 'text-sm p-3 gap-2' : 'text-xs px-2 py-1 gap-1.5',
    lg: layout === 'card' ? 'text-base p-4 gap-3' : 'text-sm px-3 py-1.5 gap-2'
  };

  if (layout === 'card') {
    const cardContent = (
      <div className={`
        ${sizeClasses[size]} 
        ${variant === 'default' ? getCategoryColor(achievement.category) : 'bg-card border border-border'}
        rounded-lg flex flex-col items-center text-center font-medium transition-all hover:shadow-md cursor-pointer
      `}>
        <div className="text-3xl mb-2">{getAchievementIcon(achievement.icon)}</div>
        <div className="font-semibold text-sm mb-1 line-clamp-2">{achievement.name}</div>
        {showScore && (
          <div className="text-lg font-bold text-primary">+{achievement.points}</div>
        )}
        {achievement.earned_at && (
          <div className="text-xs text-muted-foreground mt-1">
            {new Date(achievement.earned_at).toLocaleDateString()}
          </div>
        )}
      </div>
    );
    
    if (!showTooltip) {
      return cardContent;
    }
    
    return (
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            {cardContent}
          </TooltipTrigger>
          <TooltipContent side="top" className="max-w-xs">
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <span className="text-lg">{getAchievementIcon(achievement.icon)}</span>
                <span className="font-semibold">{achievement.name}</span>
              </div>
              <p className="text-sm text-muted-foreground">
                {achievement.description}
              </p>
              <div className="flex items-center justify-between text-xs">
                <div className="flex items-center gap-1">
                  {getCategoryIcon(achievement.category)}
                  <span className="capitalize">{achievement.category}</span>
                </div>
                <span className="text-primary font-medium">+{achievement.points} pts</span>
              </div>
              {achievement.earned_at && (
                <p className="text-xs text-muted-foreground">
                  Earned {new Date(achievement.earned_at).toLocaleDateString()}
                </p>
              )}
            </div>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    );
  }

  const badgeContent = (
    <Badge 
      variant={variant}
      className={`
        ${sizeClasses[size]} 
        ${variant === 'default' ? getCategoryColor(achievement.category) : ''}
        inline-flex items-center font-medium
      `}
    >
      <span className="text-lg">{getAchievementIcon(achievement.icon)}</span>
      <span className="truncate max-w-[100px]">{achievement.name}</span>
      {(showScore && (size === 'lg' || size === 'md')) && (
        <span className="text-xs font-bold text-primary bg-primary/10 px-1.5 py-0.5 rounded ml-1">+{achievement.points}</span>
      )}
    </Badge>
  );

  if (!showTooltip) {
    return badgeContent;
  }

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          {badgeContent}
        </TooltipTrigger>
        <TooltipContent side="top" className="max-w-xs">
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <span className="text-lg">{getAchievementIcon(achievement.icon)}</span>
              <span className="font-semibold">{achievement.name}</span>
            </div>
            <p className="text-sm text-muted-foreground">
              {achievement.description}
            </p>
            <div className="flex items-center justify-between text-xs">
              <div className="flex items-center gap-1">
                {getCategoryIcon(achievement.category)}
                <span className="capitalize">{achievement.category}</span>
              </div>
              <span className="text-primary font-medium">+{achievement.points} pts</span>
            </div>
            {achievement.earned_at && (
              <p className="text-xs text-muted-foreground">
                Earned {new Date(achievement.earned_at).toLocaleDateString()}
              </p>
            )}
          </div>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}

interface AchievementGridProps {
  achievements: Achievement[];
  maxDisplay?: number;
  size?: 'sm' | 'md' | 'lg';
  layout?: 'compact' | 'card';
  showScore?: boolean;
}

export function AchievementGrid({ 
  achievements, 
  maxDisplay = 6, 
  size = 'md',
  layout = 'compact',
  showScore = true
}: AchievementGridProps) {
  const displayAchievements = achievements.slice(0, maxDisplay);
  const remainingCount = Math.max(0, achievements.length - maxDisplay);

  const gridClasses = layout === 'card' 
    ? 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3'
    : 'flex flex-wrap gap-2';

  return (
    <div className={gridClasses}>
      {displayAchievements.map((achievement) => (
        <AchievementBadge
          key={achievement.id}
          achievement={achievement}
          size={size}
          layout={layout}
          showScore={showScore}
        />
      ))}
      {remainingCount > 0 && layout === 'compact' && (
        <Badge variant="outline" className={`${size === 'sm' ? 'text-xs px-1.5 py-0.5' : 'text-xs px-2 py-1'}`}>
          +{remainingCount} more
        </Badge>
      )}
      {remainingCount > 0 && layout === 'card' && (
        <div className="flex items-center justify-center p-4 border-2 border-dashed border-muted-foreground/30 rounded-lg text-muted-foreground">
          <div className="text-center">
            <div className="text-2xl mb-1">+{remainingCount}</div>
            <div className="text-xs">more</div>
          </div>
        </div>
      )}
    </div>
  );
}

```

`domains/users/components/AchievementNotification.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { toast } from 'sonner';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Button } from '@/shared/components/ui/button';
import { Trophy, X, Star, TrendingUp } from 'lucide-react';
import { useNavigate } from 'react-router-dom';

interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  category: string;
  points: number;
  earned_at?: string;
}

interface AchievementNotificationProps {
  achievement: Achievement;
  onClose?: () => void;
  autoClose?: boolean;
  duration?: number;
}

const getAchievementIcon = (iconName: string) => {
  switch (iconName) {
    case 'trophy':
      return 'üèÜ';
    case 'star':
      return '‚≠ê';
    case 'handshake':
      return 'ü§ù';
    case 'runner':
      return 'üèÉ';
    case 'crown':
      return 'üëë';
    default:
      return 'üéØ';
  }
};

const getCategoryColor = (category: string) => {
  switch (category) {
    case 'engagement':
      return 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900 dark:text-blue-300';
    case 'milestone':
      return 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900 dark:text-yellow-300';
    case 'hosting':
      return 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900 dark:text-purple-300';
    case 'social':
      return 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900 dark:text-green-300';
    default:
      return 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-900 dark:text-gray-300';
  }
};

// Floating achievement notification component
export function AchievementNotification({ 
  achievement, 
  onClose, 
  autoClose = true, 
  duration = 6000 
}: AchievementNotificationProps) {
  const [isVisible, setIsVisible] = useState(true);
  const navigate = useNavigate();

  useEffect(() => {
    if (autoClose) {
      const timer = setTimeout(() => {
        setIsVisible(false);
        setTimeout(() => onClose?.(), 300); // Allow fade out animation
      }, duration);

      return () => clearTimeout(timer);
    }
  }, [autoClose, duration, onClose]);

  const handleClose = () => {
    setIsVisible(false);
    setTimeout(() => onClose?.(), 300);
  };

  const handleViewProfile = () => {
    navigate('/profile?tab=achievements');
    handleClose();
  };

  if (!isVisible) return null;

  return (
    <div className={`
      fixed top-4 right-4 z-50 transform transition-all duration-300 ease-out
      ${isVisible ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}
    `}>
      <Card className="w-80 shadow-lg border-2 border-primary/20 bg-background/95 backdrop-blur">
        <CardContent className="p-4">
          <div className="flex items-start gap-3">
            {/* Achievement Icon */}
            <div className="flex-shrink-0">
              <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                <span className="text-2xl">{getAchievementIcon(achievement.icon)}</span>
              </div>
            </div>

            {/* Content */}
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <Trophy className="w-4 h-4 text-primary" />
                <span className="text-sm font-medium text-primary">Achievement Unlocked!</span>
              </div>
              
              <h3 className="font-semibold text-foreground mb-1">{achievement.name}</h3>
              <p className="text-sm text-muted-foreground mb-2">{achievement.description}</p>
              
              <div className="flex items-center justify-between">
                <Badge className={getCategoryColor(achievement.category)}>
                  <Star className="w-3 h-3 mr-1" />
                  +{achievement.points} pts
                </Badge>
                
                <div className="flex gap-2">
                  <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={handleViewProfile}
                    className="text-xs"
                  >
                    <TrendingUp className="w-3 h-3 mr-1" />
                    View All
                  </Button>
                </div>
              </div>
            </div>

            {/* Close Button */}
            <Button
              variant="ghost"
              size="sm"
              onClick={handleClose}
              className="flex-shrink-0 w-6 h-6 p-0"
            >
              <X className="w-4 h-4" />
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

// Hook for managing achievement notifications
export function useAchievementNotifications() {
  const [notifications, setNotifications] = useState<Achievement[]>([]);

  const showAchievementNotification = (achievement: Achievement) => {
    // Add to notifications state
    setNotifications(prev => [...prev, achievement]);

    // Also show toast notification as backup
    toast.success(
      `üéâ Achievement Unlocked!`,
      {
        description: `${getAchievementIcon(achievement.icon)} ${achievement.name} - ${achievement.description} (+${achievement.points} points)`,
        duration: 6000,
        action: {
          label: 'View All',
          onClick: () => {
            window.location.href = '/profile?tab=achievements';
          }
        }
      }
    );
  };

  const removeNotification = (achievementId: string) => {
    setNotifications(prev => prev.filter(notif => notif.id !== achievementId));
  };

  const clearAllNotifications = () => {
    setNotifications([]);
  };

  return {
    notifications,
    showAchievementNotification,
    removeNotification,
    clearAllNotifications
  };
}

// Component to render all active notifications
export function AchievementNotificationContainer() {
  const { notifications, removeNotification } = useAchievementNotifications();

  return (
    <div className="fixed top-4 right-4 z-50 space-y-2">
      {notifications.map((achievement, index) => (
        <div 
          key={achievement.id} 
          style={{ 
            transform: `translateY(${index * 10}px)`,
            zIndex: 50 - index 
          }}
        >
          <AchievementNotification
            achievement={achievement}
            onClose={() => removeNotification(achievement.id)}
          />
        </div>
      ))}
    </div>
  );
}

```

`domains/users/components/AchievementProgressIndicator.tsx`:

```tsx
import React from 'react';
import { Progress } from '@/shared/components/ui/progress';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Trophy, Target, Zap } from 'lucide-react';

interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  category: string;
  criteria: any;
  points: number;
}

interface AchievementProgress {
  achievement: Achievement;
  progress: number;
  total: number;
  percentage: number;
}

interface AchievementProgressIndicatorProps {
  achievements: AchievementProgress[];
  title?: string;
  showAll?: boolean;
}

export function AchievementProgressIndicator({ 
  achievements, 
  title = "Next Achievements",
  showAll = false 
}: AchievementProgressIndicatorProps) {
  const displayAchievements = showAll ? achievements : achievements.slice(0, 3);

  if (displayAchievements.length === 0) {
    return null;
  }

  return (
    <Card>
      <CardContent className="p-4">
        <div className="flex items-center gap-2 mb-4">
          <Target className="w-4 h-4 text-primary" />
          <h3 className="font-semibold text-sm">{title}</h3>
        </div>
        
        <div className="space-y-4">
          {displayAchievements.map((item) => {
            const achievement = item.achievement || item;
            return (
              <div key={achievement?.id || Math.random()} className="space-y-2">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2 flex-1 min-w-0">
                    <span className="text-lg">{achievement?.icon || 'üéØ'}</span>
                    <div className="flex-1 min-w-0">
                      <div className="font-medium text-sm truncate">
                        {achievement?.name || 'Unknown Achievement'}
                      </div>
                      <div className="text-xs text-muted-foreground truncate">
                        {achievement?.description || 'No description'}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 ml-2">
                    <Badge variant="outline" className="text-xs">
                      +{achievement?.points || 0}
                    </Badge>
                  </div>
                </div>
                
                <div className="space-y-1">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-muted-foreground">
                      {item.progress} / {item.total}
                    </span>
                    <span className="font-medium text-primary">
                      {item.percentage}%
                    </span>
                  </div>
                  <Progress value={item.percentage} className="h-2" />
                </div>
              </div>
            );
          })}
        </div>
        
        {!showAll && achievements.length > 3 && (
          <div className="text-center mt-4">
            <button className="text-xs text-muted-foreground hover:text-primary">
              View all achievements ‚Üí
            </button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

interface QuickProgressProps {
  label: string;
  current: number;
  target: number;
  icon?: React.ReactNode;
  color?: 'blue' | 'green' | 'purple' | 'orange';
}

export function QuickProgress({ 
  label, 
  current, 
  target, 
  icon = <Zap className="w-4 h-4" />,
  color = 'blue'
}: QuickProgressProps) {
  const percentage = Math.min((current / target) * 100, 100);
  
  const colorClasses = {
    blue: 'text-blue-600 bg-blue-50 border-blue-200',
    green: 'text-green-600 bg-green-50 border-green-200',
    purple: 'text-purple-600 bg-purple-50 border-purple-200',
    orange: 'text-orange-600 bg-orange-50 border-orange-200'
  };

  return (
    <div className={`p-3 rounded-lg border ${colorClasses[color]}`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          {icon}
          <span className="text-sm font-medium">{label}</span>
        </div>
        <span className="text-xs font-medium">
          {current}/{target}
        </span>
      </div>
      <Progress value={percentage} className="h-1.5" />
    </div>
  );
}

interface GameProgressWidgetProps {
  gamesPlayed: number;
  gamesHosted: number;
  nextAchievements: AchievementProgress[];
}

export function GameProgressWidget({ 
  gamesPlayed, 
  gamesHosted, 
  nextAchievements 
}: GameProgressWidgetProps) {
  // Find next participation and hosting milestones
  const nextParticipation = nextAchievements.find(a => {
    const achievement = a.achievement || a;
    return achievement?.category === 'engagement' || achievement?.category === 'participation';
  });
  const nextHosting = nextAchievements.find(a => {
    const achievement = a.achievement || a;
    return achievement?.category === 'hosting' || achievement?.category === 'engagement';
  });

  return (
    <div className="space-y-3">
      {nextParticipation && (
        <QuickProgress
          label="Activities Joined"
          current={gamesPlayed}
          target={nextParticipation.total}
          icon={<Trophy className="w-4 h-4" />}
          color="blue"
        />
      )}
      
      {nextHosting && (
        <QuickProgress
          label="Activities Hosted"
          current={gamesHosted}
          target={nextHosting.total}
          icon={<Target className="w-4 h-4" />}
          color="purple"
        />
      )}
    </div>
  );
}

```

`domains/users/components/AchievementScore.tsx`:

```tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Trophy, Star, TrendingUp } from 'lucide-react';

interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  category: string;
  points: number;
  earned_at?: string;
}

interface AchievementScoreProps {
  achievements: Achievement[];
  className?: string;
}

export function AchievementScore({ achievements, className = '' }: AchievementScoreProps) {
  // Calculate total score
  const totalScore = achievements.reduce((sum, achievement) => sum + achievement.points, 0);
  
  // Calculate category breakdown
  const categoryStats = achievements.reduce((stats, achievement) => {
    const category = achievement.category;
    if (!stats[category]) {
      stats[category] = { count: 0, points: 0 };
    }
    stats[category].count += 1;
    stats[category].points += achievement.points;
    return stats;
  }, {} as Record<string, { count: number; points: number }>);

  // Get achievement rank based on total score
  const getAchievementRank = (score: number) => {
    if (score >= 200) return { title: 'Legend', icon: 'üëë', color: 'text-yellow-600' };
    if (score >= 150) return { title: 'Champion', icon: 'üèÜ', color: 'text-purple-600' };
    if (score >= 100) return { title: 'Expert', icon: '‚≠ê', color: 'text-blue-600' };
    if (score >= 50) return { title: 'Rising Star', icon: 'üåü', color: 'text-green-600' };
    if (score >= 25) return { title: 'Rookie', icon: 'üéØ', color: 'text-orange-600' };
    return { title: 'Beginner', icon: 'üî∞', color: 'text-gray-600' };
  };

  const rank = getAchievementRank(totalScore);

  // Calculate next rank threshold
  const getNextRankThreshold = (score: number) => {
    if (score < 25) return 25;
    if (score < 50) return 50;
    if (score < 100) return 100;
    if (score < 150) return 150;
    if (score < 200) return 200;
    return null; // Max rank achieved
  };

  const nextThreshold = getNextRankThreshold(totalScore);
  const progressToNext = nextThreshold ? ((totalScore / nextThreshold) * 100) : 100;

  return (
    <Card className={className}>
      <CardHeader className="pb-3">
        <CardTitle className="flex items-center gap-2 text-lg">
          <Trophy className="w-5 h-5" />
          Achievement Score
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Total Score Display */}
        <div className="text-center space-y-2">
          <div className="text-3xl font-bold text-primary">{totalScore}</div>
          <div className="flex items-center justify-center gap-2">
            <span className="text-2xl">{rank.icon}</span>
            <Badge variant="secondary" className={`${rank.color} font-medium`}>
              {rank.title}
            </Badge>
          </div>
          {nextThreshold && (
            <div className="text-sm text-muted-foreground">
              {nextThreshold - totalScore} points to next rank
            </div>
          )}
        </div>

        {/* Progress Bar */}
        {nextThreshold && (
          <div className="space-y-1">
            <div className="flex justify-between text-xs text-muted-foreground">
              <span>Progress to next rank</span>
              <span>{Math.round(progressToNext)}%</span>
            </div>
            <div className="w-full bg-secondary rounded-full h-2">
              <div 
                className="bg-primary h-2 rounded-full transition-all duration-300"
                style={{ width: `${Math.min(progressToNext, 100)}%` }}
              />
            </div>
          </div>
        )}

        {/* Category Breakdown */}
        {Object.keys(categoryStats).length > 0 && (
          <div className="space-y-2">
            <div className="text-sm font-medium flex items-center gap-1">
              <TrendingUp className="w-4 h-4" />
              Category Breakdown
            </div>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(categoryStats).map(([category, stats]) => (
                <div key={category} className="flex items-center justify-between text-sm">
                  <span className="capitalize text-muted-foreground">{category}</span>
                  <div className="flex items-center gap-1">
                    <Badge variant="outline" className="text-xs">
                      {stats.count}
                    </Badge>
                    <span className="text-primary font-medium">{stats.points}pts</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Achievement Count */}
        <div className="flex items-center justify-between text-sm border-t pt-3">
          <span className="text-muted-foreground">Total Achievements</span>
          <div className="flex items-center gap-1">
            <Star className="w-4 h-4 text-yellow-500" />
            <span className="font-medium">{achievements.length}</span>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

// Hook for achievement score calculations
export function useAchievementScore(achievements: Achievement[]) {
  const totalScore = achievements.reduce((sum, achievement) => sum + achievement.points, 0);
  
  const categoryBreakdown = achievements.reduce((stats, achievement) => {
    const category = achievement.category;
    if (!stats[category]) {
      stats[category] = { count: 0, points: 0, achievements: [] };
    }
    stats[category].count += 1;
    stats[category].points += achievement.points;
    stats[category].achievements.push(achievement);
    return stats;
  }, {} as Record<string, { count: number; points: number; achievements: Achievement[] }>);

  const getAchievementRank = (score: number) => {
    if (score >= 200) return { title: 'Legend', icon: 'üëë', color: 'text-yellow-600', level: 6 };
    if (score >= 150) return { title: 'Champion', icon: 'üèÜ', color: 'text-purple-600', level: 5 };
    if (score >= 100) return { title: 'Expert', icon: '‚≠ê', color: 'text-blue-600', level: 4 };
    if (score >= 50) return { title: 'Rising Star', icon: 'üåü', color: 'text-green-600', level: 3 };
    if (score >= 25) return { title: 'Rookie', icon: 'üéØ', color: 'text-orange-600', level: 2 };
    return { title: 'Beginner', icon: 'üî∞', color: 'text-gray-600', level: 1 };
  };

  const rank = getAchievementRank(totalScore);

  return {
    totalScore,
    categoryBreakdown,
    rank,
    achievementCount: achievements.length
  };
}

```

`domains/users/components/DataExportSection.tsx`:

```tsx
import { useState } from 'react';
import { Download, FileJson, AlertCircle, CheckCircle2, Clock, Info } from 'lucide-react';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { Badge } from '@/shared/components/ui/badge';
import { supabase } from '@/core/database/supabase';
import { toast } from 'sonner';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

interface ExportHistory {
  id: string;
  requested_at: string;
  completed_at: string | null;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  error_message: string | null;
}

export function DataExportSection() {
  const [isExporting, setIsExporting] = useState(false);
  const queryClient = useQueryClient();

  // Dev/helper: Build a client-side export when Edge Function isn't available
  const clientSideExport = async (): Promise<Blob> => {
    const { data: auth } = await supabase.auth.getUser();
    const userId = auth?.user?.id;
    if (!userId) throw new Error('Not authenticated');

    const exportData: any = {
      export_metadata: {
        user_id: userId,
        exported_at: new Date().toISOString(),
        version: '1.0',
        format: 'json',
        mode: 'client-fallback',
      },
      profile: null,
      games_created: [],
      game_participants: [],
      games_joined: [],
      rsvps: [],
      chat_messages: [],
      tribe_chat_messages: [],
      tribe_memberships: [],
      tribes_owned: [],
      notifications: [],
      user_connections: [],
      user_stats: null,
      user_presence: [],
      user_achievements: [],
    };

    // Helper to safely query without throwing
    const safe = async <T,>(p: Promise<{ data: T | null; error: any }>): Promise<T | [] | null> => {
      try {
        const { data, error } = await p;
        if (error) {
          console.warn('[DataExport] Client fallback query warning:', error?.message || error);
          return Array.isArray(data) ? [] : null;
        }
        return data as any;
      } catch (err) {
        console.warn('[DataExport] Client fallback unexpected error:', err);
        return null as any;
      }
    };

    exportData.profile = await safe(
      supabase.from('user_profiles').select('*').eq('id', userId).single()
    );

    exportData.games_created = (await safe(
      supabase.from('games').select('*').eq('creator_id', userId).order('created_at', { ascending: false })
    )) || [];

    const gp: any[] = (await safe(
      supabase.from('game_participants').select('*').eq('user_id', userId).order('created_at', { ascending: false })
    )) as any[] || [];
    exportData.game_participants = gp;

    if (gp.length) {
      const ids = gp.map((g) => g.game_id).filter(Boolean);
      if (ids.length) {
        exportData.games_joined = (await safe(
          supabase.from('games').select('*').in('id', ids).order('created_at', { ascending: false })
        )) || [];
      }
    }

    exportData.rsvps = (await safe(
      supabase.from('rsvps').select('*').eq('user_id', userId).order('created_at', { ascending: false })
    )) || [];

    exportData.chat_messages = (await safe(
      supabase.from('chat_messages').select('*').eq('user_id', userId).order('created_at', { ascending: false })
    )) || [];

    exportData.tribe_chat_messages = (await safe(
      supabase.from('tribe_chat_messages').select('*').eq('user_id', userId).order('created_at', { ascending: false })
    )) || [];

    exportData.tribe_memberships = (await safe(
      supabase.from('tribe_members').select('*').eq('user_id', userId).order('joined_at', { ascending: false })
    )) || [];

    exportData.tribes_owned = (await safe(
      supabase.from('tribes').select('*').eq('created_by', userId).order('created_at', { ascending: false })
    )) || [];

    exportData.notifications = (await safe(
      supabase.from('notifications').select('*').eq('user_id', userId).order('created_at', { ascending: false })
    )) || [];

    exportData.user_connections = (await safe(
      supabase.from('user_connections').select('*').or(`follower_id.eq.${userId},following_id.eq.${userId}`).order('created_at', { ascending: false })
    )) || [];

    exportData.user_stats = await safe(
      supabase.from('user_stats').select('*').eq('user_id', userId).single()
    );

    exportData.user_presence = (await safe(
      supabase.from('user_presence').select('*').eq('user_id', userId).order('updated_at', { ascending: false })
    )) || [];

    exportData.user_achievements = (await safe(
      supabase.from('user_achievements').select('*').eq('user_id', userId).order('earned_at', { ascending: false })
    )) || [];

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    return blob;
  };

  // Fetch recent export history
  const { data: exportHistory, isLoading: isLoadingHistory, error: historyError } = useQuery<ExportHistory[]>({
    queryKey: ['user-data-exports'],
    queryFn: async () => {
      try {
        const { data, error } = await supabase
          .from('user_data_exports')
          .select('id, requested_at, completed_at, status, error_message')
          .order('requested_at', { ascending: false })
          .limit(5);

        // If table doesn't exist yet (migrations not applied), return empty array
        if (error?.code === '42P01' || error?.code === 'PGRST204') {
          console.warn('user_data_exports table not found - migrations may not be applied yet');
          return [];
        }

        if (error) {
          // Swallow errors to avoid global toasts; show inline alert via historyError
          console.warn('Failed to load export history:', error);
          return [];
        }
        return data || [];
      } catch (err) {
        console.warn('Unexpected error loading export history:', err);
        return [];
      }
    },
    retry: false,
    throwOnError: false,
    staleTime: 30000, // Cache for 30 seconds
  });

  // Check if user can request export (rate limiting)
  const canRequestExport = () => {
    if (!exportHistory || exportHistory.length === 0) return true;
    
    const lastExport = exportHistory[0];
    const lastExportTime = new Date(lastExport.requested_at).getTime();
    const now = Date.now();
    const hoursSinceLastExport = (now - lastExportTime) / (1000 * 60 * 60);
    
    return hoursSinceLastExport >= 24;
  };

  const getNextAvailableTime = () => {
    if (!exportHistory || exportHistory.length === 0) return null;
    
    const lastExport = exportHistory[0];
    const lastExportTime = new Date(lastExport.requested_at).getTime();
    const nextAvailable = new Date(lastExportTime + 24 * 60 * 60 * 1000);
    
    return nextAvailable;
  };

  // Request data export mutation
  const exportMutation = useMutation({
    mutationFn: async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error('Not authenticated');

      // Try Edge Function first
      try {
        const response = await fetch(
          `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/export-user-data`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json',
            },
          }
        );

        if (response.ok) {
          return response.blob();
        }

        // If function is missing/unavailable, use client-side fallback
        if (response.status === 404 || response.status === 403) {
          console.warn('[DataExport] Edge Function not available (status:', response.status, '), using client-side fallback');
          return clientSideExport();
        }

        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to export data');
      } catch (networkErr: any) {
        // Handle network/CORS/preflight failures (e.g., TypeError: Load failed)
        // Check if this is a network error (CORS, fetch failure, etc.)
        const msg = (networkErr?.message || '').toLowerCase();
        const isNetworkError = msg.includes('load failed') || 
          msg.includes('failed to fetch') || 
          msg.includes('network') || 
          msg.includes('cors') ||
          msg.includes('blocked') ||
          networkErr?.name === 'TypeError';
        
        if (isNetworkError) {
          console.warn('[DataExport] Network error calling Edge Function, using client-side fallback:', networkErr.message);
          return clientSideExport();
        }
        
        // For other errors, throw
        throw new Error('Unable to reach export service');
      }
    },
    onMutate: () => {
      setIsExporting(true);
      toast.info('Preparing your data export...');
    },
    onSuccess: (blob) => {
      // Create download link
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `tribeup-data-export-${Date.now()}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);

      toast.success('Your data has been exported successfully!');
      
      // Refresh export history
      queryClient.invalidateQueries({ queryKey: ['user-data-exports'] });
    },
    onError: (error: Error) => {
      console.error('Export error:', error);
      const msg = (error?.message || '').toLowerCase();
      if (msg.includes('load failed') || msg.includes('failed to fetch') || msg.includes('network')) {
        toast.error('Export service unavailable. Please deploy the function or enable fallback.');
      } else {
        toast.error(error.message || 'Failed to export data. Please try again.');
      }
    },
    onSettled: () => {
      setIsExporting(false);
    },
  });

  const handleExport = () => {
    if (!canRequestExport()) {
      const nextTime = getNextAvailableTime();
      if (nextTime) {
        toast.error(`You can request another export after ${nextTime.toLocaleString()}`);
      }
      return;
    }

    exportMutation.mutate();
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleString('en-US', {
      dateStyle: 'medium',
      timeStyle: 'short',
    });
  };

  const getStatusBadge = (status: ExportHistory['status']) => {
    const variants: Record<ExportHistory['status'], { variant: any; icon: any; label: string }> = {
      pending: { variant: 'outline', icon: Clock, label: 'Pending' },
      processing: { variant: 'outline', icon: Clock, label: 'Processing' },
      completed: { variant: 'success', icon: CheckCircle2, label: 'Completed' },
      failed: { variant: 'destructive', icon: AlertCircle, label: 'Failed' },
    };

    const { variant, icon: Icon, label } = variants[status];
    
    return (
      <Badge variant={variant} className="gap-1">
        <Icon className="size-3" />
        {label}
      </Badge>
    );
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <FileJson className="size-5" />
          Download Your Data
        </CardTitle>
        <CardDescription>
          Export all your TribeUp data in JSON format (GDPR compliant)
        </CardDescription>
      </CardHeader>
      
      <CardContent className="space-y-4">
        {/* Error Alert for Missing Table */}
        {historyError && (
          <Alert variant="destructive">
            <AlertCircle className="size-4" />
            <AlertDescription className="text-sm">
              <p className="font-medium mb-1">Database Setup Required</p>
              <p className="text-xs">
                The data export feature requires database migrations to be applied. 
                Please contact support or check the deployment documentation.
              </p>
            </AlertDescription>
          </Alert>
        )}

        {/* Information Alert */}
        <Alert>
          <Info className="size-4" />
          <AlertDescription className="text-sm">
            <p className="font-medium mb-2">Your export will include:</p>
            <ul className="list-disc list-inside space-y-1 text-muted-foreground">
              <li>Profile information and settings</li>
              <li>Games created and participated in</li>
              <li>Chat messages and notifications</li>
              <li>Tribe memberships and activities</li>
              <li>Connections, stats, and achievements</li>
            </ul>
            <p className="mt-2 text-muted-foreground">
              You can request one export every 24 hours. Your data will be downloaded as a JSON file.
            </p>
          </AlertDescription>
        </Alert>

        {/* Export Button */}
        <div className="flex flex-col gap-2">
          <Button
            onClick={handleExport}
            disabled={isExporting || !canRequestExport()}
            className="w-full sm:w-auto"
            size="lg"
          >
            {isExporting ? (
              <>
                <Clock className="mr-2 size-4 animate-spin" />
                Exporting...
              </>
            ) : (
              <>
                <Download className="mr-2 size-4" />
                Request Data Export
              </>
            )}
          </Button>

          {!canRequestExport() && (
            <p className="text-sm text-muted-foreground">
              Next export available: {getNextAvailableTime()?.toLocaleString()}
            </p>
          )}
        </div>

        {/* Export History */}
        {!isLoadingHistory && exportHistory && exportHistory.length > 0 && (
          <div className="space-y-2">
            <h4 className="text-sm font-semibold">Recent Exports</h4>
            <div className="space-y-2">
              {exportHistory.map((export_) => (
                <div
                  key={export_.id}
                  className="flex items-center justify-between p-3 rounded-lg border bg-card"
                >
                  <div className="flex flex-col gap-1">
                    <div className="flex items-center gap-2">
                      {getStatusBadge(export_.status)}
                      <span className="text-sm text-muted-foreground">
                        {formatDate(export_.requested_at)}
                      </span>
                    </div>
                    {export_.error_message && (
                      <p className="text-xs text-destructive">{export_.error_message}</p>
                    )}
                  </div>
                  {export_.completed_at && (
                    <CheckCircle2 className="size-4 text-success" />
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Privacy Assurance */}
        <Alert>
          <AlertCircle className="size-4" />
          <AlertDescription className="text-xs text-muted-foreground">
            Your privacy is important to us. This export only includes your personal data and is
            generated securely. The file is downloaded directly to your device and is not stored
            on our servers.
          </AlertDescription>
        </Alert>
      </CardContent>
    </Card>
  );
}

```

`domains/users/components/EditProfile.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Badge } from '@/shared/components/ui/badge';
import { ArrowLeft, Save, Upload, X } from 'lucide-react';
import { toast } from 'sonner';
import { SupabaseService } from '@/core/database/supabaseService';
import { useUpdateUserProfile } from '@/domains/users/hooks/useUserProfile';
import { useAppStore } from '@/store/appStore';
import { supabase } from '@/core/database/supabase';
import { useLayoutState } from '@/shared/hooks/useLayoutState';
import { useResponsive } from '@/shared/hooks/useResponsive';

interface ProfileFormData {
  fullName: string;
  username: string;
  bio: string;
  location: string;
  avatarUrl: string;
  sportsPreferences: string[];
}

const availableSports = [
  'Basketball', 'Soccer', 'Tennis', 'Volleyball', 'Football', 
  'Baseball', 'Swimming', 'Running', 'Cycling', 'Yoga'
];

function EditProfile() {
  const navigate = useNavigate();
  const { setUser } = useAppStore();
  const updateProfileMutation = useUpdateUserProfile();
  const loading = updateProfileMutation.isPending;
  const { layoutState } = useLayoutState();
  const { isMobile } = useResponsive();
  const { navigationHeight, shouldShowBottomNav } = layoutState;
  const [formData, setFormData] = useState<ProfileFormData>({
    fullName: '',
    username: '',
    bio: '',
    location: '',
    avatarUrl: '',
    sportsPreferences: []
  });
  const [usernameError, setUsernameError] = useState(null as string | null);
  const [checkingUsername, setCheckingUsername] = useState(false);
  const [selectedFile, setSelectedFile] = useState(null as File | null);
  const [previewUrl, setPreviewUrl] = useState('');
  const [avatarError, setAvatarError] = useState(null as string | null);
  const [authReady, setAuthReady] = useState(false);
  const [loadingProfile, setLoadingProfile] = useState(true);
  const initialFormRef = React.useRef(null as ProfileFormData | null);

  const BIO_MAX = 200;
  const USERNAME_REGEX = /^[a-zA-Z0-9._-]{3,20}$/;

  // Wait for auth to be ready before loading profile data
  useEffect(() => {
    const waitForAuth = async () => {
      try {
        // Ensure auth session is initialized before querying
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          console.error('‚ùå [EditProfile] Auth session error:', sessionError);
          toast.error('Authentication error. Please sign in again.');
          navigate('/auth');
          return;
        }

        if (!session || !session.user?.id) {
          console.warn('‚ö†Ô∏è [EditProfile] No authenticated session found');
          toast.error('Please sign in to edit your profile');
          navigate('/auth');
          return;
        }

        console.log('‚úÖ [EditProfile] Auth ready, user ID:', session.user.id);
        setAuthReady(true);

        // Now that auth is ready, load profile data from public.users
        // Use a single data source (public.users row), not session metadata
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('id, full_name, username, avatar_url, bio, location, preferred_sports')
          .eq('id', session.user.id)
          .single();

        if (userError) {
          console.error('‚ùå [EditProfile] Error loading profile from users table:', userError);
          toast.error('Failed to load profile data');
          setLoadingProfile(false);
          return;
        }

        if (!userData) {
          console.warn('‚ö†Ô∏è [EditProfile] User profile not found in users table');
          toast.error('Profile not found');
          setLoadingProfile(false);
          return;
        }

        // Transform database row to form data
        const loaded: ProfileFormData = {
          fullName: userData.full_name || '',
          username: userData.username || '',
          bio: userData.bio || '',
          location: userData.location || '',
          avatarUrl: userData.avatar_url || '',
          sportsPreferences: Array.isArray(userData.preferred_sports) ? userData.preferred_sports : []
        };
        
        setFormData(loaded);
        initialFormRef.current = loaded;
        setLoadingProfile(false);
        console.log('‚úÖ [EditProfile] Profile data loaded from public.users');
      } catch (error) {
        console.error('‚ùå [EditProfile] Exception loading profile:', error);
        toast.error('Failed to load profile data');
        setLoadingProfile(false);
      }
    };

    waitForAuth();
  }, [navigate]);

  // Debounced username availability check while typing (top-level)
  useEffect(() => {
    let timer: any;
    const uname = (formData.username || '').trim();
    if (!uname) {
      setUsernameError(null);
      return;
    }
    if (!USERNAME_REGEX.test(uname)) {
      setUsernameError('3-20 chars. Letters, numbers, dot, underscore, or hyphen.');
      return;
    }
    
    // If unchanged vs loaded form data, skip
    if (initialFormRef.current?.username && initialFormRef.current.username.trim().toLowerCase() === uname.toLowerCase()) {
      setUsernameError(null);
      return;
    }
    
    setCheckingUsername(true);
    timer = setTimeout(async () => {
      try {
        // Get current user ID from auth session (not store) to avoid timing issues
        const { data: { session } } = await supabase.auth.getSession();
        const currentUserId = session?.user?.id;
        if (!currentUserId) {
          setUsernameError('Please sign in to check username');
          setCheckingUsername(false);
          return;
        }
        const available = await SupabaseService.isUsernameAvailable(uname, currentUserId);
        setUsernameError(available ? null : 'Username is already taken');
      } catch {
        setUsernameError('Unable to validate username right now');
      } finally {
        setCheckingUsername(false);
      }
    }, 450);
    return () => clearTimeout(timer);
  }, [formData.username]);

  const handleInputChange = (field: keyof ProfileFormData, value: string | string[]) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
    if (field === 'username') {
      setUsernameError(null);
    }
    if (field === 'bio' && typeof value === 'string' && value.length > BIO_MAX) {
      // hard limit in UI
      setFormData(prev => ({ ...prev, bio: value.slice(0, BIO_MAX) }));
    }
  };

  const handleSportToggle = (sport: string) => {
    setFormData(prev => ({
      ...prev,
      sportsPreferences: prev.sportsPreferences.includes(sport)
        ? prev.sportsPreferences.filter(s => s !== sport)
        : [...prev.sportsPreferences, sport]
    }));
  };

  const handleUsernameBlur = async () => {
    // Get current user ID from auth session
    const { data: { session } } = await supabase.auth.getSession();
    const currentUserId = session?.user?.id;
    if (!currentUserId) return;

    const uname = (formData.username || '').trim();
    if (!uname) return;
    
    // client-side validation rules first
    if (!USERNAME_REGEX.test(uname)) {
      setUsernameError('3-20 chars. Letters, numbers, dot, underscore, or hyphen.');
      return;
    }
    
    // If unchanged vs loaded form data, skip
    if (initialFormRef.current?.username && initialFormRef.current.username.trim().toLowerCase() === uname.toLowerCase()) {
      return;
    }
    
    try {
      setCheckingUsername(true);
      const available = await SupabaseService.isUsernameAvailable(uname, currentUserId);
      if (!available) setUsernameError('Username is already taken');
    } catch (e) {
      setUsernameError('Unable to validate username right now');
    } finally {
      setCheckingUsername(false);
    }
  };

  const handleFileChange = (e: any) => {
    const file = e.target.files?.[0] || null;
    setSelectedFile(file);
    setAvatarError(null);
    if (file) {
      const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
      const maxBytes = 5 * 1024 * 1024; // 5MB
      if (!validTypes.includes(file.type)) {
        setAvatarError('Please upload a JPG, PNG, WEBP, or GIF image.');
        setSelectedFile(null);
        return;
      }
      if (file.size > maxBytes) {
        setAvatarError('Image is too large. Max size is 5 MB.');
        setSelectedFile(null);
        return;
      }
      const url = URL.createObjectURL(file);
      setPreviewUrl(url);
    } else {
      setPreviewUrl('');
    }
  };

  const handleSave = async () => {
    // Ensure auth is still ready before saving
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (sessionError || !session?.user?.id) {
      console.error('‚ùå [EditProfile] No authenticated session for save');
      toast.error('Please sign in to save your profile');
      navigate('/auth');
      return;
    }

    const currentUserId = session.user.id;
    console.log('üîß Starting profile save...', { userId: currentUserId, formData });

    try {
      // Validate username availability before save
      const uname = (formData.username || '').trim();
      if (uname) {
        if (!USERNAME_REGEX.test(uname)) {
          setUsernameError('3-20 chars. Letters, numbers, dot, underscore, or hyphen.');
          return;
        }
        const available = await SupabaseService.isUsernameAvailable(uname, currentUserId);
        if (!available) {
          setUsernameError('Username is already taken');
          return;
        }
      }

      // Upload avatar if a file is selected
      let finalAvatarUrl = formData.avatarUrl;
      if (selectedFile) {
        try {
          finalAvatarUrl = await SupabaseService.uploadAvatar(selectedFile);
          console.log('Avatar uploaded successfully:', finalAvatarUrl);
        } catch (avatarError) {
          console.error('Avatar upload failed:', avatarError);
          toast.error('Failed to upload profile picture. Profile will be saved without image.');
          // Continue with profile update even if avatar upload fails
        }
      }

      // Use React Query mutation for profile update
      updateProfileMutation.mutate({
        userId: currentUserId,
        profileData: {
          full_name: formData.fullName,
          username: formData.username,
          bio: formData.bio,
          location: formData.location,
          avatar_url: finalAvatarUrl,
          preferred_sports: formData.sportsPreferences
        }
      }, {
        onSuccess: (updatedProfile) => {
          console.log('‚úÖ Profile update successful:', updatedProfile);
          // Update the user in the store
          setUser(updatedProfile);
          navigate('/app/profile');
        },
        onError: (error) => {
          console.error('‚ùå Profile update failed:', error);
          toast.error('Failed to update profile: ' + error.message);
        }
      });
    } catch (error) {
      console.error('Error in profile save:', error);
      toast.error('Failed to validate profile data');
    }
  };

  const handleBack = () => {
    const isDirty = initialFormRef.current && JSON.stringify(initialFormRef.current) !== JSON.stringify(formData);
    if (isDirty) {
      const confirmLeave = window.confirm('Discard unsaved changes?');
      if (!confirmLeave) return;
    }
    navigate('/profile');
  };

  // Warn on browser/tab close if form is dirty
  useEffect(() => {
    const isDirty = initialFormRef.current && JSON.stringify(initialFormRef.current) !== JSON.stringify(formData);
    const beforeUnload = (e: BeforeUnloadEvent) => {
      if (isDirty) {
        e.preventDefault();
        e.returnValue = '';
      }
    };
    window.addEventListener('beforeunload', beforeUnload);
    return () => window.removeEventListener('beforeunload', beforeUnload);
  }, [formData]);

  const isDirty = (initialFormRef.current && JSON.stringify(initialFormRef.current) !== JSON.stringify(formData)) || selectedFile !== null;

  // Show loading state while waiting for auth and profile data
  if (!authReady || loadingProfile) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Loading profile...</p>
        </div>
      </div>
    );
  }

  // Calculate bottom padding for content area to account for fixed button
  const buttonHeight = 80; // Approximate height of button container (button + padding)
  const contentBottomPadding = isMobile && shouldShowBottomNav
    ? buttonHeight + navigationHeight + 16
    : buttonHeight + 16;

  return (
    <div className="min-h-screen bg-background" style={{ paddingBottom: `${contentBottomPadding}px` }}>
      {/* Header */}
      <div className="flex items-center gap-4 px-4 pt-12 pb-6">
        <Button variant="ghost" size="icon" onClick={handleBack}>
          <ArrowLeft className="w-5 h-5" />
        </Button>
        <h1 className="text-xl font-semibold">Edit Profile</h1>
      </div>

      <div className="px-4 space-y-6 pb-6">
        {/* Profile Picture */}
        <Card>
          <CardHeader>
            <CardTitle>Profile Picture</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-4">
              <Avatar className="w-20 h-20">
                {(previewUrl || formData.avatarUrl) && (
                  <AvatarImage src={previewUrl || formData.avatarUrl} alt="Avatar preview" />
                )}
                <AvatarFallback className="text-xl">
                  {formData.fullName ? formData.fullName.charAt(0).toUpperCase() : 'U'}
                </AvatarFallback>
              </Avatar>
              <div className="flex-1">
                <div className="flex items-center gap-3">
                  <Input type="file" accept="image/*" onChange={handleFileChange} />
                  <Upload className="w-4 h-4 text-muted-foreground" />
                </div>
                <p className="text-sm text-muted-foreground mt-1">Upload an image for your avatar</p>
                {avatarError && (
                  <p className="text-xs text-red-500 mt-1" role="alert" aria-live="polite">{avatarError}</p>
                )}
                {/* Preview now shown inside Avatar above */}
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Basic Information */}
        <Card>
          <CardHeader>
            <CardTitle>Basic Information</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <label className="text-sm font-medium mb-2 block">Full Name</label>
              <Input
                value={formData.fullName}
                onChange={(e) => handleInputChange('fullName', e.target.value)}
              />
            </div>
            
            <div>
              <label className="text-sm font-medium mb-2 block">Username <span className="text-muted-foreground font-normal">(3‚Äì20 chars)</span></label>
              <Input
                value={formData.username}
                onChange={(e) => handleInputChange('username', e.target.value)}
                onBlur={handleUsernameBlur}
                aria-describedby={
                  usernameError ? 'username-error' : 'username-help'
                }
              />
              {checkingUsername && (
                <p className="text-xs text-muted-foreground mt-1" aria-live="polite">Checking availability‚Ä¶</p>
              )}
              {usernameError && (
                <p id="username-error" className="text-xs text-red-500 mt-1" role="alert" aria-live="polite">{usernameError}</p>
              )}
              {!usernameError && !checkingUsername && formData.username && (
                <p id="username-help" className="text-xs text-muted-foreground mt-1">Allowed: letters, numbers, dot, underscore, hyphen.</p>
              )}
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">Location</label>
              <Input
                value={formData.location}
                onChange={(e) => handleInputChange('location', e.target.value)}
              />
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">Bio <span className="text-muted-foreground font-normal">(max {BIO_MAX} chars)</span></label>
              <Textarea
                value={formData.bio}
                onChange={(e) => handleInputChange('bio', e.target.value)}
                rows={3}
                maxLength={BIO_MAX}
                aria-describedby="bio-counter"
              />
              <div className="flex justify-end">
                <span id="bio-counter" className={`text-xs ${formData.bio.length >= BIO_MAX ? 'text-red-500' : 'text-muted-foreground'}`}>{formData.bio.length}/{BIO_MAX}</span>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Sports Preferences */}
        <Card>
          <CardHeader>
            <CardTitle>Sports I Play</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-2">
              {availableSports.map((sport) => (
                <Badge
                  key={sport}
                  variant={formData.sportsPreferences.includes(sport) ? "default" : "secondary"}
                  className="cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() => handleSportToggle(sport)}
                >
                  {sport}
                  {formData.sportsPreferences.includes(sport) && (
                    <X className="w-3 h-3 ml-1" />
                  )}
                </Badge>
              ))}
            </div>
            <p className="text-sm text-muted-foreground mt-3">
              Click on sports to add or remove them from your preferences
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Fixed Save Button at Bottom - mobile-friendly, respects safe area and bottom nav */}
      <div 
        className="fixed bottom-0 left-0 right-0 p-4 bg-background border-t border-border z-50"
        style={{ 
          paddingBottom: isMobile && shouldShowBottomNav 
            ? `calc(env(safe-area-inset-bottom, 0px) + ${navigationHeight}px + 16px)`
            : 'calc(env(safe-area-inset-bottom, 0px) + 16px)'
        }}
      >
        <Button 
          onClick={handleSave} 
          disabled={!isDirty || loading || checkingUsername || !!usernameError || !!avatarError || !formData.fullName || !formData.username}
          className="w-full h-12 text-base font-semibold flex items-center justify-center gap-2"
        >
          <Save className="w-4 h-4" />
          {loading ? 'Saving...' : 'Save Changes'}
        </Button>
      </div>
    </div>
  );
}

export default EditProfile;

```

`domains/users/components/FeedbackButton.tsx`:

```tsx
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { MessageSquare } from 'lucide-react';

interface FeedbackButtonProps {
  variant?: 'default' | 'outline' | 'ghost';
  size?: 'sm' | 'default' | 'lg';
  className?: string;
  showText?: boolean;
}

export function FeedbackButton({ 
  variant = 'outline', 
  size = 'default', 
  className = '',
  showText = true 
}: FeedbackButtonProps) {
  const navigate = useNavigate();

  return (
    <Button
      variant={variant}
      size={size}
      onClick={() => navigate('/app/feedback')}
      className={className}
    >
      <MessageSquare className="w-4 h-4" />
      {showText && <span className="ml-2">Feedback</span>}
    </Button>
  );
}

```

`domains/users/components/FeedbackPage.tsx`:

```tsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { RadioGroup, RadioGroupItem } from '@/shared/components/ui/radio-group';
import { Checkbox } from '@/shared/components/ui/checkbox';
import { Label } from '@/shared/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { Progress } from '@/shared/components/ui/progress';
import { ArrowLeft, CheckCircle, MessageSquare, Send, Bug, Lightbulb, Star } from 'lucide-react';
import { SupabaseService } from '@/core/database/supabaseService';
import { toast } from 'sonner';

interface FeedbackData {
  tester_name: string;
  device_browser: string;
  session_duration: string;
  signup_success: string;
  signup_method: string[];
  create_game: string;
  join_game: string;
  onboarding_rating: number;
  game_creation_rating: number;
  navigation_rating: number;
  performance_rating: number;
  technical_issues: string[];
  bug_details: string;
  positive_feedback: string;
  confusion_feedback: string;
  missing_features: string;
  likelihood_rating: number;
  additional_comments: string;
  trigger_context: string;
}

function FeedbackPage() {
  const navigate = useNavigate();
  const [currentSection, setCurrentSection] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [formData, setFormData] = useState<Partial<FeedbackData>>({
    trigger_context: 'feedback_page',
    signup_method: [],
    technical_issues: []
  });

  const totalSections = 3;
  const progress = (currentSection / totalSections) * 100;

  const updateFormData = (field: keyof FeedbackData, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleArrayUpdate = (field: 'signup_method' | 'technical_issues', value: string, checked: boolean) => {
    const currentArray = formData[field] || [];
    if (checked) {
      updateFormData(field, [...currentArray, value]);
    } else {
      updateFormData(field, currentArray.filter(item => item !== value));
    }
  };

  const handleSubmit = async () => {
    setIsSubmitting(true);
    try {
      const surveyData = {
        ...formData,
        signup_method: formData.signup_method?.join(',') || '',
        technical_issues: formData.technical_issues?.join(',') || '',
        submitted_at: new Date().toISOString()
      };

      await SupabaseService.submitUserTestingFeedback(surveyData);
      
      setIsSubmitted(true);
      toast.success('Thank you! Your feedback has been submitted.');
      
      // Auto-redirect after 3 seconds
      setTimeout(() => {
        navigate('/');
      }, 3000);
      
    } catch (error) {
      console.error('Feedback submission error:', error);
      toast.error('Failed to submit feedback. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const RatingScale = ({ name, value, onChange, required = false }: {
    name: string;
    value: number;
    onChange: (value: number) => void;
    required?: boolean;
  }) => (
    <div className="space-y-2">
      <div className="flex justify-between items-center bg-muted p-4 rounded-lg">
        <RadioGroup
          value={value?.toString()}
          onValueChange={(val: string) => onChange(parseInt(val))}
          className="flex gap-4"
        >
          {[1, 2, 3, 4, 5].map((num) => (
            <div key={num} className="flex flex-col items-center space-y-1">
              <RadioGroupItem value={num.toString()} id={`${name}-${num}`} />
              <Label htmlFor={`${name}-${num}`} className="text-sm">{num}</Label>
            </div>
          ))}
        </RadioGroup>
      </div>
      <div className="flex justify-between text-xs text-muted-foreground">
        <span>Poor</span>
        <span>Excellent</span>
      </div>
    </div>
  );

  if (isSubmitted) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardContent className="text-center space-y-4 py-8">
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto" />
            <h2 className="text-2xl font-semibold">Thank You!</h2>
            <p className="text-muted-foreground">
              Your feedback has been recorded and will help improve TribeUp. 
              You'll be redirected to the home page shortly.
            </p>
            <Button onClick={() => navigate('/')} className="mt-4">
              Return Home
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="border-b bg-card">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Button variant="ghost" size="icon" onClick={() => navigate('/')}>
                <ArrowLeft className="w-4 h-4" />
              </Button>
              <div className="flex items-center gap-2">
                <MessageSquare className="w-5 h-5 text-primary" />
                <h1 className="text-xl font-semibold">Help Improve TribeUp</h1>
              </div>
            </div>
          </div>
          <div className="mt-4 space-y-2">
            <Progress value={progress} className="w-full" />
            <p className="text-sm text-muted-foreground">
              Section {currentSection} of {totalSections} ‚Ä¢ Your feedback helps us build a better experience
            </p>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="max-w-4xl mx-auto px-4 py-8">
        <div className="space-y-8">
          {/* Section 1: Your Experience */}
          {currentSection === 1 && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Star className="w-5 h-5" />
                  Rate Your Experience
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label className="text-base font-medium">How intuitive was the overall experience?</Label>
                  <RatingScale
                    name="onboarding"
                    value={formData.onboarding_rating || 0}
                    onChange={(value) => updateFormData('onboarding_rating', value)}
                  />
                </div>

                <div>
                  <Label className="text-base font-medium">How easy was it to find and join games?</Label>
                  <RatingScale
                    name="navigation"
                    value={formData.navigation_rating || 0}
                    onChange={(value) => updateFormData('navigation_rating', value)}
                  />
                </div>

                <div>
                  <Label className="text-base font-medium">How was the overall app performance?</Label>
                  <RatingScale
                    name="performance"
                    value={formData.performance_rating || 0}
                    onChange={(value) => updateFormData('performance_rating', value)}
                  />
                </div>

                <div>
                  <Label className="text-base font-medium">How likely would you be to use TribeUp?</Label>
                  <RatingScale
                    name="likelihood"
                    value={formData.likelihood_rating || 0}
                    onChange={(value) => updateFormData('likelihood_rating', value)}
                  />
                  <div className="flex justify-between text-xs text-muted-foreground mt-2">
                    <span>Very unlikely</span>
                    <span>Very likely</span>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Section 2: What Worked & What Didn't */}
          {currentSection === 2 && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Lightbulb className="w-5 h-5" />
                  Your Feedback
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label htmlFor="positive_feedback">What did you like most about TribeUp?</Label>
                  <Textarea
                    id="positive_feedback"
                    value={formData.positive_feedback || ''}
                    onChange={(e) => updateFormData('positive_feedback', e.target.value)}
                    placeholder="Tell us what worked well..."
                    rows={3}
                  />
                </div>

                <div>
                  <Label htmlFor="confusion_feedback">What was confusing or frustrating?</Label>
                  <Textarea
                    id="confusion_feedback"
                    value={formData.confusion_feedback || ''}
                    onChange={(e) => updateFormData('confusion_feedback', e.target.value)}
                    placeholder="Help us understand what didn't work well..."
                    rows={3}
                  />
                </div>

                <div>
                  <Label htmlFor="missing_features">What features would you like to see?</Label>
                  <Textarea
                    id="missing_features"
                    value={formData.missing_features || ''}
                    onChange={(e) => updateFormData('missing_features', e.target.value)}
                    placeholder="What functionality would make this better?"
                    rows={3}
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Section 3: Technical Issues & Additional Comments */}
          {currentSection === 3 && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Bug className="w-5 h-5" />
                  Technical Issues & Final Thoughts
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label htmlFor="bug_details">Did you encounter any bugs or technical issues?</Label>
                  <Textarea
                    id="bug_details"
                    value={formData.bug_details || ''}
                    onChange={(e) => updateFormData('bug_details', e.target.value)}
                    placeholder="Describe any errors, crashes, or unexpected behavior (optional)..."
                    rows={3}
                  />
                </div>

                <div>
                  <Label htmlFor="additional_comments">Any other feedback or suggestions?</Label>
                  <Textarea
                    id="additional_comments"
                    value={formData.additional_comments || ''}
                    onChange={(e) => updateFormData('additional_comments', e.target.value)}
                    placeholder="Share any other thoughts about your experience..."
                    rows={4}
                  />
                </div>

                <div>
                  <Label htmlFor="device_browser">What device and browser are you using? (optional)</Label>
                  <Select value={formData.device_browser} onValueChange={(value) => updateFormData('device_browser', value)}>
                    <SelectTrigger>
                      <SelectValue placeholder="Select device and browser" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="desktop_chrome">Desktop - Chrome</SelectItem>
                      <SelectItem value="desktop_safari">Desktop - Safari</SelectItem>
                      <SelectItem value="desktop_firefox">Desktop - Firefox</SelectItem>
                      <SelectItem value="mobile_ios_safari">Mobile - iOS Safari</SelectItem>
                      <SelectItem value="mobile_android_chrome">Mobile - Android Chrome</SelectItem>
                      <SelectItem value="other">Other</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Navigation Buttons */}
          <div className="flex justify-between pt-4">
            <Button
              variant="outline"
              onClick={() => setCurrentSection(prev => Math.max(1, prev - 1))}
              disabled={currentSection === 1}
            >
              Previous
            </Button>

            {currentSection < totalSections ? (
              <Button
                onClick={() => setCurrentSection(prev => Math.min(totalSections, prev + 1))}
              >
                Next
              </Button>
            ) : (
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600"
              >
                <Send className="w-4 h-4 mr-2" />
                {isSubmitting ? 'Submitting...' : 'Submit Feedback'}
              </Button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default FeedbackPage;

```

`domains/users/components/FriendList.tsx`:

```tsx
import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Badge } from '@/shared/components/ui/badge';
import { Input } from '@/shared/components/ui/input';
import { Users, Search, UserPlus, UserMinus, Loader2 } from 'lucide-react';
import { useFriends, useUserSearch } from '../hooks/useFriends';
import { FriendSuggestion } from '../services/friendService';
import { toast } from 'sonner';
import { useDeepLinks } from '@/shared/hooks/useDeepLinks';

interface FriendListProps {
  onClose?: () => void;
  showSearch?: boolean;
  maxSuggestions?: number;
}

export function FriendList({
  onClose,
  showSearch = true,
  maxSuggestions = 10
}: FriendListProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [showSuggestions, setShowSuggestions] = useState(!showSearch);
  const { navigateToUser } = useDeepLinks();

  const {
    suggestions,
    isLoadingSuggestions,
    followUser,
    isFollowingLoading
  } = useFriends();

  const {
    data: searchResults,
    isLoading: isSearching,
    error: searchError
  } = useUserSearch(searchQuery, showSearch && searchQuery.length > 2);

  const displayedUsers = showSearch && searchQuery.length > 2
    ? searchResults || []
    : suggestions.slice(0, maxSuggestions);

  const handleFollow = async (userId: string, userName: string) => {
    try {
      await followUser(userId);
      toast.success(`Followed ${userName}!`);
    } catch (error) {
      toast.error('Failed to follow user');
    }
  };

  const UserCard = ({ user, showFollowButton = true }: {
    user: FriendSuggestion | any;
    showFollowButton?: boolean;
  }) => {
    const isSuggestion = 'common_games_count' in user;
    // display_name is now a generated column, always present (from full_name, username, or email)
    const displayName = user.display_name || 'User';
    const isFollowing = user.is_following || false;

    return (
      <div className="flex items-center justify-between p-3 border border-border rounded-lg hover:bg-muted/50 transition-colors">
        <div 
          className="flex items-center gap-3 flex-1 min-w-0 cursor-pointer"
          onClick={() => navigateToUser(user.id)}
        >
          <Avatar className="w-10 h-10 flex-shrink-0">
            <AvatarImage src={user.avatar_url || undefined} alt={displayName} />
            <AvatarFallback>
              {displayName.charAt(0).toUpperCase()}
            </AvatarFallback>
          </Avatar>

          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2">
              <h4 className="font-medium text-sm truncate">{displayName}</h4>
              {isSuggestion && (
                <Badge variant="secondary" className="text-xs">
                  {user.common_games_count} {user.common_games_count !== 1 ? 'activities' : 'activity'} together
                </Badge>
              )}
            </div>
            {user.bio && (
              <p className="text-xs text-muted-foreground truncate mt-1">
                {user.bio}
              </p>
            )}
          </div>
        </div>

        {showFollowButton && (
          <Button
            size="sm"
            variant={isFollowing ? "outline" : "default"}
            onClick={(e) => {
              e.stopPropagation();
              handleFollow(user.id, displayName);
            }}
            disabled={isFollowingLoading}
            className="flex-shrink-0 ml-2"
          >
            {isFollowingLoading ? (
              <Loader2 className="w-3 h-3 animate-spin" />
            ) : isFollowing ? (
              <>
                <UserMinus className="w-3 h-3 mr-1" />
                Following
              </>
            ) : (
              <>
                <UserPlus className="w-3 h-3 mr-1" />
                Follow
              </>
            )}
          </Button>
        )}
      </div>
    );
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2">
            <Users className="w-5 h-5" />
            {showSearch && searchQuery.length > 2 ? 'Search Results' : 'Suggestions'}
          </CardTitle>
          {onClose && (
            <Button variant="ghost" size="sm" onClick={onClose}>
              √ó
            </Button>
          )}
        </div>

        {showSearch && (
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
            <Input
              placeholder="Search users by name..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-9"
            />
          </div>
        )}
      </CardHeader>

      <CardContent className="space-y-3">
        {isLoadingSuggestions && displayedUsers.length === 0 ? (
          <div className="text-center py-8">
            <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2 text-muted-foreground" />
            <p className="text-sm text-muted-foreground">Loading suggestions...</p>
          </div>
        ) : displayedUsers.length === 0 ? (
          <div className="text-center py-8">
            <Users className="w-12 h-12 text-muted-foreground mx-auto mb-3" />
            <h3 className="font-medium text-sm mb-1">
              {showSearch && searchQuery.length > 2 ? 'No users found' : 'No suggestions yet'}
            </h3>
            <p className="text-xs text-muted-foreground">
              {showSearch && searchQuery.length > 2
                ? 'Try a different search term'
                : 'Join some activities to get personalized suggestions!'
              }
            </p>
          </div>
        ) : (
          <div className="space-y-2">
            {displayedUsers.map((user) => (
              <UserCard key={user.id} user={user} />
            ))}

            {!showSearch && suggestions.length > maxSuggestions && (
              <div className="text-center pt-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowSuggestions(!showSuggestions)}
                >
                  {showSuggestions ? 'Show Less' : `Show ${suggestions.length - maxSuggestions} More`}
                </Button>
              </div>
            )}
          </div>
        )}

        {searchError && (
          <div className="text-center py-4">
            <p className="text-sm text-destructive">
              Failed to search users. Please try again.
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

```

`domains/users/components/InviteFriends.tsx`:

```tsx
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/shared/components/ui/dialog';
import { Button } from '@/shared/components/ui/button';
import { FriendList } from './FriendList';
import { UserPlus, Share2 } from 'lucide-react';
import { toast } from 'sonner';

interface InviteFriendsProps {
  gameId?: string;
  gameTitle?: string;
  trigger?: React.ReactNode;
  onInviteSent?: (userIds: string[]) => void;
}

export function InviteFriends({
  gameId,
  gameTitle,
  trigger,
  onInviteSent
}: InviteFriendsProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [invitedUsers, setInvitedUsers] = useState<string[]>([]);

  const handleInvite = async (userId: string, userName: string) => {
    // For now, just add to invited list and show success
    // TODO: Implement actual invitation system when notifications are ready
    if (!invitedUsers.includes(userId)) {
      setInvitedUsers(prev => [...prev, userId]);
      toast.success(`Invited ${userName} to ${gameTitle || 'your game'}!`);
    }
  };

  const handleSendInvites = () => {
    if (invitedUsers.length > 0) {
      onInviteSent?.(invitedUsers);
      toast.success(`Sent ${invitedUsers.length} invitation${invitedUsers.length > 1 ? 's' : ''}!`);
      setInvitedUsers([]);
      setIsOpen(false);
    }
  };

  const handleShareGame = async () => {
    if (!gameId) return;

    const gameUrl = `${window.location.origin}/public/game/${gameId}`;

    try {
      if (navigator.share) {
        await navigator.share({
          title: gameTitle || 'Join my game!',
          text: `Join me for ${gameTitle || 'a game'} on TribeUp!`,
          url: gameUrl,
        });
      } else {
        await navigator.clipboard.writeText(gameUrl);
        toast.success('Game link copied to clipboard!');
      }
    } catch (error) {
      console.error('Error sharing game:', error);
      toast.error('Failed to share game link');
    }
  };

  const defaultTrigger = (
    <Button variant="outline" size="sm" className="gap-2">
      <UserPlus className="w-4 h-4" />
      Invite Players
    </Button>
  );

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>
        {trigger || defaultTrigger}
      </DialogTrigger>

      <DialogContent className="max-w-md max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <UserPlus className="w-5 h-5" />
            Invite Players to {gameTitle || 'Your Game'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* Share Game Link */}
          <div className="flex gap-2">
            <Button
              variant="outline"
              onClick={handleShareGame}
              className="flex-1 gap-2"
              disabled={!gameId}
            >
              <Share2 className="w-4 h-4" />
              Share Game Link
            </Button>
          </div>

          {/* Friend Suggestions */}
          <div>
            <h4 className="font-medium text-sm mb-3">Suggested Players</h4>
            <FriendList
              showSearch={false}
              maxSuggestions={5}
            />
          </div>

          {/* Action Buttons */}
          <div className="flex gap-2 pt-4 border-t">
            <Button variant="outline" onClick={() => setIsOpen(false)} className="flex-1">
              Cancel
            </Button>
            <Button
              onClick={handleSendInvites}
              disabled={invitedUsers.length === 0}
              className="flex-1"
            >
              Send {invitedUsers.length > 0 ? `${invitedUsers.length} ` : ''}Invite{invitedUsers.length !== 1 ? 's' : ''}
            </Button>
          </div>

          {invitedUsers.length > 0 && (
            <p className="text-xs text-muted-foreground text-center">
              {invitedUsers.length} player{invitedUsers.length > 1 ? 's' : ''} will be invited when you create the game
            </p>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}

```

`domains/users/components/LeaderboardPage.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Leaderboard, type LeaderboardPlayer } from '@/shared/components/ui';
import { ArrowLeft, Trophy } from 'lucide-react';
import { useAppStore } from '@/store/appStore';

/**
 * Leaderboard Page
 * 
 * Displays rankings of players based on various metrics.
 */
export default function LeaderboardPage() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const [sortKey, setSortKey] = useState<string>('rating');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');

  // Mock leaderboard data - Replace with actual data fetching
  const mockPlayers: LeaderboardPlayer[] = [
    {
      id: '1',
      name: 'John Doe',
      rank: 1,
      stats: { gamesPlayed: 50, wins: 35, rating: 4.8 },
    },
    {
      id: '2',
      name: 'Jane Smith',
      rank: 2,
      stats: { gamesPlayed: 45, wins: 30, rating: 4.7 },
    },
    {
      id: '3',
      name: 'Mike Johnson',
      rank: 3,
      stats: { gamesPlayed: 40, wins: 28, rating: 4.6 },
    },
    {
      id: '4',
      name: 'Sarah Williams',
      rank: 4,
      stats: { gamesPlayed: 35, wins: 25, rating: 4.5 },
    },
    {
      id: '5',
      name: 'Tom Brown',
      rank: 5,
      stats: { gamesPlayed: 30, wins: 20, rating: 4.4 },
    },
  ];

  const handleSort = (key: string) => {
    if (sortKey === key) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortKey(key);
      setSortDirection('desc');
    }
  };

  const handlePlayerClick = (player: LeaderboardPlayer) => {
    if (player.id) {
      navigate(`/user/${player.id}`);
    }
  };

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="flex items-center gap-4 px-4 py-4">
          <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>
            <ArrowLeft className="size-5" />
          </Button>
          <div className="flex items-center gap-2">
            <Trophy className="size-6 text-primary" />
            <h1 className="text-xl font-bold">Leaderboard</h1>
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-8">
        <Card>
          <CardHeader>
            <CardTitle>Top Players</CardTitle>
          </CardHeader>
          <CardContent>
            <Leaderboard
              players={mockPlayers}
              columns={[
                { key: 'name', label: 'Player', sortable: false },
                { key: 'gamesPlayed', label: 'Games', sortable: true },
                { key: 'wins', label: 'Wins', sortable: true },
                { key: 'rating', label: 'Rating', sortable: true },
              ]}
              onSort={handleSort}
              sortKey={sortKey}
              sortDirection={sortDirection}
              onPlayerClick={handlePlayerClick}
              currentUserId={user?.id}
            />
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


```

`domains/users/components/NotificationSettings.tsx`:

```tsx
import React from 'react';
// import { motion } from 'framer-motion'; // TEMPORARILY DISABLED
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Switch } from '@/shared/components/ui/switch';
import { Badge } from '@/shared/components/ui/badge';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { 
  Bell, 
  BellOff, 
  Smartphone, 
  Mail, 
  MessageSquare, 
  Calendar,
  Users,
  Trophy,
  AlertTriangle,
  CheckCircle,
  XCircle,
  RefreshCw
} from 'lucide-react';
import { usePushNotifications } from '@/domains/users/hooks/usePushNotifications';
import { useNotifications } from '@/domains/users/hooks/useNotifications';
import { toast } from 'sonner';

function NotificationSettings() {
  const {
    isSupported,
    permission,
    isSubscribed,
    isLoading,
    error,
    canSubscribe,
    shouldRequestPermission,
    requestPermission,
    subscribe,
    unsubscribe,
    sendTestNotification
  } = usePushNotifications();

  const {
    settings,
    updateSettings,
    requestPermission: requestNotificationPermission
  } = useNotifications();

  const getPermissionIcon = () => {
    switch (permission) {
      case 'granted':
        return <CheckCircle className="w-5 h-5 text-green-500" />;
      case 'denied':
        return <XCircle className="w-5 h-5 text-red-500" />;
      default:
        return <AlertTriangle className="w-5 h-5 text-yellow-500" />;
    }
  };

  const getPermissionText = () => {
    switch (permission) {
      case 'granted':
        return 'Notifications enabled';
      case 'denied':
        return 'Notifications blocked';
      default:
        return 'Permission pending';
    }
  };

  const handleTogglePushNotifications = async () => {
    if (isSubscribed) {
      await unsubscribe();
    } else if (canSubscribe) {
      await subscribe();
    } else if (shouldRequestPermission) {
      await requestPermission();
    }
  };

  return (
    <div className="space-y-6">
      {/* Push Notifications Status */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Bell className="w-5 h-5" />
            Push Notifications
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {!isSupported ? (
            <Alert>
              <AlertTriangle className="w-4 h-4" />
              <AlertDescription>
                Push notifications are not supported in your browser. Please use a modern browser like Chrome, Firefox, or Safari.
              </AlertDescription>
            </Alert>
          ) : (
            <>
              {/* Permission Status */}
              <div className="flex items-center justify-between p-3 bg-muted/50 rounded-lg">
                <div className="flex items-center gap-3">
                  {getPermissionIcon()}
                  <div>
                    <div className="font-medium">{getPermissionText()}</div>
                    <div className="text-sm text-muted-foreground">
                      {permission === 'granted' && isSubscribed && 'You\'ll receive notifications for important updates'}
                      {permission === 'granted' && !isSubscribed && 'Click to enable push notifications'}
                      {permission === 'denied' && 'Enable notifications in your browser settings'}
                      {permission === 'default' && 'Click to enable notifications'}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {isSubscribed && (
                    <Badge variant="secondary" className="bg-green-500/10 text-green-600">
                      Active
                    </Badge>
                  )}
                  <Switch
                    checked={isSubscribed}
                    onCheckedChange={handleTogglePushNotifications}
                    disabled={isLoading || (permission === 'denied')}
                  />
                </div>
              </div>

              {/* Error State */}
              {error && (
                <Alert variant="destructive">
                  <XCircle className="w-4 h-4" />
                  <AlertDescription>{error}</AlertDescription>
                </Alert>
              )}

              {/* Test Notification */}
              {isSubscribed && (
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">Test Notifications</div>
                    <div className="text-sm text-muted-foreground">
                      Send a test notification to verify everything works
                    </div>
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={sendTestNotification}
                    disabled={isLoading}
                  >
                    {isLoading ? <LoadingSpinner size="sm" /> : 'Send Test'}
                  </Button>
                </div>
              )}
            </>
          )}
        </CardContent>
      </Card>

      {/* Notification Preferences */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Smartphone className="w-5 h-5" />
            Notification Types
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <MessageSquare className="w-5 h-5 text-muted-foreground" />
              <div>
                <div className="font-medium">New Messages</div>
                <div className="text-sm text-muted-foreground">
                  Get notified when someone sends you a message
                </div>
              </div>
            </div>
            <Switch
              checked={settings.messageNotifications}
              onCheckedChange={(checked) => updateSettings({ messageNotifications: checked })}
            />
          </div>

          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Calendar className="w-5 h-5 text-muted-foreground" />
              <div>
                <div className="font-medium">Game Reminders</div>
                <div className="text-sm text-muted-foreground">
                  Reminders before your games start
                </div>
              </div>
            </div>
            <Switch
              checked={settings.gameReminders}
              onCheckedChange={(checked) => updateSettings({ gameReminders: checked })}
            />
          </div>

          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Users className="w-5 h-5 text-muted-foreground" />
              <div>
                <div className="font-medium">Game Updates</div>
                <div className="text-sm text-muted-foreground">
                  When someone joins or leaves your games
                </div>
              </div>
            </div>
            <Switch
              checked={settings.pushNotifications}
              onCheckedChange={(checked) => updateSettings({ pushNotifications: checked })}
            />
          </div>

          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Mail className="w-5 h-5 text-muted-foreground" />
              <div>
                <div className="font-medium">Email Notifications</div>
                <div className="text-sm text-muted-foreground">
                  Weekly summary and important updates
                </div>
              </div>
            </div>
            <Switch
              checked={settings.emailNotifications}
              onCheckedChange={(checked) => updateSettings({ emailNotifications: checked })}
            />
          </div>
        </CardContent>
      </Card>

      {/* Sound Settings */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Trophy className="w-5 h-5" />
            Sound & Vibration
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium">Notification Sounds</div>
              <div className="text-sm text-muted-foreground">
                Play a sound when you receive notifications
              </div>
            </div>
            <Switch
              checked={settings.soundEnabled}
              onCheckedChange={(checked) => updateSettings({ soundEnabled: checked })}
            />
          </div>
        </CardContent>
      </Card>

      {/* Quick Actions */}
      <Card>
        <CardHeader>
          <CardTitle>Quick Actions</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Button
            variant="outline"
            className="w-full justify-start"
            onClick={() => {
              updateSettings({
                pushNotifications: true,
                messageNotifications: true,
                gameReminders: true,
                soundEnabled: true
              });
              // Removed toast - settings change is visible in UI
            }}
          >
            <Bell className="w-4 h-4 mr-2" />
            Enable All Notifications
          </Button>

          <Button
            variant="outline"
            className="w-full justify-start"
            onClick={() => {
              updateSettings({
                pushNotifications: false,
                messageNotifications: false,
                gameReminders: false,
                soundEnabled: false
              });
              // Removed toast - settings change is visible in UI
            }}
          >
            <BellOff className="w-4 h-4 mr-2" />
            Disable All Notifications
          </Button>

          <Button
            variant="outline"
            className="w-full justify-start"
            onClick={() => {
              // Reset to defaults
              updateSettings({
                pushNotifications: true,
                emailNotifications: false,
                gameReminders: true,
                messageNotifications: true,
                soundEnabled: true
              });
              // Removed toast - settings change is visible in UI
            }}
          >
            <RefreshCw className="w-4 h-4 mr-2" />
            Reset to Defaults
          </Button>
        </CardContent>
      </Card>

      {/* Browser Instructions */}
      {permission === 'denied' && (
        <Alert>
          <AlertTriangle className="w-4 h-4" />
          <AlertDescription>
            <div className="space-y-2">
              <div className="font-medium">Notifications are blocked</div>
              <div className="text-sm">
                To enable notifications:
                <ol className="list-decimal list-inside mt-2 space-y-1">
                  <li>Click the üîí icon in your browser's address bar</li>
                  <li>Select "Notifications" and choose "Allow"</li>
                  <li>Refresh this page</li>
                </ol>
              </div>
            </div>
          </AlertDescription>
        </Alert>
      )}
    </div>
  );
}

export default NotificationSettings;
```

`domains/users/components/Onboarding.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback } from '@/shared/components/ui/avatar';
import { Progress } from '@/shared/components/ui/progress';
import { 
  ArrowRight, 
  MapPin, 
  Camera, 
  Check,
  Users,
  Calendar,
  Trophy,
  Shield,
  Plus,
  Search,
  Sparkles,
  Zap,
  TrendingUp
} from 'lucide-react';
import { ImageWithFallback } from '@/shared/components/figma/ImageWithFallback';
import { useNavigate } from 'react-router-dom';
import { useSimpleAuth } from '@/core/auth/SimpleAuthProvider';
import { SupabaseService } from '@/core/database/supabaseService';
import { supabase } from '@/core/database/supabase';
import { toast } from 'sonner';
import { LocationPermissionModal } from '@/domains/locations/components/LocationPermissionModal';
import { OnboardingGameBrowse } from './OnboardingGameBrowse';
import { OnboardingGameCreate } from './OnboardingGameCreate';

interface OnboardingProps {
  onComplete: (data: any) => void;
}

const onboardingSteps = [
  { id: 1, title: 'Welcome', description: 'Find your activity, find your tribe' },
  { id: 2, title: 'Sports', description: 'Choose your favorite sports' },
  { id: 3, title: 'Location', description: 'Find activities near you' },
  { id: 4, title: 'Profile', description: 'Set up your profile' },
  { id: 5, title: 'First Game', description: 'Create or join your first game' },
];

const sportsOptions = [
  { name: 'Basketball', icon: 'üèÄ', color: 'bg-sport-basketball' },
  { name: 'Soccer', icon: '‚öΩ', color: 'bg-sport-soccer' },
  { name: 'Tennis', icon: 'üéæ', color: 'bg-sport-tennis' },
  { name: 'Pickleball', icon: 'ü•í', color: 'bg-success' },
  { name: 'Volleyball', icon: 'üèê', color: 'bg-sport-volleyball' },
  { name: 'Football', icon: 'üèà', color: 'bg-sport-football' },
  { name: 'Baseball', icon: '‚öæ', color: 'bg-sport-baseball' },
  { name: 'Running', icon: 'üèÉ', color: 'bg-primary' },
  { name: 'Cycling', icon: 'üö¥', color: 'bg-success' },
  { name: 'Swimming', icon: 'üèä', color: 'bg-secondary' },
  { name: 'Rock Climbing', icon: 'üßó', color: 'bg-primary' },
  { name: 'Hiking', icon: 'ü•æ', color: 'bg-success' },
];

function Onboarding({ onComplete }: OnboardingProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [selectedSports, setSelectedSports] = useState<string[]>([]);
  const [locationPermission, setLocationPermission] = useState<'granted' | 'denied' | 'pending'>('pending');
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [userProfile, setUserProfile] = useState({
    firstName: '',
    lastName: '',
    bio: '',
    skillLevel: ''
  });
  const [firstGameMode, setFirstGameMode] = useState<'create' | 'browse' | null>(null);
  const [hasCompletedFirstGame, setHasCompletedFirstGame] = useState(false);
  const [platformStats, setPlatformStats] = useState({
    totalGames: 0,
    totalUsers: 0,
    activeGamesToday: 0
  });
  const navigate = useNavigate();
  const { user } = useSimpleAuth();

  // Fetch platform stats for value proposition
  useEffect(() => {
    const fetchStats = async () => {
      try {
        const { count: gamesCount } = await supabase
          .from('games')
          .select('*', { count: 'exact', head: true });
        
        const { count: usersCount } = await supabase
          .from('users')
          .select('*', { count: 'exact', head: true });
        
        const today = new Date().toISOString().split('T')[0];
        const { count: todayGamesCount } = await supabase
          .from('games')
          .select('*', { count: 'exact', head: true })
          .eq('date', today);
        
        setPlatformStats({
          totalGames: gamesCount || 0,
          totalUsers: usersCount || 0,
          activeGamesToday: todayGamesCount || 0
        });
      } catch (error) {
        console.error('Error fetching platform stats:', error);
      }
    };
    
    fetchStats();
  }, []);

  const progress = (currentStep / onboardingSteps.length) * 100;

  const handleNext = async () => {
    console.log('handleNext called, currentStep:', currentStep);
    if (currentStep < onboardingSteps.length) {
      console.log('Moving to next step:', currentStep + 1);
      setCurrentStep(currentStep + 1);
    } else {
      console.log('Onboarding complete, saving profile and navigating home');
      const payload = {
        ...userProfile,
        selectedSports,
        locationPermission
      };
      try {
        // Get authenticated user
        const { data: { user: authUser }, error: userErr } = await supabase.auth.getUser();
        if (userErr || !authUser) throw userErr ?? new Error('No user after sign-in');

        console.log('üéØ [Onboarding] Completing onboarding for user:', authUser.id);

        // First, upsert the profile with all the onboarding data
        const { error: upsertError } = await supabase.from('users').upsert(
          {
            id: authUser.id,
            email: authUser.email ?? null,
            full_name: `${payload.firstName} ${payload.lastName}`.trim(),
            username: `${payload.firstName}_${payload.lastName}`.toLowerCase().replace(/\s+/g, '_'),
            bio: payload.bio,
            preferred_sports: payload.selectedSports ?? [],
            location: payload.locationPermission === 'granted' ? 'Location enabled' : null,
          },
          { onConflict: 'id' }
        );

        if (upsertError) {
          console.error('‚ùå [Onboarding] Error upserting profile:', upsertError);
          toast.error('Failed to save profile. Please try again.');
          return;
        }

        console.log('‚úÖ [Onboarding] Profile upserted successfully');

        // Then, mark onboarding as completed
        const { error: updateError } = await supabase
          .from('users')
          .update({ onboarding_completed: true })
          .eq('id', authUser.id);

        if (updateError) {
          console.error('‚ùå [Onboarding] Error completing onboarding:', updateError);
          toast.error('Failed to complete onboarding. Please try again.');
          return;
        }

        console.log('‚úÖ [Onboarding] Onboarding completed successfully');
        
        // Update the app store with the latest profile data
        const updatedProfile = await SupabaseService.getUserProfile(authUser.id);
        if (updatedProfile) {
          const { useAppStore } = await import('@/store/appStore');
          useAppStore.getState().setUser(updatedProfile);
          console.log('‚úÖ [Onboarding] Updated app store with completed onboarding profile');
        }
        
        // Track onboarding completion
        const { analyticsService } = await import('@/core/analytics/analyticsService');
        analyticsService.trackEvent('complete_onboarding', {
          sports_count: payload.selectedSports?.length || 0,
          has_skill_level: !!payload.skillLevel,
          has_location: payload.locationPermission === 'granted',
          completed_first_game: hasCompletedFirstGame,
          first_game_mode: firstGameMode,
        });
        
        // Clear localStorage flag (no longer needed with proper DB tracking)
        localStorage.removeItem(`onboarding_completed_${authUser.id}`);
        console.log('‚úÖ [Onboarding] Cleared localStorage onboarding flag');
        
        // Notify caller for any additional side-effects
        onComplete?.(payload);
        toast.success("You're all set!", { description: 'Your profile is ready. Enjoy discovering games.' });
        
        // Add a small delay to ensure the profile update is processed
        setTimeout(() => {
          navigate('/', { replace: true, state: { fromOnboarding: true } });
        }, 1000);
        
      } catch (err) {
        console.error('Error completing onboarding:', err);
        toast.error('Could not save your profile. You can update it anytime in Profile.');
        // Still navigate to home even if there's an error
        setTimeout(() => {
          navigate('/', { replace: true, state: { fromOnboarding: true } });
        }, 1000);
      }
    }
  };

  const handleSportToggle = (sport: string) => {
    setSelectedSports(prev => 
      prev.includes(sport) 
        ? prev.filter(s => s !== sport)
        : [...prev, sport]
    );
  };

  // Show the location permission explanation modal
  const showLocationExplanation = () => {
    setShowLocationModal(true);
  };

  // Handle when user allows location access from the modal
  const handleLocationAllow = () => {
    console.log('üîç Onboarding: handleLocationAllow called');
    if (navigator.geolocation) {
      console.log('üîç Onboarding: Requesting geolocation permission...');
      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log('‚úÖ Onboarding: Location permission granted', position);
          setLocationPermission('granted');
        },
        (error) => {
          console.error('‚ùå Onboarding: Location permission denied', error);
          setLocationPermission('denied');
        }
      );
    } else {
      console.error('‚ùå Onboarding: Geolocation not supported');
      setLocationPermission('denied');
    }
  };

  const canProceed = () => {
    switch (currentStep) {
      case 1: return true;
      case 2: return selectedSports.length > 0;
      case 3: return true;
      case 4: return userProfile.firstName && userProfile.lastName;
      case 5: return hasCompletedFirstGame || firstGameMode !== null; // Can skip or complete
      default: return false;
    }
  };

  const handleFirstGameComplete = () => {
    setHasCompletedFirstGame(true);
  };

  return (
    <div className="min-h-screen bg-background flex flex-col">
      {/* Progress Header */}
      <div className="px-4 pt-12 pb-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className="text-xl font-semibold">TribeUp</h1>
            <p className="text-sm text-muted-foreground">
              Step {currentStep} of {onboardingSteps.length}
            </p>
          </div>
          <div className="text-sm text-muted-foreground">
            {Math.round(progress)}%
          </div>
        </div>
        <Progress value={progress} className="h-2" />
      </div>

      {/* Content */}
      <div className="flex-1 px-4">
        {/* Step 1: Welcome - Enhanced Value Proposition */}
        {currentStep === 1 && (
          <div className="flex flex-col items-center text-center space-y-8">
            <div className="w-48 h-48 rounded-2xl overflow-hidden shadow-medium">
              <ImageWithFallback
                src="https://images.unsplash.com/photo-1746690783368-9bbcf7cea12a?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHx3ZWxjb21lJTIwb25ib2FyZGluZyUyMGlsbHVzdHJhdGlvbnxlbnwxfHx8fDE3NTYxNDU1OTB8MA&ixlib=rb-4.1.0&q=80&w=1080"
                alt="Welcome illustration"
                className="w-full h-full object-cover"
              />
            </div>
            
            <div className="space-y-4">
              <div className="flex items-center justify-center gap-2">
                <Sparkles className="w-6 h-6 text-primary" />
                <h2 className="text-3xl font-semibold">Welcome to TribeUp!</h2>
              </div>
              <p className="text-lg text-muted-foreground max-w-sm">
                Connect with fellow players and discover pickup games happening around you.
              </p>
            </div>

            {/* Live Stats - Show Real Value */}
            <div className="w-full max-w-sm">
              <Card className="border-primary/20 bg-gradient-to-br from-primary/5 to-secondary/5">
                <CardContent className="pt-6">
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div>
                      <div className="flex items-center justify-center gap-1 mb-1">
                        <TrendingUp className="w-4 h-4 text-primary" />
                        <div className="text-2xl font-bold text-primary">
                          {platformStats.totalGames > 0 ? platformStats.totalGames : '...'}
                        </div>
                      </div>
                      <div className="text-xs text-muted-foreground">Games Created</div>
                    </div>
                    <div>
                      <div className="flex items-center justify-center gap-1 mb-1">
                        <Users className="w-4 h-4 text-secondary" />
                        <div className="text-2xl font-bold text-secondary">
                          {platformStats.totalUsers > 0 ? platformStats.totalUsers : '...'}
                        </div>
                      </div>
                      <div className="text-xs text-muted-foreground">Active Players</div>
                    </div>
                    <div>
                      <div className="flex items-center justify-center gap-1 mb-1">
                        <Zap className="w-4 h-4 text-success" />
                        <div className="text-2xl font-bold text-success">
                          {platformStats.activeGamesToday > 0 ? platformStats.activeGamesToday : '...'}
                        </div>
                      </div>
                      <div className="text-xs text-muted-foreground">Today's Games</div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Key Benefits */}
            <div className="grid grid-cols-3 gap-6 w-full max-w-sm">
              <div className="text-center">
                <div className="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-2">
                  <Users className="w-6 h-6 text-primary" />
                </div>
                <div className="text-sm font-medium">Find Players</div>
                <div className="text-xs text-muted-foreground mt-1">Near you</div>
              </div>
              <div className="text-center">
                <div className="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-2">
                  <Calendar className="w-6 h-6 text-secondary" />
                </div>
                <div className="text-sm font-medium">Join Games</div>
                <div className="text-xs text-muted-foreground mt-1">In minutes</div>
              </div>
              <div className="text-center">
                <div className="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center mx-auto mb-2">
                  <Trophy className="w-6 h-6 text-success" />
                </div>
                <div className="text-sm font-medium">Have Fun</div>
                <div className="text-xs text-muted-foreground mt-1">Play more</div>
              </div>
            </div>
          </div>
        )}

        {/* Step 2: Sports Selection */}
        {currentStep === 2 && (
          <div className="space-y-6">
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-semibold">What sports do you play?</h2>
              <p className="text-muted-foreground">
                Select all the sports you're interested in
              </p>
            </div>

            <div className="grid grid-cols-2 gap-4">
              {sportsOptions.map((sport) => (
                <button
                  key={sport.name}
                  onClick={() => handleSportToggle(sport.name)}
                  className={`p-4 border-2 rounded-xl transition-all ${
                    selectedSports.includes(sport.name)
                      ? 'border-primary bg-primary/5'
                      : 'border-border hover:border-primary/50'
                  }`}
                >
                  <div className="flex flex-col items-center gap-2">
                    <div className="text-2xl">{sport.icon}</div>
                    <div className="font-medium">{sport.name}</div>
                    {selectedSports.includes(sport.name) && (
                      <Check className="w-4 h-4 text-primary" />
                    )}
                  </div>
                </button>
              ))}
            </div>

            {selectedSports.length > 0 && (
              <Card>
                <CardContent className="pt-6">
                  <div className="text-sm text-muted-foreground mb-2">Selected sports:</div>
                  <div className="flex flex-wrap gap-2">
                    {selectedSports.map((sport) => {
                      const sportData = sportsOptions.find(s => s.name === sport);
                      return (
                        <Badge key={sport} className={`${sportData?.color} text-white border-none`}>
                          {sportData?.icon} {sport}
                        </Badge>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        )}

        {/* Step 3: Location Permission */}
        {currentStep === 3 && (
          <div className="flex flex-col items-center text-center space-y-6">
            <div className={`w-32 h-32 rounded-full flex items-center justify-center ${
              locationPermission === 'granted' ? 'bg-success/10' : 'bg-primary/10'
            }`}>
              {locationPermission === 'granted' ? (
                <Check className="w-16 h-16 text-success" />
              ) : (
                <MapPin className="w-16 h-16 text-primary" />
              )}
            </div>
            
            <div className="space-y-4">
              <h2 className="text-2xl font-semibold">
                {locationPermission === 'granted' ? 'Location Enabled!' : 'Enable Location Access'}
              </h2>
              <p className="text-muted-foreground max-w-sm">
                {locationPermission === 'granted' 
                  ? 'Great! We can now show you sports activities and players near you.'
                  : 'Help us show you sports activities and players near you.'}
              </p>
            </div>

            {locationPermission === 'granted' ? (
              <Card className="w-full max-w-sm border-success bg-success/5">
                <CardContent className="pt-6">
                  <div className="flex items-center gap-3 text-success">
                    <Check className="w-5 h-5 flex-shrink-0" />
                    <div className="text-left">
                      <h4 className="font-semibold text-sm">Location Access Granted</h4>
                      <p className="text-xs text-muted-foreground">
                        You'll see games sorted by distance and get personalized recommendations.
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ) : (
              <>
                {/* Benefits section */}
                <div className="w-full max-w-sm space-y-3">
                  <div className="flex items-start gap-3 text-left p-3 bg-muted/30 rounded-lg">
                    <Users className="w-5 h-5 text-primary mt-0.5 flex-shrink-0" />
                    <div>
                      <h4 className="font-medium text-sm">Find Nearby Games</h4>
                      <p className="text-xs text-muted-foreground">Discover pickup games happening close to you.</p>
                    </div>
                  </div>
                  <div className="flex items-start gap-3 text-left p-3 bg-muted/30 rounded-lg">
                    <MapPin className="w-5 h-5 text-primary mt-0.5 flex-shrink-0" />
                    <div>
                      <h4 className="font-medium text-sm">Sort by Distance</h4>
                      <p className="text-xs text-muted-foreground">See games sorted by how far they are from you.</p>
                    </div>
                  </div>
                </div>

                {locationPermission === 'pending' && (
                  <Button 
                    onClick={showLocationExplanation}
                    className="w-full max-w-sm"
                  >
                    <MapPin className="w-4 h-4 mr-2" />
                    Enable Location Access
                  </Button>
                )}
              </>
            )}

            {locationPermission === 'denied' && (
              <div className="w-full max-w-sm">
                <Card className="border-warning bg-warning/5">
                  <CardContent className="pt-6">
                    <div className="text-warning mb-4">
                      Location access denied
                    </div>
                    <div className="text-sm text-muted-foreground mb-4">
                      You can still use TribeUp, but you'll need to search for games manually.
                    </div>
                    <Button 
                      variant="outline" 
                      onClick={showLocationExplanation}
                      className="w-full"
                    >
                      Try Again
                    </Button>
                  </CardContent>
                </Card>
              </div>
            )}

            {/* Privacy notice */}
            <div className="w-full max-w-sm bg-muted/50 rounded-lg p-3">
              <div className="flex items-start gap-2">
                <Shield className="w-4 h-4 text-muted-foreground mt-0.5 flex-shrink-0" />
                <p className="text-xs text-muted-foreground text-left">
                  Your exact location is never shared with other users. You can disable location access anytime in settings.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Step 4: Profile Setup */}
        {currentStep === 4 && (
          <div className="space-y-6">
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-semibold">Set up your profile</h2>
              <p className="text-muted-foreground">
                Tell other players a bit about yourself
              </p>
            </div>

            <div className="flex justify-center">
              <div className="relative">
                <Avatar className="w-24 h-24">
                  <AvatarFallback className="text-2xl">
                    {userProfile.firstName?.[0]}{userProfile.lastName?.[0]}
                  </AvatarFallback>
                </Avatar>
                <button className="absolute bottom-0 right-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center shadow-medium">
                  <Camera className="w-4 h-4 text-primary-foreground" />
                </button>
              </div>
            </div>

            <Card>
              <CardContent className="pt-6 space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm font-medium">First Name</label>
                    <Input
                      value={userProfile.firstName}
                      onChange={(e) => setUserProfile(prev => ({ ...prev, firstName: e.target.value }))}
                      placeholder="Alex"
                    />
                  </div>
                  <div>
                    <label className="text-sm font-medium">Last Name</label>
                    <Input
                      value={userProfile.lastName}
                      onChange={(e) => setUserProfile(prev => ({ ...prev, lastName: e.target.value }))}
                      placeholder="Smith"
                    />
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium">Bio (Optional)</label>
                  <Input
                    value={userProfile.bio}
                    onChange={(e) => setUserProfile(prev => ({ ...prev, bio: e.target.value }))}
                    placeholder="Tell us about yourself..."
                  />
                </div>

                <div>
                  <label className="text-sm font-medium">Skill Level</label>
                  <div className="grid grid-cols-3 gap-2 mt-2">
                    {['Beginner', 'Intermediate', 'Advanced'].map((level) => (
                      <Button
                        key={level}
                        variant={userProfile.skillLevel === level ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setUserProfile(prev => ({ ...prev, skillLevel: level }))}
                      >
                        {level}
                      </Button>
                    ))}
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Step 5: First Game - Create or Join */}
        {currentStep === 5 && (
          <div className="space-y-6">
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-semibold">Get Started with Your First Game</h2>
              <p className="text-muted-foreground">
                Choose how you want to begin your TribeUp journey
              </p>
            </div>

            {!firstGameMode && (
              <div className="grid grid-cols-1 gap-4">
                {/* Browse and Join Games Option */}
                <Card 
                  className="cursor-pointer hover:border-primary transition-colors"
                  onClick={() => setFirstGameMode('browse')}
                >
                  <CardContent className="pt-6">
                    <div className="flex items-start gap-4">
                      <div className="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0">
                        <Search className="w-6 h-6 text-primary" />
                      </div>
                      <div className="flex-1 text-left">
                        <h3 className="font-semibold mb-1">Browse & Join Games</h3>
                        <p className="text-sm text-muted-foreground">
                          Discover games in your favorite sports and join one that fits your schedule
                        </p>
                        <div className="mt-3 flex flex-wrap gap-2">
                          <Badge variant="secondary" className="text-xs">
                            <Calendar className="w-3 h-3 mr-1" />
                            Quick start
                          </Badge>
                          <Badge variant="secondary" className="text-xs">
                            <Users className="w-3 h-3 mr-1" />
                            Meet players
                          </Badge>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Create Your Own Game Option */}
                <Card 
                  className="cursor-pointer hover:border-secondary transition-colors"
                  onClick={() => setFirstGameMode('create')}
                >
                  <CardContent className="pt-6">
                    <div className="flex items-start gap-4">
                      <div className="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center flex-shrink-0">
                        <Plus className="w-6 h-6 text-secondary" />
                      </div>
                      <div className="flex-1 text-left">
                        <h3 className="font-semibold mb-1">Create Your Game</h3>
                        <p className="text-sm text-muted-foreground">
                          Host your own game and invite others to join you
                        </p>
                        <div className="mt-3 flex flex-wrap gap-2">
                          <Badge variant="secondary" className="text-xs">
                            <Trophy className="w-3 h-3 mr-1" />
                            Be the host
                          </Badge>
                          <Badge variant="secondary" className="text-xs">
                            <MapPin className="w-3 h-3 mr-1" />
                            Your location
                          </Badge>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>
            )}

            {firstGameMode === 'browse' && (
              <OnboardingGameBrowse
                selectedSports={selectedSports}
                onGameJoined={handleFirstGameComplete}
                onBack={() => setFirstGameMode(null)}
              />
            )}

            {firstGameMode === 'create' && (
              <OnboardingGameCreate
                selectedSports={selectedSports}
                userProfile={userProfile}
                onGameCreated={handleFirstGameComplete}
                onBack={() => setFirstGameMode(null)}
              />
            )}

            {hasCompletedFirstGame && (
              <Card className="border-success bg-success/5">
                <CardContent className="pt-6 text-center">
                  <div className="flex items-center justify-center gap-2 text-success mb-2">
                    <Check className="w-6 h-6" />
                    <span className="font-semibold">Great job!</span>
                  </div>
                  <p className="text-sm text-muted-foreground">
                    You've {firstGameMode === 'create' ? 'created' : 'joined'} your first game. Ready to explore more?
                  </p>
                </CardContent>
              </Card>
            )}
          </div>
        )}
      </div>

      {/* Bottom Action */}
      <div className="p-4">
        <Button 
          onClick={handleNext}
          disabled={!canProceed()}
          className="w-full h-12"
        >
          {currentStep === onboardingSteps.length 
            ? hasCompletedFirstGame ? 'Get Started' : 'Skip for Now'
            : 'Continue'}
          <ArrowRight className="w-4 h-4 ml-2" />
        </Button>
        
        {currentStep > 1 && (
          <Button 
            variant="ghost" 
            onClick={() => setCurrentStep(currentStep - 1)}
            className="w-full mt-2"
          >
            Back
          </Button>
        )}
      </div>

      {/* Location Permission Modal */}
      <LocationPermissionModal
        open={showLocationModal}
        onOpenChange={setShowLocationModal}
        onAllow={handleLocationAllow}
        onDeny={() => setShowLocationModal(false)}
      />
    </div>
  );
}

export default Onboarding;


```

`domains/users/components/OnboardingGameBrowse.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { 
  ArrowLeft, 
  Calendar,
  Clock,
  MapPin,
  Users,
  Loader2
} from 'lucide-react';
import { supabase } from '@/core/database/supabase';
import { toast } from 'sonner';
import { useSimpleAuth } from '@/core/auth/SimpleAuthProvider';
import { format } from 'date-fns';

interface OnboardingGameBrowseProps {
  selectedSports: string[];
  onGameJoined: () => void;
  onBack: () => void;
}

interface Game {
  id: string;
  title: string;
  sport: string;
  date: string;
  time: string;
  location: string;
  maxPlayers: number;
  currentPlayers: number;
  cost: string;
  description: string;
}

export const OnboardingGameBrowse: React.FC<OnboardingGameBrowseProps> = ({
  selectedSports,
  onGameJoined,
  onBack
}) => {
  const [games, setGames] = useState<Game[]>([]);
  const [loading, setLoading] = useState(true);
  const [joiningGameId, setJoiningGameId] = useState<string | null>(null);
  const { user } = useSimpleAuth();

  useEffect(() => {
    fetchGames();
  }, [selectedSports]);

  const fetchGames = async () => {
    try {
      setLoading(true);
      const today = new Date().toISOString().split('T')[0];
      
      let query = supabase
        .from('games_with_counts')
        .select(`
          id, title, sport, date, time, location,
          max_players, current_players, cost, description
        `)
        .gte('date', today)
        .order('date', { ascending: true })
        .limit(10);

      // Filter by selected sports if any
      if (selectedSports.length > 0) {
        query = query.in('sport', selectedSports.map(s => s.toLowerCase()));
      }

      const { data, error } = await query;

      if (error) throw error;

      // Transform the data
      const transformedGames = (data || []).map((game: any) => ({
        id: game.id,
        title: game.title,
        sport: game.sport,
        date: game.date,
        time: game.time,
        location: game.location,
        maxPlayers: game.max_players,
        currentPlayers: game.current_players || 0,
        cost: game.cost,
        description: game.description
      }));

      setGames(transformedGames);
    } catch (error) {
      console.error('Error fetching games:', error);
      toast.error('Failed to load games');
    } finally {
      setLoading(false);
    }
  };

  const handleJoinGame = async (gameId: string) => {
    if (!user) {
      toast.error('Please sign in to join games');
      return;
    }

    try {
      setJoiningGameId(gameId);

      // Check if already joined
      const { data: existingParticipant } = await supabase
        .from('game_participants')
        .select('id')
        .eq('game_id', gameId)
        .eq('user_id', user.id)
        .single();

      if (existingParticipant) {
        toast.info('You have already joined this game!');
        onGameJoined();
        return;
      }

      // Join the game
      const { error } = await supabase
        .from('game_participants')
        .insert({
          game_id: gameId,
          user_id: user.id,
          status: 'joined'
        });

      if (error) throw error;

      toast.success('Successfully joined the game!');
      onGameJoined();
    } catch (error) {
      console.error('Error joining game:', error);
      toast.error('Failed to join game');
    } finally {
      setJoiningGameId(null);
    }
  };

  const getSportEmoji = (sport: string) => {
    const sportEmojis: Record<string, string> = {
      basketball: 'üèÄ',
      soccer: '‚öΩ',
      tennis: 'üéæ',
      pickleball: 'ü•í',
      volleyball: 'üèê',
      football: 'üèà',
      baseball: '‚öæ',
      running: 'üèÉ',
      cycling: 'üö¥',
      swimming: 'üèä',
      hiking: 'ü•æ',
      'rock climbing': 'üßó'
    };
    return sportEmojis[sport.toLowerCase()] || 'üèÉ';
  };

  const formatDate = (dateStr: string) => {
    try {
      const date = new Date(dateStr);
      return format(date, 'MMM d, yyyy');
    } catch {
      return dateStr;
    }
  };

  const formatTime = (timeStr: string) => {
    try {
      // Parse time string (HH:mm format)
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date();
      date.setHours(hours, minutes);
      return format(date, 'h:mm a'); // 12-hour format with AM/PM
    } catch {
      return timeStr;
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (games.length === 0) {
    return (
      <div className="space-y-4">
        <Button variant="ghost" onClick={onBack} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Back
        </Button>
        <Card>
          <CardContent className="pt-6 text-center">
            <p className="text-muted-foreground mb-4">
              No games found for your selected sports. Try creating your own game instead!
            </p>
            <Button onClick={onBack}>
              Back to Options
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <Button variant="ghost" onClick={onBack} className="mb-2">
        <ArrowLeft className="w-4 h-4 mr-2" />
        Back
      </Button>

      <div className="space-y-3 max-h-96 overflow-y-auto">
        {games.map((game) => (
          <Card key={game.id} className="hover:border-primary/50 transition-colors">
            <CardContent className="pt-4">
              <div className="space-y-3">
                <div className="flex items-start justify-between gap-2">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">{getSportEmoji(game.sport)}</span>
                    <div>
                      <h3 className="font-semibold">{game.title}</h3>
                      <p className="text-xs text-muted-foreground capitalize">{game.sport}</p>
                    </div>
                  </div>
                  <Badge variant={game.cost === 'FREE' ? 'secondary' : 'default'}>
                    {game.cost}
                  </Badge>
                </div>

                <div className="grid grid-cols-2 gap-2 text-xs text-muted-foreground">
                  <div className="flex items-center gap-1">
                    <Calendar className="w-3 h-3" />
                    {formatDate(game.date)}
                  </div>
                  <div className="flex items-center gap-1">
                    <Clock className="w-3 h-3" />
                    {formatTime(game.time)}
                  </div>
                  <div className="flex items-center gap-1 col-span-2">
                    <MapPin className="w-3 h-3" />
                    <span className="truncate">{game.location}</span>
                  </div>
                </div>

                <div className="flex items-center justify-between gap-2 pt-2">
                  <div className="flex items-center gap-1 text-xs text-muted-foreground">
                    <Users className="w-3 h-3" />
                    <span>
                      {game.currentPlayers}/{game.maxPlayers} players
                    </span>
                  </div>
                  <Button
                    size="sm"
                    onClick={() => handleJoinGame(game.id)}
                    disabled={joiningGameId === game.id || game.currentPlayers >= game.maxPlayers}
                  >
                    {joiningGameId === game.id ? (
                      <>
                        <Loader2 className="w-3 h-3 mr-1 animate-spin" />
                        Joining...
                      </>
                    ) : game.currentPlayers >= game.maxPlayers ? (
                      'Full'
                    ) : (
                      'Join Game'
                    )}
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
};

```

`domains/users/components/OnboardingGameCreate.tsx`:

```tsx
import React, { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Label } from '@/shared/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { 
  ArrowLeft,
  Loader2,
  MapPin,
  Calendar,
  Clock,
  Users
} from 'lucide-react';
import { supabase } from '@/core/database/supabase';
import { toast } from 'sonner';
import { useSimpleAuth } from '@/core/auth/SimpleAuthProvider';

interface OnboardingGameCreateProps {
  selectedSports: string[];
  userProfile: {
    firstName: string;
    lastName: string;
    bio: string;
    skillLevel: string;
  };
  onGameCreated: () => void;
  onBack: () => void;
}

const quickTimeSlots = [
  { value: '09:00', label: '9:00 AM' },
  { value: '12:00', label: '12:00 PM' },
  { value: '15:00', label: '3:00 PM' },
  { value: '17:00', label: '5:00 PM' },
  { value: '18:00', label: '6:00 PM' },
  { value: '19:00', label: '7:00 PM' },
  { value: '20:00', label: '8:00 PM' },
  { value: '21:00', label: '9:00 PM' },
];

export const OnboardingGameCreate: React.FC<OnboardingGameCreateProps> = ({
  selectedSports,
  userProfile,
  onGameCreated,
  onBack
}) => {
  const { user } = useSimpleAuth();
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const getDefaultDate = () => {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    return tomorrow.toISOString().split('T')[0];
  };

  const [formData, setFormData] = useState({
    sport: selectedSports[0]?.toLowerCase() || '',
    title: '',
    location: '',
    date: getDefaultDate(),
    time: '18:00',
    duration: '60',
    maxPlayers: '10',
    cost: 'FREE'
  });

  const getSportEmoji = (sport: string) => {
    const sportEmojis: Record<string, string> = {
      basketball: 'üèÄ',
      soccer: '‚öΩ',
      tennis: 'üéæ',
      pickleball: 'ü•í',
      volleyball: 'üèê',
      football: 'üèà',
      baseball: '‚öæ',
      running: 'üèÉ',
      cycling: 'üö¥',
      swimming: 'üèä',
      hiking: 'ü•æ',
      'rock climbing': 'üßó'
    };
    return sportEmojis[sport.toLowerCase()] || 'üèÉ';
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!user) {
      toast.error('Please sign in to create games');
      return;
    }

    if (!formData.title || !formData.location || !formData.sport) {
      toast.error('Please fill in all required fields');
      return;
    }

    try {
      setIsSubmitting(true);

      const gameData = {
        title: formData.title,
        sport: formData.sport.toLowerCase(),
        date: formData.date,
        time: formData.time,
        duration: parseInt(formData.duration),
        location: formData.location,
        max_players: parseInt(formData.maxPlayers),
        cost: formData.cost,
        description: `${userProfile.firstName}'s ${formData.sport} game`,
        creator_id: user.id,
        created_by: user.id
      };

      const { data, error } = await supabase
        .from('games')
        .insert(gameData)
        .select()
        .single();

      if (error) throw error;

      // Automatically join the creator to the game
      const { error: joinError } = await supabase
        .from('game_participants')
        .insert({
          game_id: data.id,
          user_id: user.id,
          status: 'joined'
        });

      if (joinError) {
        console.error('Error joining game:', joinError);
        // Don't throw, game was still created successfully
      }

      toast.success('Game created successfully!');
      onGameCreated();
    } catch (error) {
      console.error('Error creating game:', error);
      toast.error('Failed to create game');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="space-y-4">
      <Button variant="ghost" onClick={onBack} className="mb-2">
        <ArrowLeft className="w-4 h-4 mr-2" />
        Back
      </Button>

      <Card>
        <CardContent className="pt-6">
          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Sport Selection */}
            <div className="space-y-2">
              <Label htmlFor="sport">Sport *</Label>
              <Select
                value={formData.sport}
                onValueChange={(value) => setFormData({ ...formData, sport: value })}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select a sport">
                    {formData.sport && (
                      <span className="flex items-center gap-2">
                        <span>{getSportEmoji(formData.sport)}</span>
                        <span className="capitalize">{formData.sport}</span>
                      </span>
                    )}
                  </SelectValue>
                </SelectTrigger>
                <SelectContent>
                  {selectedSports.map((sport) => (
                    <SelectItem key={sport} value={sport.toLowerCase()}>
                      <div className="flex items-center gap-2">
                        <span>{getSportEmoji(sport)}</span>
                        <span>{sport}</span>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Game Title */}
            <div className="space-y-2">
              <Label htmlFor="title">Game Title *</Label>
              <Input
                id="title"
                placeholder={`e.g., ${userProfile.firstName}'s ${formData.sport || 'game'}`}
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                required
              />
            </div>

            {/* Location */}
            <div className="space-y-2">
              <Label htmlFor="location">Location *</Label>
              <div className="relative">
                <MapPin className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                <Input
                  id="location"
                  placeholder="e.g., Southwest Rec Center"
                  value={formData.location}
                  onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                  className="pl-10"
                  required
                />
              </div>
            </div>

            {/* Date and Time */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="date">Date *</Label>
                <div className="relative">
                  <Calendar className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                  <Input
                    id="date"
                    type="date"
                    value={formData.date}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                    className="pl-10"
                    min={new Date().toISOString().split('T')[0]}
                    required
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="time">Time *</Label>
                <Select
                  value={formData.time}
                  onValueChange={(value) => setFormData({ ...formData, time: value })}
                >
                  <SelectTrigger>
                    <SelectValue>
                      {quickTimeSlots.find(slot => slot.value === formData.time)?.label || formData.time}
                    </SelectValue>
                  </SelectTrigger>
                  <SelectContent>
                    {quickTimeSlots.map((slot) => (
                      <SelectItem key={slot.value} value={slot.value}>
                        {slot.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Max Players */}
            <div className="space-y-2">
              <Label htmlFor="maxPlayers">Max Players</Label>
              <div className="relative">
                <Users className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                <Input
                  id="maxPlayers"
                  type="number"
                  min="2"
                  max="50"
                  value={formData.maxPlayers}
                  onChange={(e) => setFormData({ ...formData, maxPlayers: e.target.value })}
                  className="pl-10"
                />
              </div>
            </div>

            {/* Submit Button */}
            <Button
              type="submit"
              className="w-full"
              disabled={isSubmitting}
            >
              {isSubmitting ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Creating Game...
                </>
              ) : (
                'Create Game'
              )}
            </Button>
          </form>
        </CardContent>
      </Card>

      <div className="text-xs text-center text-muted-foreground">
        You'll be automatically added as the first participant
      </div>
    </div>
  );
};

```

`domains/users/components/OtherUserProfile.tsx`:

```tsx
import React, { useEffect } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { useNavigate, useParams } from 'react-router-dom';
import { motion } from 'framer-motion';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Separator } from '@/shared/components/ui/separator';
import { 
  ArrowLeft, 
  MessageCircle, 
  Calendar, 
  MapPin, 
  Trophy, 
  Users, 
  Star, 
  Shield,
  Flag,
  Share,
  UserPlus,
  UserCheck
} from 'lucide-react';
import { toast } from 'sonner';
import { useUserProfile, useUserStats, useUserRecentGames, useUserAchievements } from '@/domains/users/hooks/useUserProfile';
import { useIsFollowing, useFollowUser } from '@/domains/users/hooks/useFriends';
import { AchievementGrid } from './AchievementBadge';
import { initialsFrom } from '@/shared/utils/initials';
import { supabase } from '@/core/database/supabase';



function OtherUserProfile() {
  const navigate = useNavigate();
  const { userId } = useParams();
  const queryClient = useQueryClient();
  
  // Force refresh when userId changes to ensure fresh data
  useEffect(() => {
    if (userId) {
      console.log('üîÑ User profile changed, invalidating cache for userId:', userId);
      queryClient.invalidateQueries({ queryKey: ['users', 'profile', userId] });
      queryClient.invalidateQueries({ queryKey: ['users', 'stats', userId] });
      queryClient.invalidateQueries({ queryKey: ['users', 'recentGames', userId] });
      queryClient.invalidateQueries({ queryKey: ['users', 'achievements', userId] });
    }
  }, [userId, queryClient]);
  
  // Debug: Verify session and client on component mount
  useEffect(() => {
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      console.log('üîç [OtherUserProfile] Component mount check:', {
        userId,
        hasSession: !!session,
        sessionUserId: session?.user?.id,
        hasClient: !!supabase,
        hasAuth: !!supabase.auth
      });
    })();
  }, [userId]);

  // Use React Query hooks for data fetching
  const { data: user, isLoading: loading, error } = useUserProfile(userId || '');
  const { data: userStats, isLoading: statsLoading } = useUserStats(userId || '');
  const { data: recentGames = [], isLoading: recentGamesLoading } = useUserRecentGames(userId || '', 5);
  const { data: achievements = [], isLoading: achievementsLoading } = useUserAchievements(userId || '');

  // Follow functionality
  const { data: isFriend, isLoading: isFriendLoading } = useIsFollowing(userId || '');
  const friendMutation = useFollowUser();

  const handleFriendToggle = async () => {
    if (!userId) return;
    await friendMutation.mutateAsync(userId);
  };

  // Show loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Loading profile...</p>
        </div>
      </div>
    );
  }

  // Show error or user not found
  if (error || !user) {
    console.error('‚ùå [OtherUserProfile] Error or user not found:', { 
      error, 
      errorCode: error instanceof Error ? 'unknown' : (error as any)?.code,
      errorStatus: (error as any)?.status,
      errorMessage: error instanceof Error ? error.message : (error as any)?.message,
      isAuthError: (error as any)?.isAuthError,
      user, 
      userId 
    });
    
    // Distinguish between auth errors and not found
    // Check for auth error flag set by getOtherUserProfile, or error codes
    const isAuthError = error && (
      (error as any)?.isAuthError === true ||
      (error as any)?.code === 'PGRST301' || // Permission denied
      (error as any)?.code === '42501' ||    // Insufficient privilege
      (error as any)?.status === 401 ||
      (error as any)?.status === 403 ||
      (error as any)?.message?.includes('permission') ||
      (error as any)?.message?.includes('RLS') ||
      (error as any)?.message?.includes('JWT')
    );
    
    // If error exists but isAuthError is false, and user is null, it's "not found"
    const isNotFound = !error || (!isAuthError && !user);
    
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl mb-4">{isAuthError ? 'Authentication Error' : 'User not found'}</h1>
          <p className="text-muted-foreground mb-4">
            {isAuthError 
              ? 'There was an authentication issue loading this profile. Please try logging in again.'
              : isNotFound
              ? 'The user you\'re looking for doesn\'t exist or has been removed.'
              : 'Unable to load profile. Please try again.'}
          </p>
          <p className="text-xs text-muted-foreground mb-4">UserId: {userId}</p>
          {isAuthError && (
            <p className="text-xs text-red-500 mb-4">
              Error code: {(error as any)?.code || 'unknown'} 
              {(error as any)?.status && ` (Status: ${(error as any)?.status})`}
            </p>
          )}
          <Button onClick={() => navigate('/')}>Go Home</Button>
        </div>
      </div>
    );
  }

  const handleBack = () => {
    navigate(-1);
  };

  const handleMessage = () => {
    navigate(`/chat/direct/${user.id}`);
  };

  const handleShare = () => {
    if (navigator.share) {
      navigator.share({
        title: `${user.name} on TribeUp`,
        text: `Check out ${user.name}'s profile on TribeUp`,
        url: window.location.href,
      });
    } else {
      navigator.clipboard.writeText(window.location.href);
      toast.success('Profile link copied!', {
        description: 'Share with followers',
      });
    }
  };

  const handleReport = () => {
    toast.success('Report submitted', {
      description: 'Thank you for helping keep TribeUp safe',
    });
  };

  const formatJoinDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long' 
    });
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      className="min-h-screen bg-background"
    >
      {/* Header */}
      <div className="sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border">
        <div className="flex items-center justify-between p-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={handleBack}
            aria-label="Go back"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          
          <div className="flex items-center gap-2">
            <Button variant="ghost" size="icon" onClick={handleShare}>
              <Share className="w-5 h-5" />
            </Button>
            <Button variant="ghost" size="icon" onClick={handleReport}>
              <Flag className="w-5 h-5" />
            </Button>
          </div>
        </div>
      </div>

      <div className="p-4 space-y-6">
        {/* Profile Header */}
        <Card>
          <CardContent className="p-6">
            <div className="flex flex-col items-center text-center space-y-4">
              <div className="relative">
                <Avatar className="w-24 h-24">
                  {user.avatar ? (
                    <AvatarImage
                      src={user.avatar}
                      alt={user.name}
                      onError={(e) => { (e.currentTarget as HTMLImageElement).style.display = 'none' }}
                    />
                  ) : null}
                  <AvatarFallback className="text-2xl">
                    {initialsFrom(user.name)}
                  </AvatarFallback>
                </Avatar>
                {(user as any).isVerified && (
                  <div className="absolute -top-1 -right-1 w-6 h-6 bg-primary rounded-full flex items-center justify-center">
                    <Shield className="w-3 h-3 text-primary-foreground" />
                  </div>
                )}
              </div>
              
              <div>
                <h1 className="text-2xl mb-1">{user.name}</h1>
                <div className="flex items-center justify-center gap-2 text-muted-foreground">
                  <MapPin className="w-4 h-4" />
                  <span>{user.location}</span>
                </div>
              </div>

              {user.bio && (
                <p className="text-muted-foreground max-w-md">{user.bio}</p>
              )}

              <div className="flex items-center gap-4 pt-2">
                {/* Rating temporarily hidden during early testing phase */}
                {/* <div className="text-center">
                  <div className="text-xl">
                    {statsLoading ? '...' : (userStats?.averageRating?.toFixed(1) || '0.0')}
                  </div>
                  <div className="text-sm text-muted-foreground flex items-center gap-1">
                    <Star className="w-3 h-3 fill-current text-warning" />
                    Rating
                  </div>
                </div>
                <Separator orientation="vertical" className="h-8" /> */}
                <div className="text-center">
                  <div className="text-xl">
                    {statsLoading ? '...' : (userStats?.totalGamesHosted || 0)}
                  </div>
                  <div className="text-sm text-muted-foreground">Hosted</div>
                </div>
                <Separator orientation="vertical" className="h-8" />
                <div className="text-center">
                  <div className="text-xl">
                    {statsLoading ? '...' : (userStats?.totalGamesPlayed || 0)}
                  </div>
                  <div className="text-sm text-muted-foreground">Joined</div>
                </div>
                <Separator orientation="vertical" className="h-8" />
                <div className="text-center">
                  <div className="text-xl font-bold text-primary">
                    {achievementsLoading ? '...' : achievements.reduce((total: number, ua: any) => total + ((ua.achievements || ua).points || 0), 0)}
                  </div>
                  <div className="text-sm text-muted-foreground">Total Score</div>
                </div>
              </div>

              <div className="flex gap-2 w-full max-w-xs">
                <Button
                  onClick={handleFriendToggle}
                  disabled={friendMutation.isPending || isFriendLoading}
                  variant={isFriend ? "outline" : "default"}
                  size="lg"
                  className="flex-1"
                >
                  {friendMutation.isPending ? (
                    <>
                      <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mr-2" />
                      {isFriend ? 'Unfollowing...' : 'Following...'}
                    </>
                  ) : isFriend ? (
                    <>
                      <UserCheck className="w-5 h-5 mr-2" />
                      Following
                    </>
                  ) : (
                    <>
                      <UserPlus className="w-5 h-5 mr-2" />
                      Follow
                    </>
                  )}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Achievements */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Trophy className="w-5 h-5" />
              Achievements ({achievements.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {achievementsLoading ? (
              <div className="text-center py-4">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                <p className="text-sm text-muted-foreground">Loading achievements...</p>
              </div>
            ) : achievements.length > 0 ? (
              <AchievementGrid 
                achievements={achievements.map((ua: any) => ({
                  ...ua.achievements || ua,
                  earned_at: ua.earned_at
                }))} 
                maxDisplay={12}
                size="md"
                layout="card"
                showScore={true}
              />
            ) : (
              <p className="text-muted-foreground text-center py-4">No achievements yet</p>
            )}
          </CardContent>
        </Card>

        {/* Favorite Sports */}
        <Card>
          <CardHeader>
            <CardTitle>Favorite Sports</CardTitle>
          </CardHeader>
          <CardContent>
            {statsLoading ? (
              <div className="text-center py-4">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                <p className="text-sm text-muted-foreground">Loading sports...</p>
              </div>
            ) : (
              <div className="flex flex-wrap gap-2">
                {userStats?.favoritesSports && userStats.favoritesSports.length > 0 ? (
                  userStats.favoritesSports.map((sport: string) => (
                    <Badge key={sport} variant="secondary">{sport}</Badge>
                  ))
                ) : user?.preferences?.sports && user.preferences.sports.length > 0 ? (
                  user.preferences.sports.map((sport: string) => (
                    <Badge key={sport} variant="secondary">{sport}</Badge>
                  ))
                ) : (
                  <span className="text-muted-foreground">No favorite sports listed</span>
                )}
              </div>
            )}
          </CardContent>
        </Card>

        {/* User Stats */}
        <Card>
          <CardHeader>
            <CardTitle>Activity Stats</CardTitle>
          </CardHeader>
          <CardContent>
            {statsLoading ? (
              <div className="text-center py-4">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                <p className="text-sm text-muted-foreground">Loading stats...</p>
              </div>
            ) : (
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center p-3 bg-muted rounded-lg">
                  <div className="text-2xl font-bold text-primary">{userStats?.totalPlayTime || 0}</div>
                  <div className="text-sm text-muted-foreground">Minutes Played</div>
                </div>
                <div className="text-center p-3 bg-muted rounded-lg">
                  <div className="text-2xl font-bold text-primary">{userStats?.completionRate || 0}%</div>
                  <div className="text-sm text-muted-foreground">Completion Rate</div>
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Recent Games */}
        <Card>
          <CardHeader>
            <CardTitle>Recent Games ({recentGames.length})</CardTitle>
          </CardHeader>
          <CardContent>
            {recentGamesLoading ? (
              <div className="text-center py-4">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                <p className="text-sm text-muted-foreground">Loading recent games...</p>
              </div>
            ) : recentGames.length > 0 ? (
              <div className="space-y-3">
                {recentGames.map((game: any, index: number) => (
                  <div key={game.id || index}>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
                          <Users className="w-5 h-5 text-primary" />
                        </div>
                        <div>
                          <div className="font-medium">{game.title || game.games?.title}</div>
                          <div className="text-sm text-muted-foreground">
                            {game.sport || game.games?.sport} ‚Ä¢ {new Date(game.date || game.games?.date).toLocaleDateString()}
                          </div>
                        </div>
                      </div>
                      <Badge variant={game.isHost ? 'default' : 'secondary'}>
                        {game.isHost ? 'Host' : 'Player'}
                      </Badge>
                    </div>
                    {index < recentGames.length - 1 && <Separator className="mt-3" />}
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-muted-foreground text-center py-4">No recent games</p>
            )}
          </CardContent>
        </Card>

        {/* Member Since */}
        <Card>
          <CardContent className="p-4">
            <div className="flex items-center gap-2 text-muted-foreground">
              <Calendar className="w-4 h-4" />
              <span className="text-sm">Member since {formatJoinDate((user as any).joinedDate || (user as any).created_at || new Date().toISOString())}</span>
            </div>
          </CardContent>
        </Card>
      </div>
    </motion.div>
  );
}

export default OtherUserProfile;
```

`domains/users/components/PlayerCard.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Button } from '@/shared/components/ui/button';
import { ClickableAvatar } from '@/shared/components/ui/clickable-avatar';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import {
  MessageCircle,
  UserPlus,
  Star,
  Trophy,
  Activity,
  MapPin,
  MoreVertical,
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/shared/components/ui/dropdown-menu';

export interface PlayerStats {
  gamesPlayed?: number;
  wins?: number;
  losses?: number;
  rating?: number;
  winRate?: number;
  favoriteSport?: string;
  location?: string;
}

export interface PlayerCardProps extends React.HTMLAttributes<HTMLDivElement> {
  player: {
    id?: string;
    name: string;
    avatar?: string | null;
    username?: string;
    stats?: PlayerStats;
    isOnline?: boolean;
    isInGame?: boolean;
    isCurrentUser?: boolean;
  };
  variant?: 'list' | 'card' | 'compact';
  showStats?: boolean;
  showActions?: boolean;
  onInvite?: (playerId: string) => void;
  onMessage?: (playerId: string) => void;
  onViewProfile?: (playerId: string) => void;
  onMoreActions?: (playerId: string) => void;
}

/**
 * Player/Athlete Card Component
 * 
 * Displays a player profile with stats, status indicators, and quick actions.
 * Based on Strava's athlete card patterns.
 * 
 * @example
 * ```tsx
 * <PlayerCard
 *   player={{
 *     id: '1',
 *     name: 'John Doe',
 *     avatar: '/avatar.jpg',
 *     stats: { gamesPlayed: 50, wins: 35, rating: 4.8 }
 *   }}
 *   variant="card"
 *   showStats
 *   onInvite={(id) => invitePlayer(id)}
 * />
 * ```
 */
export function PlayerCard({
  player,
  variant = 'card',
  showStats = true,
  showActions = true,
  onInvite,
  onMessage,
  onViewProfile,
  onMoreActions,
  className,
  ...props
}: PlayerCardProps) {
  const stats = player.stats || {};

  const handleInvite = () => {
    if (player.id && onInvite) {
      onInvite(player.id);
    }
  };

  const handleMessage = () => {
    if (player.id && onMessage) {
      onMessage(player.id);
    }
  };

  const handleViewProfile = () => {
    if (player.id && onViewProfile) {
      onViewProfile(player.id);
    }
  };

  // Compact variant - minimal display
  if (variant === 'compact') {
    return (
      <div
        className={cn(
          'flex items-center gap-2 p-2 rounded-lg hover:bg-muted/50 transition-colors',
          className
        )}
        {...props}
      >
        {player.id ? (
          <ClickableAvatar
            userId={player.id}
            src={player.avatar || undefined}
            alt={player.name}
            size="sm"
            onClick={onViewProfile ? handleViewProfile : undefined}
          />
        ) : (
          <Avatar className="size-8">
            <AvatarImage src={player.avatar || undefined} alt={player.name} />
            <AvatarFallback className="bg-primary/10 text-primary text-xs">
              {player.name
                ?.split(' ')
                ?.map((word) => word[0])
                ?.join('')
                ?.toUpperCase() || '?'}
          </AvatarFallback>
          </Avatar>
        )}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <span className="font-medium text-sm truncate">{player.name}</span>
            {player.isOnline && (
              <div className="size-2 rounded-full bg-success" title="Online" />
            )}
          </div>
          {stats.rating && (
            <div className="flex items-center gap-1 text-xs text-muted-foreground">
              <Star className="size-3 fill-warning text-warning" />
              <span>{stats.rating.toFixed(1)}</span>
            </div>
          )}
        </div>
      </div>
    );
  }

  // List variant - horizontal layout
  if (variant === 'list') {
    return (
      <Card
        className={cn(
          'hover:shadow-medium transition-all duration-200',
          className
        )}
        {...props}
      >
        <CardContent className="p-4">
          <div className="flex items-center gap-4">
            {/* Avatar */}
            <div className="flex-shrink-0 relative">
              {player.id ? (
                <ClickableAvatar
                  userId={player.id}
                  src={player.avatar || undefined}
                  alt={player.name}
                  size="md"
                />
              ) : (
                <Avatar className="size-12">
                  <AvatarImage src={player.avatar || undefined} alt={player.name} />
                  <AvatarFallback className="bg-primary/10 text-primary">
                    {player.name
                      ?.split(' ')
                      ?.map((word) => word[0])
                      ?.join('')
                      ?.toUpperCase() || '?'}
                </AvatarFallback>
                </Avatar>
              )}
              {/* Status Indicators */}
              {player.isOnline && (
                <div className="absolute bottom-0 right-0 size-3 rounded-full bg-success border-2 border-background" />
              )}
              {player.isInGame && (
                <div className="absolute top-0 right-0 size-3 rounded-full bg-primary border-2 border-background" />
              )}
            </div>

            {/* Player Info */}
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <h3 className="font-semibold truncate">{player.name}</h3>
                {player.isCurrentUser && (
                  <Badge variant="secondary" className="text-xs">
                    You
                  </Badge>
                )}
              </div>
              {player.username && (
                <p className="text-sm text-muted-foreground">@{player.username}</p>
              )}

              {/* Stats */}
              {showStats && (
                <div className="flex items-center gap-4 mt-2 text-sm">
                  {stats.gamesPlayed !== undefined && (
                    <div className="flex items-center gap-1">
                      <Activity className="size-3 text-muted-foreground" />
                      <span className="text-muted-foreground">
                        {stats.gamesPlayed} games
                      </span>
                    </div>
                  )}
                  {stats.wins !== undefined && (
                    <div className="flex items-center gap-1">
                      <Trophy className="size-3 text-warning" />
                      <span className="text-muted-foreground">{stats.wins} wins</span>
                    </div>
                  )}
                  {stats.rating !== undefined && (
                    <div className="flex items-center gap-1">
                      <Star className="size-3 fill-warning text-warning" />
                      <span className="text-muted-foreground">
                        {stats.rating.toFixed(1)}
                      </span>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Actions */}
            {showActions && !player.isCurrentUser && (
              <div className="flex-shrink-0 flex items-center gap-2">
                {onMessage && (
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    onClick={handleMessage}
                    aria-label={`Message ${player.name}`}
                  >
                    <MessageCircle className="size-4" />
                  </Button>
                )}
                {onInvite && (
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    onClick={handleInvite}
                    aria-label={`Invite ${player.name}`}
                  >
                    <UserPlus className="size-4" />
                  </Button>
                )}
                {onMoreActions && (
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        aria-label="More actions"
                      >
                        <MoreVertical className="size-4" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      {onViewProfile && (
                        <DropdownMenuItem onClick={handleViewProfile}>
                          View Profile
                        </DropdownMenuItem>
                      )}
                      <DropdownMenuItem onClick={() => onMoreActions(player.id!)}>
                        More Options
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                )}
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    );
  }

  // Card variant - full card layout
  return (
    <Card
      className={cn(
        'hover:shadow-medium transition-all duration-200 cursor-pointer',
        className
      )}
      onClick={handleViewProfile}
      {...props}
    >
      <CardContent className="p-4">
        <div className="flex flex-col items-center text-center space-y-3">
          {/* Avatar */}
          <div className="relative">
            {player.id ? (
              <ClickableAvatar
                userId={player.id}
                src={player.avatar || undefined}
                alt={player.name}
                size="lg"
              />
            ) : (
              <Avatar className="size-16">
                <AvatarImage src={player.avatar || undefined} alt={player.name} />
                <AvatarFallback className="bg-primary/10 text-primary text-lg">
                  {player.name
                    ?.split(' ')
                    ?.map((word) => word[0])
                    ?.join('')
                    ?.toUpperCase() || '?'}
              </AvatarFallback>
              </Avatar>
            )}
            {/* Status Indicators */}
            {player.isOnline && (
              <div className="absolute bottom-0 right-0 size-4 rounded-full bg-success border-2 border-background" />
            )}
            {player.isInGame && (
              <div className="absolute top-0 right-0 size-4 rounded-full bg-primary border-2 border-background" />
            )}
          </div>

          {/* Player Info */}
          <div className="w-full">
            <div className="flex items-center justify-center gap-2 mb-1">
              <h3 className="font-semibold">{player.name}</h3>
              {player.isCurrentUser && (
                <Badge variant="secondary" className="text-xs">
                  You
                </Badge>
              )}
            </div>
            {player.username && (
              <p className="text-sm text-muted-foreground">@{player.username}</p>
            )}

            {/* Stats */}
            {showStats && (
              <div className="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-border">
                {stats.gamesPlayed !== undefined && (
                  <div className="flex flex-col items-center">
                    <Activity className="size-4 text-muted-foreground mb-1" />
                    <span className="text-xs font-semibold">{stats.gamesPlayed}</span>
                    <span className="text-[10px] text-muted-foreground">Games</span>
                  </div>
                )}
                {stats.wins !== undefined && (
                  <div className="flex flex-col items-center">
                    <Trophy className="size-4 text-warning mb-1" />
                    <span className="text-xs font-semibold">{stats.wins}</span>
                    <span className="text-[10px] text-muted-foreground">Wins</span>
                  </div>
                )}
                {stats.rating !== undefined && (
                  <div className="flex flex-col items-center">
                    <Star className="size-4 fill-warning text-warning mb-1" />
                    <span className="text-xs font-semibold">{stats.rating.toFixed(1)}</span>
                    <span className="text-[10px] text-muted-foreground">Rating</span>
                  </div>
                )}
              </div>
            )}

            {/* Location */}
            {stats.location && (
              <div className="flex items-center justify-center gap-1 mt-2 text-xs text-muted-foreground">
                <MapPin className="size-3" />
                <span>{stats.location}</span>
              </div>
            )}

            {/* Actions */}
            {showActions && !player.isCurrentUser && (
              <div className="flex items-center justify-center gap-2 mt-4">
                {onMessage && (
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={(e) => {
                      e.stopPropagation();
                      handleMessage();
                    }}
                  >
                    <MessageCircle className="size-3 mr-1" />
                    Message
                  </Button>
                )}
                {onInvite && (
                  <Button
                    type="button"
                    variant="default"
                    size="sm"
                    onClick={(e) => {
                      e.stopPropagation();
                      handleInvite();
                    }}
                  >
                    <UserPlus className="size-3 mr-1" />
                    Invite
                  </Button>
                )}
              </div>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}


```

`domains/users/components/Settings.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Switch } from '@/shared/components/ui/switch';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { Separator } from '@/shared/components/ui/separator';
import { Alert, AlertDescription } from '@/shared/components/ui/alert';
import { 
  ArrowLeft, 
  Bell, 
  Shield, 
  MapPin, 
  Palette, 
  Globe, 
  HelpCircle, 
  MessageSquare, 
  LogOut,
  ChevronRight,
  User,
  Lock,
  Eye,
  EyeOff,
  Accessibility,
  Sun,
  Moon,
  Monitor,
  Settings as SettingsIcon,
  FileText,
  Scale
} from 'lucide-react';
import { useTheme } from '@/shared/hooks/useTheme';
import { useSimpleAuth } from '@/core/auth/SimpleAuthProvider';
import { useNotifications } from '@/domains/users/hooks/useNotifications';
import { toast } from 'sonner';
import { useAppStore } from '@/store/appStore';
import { AccountDeletionSection } from '@/domains/users/components/AccountDeletionSection';
import { DataExportSection } from '@/domains/users/components/DataExportSection';

function Settings() {
  const navigate = useNavigate();
  const { signOut } = useSimpleAuth();
  const { theme, effectiveTheme, toggleTheme, setTheme } = useTheme();
  const { user } = useAppStore();
  const { settings, updateSettings } = useNotifications();

  const [isSigningOut, setIsSigningOut] = useState(false);

  const handleSignOut = async () => {
    if (isSigningOut) return; // Prevent double-clicks
    
    setIsSigningOut(true);
    try {
      console.log('Initiating sign out...');
      await signOut();
      console.log('Sign out completed');
      navigate('/auth');
    } catch (error) {
      console.error('Sign out error:', error);
      toast.error('Failed to sign out. Please try again.');
    } finally {
      setIsSigningOut(false);
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <div className="container max-w-4xl mx-auto p-4 space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4 mb-6">
          <Button 
            variant="ghost" 
            size="sm" 
            onClick={() => navigate(-1)}
            className="flex items-center gap-2"
          >
            <ArrowLeft className="w-4 h-4" />
            Back
          </Button>
          <div>
            <h1 className="text-2xl font-bold">Settings</h1>
            <p className="text-muted-foreground">Manage your account and app preferences</p>
          </div>
        </div>

        {/* Theme Settings */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Palette className="w-5 h-5" />
              Appearance
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <div className="font-medium mb-3">Theme</div>
                <div className="grid grid-cols-3 gap-3">
                  <Button
                    variant={theme === 'light' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => setTheme('light')}
                    className="flex items-center gap-2"
                  >
                    <Sun className="w-4 h-4" />
                    Light
                  </Button>
                  <Button
                    variant={theme === 'dark' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => setTheme('dark')}
                    className="flex items-center gap-2"
                  >
                    <Moon className="w-4 h-4" />
                    Dark
                  </Button>
                  <Button
                    variant={theme === 'system' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => setTheme('system')}
                    className="flex items-center gap-2"
                  >
                    <Monitor className="w-4 h-4" />
                    System
                  </Button>
                </div>
                <p className="text-sm text-muted-foreground mt-2">
                  Current: {effectiveTheme} mode
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Notification Settings - Only Functional Ones */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Bell className="w-5 h-5" />
              Notifications
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="font-medium">Push Notifications</div>
                <div className="text-sm text-muted-foreground">
                  Receive notifications on your device
                </div>
              </div>
              <Switch 
                checked={settings.pushNotifications}
                onCheckedChange={(checked) => updateSettings({ pushNotifications: checked })}
                aria-label="Toggle push notifications"
              />
            </div>
            
            <Separator />
            
            <div className="flex items-center justify-between">
              <div>
                <div className="font-medium">Game Reminders</div>
                <div className="text-sm text-muted-foreground">
                  Get notified before your games start
                </div>
              </div>
              <Switch 
                checked={settings.gameReminders}
                onCheckedChange={(checked) => updateSettings({ gameReminders: checked })}
                aria-label="Toggle game reminders"
              />
            </div>

            <Separator />
            
            <div className="flex items-center justify-between">
              <div>
                <div className="font-medium">Message Notifications</div>
                <div className="text-sm text-muted-foreground">
                  Notifications for messages and updates
                </div>
              </div>
              <Switch 
                checked={settings.messageNotifications}
                onCheckedChange={(checked) => updateSettings({ messageNotifications: checked })}
                aria-label="Toggle message notifications"
              />
            </div>

            <Alert>
              <Bell className="h-4 w-4" />
              <AlertDescription>
                Note: Email notifications and some other features are coming soon.
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        {/* Quick Actions */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <SettingsIcon className="w-5 h-5" />
              Quick Actions
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <Button
              variant="outline"
              className="w-full justify-between"
              onClick={() => navigate('/app/profile/edit')}
            >
              <div className="flex items-center gap-2">
                <User className="w-4 h-4" />
                Edit Profile
              </div>
              <ChevronRight className="w-4 h-4" />
            </Button>

            <Button
              variant="outline"
              className="w-full justify-between"
              onClick={() => navigate('/settings/notifications')}
            >
              <div className="flex items-center gap-2">
                <Bell className="w-4 h-4" />
                Notification Settings
              </div>
              <ChevronRight className="w-4 h-4" />
            </Button>

            <Button
              variant="outline"
              className="w-full justify-between"
              onClick={() => navigate('/settings/accessibility')}
            >
              <div className="flex items-center gap-2">
                <Accessibility className="w-4 h-4" />
                Accessibility
              </div>
              <ChevronRight className="w-4 h-4" />
            </Button>
          </CardContent>
        </Card>

        {/* Legal Section */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Scale className="w-5 h-5" />
              Legal
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <Link to="/legal/terms">
              <Button
                variant="outline"
                className="w-full justify-between"
              >
                <div className="flex items-center gap-2">
                  <FileText className="w-4 h-4" />
                  Terms of Service
                </div>
                <ChevronRight className="w-4 h-4" />
              </Button>
            </Link>

            <Link to="/legal/privacy">
              <Button
                variant="outline"
                className="w-full justify-between"
              >
                <div className="flex items-center gap-2">
                  <Shield className="w-4 h-4" />
                  Privacy Policy
                </div>
                <ChevronRight className="w-4 h-4" />
              </Button>
            </Link>
          </CardContent>
        </Card>

        {/* Account Actions */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <LogOut className="w-5 h-5" />
              Session
            </CardTitle>
          </CardHeader>
          <CardContent>
            <Button
              variant="outline"
              onClick={handleSignOut}
              disabled={isSigningOut}
              className="w-full"
            >
              <LogOut className="w-4 h-4 mr-2" />
              {isSigningOut ? 'Signing out...' : 'Sign Out'}
            </Button>
          </CardContent>
        </Card>

        {/* Privacy & Data Section */}
        <div className="space-y-6">
          <div>
            <h2 className="text-xl font-semibold mb-2">Privacy & Data</h2>
            <p className="text-sm text-muted-foreground">
              Manage your data and privacy settings
            </p>
          </div>

          {/* Data Export */}
          <DataExportSection />

          {/* Account Deletion */}
          <AccountDeletionSection />
        </div>
      </div>
    </div>
  );
}

export default Settings;

```

`domains/users/components/SimplePhotoUpload.tsx`:

```tsx
import React, { useState, useRef } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Card } from '@/shared/components/ui/card';
import { Camera, Upload, X, Loader2 } from 'lucide-react';
import { PhotoService } from '@/domains/users/services/photoService';

interface SimplePhotoUploadProps {
  gameId: string;
  onPhotoUploaded?: (photo: any) => void;
}

export function SimplePhotoUpload({ gameId, onPhotoUploaded }: SimplePhotoUploadProps) {
  const [uploading, setUploading] = useState(false);
  const [dragActive, setDragActive] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Handle file selection (drag, drop, or click)
  const handleFiles = async (files: FileList) => {
    if (files.length === 0) return;
    
    const file = files[0];
    await uploadPhoto(file);
  };

  // Upload photo with auto-compression
  const uploadPhoto = async (file: File) => {
    setUploading(true);
    try {
      // Auto-compress if needed
      const compressedFile = await PhotoService.compressImage(file);
      
      // Upload without requiring caption
      const photo = await PhotoService.uploadGamePhoto(gameId, compressedFile);
      
      if (photo && onPhotoUploaded) {
        onPhotoUploaded(photo);
      }
    } catch (error) {
      console.error('Upload failed:', error);
    } finally {
      setUploading(false);
    }
  };

  // Drag and drop handlers
  const handleDrag = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleFiles(e.dataTransfer.files);
    }
  };

  // Click to upload
  const handleClick = () => {
    fileInputRef.current?.click();
  };

  return (
    <Card 
      className={`p-6 border-2 border-dashed transition-colors cursor-pointer ${
        dragActive 
          ? 'border-blue-500 bg-blue-50' 
          : 'border-gray-300 hover:border-gray-400'
      }`}
      onDragEnter={handleDrag}
      onDragLeave={handleDrag}
      onDragOver={handleDrag}
      onDrop={handleDrop}
      onClick={handleClick}
    >
      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        onChange={(e) => e.target.files && handleFiles(e.target.files)}
        className="hidden"
      />
      
      <div className="text-center">
        {uploading ? (
          <div className="flex flex-col items-center space-y-2">
            <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
            <p className="text-sm text-gray-600">Uploading photo...</p>
          </div>
        ) : (
          <div className="flex flex-col items-center space-y-2">
            <div className="flex space-x-2">
              <Camera className="h-8 w-8 text-gray-400" />
              <Upload className="h-8 w-8 text-gray-400" />
            </div>
            <p className="text-sm font-medium">Share a photo from the game!</p>
            <p className="text-xs text-gray-500">
              Drag & drop, click to browse, or take a photo
            </p>
          </div>
        )}
      </div>
    </Card>
  );
}

// Simple photo gallery for viewing uploaded photos
export function SimplePhotoGallery({ gameId }: { gameId: string }) {
  const [photos, setPhotos] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  React.useEffect(() => {
    loadPhotos();
  }, [gameId]);

  const loadPhotos = async () => {
    const gamePhotos = await PhotoService.getGamePhotos(gameId);
    setPhotos(gamePhotos);
    setLoading(false);
  };

  const handlePhotoUploaded = (newPhoto: any) => {
    setPhotos(prev => [newPhoto, ...prev]);
  };

  if (loading) {
    return <div className="text-center py-4">Loading photos...</div>;
  }

  return (
    <div className="space-y-4">
      <SimplePhotoUpload gameId={gameId} onPhotoUploaded={handlePhotoUploaded} />
      
      {photos.length > 0 && (
        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
          {photos.map((photo) => (
            <div key={photo.id} className="relative aspect-square">
              <img
                src={photo.photo_url}
                alt={photo.caption || 'Game photo'}
                className="w-full h-full object-cover rounded-lg"
              />
              {photo.caption && (
                <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2 rounded-b-lg">
                  {photo.caption}
                </div>
              )}
            </div>
          ))}
        </div>
      )}
      
      {photos.length === 0 && (
        <div className="text-center py-8 text-gray-500">
          <Camera className="h-12 w-12 mx-auto mb-2 opacity-50" />
          <p>No photos yet. Be the first to share!</p>
        </div>
      )}
    </div>
  );
}

```

`domains/users/components/SimpleSurvey.tsx`:

```tsx
import React, { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { X, CheckCircle, MessageSquare } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/shared/components/ui/dialog';
import { toast } from 'sonner';

interface SimpleSurveyProps {
  isOpen: boolean;
  onClose: () => void;
}

export function SimpleSurvey({ isOpen, onClose }: SimpleSurveyProps) {
  const [formData, setFormData] = useState({
    tester_name: '',
    device_browser: '',
    feedback: '',
    rating: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    
    try {
      // Simulate submission
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setIsSubmitted(true);
      toast.success('Thank you! Your feedback has been submitted.');
      
      setTimeout(() => {
        onClose();
        setIsSubmitted(false);
        setFormData({ tester_name: '', device_browser: '', feedback: '', rating: '' });
      }, 2000);
      
    } catch (error) {
      toast.error('Failed to submit feedback. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isSubmitted) {
    return (
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent className="max-w-md">
          <div className="text-center space-y-4 py-6">
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto" />
            <h3 className="text-xl font-semibold">Thank You!</h3>
            <p className="text-muted-foreground">
              Your feedback has been recorded and will help improve TribeUp.
            </p>
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-lg">
        <DialogHeader>
          <div className="flex items-center justify-between">
            <DialogTitle className="flex items-center gap-2">
              <MessageSquare className="w-5 h-5" />
              TribeUp User Testing Survey
            </DialogTitle>
            <Button variant="ghost" size="icon" onClick={onClose}>
              <X className="w-4 h-4" />
            </Button>
          </div>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Quick Feedback</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <label className="text-sm font-medium">Your name or initials *</label>
                <Input
                  value={formData.tester_name}
                  onChange={(e) => setFormData(prev => ({ ...prev, tester_name: e.target.value }))}
                  placeholder="Enter your name or initials"
                  required
                />
              </div>
              
              <div>
                <label className="text-sm font-medium">Device/Browser *</label>
                <Select 
                  value={formData.device_browser} 
                  onValueChange={(value) => setFormData(prev => ({ ...prev, device_browser: value }))}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select device and browser" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="desktop_chrome">Desktop - Chrome</SelectItem>
                    <SelectItem value="desktop_safari">Desktop - Safari</SelectItem>
                    <SelectItem value="mobile_ios">Mobile - iOS Safari</SelectItem>
                    <SelectItem value="mobile_android">Mobile - Android Chrome</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="text-sm font-medium">Overall Experience *</label>
                <Select 
                  value={formData.rating} 
                  onValueChange={(value) => setFormData(prev => ({ ...prev, rating: value }))}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Rate your experience" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</SelectItem>
                    <SelectItem value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</SelectItem>
                    <SelectItem value="3">‚≠ê‚≠ê‚≠ê Average</SelectItem>
                    <SelectItem value="2">‚≠ê‚≠ê Poor</SelectItem>
                    <SelectItem value="1">‚≠ê Very Poor</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              
              <div>
                <label className="text-sm font-medium">Feedback & Suggestions</label>
                <Textarea
                  value={formData.feedback}
                  onChange={(e) => setFormData(prev => ({ ...prev, feedback: e.target.value }))}
                  placeholder="Share your thoughts about TribeUp - what worked well, what was confusing, what features are missing..."
                  rows={4}
                />
              </div>
            </CardContent>
          </Card>

          <Button
            type="submit"
            disabled={isSubmitting || !formData.tester_name || !formData.device_browser || !formData.rating}
            className="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600"
          >
            {isSubmitting ? 'Submitting...' : 'Submit Feedback'}
          </Button>
        </form>
      </DialogContent>
    </Dialog>
  );
}

```

`domains/users/components/UserProfile.tsx`:

```tsx
import React, { useState, useMemo, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/shared/components/ui/tabs';
import { Settings, Trophy, Calendar, MapPin, Users, UserPlus, Users2 } from 'lucide-react';
import { useAppStore } from '@/store/appStore';
import { useUserStats, useUserRecentGames, useUserAchievements } from '@/domains/users/hooks/useUserProfile';
import { useUserFriends, useUserFollowers, useFriendSuggestions, useFollowUser } from '@/domains/users/hooks/useFriends';
import { useUserTribes } from '@/domains/tribes/hooks/useTribes';
import { AchievementGrid } from './AchievementBadge';
import { StatGroup } from '@/shared/components/ui';
import { formatTimeString } from '@/shared/utils/dateUtils';
import { useDeepLinks } from '@/shared/hooks/useDeepLinks';
import { 
  EmptyState,
  NoSportsSelectedEmptyState,
  NoTribesEmptyState,
  NoRecentGamesEmptyState,
  NoAchievementsEmptyState,
  NoFriendsEmptyState
} from '@/shared/components/common/EmptyState';

function UserProfile() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { navigateToUser } = useDeepLinks();
  
  // Support deep linking to specific tab via URL hash
  const urlHash = window.location.hash.replace('#', '');
  const initialTab = ['overview', 'following', 'achievements'].includes(urlHash) ? urlHash : 'overview';
  const [activeTab, setActiveTab] = useState(initialTab);
  const [showAllFollowing, setShowAllFollowing] = useState(false);
  const [showAllFollowers, setShowAllFollowers] = useState(false);
  const [showAllAchievements, setShowAllAchievements] = useState(false);
  const pendingScrollRef = useRef<string | null>(null);

  // Smooth scroll utility that accounts for fixed headers on mobile
  const smoothScrollTo = (elementId: string) => {
    try {
      const el = document.getElementById(elementId);
      if (!el) return;
      const rect = el.getBoundingClientRect();
      // Compute dynamic offset: sticky tabs height + any top padding
      const tabsEl = document.getElementById('profile-tabs');
      const tabsH = tabsEl ? tabsEl.offsetHeight : 48;
      const offset = Math.max(tabsH + 16, 64);
      const y = window.scrollY + rect.top - offset;
      window.scrollTo({ top: Math.max(y, 0), behavior: 'smooth' });
    } catch {}
  };

  // Perform deferred scroll after tab content renders
  useEffect(() => {
    if (pendingScrollRef.current) {
      const targetId = pendingScrollRef.current;
      pendingScrollRef.current = null;
      const t = setTimeout(() => smoothScrollTo(targetId), 120);
      return () => clearTimeout(t);
    }
  }, [activeTab]);
  
  // Fetch users you're following and followers
  const { data: userFriends = [], isLoading: friendsLoading } = useUserFriends(user?.id);
  const { data: userFollowers = [], isLoading: followersLoading } = useUserFollowers(user?.id);
  const { data: friendSuggestions = [], isLoading: suggestionsLoading } = useFriendSuggestions(10);
  const friendMutation = useFollowUser();
  
  // Use React Query hooks for data fetching
  const { data: stats, isLoading: statsLoading } = useUserStats(user?.id || '');
  const { data: recentGamesData = [], isLoading: recentGamesLoading } = useUserRecentGames(user?.id || '', 5);
  const { data: achievements = [], isLoading: achievementsLoading } = useUserAchievements(user?.id || '');
  const { data: userTribes = [], isLoading: tribesLoading } = useUserTribes(user?.id);
  
  const loading = statsLoading || recentGamesLoading || achievementsLoading;
  
  // Transform stats data for display
  const userStats = useMemo(() => [
    { label: 'Activities Joined', value: stats?.totalGamesPlayed?.toString() || '0', icon: Calendar },
    { label: 'Activities Hosted', value: stats?.totalGamesHosted?.toString() || '0', icon: MapPin },
    { label: 'Following', value: userFriends.length.toString(), icon: Users },
    { label: 'Achievements', value: achievements.length.toString(), icon: Trophy },
  ], [stats, achievements, userFriends.length]);
  
  // Transform recent games data
  const recentGames = useMemo(() => {
    return recentGamesData.map((participation: any) => ({
      id: participation.games?.id || participation.id,
      title: participation.games?.title || participation.title,
      sport: participation.games?.sport || participation.sport,
      date: participation.games?.date || participation.date,
      time: participation.games?.time || participation.time,
      location: participation.games?.location || participation.location,
      isHost: (participation.games?.creator_id || participation.creator_id) === user?.id
    }));
  }, [recentGamesData, user?.id]);

  // React Query handles all data loading automatically

  // Get user data with fallbacks
  const displayName = user?.name || 'User Profile';
  const displayUsername = user?.username ? `@${user.username}` : '@user';
  const displayBio = user?.bio || 'Sports enthusiast ‚Ä¢ Always up for an activity!';
  const displayAvatar = user?.avatar || '';
  const displaySports = (user?.preferred_sports && Array.isArray(user.preferred_sports) && user.preferred_sports.length > 0) 
    ? user.preferred_sports 
    : [];

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="flex items-center justify-between px-4 pt-12 pb-6">
        <h1 className="text-xl font-semibold">Profile</h1>
        <Button variant="ghost" size="icon" onClick={() => navigate('/settings')}>
          <Settings className="w-5 h-5" />
        </Button>
      </div>

      <div className="px-4 space-y-6">
        {/* Profile Info */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-4 mb-6">
              <Avatar className="w-16 h-16">
                <AvatarImage src={displayAvatar} alt={displayName} />
                <AvatarFallback className="text-xl">
                  {displayName.charAt(0).toUpperCase()}
                </AvatarFallback>
              </Avatar>
              <div className="flex-1">
                <h2 className="text-xl font-semibold">{displayName}</h2>
                <p className="text-muted-foreground">{displayUsername}</p>
                <p className="text-sm text-muted-foreground mt-1">
                  {displayBio}
                </p>
              </div>
            </div>

            <Button variant="outline" className="w-full" onClick={() => navigate('/app/profile/edit')}>
              Edit Profile
            </Button>
          </CardContent>
        </Card>

        {/* Stats - now clickable */}
        <Card>
          <CardHeader>
            <CardTitle id="profile-stats">Stats</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 gap-3">
              {userStats.map((stat) => {
                const handleClick = () => {
                  if (stat.label === 'Following') {
                    setActiveTab('following');
                    pendingScrollRef.current = 'following-top';
                  } else if (stat.label === 'Achievements') {
                    setActiveTab('achievements');
                    pendingScrollRef.current = 'achievements-top';
                  } else if (stat.label === 'Activities Hosted' || stat.label === 'Activities Joined') {
                    // Navigate to recent games section by switching to overview and scrolling
                    setActiveTab('overview');
                    pendingScrollRef.current = 'overview-top';
                  }
                };
                return (
                  <button
                    key={stat.label}
                    onClick={handleClick}
                    className="w-full rounded-lg border p-3 text-left hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary"
                  >
                    <div className="flex items-center gap-3">
                      <stat.icon className="w-5 h-5" />
                      <div>
                        <div className="text-sm text-muted-foreground">{stat.label}</div>
                        <div className="text-lg font-semibold">{stat.value}</div>
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          </CardContent>
        </Card>

        {/* Social: Segmented control with inline content to avoid long scrolls */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Users className="w-5 h-5" />
              Social
            </CardTitle>
          </CardHeader>
          <CardContent>
            <Tabs value={activeTab} onValueChange={setActiveTab}>
              <TabsList className="grid w-full grid-cols-3">
                <TabsTrigger value="following">Following</TabsTrigger>
                <TabsTrigger value="followers">Followers</TabsTrigger>
                <TabsTrigger value="achievements">Achievements</TabsTrigger>
              </TabsList>
              <div className="mt-4" />
              <TabsContent value="following" className="space-y-4">
                {userFriends.length > 0 ? (
                  <div className="space-y-2">
                    {(showAllFollowing ? userFriends : userFriends.slice(0, 6)).map((friend) => (
                      <div 
                        key={friend.id} 
                        className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors"
                      >
                        <div
                          className="flex items-center gap-3 cursor-pointer flex-1"
                          onClick={() => navigateToUser(friend.id)}
                        >
                          <Avatar className="w-10 h-10">
                            <AvatarImage src={friend.avatar_url || undefined} />
                            <AvatarFallback>
                              {(friend.display_name || friend.username || 'U').charAt(0).toUpperCase()}
                            </AvatarFallback>
                          </Avatar>
                          <div>
                            <p className="font-medium">{friend.display_name || friend.username || 'User'}</p>
                            {friend.bio && (
                              <p className="text-sm text-muted-foreground truncate max-w-[200px]">{friend.bio}</p>
                            )}
                          </div>
                        </div>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={(e) => {
                            e.stopPropagation();
                            friendMutation.mutate(friend.id);
                          }}
                          disabled={friendMutation.isPending}
                          className="ml-2"
                        >
                          Unfollow
                        </Button>
                      </div>
                    ))}
                    {userFriends.length > 6 && (
                      <div className="flex justify-end gap-4">
                        {showAllFollowing ? (
                          <Button
                            variant="link"
                            size="sm"
                            onClick={() => setShowAllFollowing(false)}
                            aria-label="Show less following"
                          >
                            Show less
                          </Button>
                        ) : (
                          <>
                            <Button
                              variant="link"
                              size="sm"
                              onClick={() => setShowAllFollowing(true)}
                              aria-label="Show more following"
                            >
                              Show more
                            </Button>
                            <Button
                              variant="link"
                              size="sm"
                              onClick={() => navigate('/app/profile/following')}
                              aria-label="See all following"
                            >
                              See all
                            </Button>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                ) : (
                  <NoFriendsEmptyState onExploreGames={() => navigate('/app')} />
                )}
              </TabsContent>
              <TabsContent value="followers" className="space-y-4">
                {followersLoading ? (
                  <div className="py-4 text-center text-muted-foreground">
                    <div className="animate-spin w-6 h-6 border-2 border-primary border-t-transparent rounded-full mx-auto mb-2"></div>
                    Loading followers...
                  </div>
                ) : userFollowers.length > 0 ? (
                  <div className="space-y-2">
                    {(showAllFollowers ? userFollowers : userFollowers.slice(0, 6)).map((follower) => (
                      <div 
                        key={follower.id} 
                        className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors cursor-pointer"
                        onClick={() => navigateToUser(follower.id)}
                      >
                        <div className="flex items-center gap-3">
                          <Avatar className="w-10 h-10">
                            <AvatarImage src={follower.avatar_url || undefined} />
                            <AvatarFallback>
                              {(follower.display_name || follower.username || 'U').charAt(0).toUpperCase()}
                            </AvatarFallback>
                          </Avatar>
                          <div>
                            <p className="font-medium">{follower.display_name || follower.username || 'User'}</p>
                            {follower.bio && (
                              <p className="text-sm text-muted-foreground truncate max-w-[200px]">{follower.bio}</p>
                            )}
                          </div>
                        </div>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={(e) => {
                            e.stopPropagation();
                            friendMutation.mutate(follower.id);
                          }}
                          disabled={friendMutation.isPending}
                          className="ml-2"
                        >
                          {follower.is_following ? 'Unfollow' : 'Follow back'}
                        </Button>
                      </div>
                    ))}
                    {userFollowers.length > 6 && (
                      <div className="flex justify-end gap-4">
                        {showAllFollowers ? (
                          <Button
                            variant="link"
                            size="sm"
                            onClick={() => setShowAllFollowers(false)}
                            aria-label="Show less followers"
                          >
                            Show less
                          </Button>
                        ) : (
                          <>
                            <Button
                              variant="link"
                              size="sm"
                              onClick={() => setShowAllFollowers(true)}
                              aria-label="Show more followers"
                            >
                              Show more
                            </Button>
                            <Button
                              variant="link"
                              size="sm"
                              onClick={() => navigate('/app/profile/followers')}
                              aria-label="See all followers"
                            >
                              See all
                            </Button>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="text-sm text-muted-foreground">No followers yet.</div>
                )}
              </TabsContent>
              <TabsContent value="achievements" className="space-y-4">
                {achievements.length > 0 ? (
                  <AchievementGrid 
                    achievements={achievements.map((ua: any) => ({
                      ...ua.achievements,
                      earned_at: ua.earned_at
                    }))} 
                    maxDisplay={showAllAchievements ? achievements.length : 8}
                    size="sm"
                    layout="card"
                    showScore={true}
                  />
                ) : (
                  <NoAchievementsEmptyState onFindGames={() => navigate('/app')} />
                )}
                {achievements.length > 8 && (
                  <div className="flex justify-end gap-4">
                    {showAllAchievements ? (
                      <Button
                        variant="link"
                        size="sm"
                        onClick={() => setShowAllAchievements(false)}
                        aria-label="Show fewer achievements"
                      >
                        Show less
                      </Button>
                    ) : (
                      <>
                        <Button
                          variant="link"
                          size="sm"
                          onClick={() => setShowAllAchievements(true)}
                          aria-label="Show more achievements"
                        >
                          Show more
                        </Button>
                        <Button
                          variant="link"
                          size="sm"
                          onClick={() => navigate('/app/profile/achievements')}
                          aria-label="See all achievements"
                        >
                          See all
                        </Button>
                      </>
                    )}
                  </div>
                )}
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>

        {/* Sports Preferences */}
        <Card>
          <CardHeader>
            <CardTitle>Sports I Play</CardTitle>
          </CardHeader>
          <CardContent>
            {displaySports.length > 0 ? (
              <div className="flex flex-wrap gap-2">
                {displaySports.map((sport) => (
                  <Badge key={sport} variant="secondary">
                    {sport}
                  </Badge>
                ))}
              </div>
            ) : (
              <NoSportsSelectedEmptyState 
                onEditProfile={() => navigate('/app/profile/edit')} 
              />
            )}
          </CardContent>
        </Card>

        {/* My Tribes */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Users2 className="w-5 h-5" />
              My Tribes ({userTribes.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {tribesLoading ? (
              <div className="text-center py-4 text-muted-foreground">
                <div className="animate-spin w-6 h-6 border-2 border-primary border-t-transparent rounded-full mx-auto mb-2"></div>
                <p className="text-sm">Loading tribes...</p>
              </div>
            ) : userTribes.length > 0 ? (
              <div className="space-y-2">
                {userTribes.map((tribe: any) => (
                  <div
                    key={tribe.id}
                    className="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-muted/50 transition-colors"
                    onClick={() => navigate(`/tribe/${tribe.id}`)}
                  >
                    <div className="flex items-center gap-3 flex-1 min-w-0">
                      <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                        {tribe.avatar_url ? (
                          <img src={tribe.avatar_url} alt={tribe.name} className="w-full h-full rounded-full object-cover" />
                        ) : (
                          <span className="text-primary font-semibold">
                            {tribe.name.substring(0, 2).toUpperCase()}
                          </span>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-medium truncate">{tribe.name}</div>
                        <div className="text-sm text-muted-foreground flex items-center gap-2">
                          <span>{tribe.member_count} members</span>
                          <span>‚Ä¢</span>
                          <span>{tribe.activity}</span>
                        </div>
                      </div>
                    </div>
                    {!tribe.is_public && (
                      <Badge variant="secondary" className="ml-2">Private</Badge>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <NoTribesEmptyState 
                onExplore={() => navigate('/app/tribes')}
              />
            )}
          </CardContent>
        </Card>

        {/* Sections below: keep Overview only to avoid duplicate content */}
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList id="profile-tabs" className="grid w-full grid-cols-1 sticky top-0 z-10 bg-background/90 backdrop-blur supports-[backdrop-filter]:bg-background/60">
            <TabsTrigger value="overview" onClick={() => { pendingScrollRef.current = 'overview-top'; }}>Overview</TabsTrigger>
          </TabsList>

          <TabsContent value="overview" className="space-y-6">
            <div id="overview-top" />
            {/* Recent Games */}
            <Card>
              <CardHeader>
                <CardTitle id="recent-games">Recent Games</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {loading ? (
                    <div className="text-center py-8 text-muted-foreground">
                      <div className="animate-spin w-6 h-6 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                      <p>Loading recent games...</p>
                    </div>
                  ) : recentGames.length > 0 ? (
                    recentGames.map((game: any, index: number) => (
                      <div key={game.id || index} className="flex items-center justify-between p-3 border rounded-lg">
                        <div className="flex-1">
                          <div className="font-medium">{game.title}</div>
                          <div className="text-sm text-muted-foreground">
                            {new Date(game.date).toLocaleDateString()} at {formatTimeString(game.time)}
                          </div>
                          <div className="text-xs text-muted-foreground mt-1">
                            {game.location}
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          {game.isHost && (
                            <Badge variant="secondary" className="text-xs">
                              Host
                            </Badge>
                          )}
                          <Badge variant="outline">{game.sport}</Badge>
                        </div>
                      </div>
                    ))
                  ) : (
                    <NoRecentGamesEmptyState 
                      onFindGames={() => navigate('/app')}
                    />
                  )}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Achievements shown inline in Social above */}

          {/* Following/Friends shown inline in Social above */}

          {/* Followers shown inline in Social above */}

        </Tabs>
      </div>
    </div>
  );
}

export default UserProfile;
```

`domains/users/components/UserTestingSurvey.tsx`:

```tsx
import { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { RadioGroup, RadioGroupItem } from '@/shared/components/ui/radio-group';
import { Checkbox } from '@/shared/components/ui/checkbox';
import { Label } from '@/shared/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select';
import { Progress } from '@/shared/components/ui/progress';
import { X, CheckCircle, MessageSquare } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/shared/components/ui/dialog';
import { SupabaseService } from '@/core/database/supabaseService';
import { toast } from 'sonner';

interface UserTestingSurveyProps {
  isOpen: boolean;
  onClose: () => void;
  triggerContext?: 'onboarding' | 'game_creation' | 'game_join' | 'general';
}

interface SurveyData {
  tester_name: string;
  device_browser: string;
  session_duration: string;
  signup_success: string;
  signup_method: string[];
  create_game: string;
  join_game: string;
  onboarding_rating: number;
  game_creation_rating: number;
  navigation_rating: number;
  performance_rating: number;
  technical_issues: string[];
  bug_details: string;
  positive_feedback: string;
  confusion_feedback: string;
  missing_features: string;
  likelihood_rating: number;
  additional_comments: string;
  trigger_context: string;
}

export function UserTestingSurvey({ isOpen, onClose, triggerContext = 'general' }: UserTestingSurveyProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [formData, setFormData] = useState<Partial<SurveyData>>({
    trigger_context: triggerContext,
    signup_method: [],
    technical_issues: []
  });

  const totalSteps = 6;
  const progress = (currentStep / totalSteps) * 100;

  const updateFormData = (field: keyof SurveyData, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleArrayUpdate = (field: 'signup_method' | 'technical_issues', value: string, checked: boolean) => {
    const currentArray = formData[field] || [];
    if (checked) {
      updateFormData(field, [...currentArray, value]);
    } else {
      updateFormData(field, currentArray.filter(item => item !== value));
    }
  };

  const handleSubmit = async () => {
    setIsSubmitting(true);
    try {
      // Create the survey data object
      const surveyData = {
        ...formData,
        signup_method: formData.signup_method?.join(',') || '',
        technical_issues: formData.technical_issues?.join(',') || '',
        submitted_at: new Date().toISOString()
      };

      // Store in Supabase (you'll need to create this table)
      await SupabaseService.submitUserTestingFeedback(surveyData);
      
      setIsSubmitted(true);
      toast.success('Thank you! Your feedback has been submitted.');
      
      // Auto-close after 3 seconds
      setTimeout(() => {
        onClose();
        setIsSubmitted(false);
        setCurrentStep(1);
        setFormData({ trigger_context: triggerContext, signup_method: [], technical_issues: [] });
      }, 3000);
      
    } catch (error) {
      console.error('Survey submission error:', error);
      toast.error('Failed to submit feedback. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const RatingScale = ({ name, value, onChange, required = false }: {
    name: string;
    value: number;
    onChange: (value: number) => void;
    required?: boolean;
  }) => (
    <div className="space-y-2">
      <div className="flex justify-between items-center bg-muted p-4 rounded-lg">
        <RadioGroup
          value={value?.toString()}
          onValueChange={(val: string) => onChange(parseInt(val))}
          className="flex gap-4"
        >
          {[1, 2, 3, 4, 5].map((num) => (
            <div key={num} className="flex flex-col items-center space-y-1">
              <RadioGroupItem value={num.toString()} id={`${name}-${num}`} />
              <Label htmlFor={`${name}-${num}`} className="text-sm">{num}</Label>
            </div>
          ))}
        </RadioGroup>
      </div>
      <div className="flex justify-between text-xs text-muted-foreground">
        <span>Poor</span>
        <span>Excellent</span>
      </div>
    </div>
  );

  if (isSubmitted) {
    return (
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent className="max-w-md">
          <div className="text-center space-y-4 py-6">
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto" />
            <h3 className="text-xl font-semibold">Thank You!</h3>
            <p className="text-muted-foreground">
              Your feedback has been recorded and will help improve TribeUp.
            </p>
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <div className="flex items-center justify-between">
            <DialogTitle className="flex items-center gap-2">
              <MessageSquare className="w-5 h-5" />
              TribeUp User Testing Survey
            </DialogTitle>
            <Button variant="ghost" size="icon" onClick={onClose}>
              <X className="w-4 h-4" />
            </Button>
          </div>
          <div className="space-y-2">
            <Progress value={progress} className="w-full" />
            <p className="text-sm text-muted-foreground">
              Step {currentStep} of {totalSteps} ‚Ä¢ Help us improve your experience
            </p>
          </div>
        </DialogHeader>

        <div className="space-y-6">
          {/* Step 1: Basic Info */}
          {currentStep === 1 && (
            <Card>
              <CardHeader>
                <CardTitle>üìã Testing Session Info</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label htmlFor="tester_name">Your name or initials *</Label>
                  <Input
                    id="tester_name"
                    value={formData.tester_name || ''}
                    onChange={(e) => updateFormData('tester_name', e.target.value)}
                    placeholder="Enter your name or initials"
                  />
                </div>
                
                <div>
                  <Label htmlFor="device_browser">Device/Browser used *</Label>
                  <Select value={formData.device_browser} onValueChange={(value) => updateFormData('device_browser', value)}>
                    <SelectTrigger>
                      <SelectValue placeholder="Select device and browser" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="desktop_chrome">Desktop - Chrome</SelectItem>
                      <SelectItem value="desktop_safari">Desktop - Safari</SelectItem>
                      <SelectItem value="desktop_firefox">Desktop - Firefox</SelectItem>
                      <SelectItem value="mobile_ios_safari">Mobile - iOS Safari</SelectItem>
                      <SelectItem value="mobile_android_chrome">Mobile - Android Chrome</SelectItem>
                      <SelectItem value="other">Other</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                
                <div>
                  <Label htmlFor="session_duration">Testing session duration</Label>
                  <Input
                    id="session_duration"
                    value={formData.session_duration || ''}
                    onChange={(e) => updateFormData('session_duration', e.target.value)}
                    placeholder="e.g., 30 minutes"
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 2: Task Completion */}
          {currentStep === 2 && (
            <Card>
              <CardHeader>
                <CardTitle>‚úÖ Task Completion Check</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label className="text-base font-medium">Were you able to successfully sign up for TribeUp? *</Label>
                  <RadioGroup
                    value={formData.signup_success}
                    onValueChange={(value: string) => updateFormData('signup_success', value)}
                    className="mt-2"
                  >
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="yes" id="signup_yes" />
                      <Label htmlFor="signup_yes">Yes, completed successfully</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="partial" id="signup_partial" />
                      <Label htmlFor="signup_partial">Partially (encountered issues)</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="no" id="signup_no" />
                      <Label htmlFor="signup_no">No, could not complete</Label>
                    </div>
                  </RadioGroup>
                </div>

                <div>
                  <Label className="text-base font-medium">Which signup method did you use?</Label>
                  <div className="space-y-2 mt-2">
                    <div className="flex items-center space-x-2">
                      <Checkbox
                        id="email_pass"
                        checked={formData.signup_method?.includes('email_password')}
                        onCheckedChange={(checked) => handleArrayUpdate('signup_method', 'email_password', checked as boolean)}
                      />
                      <Label htmlFor="email_pass">Email/Password</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Checkbox
                        id="google_oauth"
                        checked={formData.signup_method?.includes('google_oauth')}
                        onCheckedChange={(checked) => handleArrayUpdate('signup_method', 'google_oauth', checked as boolean)}
                      />
                      <Label htmlFor="google_oauth">Google OAuth</Label>
                    </div>
                  </div>
                </div>

                <div>
                  <Label className="text-base font-medium">Were you able to create a new game? *</Label>
                  <RadioGroup
                    value={formData.create_game}
                    onValueChange={(value: string) => updateFormData('create_game', value)}
                    className="mt-2"
                  >
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="yes" id="create_yes" />
                      <Label htmlFor="create_yes">Yes, successfully created</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="partial" id="create_partial" />
                      <Label htmlFor="create_partial">Started but didn't finish</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="no" id="create_no" />
                      <Label htmlFor="create_no">No, couldn't create</Label>
                    </div>
                  </RadioGroup>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 3: Experience Ratings */}
          {currentStep === 3 && (
            <Card>
              <CardHeader>
                <CardTitle>‚≠ê User Experience Ratings</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label className="text-base font-medium">How intuitive was the onboarding process? *</Label>
                  <RatingScale
                    name="onboarding"
                    value={formData.onboarding_rating || 0}
                    onChange={(value) => updateFormData('onboarding_rating', value)}
                    required
                  />
                </div>

                <div>
                  <Label className="text-base font-medium">How easy was it to create a game? *</Label>
                  <RatingScale
                    name="game_creation"
                    value={formData.game_creation_rating || 0}
                    onChange={(value) => updateFormData('game_creation_rating', value)}
                    required
                  />
                </div>

                <div>
                  <Label className="text-base font-medium">How clear was the navigation? *</Label>
                  <RatingScale
                    name="navigation"
                    value={formData.navigation_rating || 0}
                    onChange={(value) => updateFormData('navigation_rating', value)}
                    required
                  />
                </div>

                <div>
                  <Label className="text-base font-medium">How was the overall app performance? *</Label>
                  <RatingScale
                    name="performance"
                    value={formData.performance_rating || 0}
                    onChange={(value) => updateFormData('performance_rating', value)}
                    required
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 4: Technical Issues */}
          {currentStep === 4 && (
            <Card>
              <CardHeader>
                <CardTitle>üêõ Technical Issues & Bugs</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label className="text-base font-medium">Did you encounter any of these issues? (Check all that apply)</Label>
                  <div className="space-y-2 mt-2">
                    {[
                      { value: 'infinite_loading', label: 'Infinite loading screens' },
                      { value: 'app_crashes', label: 'App crashes or white screens' },
                      { value: 'forms_broken', label: 'Forms not working properly' },
                      { value: 'buttons_unresponsive', label: 'Buttons not responding' },
                      { value: 'map_issues', label: 'Map not loading or working' },
                      { value: 'auth_problems', label: 'Login/signup problems' },
                      { value: 'no_issues', label: 'No technical issues encountered' }
                    ].map((issue) => (
                      <div key={issue.value} className="flex items-center space-x-2">
                        <Checkbox
                          id={issue.value}
                          checked={formData.technical_issues?.includes(issue.value)}
                          onCheckedChange={(checked) => handleArrayUpdate('technical_issues', issue.value, checked as boolean)}
                        />
                        <Label htmlFor={issue.value}>{issue.label}</Label>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <Label htmlFor="bug_details">Please describe any specific bugs or errors</Label>
                  <Textarea
                    id="bug_details"
                    value={formData.bug_details || ''}
                    onChange={(e) => updateFormData('bug_details', e.target.value)}
                    placeholder="Describe any technical issues, error messages, or unexpected behavior..."
                    rows={4}
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 5: Feedback */}
          {currentStep === 5 && (
            <Card>
              <CardHeader>
                <CardTitle>üí≠ Usability Feedback</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label htmlFor="positive_feedback">What features did you find most useful or well-designed?</Label>
                  <Textarea
                    id="positive_feedback"
                    value={formData.positive_feedback || ''}
                    onChange={(e) => updateFormData('positive_feedback', e.target.value)}
                    placeholder="Tell us what worked well for you..."
                    rows={3}
                  />
                </div>

                <div>
                  <Label htmlFor="confusion_feedback">What was the most confusing or frustrating part?</Label>
                  <Textarea
                    id="confusion_feedback"
                    value={formData.confusion_feedback || ''}
                    onChange={(e) => updateFormData('confusion_feedback', e.target.value)}
                    placeholder="Help us understand what didn't work well..."
                    rows={3}
                  />
                </div>

                <div>
                  <Label htmlFor="missing_features">What features are missing that you'd expect to see?</Label>
                  <Textarea
                    id="missing_features"
                    value={formData.missing_features || ''}
                    onChange={(e) => updateFormData('missing_features', e.target.value)}
                    placeholder="What functionality would you like to see added?"
                    rows={3}
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 6: Overall Assessment */}
          {currentStep === 6 && (
            <Card>
              <CardHeader>
                <CardTitle>üéØ Overall Assessment</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label className="text-base font-medium">How likely would you be to use TribeUp to organize sports activities? *</Label>
                  <RatingScale
                    name="likelihood"
                    value={formData.likelihood_rating || 0}
                    onChange={(value) => updateFormData('likelihood_rating', value)}
                    required
                  />
                  <div className="flex justify-between text-xs text-muted-foreground mt-2">
                    <span>Very unlikely</span>
                    <span>Very likely</span>
                  </div>
                </div>

                <div>
                  <Label htmlFor="additional_comments">Any additional comments or suggestions?</Label>
                  <Textarea
                    id="additional_comments"
                    value={formData.additional_comments || ''}
                    onChange={(e) => updateFormData('additional_comments', e.target.value)}
                    placeholder="Share any other thoughts about your TribeUp experience..."
                    rows={4}
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Navigation Buttons */}
          <div className="flex justify-between pt-4">
            <Button
              variant="outline"
              onClick={() => setCurrentStep(prev => Math.max(1, prev - 1))}
              disabled={currentStep === 1}
            >
              Previous
            </Button>

            {currentStep < totalSteps ? (
              <Button
                onClick={() => setCurrentStep(prev => Math.min(totalSteps, prev + 1))}
              >
                Next
              </Button>
            ) : (
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600"
              >
                {isSubmitting ? 'Submitting...' : 'Submit Feedback'}
              </Button>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

```

`domains/users/pages/AchievementsPage.tsx`:

```tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Trophy } from 'lucide-react';
import { useAppStore } from '@/store/appStore';
import { useUserAchievements } from '@/domains/users/hooks/useUserProfile';
import { AchievementGrid } from '@/domains/users/components/AchievementBadge';

export default function AchievementsPage() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { data: achievements = [], isLoading } = useUserAchievements(user?.id || '');

  return (
    <div className="px-4 py-6 space-y-6">
      <div className="flex items-center gap-3">
        <Button variant="outline" size="sm" onClick={() => navigate(-1)}>Back</Button>
        <h1 className="text-xl font-semibold">Achievements</h1>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Trophy className="w-5 h-5" />
            All Achievements ({achievements.length})
          </CardTitle>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="py-6 text-center text-muted-foreground">Loading...</div>
          ) : achievements.length > 0 ? (
            <AchievementGrid 
              achievements={achievements.map((ua: any) => ({
                ...ua.achievements,
                earned_at: ua.earned_at
              }))}
              maxDisplay={48}
              size="md"
              layout="card"
              showScore={true}
            />
          ) : (
            <div className="py-6 text-center text-muted-foreground">No achievements yet.</div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/users/pages/FollowersPage.tsx`:

```tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { useAppStore } from '@/store/appStore';
import { useUserFollowers, useFollowUser } from '@/domains/users/hooks/useFriends';
import { useDeepLinks } from '@/shared/hooks/useDeepLinks';

export default function FollowersPage() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { navigateToUser } = useDeepLinks();
  const { data: userFollowers = [], isLoading } = useUserFollowers(user?.id);
  const followMutation = useFollowUser();

  return (
    <div className="px-4 py-6 space-y-6">
      <div className="flex items-center gap-3">
        <Button variant="outline" size="sm" onClick={() => navigate(-1)}>Back</Button>
        <h1 className="text-xl font-semibold">Followers</h1>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>People who follow you ({userFollowers.length})</CardTitle>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="py-6 text-center text-muted-foreground">Loading...</div>
          ) : userFollowers.length > 0 ? (
            <div className="space-y-2">
              {userFollowers.map((follower) => (
                <div
                  key={follower.id}
                  className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors"
                >
                  <div
                    className="flex items-center gap-3 cursor-pointer"
                    onClick={() => navigateToUser(follower.id)}
                  >
                    <Avatar className="w-10 h-10">
                      <AvatarImage src={follower.avatar_url || undefined} />
                      <AvatarFallback>
                        {(follower.display_name || follower.username || 'U').charAt(0).toUpperCase()}
                      </AvatarFallback>
                    </Avatar>
                    <div>
                      <p className="font-medium">{follower.display_name || follower.username || 'User'}</p>
                      {follower.bio && (
                        <p className="text-sm text-muted-foreground truncate max-w-[240px]">{follower.bio}</p>
                      )}
                    </div>
                  </div>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => followMutation.mutate(follower.id)}
                    disabled={followMutation.isPending}
                  >
                    {follower.is_following ? 'Unfollow' : 'Follow back'}
                  </Button>
                </div>
              ))}
            </div>
          ) : (
            <div className="py-6 text-center text-muted-foreground">You don‚Äôt have any followers yet.</div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/users/pages/FollowingPage.tsx`:

```tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { useAppStore } from '@/store/appStore';
import { useUserFriends, useFollowUser } from '@/domains/users/hooks/useFriends';
import { useDeepLinks } from '@/shared/hooks/useDeepLinks';

export default function FollowingPage() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const { navigateToUser } = useDeepLinks();
  const { data: userFriends = [], isLoading } = useUserFriends(user?.id);
  const followMutation = useFollowUser();

  return (
    <div className="px-4 py-6 space-y-6">
      <div className="flex items-center gap-3">
        <Button variant="outline" size="sm" onClick={() => navigate(-1)}>Back</Button>
        <h1 className="text-xl font-semibold">Following</h1>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>People you follow ({userFriends.length})</CardTitle>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="py-6 text-center text-muted-foreground">Loading...</div>
          ) : userFriends.length > 0 ? (
            <div className="space-y-2">
              {userFriends.map((friend) => (
                <div
                  key={friend.id}
                  className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors"
                >
                  <div
                    className="flex items-center gap-3 cursor-pointer flex-1"
                    onClick={() => navigateToUser(friend.id)}
                  >
                    <Avatar className="w-10 h-10">
                      <AvatarImage src={friend.avatar_url || undefined} />
                      <AvatarFallback>
                        {(friend.display_name || friend.username || 'U').charAt(0).toUpperCase()}
                      </AvatarFallback>
                    </Avatar>
                    <div>
                      <p className="font-medium">{friend.display_name || friend.username || 'User'}</p>
                      {friend.bio && (
                        <p className="text-sm text-muted-foreground truncate max-w-[240px]">{friend.bio}</p>
                      )}
                    </div>
                  </div>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={(e) => {
                      e.stopPropagation();
                      followMutation.mutate(friend.id);
                    }}
                    disabled={followMutation.isPending}
                  >
                    Unfollow
                  </Button>
                </div>
              ))}
            </div>
          ) : (
            <div className="py-6 text-center text-muted-foreground">You are not following anyone yet.</div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

```

`domains/weather/components/WeatherWidget.tsx`:

```tsx
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Loader2, Cloud, AlertTriangle } from 'lucide-react';
import { WeatherService, WeatherData } from '@/domains/weather/services/weatherService';

interface WeatherWidgetProps {
  latitude?: number;
  longitude?: number;
  location?: string;
  gameDateTime: Date;
  duration?: number; // Game duration in minutes
  sport?: string; // Sport type for specific recommendations
  className?: string;
}

export function WeatherWidget({ 
  latitude, 
  longitude, 
  location, 
  gameDateTime,
  duration = 60,
  sport = 'general',
  className 
}: WeatherWidgetProps) {
  const [weather, setWeather] = useState<WeatherData | null>(null);
  const [enhancedRecommendation, setEnhancedRecommendation] = useState<string>('');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchWeather = async () => {
      setLoading(true);
      setError(null);
      
      try {
        let weatherData: WeatherData | null = null;
        let finalLat = latitude;
        let finalLng = longitude;
        
        // If we don't have coordinates, use Google Geocoding API for precise location
        if ((!latitude || !longitude) && location) {
          console.log(`üó∫Ô∏è Using Google Geocoding for location: ${location}`);
          const googleApiKey = (import.meta as any).env?.VITE_GOOGLE_MAPS_API_KEY;
          
          if (googleApiKey) {
            try {
              const geocodeResponse = await fetch(
                `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(location)}&key=${googleApiKey}`
              );
              
              if (geocodeResponse.ok) {
                const geocodeData = await geocodeResponse.json();
                console.log('üó∫Ô∏è Google geocoding results:', geocodeData);
                
                if (geocodeData.status === 'OK' && geocodeData.results && geocodeData.results.length > 0) {
                  finalLat = geocodeData.results[0].geometry.location.lat;
                  finalLng = geocodeData.results[0].geometry.location.lng;
                  console.log(`üéØ Google Maps coordinates: ${finalLat}, ${finalLng}`);
                  
                  // Also get the formatted address for better accuracy
                  const formattedAddress = geocodeData.results[0].formatted_address;
                  console.log(`üìç Formatted address: ${formattedAddress}`);
                } else {
                  console.warn('üó∫Ô∏è Google geocoding failed:', geocodeData.status, geocodeData.error_message);
                }
              } else {
                console.error('üó∫Ô∏è Google geocoding HTTP error:', geocodeResponse.status);
              }
            } catch (geocodeError) {
              console.error('‚ùå Google geocoding error:', geocodeError);
            }
          } else {
            console.warn('üó∫Ô∏è Google Maps API key not available');
          }
        }
        
        // Now fetch weather with the best coordinates we have
        if (finalLat && finalLng) {
          console.log(`üå§Ô∏è Fetching weather for coordinates: ${finalLat}, ${finalLng}`);
          console.log(`üïê Game time: ${gameDateTime.toISOString()} (${gameDateTime.toLocaleString()})`);
          console.log(`üïê Current time: ${new Date().toISOString()} (${new Date().toLocaleString()})`);
          
          const hoursDiff = (gameDateTime.getTime() - new Date().getTime()) / (1000 * 60 * 60);
          console.log(`‚è∞ Game is ${hoursDiff > 0 ? `in ${Math.round(hoursDiff)} hours` : `${Math.round(Math.abs(hoursDiff))} hours ago`}`);
          
          // Also get current weather for comparison
          const currentWeather = await WeatherService.getCurrentWeather(finalLat, finalLng);
          console.log(`üå°Ô∏è CURRENT weather: ${currentWeather?.temperature}¬∞F, ${currentWeather?.condition} - ${currentWeather?.description}`);
          
          weatherData = await WeatherService.getGameWeather(finalLat, finalLng, gameDateTime);
          
          if (weatherData) {
            console.log(`üéØ GAME weather: ${weatherData.temperature}¬∞F, ${weatherData.condition} - ${weatherData.description}`);
            console.log(`üìç Compare with: https://openweathermap.org/find?q=${finalLat},${finalLng}`);
            
            // Get enhanced recommendations
            const enhanced = await WeatherService.getEnhancedWeatherRecommendation(
              finalLat, finalLng, gameDateTime, duration, sport
            );
            setEnhancedRecommendation(enhanced);
          }
        }
        
        // Fallback to zipcode extraction if coordinates failed
        if (!weatherData && location) {
          const zipcode = WeatherService.extractZipcode(location);
          if (zipcode) {
            console.log(`üå§Ô∏è Fallback: Using zipcode ${zipcode}`);
            weatherData = await WeatherService.getWeatherByZipcode(zipcode, gameDateTime);
            
            if (weatherData) {
              // Try to get enhanced recommendations with zipcode fallback
              const enhanced = WeatherService.getWeatherRecommendation(weatherData);
              setEnhancedRecommendation(enhanced);
            }
          }
        }
        
        // Final fallback to mock data
        if (!weatherData) {
          console.warn('üå§Ô∏è Using mock weather data - no valid location found');
          weatherData = {
            temperature: 72,
            condition: 'Clear',
            description: 'Weather data unavailable for this location',
            humidity: 65,
            windSpeed: 8,
            precipitation: 0,
            icon: 'üå§Ô∏è',
            isOutdoorFriendly: true,
          };
        }
        
        setWeather(weatherData);
      } catch (err) {
        console.error('Weather fetch error:', err);
        setError('Unable to load weather data');
      } finally {
        setLoading(false);
      }
    };

    // Only fetch if we have location data
    if (location) {
      fetchWeather();
    } else {
      setLoading(false);
      setError('Location not available');
    }
  }, [latitude, longitude, location, gameDateTime]);

  if (loading) {
    return (
      <Card className={className}>
        <CardHeader className="pb-3">
          <CardTitle className="flex items-center gap-2 text-sm">
            <Cloud className="w-4 h-4" />
            Weather Forecast
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center justify-center py-4">
            <Loader2 className="w-5 h-5 animate-spin text-muted-foreground" />
            <span className="ml-2 text-sm text-muted-foreground">Loading weather...</span>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error || !weather) {
    return (
      <Card className={className}>
        <CardHeader className="pb-3">
          <CardTitle className="flex items-center gap-2 text-sm">
            <Cloud className="w-4 h-4" />
            Weather Forecast
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            <AlertTriangle className="w-4 h-4" />
            {error || 'Weather data unavailable'}
          </div>
        </CardContent>
      </Card>
    );
  }

  const getGameTimeText = () => {
    const now = new Date();
    const timeDiff = gameDateTime.getTime() - now.getTime();
    const hoursDiff = Math.round(timeDiff / (1000 * 60 * 60));
    
    if (hoursDiff < 0) {
      return 'Game time';
    } else if (hoursDiff < 24) {
      return `In ${hoursDiff} hours`;
    } else {
      const daysDiff = Math.round(hoursDiff / 24);
      return `In ${daysDiff} days`;
    }
  };

  return (
    <Card className={className}>
      <CardHeader className="pb-3">
        <CardTitle className="flex items-center gap-2 text-sm">
          <Cloud className="w-4 h-4" />
          Weather Forecast
          <Badge variant="outline" className="ml-auto text-xs">
            {getGameTimeText()}
          </Badge>
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        {/* Main Weather Info */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-2xl">{weather.icon}</span>
            <div>
              <div className="font-semibold">{weather.temperature}¬∞F</div>
              <div className="text-sm text-muted-foreground">{weather.description}</div>
            </div>
          </div>
          <div className="text-right text-sm text-muted-foreground">
            <div>Humidity: {weather.humidity}%</div>
            <div>Wind: {weather.windSpeed} mph</div>
          </div>
        </div>

        {/* Outdoor Friendly Badge */}
        <div className="flex items-center gap-2">
          <Badge 
            variant={weather.isOutdoorFriendly ? "default" : "destructive"}
            className="text-xs"
          >
            {weather.isOutdoorFriendly ? '‚úÖ Good for outdoor sports' : '‚ö†Ô∏è Check conditions'}
          </Badge>
        </div>

        {/* Weather Tips */}
        {enhancedRecommendation && (
          <div className="text-xs text-muted-foreground border-t pt-2">
            <div className="leading-relaxed">
              {enhancedRecommendation}
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

```

`pages/AuthCallback.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '@/core/database/supabase';
import { toast } from 'sonner';
import { Loader2 } from 'lucide-react';

function AuthCallback() {
  const navigate = useNavigate();

  useEffect(() => {
    const handleAuthCallback = async () => {
      try {
        console.log('[AuthCallback] Processing OAuth callback...');
        
        // Handle the OAuth callback with Supabase - this processes the URL hash/fragment
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('[AuthCallback] Session error:', error);
          toast.error('Authentication failed');
          navigate('/auth', { replace: true });
          return;
        }

        if (data.session) {
          console.log('[AuthCallback] Session found, user authenticated');
          
          // Check for pending game join
          const pendingGameId = localStorage.getItem('pendingGameJoin');
          if (pendingGameId) {
            console.log('[AuthCallback] Redirecting to pending game:', pendingGameId);
            localStorage.removeItem('pendingGameJoin');
            navigate(`/game/${pendingGameId}`, { replace: true });
          } else {
            console.log('[AuthCallback] Redirecting to home');
            navigate('/', { replace: true });
          }
        } else {
          console.log('[AuthCallback] No session found, checking URL for auth data...');
          
          // If no session, try to handle the OAuth callback from URL
          const urlParams = new URLSearchParams(window.location.search);
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          
          if (urlParams.get('code') || hashParams.get('access_token')) {
            console.log('[AuthCallback] OAuth data found in URL, waiting for session...');
            // Wait a bit for Supabase to process the OAuth callback
            setTimeout(async () => {
              const { data: retryData, error: retryError } = await supabase.auth.getSession();
              if (retryData.session) {
                console.log('[AuthCallback] Session found on retry');
                navigate('/', { replace: true });
              } else {
                console.error('[AuthCallback] Still no session after retry:', retryError);
                navigate('/auth', { replace: true });
              }
            }, 2000);
          } else {
            console.log('[AuthCallback] No OAuth data in URL');
            navigate('/auth', { replace: true });
          }
        }
      } catch (error) {
        console.error('[AuthCallback] Unexpected error:', error);
        toast.error('Authentication failed');
        navigate('/auth', { replace: true });
      }
    };

    // Add timeout to prevent infinite loading
    const timeoutId = setTimeout(() => {
      console.error('[AuthCallback] Timeout - redirecting to auth');
      toast.error('Authentication timed out');
      navigate('/auth', { replace: true });
    }, 10000); // 10 second timeout

    handleAuthCallback().finally(() => {
      clearTimeout(timeoutId);
    });

    return () => clearTimeout(timeoutId);
  }, [navigate]);

  return (
    <div className="min-h-screen bg-background flex items-center justify-center">
      <div className="text-center space-y-4">
        <Loader2 className="w-8 h-8 animate-spin mx-auto" />
        <h2 className="text-xl font-semibold">Completing sign in...</h2>
        <p className="text-muted-foreground">Please wait while we set up your account</p>
      </div>
    </div>
  );
}

export default AuthCallback;

```

`pages/DesignSystemShowcase.tsx`:

```tsx
import * as React from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Separator } from '@/shared/components/ui/separator';
import { ArrowLeft } from 'lucide-react';
import {
  Facepile,
  EmptyStateEnhanced,
  NoGamesFound,
  Leaderboard,
  StatGroup,
  ProgressCard,
  Wizard,
  FeedItem,
  type LeaderboardPlayer,
  type WizardStepType,
} from '@/shared/components/ui';
import { SportPicker, DEFAULT_SPORTS } from '@/domains/games/components/SportPicker';
import { RSVPSection } from '@/domains/games/components/RSVPSection';
import type { Attendee, RSVPStatus } from '@/domains/games/components/AttendeeList';
import { PlayerCard } from '@/domains/users/components/PlayerCard';
import { LocationPicker } from '@/domains/locations/components/LocationPicker';
import type { Location } from '@/domains/locations/components/LocationPicker';
import { Activity, Trophy, Star, Users, MapPin, Plus } from 'lucide-react';

/**
 * Design System Showcase Page
 * 
 * Interactive demo of all new design system components.
 * Accessible at /design-system route.
 */
export default function DesignSystemShowcase() {
  const navigate = useNavigate();
  const [currentWizardStep, setCurrentWizardStep] = React.useState(0);
  const [selectedSport, setSelectedSport] = React.useState<string>('');
  const [selectedLocation, setSelectedLocation] = React.useState<Location | undefined>();
  const [sortKey, setSortKey] = React.useState<string>('rating');
  const [sortDirection, setSortDirection] = React.useState<'asc' | 'desc'>('desc');

  // Mock data for demos
  const mockUsers = [
    { id: '1', name: 'John Doe', image: null, email: 'john@example.com' },
    { id: '2', name: 'Jane Smith', image: null, email: 'jane@example.com' },
    { id: '3', name: 'Mike Johnson', image: null, email: 'mike@example.com' },
    { id: '4', name: 'Sarah Williams', image: null, email: 'sarah@example.com' },
    { id: '5', name: 'Tom Brown', image: null, email: 'tom@example.com' },
    { id: '6', name: 'Emily Davis', image: null, email: 'emily@example.com' },
  ];

  const mockLeaderboardPlayers: LeaderboardPlayer[] = [
    {
      id: '1',
      name: 'John Doe',
      rank: 1,
      stats: { gamesPlayed: 50, wins: 35, rating: 4.8 },
    },
    {
      id: '2',
      name: 'Jane Smith',
      rank: 2,
      stats: { gamesPlayed: 45, wins: 30, rating: 4.7 },
    },
    {
      id: '3',
      name: 'Mike Johnson',
      rank: 3,
      stats: { gamesPlayed: 40, wins: 28, rating: 4.6 },
    },
  ];

  const mockAttendees: Attendee[] = [
    { id: '1', name: 'John Doe', avatar: null, status: 'going', isHost: true },
    { id: '2', name: 'Jane Smith', avatar: null, status: 'going' },
    { id: '3', name: 'Mike Johnson', avatar: null, status: 'maybe' },
    { id: '4', name: 'Sarah Williams', avatar: null, status: 'going' },
  ];

  const wizardSteps: WizardStepType[] = [
    {
      id: 'step1',
      title: 'Step 1',
      component: <div>Step 1 Content</div>,
      isValid: true,
    },
    {
      id: 'step2',
      title: 'Step 2',
      component: <div>Step 2 Content</div>,
      isValid: true,
    },
    {
      id: 'step3',
      title: 'Step 3',
      component: <div>Step 3 Content</div>,
      isValid: true,
    },
  ];

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>
              <ArrowLeft className="size-5" />
            </Button>
            <div>
              <h1 className="text-2xl font-bold">Design System Showcase</h1>
              <p className="text-sm text-muted-foreground">
                Interactive demos of all design system components
              </p>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-8 space-y-12">
        {/* Facepile */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Facepile Component</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div>
                <h3 className="text-sm font-semibold mb-3">Default (5 visible)</h3>
                <Facepile users={mockUsers} maxVisible={5} size="md" />
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">Small (3 visible)</h3>
                <Facepile users={mockUsers} maxVisible={3} size="sm" />
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">Large (5 visible)</h3>
                <Facepile users={mockUsers} maxVisible={5} size="lg" />
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Sport Picker */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Sport Picker Component</CardTitle>
            </CardHeader>
            <CardContent>
              <SportPicker
                selectedSport={selectedSport}
                onSportSelect={(sport) => setSelectedSport(sport.value)}
                showSearch
                showRecent
                recentSports={['basketball', 'soccer']}
                gridCols={3}
                size="md"
              />
            </CardContent>
          </Card>
        </section>

        {/* Leaderboard */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Leaderboard Component</CardTitle>
            </CardHeader>
            <CardContent>
              <Leaderboard
                players={mockLeaderboardPlayers}
                columns={[
                  { key: 'name', label: 'Player', sortable: false },
                  { key: 'gamesPlayed', label: 'Games', sortable: true },
                  { key: 'wins', label: 'Wins', sortable: true },
                  { key: 'rating', label: 'Rating', sortable: true },
                ]}
                sortKey={sortKey}
                sortDirection={sortDirection}
                onSort={(key) => {
                  setSortKey(key);
                  setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                }}
              />
            </CardContent>
          </Card>
        </section>

        {/* Player Card */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Player Card Component</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div>
                <h3 className="text-sm font-semibold mb-3">Card Variant</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <PlayerCard
                    player={{
                      id: '1',
                      name: 'John Doe',
                      avatar: null,
                      stats: { gamesPlayed: 50, wins: 35, rating: 4.8 },
                    }}
                    variant="card"
                    showStats
                  />
                </div>
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">List Variant</h3>
                <div className="space-y-2">
                  <PlayerCard
                    player={{
                      id: '1',
                      name: 'John Doe',
                      avatar: null,
                      stats: { gamesPlayed: 50, wins: 35, rating: 4.8 },
                    }}
                    variant="list"
                    showStats
                  />
                  <PlayerCard
                    player={{
                      id: '2',
                      name: 'Jane Smith',
                      avatar: null,
                      stats: { gamesPlayed: 45, wins: 30, rating: 4.7 },
                    }}
                    variant="list"
                    showStats
                  />
                </div>
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">Compact Variant</h3>
                <div className="space-y-2">
                  <PlayerCard
                    player={{
                      id: '1',
                      name: 'John Doe',
                      avatar: null,
                      stats: { rating: 4.8 },
                    }}
                    variant="compact"
                  />
                  <PlayerCard
                    player={{
                      id: '2',
                      name: 'Jane Smith',
                      avatar: null,
                      stats: { rating: 4.7 },
                    }}
                    variant="compact"
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* RSVP Section */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>RSVP Section Component</CardTitle>
            </CardHeader>
            <CardContent>
              <RSVPSection
                attendees={mockAttendees}
                userRSVPStatus="going"
                maxPlayers={20}
                currentPlayers={3}
                onRSVPChange={(status) => console.log('RSVP changed:', status)}
                onInvite={() => console.log('Invite clicked')}
                showFullList={true}
              />
            </CardContent>
          </Card>
        </section>

        {/* Stats Display */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Stats Display Components</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div>
                <h3 className="text-sm font-semibold mb-3">Stat Group</h3>
                <StatGroup
                  stats={[
                    { label: 'Games', value: 50, icon: <Activity className="size-4" /> },
                    { label: 'Wins', value: 35, icon: <Trophy className="size-4" /> },
                    { label: 'Rating', value: 4.8, icon: <Star className="size-4" /> },
                  ]}
                  columns={3}
                />
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">Progress Card</h3>
                <ProgressCard
                  label="Win Rate"
                  value={35}
                  max={50}
                  showPercentage
                  color="success"
                  icon={<Trophy className="size-4" />}
                />
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Wizard */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Wizard Component</CardTitle>
            </CardHeader>
            <CardContent>
              <Wizard
                steps={wizardSteps}
                currentStep={currentWizardStep}
                onStepChange={setCurrentWizardStep}
                onComplete={() => {
                  alert('Wizard completed!');
                  setCurrentWizardStep(0);
                }}
                showProgress
                showNavigation
              />
            </CardContent>
          </Card>
        </section>

        {/* Activity Feed */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Activity Feed Components</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <FeedItem
                user={{ id: '1', name: 'John Doe', avatar: null }}
                action="joined_game"
                timestamp={new Date()}
                content={{ title: 'Basketball Game', gameId: '123' }}
                likes={5}
                comments={2}
                onLike={() => console.log('Liked')}
                onComment={() => console.log('Comment')}
              />
              <FeedItem
                user={{ id: '2', name: 'Jane Smith', avatar: null }}
                action="created_game"
                timestamp={new Date(Date.now() - 3600000)}
                content={{ title: 'Soccer Match', gameId: '456' }}
                likes={10}
                comments={5}
              />
            </CardContent>
          </Card>
        </section>

        {/* Location Picker */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Location Picker Component</CardTitle>
            </CardHeader>
            <CardContent>
              <LocationPicker
                selectedLocation={selectedLocation}
                onLocationSelect={setSelectedLocation}
                showMap={false}
                showSearch
                showRecent
                recentLocations={[
                  {
                    name: 'UF Student Recreation Center',
                    address: 'Gainesville, FL',
                    latitude: 29.6436,
                    longitude: -82.3549,
                    isRecent: true,
                  },
                ]}
              />
            </CardContent>
          </Card>
        </section>

        {/* Empty States */}
        <section>
          <Card>
            <CardHeader>
              <CardTitle>Empty State Components</CardTitle>
            </CardHeader>
            <CardContent className="space-y-8">
              <div>
                <h3 className="text-sm font-semibold mb-3">No Results</h3>
                <EmptyStateEnhanced
                  variant="no-results"
                  title="No games found"
                  description="Try adjusting your filters"
                  primaryAction={{
                    label: "Clear Filters",
                    onClick: () => console.log('Clear filters'),
                  }}
                />
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">No Data</h3>
                <EmptyStateEnhanced
                  variant="no-data"
                  title="No activities yet"
                  description="Create your first activity to get started"
                  primaryAction={{
                    label: "Create Activity",
                    onClick: () => console.log('Create activity'),
                    icon: <Plus className="size-4" />,
                  }}
                />
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">Error State</h3>
                <EmptyStateEnhanced
                  variant="error"
                  title="Something went wrong"
                  description="We encountered an error. Please try again."
                  primaryAction={{
                    label: "Try Again",
                    onClick: () => console.log('Retry'),
                  }}
                />
              </div>
              <Separator />
              <div>
                <h3 className="text-sm font-semibold mb-3">No Games Found (Preset)</h3>
                <NoGamesFound onCreateGame={() => console.log('Create game')} />
              </div>
            </CardContent>
          </Card>
        </section>
      </div>
    </div>
  );
}

```

`pages/PublicHomeScreen.tsx`:

```tsx
import { useState, useMemo, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { MapPin, Calendar, Users, LogIn, UserPlus, Shield } from 'lucide-react';
import { useGamesWithCreators } from '@/domains/games/hooks/useGamesWithCreators';
import { useSimpleAuth } from '@/core/auth/SimpleAuthProvider';
import { useLocationWithPermissionModal } from '@/domains/locations/hooks/useLocationWithPermissionModal';
import { LocationPermissionModal } from '@/domains/locations/components/LocationPermissionModal';
import { UnifiedGameCard } from '@/domains/games/components/UnifiedGameCard';
import { GameCardSkeleton } from '@/domains/games/components/GameCardSkeleton';
import { Badge } from '@/shared/components/ui/badge';
import { Input } from '@/shared/components/ui/input';
import { useActivityFilters } from '@/domains/games/hooks/useActivityFilters';
import { ThemeToggle } from '@/shared/components/ui/theme-toggle';

export default function PublicHomeScreen() {
  const navigate = useNavigate();
  const { user, loading: authLoading } = useSimpleAuth();
  const { games, loading: isLoading, error } = useGamesWithCreators();
  const { 
    currentLocation, 
    permission, 
    getDistanceTo,
    showPermissionModal,
    setShowPermissionModal,
    requestLocationWithExplanation,
    handlePermissionAllow,
    handlePermissionDeny 
  } = useLocationWithPermissionModal();

  const [selectedSport, setSelectedSport] = useState('all');
  const [sortBy, setSortBy] = useState<'date' | 'distance'>('date');
  const [searchQuery, setSearchQuery] = useState('');

  // Redirect authenticated users to /app
  useEffect(() => {
    if (!authLoading && user) {
      navigate('/app', { replace: true });
    }
  }, [user, authLoading, navigate]);

  // Load persisted filters
  useEffect(() => {
    try {
      const raw = localStorage.getItem('publicFilters');
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed.selectedSport) setSelectedSport(parsed.selectedSport);
        if (parsed.sortBy) setSortBy(parsed.sortBy);
        if (parsed.searchQuery) setSearchQuery(parsed.searchQuery);
      }
    } catch {}
  }, []);

  // Persist filters
  useEffect(() => {
    const payload = { selectedSport, sortBy, searchQuery };
    try { localStorage.setItem('publicFilters', JSON.stringify(payload)); } catch {}
  }, [selectedSport, sortBy, searchQuery]);

  // Filter games
  const { filteredGames } = useActivityFilters({
    games,
    showFollowingOnly: false,
  });

  // Filter by sport + search
  const sportFilteredGames = useMemo(() => {
    const list = selectedSport === 'all'
      ? filteredGames
      : filteredGames.filter(game => game.sport === selectedSport);
    if (!searchQuery.trim()) return list;
    const q = searchQuery.toLowerCase();
    return list.filter(game => (
      game.title?.toLowerCase().includes(q) ||
      game.location?.toLowerCase().includes(q) ||
      game.sport?.toLowerCase().includes(q)
    ));
  }, [filteredGames, selectedSport, searchQuery]);

  // Get available sports
  const availableSports = useMemo(() => {
    const sports = new Set(games.map(game => game.sport));
    return Array.from(sports).sort();
  }, [games]);

  // Sort games (simple)
  const sortedGames = useMemo(() => {
    const list = [...sportFilteredGames];
    if (sortBy === 'date') {
      list.sort((a, b) => new Date(a.date + 'T' + a.time).getTime() - new Date(b.date + 'T' + b.time).getTime());
    } else if (sortBy === 'distance' && currentLocation) {
      list.sort((a, b) => {
        if (!a.latitude || !a.longitude) return 1;
        if (!b.latitude || !b.longitude) return -1;
        const da = getDistanceTo({ latitude: a.latitude, longitude: a.longitude }) ?? Infinity;
        const db = getDistanceTo({ latitude: b.latitude, longitude: b.longitude }) ?? Infinity;
        return da - db;
      });
    }
    return list;
  }, [sportFilteredGames, sortBy, currentLocation, getDistanceTo]);

  // Lightweight stats (only counts) for compact header
  const stats = useMemo(() => ({
    total: games.length,
    today: games.filter(g => g.date === new Date().toISOString().slice(0,10)).length,
  }), [games]);

  // (Second redirect effect removed - redundant)

  return (
    <div className="min-h-screen bg-background text-foreground">
      {/* Compact header */}
      <header className="border-b bg-background/90 backdrop-blur px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <div className="font-semibold text-lg">TribeUp</div>
            <div className="hidden sm:flex items-center gap-2 text-xs text-muted-foreground">
              <Calendar className="h-3.5 w-3.5" /> <span>{stats.total} active</span>
              <Users className="h-3.5 w-3.5" /> <span>{stats.today} today</span>
            </div>
          </div>
          <div className="flex gap-2">
            <ThemeToggle />
            {!user && (
              <>
                <Button size="sm" variant="outline" onClick={() => navigate('/auth')} className="gap-1">
                  <LogIn className="h-4 w-4" /> Sign In
                </Button>
                <Button size="sm" onClick={() => navigate('/auth')} className="gap-1">
                  <UserPlus className="h-4 w-4" /> Create Account
                </Button>
              </>
            )}
          </div>
        </div>
      </header>

      {/* Filters */}
      <div className="border-b bg-background sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
            {/* Sport Filter */}
            <div className="flex gap-2 overflow-x-auto w-full md:w-auto scrollbar-hide">
              <Badge
                variant={selectedSport === 'all' ? 'default' : 'outline'}
                className="cursor-pointer whitespace-nowrap px-3 py-1.5 text-xs font-medium"
                onClick={() => setSelectedSport('all')}
              >
                All Sports
              </Badge>
              {availableSports.map(sport => (
                <Badge
                  key={sport}
                  variant={selectedSport === sport ? 'default' : 'outline'}
                  className="cursor-pointer whitespace-nowrap px-3 py-1.5 text-xs font-medium"
                  onClick={() => setSelectedSport(sport)}
                >
                  {sport}
                </Badge>
              ))}
            </div>
            <div className="flex gap-2 items-center w-full md:w-auto">
              <div className="flex-1 md:flex-initial min-w-[160px]">
                <Input
                  value={searchQuery}
                  onChange={e => setSearchQuery(e.target.value)}
                  placeholder="Search games..."
                  className="h-8 text-xs"
                />
              </div>
              <Button
                variant={sortBy === 'date' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setSortBy('date')}
              >
                <Calendar className="mr-1 h-3.5 w-3.5" />
                Date
              </Button>
              <Button
                variant={sortBy === 'distance' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setSortBy('distance')}
                disabled={!currentLocation}
              >
                <MapPin className="mr-1 h-3.5 w-3.5" />
                Distance
              </Button>
              {searchQuery && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setSearchQuery('')}
                  className="text-xs"
                >Clear</Button>
              )}
            </div>
        </div>
      </div>

      {/* Content */}
      <main className="max-w-7xl mx-auto px-4 py-6">
        {/* Location Permission Prompt */}
        {permission === 'prompt' && (
          <div className="mb-4 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div className="flex items-start gap-3">
              <div className="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center">
                <MapPin className="h-5 w-5 text-blue-600 dark:text-blue-400" />
              </div>
              <div className="flex-1">
                <h3 className="font-medium text-blue-900 dark:text-blue-100">Find games near you</h3>
                <p className="text-sm text-blue-700 dark:text-blue-300 mt-1">
                  Enable location to discover nearby activities and sort by distance.
                </p>
                <div className="flex items-center gap-2 mt-2 text-xs text-blue-600 dark:text-blue-400">
                  <Shield className="h-3.5 w-3.5" />
                  <span>Your exact location is never shared with other users</span>
                </div>
                <Button size="sm" onClick={requestLocationWithExplanation} className="mt-3">
                  <MapPin className="h-4 w-4 mr-1" />
                  Enable Location
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* Loading State */}
        {isLoading && (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {[...Array(6)].map((_, i) => <GameCardSkeleton key={i} />)}
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="text-center py-12">
            <p className="text-red-600 mb-4">Failed to load games. Please try again.</p>
          </div>
        )}

        {/* Empty State */}
        {!isLoading && sortedGames.length === 0 && (
          <div className="py-16 text-center">
            <Users className="h-14 w-14 text-gray-300 mx-auto mb-4" />
            <h3 className="font-semibold mb-1">No games found</h3>
            <p className="text-sm text-gray-600 mb-4">{selectedSport !== 'all' ? `No ${selectedSport} games right now` : 'No games available right now'}</p>
            {!user && (
              <Button size="sm" onClick={() => navigate('/auth')} className="gap-1">
                <UserPlus className="h-4 w-4" /> Sign in to create a game
              </Button>
            )}
          </div>
        )}

        {/* Games Grid */}
        {!isLoading && sortedGames.length > 0 && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-semibold text-lg">
                {selectedSport !== 'all' ? `${selectedSport} games` : 'All games'}
                {searchQuery && <span className="text-xs font-normal text-muted-foreground ml-2">filtered</span>}
              </h2>
              <span className="text-xs text-gray-600">{sortedGames.length} total</span>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {sortedGames.map(game => {
                const distance = currentLocation && game.latitude && game.longitude
                  ? getDistanceTo({ latitude: game.latitude, longitude: game.longitude })
                  : null;
                return (
                  <UnifiedGameCard
                    key={game.id}
                    game={game}
                    variant="simple"
                    showJoinButton={false}
                    onSelect={() => navigate(`/public/game/${game.id}`)}
                    distance={distance ? `${distance.toFixed(1)} mi` : null}
                  />
                );
              })}
            </div>
          </div>
        )}
      </main>
      <footer className="px-4 py-8 text-center text-xs text-gray-500 border-t mt-8">
        <div className="max-w-7xl mx-auto">
          <p className="mb-4">Browse games publicly. Sign in when you're ready to join or create.</p>
          <div className="flex justify-center gap-4">
            <button 
              onClick={() => navigate('/legal/privacy')} 
              className="hover:text-foreground transition-colors underline-offset-2 hover:underline"
            >
              Privacy Policy
            </button>
            <span className="text-gray-300">|</span>
            <button 
              onClick={() => navigate('/legal/terms')} 
              className="hover:text-foreground transition-colors underline-offset-2 hover:underline"
            >
              Terms of Service
            </button>
          </div>
        </div>
      </footer>

      {/* Location Permission Modal */}
      <LocationPermissionModal
        open={showPermissionModal}
        onOpenChange={setShowPermissionModal}
        onAllow={handlePermissionAllow}
        onDeny={handlePermissionDeny}
      />
    </div>
  );
}

```

`pages/PublicHomeScreen_old.tsx`:

```tsx
import { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { MapPin, Calendar, Users, LogIn, UserPlus } from 'lucide-react';
import { useGamesWithCreators } from '@/domains/games/hooks/useGamesWithCreators';
import { useLocation } from '@/domains/locations/hooks/useLocation';
import { UnifiedGameCard } from '@/domains/games/components/UnifiedGameCard';
import { GameCardSkeleton } from '@/domains/games/components/GameCardSkeleton';
import { Badge } from '@/shared/components/ui/badge';
import { useActivityFilters } from '@/domains/games/hooks/useActivityFilters';

export default function PublicHomeScreen() {
  const navigate = useNavigate();
  const { games, loading: isLoading, error } = useGamesWithCreators();
  const { currentLocation, permission, requestLocation, getDistanceTo } = useLocation();
  
  const [selectedSport, setSelectedSport] = useState<string>('all');
  const [sortBy, setSortBy] = useState<'date' | 'distance'>('date');

  // Filter games
  const { filteredGames } = useActivityFilters({
    games,
    showFollowingOnly: false, // Public view doesn't filter by friends
  });

  // Filter by sport if selected
  const sportFilteredGames = useMemo(() => {
    if (selectedSport === 'all') return filteredGames;
    return filteredGames.filter(game => game.sport?.toLowerCase() === selectedSport.toLowerCase());
  }, [filteredGames, selectedSport]);

  // Sort games
  const sortedGames = useMemo(() => {
    const sorted = [...sportFilteredGames];
    
    if (sortBy === 'distance' && currentLocation) {
      sorted.sort((a, b) => {
        const distA = a.latitude && a.longitude 
          ? getDistanceTo({ latitude: a.latitude, longitude: a.longitude }, 'km') || 999
          : 999;
        const distB = b.latitude && b.longitude
          ? getDistanceTo({ latitude: b.latitude, longitude: b.longitude }, 'km') || 999
          : 999;
        return distA - distB;
      });
    } else {
      // Sort by date
      sorted.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time}`);
        const dateB = new Date(`${b.date}T${b.time}`);
        return dateA.getTime() - dateB.getTime();
      });
    }
    
    return sorted;
  }, [sportFilteredGames, sortBy, currentLocation, getDistanceTo]);

  // Get unique sports
  const availableSports = useMemo(() => {
    const sportsSet = new Set(games.map(g => g.sport).filter(Boolean));
    return Array.from(sportsSet).sort();
  }, [games]);

  // Stats for hero section
  const stats = useMemo(() => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    const gamesToday = games.filter(game => {
      const [year, month, day] = game.date.split('-').map(Number);
      const gameDate = new Date(year, month - 1, day);
      return gameDate.getTime() === today.getTime();
    }).length;
    
    const gamesNearby = currentLocation ? games.filter(game => {
      if (!game.latitude || !game.longitude) return false;
      const distanceKm = getDistanceTo({ latitude: game.latitude, longitude: game.longitude }, 'km');
      return distanceKm !== null && distanceKm <= 10;
    }).length : 0;
    
    return {
      total: games.length,
      today: gamesToday,
      nearby: gamesNearby,
    };
  }, [games, currentLocation, getDistanceTo]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100">
      {/* Modern Hero Section */}
      <div className="relative bg-gradient-to-br from-indigo-600 via-blue-600 to-cyan-500 text-white overflow-hidden">
        {/* Decorative elements */}
        <div className="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]" />
        <div className="absolute top-0 right-0 w-96 h-96 bg-white/10 rounded-full blur-3xl" />
        <div className="absolute bottom-0 left-0 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl" />
        
        <div className="relative max-w-7xl mx-auto px-4 py-16 md:py-24">
          <div className="text-center space-y-8">
            {/* Main Heading */}
            <div className="space-y-4">
              <Badge className="bg-white/20 text-white border-white/30 hover:bg-white/30 mb-4">
                üèÜ Join 1000+ Active Players
              </Badge>
              <h1 className="text-5xl md:text-7xl font-extrabold tracking-tight">
                Find Your Next
                <span className="block text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-orange-300">
                  Sports Adventure
                </span>
              </h1>
              <p className="text-xl md:text-2xl text-blue-100 max-w-3xl mx-auto font-light">
                Discover pickup games, connect with local players, and stay active in your community
              </p>
            </div>
            
            {/* Stats Cards */}
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-3xl mx-auto">
              <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105">
                <div className="flex items-center justify-center mb-2">
                  <Calendar className="w-6 h-6 text-yellow-300" />
                </div>
                <div className="text-4xl font-bold mb-1">{stats.total}</div>
                <div className="text-sm text-blue-100 font-medium">Active Games</div>
              </div>
              <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105">
                <div className="flex items-center justify-center mb-2">
                  <Users className="w-6 h-6 text-green-300" />
                </div>
                <div className="text-4xl font-bold mb-1">{stats.today}</div>
                <div className="text-sm text-blue-100 font-medium">Games Today</div>
              </div>
              <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105">
                <div className="flex items-center justify-center mb-2">
                  <MapPin className="w-6 h-6 text-pink-300" />
                </div>
                <div className="text-4xl font-bold mb-1">{stats.nearby}</div>
                <div className="text-sm text-blue-100 font-medium">Nearby You</div>
              </div>
            </div>
            
            {/* CTAs */}
            <div className="flex flex-col sm:flex-row gap-4 justify-center items-center pt-4">
              <Button 
                size="lg" 
                onClick={() => navigate('/login')}
                className="bg-white text-blue-600 hover:bg-blue-50 font-semibold text-lg px-10 py-6 rounded-xl shadow-2xl hover:shadow-xl transition-all duration-300 hover:scale-105"
              >
                <LogIn className="mr-2 h-5 w-5" />
                Sign In
              </Button>
              <Button 
                size="lg" 
                onClick={() => navigate('/login')}
                className="bg-gradient-to-r from-orange-500 to-pink-500 text-white hover:from-orange-600 hover:to-pink-600 font-semibold text-lg px-10 py-6 rounded-xl shadow-2xl hover:shadow-xl transition-all duration-300 hover:scale-105 border-0"
              >
                <UserPlus className="mr-2 h-5 w-5" />
                Get Started Free
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Filters Section */}
      <div className="sticky top-0 z-10 bg-white/80 backdrop-blur-lg border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
            {/* Sport Filter */}
            <div className="flex gap-2 overflow-x-auto pb-2 sm:pb-0 w-full sm:w-auto scrollbar-hide">
              <Badge
                variant={selectedSport === 'all' ? 'default' : 'outline'}
                className="cursor-pointer whitespace-nowrap px-4 py-2 text-sm font-medium transition-all hover:scale-105"
                onClick={() => setSelectedSport('all')}
              >
                All Sports
              </Badge>
              {availableSports.map(sport => (
                <Badge
                  key={sport}
                  variant={selectedSport === sport ? 'default' : 'outline'}
                  className="cursor-pointer whitespace-nowrap px-4 py-2 text-sm font-medium transition-all hover:scale-105"
                  onClick={() => setSelectedSport(sport)}
                >
                  {sport}
                </Badge>
              ))}
            </div>
            
            {/* Sort Options */}
            <div className="flex gap-2 w-full sm:w-auto">
              <Button
                variant={sortBy === 'date' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setSortBy('date')}
              >
                <Calendar className="mr-2 h-4 w-4" />
                Date
              </Button>
              <Button
                variant={sortBy === 'distance' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setSortBy('distance')}
                disabled={!currentLocation}
              >
                <MapPin className="mr-2 h-4 w-4" />
                Distance
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Games Grid */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        {/* Location Permission Prompt */}
        {permission === 'prompt' && (
          <div className="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="flex items-start gap-3">
              <MapPin className="h-5 w-5 text-blue-600 mt-0.5" />
              <div className="flex-1">
                <h3 className="font-semibold text-blue-900">Enable Location</h3>
                <p className="text-sm text-blue-700 mb-3">
                  See games near you and sort by distance
                </p>
                <Button size="sm" onClick={requestLocation}>
                  Enable Location
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* Loading State */}
        {isLoading && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[1, 2, 3, 4, 5, 6].map(i => (
              <GameCardSkeleton key={i} />
            ))}
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="text-center py-12">
            <p className="text-red-600 mb-4">Failed to load games. Please try again.</p>
          </div>
        )}

        {/* Empty State */}
        {!isLoading && sortedGames.length === 0 && (
          <div className="text-center py-20">
            <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-3xl p-12 max-w-md mx-auto border border-gray-200">
              <Users className="h-20 w-20 text-gray-400 mx-auto mb-6" />
              <h3 className="text-2xl font-bold text-gray-900 mb-3">
                No games found
              </h3>
              <p className="text-gray-600 mb-8 text-lg">
                {selectedSport !== 'all' 
                  ? `No ${selectedSport} games available right now` 
                  : 'No games available right now'}
              </p>
              <Button 
                size="lg"
                onClick={() => navigate('/login')}
                className="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700"
              >
                <UserPlus className="mr-2 h-5 w-5" />
                Sign in to create a game
              </Button>
            </div>
          </div>
        )}

        {/* Games Grid */}
        {!isLoading && sortedGames.length > 0 && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-3xl font-bold text-gray-900">
                  {selectedSport !== 'all' ? `${selectedSport} Games` : 'Discover Games'}
                </h2>
                <p className="text-gray-600 mt-1">
                  {sortedGames.length} {sortedGames.length === 1 ? 'game' : 'games'} available
                </p>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {sortedGames.map(game => {
                const distance = currentLocation && game.latitude && game.longitude
                  ? getDistanceTo({ latitude: game.latitude, longitude: game.longitude })
                  : null;
                
                return (
                  <div key={game.id} className="group relative">
                    <div className="transition-all duration-300 hover:scale-[1.02]">
                      <UnifiedGameCard
                        game={game}
                        variant="simple"
                        showJoinButton={false}
                        onSelect={() => navigate(`/public/game/${game.id}`)}
                        distance={distance ? `${distance.toFixed(1)} mi` : null}
                      />
                    </div>
                    {/* Login overlay for actions */}
                    <div className="absolute inset-0 bg-gradient-to-t from-blue-600/90 via-blue-600/40 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 rounded-xl flex items-end justify-center p-6 pointer-events-none">
                      <Button 
                        size="lg"
                        className="pointer-events-auto bg-white text-blue-600 hover:bg-blue-50 font-semibold shadow-xl transform translate-y-4 group-hover:translate-y-0 transition-all duration-300"
                        onClick={(e) => {
                          e.stopPropagation();
                          navigate('/login');
                        }}
                      >
                        <LogIn className="mr-2 h-5 w-5" />
                        Login to Join
                      </Button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>

      {/* Footer CTA */}
      <div className="relative bg-gradient-to-br from-indigo-600 via-blue-600 to-cyan-500 mt-20 overflow-hidden">
        <div className="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]" />
        <div className="absolute top-0 right-0 w-96 h-96 bg-white/10 rounded-full blur-3xl" />
        
        <div className="relative max-w-4xl mx-auto px-4 py-20 text-center">
          <h2 className="text-4xl md:text-5xl font-bold text-white mb-6">
            Ready to join the action?
          </h2>
          <p className="text-xl text-blue-100 mb-10 max-w-2xl mx-auto">
            Create an account to join games, meet players, and organize your own activities
          </p>
          <Button 
            size="lg"
            onClick={() => navigate('/login')}
            className="bg-white text-blue-600 hover:bg-blue-50 font-semibold text-lg px-12 py-6 rounded-xl shadow-2xl hover:shadow-xl transition-all duration-300 hover:scale-105"
          >
            <UserPlus className="mr-2 h-6 w-6" />
            Get Started Free
          </Button>
          
          {/* Features */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mt-16 text-white">
            <div className="space-y-3">
              <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mx-auto">
                <Calendar className="w-6 h-6" />
              </div>
              <h3 className="font-semibold text-lg">Join Anytime</h3>
              <p className="text-blue-100 text-sm">Browse and join games that fit your schedule</p>
            </div>
            <div className="space-y-3">
              <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mx-auto">
                <Users className="w-6 h-6" />
              </div>
              <h3 className="font-semibold text-lg">Meet Players</h3>
              <p className="text-blue-100 text-sm">Connect with active people in your community</p>
            </div>
            <div className="space-y-3">
              <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mx-auto">
                <MapPin className="w-6 h-6" />
              </div>
              <h3 className="font-semibold text-lg">Find Nearby</h3>
              <p className="text-blue-100 text-sm">Discover games happening close to you</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

```

`shared/components/common/AdminDashboard.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Input } from '@/shared/components/ui/input';
import { Textarea } from '@/shared/components/ui/textarea';
import { 
  ArrowLeft, 
  Users, 
  Calendar, 
  Shield, 
  Trash2, 
  UserCheck, 
  UserX,
  Eye,
  AlertTriangle,
  Activity
} from 'lucide-react';
import { toast } from 'sonner';
import { useAllUsers, useAdminAuditLog, useUpdateUserRole, useDeleteGame, useCanPerformAdminActions } from '@/shared/hooks/useAdmin';
import { useGames } from '@/domains/games/hooks/useGames';
import { useAppStore } from '@/store/appStore';

function AdminDashboard() {
  const navigate = useNavigate();
  const { user } = useAppStore();
  const [selectedTab, setSelectedTab] = useState<'overview' | 'users' | 'games' | 'audit'>('overview');
  const [deleteReason, setDeleteReason] = useState('');
  const [gameToDelete, setGameToDelete] = useState<string | null>(null);

  // Hooks
  const { data: allUsers, isLoading: usersLoading } = useAllUsers();
  const { data: games, isLoading: gamesLoading } = useGames();
  const { data: auditLog, isLoading: auditLoading } = useAdminAuditLog();
  const updateUserRoleMutation = useUpdateUserRole();
  const deleteGameMutation = useDeleteGame();
  const canPerform = useCanPerformAdminActions();

  // Check if user has admin access
  if (!canPerform?.canViewAuditLog) {
    return (
      <div className="min-h-screen bg-background p-4">
        <div className="max-w-2xl mx-auto">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Shield className="w-5 h-5" />
                Access Denied
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-muted-foreground mb-4">
                You don't have permission to access the admin dashboard.
              </p>
              <Button onClick={() => navigate('/')} variant="outline">
                <ArrowLeft className="w-4 h-4 mr-2" />
                Back to Home
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  // Check if user has admin access
  if (!user || user.role !== 'admin') {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="text-center">
              <Shield className="w-12 h-12 mx-auto mb-4 text-muted-foreground" />
              <h2 className="text-xl font-semibold mb-2">Access Denied</h2>
              <p className="text-muted-foreground mb-4">
                You don't have permission to access the admin dashboard.
              </p>
              <Button onClick={() => navigate('/')}>
                Return to Home
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const handleRoleUpdate = (userId: string, newRole: 'user' | 'moderator' | 'admin') => {
    if (userId === user.id && newRole !== 'admin') {
      toast.error('You cannot remove your own admin privileges');
      return;
    }
    
    updateUserRoleMutation.mutate({ userId, role: newRole });
  };

  const handleDeleteGame = (gameId: string) => {
    if (!deleteReason.trim()) {
      toast.error('Please provide a reason for deletion');
      return;
    }
    
    deleteGameMutation.mutate({ 
      gameId, 
      reason: deleteReason 
    }, {
      onSuccess: () => {
        setGameToDelete(null);
        setDeleteReason('');
      }
    });
  };

  const getRoleBadgeVariant = (role: string) => {
    switch (role) {
      case 'admin': return 'destructive';
      case 'moderator': return 'default';
      default: return 'secondary';
    }
  };

  const tabs = [
    { id: 'overview', label: 'Overview', icon: Activity },
    { id: 'users', label: 'Users', icon: Users },
    { id: 'games', label: 'Games', icon: Calendar },
    { id: 'audit', label: 'Audit Log', icon: Eye },
  ];

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="flex items-center justify-between px-4 pt-12 pb-6">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate('/')}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-xl font-semibold">Admin Dashboard</h1>
            <p className="text-sm text-muted-foreground">Manage users, games, and platform settings</p>
          </div>
        </div>
        <Badge variant="destructive" className="flex items-center gap-1">
          <Shield className="w-3 h-3" />
          Admin
        </Badge>
      </div>

      {/* Tab Navigation */}
      <div className="px-4 mb-6">
        <div className="flex space-x-1 bg-muted p-1 rounded-lg">
          {tabs.map((tab) => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => setSelectedTab(tab.id as any)}
                className={`flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                  selectedTab === tab.id
                    ? 'bg-background text-foreground shadow-sm'
                    : 'text-muted-foreground hover:text-foreground'
                }`}
              >
                <Icon className="w-4 h-4" />
                {tab.label}
              </button>
            );
          })}
        </div>
      </div>

      <div className="px-4 space-y-6">
        {/* Overview Tab */}
        {selectedTab === 'overview' && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card>
              <CardContent className="pt-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Total Users</p>
                    <p className="text-2xl font-bold">{allUsers?.length || 0}</p>
                  </div>
                  <Users className="w-8 h-8 text-muted-foreground" />
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardContent className="pt-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Active Games</p>
                    <p className="text-2xl font-bold">{games?.length || 0}</p>
                  </div>
                  <Calendar className="w-8 h-8 text-muted-foreground" />
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardContent className="pt-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Moderators</p>
                    <p className="text-2xl font-bold">
                      {allUsers?.filter(u => u.role === 'moderator').length || 0}
                    </p>
                  </div>
                  <Shield className="w-8 h-8 text-muted-foreground" />
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardContent className="pt-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Recent Actions</p>
                    <p className="text-2xl font-bold">{auditLog?.length || 0}</p>
                  </div>
                  <Activity className="w-8 h-8 text-muted-foreground" />
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Users Tab */}
        {selectedTab === 'users' && (
          <Card>
            <CardHeader>
              <CardTitle>User Management</CardTitle>
            </CardHeader>
            <CardContent>
              {usersLoading ? (
                <p>Loading users...</p>
              ) : (
                <div className="space-y-4">
                  {allUsers?.map((userItem) => (
                    <div key={userItem.id} className="flex items-center justify-between p-4 border rounded-lg">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-muted flex items-center justify-center">
                          {userItem.name?.charAt(0).toUpperCase() || 'U'}
                        </div>
                        <div>
                          <p className="font-medium">{userItem.name}</p>
                          <p className="text-sm text-muted-foreground">{userItem.email}</p>
                          <p className="text-xs text-muted-foreground">@{userItem.username}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Badge variant={getRoleBadgeVariant(userItem.role)}>
                          {userItem.role}
                        </Badge>
                        {userItem.id !== user.id && (
                          <div className="flex gap-1">
                            {userItem.role !== 'moderator' && (
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleRoleUpdate(userItem.id, 'moderator')}
                                disabled={updateUserRoleMutation.isPending}
                              >
                                <UserCheck className="w-3 h-3 mr-1" />
                                Make Moderator
                              </Button>
                            )}
                            {userItem.role !== 'user' && (
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleRoleUpdate(userItem.id, 'user')}
                                disabled={updateUserRoleMutation.isPending}
                              >
                                <UserX className="w-3 h-3 mr-1" />
                                Remove Role
                              </Button>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Games Tab */}
        {selectedTab === 'games' && (
          <Card>
            <CardHeader>
              <CardTitle>Game Management</CardTitle>
            </CardHeader>
            <CardContent>
              {gamesLoading ? (
                <p>Loading games...</p>
              ) : (
                <div className="space-y-4">
                  {games?.map((game) => (
                    <div key={game.id} className="flex items-center justify-between p-4 border rounded-lg">
                      <div>
                        <h3 className="font-medium">{game.title}</h3>
                        <p className="text-sm text-muted-foreground">
                          {game.sport} ‚Ä¢ {game.date} at {game.time}
                        </p>
                        <p className="text-sm text-muted-foreground">
                          {game.location} ‚Ä¢ {game.totalPlayers ?? 0}/{game.maxPlayers ?? 0} players
                        </p>
                      </div>
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => setGameToDelete(game.id)}
                        disabled={deleteGameMutation.isPending}
                      >
                        <Trash2 className="w-3 h-3 mr-1" />
                        Delete
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Audit Log Tab */}
        {selectedTab === 'audit' && (
          <Card>
            <CardHeader>
              <CardTitle>Audit Log</CardTitle>
            </CardHeader>
            <CardContent>
              {auditLoading ? (
                <p>Loading audit log...</p>
              ) : (
                <div className="space-y-4">
                  {auditLog?.map((entry) => (
                    <div key={entry.id} className="p-4 border rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                        <Badge variant="outline">{entry.action}</Badge>
                        <span className="text-xs text-muted-foreground">
                          {new Date(entry.created_at).toLocaleString()}
                        </span>
                      </div>
                      <p className="text-sm">
                        <strong>{entry.admin?.full_name || 'Unknown Admin'}</strong> performed{' '}
                        <strong>{entry.action}</strong> on {entry.target_type}
                        {entry.target_id && ` (${entry.target_id.slice(0, 8)}...)`}
                      </p>
                      {entry.details && (
                        <pre className="text-xs text-muted-foreground mt-2 bg-muted p-2 rounded">
                          {JSON.stringify(entry.details, null, 2)}
                        </pre>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}
      </div>

      {/* Delete Game Modal */}
      {gameToDelete && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <Card className="w-full max-w-md">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <AlertTriangle className="w-5 h-5 text-destructive" />
                Delete Game
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <p className="text-sm text-muted-foreground">
                This action cannot be undone. Please provide a reason for deleting this game.
              </p>
              <Textarea
                placeholder="Reason for deletion..."
                value={deleteReason}
                onChange={(e) => setDeleteReason(e.target.value)}
                rows={3}
              />
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => {
                    setGameToDelete(null);
                    setDeleteReason('');
                  }}
                  className="flex-1"
                >
                  Cancel
                </Button>
                <Button
                  variant="destructive"
                  onClick={() => handleDeleteGame(gameToDelete)}
                  disabled={deleteGameMutation.isPending || !deleteReason.trim()}
                  className="flex-1"
                >
                  {deleteGameMutation.isPending ? 'Deleting...' : 'Delete Game'}
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}

export default AdminDashboard;

```

`shared/components/common/CacheClearButton.tsx`:

```tsx
import React, { useState } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { Button } from '@/shared/components/ui/button';
import { RefreshCw, Trash2, AlertTriangle, Bug, Zap, Wifi } from 'lucide-react';
import { gameKeys } from '@/domains/games/hooks/useGames';
import { queryDebugger } from '@/shared/utils/queryDebugger';
import { SupabaseDiagnostics } from '@/shared/utils/supabaseDiagnostics';
import { SupabaseSpeedTest } from '@/shared/utils/supabaseSpeedTest';
import { ConnectionDiagnostic } from '@/shared/utils/connectionDiagnostic';

export function CacheClearButton() {
  const queryClient = useQueryClient();
  const [clearing, setClearing] = useState(false);
  const [lastCleared, setLastCleared] = useState<Date | null>(null);
  const [runningDiagnostics, setRunningDiagnostics] = useState(false);
  const [runningSpeedTest, setRunningSpeedTest] = useState(false);
  const [runningConnectionTest, setRunningConnectionTest] = useState(false);

  const clearGameCache = async () => {
    setClearing(true);
    console.log('üßπ [CacheClearButton] Clearing game cache...');
    
    try {
      // Remove all game-related queries
      queryClient.removeQueries({
        predicate: (query) => 
          query.queryKey.includes('games') || 
          query.queryKey.some(key => typeof key === 'string' && key.includes('game'))
      });
      
      // Invalidate any remaining game queries
      await queryClient.invalidateQueries({ queryKey: gameKeys.all });
      
      // Clear query debugger cache
      queryDebugger.clearAllGameQueries();
      
      // Clear potential auth issues
      try {
        const authToken = localStorage.getItem('supabase.auth.token');
        if (authToken) {
          console.log('üîê Found auth token, checking validity...');
          // Parse and check if token is expired
          const tokenData = JSON.parse(authToken);
          if (tokenData.expires_at && new Date(tokenData.expires_at * 1000) < new Date()) {
            console.log('üö® Auth token expired, clearing...');
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('tribeup-auth');
          }
        }
      } catch (authError) {
        console.warn('‚ö†Ô∏è Could not check auth token:', authError);
      }
      
      setLastCleared(new Date());
      console.log('‚úÖ [CacheClearButton] Game cache cleared successfully');
      
      // Force a fresh fetch
      setTimeout(() => {
        queryClient.refetchQueries({ queryKey: gameKeys.lists() });
      }, 100);
      
    } catch (error) {
      console.error('‚ùå [CacheClearButton] Error clearing cache:', error);
    } finally {
      setClearing(false);
    }
  };

  const clearAllCache = async () => {
    setClearing(true);
    console.log('üßπ [CacheClearButton] Clearing ALL cache...');
    
    try {
      // Clear React Query cache
      queryClient.clear();
      
      // Clear browser storage
      localStorage.removeItem('supabase.auth.token');
      sessionStorage.clear();
      
      setLastCleared(new Date());
      console.log('‚úÖ [CacheClearButton] All cache cleared');
      
      // Reload the page after clearing everything
      setTimeout(() => {
        window.location.reload();
      }, 500);
      
    } catch (error) {
      console.error('‚ùå [CacheClearButton] Error clearing all cache:', error);
    } finally {
      setClearing(false);
    }
  };

  const runDiagnostics = async () => {
    setRunningDiagnostics(true);
    console.log('üîç [CacheClearButton] Running Supabase diagnostics...');
    
    try {
      await SupabaseDiagnostics.runDiagnostics();
      console.log('‚úÖ [CacheClearButton] Diagnostics completed - check console for results');
    } catch (error) {
      console.error('‚ùå [CacheClearButton] Diagnostics failed:', error);
    } finally {
      setRunningDiagnostics(false);
    }
  };

  const runSpeedTest = async () => {
    setRunningSpeedTest(true);
    console.log('üèÉ‚Äç‚ôÇÔ∏è [CacheClearButton] Running Supabase speed test...');
    
    try {
      await SupabaseSpeedTest.runFullSpeedTest();
      console.log('‚úÖ [CacheClearButton] Speed test completed - check console for results');
    } catch (error) {
      console.error('‚ùå [CacheClearButton] Speed test failed:', error);
    } finally {
      setRunningSpeedTest(false);
    }
  };

  const runConnectionTest = async () => {
    setRunningConnectionTest(true);
    console.log('üîç [CacheClearButton] Running connection diagnostic...');
    
    try {
      await ConnectionDiagnostic.runConnectionTest();
      console.log('‚úÖ [CacheClearButton] Connection test completed - check console for results');
    } catch (error) {
      console.error('‚ùå [CacheClearButton] Connection test failed:', error);
    } finally {
      setRunningConnectionTest(false);
    }
  };

  const getQueryStats = () => {
    const cache = queryClient.getQueryCache();
    const queries = cache.getAll();
    
    const gameQueries = queries.filter(q => 
      q.queryKey.includes('games') || 
      q.queryKey.some(key => typeof key === 'string' && key.includes('game'))
    );
    
    const staleQueries = gameQueries.filter(q => q.isStale());
    
    return {
      total: queries.length,
      gameQueries: gameQueries.length,
      staleGameQueries: staleQueries.length
    };
  };

  const stats = getQueryStats();

  return (
    <div className="fixed bottom-4 right-4 z-50 bg-card border rounded-lg p-4 shadow-lg max-w-sm">
      <div className="flex items-center gap-2 mb-3">
        <AlertTriangle className="w-4 h-4 text-yellow-500" />
        <span className="text-sm font-medium">Cache Debug</span>
      </div>
      
      <div className="text-xs text-muted-foreground mb-3 space-y-1">
        <div>Total Queries: {stats.total}</div>
        <div>Game Queries: {stats.gameQueries}</div>
        <div className={stats.staleGameQueries > 0 ? 'text-yellow-600' : ''}>
          Stale Game Queries: {stats.staleGameQueries}
        </div>
        {lastCleared && (
          <div>Last Cleared: {lastCleared.toLocaleTimeString()}</div>
        )}
      </div>
      
      <div className="space-y-2">
        <div className="flex gap-2">
          <Button
            size="sm"
            variant="outline"
            onClick={clearGameCache}
            disabled={clearing}
            className="flex-1"
          >
            <RefreshCw className={`w-3 h-3 mr-1 ${clearing ? 'animate-spin' : ''}`} />
            Clear Games
          </Button>
          
          <Button
            size="sm"
            variant="destructive"
            onClick={clearAllCache}
            disabled={clearing}
            className="flex-1"
          >
            <Trash2 className="w-3 h-3 mr-1" />
            Clear All
          </Button>
        </div>
        
        <Button
          size="sm"
          variant="secondary"
          onClick={runDiagnostics}
          disabled={runningDiagnostics}
          className="w-full"
        >
          <Bug className={`w-3 h-3 mr-1 ${runningDiagnostics ? 'animate-pulse' : ''}`} />
          {runningDiagnostics ? 'Running Diagnostics...' : 'Diagnose DB Issues'}
        </Button>
        
        <Button
          size="sm"
          variant="outline"
          onClick={runSpeedTest}
          disabled={runningSpeedTest}
          className="w-full"
        >
          <Zap className={`w-3 h-3 mr-1 ${runningSpeedTest ? 'animate-bounce' : ''}`} />
          {runningSpeedTest ? 'Testing Speed...' : 'Test Supabase Speed'}
        </Button>
        
        <Button
          size="sm"
          variant="destructive"
          onClick={runConnectionTest}
          disabled={runningConnectionTest}
          className="w-full"
        >
          <Wifi className={`w-3 h-3 mr-1 ${runningConnectionTest ? 'animate-pulse' : ''}`} />
          {runningConnectionTest ? 'Testing Connection...' : 'Fix Connection Issues'}
        </Button>
      </div>
      
      <div className="text-xs text-muted-foreground mt-2">
        "Fix Connection" will diagnose network/DNS/CORS issues
      </div>
    </div>
  );
}

```

`shared/components/common/CalendarIntegration.tsx`:

```tsx
import { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/shared/components/ui/dropdown-menu';
import { Calendar, CalendarPlus, Download, ExternalLink, Smartphone } from 'lucide-react';
import { CalendarService } from '@/shared/components/lib/calendarService';
import { toast } from 'sonner';

interface CalendarIntegrationProps {
  game: any;
  variant?: 'default' | 'outline' | 'ghost';
  size?: 'sm' | 'default' | 'lg';
  showText?: boolean;
  className?: string;
}

export function CalendarIntegration({ 
  game, 
  variant = 'outline', 
  size = 'default', 
  showText = true,
  className = '' 
}: CalendarIntegrationProps) {
  const [isOpen, setIsOpen] = useState(false);

  const handleGoogleCalendar = () => {
    try {
      const event = CalendarService.createEventFromGame(game);
      CalendarService.openGoogleCalendar(event);
      toast.success('Opening Google Calendar...');
      setIsOpen(false);
    } catch (error) {
      console.error('Error opening Google Calendar:', error);
      toast.error('Failed to open Google Calendar');
    }
  };

  const handleDownloadICS = () => {
    try {
      const event = CalendarService.createEventFromGame(game);
      CalendarService.downloadICSFile(event);
      toast.success('Calendar file downloaded!');
      setIsOpen(false);
    } catch (error) {
      console.error('Error downloading calendar file:', error);
      toast.error('Failed to download calendar file');
    }
  };

  const handleAppleCalendar = () => {
    // For iOS devices, we can try to open the calendar app directly
    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
      try {
        const event = CalendarService.createEventFromGame(game);
        const icsContent = CalendarService.generateICSFile(event);
        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        
        // Try to open with calendar app
        window.location.href = url;
        toast.success('Opening Calendar app...');
        setIsOpen(false);
        
        // Cleanup
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch (error) {
        console.error('Error opening Apple Calendar:', error);
        handleDownloadICS(); // Fallback to download
      }
    } else {
      handleDownloadICS(); // Fallback for non-iOS devices
    }
  };

  const handleOutlookCalendar = () => {
    try {
      const event = CalendarService.createEventFromGame(game);
      const outlookUrl = generateOutlookUrl(event);
      window.open(outlookUrl, '_blank');
      toast.success('Opening Outlook Calendar...');
      setIsOpen(false);
    } catch (error) {
      console.error('Error opening Outlook Calendar:', error);
      toast.error('Failed to open Outlook Calendar');
    }
  };

  // Generate Outlook calendar URL
  const generateOutlookUrl = (event: any) => {
    const baseUrl = 'https://outlook.live.com/calendar/0/deeplink/compose';
    const params = new URLSearchParams({
      subject: event.title,
      startdt: event.startDate.toISOString(),
      enddt: event.endDate.toISOString(),
      body: event.description + (event.url ? `\n\nGame Link: ${event.url}` : ''),
      location: event.location
    });
    return `${baseUrl}?${params.toString()}`;
  };

  const isSmallScreen = typeof window !== 'undefined' && window.innerWidth < 768;

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button variant={variant} size={size} className={className}>
          <CalendarPlus className="w-4 h-4" />
          {showText && <span className="ml-2">Add to Calendar</span>}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuItem onClick={handleGoogleCalendar} className="cursor-pointer">
          <ExternalLink className="w-4 h-4 mr-2" />
          <div className="flex flex-col">
            <span>Google Calendar</span>
            <span className="text-xs text-muted-foreground">Opens in browser</span>
          </div>
        </DropdownMenuItem>
        
        <DropdownMenuItem onClick={handleAppleCalendar} className="cursor-pointer">
          <Smartphone className="w-4 h-4 mr-2" />
          <div className="flex flex-col">
            <span>Apple Calendar</span>
            <span className="text-xs text-muted-foreground">
              {/iPhone|iPad|iPod/.test(navigator.userAgent) ? 'Opens Calendar app' : 'Downloads .ics file'}
            </span>
          </div>
        </DropdownMenuItem>
        
        <DropdownMenuItem onClick={handleOutlookCalendar} className="cursor-pointer">
          <Calendar className="w-4 h-4 mr-2" />
          <div className="flex flex-col">
            <span>Outlook Calendar</span>
            <span className="text-xs text-muted-foreground">Opens in browser</span>
          </div>
        </DropdownMenuItem>
        
        <DropdownMenuItem onClick={handleDownloadICS} className="cursor-pointer">
          <Download className="w-4 h-4 mr-2" />
          <div className="flex flex-col">
            <span>Download .ics file</span>
            <span className="text-xs text-muted-foreground">Works with any calendar app</span>
          </div>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

// Simplified version for mobile or compact layouts
export function CalendarButton({ game, className = '' }: { game: any; className?: string }) {
  const handleQuickAdd = () => {
    try {
      const event = CalendarService.createEventFromGame(game);
      
      // Smart detection of best calendar option
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        // iOS - try to open Calendar app
        const icsContent = CalendarService.generateICSFile(event);
        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        window.location.href = url;
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        toast.success('Opening Calendar app...');
      } else if (/Android/.test(navigator.userAgent)) {
        // Android - open Google Calendar
        CalendarService.openGoogleCalendar(event);
        toast.success('Opening Google Calendar...');
      } else {
        // Desktop - download ICS file
        CalendarService.downloadICSFile(event);
        toast.success('Calendar file downloaded!');
      }
    } catch (error) {
      console.error('Error adding to calendar:', error);
      toast.error('Failed to add to calendar');
    }
  };

  return (
    <Button 
      variant="outline" 
      size="sm" 
      onClick={handleQuickAdd}
      className={className}
    >
      <CalendarPlus className="w-4 h-4 mr-2" />
      Add to Calendar
    </Button>
  );
}

```

`shared/components/common/ConfirmDeleteModal.tsx`:

```tsx
import React, { useState } from 'react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/shared/components/ui/alert-dialog';
import { Input } from '@/shared/components/ui/input';
import { Label } from '@/shared/components/ui/label';
import { AlertTriangle } from 'lucide-react';

interface ConfirmDeleteModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onConfirm: () => void;
  title?: string;
  description?: string;
  confirmationText: string;
  confirmationPlaceholder?: string;
  isLoading?: boolean;
  consequences?: string[];
}

export function ConfirmDeleteModal({
  open,
  onOpenChange,
  onConfirm,
  title = 'Delete Account',
  description = 'This action cannot be undone. This will permanently delete your account and remove all your data from our servers.',
  confirmationText,
  confirmationPlaceholder = 'Type DELETE to confirm',
  isLoading = false,
  consequences = [],
}: ConfirmDeleteModalProps) {
  const [inputValue, setInputValue] = useState('');
  
  const isConfirmationValid = inputValue.trim().toUpperCase() === confirmationText.trim().toUpperCase();

  const handleConfirm = () => {
    if (isConfirmationValid && !isLoading) {
      onConfirm();
    }
  };

  const handleOpenChange = (newOpen: boolean) => {
    if (!newOpen) {
      setInputValue(''); // Reset input when closing
    }
    onOpenChange(newOpen);
  };

  return (
    <AlertDialog open={open} onOpenChange={handleOpenChange}>
      <AlertDialogContent className="max-w-md">
        <AlertDialogHeader>
          <div className="flex items-center gap-3">
            <div className="flex h-10 w-10 items-center justify-center rounded-full bg-destructive/10">
              <AlertTriangle className="h-5 w-5 text-destructive" aria-hidden="true" />
            </div>
            <AlertDialogTitle className="text-xl">{title}</AlertDialogTitle>
          </div>
          <AlertDialogDescription className="text-left pt-2">
            {description}
          </AlertDialogDescription>
        </AlertDialogHeader>

        {consequences.length > 0 && (
          <div className="space-y-2 py-2">
            <p className="text-sm font-medium text-destructive">
              The following will be permanently deleted:
            </p>
            <ul className="text-sm text-muted-foreground space-y-1 list-disc list-inside">
              {consequences.map((consequence, index) => (
                <li key={index}>{consequence}</li>
              ))}
            </ul>
          </div>
        )}

        <div className="space-y-2 py-2">
          <Label htmlFor="confirmation-input" className="text-sm font-medium">
            Type <span className="font-bold text-destructive">{confirmationText}</span> to confirm
          </Label>
          <Input
            id="confirmation-input"
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            placeholder={confirmationPlaceholder}
            className="w-full"
            disabled={isLoading}
            aria-describedby="confirmation-hint"
            autoComplete="off"
          />
          <p id="confirmation-hint" className="text-xs text-muted-foreground">
            This helps prevent accidental deletion
          </p>
        </div>

        <AlertDialogFooter className="gap-2 sm:gap-0">
          <AlertDialogCancel disabled={isLoading}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={handleConfirm}
            disabled={!isConfirmationValid || isLoading}
            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
          >
            {isLoading ? 'Deleting...' : 'Delete Account'}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}

```

`shared/components/common/DesignSystem.tsx`:

```tsx
import React, { useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Input } from '@/shared/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback } from '@/shared/components/ui/avatar';
import { Alert, AlertDescription, AlertTitle } from '@/shared/components/ui/alert';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/shared/components/ui/tabs';
import { Switch } from '@/shared/components/ui/switch';
import { Checkbox } from '@/shared/components/ui/checkbox';
import { Progress } from '@/shared/components/ui/progress';
import { Skeleton } from '@/shared/components/ui/skeleton';
import { Separator } from '@/shared/components/ui/separator';
import { 
  ArrowLeft, 
  Home, 
  Plus, 
  User, 
  Calendar, 
  MapPin, 
  Users, 
  Settings,
  Trophy,
  Star,
  Heart,
  Bell,
  Search,
  Filter,
  Download,
  Share,
  Edit,
  Trash,
  Eye,
  EyeOff,
  CheckCircle,
  AlertCircle,
  XCircle,
  Info
} from 'lucide-react';

interface DesignSystemProps {
  onBack: () => void;
}

const sportColors = [
  { name: 'Basketball', color: 'bg-sport-basketball', icon: 'üèÄ' },
  { name: 'Soccer', color: 'bg-sport-soccer', icon: '‚öΩ' },
  { name: 'Tennis', color: 'bg-sport-tennis', icon: 'üéæ' },
  { name: 'Volleyball', color: 'bg-sport-volleyball', icon: 'üèê' },
  { name: 'Football', color: 'bg-sport-football', icon: 'üèà' },
  { name: 'Baseball', color: 'bg-sport-baseball', icon: '‚öæ' },
];

const brandColors = [
  { name: 'Core Orange', hex: '#FA4616', usage: 'Primary brand color, CTAs' },
  { name: 'Core Blue', hex: '#0021A5', usage: 'Secondary color, text' },
  { name: 'Bottlebrush', hex: '#D32737', usage: 'Error states, alerts' },
  { name: 'Alachua', hex: '#F2A900', usage: 'Warning states, highlights' },
  { name: 'Gator', hex: '#22884C', usage: 'Success states, confirmation' },
  { name: 'Dark Blue', hex: '#002657', usage: 'Dark text, headers' },
  { name: 'Perennial', hex: '#6A2A60', usage: 'Accent color, premium' },
];

function DesignSystem({ onBack }: DesignSystemProps) {
  const [darkMode, setDarkMode] = useState(false);

  React.useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="flex items-center justify-between px-4 py-4">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" onClick={onBack}>
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div>
              <h1 className="text-xl font-semibold">TribeUp Design System</h1>
              <p className="text-sm text-muted-foreground">University of Florida Brand</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm">Dark Mode</span>
            <Switch checked={darkMode} onCheckedChange={setDarkMode} />
          </div>
        </div>
      </div>

      <div className="px-4 py-6 max-w-6xl mx-auto">
        <Tabs defaultValue="colors" className="w-full">
          <TabsList className="grid w-full grid-cols-6">
            <TabsTrigger value="colors">Colors</TabsTrigger>
            <TabsTrigger value="typography">Typography</TabsTrigger>
            <TabsTrigger value="buttons">Buttons</TabsTrigger>
            <TabsTrigger value="components">Components</TabsTrigger>
            <TabsTrigger value="layout">Layout</TabsTrigger>
            <TabsTrigger value="icons">Icons</TabsTrigger>
          </TabsList>

          {/* Colors Tab */}
          <TabsContent value="colors" className="space-y-8">
            {/* Brand Colors */}
            <Card>
              <CardHeader>
                <CardTitle>University of Florida Brand Colors</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {brandColors.map((color) => (
                    <div key={color.name} className="space-y-2">
                      <div 
                        className="w-full h-20 rounded-lg shadow-subtle"
                        style={{ backgroundColor: color.hex }}
                      />
                      <div>
                        <div className="font-medium">{color.name}</div>
                        <div className="text-sm text-muted-foreground">{color.hex}</div>
                        <div className="text-xs text-muted-foreground">{color.usage}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* Sport Colors */}
            <Card>
              <CardHeader>
                <CardTitle>Sport Color System</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                  {sportColors.map((sport) => (
                    <div key={sport.name} className="text-center">
                      <div className={`w-full h-16 rounded-lg ${sport.color} flex items-center justify-center text-2xl shadow-subtle`}>
                        {sport.icon}
                      </div>
                      <div className="mt-2 text-sm font-medium">{sport.name}</div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* Semantic Colors */}
            <Card>
              <CardHeader>
                <CardTitle>Semantic Colors</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="space-y-2">
                    <div className="w-full h-16 bg-primary rounded-lg shadow-subtle"></div>
                    <div className="text-sm font-medium">Primary</div>
                    <div className="text-xs text-muted-foreground">Core Orange</div>
                  </div>
                  <div className="space-y-2">
                    <div className="w-full h-16 bg-secondary rounded-lg shadow-subtle"></div>
                    <div className="text-sm font-medium">Secondary</div>
                    <div className="text-xs text-muted-foreground">Core Blue</div>
                  </div>
                  <div className="space-y-2">
                    <div className="w-full h-16 bg-destructive rounded-lg shadow-subtle"></div>
                    <div className="text-sm font-medium">Destructive</div>
                    <div className="text-xs text-muted-foreground">Bottlebrush</div>
                  </div>
                  <div className="space-y-2">
                    <div className="w-full h-16 bg-success rounded-lg shadow-subtle"></div>
                    <div className="text-sm font-medium">Success</div>
                    <div className="text-xs text-muted-foreground">Gator</div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Typography Tab */}
          <TabsContent value="typography" className="space-y-8">
            <Card>
              <CardHeader>
                <CardTitle>Typography Scale</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <h1>Heading 1 - Display Large</h1>
                  <p className="text-sm text-muted-foreground">2rem, medium weight, -0.025em tracking</p>
                </div>
                <div>
                  <h2>Heading 2 - Display Medium</h2>
                  <p className="text-sm text-muted-foreground">1.5rem, medium weight, -0.025em tracking</p>
                </div>
                <div>
                  <h3>Heading 3 - Display Small</h3>
                  <p className="text-sm text-muted-foreground">1.25rem, medium weight</p>
                </div>
                <div>
                  <h4>Heading 4 - Title Large</h4>
                  <p className="text-sm text-muted-foreground">1.125rem, medium weight</p>
                </div>
                <div>
                  <h5>Heading 5 - Title Medium</h5>
                  <p className="text-sm text-muted-foreground">1rem, medium weight</p>
                </div>
                <div>
                  <h6>Heading 6 - Title Small</h6>
                  <p className="text-sm text-muted-foreground">0.875rem, medium weight</p>
                </div>
                <div>
                  <p>Body Text - Regular paragraph text with good readability</p>
                  <p className="text-sm text-muted-foreground">1rem, normal weight, 1.6 line height</p>
                </div>
                <div>
                  <label>Label Text - Form labels and captions</label>
                  <p className="text-sm text-muted-foreground">0.875rem, medium weight</p>
                </div>
                <div>
                  <div className="text-caption">Caption Text - Small descriptive text</div>
                  <p className="text-sm text-muted-foreground">0.75rem, normal weight</p>
                </div>
                <div>
                  <div className="text-overline">OVERLINE TEXT</div>
                  <p className="text-sm text-muted-foreground">0.75rem, medium weight, uppercase, 0.1em tracking</p>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Buttons Tab */}
          <TabsContent value="buttons" className="space-y-8">
            <Card>
              <CardHeader>
                <CardTitle>Button Variants</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="space-y-4">
                  <div>
                    <h4 className="mb-3">Primary Buttons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button size="sm">Small</Button>
                      <Button>Default</Button>
                      <Button size="lg">Large</Button>
                      <Button disabled>Disabled</Button>
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="mb-3">Secondary Buttons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button variant="secondary" size="sm">Small</Button>
                      <Button variant="secondary">Default</Button>
                      <Button variant="secondary" size="lg">Large</Button>
                      <Button variant="secondary" disabled>Disabled</Button>
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-3">Outline Buttons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button variant="outline" size="sm">Small</Button>
                      <Button variant="outline">Default</Button>
                      <Button variant="outline" size="lg">Large</Button>
                      <Button variant="outline" disabled>Disabled</Button>
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-3">Ghost Buttons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button variant="ghost" size="sm">Small</Button>
                      <Button variant="ghost">Default</Button>
                      <Button variant="ghost" size="lg">Large</Button>
                      <Button variant="ghost" disabled>Disabled</Button>
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-3">Destructive Buttons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button variant="destructive" size="sm">Small</Button>
                      <Button variant="destructive">Default</Button>
                      <Button variant="destructive" size="lg">Large</Button>
                      <Button variant="destructive" disabled>Disabled</Button>
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-3">Icon Buttons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button size="icon"><Home className="w-4 h-4" /></Button>
                      <Button variant="outline" size="icon"><Plus className="w-4 h-4" /></Button>
                      <Button variant="ghost" size="icon"><User className="w-4 h-4" /></Button>
                      <Button variant="destructive" size="icon"><Trash className="w-4 h-4" /></Button>
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-3">Buttons with Icons</h4>
                    <div className="flex flex-wrap gap-3">
                      <Button><Plus className="w-4 h-4 mr-2" />Add Game</Button>
                      <Button variant="outline"><Download className="w-4 h-4 mr-2" />Download</Button>
                      <Button variant="secondary"><Share className="w-4 h-4 mr-2" />Share</Button>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Components Tab */}
          <TabsContent value="components" className="space-y-8">
            {/* Input Components */}
            <Card>
              <CardHeader>
                <CardTitle>Input Components</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label>Default Input</label>
                    <Input placeholder="Enter text..." />
                  </div>
                  <div className="space-y-2">
                    <label>Disabled Input</label>
                    <Input placeholder="Disabled" disabled />
                  </div>
                  <div className="space-y-2">
                    <label>Date Input</label>
                    <Input type="date" />
                  </div>
                  <div className="space-y-2">
                    <label>Time Input</label>
                    <Input type="time" />
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Badges */}
            <Card>
              <CardHeader>
                <CardTitle>Badges & Tags</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <h4 className="mb-3">Badge Variants</h4>
                    <div className="flex flex-wrap gap-2">
                      <Badge>Default</Badge>
                      <Badge variant="secondary">Secondary</Badge>
                      <Badge variant="outline">Outline</Badge>
                      <Badge variant="destructive">Destructive</Badge>
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="mb-3">Sport Tags</h4>
                    <div className="flex flex-wrap gap-2">
                      {sportColors.map((sport) => (
                        <Badge key={sport.name} className={`${sport.color} text-white border-none`}>
                          {sport.icon} {sport.name}
                        </Badge>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="mb-3">Status Badges</h4>
                    <div className="flex flex-wrap gap-2">
                      <Badge className="bg-success text-success-foreground">Available</Badge>
                      <Badge className="bg-warning text-warning-foreground">Almost Full</Badge>
                      <Badge className="bg-destructive text-destructive-foreground">Full</Badge>
                      <Badge className="bg-muted text-muted-foreground">Cancelled</Badge>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Alerts */}
            <Card>
              <CardHeader>
                <CardTitle>Alerts & Messages</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <Alert>
                  <Info className="h-4 w-4" />
                  <AlertTitle>Information</AlertTitle>
                  <AlertDescription>
                    This is a general information alert for user notifications.
                  </AlertDescription>
                </Alert>
                
                <Alert className="border-success text-success-foreground">
                  <CheckCircle className="h-4 w-4" />
                  <AlertTitle>Success</AlertTitle>
                  <AlertDescription>
                    Your game has been successfully created and published.
                  </AlertDescription>
                </Alert>
                
                <Alert className="border-warning text-warning-foreground">
                  <AlertCircle className="h-4 w-4" />
                  <AlertTitle>Warning</AlertTitle>
                  <AlertDescription>
                    This game is almost at capacity. Join now to secure your spot.
                  </AlertDescription>
                </Alert>
                
                <Alert variant="destructive">
                  <XCircle className="h-4 w-4" />
                  <AlertTitle>Error</AlertTitle>
                  <AlertDescription>
                    Unable to join game. Please try again later.
                  </AlertDescription>
                </Alert>
              </CardContent>
            </Card>

            {/* Avatars & Progress */}
            <Card>
              <CardHeader>
                <CardTitle>Avatars, Progress & Controls</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <h4 className="mb-3">Avatars</h4>
                  <div className="flex items-center gap-4">
                    <Avatar className="w-8 h-8">
                      <AvatarFallback>SM</AvatarFallback>
                    </Avatar>
                    <Avatar className="w-10 h-10">
                      <AvatarFallback>MD</AvatarFallback>
                    </Avatar>
                    <Avatar className="w-12 h-12">
                      <AvatarFallback>LG</AvatarFallback>
                    </Avatar>
                    <Avatar className="w-16 h-16">
                      <AvatarFallback>XL</AvatarFallback>
                    </Avatar>
                  </div>
                </div>
                
                <div>
                  <h4 className="mb-3">Progress Indicators</h4>
                  <div className="space-y-3">
                    <div>
                      <div className="flex justify-between text-sm mb-1">
                        <span>Game Capacity</span>
                        <span>7/10 players</span>
                      </div>
                      <Progress value={70} />
                    </div>
                    <div>
                      <div className="flex justify-between text-sm mb-1">
                        <span>Event Progress</span>
                        <span>3/5 complete</span>
                      </div>
                      <Progress value={60} className="[&>div]:bg-success" />
                    </div>
                  </div>
                </div>
                
                <div>
                  <h4 className="mb-3">Controls</h4>
                  <div className="flex items-center gap-6">
                    <div className="flex items-center space-x-2">
                      <Checkbox id="terms" />
                      <label htmlFor="terms" className="text-sm">Accept terms</label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="notifications" />
                      <label htmlFor="notifications" className="text-sm">Notifications</label>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Loading States */}
            <Card>
              <CardHeader>
                <CardTitle>Loading States</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <h4 className="mb-3">Skeleton Loading</h4>
                  <div className="space-y-3">
                    <div className="flex items-center space-x-4">
                      <Skeleton className="h-12 w-12 rounded-full" />
                      <div className="space-y-2">
                        <Skeleton className="h-4 w-[200px]" />
                        <Skeleton className="h-4 w-[160px]" />
                      </div>
                    </div>
                    <Skeleton className="h-32 w-full rounded-lg" />
                    <div className="flex space-x-2">
                      <Skeleton className="h-10 w-20" />
                      <Skeleton className="h-10 w-20" />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Layout Tab */}
          <TabsContent value="layout" className="space-y-8">
            <Card>
              <CardHeader>
                <CardTitle>Spacing System</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="text-center">
                      <div className="bg-primary h-1 mb-2"></div>
                      <div className="text-sm">4px</div>
                      <div className="text-xs text-muted-foreground">Space 1</div>
                    </div>
                    <div className="text-center">
                      <div className="bg-primary h-2 mb-2"></div>
                      <div className="text-sm">8px</div>
                      <div className="text-xs text-muted-foreground">Space 2</div>
                    </div>
                    <div className="text-center">
                      <div className="bg-primary h-3 mb-2"></div>
                      <div className="text-sm">12px</div>
                      <div className="text-xs text-muted-foreground">Space 3</div>
                    </div>
                    <div className="text-center">
                      <div className="bg-primary h-4 mb-2"></div>
                      <div className="text-sm">16px</div>
                      <div className="text-xs text-muted-foreground">Space 4</div>
                    </div>
                    <div className="text-center">
                      <div className="bg-primary h-6 mb-2"></div>
                      <div className="text-sm">24px</div>
                      <div className="text-xs text-muted-foreground">Space 6</div>
                    </div>
                    <div className="text-center">
                      <div className="bg-primary h-8 mb-2"></div>
                      <div className="text-sm">32px</div>
                      <div className="text-xs text-muted-foreground">Space 8</div>
                    </div>
                    <div className="text-center">
                      <div className="bg-primary h-12 mb-2"></div>
                      <div className="text-sm">48px</div>
                      <div className="text-xs text-muted-foreground">Space 12</div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Border Radius</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                  <div className="text-center">
                    <div className="bg-muted h-16 mb-2 rounded-xs"></div>
                    <div className="text-sm">4px</div>
                    <div className="text-xs text-muted-foreground">XS</div>
                  </div>
                  <div className="text-center">
                    <div className="bg-muted h-16 mb-2 rounded-sm"></div>
                    <div className="text-sm">8px</div>
                    <div className="text-xs text-muted-foreground">SM</div>
                  </div>
                  <div className="text-center">
                    <div className="bg-muted h-16 mb-2 rounded-md"></div>
                    <div className="text-sm">12px</div>
                    <div className="text-xs text-muted-foreground">MD</div>
                  </div>
                  <div className="text-center">
                    <div className="bg-muted h-16 mb-2 rounded-lg"></div>
                    <div className="text-sm">16px</div>
                    <div className="text-xs text-muted-foreground">LG</div>
                  </div>
                  <div className="text-center">
                    <div className="bg-muted h-16 mb-2 rounded-xl"></div>
                    <div className="text-sm">24px</div>
                    <div className="text-xs text-muted-foreground">XL</div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Shadow System</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="text-center">
                    <div className="bg-card h-24 rounded-lg shadow-subtle mb-3"></div>
                    <div className="text-sm font-medium">Subtle</div>
                    <div className="text-xs text-muted-foreground">Cards, buttons</div>
                  </div>
                  <div className="text-center">
                    <div className="bg-card h-24 rounded-lg shadow-medium mb-3"></div>
                    <div className="text-sm font-medium">Medium</div>
                    <div className="text-xs text-muted-foreground">Modals, dropdowns</div>
                  </div>
                  <div className="text-center">
                    <div className="bg-card h-24 rounded-lg shadow-strong mb-3"></div>
                    <div className="text-sm font-medium">Strong</div>
                    <div className="text-xs text-muted-foreground">Overlays, floating</div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Icons Tab */}
          <TabsContent value="icons" className="space-y-8">
            <Card>
              <CardHeader>
                <CardTitle>Icon Library</CardTitle>
                <p className="text-muted-foreground">Lucide React icons used throughout the application</p>
              </CardHeader>
              <CardContent>
                <div className="space-y-6">
                  <div>
                    <h4 className="mb-4">Navigation Icons</h4>
                    <div className="grid grid-cols-4 md:grid-cols-8 gap-4">
                      {[Home, Plus, User, Settings, Search, Filter, ArrowLeft].map((Icon, index) => (
                        <div key={index} className="flex flex-col items-center gap-2 p-3 rounded-lg border">
                          <Icon className="w-6 h-6" />
                          <span className="text-xs">{Icon.name}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-4">Action Icons</h4>
                    <div className="grid grid-cols-4 md:grid-cols-8 gap-4">
                      {[Edit, Trash, Download, Share, Eye, EyeOff, Heart, Star].map((Icon, index) => (
                        <div key={index} className="flex flex-col items-center gap-2 p-3 rounded-lg border">
                          <Icon className="w-6 h-6" />
                          <span className="text-xs">{Icon.name}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-4">Status Icons</h4>
                    <div className="grid grid-cols-4 md:grid-cols-8 gap-4">
                      {[CheckCircle, AlertCircle, XCircle, Info, Bell, Trophy].map((Icon, index) => (
                        <div key={index} className="flex flex-col items-center gap-2 p-3 rounded-lg border">
                          <Icon className="w-6 h-6" />
                          <span className="text-xs">{Icon.name}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h4 className="mb-4">Content Icons</h4>
                    <div className="grid grid-cols-4 md:grid-cols-8 gap-4">
                      {[Calendar, MapPin, Users].map((Icon, index) => (
                        <div key={index} className="flex flex-col items-center gap-2 p-3 rounded-lg border">
                          <Icon className="w-6 h-6" />
                          <span className="text-xs">{Icon.name}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

export default DesignSystem;
```

`shared/components/common/EmptyState.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import {
  Inbox,
  Search,
  Users,
  Calendar,
  Trophy,
  MessageSquare,
  Bell,
  MapPin,
  Heart,
  Plus,
  RefreshCw,
  CheckCircle,
  AlertCircle,
  Users2,
  type LucideIcon,
} from 'lucide-react';

/**
 * EmptyState - A comprehensive, reusable empty state component
 * 
 * Features:
 * - Multiple variants for common scenarios
 * - Customizable icon, title, description
 * - Primary and secondary action buttons
 * - Size options (sm, md, lg)
 * - Optional card wrapper
 * - Contextual tips section
 * - Accessibility support with ARIA attributes
 */

export type EmptyStateVariant =
  | 'no-results'      // Search/filter with no matches
  | 'no-data'         // Empty list/collection
  | 'no-games'        // No games/activities found
  | 'no-tribes'       // No tribes/communities found
  | 'no-friends'      // No friends/following
  | 'no-messages'     // No messages/chat
  | 'no-notifications'// No notifications
  | 'no-achievements' // No achievements earned
  | 'no-sports'       // No sports selected
  | 'error'           // Error state
  | 'success'         // Completed/empty with success
  | 'onboarding';     // Welcome/getting started

export interface EmptyStateAction {
  label: string;
  onClick: () => void;
  variant?: 'default' | 'outline' | 'ghost' | 'secondary';
  icon?: React.ReactNode;
}

export interface EmptyStateTip {
  emoji?: string;
  text: string;
}

export interface EmptyStateProps extends React.HTMLAttributes<HTMLDivElement> {
  /** Preset variant for common empty state scenarios */
  variant?: EmptyStateVariant;
  /** Title text - uses variant default if not provided */
  title?: string;
  /** Description text - uses variant default if not provided */
  description?: string;
  /** Custom icon element (overrides variant icon) */
  icon?: React.ReactNode;
  /** Custom illustration element (takes precedence over icon) */
  illustration?: React.ReactNode;
  /** Primary call-to-action button */
  primaryAction?: EmptyStateAction;
  /** Secondary call-to-action button */
  secondaryAction?: EmptyStateAction;
  /** Size variant */
  size?: 'sm' | 'md' | 'lg';
  /** Wrap in a Card component */
  withCard?: boolean;
  /** Optional tips to display below the description */
  tips?: EmptyStateTip[];
  /** Additional CSS classes */
  className?: string;
}

interface VariantConfig {
  icon: LucideIcon;
  iconBgClass: string;
  iconColorClass: string;
  title: string;
  description: string;
}

const variantConfigs: Record<EmptyStateVariant, VariantConfig> = {
  'no-results': {
    icon: Search,
    iconBgClass: 'bg-muted',
    iconColorClass: 'text-muted-foreground',
    title: 'No results found',
    description: 'Try adjusting your search or filters to find what you\'re looking for.',
  },
  'no-data': {
    icon: Inbox,
    iconBgClass: 'bg-muted',
    iconColorClass: 'text-muted-foreground',
    title: 'No data available',
    description: 'There\'s nothing here yet. Get started by creating your first item!',
  },
  'no-games': {
    icon: Calendar,
    iconBgClass: 'bg-orange-100 dark:bg-orange-900/30',
    iconColorClass: 'text-orange-600',
    title: 'No activities yet',
    description: 'Be the first to create an activity and start building your community!',
  },
  'no-tribes': {
    icon: Users2,
    iconBgClass: 'bg-blue-100 dark:bg-blue-900/30',
    iconColorClass: 'text-blue-600',
    title: 'No tribes yet',
    description: 'Create or join a tribe to connect with others who share your interests!',
  },
  'no-friends': {
    icon: Users,
    iconBgClass: 'bg-purple-100 dark:bg-purple-900/30',
    iconColorClass: 'text-purple-600',
    title: 'Not following anyone yet',
    description: 'Follow other players to see their activities and stay connected.',
  },
  'no-messages': {
    icon: MessageSquare,
    iconBgClass: 'bg-green-100 dark:bg-green-900/30',
    iconColorClass: 'text-green-600',
    title: 'No messages yet',
    description: 'Start the conversation! Send your first message to get things going.',
  },
  'no-notifications': {
    icon: Bell,
    iconBgClass: 'bg-yellow-100 dark:bg-yellow-900/30',
    iconColorClass: 'text-yellow-600',
    title: 'All caught up!',
    description: 'You have no new notifications. Check back later for updates.',
  },
  'no-achievements': {
    icon: Trophy,
    iconBgClass: 'bg-amber-100 dark:bg-amber-900/30',
    iconColorClass: 'text-amber-600',
    title: 'No achievements yet',
    description: 'Join and create activities to start earning achievements!',
  },
  'no-sports': {
    icon: Heart,
    iconBgClass: 'bg-red-100 dark:bg-red-900/30',
    iconColorClass: 'text-red-600',
    title: 'No sports selected',
    description: 'Add your favorite sports to get personalized activity recommendations.',
  },
  'error': {
    icon: AlertCircle,
    iconBgClass: 'bg-destructive/10',
    iconColorClass: 'text-destructive',
    title: 'Something went wrong',
    description: 'We encountered an error. Please try again or contact support.',
  },
  'success': {
    icon: CheckCircle,
    iconBgClass: 'bg-green-100 dark:bg-green-900/30',
    iconColorClass: 'text-green-600',
    title: 'All done!',
    description: 'You\'ve completed everything. Great job!',
  },
  'onboarding': {
    icon: Plus,
    iconBgClass: 'bg-primary/10',
    iconColorClass: 'text-primary',
    title: 'Welcome to TribeUp!',
    description: 'Find your game, find your tribe. Let\'s get you started.',
  },
};

const sizeConfigs = {
  sm: {
    container: 'py-6 px-4',
    iconContainer: 'w-12 h-12',
    iconSize: 'w-6 h-6',
    title: 'text-base font-medium',
    description: 'text-sm',
    gap: 'gap-3',
  },
  md: {
    container: 'py-10 px-6',
    iconContainer: 'w-16 h-16',
    iconSize: 'w-8 h-8',
    title: 'text-lg font-semibold',
    description: 'text-base',
    gap: 'gap-4',
  },
  lg: {
    container: 'py-14 px-8',
    iconContainer: 'w-20 h-20',
    iconSize: 'w-10 h-10',
    title: 'text-xl font-bold',
    description: 'text-base',
    gap: 'gap-5',
  },
};

export function EmptyState({
  variant = 'no-data',
  title,
  description,
  icon,
  illustration,
  primaryAction,
  secondaryAction,
  size = 'md',
  withCard = false,
  tips,
  className,
  ...props
}: EmptyStateProps) {
  const config = variantConfigs[variant];
  const sizeConfig = sizeConfigs[size];
  const IconComponent = config.icon;

  const displayTitle = title ?? config.title;
  const displayDescription = description ?? config.description;

  const content = (
    <div
      className={cn(
        'flex flex-col items-center justify-center text-center',
        sizeConfig.container,
        sizeConfig.gap,
        className
      )}
      role="status"
      aria-label={displayTitle}
      {...props}
    >
      {/* Icon or Illustration */}
      {illustration ? (
        <div className="mb-2">{illustration}</div>
      ) : icon ? (
        <div
          className={cn(
            'rounded-full flex items-center justify-center',
            sizeConfig.iconContainer,
            config.iconBgClass
          )}
        >
          {icon}
        </div>
      ) : (
        <div
          className={cn(
            'rounded-full flex items-center justify-center',
            sizeConfig.iconContainer,
            config.iconBgClass
          )}
        >
          <IconComponent className={cn(sizeConfig.iconSize, config.iconColorClass)} />
        </div>
      )}

      {/* Title */}
      <h3 className={cn(sizeConfig.title, 'text-foreground')}>
        {displayTitle}
      </h3>

      {/* Description */}
      {displayDescription && (
        <p className={cn('text-muted-foreground max-w-md', sizeConfig.description)}>
          {displayDescription}
        </p>
      )}

      {/* Action Buttons */}
      {(primaryAction || secondaryAction) && (
        <div className="flex flex-col sm:flex-row items-center gap-3 mt-2">
          {primaryAction && (
            <Button
              onClick={primaryAction.onClick}
              variant={primaryAction.variant ?? 'default'}
              size={size === 'sm' ? 'sm' : 'default'}
              className="w-full sm:w-auto"
            >
              {primaryAction.icon && (
                <span className="mr-2">{primaryAction.icon}</span>
              )}
              {primaryAction.label}
            </Button>
          )}

          {secondaryAction && (
            <Button
              onClick={secondaryAction.onClick}
              variant={secondaryAction.variant ?? 'outline'}
              size={size === 'sm' ? 'sm' : 'default'}
              className="w-full sm:w-auto"
            >
              {secondaryAction.icon && (
                <span className="mr-2">{secondaryAction.icon}</span>
              )}
              {secondaryAction.label}
            </Button>
          )}
        </div>
      )}

      {/* Tips Section */}
      {tips && tips.length > 0 && (
        <div className="mt-4 pt-4 border-t border-border w-full max-w-md">
          <div className="space-y-2">
            {tips.map((tip, index) => (
              <p key={index} className="text-xs text-muted-foreground">
                {tip.emoji && <span className="mr-1">{tip.emoji}</span>}
                {tip.text}
              </p>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  if (withCard) {
    return (
      <Card className="border-dashed">
        <CardContent className="p-0">
          {content}
        </CardContent>
      </Card>
    );
  }

  return content;
}

/**
 * Preset Empty States for Common Scenarios
 * These provide consistent, contextual messaging across the app
 */

export interface NoGamesEmptyStateProps {
  onCreateGame?: () => void;
  onExplore?: () => void;
  isFiltered?: boolean;
}

export function NoGamesEmptyState({
  onCreateGame,
  onExplore,
  isFiltered = false,
}: NoGamesEmptyStateProps) {
  return (
    <EmptyState
      variant={isFiltered ? 'no-results' : 'no-games'}
      title={isFiltered ? 'No matching activities' : undefined}
      description={
        isFiltered
          ? 'Try adjusting your filters to see more activities.'
          : undefined
      }
      illustration={<span className="text-6xl">üèÄ</span>}
      primaryAction={
        onCreateGame
          ? {
              label: 'Create Activity',
              onClick: onCreateGame,
              icon: <Plus className="w-4 h-4" />,
            }
          : undefined
      }
      secondaryAction={
        isFiltered && onExplore
          ? {
              label: 'Clear Filters',
              onClick: onExplore,
              variant: 'outline',
            }
          : onExplore
          ? {
              label: 'Explore',
              onClick: onExplore,
              variant: 'outline',
            }
          : undefined
      }
      tips={
        !isFiltered
          ? [
              { emoji: 'üí°', text: 'Tip: Start with a small group for better turnout!' },
            ]
          : undefined
      }
    />
  );
}

export interface NoTribesEmptyStateProps {
  onCreateTribe?: () => void;
  onExplore?: () => void;
  isSearch?: boolean;
}

export function NoTribesEmptyState({
  onCreateTribe,
  onExplore,
  isSearch = false,
}: NoTribesEmptyStateProps) {
  return (
    <EmptyState
      variant={isSearch ? 'no-results' : 'no-tribes'}
      title={isSearch ? 'No tribes found' : undefined}
      description={
        isSearch
          ? 'Try a different search term or create a new tribe.'
          : undefined
      }
      primaryAction={
        isSearch && onExplore
          ? {
              label: 'Clear Search',
              onClick: onExplore,
              variant: 'outline',
            }
          : onCreateTribe
          ? {
              label: 'Create Tribe',
              onClick: onCreateTribe,
              icon: <Plus className="w-4 h-4" />,
            }
          : undefined
      }
      secondaryAction={
        !isSearch && onExplore
          ? {
              label: 'Explore Tribes',
              onClick: onExplore,
              variant: 'outline',
            }
          : undefined
      }
    />
  );
}

export interface NoFriendsEmptyStateProps {
  onFindFriends?: () => void;
  onExploreGames?: () => void;
}

export function NoFriendsEmptyState({
  onFindFriends,
  onExploreGames,
}: NoFriendsEmptyStateProps) {
  return (
    <EmptyState
      variant="no-friends"
      primaryAction={
        onFindFriends
          ? {
              label: 'Find People to Follow',
              onClick: onFindFriends,
              icon: <Users className="w-4 h-4" />,
            }
          : undefined
      }
      secondaryAction={
        onExploreGames
          ? {
              label: 'Explore Activities',
              onClick: onExploreGames,
              variant: 'outline',
            }
          : undefined
      }
      tips={[
        { emoji: 'üí°', text: 'Tip: Join activities to meet people, then follow them to see their future activities!' },
      ]}
    />
  );
}

export interface NoRecentGamesEmptyStateProps {
  onFindGames?: () => void;
}

export function NoRecentGamesEmptyState({ onFindGames }: NoRecentGamesEmptyStateProps) {
  return (
    <EmptyState
      variant="no-games"
      title="No recent games"
      description="Join your first game to see it here!"
      primaryAction={
        onFindGames
          ? {
              label: 'Find Activities',
              onClick: onFindGames,
              icon: <Search className="w-4 h-4" />,
            }
          : undefined
      }
      size="sm"
    />
  );
}

export interface NoAchievementsEmptyStateProps {
  onFindGames?: () => void;
}

export function NoAchievementsEmptyState({ onFindGames }: NoAchievementsEmptyStateProps) {
  return (
    <EmptyState
      variant="no-achievements"
      primaryAction={
        onFindGames
          ? {
              label: 'Find Activities',
              onClick: onFindGames,
              icon: <Search className="w-4 h-4" />,
            }
          : undefined
      }
      tips={[
        { emoji: 'üèÜ', text: 'Play games to unlock your first achievement!' },
      ]}
    />
  );
}

export interface NoSportsSelectedEmptyStateProps {
  onEditProfile?: () => void;
}

export function NoSportsSelectedEmptyState({ onEditProfile }: NoSportsSelectedEmptyStateProps) {
  return (
    <EmptyState
      variant="no-sports"
      primaryAction={
        onEditProfile
          ? {
              label: 'Add Your Sports',
              onClick: onEditProfile,
              variant: 'outline',
            }
          : undefined
      }
      size="sm"
    />
  );
}

export interface NoMessagesEmptyStateProps {
  isChannel?: boolean;
}

export function NoMessagesEmptyState({ isChannel = false }: NoMessagesEmptyStateProps) {
  return (
    <EmptyState
      variant="no-messages"
      title={isChannel ? 'No messages in this channel' : undefined}
      description={isChannel ? 'Be the first to send a message!' : undefined}
      size="sm"
    />
  );
}

export interface ErrorEmptyStateProps {
  onRetry?: () => void;
  message?: string;
}

export function ErrorEmptyState({ onRetry, message }: ErrorEmptyStateProps) {
  return (
    <EmptyState
      variant="error"
      description={message}
      primaryAction={
        onRetry
          ? {
              label: 'Try Again',
              onClick: onRetry,
              icon: <RefreshCw className="w-4 h-4" />,
            }
          : undefined
      }
    />
  );
}

export default EmptyState;

```

`shared/components/common/ErrorBoundary.tsx`:

```tsx
import { Component, ErrorInfo, ReactNode } from 'react';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { AlertTriangle, RefreshCw } from 'lucide-react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
  onError?: (error: Error, errorInfo: ErrorInfo) => void;
}

interface State {
  hasError: boolean;
  error: Error | null;
  errorInfo: ErrorInfo | null;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }
  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error, errorInfo: null };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('üö® [ErrorBoundary] Error caught:', error);
    console.error('üö® [ErrorBoundary] Error info:', errorInfo);
    
    // Handle chunk loading errors by reloading the page
    if (error.message?.includes('Loading chunk') || 
        error.message?.includes('dynamically imported module') ||
        error.message?.includes('Failed to fetch')) {
      console.warn('üîÑ [ErrorBoundary] Chunk loading error detected, reloading page...');
      setTimeout(() => {
        window.location.reload();
      }, 1000);
      return;
    }
    
    this.setState({
      error,
      errorInfo,
    });
    
    if (this.props.onError) {
      this.props.onError(error, errorInfo);
    }

    // Log to PostHog error tracking
    // Use dynamic import to avoid circular dependencies
    import('@/core/analytics/analyticsService')
      .then(({ analyticsService }) => {
        analyticsService.captureException(error, {
          componentStack: errorInfo.componentStack,
          errorBoundary: true,
        });
      })
      .catch((err) => {
        // Silently fail if analytics service isn't available
        if (import.meta.env.DEV) {
          console.warn('Failed to send error to PostHog:', err);
        }
      });
  }

  handleRetry = () => {
    this.setState({ hasError: false, error: null, errorInfo: null });
  };

  render() {
    if (this.state.hasError) {
      // Custom fallback UI
      if (this.props.fallback) {
        return this.props.fallback;
      }

      // Default error UI
      return (
        <div className="min-h-screen bg-background flex items-center justify-center p-4">
          <Card className="w-full max-w-md">
            <CardHeader className="text-center">
              <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10">
                <AlertTriangle className="h-6 w-6 text-destructive" />
              </div>
              <CardTitle className="text-xl">Something went wrong</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <p className="text-sm text-muted-foreground text-center">
                We encountered an unexpected error. This has been logged and we'll look into it.
              </p>
              
              {process.env.NODE_ENV === 'development' && this.state.error && (
                <details className="text-xs">
                  <summary className="cursor-pointer text-muted-foreground hover:text-foreground">
                    Error Details (Development)
                  </summary>
                  <pre className="mt-2 whitespace-pre-wrap break-words bg-muted p-2 rounded text-xs">
                    {this.state.error.toString()}
                    {this.state.errorInfo?.componentStack}
                  </pre>
                </details>
              )}
              
              <div className="flex gap-2">
                <Button 
                  onClick={this.handleRetry}
                  className="flex-1"
                  variant="default"
                >
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Try Again
                </Button>
                <Button 
                  onClick={() => window.location.reload()}
                  variant="outline"
                  className="flex-1"
                >
                  Reload Page
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      );
    }

    return this.props.children;
  }
}

// Hook version for functional components
export function useErrorHandler() {
  return (error: Error, errorInfo?: { componentStack?: string }) => {
    console.error('Error caught by useErrorHandler:', error, errorInfo);
    
    // You can add error reporting logic here
    // Sentry.captureException(error, { extra: errorInfo });
  };
}
```

`shared/components/common/FloatingActionButton.tsx`:

```tsx
import { useNavigate, useLocation } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Plus } from 'lucide-react';
import { brandColors } from '@/shared/config/theme';

export function FloatingActionButton() {
  // FAB removed - Create is now in bottom navigation for easier access
  return null;
}


```

`shared/components/common/NavigationTest.tsx`:

```tsx
import React from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/shared/components/ui/card';
import { Badge } from '@/shared/components/ui/badge';
import { 
  Home, 
  Search, 
  Plus, 
  User, 
  Settings, 
  Bell, 
  Accessibility, 
  MessageSquare, 
  Gamepad2,
  ArrowLeft,
  CheckCircle,
  XCircle
} from 'lucide-react';

interface NavRoute {
  path: string;
  label: string;
  icon: React.ComponentType<any>;
  description: string;
}

const routes: NavRoute[] = [
  { path: '/', label: 'Home', icon: Home, description: 'Main dashboard and activity feed' },
  { path: '/search', label: 'Search', icon: Search, description: 'Discover and search activities' },
  { path: '/create', label: 'Create Activity', icon: Plus, description: 'Create a new activity' },
  { path: '/profile', label: 'Profile', icon: User, description: 'User profile and stats' },
  { path: '/settings', label: 'Settings', icon: Settings, description: 'App settings and preferences' },
  { path: '/settings/notifications', label: 'Notifications', icon: Bell, description: 'Push notification settings' },
  { path: '/settings/accessibility', label: 'Accessibility', icon: Accessibility, description: 'Accessibility options' },
  { path: '/game/1', label: 'Activity Details', icon: Gamepad2, description: 'Sample activity details page' },
  { path: '/chat/game/1', label: 'Activity Chat', icon: MessageSquare, description: 'Activity chat interface' },
  { path: '/chat/direct/user1', label: 'Direct Chat', icon: MessageSquare, description: 'Direct message interface' },
];

function NavigationTest() {
  const navigate = useNavigate();
  const location = useLocation();
  const [testedRoutes, setTestedRoutes] = React.useState<Set<string>>(new Set());

  const handleNavigate = (path: string) => {
    navigate(path);
    setTestedRoutes(prev => new Set(prev).add(path));
  };

  const currentPath = location.pathname;
  const isTestRoute = currentPath === '/navigation-test';

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="flex items-center gap-4 px-4 py-4">
          <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-xl">Navigation Test</h1>
            <p className="text-sm text-muted-foreground">
              Test all app routes and navigation
            </p>
          </div>
        </div>
      </div>

      <div className="px-4 py-6 space-y-6">
        {/* Current Route Info */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Badge variant="outline">Current Route</Badge>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="font-mono text-sm bg-muted p-3 rounded">
              {currentPath}
            </div>
            {!isTestRoute && (
              <div className="mt-3">
                <Button 
                  variant="outline" 
                  size="sm"
                  onClick={() => navigate('/navigation-test')}
                >
                  Back to Navigation Test
                </Button>
              </div>
            )}
          </CardContent>
        </Card>

        {isTestRoute && (
          <>
            {/* Route Testing */}
            <Card>
              <CardHeader>
                <CardTitle>Route Testing</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid gap-3">
                  {routes.map((route) => {
                    const Icon = route.icon;
                    const isTested = testedRoutes.has(route.path);
                    const isCurrent = currentPath === route.path;
                    
                    return (
                      <div 
                        key={route.path}
                        className={`flex items-center justify-between p-3 border rounded-lg transition-colors ${
                          isCurrent ? 'border-primary bg-primary/5' : 'border-border hover:border-muted-foreground'
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <Icon className="w-5 h-5 text-muted-foreground" />
                          <div>
                            <div className="font-medium">{route.label}</div>
                            <div className="text-sm text-muted-foreground">
                              {route.description}
                            </div>
                            <div className="text-xs font-mono text-muted-foreground">
                              {route.path}
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                          {isTested && (
                            <CheckCircle className="w-4 h-4 text-green-500" />
                          )}
                          {isCurrent ? (
                            <Badge variant="default" className="text-xs">
                              Current
                            </Badge>
                          ) : (
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => handleNavigate(route.path)}
                            >
                              Test
                            </Button>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>

            {/* Test Results */}
            <Card>
              <CardHeader>
                <CardTitle>Test Results</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span>Routes Tested</span>
                    <Badge variant="secondary">
                      {testedRoutes.size} / {routes.length}
                    </Badge>
                  </div>
                  
                  <div className="w-full bg-muted rounded-full h-2">
                    <div 
                      className="bg-primary h-2 rounded-full transition-all duration-300"
                      style={{ width: `${(testedRoutes.size / routes.length) * 100}%` }}
                    />
                  </div>
                  
                  {testedRoutes.size === routes.length && (
                    <div className="flex items-center gap-2 text-green-600 bg-green-50 p-3 rounded">
                      <CheckCircle className="w-5 h-5" />
                      <span>All routes tested successfully!</span>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>

            {/* Quick Actions */}
            <Card>
              <CardHeader>
                <CardTitle>Quick Actions</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      routes.forEach((route, index) => {
                        setTimeout(() => {
                          handleNavigate(route.path);
                        }, index * 1000);
                      });
                    }}
                  >
                    Test All Routes
                  </Button>
                  
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setTestedRoutes(new Set())}
                  >
                    Clear Results
                  </Button>
                  
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => navigate('/')}
                  >
                    Go Home
                  </Button>
                </div>
              </CardContent>
            </Card>
          </>
        )}
      </div>
    </div>
  );
}

export default NavigationTest;
```

`shared/components/common/NetworkStatus.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { Wifi, WifiOff, AlertTriangle } from 'lucide-react';
import { Badge } from '@/shared/components/ui/badge';

export function NetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [supabaseReachable, setSupabaseReachable] = useState<boolean | null>(null);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  useEffect(() => {
    // Test Supabase connectivity
    const testSupabase = async () => {
      try {
        const response = await fetch('https://alegufnopsminqcokelr.supabase.co/rest/v1/', {
          method: 'HEAD',
          signal: AbortSignal.timeout(3000)
        });
        setSupabaseReachable(response.ok);
      } catch (error) {
        console.warn('Supabase connectivity test failed:', error);
        setSupabaseReachable(false);
      }
    };

    if (isOnline) {
      testSupabase();
      // Test every 30 seconds
      const interval = setInterval(testSupabase, 30000);
      return () => clearInterval(interval);
    } else {
      setSupabaseReachable(false);
    }
  }, [isOnline]);

  if (!isOnline) {
    return (
      <Badge variant="destructive" className="fixed top-4 right-4 z-50">
        <WifiOff className="w-3 h-3 mr-1" />
        Offline
      </Badge>
    );
  }

  if (supabaseReachable === false) {
    return (
      <Badge variant="destructive" className="fixed top-4 right-4 z-50">
        <AlertTriangle className="w-3 h-3 mr-1" />
        Connection Issue
      </Badge>
    );
  }

  if (supabaseReachable === true) {
    return (
      <Badge variant="secondary" className="fixed top-4 right-4 z-50 opacity-50">
        <Wifi className="w-3 h-3 mr-1" />
        Connected
      </Badge>
    );
  }

  return null; // Still testing
}

```

`shared/components/common/NotificationCenter.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Avatar, AvatarFallback } from '@/shared/components/ui/avatar';
import { Badge } from '@/shared/components/ui/badge';
import { Separator } from '@/shared/components/ui/separator';
import { LoadingSpinner } from '@/shared/components/ui/loading-spinner';
import { NoNotifications } from '@/shared/components/ui/empty-state';
import { 
  Bell, 
  BellOff, 
  ArrowLeft, 
  MessageSquare, 
  Calendar, 
  Users, 
  Trash2,
  Check,
  CheckCheck,
  Settings,
  Filter,
  RefreshCw
} from 'lucide-react';
import { useNotifications } from '@/domains/users/hooks/useNotifications';
import { useDeepLinks } from '@/shared/hooks/useDeepLinks';
import { toast } from 'sonner';

const getNotificationIcon = (type: string) => {
  switch (type) {
    case 'new_message':
      return <MessageSquare className="w-5 h-5 text-blue-500" />;
    case 'game_reminder':
      return <Calendar className="w-5 h-5 text-orange-500" />;
    case 'game_update':
      return <Users className="w-5 h-5 text-green-500" />;
    case 'join_request':
      return <Users className="w-5 h-5 text-purple-500" />;
    case 'system':
      return <Bell className="w-5 h-5 text-gray-500" />;
    default:
      return <Bell className="w-5 h-5 text-gray-500" />;
  }
};

const getNotificationBackground = (type: string) => {
  switch (type) {
    case 'new_message':
      return 'bg-blue-500/10 border-blue-500/20';
    case 'game_reminder':
      return 'bg-orange-500/10 border-orange-500/20';
    case 'game_update':
      return 'bg-green-500/10 border-green-500/20';
    case 'join_request':
      return 'bg-purple-500/10 border-purple-500/20';
    case 'system':
      return 'bg-gray-500/10 border-gray-500/20';
    default:
      return 'bg-muted/50 border-border';
  }
};

function NotificationCenter() {
  const navigate = useNavigate();
  const { navigateToGame, navigateToChat, navigateToUser } = useDeepLinks();
  const [isLoading, setIsLoading] = useState(false);
  const [filter, setFilter] = useState<'all' | 'unread' | 'messages' | 'activities'>('all');
  
  const {
    notifications,
    unreadCount,
    markAsRead,
    markAllAsRead,
    deleteNotification,
    clearAll
  } = useNotifications();

  const filteredNotifications = notifications.filter(notification => {
    switch (filter) {
      case 'unread':
        return !notification.read;
      case 'messages':
        return notification.type === 'new_message';
      case 'activities':
        return ['game_reminder', 'game_update', 'join_request'].includes(notification.type);
      default:
        return true;
    }
  });

  const handleNotificationClick = async (notification: any) => {
    // Mark as read if unread
    if (!notification.read) {
      markAsRead(notification.id);
    }

    // Determine navigation URL - prioritize actionUrl, fallback to data fields
    let url: string | null = notification.actionUrl;
    
    if (!url) {
      // Build URL from data fields based on notification type
      // Check for gameId in multiple possible locations
      const gameId = notification.gameId || 
                     notification.data?.gameId || 
                     notification.data?.game_id ||
                     notification.data?.game_uuid;
      
      if (gameId) {
        if (notification.type === 'new_message') {
          // Game chat messages
          url = `/chat/game/${gameId}`;
        } else {
          // All other game-related notifications (join_request, game_update, game_reminder, etc.)
          url = `/game/${gameId}`;
        }
      } else {
        // Fallback: Check if notification type is game-related and try to extract gameId from message or other fields
        const gameRelatedTypes = ['join_request', 'game_update', 'game_reminder', 'game_cancelled'];
        if (gameRelatedTypes.includes(notification.type)) {
          // Try to find gameId in the notification message or other data fields
          const messageGameId = notification.message?.match(/game[\/\s]+([a-f0-9-]{36})/i)?.[1];
          if (messageGameId) {
            url = `/game/${messageGameId}`;
          }
        } else if (notification.userId || notification.data?.userId) {
          const userId = notification.userId || notification.data?.userId;
          url = `/user/${userId}`;
        } else if (notification.data?.chatId && notification.data?.chatType) {
          url = `/chat/${notification.data.chatType}/${notification.data.chatId}`;
        }
      }
    }

    // Navigate to appropriate screen
    if (url) {
      if (url.startsWith('/game/')) {
        const gameId = url.split('/')[2];
        navigateToGame(gameId);
      } else if (url.startsWith('/chat/')) {
        const parts = url.split('/');
        const type = parts[2] as 'game' | 'direct';
        const id = parts[3];
        navigateToChat(type, id);
      } else if (url.startsWith('/user/')) {
        const userId = url.split('/')[2];
        navigateToUser(userId);
      } else {
        navigate(url);
      }
    }
  };

  const handleRefresh = async () => {
    setIsLoading(true);
    await new Promise(resolve => setTimeout(resolve, 1000));
    setIsLoading(false);
    toast.success('Notifications refreshed');
  };

  const handleMarkAllRead = () => {
    markAllAsRead();
    // Removed toast - action is clear from UI feedback
  };

  const handleClearAll = () => {
    clearAll();
    // Removed toast - action is clear from UI feedback
  };

  const formatTime = (date: Date) => {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
  };

  // Helper function to properly capitalize notification titles
  const capitalizeTitle = (title: string): string => {
    if (!title) return title;
    // Capitalize first letter of each word, but preserve existing capitalization for proper nouns
    return title
      .split(' ')
      .map(word => {
        // If word is all lowercase or starts with lowercase, capitalize first letter
        if (word.length > 0 && word[0] === word[0].toLowerCase()) {
          return word[0].toUpperCase() + word.slice(1);
        }
        return word;
      })
      .join(' ');
  };

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-10">
        <div className="flex items-center justify-between px-4 py-4">
          <div className="flex items-center gap-4">
            <Button 
              variant="ghost" 
              size="icon" 
              onClick={() => navigate(-1)}
              aria-label="Go back"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div>
              <h1 className="text-xl">Notifications</h1>
              {unreadCount > 0 && (
                <p className="text-sm text-muted-foreground">
                  {unreadCount} unread notification{unreadCount !== 1 ? 's' : ''}
                </p>
              )}
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            <Button
              variant="ghost"
              size="icon"
              onClick={handleRefresh}
              disabled={isLoading}
              aria-label="Refresh notifications"
            >
              {isLoading ? (
                <LoadingSpinner size="sm" />
              ) : (
                <RefreshCw className="w-4 h-4" />
              )}
            </Button>
            
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate('/settings/notifications')}
              aria-label="Notification settings"
            >
              <Settings className="w-4 h-4" />
            </Button>
          </div>
        </div>

        {/* Filter Tabs */}
        <div className="px-4 pb-4">
          <div className="flex gap-2 overflow-x-auto">
            {[
              { key: 'all', label: 'All', count: notifications.length },
              { key: 'unread', label: 'Unread', count: unreadCount },
              { key: 'activities', label: 'Activities', count: notifications.filter(n => ['game_reminder', 'game_update', 'join_request'].includes(n.type)).length },
            ].map((tab) => (
              <button
                key={tab.key}
                onClick={() => setFilter(tab.key as any)}
                className={`flex items-center gap-2 px-4 py-2 rounded-full transition-all whitespace-nowrap ${
                  filter === tab.key
                    ? 'bg-primary text-primary-foreground'
                    : 'bg-muted text-muted-foreground hover:bg-muted/80'
                }`}
              >
                <span>{tab.label}</span>
                {tab.count > 0 && (
                  <Badge 
                    variant={filter === tab.key ? "secondary" : "outline"} 
                    className="text-xs min-w-[20px] h-5"
                  >
                    {tab.count}
                  </Badge>
                )}
              </button>
            ))}
          </div>
        </div>

        {/* Quick Actions */}
        {notifications.length > 0 && (
          <div className="px-4 pb-4">
            <div className="flex gap-2">
              {unreadCount > 0 && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleMarkAllRead}
                  className="text-xs"
                >
                  <CheckCheck className="w-3 h-3 mr-1" />
                  Mark All Read
                </Button>
              )}
              
              <Button
                variant="outline"
                size="sm"
                onClick={handleClearAll}
                className="text-xs text-destructive hover:text-destructive"
              >
                <Trash2 className="w-3 h-3 mr-1" />
                Clear All
              </Button>
            </div>
          </div>
        )}
      </div>

      {/* Notifications List */}
      <div className="px-4 py-6" id="main-content">
        {isLoading ? (
          <div
            key="loading"
            className="space-y-4"
          >
            {Array.from({ length: 5 }).map((_, index) => (
              <div key={index} className="h-20 bg-muted/50 rounded-lg animate-pulse" />
            ))}
          </div>
        ) : filteredNotifications.length === 0 ? (
          <div
            key="empty"
          >
            <NoNotifications filter={filter} />
          </div>
        ) : (
          <div
            key="notifications"
            className="space-y-3"
          >
            {filteredNotifications.map((notification, index) => (
              <div
                key={notification.id}
              >
                  <Card 
                    className={`cursor-pointer transition-all hover:shadow-md ${
                      !notification.read ? 'border-l-4 border-l-primary' : ''
                    } ${getNotificationBackground(notification.type)}`}
                  >
                    <CardContent 
                      className="p-4"
                      onClick={() => handleNotificationClick(notification)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                          e.preventDefault();
                          handleNotificationClick(notification);
                        }
                      }}
                      tabIndex={0}
                      role="button"
                      aria-label={`Notification: ${capitalizeTitle(notification.title)}`}
                    >
                      <div className="flex gap-3">
                        <div className="flex-shrink-0 mt-1">
                          {getNotificationIcon(notification.type)}
                        </div>
                        
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                              <div className={`font-medium ${!notification.read ? 'text-foreground' : 'text-muted-foreground'}`}>
                                {capitalizeTitle(notification.title)}
                              </div>
                              <p className="text-sm text-muted-foreground mt-1 line-clamp-2">
                                {notification.message}
                              </p>
                              <div className="flex items-center gap-2 mt-2">
                                <span className="text-xs text-muted-foreground">
                                  {formatTime(notification.timestamp)}
                                </span>
                                {!notification.read && (
                                  <div className="w-2 h-2 bg-primary rounded-full" />
                                )}
                              </div>
                            </div>
                            
                            <div className="flex items-center gap-1">
                              {!notification.read && (
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    markAsRead(notification.id);
                                    // Removed toast - visual feedback is sufficient
                                  }}
                                  aria-label="Mark as read"
                                  className="h-8 w-8 p-0"
                                >
                                  <Check className="w-3 h-3" />
                                </Button>
                              )}
                              
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  deleteNotification(notification.id);
                                  // Removed toast - action is clear from UI
                                }}
                                aria-label="Delete notification"
                                className="h-8 w-8 p-0 text-destructive hover:text-destructive"
                              >
                                <Trash2 className="w-3 h-3" />
                              </Button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                </div>
              ))}
            </div>
          )}
      </div>
    </div>
  );
}

export default NotificationCenter;
```

`shared/components/common/OAuthPerformanceMonitor.tsx`:

```tsx
import React, { useEffect, useState } from 'react';

interface PerformanceMetrics {
  oauthStartTime: number;
  oauthEndTime: number;
  profileCreationTime: number;
  totalTime: number;
  steps: string[];
}

export function OAuthPerformanceMonitor() {
  const [metrics, setMetrics] = useState<PerformanceMetrics | null>(null);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    // Only show in development or when debug flag is set
    const isDebug = process.env.NODE_ENV === 'development' || 
                   localStorage.getItem('DEBUG_OAUTH_PERFORMANCE') === 'true';
    
    if (!isDebug) return;

    // Monitor OAuth performance
    const startTime = performance.now();
    let profileStartTime = 0;
    let profileEndTime = 0;
    const steps: string[] = [];

    // Track OAuth start
    const originalSignInWithOAuth = window.supabase?.auth?.signInWithOAuth;
    if (originalSignInWithOAuth) {
      window.supabase.auth.signInWithOAuth = async (...args: any[]) => {
        steps.push(`OAuth initiation started at ${new Date().toISOString()}`);
        const result = await originalSignInWithOAuth.apply(window.supabase.auth, args);
        steps.push(`OAuth redirect initiated at ${new Date().toISOString()}`);
        return result;
      };
    }

    // Track profile creation
    const originalGetUserProfile = window.SupabaseService?.getUserProfile;
    if (originalGetUserProfile) {
      window.SupabaseService.getUserProfile = async (...args: any[]) => {
        profileStartTime = performance.now();
        steps.push(`Profile lookup started at ${new Date().toISOString()}`);
        const result = await originalGetUserProfile.apply(window.SupabaseService, args);
        profileEndTime = performance.now();
        steps.push(`Profile lookup completed at ${new Date().toISOString()}`);
        return result;
      };
    }

    // Track auth state changes
    const authStateListener = (event: string, session: any) => {
      if (event === 'SIGNED_IN' && session?.user) {
        const endTime = performance.now();
        const totalTime = endTime - startTime;
        
        setMetrics({
          oauthStartTime: startTime,
          oauthEndTime: endTime,
          profileCreationTime: profileEndTime - profileStartTime,
          totalTime,
          steps: [...steps, `Authentication completed at ${new Date().toISOString()}`]
        });
        setIsVisible(true);
      }
    };

    // Listen for auth changes
    if (window.supabase?.auth?.onAuthStateChange) {
      const { data: { subscription } } = window.supabase.auth.onAuthStateChange(authStateListener);
      
      return () => {
        subscription.unsubscribe();
        // Restore original functions
        if (originalSignInWithOAuth) {
          window.supabase.auth.signInWithOAuth = originalSignInWithOAuth;
        }
        if (originalGetUserProfile) {
          window.SupabaseService.getUserProfile = originalGetUserProfile;
        }
      };
    }
  }, []);

  if (!isVisible || !metrics) return null;

  return (
    <div className="fixed bottom-4 right-4 bg-black/90 text-white p-4 rounded-lg shadow-lg max-w-md z-50">
      <div className="flex justify-between items-center mb-2">
        <h3 className="font-semibold">OAuth Performance</h3>
        <button 
          onClick={() => setIsVisible(false)}
          className="text-gray-400 hover:text-white"
        >
          √ó
        </button>
      </div>
      
      <div className="space-y-2 text-sm">
        <div>
          <span className="text-gray-400">Total Time:</span>
          <span className="ml-2 font-mono">
            {metrics.totalTime.toFixed(2)}ms
          </span>
        </div>
        
        <div>
          <span className="text-gray-400">Profile Creation:</span>
          <span className="ml-2 font-mono">
            {metrics.profileCreationTime.toFixed(2)}ms
          </span>
        </div>
        
        <div className="text-xs text-gray-400">
          <div>Steps:</div>
          {metrics.steps.map((step, index) => (
            <div key={index} className="ml-2">
              {index + 1}. {step}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// Extend window object for type safety
declare global {
  interface Window {
    supabase?: any;
    SupabaseService?: any;
  }
}

```

`shared/components/common/OnlinePlayersWidget.tsx`:

```tsx
import React from 'react';
import { Users, Wifi } from 'lucide-react';
import { Badge } from '@/shared/components/ui/badge';
import { RealtimeAvatarStack } from './realtime-avatar-stack';

export function OnlinePlayersWidget() {
  return (
    <div className="bg-card rounded-lg p-4">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <div className="relative">
            <Users className="w-4 h-4 text-primary" />
            <div className="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          </div>
          <span className="text-sm font-medium">Players Online</span>
        </div>
      </div>
      
      <div className="flex items-center gap-3">
        <RealtimeAvatarStack roomName="global-online" />
        <span className="text-xs text-muted-foreground">
          Active players across all games
        </span>
      </div>
    </div>
  );
}

```

`shared/components/common/QueryErrorBoundary.tsx`:

```tsx
import React, { Component, ReactNode } from 'react';
import { QueryErrorResetBoundary } from '@tanstack/react-query';
import { Button } from '@/shared/components/ui/button';
import { RefreshCw, AlertTriangle } from 'lucide-react';

interface QueryErrorFallbackProps {
  error: Error;
  resetErrorBoundary: () => void;
}

function QueryErrorFallback({ error, resetErrorBoundary }: QueryErrorFallbackProps) {
  console.error('üö® [QueryErrorBoundary] Caught error:', error);
  
  return (
    <div className="min-h-screen bg-background flex items-center justify-center">
      <div className="text-center space-y-4 max-w-md">
        <div className="flex justify-center">
          <AlertTriangle className="w-12 h-12 text-destructive" />
        </div>
        <div>
          <h2 className="text-xl font-semibold text-destructive mb-2">
            Something went wrong
          </h2>
          <p className="text-muted-foreground mb-4">
            {error.message || 'An unexpected error occurred while loading data.'}
          </p>
          <details className="text-left bg-muted p-3 rounded text-xs">
            <summary className="cursor-pointer font-medium mb-2">
              Technical Details
            </summary>
            <pre className="whitespace-pre-wrap break-words">
              {error.stack || error.message}
            </pre>
          </details>
        </div>
        <div className="flex gap-2 justify-center">
          <Button onClick={resetErrorBoundary}>
            <RefreshCw className="w-4 h-4 mr-2" />
            Try Again
          </Button>
          <Button 
            variant="outline"
            onClick={() => {
              console.log('üßπ [QueryErrorBoundary] Clearing all cache');
              localStorage.clear();
              sessionStorage.clear();
              window.location.reload();
            }}
          >
            Reset App
          </Button>
        </div>
      </div>
    </div>
  );
}

interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

interface ErrorBoundaryProps {
  children: ReactNode;
  onReset?: () => void;
  fallback?: (error: Error, reset: () => void) => ReactNode;
}

class SimpleErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('üö® [SimpleErrorBoundary] Error caught:', {
      error: error.message,
      stack: error.stack,
      errorInfo
    });
  }

  reset = () => {
    this.setState({ hasError: false, error: undefined });
    this.props.onReset?.();
  };

  render() {
    if (this.state.hasError && this.state.error) {
      if (this.props.fallback) {
        return this.props.fallback(this.state.error, this.reset);
      }
      return <QueryErrorFallback error={this.state.error} resetErrorBoundary={this.reset} />;
    }

    return this.props.children;
  }
}

interface QueryErrorBoundaryProps {
  children: React.ReactNode;
}

export function QueryErrorBoundary({ children }: QueryErrorBoundaryProps) {
  return (
    <QueryErrorResetBoundary>
      {({ reset }) => (
        <SimpleErrorBoundary
          onReset={reset}
          fallback={(error, resetErrorBoundary) => (
            <QueryErrorFallback error={error} resetErrorBoundary={resetErrorBoundary} />
          )}
        >
          {children}
        </SimpleErrorBoundary>
      )}
    </QueryErrorResetBoundary>
  );
}

```

`shared/components/common/RouteTracker.tsx`:

```tsx
import { useAnalytics } from '@/shared/hooks/useAnalytics';

/**
 * Component that automatically tracks page views on route changes
 * Should be placed inside BrowserRouter
 */
export function RouteTracker() {
  useAnalytics(); // This hook automatically tracks page views
  return null;
}


```

`shared/components/common/SimpleCalendarButton.tsx`:

```tsx
import { Button } from '@/shared/components/ui/button';
import { CalendarPlus } from 'lucide-react';

interface SimpleCalendarButtonProps {
  game: any;
  variant?: 'default' | 'outline' | 'ghost';
  size?: 'sm' | 'default' | 'lg';
  className?: string;
}

export function SimpleCalendarButton({ 
  game, 
  variant = 'outline', 
  size = 'sm',
  className = '' 
}: SimpleCalendarButtonProps) {
  
  const handleAddToCalendar = () => {
    // Create event details
    const gameDateTime = new Date(`${game.date}T${game.time}`);
    const endDateTime = new Date(gameDateTime);
    endDateTime.setHours(endDateTime.getHours() + 2); // Default 2 hours
    
    const title = `${game.sport}: ${game.title}`;
    const description = `Join us for ${game.sport}!\n\n${game.description || ''}\n\nMax Players: ${game.maxPlayers || game.max_players}\nCost: ${game.cost || 'Free'}`;
    const location = game.location;
    
    // Format dates (YYYYMMDDTHHMMSSZ)
    const formatDate = (date: Date) => date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    
    // Detect device and use appropriate calendar
    const userAgent = navigator.userAgent;
    
    if (/iPhone|iPad|iPod/.test(userAgent)) {
      // iOS - Create .ics file and try to open with Calendar app
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//TribeUp//TribeUp Social Sports//EN',
        'BEGIN:VEVENT',
        `UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@tribeup.app`,
        `DTSTART:${formatDate(gameDateTime)}`,
        `DTEND:${formatDate(endDateTime)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        `DTSTAMP:${formatDate(new Date())}`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      const blob = new Blob([icsContent], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      
      // Try to open with Calendar app
      window.location.href = url;
      
      // Cleanup after a delay
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      
    } else if (/Android/.test(userAgent)) {
      // Android - Use Google Calendar
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(gameDateTime)}/${formatDate(endDateTime)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
      window.open(googleUrl, '_blank');
      
    } else if (/Mac/.test(userAgent)) {
      // macOS - Create .ics file for Calendar app
      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//TribeUp//TribeUp Social Sports//EN',
        'BEGIN:VEVENT',
        `UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@tribeup.app`,
        `DTSTART:${formatDate(gameDateTime)}`,
        `DTEND:${formatDate(endDateTime)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        `DTSTAMP:${formatDate(new Date())}`,
        'STATUS:CONFIRMED',
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
      
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
    } else {
      // Default - Google Calendar for all other devices
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(gameDateTime)}/${formatDate(endDateTime)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
      window.open(googleUrl, '_blank');
    }
  };

  return (
    <Button
      variant={variant}
      size={size}
      onClick={handleAddToCalendar}
      className={className}
    >
      <CalendarPlus className="w-4 h-4" />
    </Button>
  );
}

```

`shared/components/common/avatar-stack.tsx`:

```tsx
import { cn } from '@/shared/utils/utils'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { cva, type VariantProps } from 'class-variance-authority'
import * as React from 'react'

const avatarStackVariants = cva('flex -space-x-4 -space-y-4', {
  variants: {
    orientation: {
      vertical: 'flex-row',
      horizontal: 'flex-col',
    },
  },
  defaultVariants: {
    orientation: 'vertical',
  },
})

export interface AvatarStackProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof avatarStackVariants> {
  avatars: { name: string; image: string }[]
  maxAvatarsAmount?: number
}

const AvatarStack = ({
  className,
  orientation,
  avatars,
  maxAvatarsAmount = 3,
  ...props
}: AvatarStackProps) => {
  const shownAvatars = avatars.slice(0, maxAvatarsAmount)
  const hiddenAvatars = avatars.slice(maxAvatarsAmount)

  return (
    <div
      className={cn(
        avatarStackVariants({ orientation }),
        className,
      )}
      {...props}
    >
      {shownAvatars.map(({ name, image }, index) => (
        <div key={`${name}-${image}-${index}`} title={name}>
          <Avatar className="hover:z-10">
            <AvatarImage src={image} />
            <AvatarFallback className="bg-primary/10 text-primary text-xs">
              {name
                ?.split(' ')
                ?.map((word) => word[0])
                ?.join('')
                ?.toUpperCase()}
            </AvatarFallback>
          </Avatar>
        </div>
      ))}

      {hiddenAvatars.length ? (
        <div title={hiddenAvatars.map(({ name }) => name).join(', ')}>
          <Avatar>
            <AvatarFallback>+{avatars.length - shownAvatars.length}</AvatarFallback>
          </Avatar>
        </div>
      ) : null}
    </div>
  )
}

export { AvatarStack, avatarStackVariants }

```

`shared/components/common/chat-message.tsx`:

```tsx
import { cn } from '@/shared/utils/utils'
import type { ChatMessage } from '@/shared/hooks/use-realtime-chat'

interface ChatMessageItemProps {
  message: ChatMessage
  isOwnMessage: boolean
  showHeader: boolean
}

export const ChatMessageItem = ({ message, isOwnMessage, showHeader }: ChatMessageItemProps) => {
  return (
    <div className={`flex mt-2 ${isOwnMessage ? 'justify-end' : 'justify-start'}`}>
      <div
        className={cn('max-w-[75%] w-fit flex flex-col gap-1', {
          'items-end': isOwnMessage,
        })}
      >
        {showHeader && (
          <div
            className={cn('flex items-center gap-2 text-xs px-3', {
              'justify-end flex-row-reverse': isOwnMessage,
            })}
          >
            <span className={'font-medium'}>{message.user.name}</span>
            <span className="text-foreground/50 text-xs">
              {new Date(message.createdAt).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
              })}
            </span>
          </div>
        )}
        <div
          className={cn(
            'py-2 px-3 rounded-xl text-sm w-fit',
            isOwnMessage ? 'bg-primary text-primary-foreground' : 'bg-muted text-foreground'
          )}
        >
          {message.content}
        </div>
      </div>
    </div>
  )
}

```

`shared/components/common/current-user-avatar.tsx`:

```tsx
import { useCurrentUserImage } from '@/shared/hooks/use-current-user-image'
import { useCurrentUserName } from '@/shared/hooks/use-current-user-name'
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar'
import { cn } from '@/shared/utils/utils'

interface CurrentUserAvatarProps {
  size?: 'sm' | 'md' | 'lg'
  className?: string
  showOnlineIndicator?: boolean
}

export const CurrentUserAvatar = ({ 
  size = 'md', 
  className,
  showOnlineIndicator = false 
}: CurrentUserAvatarProps) => {
  const profileImage = useCurrentUserImage()
  const name = useCurrentUserName()
  
  // Generate initials from name, handling edge cases
  const initials = name && name !== '?' 
    ? name
        .split(' ')
        .map((word) => word[0])
        .join('')
        .toUpperCase()
        .slice(0, 2) // Limit to 2 characters
    : '??'

  const sizeClasses = {
    sm: 'w-6 h-6 text-xs',
    md: 'w-8 h-8 text-sm',
    lg: 'w-10 h-10 text-base'
  }

  return (
    <div className="relative">
      <Avatar className={cn(sizeClasses[size], className)}>
        {profileImage && (
          <AvatarImage 
            src={profileImage} 
            alt={name || 'User avatar'} 
            className="object-cover"
          />
        )}
        <AvatarFallback className="bg-primary/10 text-primary font-medium">
          {initials}
        </AvatarFallback>
      </Avatar>
      
      {showOnlineIndicator && (
        <div className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-background rounded-full" />
      )}
    </div>
  )
}

```

`shared/components/common/realtime-avatar-stack.tsx`:

```tsx
import { AvatarStack } from '@/components/avatar-stack'
import { useRealtimePresenceRoom } from '@/hooks/use-realtime-presence-room'
import { useMemo } from 'react'

export const RealtimeAvatarStack = ({ roomName }: { roomName: string }) => {
  const { users: usersMap } = useRealtimePresenceRoom(roomName)
  const avatars = useMemo(() => {
    return Object.values(usersMap).map((user) => ({
      name: user.name,
      image: user.image,
    }))
  }, [usersMap])

  return <AvatarStack avatars={avatars} />
}

```

`shared/components/common/realtime-chat.tsx`:

```tsx
import { cn } from '@/shared/utils/utils'
import { ChatMessageItem } from './chat-message'
import { useChatScroll } from '@/shared/hooks/use-chat-scroll'
import {
  type ChatMessage,
  useRealtimeChat,
} from '@/shared/hooks/use-realtime-chat'
import { Button } from '@/shared/components/ui/button'
import { Input } from '@/shared/components/ui/input'
import { Send } from 'lucide-react'
import { useCallback, useEffect, useMemo, useState } from 'react'

interface RealtimeChatProps {
  roomName: string
  username: string
  onMessage?: (messages: ChatMessage[]) => void
  messages?: ChatMessage[]
}

/**
 * Realtime chat component
 * @param roomName - The name of the room to join. Each room is a unique chat.
 * @param username - The username of the user
 * @param onMessage - The callback function to handle the messages. Useful if you want to store the messages in a database.
 * @param messages - The messages to display in the chat. Useful if you want to display messages from a database.
 * @returns The chat component
 */
export const RealtimeChat = ({
  roomName,
  username,
  onMessage,
  messages: initialMessages = [],
}: RealtimeChatProps) => {
  const { containerRef, scrollToBottom } = useChatScroll()

  const {
    messages: realtimeMessages,
    sendMessage,
    isConnected,
  } = useRealtimeChat({
    roomName,
    username,
  })
  const [newMessage, setNewMessage] = useState('')

  // Merge realtime messages with initial messages
  const allMessages = useMemo(() => {
    const mergedMessages = [...initialMessages, ...realtimeMessages]
    // Remove duplicates based on message id
    const uniqueMessages = mergedMessages.filter(
      (message, index, self) => index === self.findIndex((m) => m.id === message.id)
    )
    // Sort by creation date
    const sortedMessages = uniqueMessages.sort((a, b) => a.createdAt.localeCompare(b.createdAt))

    return sortedMessages
  }, [initialMessages, realtimeMessages])

  useEffect(() => {
    if (onMessage) {
      onMessage(allMessages)
    }
  }, [allMessages, onMessage])

  useEffect(() => {
    // Scroll to bottom whenever messages change
    scrollToBottom()
  }, [allMessages, scrollToBottom])

  const handleSendMessage = useCallback(
    (e: React.FormEvent) => {
      e.preventDefault()
      if (!newMessage.trim() || !isConnected) return

      sendMessage(newMessage)
      setNewMessage('')
    },
    [newMessage, isConnected, sendMessage]
  )

  return (
    <div className="flex flex-col h-full w-full bg-background text-foreground antialiased">
      {/* Messages */}
      <div ref={containerRef} className="flex-1 overflow-y-auto p-4 space-y-4">
        {allMessages.length === 0 ? (
          <div className="text-center text-sm text-muted-foreground">
            No messages yet. Start the conversation!
          </div>
        ) : null}
        <div className="space-y-1">
          {allMessages.map((message, index) => {
            const prevMessage = index > 0 ? allMessages[index - 1] : null
            const showHeader = !prevMessage || prevMessage.user.name !== message.user.name

            return (
              <div
                key={message.id}
                className="animate-in fade-in slide-in-from-bottom-4 duration-300"
              >
                <ChatMessageItem
                  message={message}
                  isOwnMessage={message.user.name === username}
                  showHeader={showHeader}
                />
              </div>
            )
          })}
        </div>
      </div>

      <form onSubmit={handleSendMessage} className="flex w-full gap-2 border-t border-border p-4">
        <Input
          className={cn(
            'rounded-full bg-background text-sm transition-all duration-300',
            isConnected && newMessage.trim() ? 'w-[calc(100%-36px)]' : 'w-full'
          )}
          type="text"
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          placeholder="Type a message..."
          disabled={!isConnected}
        />
        {isConnected && newMessage.trim() && (
          <Button
            className="aspect-square rounded-full animate-in fade-in slide-in-from-right-4 duration-300"
            type="submit"
            disabled={!isConnected}
          >
            <Send className="size-4" />
          </Button>
        )}
      </form>
    </div>
  )
}

```

`shared/components/examples/CurrentUserAvatarExample.tsx`:

```tsx
import React from 'react';
import { CurrentUserAvatar } from '@/components/current-user-avatar';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

/**
 * Example component showing different ways to use CurrentUserAvatar
 * This demonstrates the official Supabase current user avatar component
 * integrated with TribeUp's user system
 */
export function CurrentUserAvatarExample() {
  return (
    <div className="space-y-6 p-6">
      <Card>
        <CardHeader>
          <CardTitle>Current User Avatar Examples</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          
          {/* Different Sizes */}
          <div>
            <h3 className="text-sm font-medium mb-3">Different Sizes</h3>
            <div className="flex items-center gap-4">
              <div className="text-center">
                <CurrentUserAvatar size="sm" />
                <p className="text-xs text-muted-foreground mt-1">Small</p>
              </div>
              <div className="text-center">
                <CurrentUserAvatar size="md" />
                <p className="text-xs text-muted-foreground mt-1">Medium</p>
              </div>
              <div className="text-center">
                <CurrentUserAvatar size="lg" />
                <p className="text-xs text-muted-foreground mt-1">Large</p>
              </div>
            </div>
          </div>

          {/* With Online Indicator */}
          <div>
            <h3 className="text-sm font-medium mb-3">With Online Indicator</h3>
            <div className="flex items-center gap-4">
              <CurrentUserAvatar size="md" showOnlineIndicator />
              <CurrentUserAvatar size="lg" showOnlineIndicator />
            </div>
          </div>

          {/* Custom Styling */}
          <div>
            <h3 className="text-sm font-medium mb-3">Custom Styling</h3>
            <div className="flex items-center gap-4">
              <CurrentUserAvatar 
                size="lg" 
                className="ring-2 ring-primary ring-offset-2" 
              />
              <CurrentUserAvatar 
                size="lg" 
                className="border-2 border-dashed border-muted-foreground" 
              />
            </div>
          </div>

          {/* Usage in Navigation */}
          <div>
            <h3 className="text-sm font-medium mb-3">Navigation Usage</h3>
            <div className="flex items-center gap-2 p-2 bg-muted rounded-lg">
              <CurrentUserAvatar size="sm" />
              <span className="text-sm">Profile</span>
            </div>
          </div>

        </CardContent>
      </Card>
    </div>
  );
}

```

`shared/components/examples/RealtimeAvatarStackExample.tsx`:

```tsx
import React from 'react';
import { RealtimeAvatarStack } from '@/components/realtime-avatar-stack';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

interface RealtimeAvatarStackExampleProps {
  gameId?: string;
  roomName?: string;
}

/**
 * Example component showing how to use RealtimeAvatarStack in your TribeUp app
 * 
 * Usage examples:
 * 1. Game participants: <RealtimeAvatarStackExample gameId="game-123" />
 * 2. Chat room users: <RealtimeAvatarStackExample roomName="game-chat-123" />
 * 3. Venue presence: <RealtimeAvatarStackExample roomName="venue-central-park" />
 */
export function RealtimeAvatarStackExample({ 
  gameId, 
  roomName 
}: RealtimeAvatarStackExampleProps) {
  // Use gameId to create a room name if not provided
  const finalRoomName = roomName || `game-${gameId}`;

  return (
    <Card className="w-full max-w-md">
      <CardHeader>
        <CardTitle className="text-sm font-medium">
          {gameId ? 'Game Participants' : 'Online Users'}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="flex items-center gap-3">
          <RealtimeAvatarStack roomName={finalRoomName} />
          <span className="text-sm text-muted-foreground">
            Currently online
          </span>
        </div>
      </CardContent>
    </Card>
  );
}

// Integration examples for your existing components:

/**
 * 1. Add to GameDetails.tsx:
 * 
 * import { RealtimeAvatarStack } from '@/components/realtime-avatar-stack';
 * 
 * // In your GameDetails component:
 * <div className="flex items-center gap-2 mb-4">
 *   <h3 className="font-semibold">Participants</h3>
 *   <RealtimeAvatarStack roomName={`game-${game.id}`} />
 * </div>
 */

/**
 * 2. Add to GameChat.tsx:
 * 
 * // Show who's actively in the chat
 * <div className="border-b p-3">
 *   <div className="flex items-center justify-between">
 *     <span className="text-sm font-medium">Active in chat</span>
 *     <RealtimeAvatarStack roomName={`chat-${gameId}`} />
 *   </div>
 * </div>
 */

/**
 * 3. Add to UnifiedGameCard.tsx:
 * 
 * // Quick preview of online participants
 * <div className="flex items-center gap-2 text-xs text-muted-foreground">
 *   <RealtimeAvatarStack roomName={`game-${game.id}`} />
 *   <span>online now</span>
 * </div>
 */

/**
 * 4. Add to OnlinePlayersWidget.tsx:
 * 
 * // Replace your current implementation with:
 * <RealtimeAvatarStack roomName="global-online" />
 */

```

`shared/components/figma/ImageWithFallback.tsx`:

```tsx
import React, { useState } from 'react'

const ERROR_IMG_SRC =
  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODgiIGhlaWdodD0iODgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgc3Ryb2tlPSIjMDAwIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBvcGFjaXR5PSIuMyIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIzLjciPjxyZWN0IHg9IjE2IiB5PSIxNiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjU2IiByeD0iNiIvPjxwYXRoIGQ9Im0xNiA1OCAxNi0xOCAzMiAzMiIvPjxjaXJjbGUgY3g9IjUzIiBjeT0iMzUiIHI9IjciLz48L3N2Zz4KCg=='

export function ImageWithFallback(props: React.ImgHTMLAttributes<HTMLImageElement>) {
  const [didError, setDidError] = useState(false)

  const handleError = () => {
    setDidError(true)
  }

  const { src, alt, style, className, ...rest } = props

  return didError ? (
    <div
      className={`inline-block bg-gray-100 text-center align-middle ${className ?? ''}`}
      style={style}
    >
      <div className="flex items-center justify-center w-full h-full">
        <img src={ERROR_IMG_SRC} alt="Error loading image" {...rest} data-original-url={src} />
      </div>
    </div>
  ) : (
    <img src={src} alt={alt} className={className} style={style} {...rest} onError={handleError} />
  )
}

```

`shared/components/layout/AppContent.tsx`:

```tsx
import { Outlet, useLocation } from 'react-router-dom';
import { useEffect } from 'react';
import { DesktopLayout } from './DesktopLayout';
import { MobileLayout } from './MobileLayout';
import { useResponsive } from '@/shared/hooks/useResponsive';
import { useLayoutState } from '@/shared/hooks/useLayoutState';

function AppContent() {
  const { isMobile } = useResponsive();
  const { navigationRef, layoutState } = useLayoutState();
  const location = useLocation();

  // Scroll to top on route change - first line of defense
  useEffect(() => {
    // Scroll immediately on route change
    window.scrollTo(0, 0);
  }, [location.pathname]);

  if (isMobile) {
    return (
      <MobileLayout 
        navigationRef={navigationRef}
        layoutState={layoutState}
      >
        <Outlet />
      </MobileLayout>
    );
  }

  return (
    <DesktopLayout>
      <Outlet />
    </DesktopLayout>
  );
}

export default AppContent;
```

`shared/components/layout/BottomNavigation.tsx`:

```tsx
import { forwardRef } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Badge } from '@/shared/components/ui/badge';
import { CurrentUserAvatar } from '@/shared/components/common/current-user-avatar';
import { useNotifications } from '@/domains/users/hooks/useNotifications';
import { useAppStore } from '@/store/appStore';
import { getMobileNavItems } from '@/shared/config/navigation';


export const BottomNavigation = forwardRef<HTMLDivElement>((_props, ref) => {
  const navigate = useNavigate();
  const location = useLocation();
  
  // Use safe defaults to prevent white screen on refresh
  const notifications = useNotifications();
  const { user } = useAppStore();
  
  // Provide fallbacks if hooks return undefined/null
  const unreadCount = notifications?.unreadCount || 0;
  const safeUser = user || null;
  
  const navItems = getMobileNavItems();

  // Helper to check if nav item is active
  const isNavItemActive = (itemPath: string, currentPath: string) => {
    // Exact match
    if (currentPath === itemPath) return true;
    // Home route: also match /app and /app/
    if (itemPath === '/app' && (currentPath === '/app' || currentPath === '/app/')) return true;
    return false;
  };

  return (
    <div ref={ref} className="fixed bottom-0 left-0 right-0 bg-background/95 backdrop-blur-sm border-t border-border z-40">
      <nav className="flex items-stretch max-w-lg mx-auto" role="navigation" aria-label="Primary">
        {navItems.map((item) => {
          const isActive = isNavItemActive(item.path, location.pathname);
          const Icon = item.icon;
          
          return (
            <Button
              key={item.path}
              variant="ghost"
              onClick={() => navigate(item.path)}
              className={`relative flex flex-col items-center justify-center gap-1 py-2.5 px-2 h-auto flex-1 rounded-none transition-colors duration-150 shadow-none group ${
                isActive 
                  ? 'text-primary bg-primary/10' 
                  : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'
              }`}
              aria-label={`Navigate to ${item.label}`}
              aria-current={isActive ? 'page' : undefined}
            >
              <div className="relative flex items-center justify-center w-6 h-6">
                {item.path === '/profile' && safeUser ? (
                  <CurrentUserAvatar size="sm" className={isActive ? 'scale-110 transition-transform duration-200' : 'transition-transform duration-200'} />
                ) : (
                  <Icon className={`w-6 h-6 ${isActive ? 'scale-110' : 'group-hover:scale-105'} transition-transform duration-150`} />
                )}
                {(item.showBadge || item.path === '/notifications') && unreadCount > 0 && (
                  <Badge 
                    variant="destructive" 
                    className="absolute -top-1 -right-1 h-4 w-4 p-0 text-[10px] flex items-center justify-center min-w-[16px] rounded-full"
                  >
                    {unreadCount > 99 ? '99+' : unreadCount}
                  </Badge>
                )}
              </div>
              
              <span className={`text-[11px] font-medium leading-tight ${isActive ? 'font-semibold' : 'text-muted-foreground'}`}>
                {item.label}
              </span>
              
              {/* Active indicator - subtle top border */}
              {isActive && (
                <div className="absolute top-0 left-0 right-0 h-0.5 bg-primary rounded-full" aria-hidden="true" />
              )}
            </Button>
          );
        })}
      </nav>
      
      {/* Bottom safe area for mobile devices */}
      <div className="pb-safe bg-background/95" />
    </div>
  );
});

BottomNavigation.displayName = 'BottomNavigation';
```

`shared/components/layout/DesktopLayout.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { Button } from '@/shared/components/ui/button';
import { Badge } from '@/shared/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { useNotifications } from '@/domains/users/hooks/useNotifications';
import { useAppStore } from '@/store/appStore';
import { Plus, Menu } from 'lucide-react';
import { ThemeToggle } from '@/shared/components/ui/theme-toggle';
import { getDesktopNavItems } from '@/shared/config/navigation';
import { brandColors, layoutConstants } from '@/shared/config/theme';


export function DesktopLayout({ children }: { children: React.ReactNode }) {
  const navigate = useNavigate();
  const location = useLocation();
  const { unreadCount } = useNotifications();
  const { user } = useAppStore();
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  
  const sidebarItems = getDesktopNavItems();

  return (
    <div className="flex h-screen bg-background">
      {/* Sidebar */}
      <aside 
        className={`bg-card border-r border-border ${layoutConstants.sidebar.transition} ${
          sidebarCollapsed ? layoutConstants.sidebar.collapsed : layoutConstants.sidebar.expanded
        }`}
      >
        {/* Sidebar Header */}
        <div className={sidebarCollapsed ? 'px-4 py-4' : 'p-6 border-b border-border'}>
          {!sidebarCollapsed ? (
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div>
                  <h1 className="text-xl text-foreground">TribeUp</h1>
                  <p className="text-sm text-muted-foreground">Find your tribe</p>
                </div>
                <ThemeToggle />
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                  aria-label="Collapse sidebar"
                >
                  <Menu className="w-5 h-5" />
                </Button>
              </div>
              {/* Close outer flex container */}
            </div>
          ) : (
            <Button
              variant="ghost"
              onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
              aria-label="Expand sidebar"
              className="w-10 h-10 p-0 mx-auto"
            >
              <Menu className="w-5 h-5" />
            </Button>
          )}
        </div>

        {/* Quick Create Button */}
        <div className="p-4">
          <Button
            onClick={() => navigate('/app/create')}
            className={`gap-3 text-white hover:opacity-90 ${
              sidebarCollapsed 
                ? 'w-10 h-10 p-0 justify-center mx-auto' 
                : 'w-full justify-start'
            }`}
            style={{ 
              backgroundColor: brandColors.primary, 
              borderColor: brandColors.primary
            }}
            aria-label="Create new game"
          >
            <Plus className="w-5 h-5" />
            {!sidebarCollapsed && 'Create Activity'}
          </Button>
        </div>

        {/* Navigation Items */}
        <nav className="flex-1 px-4 space-y-2" role="menubar">
          {sidebarItems.map((item) => {
            const isActive = location.pathname === item.path;
            const Icon = item.icon;
            
            return (
              <div
                key={item.path}
              >
                <Button
                  variant="ghost"
                  onClick={() => navigate(item.path)}
                  className={`gap-3 h-10 relative ${
                    sidebarCollapsed 
                      ? 'w-10 p-0 justify-center mx-auto' 
                      : 'w-full justify-start px-4'
                  } ${isActive ? 'bg-accent text-accent-foreground' : ''}`}
                  role="menuitem"
                  aria-current={isActive ? 'page' : undefined}
                  title={sidebarCollapsed ? item.label : undefined}
                >
                  <div className="relative">
                    <Icon className="w-5 h-5 flex-shrink-0" />
                    {(item.showBadge || item.path === '/notifications') && unreadCount > 0 && (
                      <Badge 
                        variant="destructive" 
                        className="absolute -top-1 -right-1 h-4 min-w-4 p-0 text-xs flex items-center justify-center"
                      >
                        {unreadCount > 99 ? '99+' : unreadCount}
                      </Badge>
                    )}
                  </div>
                  {!sidebarCollapsed && (
                    <div className="flex-1 text-left">
                      <div className="font-medium flex items-center gap-2">
                        {item.label}
                        {(item.showBadge || item.path === '/notifications') && unreadCount > 0 && (
                          <Badge variant="destructive" className="h-5 px-2 text-xs">
                            {unreadCount > 99 ? '99+' : unreadCount}
                          </Badge>
                        )}
                      </div>
                    </div>
                  )}
                </Button>
              </div>
            );
          })}
        </nav>

        {/* User Profile */}
        <div className={`border-t border-border ${sidebarCollapsed ? 'px-4 py-4' : 'p-4'}`}>
          {!sidebarCollapsed ? (
            <div className="flex items-center gap-3">
              <Avatar className="cursor-pointer" onClick={() => navigate('/app/profile')}>
                {user?.avatar && <AvatarImage src={user.avatar} alt={user.name || 'User'} />}
                <AvatarFallback>{user?.name?.charAt(0) || 'U'}</AvatarFallback>
              </Avatar>
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate">
                  {user?.name || 'User'}
                </p>
                <p className="text-xs text-muted-foreground truncate">
                  {user?.username ? `@${user.username}` : '@user'}
                </p>
              </div>
            </div>
          ) : (
            <div className="w-8 h-8 mx-auto">
              <Avatar className="cursor-pointer w-8 h-8" onClick={() => navigate('/app/profile')}>
                {user?.avatar && <AvatarImage src={user.avatar} alt={user.name || 'User'} />}
                <AvatarFallback className="text-xs">{user?.name?.charAt(0) || 'U'}</AvatarFallback>
              </Avatar>
            </div>
          )}
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-hidden">
        {children}
      </main>
    </div>
  );
}
```

`shared/components/layout/MobileLayout.tsx`:

```tsx
import React from 'react';
import { BottomNavigation } from './BottomNavigation';
import { LayoutState } from '@/shared/hooks/useLayoutState';
import { FloatingActionButton } from '@/shared/components/common/FloatingActionButton';

interface MobileLayoutProps {
  children: React.ReactNode;
  navigationRef: React.RefObject<HTMLDivElement>;
  layoutState: LayoutState;
}

export function MobileLayout({ 
  children, 
  navigationRef, 
  layoutState 
}: MobileLayoutProps) {
  const { navigationHeight, shouldShowBottomNav } = layoutState;

  return (
    <div className="min-h-screen bg-background">
      {/* Main content area with proper scrolling */}
      <main 
        style={{ 
          paddingBottom: shouldShowBottomNav ? `${navigationHeight + 16}px` : '0px' 
        }}
        className="relative"
      >
        {children}
      </main>

      {/* Floating Action Button for Create */}
      <FloatingActionButton />

      {/* Bottom navigation - conditionally rendered */}
      {shouldShowBottomNav && <BottomNavigation ref={navigationRef} />}
    </div>
  );
}

```

`shared/components/ui/GameCapacity.tsx`:

```tsx
import React from 'react';
import { Users } from 'lucide-react';
import { Badge } from './badge';

interface GameCapacityProps {
  totalPlayers: number; // Pre-computed from games_with_counts.total_players (DO NOT recalculate)
  maxPlayers: number; // From games_with_counts.max_players
  availableSpots: number; // Pre-computed from games_with_counts.available_spots (DO NOT recalculate)
  className?: string;
}

/**
 * GameCapacity - Displays game capacity from pre-computed view fields ONLY
 * 
 * SINGLE SOURCE OF TRUTH:
 * - totalPlayers: from games_with_counts.total_players
 * - maxPlayers: from games_with_counts.max_players
 * - availableSpots: from games_with_counts.available_spots
 * 
 * DO NOT pass private_count/public_count or recalculate anything
 */
export function GameCapacity({
  totalPlayers,
  maxPlayers,
  availableSpots,
  className = ''
}: GameCapacityProps) {
  const total = Number(totalPlayers ?? 0);
  const max = Number(maxPlayers ?? 0);
  const available = Math.max(0, Number(availableSpots ?? 0));
  
  // Determine if game is full or nearly full
  const isFull = available === 0;
  const isNearlyFull = available <= 2 && available > 0;
  
  // Debug logging
  console.log('GameCapacity render:', {
    totalPlayers: total,
    maxPlayers: max,
    availableSpots: available
  });

  return (
    <div className={`flex items-center gap-2 ${className}`}>
      <div className="flex items-center gap-1 text-sm text-muted-foreground">
        <Users className="w-4 h-4" />
        <span>
          {total}/{max}
        </span>
      </div>
      
      {isFull && (
        <Badge variant="destructive" size="sm">
          Full
        </Badge>
      )}
      
      {isNearlyFull && !isFull && (
        <Badge variant="orange" size="sm">
          {available} left
        </Badge>
      )}
    </div>
  );
}

/**
 * GameCapacityLine - Displays capacity as text
 * Format: "Capacity: X/Y | Z available"
 */
export function GameCapacityLine({
  totalPlayers,
  maxPlayers,
  availableSpots
}: GameCapacityProps) {
  const total = Number(totalPlayers ?? 0);
  const max = Number(maxPlayers ?? 0);
  const available = Math.max(0, Number(availableSpots ?? 0));
  
  return (
    <span className="text-sm text-muted-foreground">
      Capacity: {total}/{max} | {available} available
    </span>
  );
}


```

`shared/components/ui/accordion.tsx`:

```tsx
"use client";

import * as React from "react";
import * as AccordionPrimitive from "@radix-ui/react-accordion";
import { ChevronDownIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />;
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn("border-b last:border-b-0", className)}
      {...props}
    />
  );
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
          className,
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  );
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn("pt-0 pb-4", className)}>{children}</div>
    </AccordionPrimitive.Content>
  );
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent };

```

`shared/components/ui/alert-dialog.tsx`:

```tsx
"use client";

import * as React from "react";
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog";

import { cn } from "@/shared/utils/utils";
import { buttonVariants } from "./button";

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />;
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  );
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  );
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className,
        )}
        {...props}
      />
    </AlertDialogPortal>
  );
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className,
      )}
      {...props}
    />
  );
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  );
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  );
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  );
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};

```

`shared/components/ui/alert.tsx`:

```tsx
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/shared/utils/utils";

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  );
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className,
      )}
      {...props}
    />
  );
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className,
      )}
      {...props}
    />
  );
}

export { Alert, AlertTitle, AlertDescription };

```

`shared/components/ui/aspect-ratio.tsx`:

```tsx
"use client";

import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio";

function AspectRatio({
  ...props
}: React.ComponentProps<typeof AspectRatioPrimitive.Root>) {
  return <AspectRatioPrimitive.Root data-slot="aspect-ratio" {...props} />;
}

export { AspectRatio };

```

`shared/components/ui/avatar.tsx`:

```tsx
import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/shared/utils/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

```

`shared/components/ui/badge.tsx`:

```tsx
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/shared/utils/utils";

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border font-medium w-fit whitespace-nowrap shrink-0 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        orange:
          "border-transparent bg-orange-600 text-white [a&]:hover:bg-orange-700 dark:bg-orange-600 dark:text-white",
      },
      size: {
        sm: "px-1.5 py-0.5 text-[10px] [&>svg]:size-2.5",
        default: "px-2 py-0.5 text-xs [&>svg]:size-3",
        lg: "px-3 py-1 text-sm [&>svg]:size-4",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function Badge({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span";

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant, size }), className)}
      {...props}
    />
  );
}

export { Badge, badgeVariants };

```

`shared/components/ui/breadcrumb.tsx`:

```tsx
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { ChevronRight, MoreHorizontal } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Breadcrumb({ ...props }: React.ComponentProps<"nav">) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />;
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<"ol">) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        "text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5",
        className,
      )}
      {...props}
    />
  );
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn("inline-flex items-center gap-1.5", className)}
      {...props}
    />
  );
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean;
}) {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn("hover:text-foreground transition-colors", className)}
      {...props}
    />
  );
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("text-foreground font-normal", className)}
      {...props}
    />
  );
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn("[&>svg]:size-3.5", className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  );
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  );
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
};

```

`shared/components/ui/button.tsx`:

```tsx
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/shared/utils/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-medium transition-all duration-200 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive shadow-sm hover:shadow-md active:scale-[0.98] transform",
  {
    variants: {
      variant: {
        default: "bg-orange-600 text-white hover:bg-orange-700 hover:shadow-orange-600/25 hover:text-white active:text-white focus:text-white",
        destructive:
          "bg-gradient-to-r from-destructive to-destructive/90 text-white hover:from-destructive/90 hover:to-destructive/80 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 hover:shadow-destructive/25 hover:text-white active:text-white focus:text-white",
        outline:
          "border-2 bg-background text-gray-900 hover:bg-accent hover:text-gray-900 dark:bg-input/30 dark:border-input dark:hover:bg-input/50 hover:border-primary/50 dark:text-white active:text-gray-900 focus:text-gray-900",
        secondary:
          "bg-gradient-to-r from-secondary to-secondary/90 text-gray-900 hover:from-secondary/90 hover:to-secondary/80 hover:text-gray-900 active:text-gray-900 focus:text-gray-900 dark:text-white",
        ghost:
          "hover:bg-accent hover:text-gray-900 dark:hover:bg-accent/50 hover:shadow-none text-gray-900 dark:text-white active:text-gray-900 focus:text-gray-900",
        link: "text-orange-600 underline-offset-4 hover:underline shadow-none hover:shadow-none hover:text-orange-700 active:text-orange-600 focus:text-orange-600 dark:text-orange-400",
        message: "bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-blue-500/25 font-semibold hover:text-white active:text-white focus:text-white",
        "orange-gradient": "bg-gradient-to-r from-orange-500 to-orange-600 text-white hover:from-orange-600 hover:to-orange-700 hover:shadow-orange-500/25 shadow-lg hover:shadow-xl transition-all duration-300 hover:text-white active:text-white focus:text-white",
      },
      size: {
        default: "h-10 px-5 py-2.5 has-[>svg]:px-4",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-12 rounded-lg px-8 has-[>svg]:px-6 text-base",
        icon: "size-10 rounded-lg",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

const Button = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> &
    VariantProps<typeof buttonVariants> & {
      asChild?: boolean;
    }
>(({ className, variant, size, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      ref={ref}
      data-slot="button"
      className={cn(buttonVariants({ variant, size }), className)}
      {...props}
    />
  );
});

Button.displayName = "Button";

export { Button, buttonVariants };

```

`shared/components/ui/calendar.tsx`:

```tsx
"use client";

import * as React from "react";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { DayPicker } from "react-day-picker";

import { cn } from "@/shared/utils/utils";
import { buttonVariants } from "./button";

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: React.ComponentProps<typeof DayPicker>) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row gap-2",
        month: "flex flex-col gap-4",
        caption: "flex justify-center pt-1 relative items-center w-full",
        caption_label: "text-sm font-medium",
        nav: "flex items-center gap-1",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "size-7 bg-transparent p-0 opacity-50 hover:opacity-100",
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-x-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-8 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: cn(
          "relative p-0 text-center text-sm focus-within:relative focus-within:z-20 [&:has([aria-selected])]:bg-accent [&:has([aria-selected].day-range-end)]:rounded-r-md",
          props.mode === "range"
            ? "[&:has(>.day-range-end)]:rounded-r-md [&:has(>.day-range-start)]:rounded-l-md first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md"
            : "[&:has([aria-selected])]:rounded-md",
        ),
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "size-8 p-0 font-normal aria-selected:opacity-100",
        ),
        day_range_start:
          "day-range-start aria-selected:bg-primary aria-selected:text-primary-foreground",
        day_range_end:
          "day-range-end aria-selected:bg-primary aria-selected:text-primary-foreground",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ className, ...props }) => (
          <ChevronLeft className={cn("size-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }) => (
          <ChevronRight className={cn("size-4", className)} {...props} />
        ),
      }}
      {...props}
    />
  );
}

export { Calendar };

```

`shared/components/ui/card.tsx`:

```tsx
import * as React from "react";

import { cn } from "@/shared/utils/utils";

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border",
        className,
      )}
      {...props}
    />
  );
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 pt-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className,
      )}
      {...props}
    />
  );
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <h4
      data-slot="card-title"
      className={cn("leading-none", className)}
      {...props}
    />
  );
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <p
      data-slot="card-description"
      className={cn("text-muted-foreground", className)}
      {...props}
    />
  );
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className,
      )}
      {...props}
    />
  );
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6 [&:last-child]:pb-6", className)}
      {...props}
    />
  );
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 pb-6 [.border-t]:pt-6", className)}
      {...props}
    />
  );
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
};

```

`shared/components/ui/carousel.tsx`:

```tsx
"use client";

import * as React from "react";
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react";
import { ArrowLeft, ArrowRight } from "lucide-react";

import { cn } from "@/shared/utils/utils";
import { Button } from "./button";

type CarouselApi = UseEmblaCarouselType[1];
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>;
type CarouselOptions = UseCarouselParameters[0];
type CarouselPlugin = UseCarouselParameters[1];

type CarouselProps = {
  opts?: CarouselOptions;
  plugins?: CarouselPlugin;
  orientation?: "horizontal" | "vertical";
  setApi?: (api: CarouselApi) => void;
};

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0];
  api: ReturnType<typeof useEmblaCarousel>[1];
  scrollPrev: () => void;
  scrollNext: () => void;
  canScrollPrev: boolean;
  canScrollNext: boolean;
} & CarouselProps;

const CarouselContext = React.createContext<CarouselContextProps | null>(null);

function useCarousel() {
  const context = React.useContext(CarouselContext);

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />");
  }

  return context;
}

function Carousel({
  orientation = "horizontal",
  opts,
  setApi,
  plugins,
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & CarouselProps) {
  const [carouselRef, api] = useEmblaCarousel(
    {
      ...opts,
      axis: orientation === "horizontal" ? "x" : "y",
    },
    plugins,
  );
  const [canScrollPrev, setCanScrollPrev] = React.useState(false);
  const [canScrollNext, setCanScrollNext] = React.useState(false);

  const onSelect = React.useCallback((api: CarouselApi) => {
    if (!api) return;
    setCanScrollPrev(api.canScrollPrev());
    setCanScrollNext(api.canScrollNext());
  }, []);

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev();
  }, [api]);

  const scrollNext = React.useCallback(() => {
    api?.scrollNext();
  }, [api]);

  const handleKeyDown = React.useCallback(
    (event: React.KeyboardEvent<HTMLDivElement>) => {
      if (event.key === "ArrowLeft") {
        event.preventDefault();
        scrollPrev();
      } else if (event.key === "ArrowRight") {
        event.preventDefault();
        scrollNext();
      }
    },
    [scrollPrev, scrollNext],
  );

  React.useEffect(() => {
    if (!api || !setApi) return;
    setApi(api);
  }, [api, setApi]);

  React.useEffect(() => {
    if (!api) return;
    onSelect(api);
    api.on("reInit", onSelect);
    api.on("select", onSelect);

    return () => {
      api?.off("select", onSelect);
    };
  }, [api, onSelect]);

  return (
    <CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}
    >
      <div
        onKeyDownCapture={handleKeyDown}
        className={cn("relative", className)}
        role="region"
        aria-roledescription="carousel"
        data-slot="carousel"
        {...props}
      >
        {children}
      </div>
    </CarouselContext.Provider>
  );
}

function CarouselContent({ className, ...props }: React.ComponentProps<"div">) {
  const { carouselRef, orientation } = useCarousel();

  return (
    <div
      ref={carouselRef}
      className="overflow-hidden"
      data-slot="carousel-content"
    >
      <div
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className,
        )}
        {...props}
      />
    </div>
  );
}

function CarouselItem({ className, ...props }: React.ComponentProps<"div">) {
  const { orientation } = useCarousel();

  return (
    <div
      role="group"
      aria-roledescription="slide"
      data-slot="carousel-item"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className,
      )}
      {...props}
    />
  );
}

function CarouselPrevious({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel();

  return (
    <Button
      data-slot="carousel-previous"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -left-12 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className,
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft />
      <span className="sr-only">Previous slide</span>
    </Button>
  );
}

function CarouselNext({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollNext, canScrollNext } = useCarousel();

  return (
    <Button
      data-slot="carousel-next"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -right-12 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className,
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight />
      <span className="sr-only">Next slide</span>
    </Button>
  );
}

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
};

```

`shared/components/ui/chart.tsx`:

```tsx
"use client";

import * as React from "react";
import * as RechartsPrimitive from "recharts@2.15.2";

import { cn } from "@/shared/utils/utils";

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const;

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode;
    icon?: React.ComponentType;
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  );
};

type ChartContextProps = {
  config: ChartConfig;
};

const ChartContext = React.createContext<ChartContextProps | null>(null);

function useChart() {
  const context = React.useContext(ChartContext);

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />");
  }

  return context;
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig;
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"];
}) {
  const uniqueId = React.useId();
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`;

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className,
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  );
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color,
  );

  if (!colorConfig.length) {
    return null;
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color;
    return color ? `  --color-${key}: ${color};` : null;
  })
  .join("\n")}
}
`,
          )
          .join("\n"),
      }}
    />
  );
};

const ChartTooltip = RechartsPrimitive.Tooltip;

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean;
    hideIndicator?: boolean;
    indicator?: "line" | "dot" | "dashed";
    nameKey?: string;
    labelKey?: string;
  }) {
  const { config } = useChart();

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null;
    }

    const [item] = payload;
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`;
    const itemConfig = getPayloadConfigFromPayload(config, item, key);
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label;

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      );
    }

    if (!value) {
      return null;
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>;
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ]);

  if (!active || !payload?.length) {
    return null;
  }

  const nestLabel = payload.length === 1 && indicator !== "dot";

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className,
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload.map((item, index) => {
          const key = `${nameKey || item.name || item.dataKey || "value"}`;
          const itemConfig = getPayloadConfigFromPayload(config, item, key);
          const indicatorColor = color || item.payload.fill || item.color;

          return (
            <div
              key={item.dataKey}
              className={cn(
                "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                indicator === "dot" && "items-center",
              )}
            >
              {formatter && item?.value !== undefined && item.name ? (
                formatter(item.value, item.name, item, index, item.payload)
              ) : (
                <>
                  {itemConfig?.icon ? (
                    <itemConfig.icon />
                  ) : (
                    !hideIndicator && (
                      <div
                        className={cn(
                          "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                          {
                            "h-2.5 w-2.5": indicator === "dot",
                            "w-1": indicator === "line",
                            "w-0 border-[1.5px] border-dashed bg-transparent":
                              indicator === "dashed",
                            "my-0.5": nestLabel && indicator === "dashed",
                          },
                        )}
                        style={
                          {
                            "--color-bg": indicatorColor,
                            "--color-border": indicatorColor,
                          } as React.CSSProperties
                        }
                      />
                    )
                  )}
                  <div
                    className={cn(
                      "flex flex-1 justify-between leading-none",
                      nestLabel ? "items-end" : "items-center",
                    )}
                  >
                    <div className="grid gap-1.5">
                      {nestLabel ? tooltipLabel : null}
                      <span className="text-muted-foreground">
                        {itemConfig?.label || item.name}
                      </span>
                    </div>
                    {item.value && (
                      <span className="text-foreground font-mono font-medium tabular-nums">
                        {item.value.toLocaleString()}
                      </span>
                    )}
                  </div>
                </>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

const ChartLegend = RechartsPrimitive.Legend;

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean;
    nameKey?: string;
  }) {
  const { config } = useChart();

  if (!payload?.length) {
    return null;
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className,
      )}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || "value"}`;
        const itemConfig = getPayloadConfigFromPayload(config, item, key);

        return (
          <div
            key={item.value}
            className={cn(
              "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3",
            )}
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        );
      })}
    </div>
  );
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string,
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined;
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined;

  let configLabelKey: string = key;

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string;
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string;
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config];
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
};

```

`shared/components/ui/checkbox.tsx`:

```tsx
"use client";

import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { CheckIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border bg-input-background dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  );
}

export { Checkbox };

```

`shared/components/ui/clickable-avatar.tsx`:

```tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Avatar, AvatarImage, AvatarFallback } from './avatar';
import { cn } from '@/shared/utils/utils';
import { useAppStore } from '@/store/appStore';

interface ClickableAvatarProps {
  userId?: string;
  src?: string;
  alt?: string;
  fallback?: string;
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
  className?: string;
  onClick?: () => void;
  disabled?: boolean;
}

const sizeClasses = {
  xs: 'h-6 w-6',
  sm: 'h-6 w-6',
  md: 'h-8 w-8', 
  lg: 'h-10 w-10',
  xl: 'h-12 w-12'
};

export function ClickableAvatar({
  userId,
  src,
  alt,
  fallback,
  size = 'md',
  className,
  onClick,
  disabled = false
}: ClickableAvatarProps) {
  const navigate = useNavigate();
  const { user } = useAppStore();

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    
    if (onClick) {
      onClick();
    } else if (userId && !disabled) {
      // Route normalization: if user taps their own card, redirect to own profile route
      const currentUserId = user?.id;
      if (userId === currentUserId) {
        navigate('/app/profile/me');
      } else {
        navigate(`/app/user/${userId}`);
      }
    }
  };

  const getInitials = (name?: string) => {
    if (!name) return '?';
    
    // Handle "Unknown User" case specifically
    if (name.startsWith('Unknown User')) {
      return '??';
    }
    
    return name
      .split(' ')
      .map(word => word.charAt(0))
      .join('')
      .toUpperCase()
      .slice(0, 2);
  };

  return (
    <Avatar
      className={cn(
        sizeClasses[size],
        (userId || onClick) && !disabled && 'cursor-pointer hover:ring-2 hover:ring-primary/20 transition-all',
        disabled && 'opacity-50 cursor-not-allowed',
        className
      )}
      onClick={handleClick}
    >
      {src && (
        <AvatarImage 
          src={src} 
          alt={alt || 'User avatar'} 
        />
      )}
      <AvatarFallback className="bg-primary/10 text-primary font-medium">
        {fallback || getInitials(alt)}
      </AvatarFallback>
    </Avatar>
  );
}

```

`shared/components/ui/collapsible.tsx`:

```tsx
"use client";

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />;
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  );
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  );
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent };

```

`shared/components/ui/command.tsx`:

```tsx
"use client";

import * as React from "react";
import { Command as CommandPrimitive } from "cmdk";
import { SearchIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "./dialog";

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className,
      )}
      {...props}
    />
  );
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string;
  description?: string;
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent className="overflow-hidden p-0">
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  );
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className,
        )}
        {...props}
      />
    </div>
  );
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className,
      )}
      {...props}
    />
  );
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  );
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className,
      )}
      {...props}
    />
  );
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  );
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
};

```

`shared/components/ui/context-menu.tsx`:

```tsx
"use client";

import * as React from "react";
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function ContextMenu({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Root>) {
  return <ContextMenuPrimitive.Root data-slot="context-menu" {...props} />;
}

function ContextMenuTrigger({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Trigger>) {
  return (
    <ContextMenuPrimitive.Trigger data-slot="context-menu-trigger" {...props} />
  );
}

function ContextMenuGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Group>) {
  return (
    <ContextMenuPrimitive.Group data-slot="context-menu-group" {...props} />
  );
}

function ContextMenuPortal({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Portal>) {
  return (
    <ContextMenuPrimitive.Portal data-slot="context-menu-portal" {...props} />
  );
}

function ContextMenuSub({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Sub>) {
  return <ContextMenuPrimitive.Sub data-slot="context-menu-sub" {...props} />;
}

function ContextMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioGroup>) {
  return (
    <ContextMenuPrimitive.RadioGroup
      data-slot="context-menu-radio-group"
      {...props}
    />
  );
}

function ContextMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <ContextMenuPrimitive.SubTrigger
      data-slot="context-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto" />
    </ContextMenuPrimitive.SubTrigger>
  );
}

function ContextMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubContent>) {
  return (
    <ContextMenuPrimitive.SubContent
      data-slot="context-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

function ContextMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Content>) {
  return (
    <ContextMenuPrimitive.Portal>
      <ContextMenuPrimitive.Content
        data-slot="context-menu-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-context-menu-content-available-height) min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </ContextMenuPrimitive.Portal>
  );
}

function ContextMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <ContextMenuPrimitive.Item
      data-slot="context-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function ContextMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.CheckboxItem>) {
  return (
    <ContextMenuPrimitive.CheckboxItem
      data-slot="context-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.CheckboxItem>
  );
}

function ContextMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioItem>) {
  return (
    <ContextMenuPrimitive.RadioItem
      data-slot="context-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.RadioItem>
  );
}

function ContextMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <ContextMenuPrimitive.Label
      data-slot="context-menu-label"
      data-inset={inset}
      className={cn(
        "text-foreground px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className,
      )}
      {...props}
    />
  );
}

function ContextMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Separator>) {
  return (
    <ContextMenuPrimitive.Separator
      data-slot="context-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function ContextMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="context-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
};

```

`shared/components/ui/dialog.tsx`:

```tsx
"use client";

import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { XIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />;
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />;
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />;
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />;
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className,
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  );
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className,
      )}
      {...props}
    />
  );
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  );
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
};

```

`shared/components/ui/drawer.tsx`:

```tsx
"use client";

import * as React from "react";
import { Drawer as DrawerPrimitive } from "vaul@1.1.2";

import { cn } from "@/shared/utils/utils";

function Drawer({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) {
  return <DrawerPrimitive.Root data-slot="drawer" {...props} />;
}

function DrawerTrigger({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Trigger>) {
  return <DrawerPrimitive.Trigger data-slot="drawer-trigger" {...props} />;
}

function DrawerPortal({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Portal>) {
  return <DrawerPrimitive.Portal data-slot="drawer-portal" {...props} />;
}

function DrawerClose({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Close>) {
  return <DrawerPrimitive.Close data-slot="drawer-close" {...props} />;
}

function DrawerOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Overlay>) {
  return (
    <DrawerPrimitive.Overlay
      data-slot="drawer-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function DrawerContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Content>) {
  return (
    <DrawerPortal data-slot="drawer-portal">
      <DrawerOverlay />
      <DrawerPrimitive.Content
        data-slot="drawer-content"
        className={cn(
          "group/drawer-content bg-background fixed z-50 flex h-auto flex-col",
          "data-[vaul-drawer-direction=top]:inset-x-0 data-[vaul-drawer-direction=top]:top-0 data-[vaul-drawer-direction=top]:mb-24 data-[vaul-drawer-direction=top]:max-h-[80vh] data-[vaul-drawer-direction=top]:rounded-b-lg data-[vaul-drawer-direction=top]:border-b",
          "data-[vaul-drawer-direction=bottom]:inset-x-0 data-[vaul-drawer-direction=bottom]:bottom-0 data-[vaul-drawer-direction=bottom]:mt-24 data-[vaul-drawer-direction=bottom]:max-h-[80vh] data-[vaul-drawer-direction=bottom]:rounded-t-lg data-[vaul-drawer-direction=bottom]:border-t",
          "data-[vaul-drawer-direction=right]:inset-y-0 data-[vaul-drawer-direction=right]:right-0 data-[vaul-drawer-direction=right]:w-3/4 data-[vaul-drawer-direction=right]:border-l data-[vaul-drawer-direction=right]:sm:max-w-sm",
          "data-[vaul-drawer-direction=left]:inset-y-0 data-[vaul-drawer-direction=left]:left-0 data-[vaul-drawer-direction=left]:w-3/4 data-[vaul-drawer-direction=left]:border-r data-[vaul-drawer-direction=left]:sm:max-w-sm",
          className,
        )}
        {...props}
      >
        <div className="bg-muted mx-auto mt-4 hidden h-2 w-[100px] shrink-0 rounded-full group-data-[vaul-drawer-direction=bottom]/drawer-content:block" />
        {children}
      </DrawerPrimitive.Content>
    </DrawerPortal>
  );
}

function DrawerHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="drawer-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  );
}

function DrawerFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="drawer-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  );
}

function DrawerTitle({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Title>) {
  return (
    <DrawerPrimitive.Title
      data-slot="drawer-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  );
}

function DrawerDescription({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Description>) {
  return (
    <DrawerPrimitive.Description
      data-slot="drawer-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
};

```

`shared/components/ui/dropdown-menu.tsx`:

```tsx
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />;
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  );
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  );
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "z-[99999] min-w-32 overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  );
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  );
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  );
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  );
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  );
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />;
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  );
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
};

```

`shared/components/ui/empty-state-enhanced.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Button } from '@/shared/components/ui/button';
import {
  Inbox,
  Search,
  Users,
  Calendar,
  Trophy,
  MessageSquare,
  AlertCircle,
  Plus,
  RefreshCw,
} from 'lucide-react';

export type EmptyStateVariant =
  | 'no-results'
  | 'no-data'
  | 'error'
  | 'onboarding'
  | 'success'
  | 'loading';

export interface EmptyStateAction {
  label: string;
  onClick: () => void;
  variant?: 'default' | 'outline' | 'ghost' | 'secondary';
  icon?: React.ReactNode;
}

export interface EmptyStateEnhancedProps
  extends React.HTMLAttributes<HTMLDivElement> {
  variant?: EmptyStateVariant;
  title: string;
  description?: string;
  icon?: React.ReactNode;
  illustration?: React.ReactNode;
  primaryAction?: EmptyStateAction;
  secondaryAction?: EmptyStateAction;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

const variantConfig: Record<
  EmptyStateVariant,
  {
    defaultIcon: React.ReactNode;
    defaultTitle?: string;
    defaultDescription?: string;
    colorClass?: string;
  }
> = {
  'no-results': {
    defaultIcon: <Search className="size-12 text-muted-foreground" />,
    defaultTitle: 'No results found',
    defaultDescription: 'Try adjusting your search or filters to find what you\'re looking for.',
    colorClass: 'text-muted-foreground',
  },
  'no-data': {
    defaultIcon: <Inbox className="size-12 text-muted-foreground" />,
    defaultTitle: 'No data available',
    defaultDescription: 'There\'s nothing here yet. Get started by creating your first item!',
    colorClass: 'text-muted-foreground',
  },
  error: {
    defaultIcon: <AlertCircle className="size-12 text-destructive" />,
    defaultTitle: 'Something went wrong',
    defaultDescription: 'We encountered an error. Please try again or contact support if the problem persists.',
    colorClass: 'text-destructive',
  },
  onboarding: {
    defaultIcon: <Plus className="size-12 text-primary" />,
    defaultTitle: 'Get started',
    defaultDescription: 'Welcome! Let\'s set up your profile and start exploring.',
    colorClass: 'text-primary',
  },
  success: {
    defaultIcon: <Trophy className="size-12 text-success" />,
    defaultTitle: 'All done!',
    defaultDescription: 'You\'ve completed everything. Great job!',
    colorClass: 'text-success',
  },
  loading: {
    defaultIcon: <RefreshCw className="size-12 text-muted-foreground animate-spin" />,
    defaultTitle: 'Loading...',
    defaultDescription: 'Please wait while we load your content.',
    colorClass: 'text-muted-foreground',
  },
};

const sizeClasses = {
  sm: {
    container: 'py-8 px-4',
    icon: 'size-10',
    title: 'text-base',
    description: 'text-sm',
    gap: 'gap-3',
  },
  md: {
    container: 'py-12 px-6',
    icon: 'size-16',
    title: 'text-lg',
    description: 'text-base',
    gap: 'gap-4',
  },
  lg: {
    container: 'py-16 px-8',
    icon: 'size-20',
    title: 'text-xl',
    description: 'text-lg',
    gap: 'gap-6',
  },
};

/**
 * Enhanced Empty State Component
 * 
 * A comprehensive empty state component with variants, illustrations, and multiple CTAs.
 * Based on Strava's empty state patterns.
 * 
 * @example
 * ```tsx
 * <EmptyStateEnhanced
 *   variant="no-results"
 *   title="No games found"
 *   description="Try adjusting your filters"
 *   primaryAction={{
 *     label: "Create Game",
 *     onClick: () => navigate('/create'),
 *     icon: <Plus />
 *   }}
 * />
 * ```
 */
export function EmptyStateEnhanced({
  variant = 'no-data',
  title,
  description,
  icon,
  illustration,
  primaryAction,
  secondaryAction,
  size = 'md',
  className,
  ...props
}: EmptyStateEnhancedProps) {
  const config = variantConfig[variant];
  const sizes = sizeClasses[size];

  const displayIcon = icon || illustration || config.defaultIcon;
  const displayTitle = title || config.defaultTitle || 'Empty';
  const displayDescription = description || config.defaultDescription;

  return (
    <div
      className={cn(
        'flex flex-col items-center justify-center text-center',
        sizes.container,
        sizes.gap,
        className
      )}
      {...props}
    >
      {/* Illustration or Icon */}
      {illustration ? (
        <div className="mb-2">{illustration}</div>
      ) : (
        <div
          className={cn(
            'flex items-center justify-center mb-2',
            sizes.icon,
            config.colorClass
          )}
        >
          {displayIcon}
        </div>
      )}

      {/* Title */}
      <h3 className={cn('font-semibold', sizes.title)}>{displayTitle}</h3>

      {/* Description */}
      {displayDescription && (
        <p className={cn('text-muted-foreground max-w-md', sizes.description)}>
          {displayDescription}
        </p>
      )}

      {/* Actions */}
      {(primaryAction || secondaryAction) && (
        <div className="flex flex-col sm:flex-row items-center gap-3 mt-2">
          {primaryAction && (
            <Button
              onClick={primaryAction.onClick}
              variant={primaryAction.variant || 'default'}
              size={size === 'sm' ? 'sm' : 'default'}
              className="w-full sm:w-auto"
            >
              {primaryAction.icon && (
                <span className="mr-2">{primaryAction.icon}</span>
              )}
              {primaryAction.label}
            </Button>
          )}

          {secondaryAction && (
            <Button
              onClick={secondaryAction.onClick}
              variant={secondaryAction.variant || 'outline'}
              size={size === 'sm' ? 'sm' : 'default'}
              className="w-full sm:w-auto"
            >
              {secondaryAction.icon && (
                <span className="mr-2">{secondaryAction.icon}</span>
              )}
              {secondaryAction.label}
            </Button>
          )}
        </div>
      )}
    </div>
  );
}

/**
 * Preset Empty States for Common Scenarios
 */

export function NoGamesFound({
  onCreateGame,
  onExplore,
}: {
  onCreateGame?: () => void;
  onExplore?: () => void;
}) {
  return (
    <EmptyStateEnhanced
      variant="no-results"
      title="No activities found"
      description="Be the first to create an activity in your area and start building your sports community!"
      illustration={<div className="text-6xl">üèÄ</div>}
      primaryAction={
        onCreateGame
          ? {
              label: 'Create Activity',
              onClick: onCreateGame,
              icon: <Plus className="size-4" />,
            }
          : undefined
      }
      secondaryAction={
        onExplore
          ? {
              label: 'Explore',
              onClick: onExplore,
              variant: 'outline',
            }
          : undefined
      }
    />
  );
}

export function NoPlayersFound({
  onInvite,
}: {
  onInvite?: () => void;
}) {
  return (
    <EmptyStateEnhanced
      variant="no-data"
      title="No players yet"
      description="Invite friends or wait for others to join this activity."
      icon={<Users className="size-12 text-muted-foreground" />}
      primaryAction={
        onInvite
          ? {
              label: 'Invite Players',
              onClick: onInvite,
              icon: <Users className="size-4" />,
            }
          : undefined
      }
    />
  );
}

export function NoUpcomingGames({
  onCreateGame,
}: {
  onCreateGame?: () => void;
}) {
  return (
    <EmptyStateEnhanced
      variant="no-data"
      title="No upcoming activities"
      description="Create an activity to get started, or check back later for new opportunities."
      icon={<Calendar className="size-12 text-muted-foreground" />}
      primaryAction={
        onCreateGame
          ? {
              label: 'Create Activity',
              onClick: onCreateGame,
              icon: <Plus className="size-4" />,
            }
          : undefined
      }
    />
  );
}

export function EmptyLeaderboard({
  onJoinGame,
}: {
  onJoinGame?: () => void;
}) {
  return (
    <EmptyStateEnhanced
      variant="onboarding"
      title="Leaderboard is empty"
      description="Join your first activity to start competing and climb the leaderboard!"
      icon={<Trophy className="size-12 text-primary" />}
      primaryAction={
        onJoinGame
          ? {
              label: 'Find Activities',
              onClick: onJoinGame,
            }
          : undefined
      }
    />
  );
}

export function ErrorState({
  onRetry,
  onContactSupport,
}: {
  onRetry?: () => void;
  onContactSupport?: () => void;
}) {
  return (
    <EmptyStateEnhanced
      variant="error"
      title="Something went wrong"
      description="We encountered an error. Please try again or contact support if the problem persists."
      primaryAction={
        onRetry
          ? {
              label: 'Try Again',
              onClick: onRetry,
              icon: <RefreshCw className="size-4" />,
            }
          : undefined
      }
      secondaryAction={
        onContactSupport
          ? {
              label: 'Contact Support',
              onClick: onContactSupport,
              variant: 'outline',
            }
          : undefined
      }
    />
  );
}

export function OnboardingWelcome({
  onGetStarted,
}: {
  onGetStarted?: () => void;
}) {
  return (
    <EmptyStateEnhanced
      variant="onboarding"
      title="Welcome to TribeUp!"
      description="Find your game, find your tribe. Let's get you set up and ready to play."
      illustration={<div className="text-6xl">üéâ</div>}
      primaryAction={
        onGetStarted
          ? {
              label: 'Get Started',
              onClick: onGetStarted,
            }
          : undefined
      }
      size="lg"
    />
  );
}


```

`shared/components/ui/empty-state.tsx`:

```tsx
import React from 'react';
// import { motion } from 'framer-motion'; // TEMPORARILY DISABLED
import { Button } from './button';
import { cn } from '@/shared/utils/utils';
import { Bell, MessageSquare, Calendar, CheckCircle } from 'lucide-react';

interface EmptyStateProps {
  icon?: React.ReactNode;
  title: string;
  description?: string;
  action?: {
    label: string;
    onClick: () => void;
    variant?: 'default' | 'outline' | 'ghost';
  };
  className?: string;
  size?: 'sm' | 'md' | 'lg';
}

export function EmptyState({
  icon,
  title,
  description,
  action,
  className,
  size = 'md'
}: EmptyStateProps) {
  const sizeClasses = {
    sm: 'py-8 px-4',
    md: 'py-12 px-6',
    lg: 'py-16 px-8'
  };

  const iconSizeClasses = {
    sm: 'w-12 h-12',
    md: 'w-16 h-16',
    lg: 'w-20 h-20'
  };

  return (
    <div
      className={cn(
        "flex flex-col items-center justify-center text-center",
        sizeClasses[size],
        className
      )}
    >
      {icon && (
        <div className={cn(
          "text-muted-foreground mb-4 flex items-center justify-center",
          iconSizeClasses[size]
        )}>
          {icon}
        </div>
      )}
      
      <h3 className="text-lg font-medium mb-2">{title}</h3>
      
      {description && (
        <p className="text-muted-foreground max-w-md mb-6">
          {description}
        </p>
      )}
      
      {action && (
        <Button 
          onClick={action.onClick}
          variant={action.variant || 'default'}
        >
          {action.label}
        </Button>
      )}
    </div>
  );
}

// Preset empty states for common scenarios
export function NoGamesFound({ onCreateGame }: { onCreateGame: () => void }) {
  return (
    <EmptyState
      icon={<div className="text-6xl">üèÄ</div>}
      title="No activities found"
      description="Be the first to create an activity in your area and start building your sports community!"
      action={{
        label: "Create Activity",
        onClick: onCreateGame
      }}
    />
  );
}

export function NoMessages() {
  return (
    <EmptyState
      icon={<div className="text-6xl">üí¨</div>}
      title="No messages yet"
      description="Start the conversation! Send your first message to get things going."
      size="sm"
    />
  );
}

export function NoFriends({ onExplore }: { onExplore: () => void }) {
  return (
    <EmptyState
      icon={<div className="text-6xl">üë•</div>}
      title="No friends yet"
      description="Connect with other players by joining activities and building your sports network."
      action={{
        label: "Explore Activities",
        onClick: onExplore,
        variant: "outline"
      }}
    />
  );
}

export function OfflineState({ onRetry }: { onRetry: () => void }) {
  return (
    <EmptyState
      icon={<div className="text-6xl">üì°</div>}
      title="No internet connection"
      description="Check your connection and try again. Some features may not be available offline."
      action={{
        label: "Try Again",
        onClick: onRetry,
        variant: "outline"
      }}
    />
  );
}

export function NoNotifications({ filter }: { filter: string }) {
  const getEmptyContent = () => {
    switch (filter) {
      case 'unread':
        return {
          title: 'All caught up!',
          description: 'You have no unread notifications. You\'re all up to date!',
          icon: <CheckCircle className="w-8 h-8" />
        };
      case 'messages':
        return {
          title: 'No message notifications',
          description: 'You haven\'t received any message notifications recently.',
          icon: <MessageSquare className="w-8 h-8" />
        };
      case 'games':
        return {
          title: 'No activity notifications',
          description: 'No activity updates, reminders, or join requests at the moment.',
          icon: <Calendar className="w-8 h-8" />
        };
      default:
        return {
          title: 'No notifications',
          description: 'When you receive notifications, they\'ll appear here. Stay tuned for updates!',
          icon: <Bell className="w-8 h-8" />
        };
    }
  };

  const content = getEmptyContent();

  return (
    <EmptyState
      icon={content.icon}
      title={content.title}
      description={content.description}
      size="md"
    />
  );
}
```

`shared/components/ui/facepile.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { ClickableAvatar } from '@/shared/components/ui/clickable-avatar';
import { cva, type VariantProps } from 'class-variance-authority';
import { Popover, PopoverContent, PopoverTrigger } from '@/shared/components/ui/popover';
import { ScrollArea } from '@/shared/components/ui/scroll-area';
import { Users } from 'lucide-react';

const facepileVariants = cva('flex items-center', {
  variants: {
    size: {
      sm: 'gap-1',
      md: 'gap-1.5',
      lg: 'gap-2',
    },
    maxVisible: {
      3: '',
      4: '',
      5: '',
    },
  },
  defaultVariants: {
    size: 'md',
    maxVisible: 5,
  },
});

const avatarSizeVariants = cva('border-2 border-background', {
  variants: {
    size: {
      sm: 'size-6',
      md: 'size-8',
      lg: 'size-10',
    },
  },
  defaultVariants: {
    size: 'md',
  },
});

const overflowBadgeVariants = cva(
  'flex items-center justify-center border-2 border-background rounded-full font-medium text-xs bg-muted text-muted-foreground',
  {
    variants: {
      size: {
        sm: 'size-6 text-[10px]',
        md: 'size-8 text-xs',
        lg: 'size-10 text-sm',
      },
    },
    defaultVariants: {
      size: 'md',
    },
  }
);

export interface FacepileUser {
  id?: string;
  name: string;
  image?: string | null;
  email?: string;
}

export interface FacepileProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof facepileVariants> {
  users: FacepileUser[];
  maxVisible?: 3 | 4 | 5;
  showCount?: boolean;
  onUserClick?: (user: FacepileUser) => void;
  enablePopover?: boolean;
  emptyMessage?: string;
  className?: string;
}

/**
 * Facepile Component - Strava-inspired overlapping avatar display
 * 
 * Displays a group of user avatars in an overlapping pattern with overflow indicator.
 * Supports click-to-expand functionality via popover.
 * 
 * @example
 * ```tsx
 * <Facepile
 *   users={[
 *     { id: '1', name: 'John Doe', image: '/avatar1.jpg' },
 *     { id: '2', name: 'Jane Smith', image: '/avatar2.jpg' },
 *   ]}
 *   maxVisible={5}
 *   onUserClick={(user) => navigate(`/users/${user.id}`)}
 * />
 * ```
 */
export const Facepile = React.forwardRef<HTMLDivElement, FacepileProps>(
  (
    {
      users,
      maxVisible = 5,
      size = 'md',
      showCount = true,
      onUserClick,
      enablePopover = true,
      emptyMessage = 'No users',
      className,
      ...props
    },
    ref
  ) => {
    const [isPopoverOpen, setIsPopoverOpen] = React.useState(false);

    // Handle empty state
    if (!users || users.length === 0) {
      return (
        <div
          ref={ref}
          className={cn('flex items-center gap-2 text-muted-foreground text-sm', className)}
          {...props}
        >
          <Users className={cn(avatarSizeVariants({ size }))} />
          <span>{emptyMessage}</span>
        </div>
      );
    }

    const visibleUsers = users.slice(0, maxVisible);
    const overflowCount = users.length - maxVisible;
    const hasOverflow = overflowCount > 0;

    const renderAvatar = (user: FacepileUser, index: number) => {
      const avatarElement = user.id ? (
        <ClickableAvatar
          userId={user.id}
          src={user.image || undefined}
          alt={user.name}
          size={size === 'sm' ? 'xs' : size === 'md' ? 'sm' : 'md'}
          className={cn(
            avatarSizeVariants({ size }),
            'hover:z-10 transition-all duration-200 hover:scale-110',
            index > 0 && '-ml-2'
          )}
          onClick={onUserClick ? () => onUserClick(user) : undefined}
        />
      ) : (
        <Avatar
          className={cn(
            avatarSizeVariants({ size }),
            'hover:z-10 transition-all duration-200 hover:scale-110',
            index > 0 && '-ml-2'
          )}
        >
          <AvatarImage src={user.image || undefined} alt={user.name} />
          <AvatarFallback className="bg-primary/10 text-primary text-xs">
            {user.name
              ?.split(' ')
              ?.map((word) => word[0])
              ?.join('')
              ?.toUpperCase() || '?'}
          </AvatarFallback>
        </Avatar>
      );

      return (
        <div
          key={user.id || user.email || index}
          className="relative"
          title={user.name}
        >
          {avatarElement}
        </div>
      );
    };

    const content = (
      <div
        ref={ref}
        className={cn(facepileVariants({ size, maxVisible }), className)}
        {...props}
      >
        {visibleUsers.map((user, index) => renderAvatar(user, index))}

        {hasOverflow && (
          <Popover open={isPopoverOpen} onOpenChange={setIsPopoverOpen}>
            <PopoverTrigger asChild>
              <button
                type="button"
                className={cn(
                  overflowBadgeVariants({ size }),
                  'hover:bg-muted-foreground/20 transition-colors duration-200 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2',
                  visibleUsers.length > 0 && '-ml-2'
                )}
                aria-label={`${overflowCount} more users`}
                onClick={(e) => {
                  e.stopPropagation();
                  if (!enablePopover) {
                    // If popover disabled, just show count
                    return;
                  }
                }}
              >
                +{overflowCount}
              </button>
            </PopoverTrigger>
            {enablePopover && (
              <PopoverContent
                className="w-64 p-0"
                align="start"
                side="bottom"
                sideOffset={8}
              >
                <div className="p-2">
                  <div className="px-2 py-1.5 text-sm font-medium text-muted-foreground">
                    All Participants ({users.length})
                  </div>
                  <ScrollArea className="h-[200px]">
                    <div className="space-y-1 p-2">
                      {users.map((user, index) => (
                        <div
                          key={user.id || user.email || index}
                          className={cn(
                            'flex items-center gap-3 rounded-md p-2 hover:bg-muted transition-colors cursor-pointer',
                            onUserClick && 'cursor-pointer'
                          )}
                          onClick={() => {
                            if (onUserClick) {
                              onUserClick(user);
                            }
                            setIsPopoverOpen(false);
                          }}
                        >
                          {user.id ? (
                            <ClickableAvatar
                              userId={user.id}
                              src={user.image || undefined}
                              alt={user.name}
                              size="sm"
                              onClick={onUserClick ? () => onUserClick(user) : undefined}
                            />
                          ) : (
                            <Avatar className="size-8">
                              <AvatarImage src={user.image || undefined} alt={user.name} />
                              <AvatarFallback className="bg-primary/10 text-primary text-xs">
                                {user.name
                                  ?.split(' ')
                                  ?.map((word) => word[0])
                                  ?.join('')
                                  ?.toUpperCase() || '?'}
                              </AvatarFallback>
                            </Avatar>
                          )}
                          <div className="flex-1 min-w-0">
                            <div className="text-sm font-medium truncate">{user.name}</div>
                            {user.email && (
                              <div className="text-xs text-muted-foreground truncate">
                                {user.email}
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </ScrollArea>
                </div>
              </PopoverContent>
            )}
          </Popover>
        )}
      </div>
    );

    // If showCount is true and there's overflow, show count text
    if (showCount && hasOverflow && !enablePopover) {
      return (
        <div className={cn('flex items-center gap-2', className)} {...props}>
          {content}
          <span className="text-sm text-muted-foreground">
            {overflowCount} more
          </span>
        </div>
      );
    }

    return content;
  }
);

Facepile.displayName = 'Facepile';

/**
 * Simple Facepile variant - just shows avatars without popover
 */
export const SimpleFacepile = React.forwardRef<
  HTMLDivElement,
  Omit<FacepileProps, 'enablePopover' | 'showCount'>
>((props, ref) => {
  return <Facepile {...props} enablePopover={false} showCount={false} ref={ref} />;
});

SimpleFacepile.displayName = 'SimpleFacepile';


```

`shared/components/ui/feed/FeedCard.tsx`:

```tsx
import * as React from 'react';
import { FeedItem, FeedItemProps } from './FeedItem';

export interface FeedCardProps extends FeedItemProps {
  variant?: 'default' | 'compact' | 'expanded';
}

/**
 * Feed Card Component
 * 
 * Card variant of FeedItem with different display styles.
 * 
 * @example
 * ```tsx
 * <FeedCard
 *   variant="compact"
 *   user={user}
 *   action="joined_game"
 *   timestamp={new Date()}
 * />
 * ```
 */
export function FeedCard({
  variant = 'default',
  className,
  ...props
}: FeedCardProps) {
  const variantClasses = {
    default: '',
    compact: 'p-3',
    expanded: 'p-6',
  }[variant];

  return (
    <FeedItem
      className={variantClasses}
      {...props}
    />
  );
}


```

`shared/components/ui/feed/FeedItem.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Button } from '@/shared/components/ui/button';
import { Badge } from '@/shared/components/ui/badge';
import { ClickableAvatar } from '@/shared/components/ui/clickable-avatar';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import {
  Heart,
  MessageCircle,
  Share2,
  ChevronDown,
  ChevronUp,
  MoreVertical,
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/shared/components/ui/dropdown-menu';
// Simple time ago function
function formatTimeAgo(date: Date | string): string {
  const now = new Date();
  const then = typeof date === 'string' ? new Date(date) : date;
  const diffMs = now.getTime() - then.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
  return then.toLocaleDateString();
}

export type FeedActionType =
  | 'joined_game'
  | 'created_game'
  | 'achieved_milestone'
  | 'completed_game'
  | 'invited_friend'
  | 'rated_game';

export interface FeedItemProps extends React.HTMLAttributes<HTMLDivElement> {
  user: {
    id?: string;
    name: string;
    avatar?: string | null;
    username?: string;
  };
  action: FeedActionType;
  timestamp: Date | string;
  content?: {
    title?: string;
    description?: string;
    image?: string;
    gameId?: string;
    gameTitle?: string;
  };
  likes?: number;
  comments?: number;
  isLiked?: boolean;
  isExpanded?: boolean;
  onLike?: () => void;
  onComment?: () => void;
  onShare?: () => void;
  onExpand?: () => void;
  onGameClick?: (gameId: string) => void;
  onUserClick?: (userId: string) => void;
}

const actionConfig: Record<
  FeedActionType,
  { label: string; icon: React.ReactNode; color: string }
> = {
  joined_game: {
    label: 'joined',
    icon: 'üëã',
    color: 'text-primary',
  },
  created_game: {
    label: 'created',
    icon: '‚ú®',
    color: 'text-primary',
  },
  achieved_milestone: {
    label: 'achieved',
    icon: 'üèÜ',
    color: 'text-warning',
  },
  completed_game: {
    label: 'completed',
    icon: '‚úÖ',
    color: 'text-success',
  },
  invited_friend: {
    label: 'invited',
    icon: 'üë•',
    color: 'text-primary',
  },
  rated_game: {
    label: 'rated',
    icon: '‚≠ê',
    color: 'text-warning',
  },
};

/**
 * Feed Item Component
 * 
 * Displays a single activity feed item with user info, action, content, and interactions.
 * 
 * @example
 * ```tsx
 * <FeedItem
 *   user={{ id: '1', name: 'John Doe', avatar: '/avatar.jpg' }}
 *   action="joined_game"
 *   timestamp={new Date()}
 *   content={{ gameTitle: 'Basketball Game', gameId: '123' }}
 *   likes={5}
 *   onLike={() => handleLike()}
 * />
 * ```
 */
export function FeedItem({
  user,
  action,
  timestamp,
  content,
  likes = 0,
  comments = 0,
  isLiked = false,
  isExpanded = false,
  onLike,
  onComment,
  onShare,
  onExpand,
  onGameClick,
  onUserClick,
  className,
  ...props
}: FeedItemProps) {
  const config = actionConfig[action];
  const timeAgo = formatTimeAgo(timestamp);

  const handleGameClick = () => {
    if (content?.gameId && onGameClick) {
      onGameClick(content.gameId);
    }
  };

  return (
    <Card
      className={cn(
        'hover:shadow-medium transition-all duration-200',
        className
      )}
      {...props}
    >
      <CardContent className="p-4">
        <div className="space-y-3">
          {/* Header */}
          <div className="flex items-start gap-3">
            {/* Avatar */}
            <div className="flex-shrink-0">
              {user.id ? (
                <ClickableAvatar
                  userId={user.id}
                  src={user.avatar || undefined}
                  alt={user.name}
                  size="md"
                  onClick={onUserClick ? () => onUserClick(user.id!) : undefined}
                />
              ) : (
                <Avatar className="size-10">
                  <AvatarImage src={user.avatar || undefined} alt={user.name} />
                  <AvatarFallback className="bg-primary/10 text-primary">
                    {user.name
                      ?.split(' ')
                      ?.map((word) => word[0])
                      ?.join('')
                      ?.toUpperCase() || '?'}
                </AvatarFallback>
                </Avatar>
              )}
            </div>

            {/* Content */}
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="font-semibold">{user.name}</span>
                <span className="text-muted-foreground">{config.label}</span>
                {content?.gameTitle && (
                  <button
                    type="button"
                    onClick={handleGameClick}
                    className="font-medium text-primary hover:underline"
                  >
                    {content.gameTitle}
                  </button>
                )}
                {content?.title && (
                  <span className="font-medium">{content.title}</span>
                )}
              </div>
              <p className="text-xs text-muted-foreground mt-1">{timeAgo}</p>

              {/* Description */}
              {content?.description && (
                <p className="text-sm text-muted-foreground mt-2">
                  {content.description}
                </p>
              )}

              {/* Image */}
              {content?.image && (
                <div className="mt-3 rounded-lg overflow-hidden">
                  <img
                    src={content.image}
                    alt={content.title || 'Feed image'}
                    className="w-full h-auto"
                  />
                </div>
              )}
            </div>

            {/* More Menu */}
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  className="flex-shrink-0"
                >
                  <MoreVertical className="size-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                {onShare && (
                  <DropdownMenuItem onClick={onShare}>Share</DropdownMenuItem>
                )}
                <DropdownMenuItem>Report</DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>

          {/* Actions */}
          <div className="flex items-center gap-4 pt-2 border-t border-border">
            {onLike && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={onLike}
                className={cn(isLiked && 'text-destructive')}
              >
                <Heart
                  className={cn('size-4 mr-1', isLiked && 'fill-current')}
                />
                {likes > 0 && <span>{likes}</span>}
              </Button>
            )}
            {onComment && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={onComment}
              >
                <MessageCircle className="size-4 mr-1" />
                {comments > 0 && <span>{comments}</span>}
              </Button>
            )}
            {onShare && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={onShare}
              >
                <Share2 className="size-4 mr-1" />
                Share
              </Button>
            )}
            {onExpand && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={onExpand}
                className="ml-auto"
              >
                {isExpanded ? (
                  <>
                    <ChevronUp className="size-4 mr-1" />
                    Less
                  </>
                ) : (
                  <>
                    <ChevronDown className="size-4 mr-1" />
                    More
                  </>
                )}
              </Button>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}


```

`shared/components/ui/form.tsx`:

```tsx
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { Slot } from "@radix-ui/react-slot";
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form";

import { cn } from "@/shared/utils/utils";
import { Label } from "./label";

const Form = FormProvider;

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue,
);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const itemContext = React.useContext(FormItemContext);
  const { getFieldState } = useFormContext();
  const formState = useFormState({ name: fieldContext.name });
  const fieldState = getFieldState(fieldContext.name, formState);

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>");
  }

  const { id } = itemContext;

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  };
};

type FormItemContextValue = {
  id: string;
};

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue,
);

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId();

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  );
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField();

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  );
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } =
    useFormField();

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  );
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField();

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField();
  const body = error ? String(error?.message ?? "") : props.children;

  if (!body) {
    return null;
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  );
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
};

```

`shared/components/ui/hover-card.tsx`:

```tsx
"use client";

import * as React from "react";
import * as HoverCardPrimitive from "@radix-ui/react-hover-card";

import { cn } from "@/shared/utils/utils";

function HoverCard({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Root>) {
  return <HoverCardPrimitive.Root data-slot="hover-card" {...props} />;
}

function HoverCardTrigger({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Trigger>) {
  return (
    <HoverCardPrimitive.Trigger data-slot="hover-card-trigger" {...props} />
  );
}

function HoverCardContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Content>) {
  return (
    <HoverCardPrimitive.Portal data-slot="hover-card-portal">
      <HoverCardPrimitive.Content
        data-slot="hover-card-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className,
        )}
        {...props}
      />
    </HoverCardPrimitive.Portal>
  );
}

export { HoverCard, HoverCardTrigger, HoverCardContent };

```

`shared/components/ui/input-otp.tsx`:

```tsx
"use client";

import * as React from "react";
import { OTPInput, OTPInputContext } from "input-otp";
import { MinusIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function InputOTP({
  className,
  containerClassName,
  ...props
}: React.ComponentProps<typeof OTPInput> & {
  containerClassName?: string;
}) {
  return (
    <OTPInput
      data-slot="input-otp"
      containerClassName={cn(
        "flex items-center gap-2 has-disabled:opacity-50",
        containerClassName,
      )}
      className={cn("disabled:cursor-not-allowed", className)}
      {...props}
    />
  );
}

function InputOTPGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="input-otp-group"
      className={cn("flex items-center gap-1", className)}
      {...props}
    />
  );
}

function InputOTPSlot({
  index,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  index: number;
}) {
  const inputOTPContext = React.useContext(OTPInputContext);
  const { char, hasFakeCaret, isActive } = inputOTPContext?.slots[index] ?? {};

  return (
    <div
      data-slot="input-otp-slot"
      data-active={isActive}
      className={cn(
        "data-[active=true]:border-ring data-[active=true]:ring-ring/50 data-[active=true]:aria-invalid:ring-destructive/20 dark:data-[active=true]:aria-invalid:ring-destructive/40 aria-invalid:border-destructive data-[active=true]:aria-invalid:border-destructive dark:bg-input/30 border-input relative flex h-9 w-9 items-center justify-center border-y border-r text-sm bg-input-background transition-all outline-none first:rounded-l-md first:border-l last:rounded-r-md data-[active=true]:z-10 data-[active=true]:ring-[3px]",
        className,
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink bg-foreground h-4 w-px duration-1000" />
        </div>
      )}
    </div>
  );
}

function InputOTPSeparator({ ...props }: React.ComponentProps<"div">) {
  return (
    <div data-slot="input-otp-separator" role="separator" {...props}>
      <MinusIcon />
    </div>
  );
}

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator };

```

`shared/components/ui/input.tsx`:

```tsx
import * as React from "react";

import { cn } from "@/shared/utils/utils";

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        ref={ref}
        data-slot="input"
        className={cn(
          "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
          "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
          className,
        )}
        {...props}
      />
    );
  }
);

Input.displayName = "Input";

export { Input };

```

`shared/components/ui/label.tsx`:

```tsx
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";

import { cn } from "@/shared/utils/utils";

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className,
      )}
      {...props}
    />
  );
}

export { Label };

```

`shared/components/ui/leaderboard/Leaderboard.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { ScrollArea } from '@/shared/components/ui/scroll-area';
import { LeaderboardRow, LeaderboardPlayer } from './LeaderboardRow';
import { LeaderboardHeader, LeaderboardColumn } from './LeaderboardHeader';
import { EmptyStateEnhanced } from '@/shared/components/ui/empty-state-enhanced';

export interface LeaderboardProps extends React.HTMLAttributes<HTMLDivElement> {
  players: LeaderboardPlayer[];
  columns?: LeaderboardColumn[];
  sortKey?: string;
  sortDirection?: 'asc' | 'desc';
  onSort?: (key: string) => void;
  onPlayerClick?: (player: LeaderboardPlayer) => void;
  showRankBadge?: boolean;
  showStats?: boolean;
  statKeys?: string[];
  highlightCurrentUser?: boolean;
  emptyMessage?: string;
  emptyDescription?: string;
  maxHeight?: string;
  currentUserId?: string;
}

/**
 * Leaderboard Component
 * 
 * Complete leaderboard display with sorting, pagination, and player interaction.
 * 
 * @example
 * ```tsx
 * <Leaderboard
 *   players={leaderboardData}
 *   columns={[
 *     { key: 'name', label: 'Player', sortable: false },
 *     { key: 'gamesPlayed', label: 'Games', sortable: true },
 *     { key: 'wins', label: 'Wins', sortable: true },
 *   ]}
 *   sortKey="wins"
 *   sortDirection="desc"
 *   onSort={(key) => handleSort(key)}
 *   onPlayerClick={(player) => navigate(`/user/${player.id}`)}
 * />
 * ```
 */
export function Leaderboard({
  players,
  columns = [
    { key: 'name', label: 'Player', sortable: false },
    { key: 'gamesPlayed', label: 'Games', sortable: true },
    { key: 'wins', label: 'Wins', sortable: true },
    { key: 'rating', label: 'Rating', sortable: true },
  ],
  sortKey,
  sortDirection,
  onSort,
  onPlayerClick,
  showRankBadge = true,
  showStats = true,
  statKeys = ['gamesPlayed', 'wins', 'rating'],
  highlightCurrentUser = true,
  emptyMessage = 'No players yet',
  emptyDescription = 'Be the first to join and start competing!',
  maxHeight = '600px',
  currentUserId,
  className,
  ...props
}: LeaderboardProps) {
  // Mark current user
  const playersWithCurrentUser = React.useMemo(() => {
    if (!currentUserId) return players;
    return players.map((player) => ({
      ...player,
      isCurrentUser: player.id === currentUserId,
    }));
  }, [players, currentUserId]);

  // Handle sorting
  const handleSort = (key: string) => {
    if (onSort) {
      onSort(key);
    }
  };

  if (players.length === 0) {
    return (
      <div className={cn('flex items-center justify-center py-12', className)} {...props}>
        <EmptyStateEnhanced
          title={emptyMessage}
          description={emptyDescription}
          icon={<div className="text-4xl">üèÜ</div>}
        />
      </div>
    );
  }

  return (
    <div className={cn('border border-border rounded-lg overflow-hidden', className)} {...props}>
      {/* Header */}
      <LeaderboardHeader
        columns={columns}
        sortKey={sortKey}
        sortDirection={sortDirection}
        onSort={handleSort}
        showRank={showRankBadge}
      />

      {/* Player List */}
      <ScrollArea style={{ maxHeight }}>
        <div className="divide-y divide-border">
          {playersWithCurrentUser.map((player) => (
            <LeaderboardRow
              key={player.id || player.name}
              player={player}
              showRankBadge={showRankBadge}
              showStats={showStats}
              statKeys={statKeys}
              highlightCurrentUser={highlightCurrentUser}
              onPlayerClick={onPlayerClick}
            />
          ))}
        </div>
      </ScrollArea>
    </div>
  );
}

/**
 * Simple Leaderboard - Minimal configuration
 */
export function SimpleLeaderboard({
  players,
  onPlayerClick,
  currentUserId,
  ...props
}: Omit<LeaderboardProps, 'columns' | 'sortKey' | 'sortDirection' | 'onSort'>) {
  return (
    <Leaderboard
      players={players}
      onPlayerClick={onPlayerClick}
      currentUserId={currentUserId}
      columns={[
        { key: 'name', label: 'Player', sortable: false },
        { key: 'gamesPlayed', label: 'Games', sortable: false },
        { key: 'wins', label: 'Wins', sortable: false },
      ]}
      showStats={false}
      {...props}
    />
  );
}


```

`shared/components/ui/leaderboard/LeaderboardHeader.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { ArrowUpDown, ArrowUp, ArrowDown } from 'lucide-react';
import { Button } from '@/shared/components/ui/button';

export interface LeaderboardColumn {
  key: string;
  label: string;
  sortable?: boolean;
  align?: 'left' | 'center' | 'right';
}

export interface LeaderboardHeaderProps extends React.HTMLAttributes<HTMLDivElement> {
  columns: LeaderboardColumn[];
  sortKey?: string;
  sortDirection?: 'asc' | 'desc';
  onSort?: (key: string) => void;
  showRank?: boolean;
}

/**
 * Leaderboard Header Component
 * 
 * Displays column headers for a leaderboard with sorting functionality.
 * 
 * @example
 * ```tsx
 * <LeaderboardHeader
 *   columns={[
 *     { key: 'name', label: 'Player', sortable: false },
 *     { key: 'gamesPlayed', label: 'Games', sortable: true },
 *     { key: 'wins', label: 'Wins', sortable: true },
 *   ]}
 *   sortKey="wins"
 *   sortDirection="desc"
 *   onSort={(key) => setSortKey(key)}
 * />
 * ```
 */
export function LeaderboardHeader({
  columns,
  sortKey,
  sortDirection,
  onSort,
  showRank = true,
  className,
  ...props
}: LeaderboardHeaderProps) {
  const handleSort = (key: string) => {
    if (onSort) {
      onSort(key);
    }
  };

  const getSortIcon = (columnKey: string) => {
    if (!sortKey || sortKey !== columnKey) {
      return <ArrowUpDown className="size-3 text-muted-foreground" />;
    }
    if (sortDirection === 'asc') {
      return <ArrowUp className="size-3 text-primary" />;
    }
    return <ArrowDown className="size-3 text-primary" />;
  };

  return (
    <div
      className={cn(
        'flex items-center gap-3 px-3 py-2 border-b border-border bg-muted/30',
        className
      )}
      {...props}
    >
      {/* Rank Column */}
      {showRank && (
        <div className="flex-shrink-0 w-10 flex items-center justify-center">
          <span className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">
            Rank
          </span>
        </div>
      )}

      {/* Avatar Column (spacer) */}
      <div className="flex-shrink-0 w-10" />

      {/* Dynamic Columns */}
      {columns.map((column) => (
        <div
          key={column.key}
          className={cn(
            'flex-1',
            column.align === 'center' && 'justify-center',
            column.align === 'right' && 'justify-end',
            'flex items-center gap-1'
          )}
        >
          {column.sortable && onSort ? (
            <Button
              type="button"
              variant="ghost"
              size="sm"
              className={cn(
                'h-auto p-0 font-semibold text-xs uppercase tracking-wider text-muted-foreground hover:text-foreground',
                sortKey === column.key && 'text-primary'
              )}
              onClick={() => handleSort(column.key)}
            >
              <span>{column.label}</span>
              {getSortIcon(column.key)}
            </Button>
          ) : (
            <span className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">
              {column.label}
            </span>
          )}
        </div>
      ))}
    </div>
  );
}


```

`shared/components/ui/leaderboard/LeaderboardRow.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Avatar, AvatarFallback, AvatarImage } from '@/shared/components/ui/avatar';
import { ClickableAvatar } from '@/shared/components/ui/clickable-avatar';
import { Badge } from '@/shared/components/ui/badge';
import { Trophy, Medal, Award } from 'lucide-react';

export interface LeaderboardPlayer {
  id?: string;
  name: string;
  avatar?: string | null;
  rank: number;
  stats: {
    gamesPlayed?: number;
    wins?: number;
    losses?: number;
    rating?: number;
    winRate?: number;
    [key: string]: number | string | undefined;
  };
  isCurrentUser?: boolean;
}

export interface LeaderboardRowProps extends React.HTMLAttributes<HTMLDivElement> {
  player: LeaderboardPlayer;
  showRankBadge?: boolean;
  showStats?: boolean;
  statKeys?: string[];
  highlightCurrentUser?: boolean;
  onPlayerClick?: (player: LeaderboardPlayer) => void;
}

/**
 * Leaderboard Row Component
 * 
 * Displays a single player entry in a leaderboard with rank, avatar, name, and stats.
 * 
 * @example
 * ```tsx
 * <LeaderboardRow
 *   player={{
 *     id: '1',
 *     name: 'John Doe',
 *     rank: 1,
 *     stats: { gamesPlayed: 50, wins: 35, rating: 4.8 }
 *   }}
 *   showRankBadge
 * />
 * ```
 */
export function LeaderboardRow({
  player,
  showRankBadge = true,
  showStats = true,
  statKeys = ['gamesPlayed', 'wins', 'rating'],
  highlightCurrentUser = true,
  onPlayerClick,
  className,
  ...props
}: LeaderboardRowProps) {
  const getRankIcon = (rank: number) => {
    if (rank === 1) {
      return <Trophy className="size-5 text-yellow-500 fill-current" />;
    }
    if (rank === 2) {
      return <Medal className="size-5 text-gray-400 fill-current" />;
    }
    if (rank === 3) {
      return <Award className="size-5 text-amber-600 fill-current" />;
    }
    return null;
  };

  const getRankBadgeColor = (rank: number) => {
    if (rank === 1) return 'bg-yellow-500 text-white';
    if (rank === 2) return 'bg-gray-400 text-white';
    if (rank === 3) return 'bg-amber-600 text-white';
    return 'bg-muted text-muted-foreground';
  };

  const formatStatValue = (key: string, value: number | string | undefined): string => {
    if (value === undefined || value === null) return '‚Äî';
    
    if (key === 'rating' || key === 'winRate') {
      return typeof value === 'number' ? value.toFixed(1) : value.toString();
    }
    
    return value.toString();
  };

  const getStatLabel = (key: string): string => {
    const labels: Record<string, string> = {
      gamesPlayed: 'Games',
      wins: 'Wins',
      losses: 'Losses',
      rating: 'Rating',
      winRate: 'Win Rate',
    };
    return labels[key] || key;
  };

  const handleClick = () => {
    if (onPlayerClick) {
      onPlayerClick(player);
    }
  };

  return (
    <div
      className={cn(
        'flex items-center gap-3 p-3 rounded-lg transition-colors',
        'hover:bg-muted/50',
        highlightCurrentUser && player.isCurrentUser && 'bg-primary/5 border border-primary/20',
        onPlayerClick && 'cursor-pointer',
        className
      )}
      onClick={handleClick}
      {...props}
    >
      {/* Rank Badge */}
      {showRankBadge && (
        <div className="flex-shrink-0 w-10 flex items-center justify-center">
          {getRankIcon(player.rank) || (
            <div
              className={cn(
                'size-8 rounded-full flex items-center justify-center font-bold text-sm',
                getRankBadgeColor(player.rank)
              )}
            >
              {player.rank}
            </div>
          )}
        </div>
      )}

      {/* Avatar */}
      <div className="flex-shrink-0">
        {player.id ? (
          <ClickableAvatar
            userId={player.id}
            src={player.avatar || undefined}
            alt={player.name}
            size="md"
            onClick={onPlayerClick ? () => handleClick() : undefined}
          />
        ) : (
          <Avatar className="size-10">
            <AvatarImage src={player.avatar || undefined} alt={player.name} />
            <AvatarFallback className="bg-primary/10 text-primary text-xs">
              {player.name
                ?.split(' ')
                ?.map((word) => word[0])
                ?.join('')
                ?.toUpperCase() || '?'}
          </AvatarFallback>
          </Avatar>
        )}
      </div>

      {/* Player Info */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <span
            className={cn(
              'font-semibold truncate',
              highlightCurrentUser && player.isCurrentUser && 'text-primary'
            )}
          >
            {player.name}
          </span>
          {highlightCurrentUser && player.isCurrentUser && (
            <Badge variant="secondary" className="text-xs">
              You
            </Badge>
          )}
        </div>

        {/* Stats */}
        {showStats && player.stats && (
          <div className="flex items-center gap-3 mt-1 text-xs text-muted-foreground">
            {statKeys.map((key) => {
              const value = player.stats[key];
              if (value === undefined) return null;
              return (
                <span key={key}>
                  <span className="font-medium">{getStatLabel(key)}:</span>{' '}
                  {formatStatValue(key, value)}
                </span>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}


```

`shared/components/ui/loading-skeleton.tsx`:

```tsx
import React from 'react';
// import { motion } from 'framer-motion'; // TEMPORARILY DISABLED
import { cn } from '@/shared/utils/utils';

interface LoadingSkeletonProps {
  className?: string;
  variant?: 'default' | 'circular' | 'rectangular' | 'text';
  animation?: 'pulse' | 'wave' | 'none';
  width?: string | number;
  height?: string | number;
}

export function LoadingSkeleton({ 
  className, 
  variant = 'default',
  animation = 'pulse',
  width,
  height
}: LoadingSkeletonProps) {
  const baseClasses = "bg-muted animate-pulse";
  
  const variantClasses = {
    default: "rounded-md",
    circular: "rounded-full",
    rectangular: "rounded-none",
    text: "rounded-sm h-4"
  };

  const animationClasses = {
    pulse: "animate-pulse",
    wave: "loading",
    none: ""
  };

  const style = {
    width: width || undefined,
    height: height || undefined
  };

  return (
    <div 
      className={cn(
        baseClasses,
        variantClasses[variant],
        animationClasses[animation],
        className
      )}
      style={style}
      aria-label="Loading..."
      role="status"
    />
  );
}

// Preset skeletons for common components
export function GameCardSkeleton() {
  return (
    <div className="bg-card border border-border rounded-lg p-4 space-y-4">
      <div className="flex items-center justify-between">
        <LoadingSkeleton className="h-6 w-24" />
        <LoadingSkeleton variant="circular" className="h-8 w-8" />
      </div>
      
      <div className="space-y-2">
        <LoadingSkeleton className="h-4 w-3/4" />
        <LoadingSkeleton className="h-4 w-1/2" />
      </div>
      
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <LoadingSkeleton variant="circular" className="h-6 w-6" />
          <LoadingSkeleton className="h-4 w-16" />
        </div>
        <LoadingSkeleton className="h-8 w-20" />
      </div>
    </div>
  );
}

export function ChatMessageSkeleton({ isOwn = false }: { isOwn?: boolean }) {
  return (
    <div className={`flex gap-3 ${isOwn ? 'justify-end' : 'justify-start'}`}>
      {!isOwn && <LoadingSkeleton variant="circular" className="h-8 w-8" />}
      <div className={`max-w-xs ${isOwn ? 'order-first' : ''}`}>
        {!isOwn && <LoadingSkeleton className="h-3 w-16 mb-1" />}
        <LoadingSkeleton className={`h-10 ${isOwn ? 'w-32' : 'w-40'} rounded-2xl`} />
      </div>
    </div>
  );
}

export function UserProfileSkeleton() {
  return (
    <div className="space-y-6 p-4">
      {/* Header */}
      <div className="flex flex-col items-center text-center space-y-4">
        <LoadingSkeleton variant="circular" className="h-24 w-24" />
        <div className="space-y-2">
          <LoadingSkeleton className="h-6 w-32" />
          <LoadingSkeleton className="h-4 w-24" />
        </div>
        <LoadingSkeleton className="h-4 w-64" />
        <div className="flex items-center gap-4">
          <LoadingSkeleton className="h-8 w-12" />
          <LoadingSkeleton className="h-8 w-12" />
          <LoadingSkeleton className="h-8 w-12" />
        </div>
        <LoadingSkeleton className="h-10 w-48 rounded-full" />
      </div>
      
      {/* Cards */}
      {Array.from({ length: 3 }).map((_, i) => (
        <div key={i} className="bg-card border border-border rounded-lg p-4 space-y-3">
          <LoadingSkeleton className="h-5 w-24" />
          <div className="space-y-2">
            <LoadingSkeleton className="h-4 w-full" />
            <LoadingSkeleton className="h-4 w-3/4" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

`shared/components/ui/loading-spinner.tsx`:

```tsx
import React from 'react';
import { Loader2 } from 'lucide-react';

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
  text?: string;
}

export function LoadingSpinner({ size = 'md', className = '', text }: LoadingSpinnerProps) {
  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-6 h-6',
    lg: 'w-8 h-8',
  };

  return (
    <div className={`flex flex-col items-center justify-center gap-3 ${className}`}>
      <div className="animate-spin">
        <Loader2 className={`${sizeClasses[size]} text-primary`} />
      </div>

      {text && (
        <p className="text-sm text-muted-foreground">
          {text}
        </p>
      )}
    </div>
  );
}

export function PulseLoader({ className = '' }: { className?: string }) {
  return (
    <div className={`flex space-x-1 ${className}`}>
      {[0, 1, 2].map((index) => (
        <div
          key={index}
          className="w-2 h-2 bg-primary rounded-full animate-pulse"
          style={{
            animationDelay: `${index * 0.2}s`,
          }}
        />
      ))}
    </div>
  );
}
```

`shared/components/ui/menubar.tsx`:

```tsx
"use client";

import * as React from "react";
import * as MenubarPrimitive from "@radix-ui/react-menubar";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Menubar({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Root>) {
  return (
    <MenubarPrimitive.Root
      data-slot="menubar"
      className={cn(
        "bg-background flex h-9 items-center gap-1 rounded-md border p-1 shadow-xs",
        className,
      )}
      {...props}
    />
  );
}

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu data-slot="menubar-menu" {...props} />;
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group data-slot="menubar-group" {...props} />;
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal data-slot="menubar-portal" {...props} />;
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return (
    <MenubarPrimitive.RadioGroup data-slot="menubar-radio-group" {...props} />
  );
}

function MenubarTrigger({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Trigger>) {
  return (
    <MenubarPrimitive.Trigger
      data-slot="menubar-trigger"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex items-center rounded-sm px-2 py-1 text-sm font-medium outline-hidden select-none",
        className,
      )}
      {...props}
    />
  );
}

function MenubarContent({
  className,
  align = "start",
  alignOffset = -4,
  sideOffset = 8,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Content>) {
  return (
    <MenubarPortal>
      <MenubarPrimitive.Content
        data-slot="menubar-content"
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[12rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </MenubarPortal>
  );
}

function MenubarItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <MenubarPrimitive.Item
      data-slot="menubar-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function MenubarCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.CheckboxItem>) {
  return (
    <MenubarPrimitive.CheckboxItem
      data-slot="menubar-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.CheckboxItem>
  );
}

function MenubarRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioItem>) {
  return (
    <MenubarPrimitive.RadioItem
      data-slot="menubar-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.RadioItem>
  );
}

function MenubarLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <MenubarPrimitive.Label
      data-slot="menubar-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className,
      )}
      {...props}
    />
  );
}

function MenubarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Separator>) {
  return (
    <MenubarPrimitive.Separator
      data-slot="menubar-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function MenubarShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="menubar-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />;
}

function MenubarSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <MenubarPrimitive.SubTrigger
      data-slot="menubar-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-none select-none data-[inset]:pl-8",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto h-4 w-4" />
    </MenubarPrimitive.SubTrigger>
  );
}

function MenubarSubContent({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubContent>) {
  return (
    <MenubarPrimitive.SubContent
      data-slot="menubar-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

export {
  Menubar,
  MenubarPortal,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarGroup,
  MenubarSeparator,
  MenubarLabel,
  MenubarItem,
  MenubarShortcut,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarSub,
  MenubarSubTrigger,
  MenubarSubContent,
};

```

`shared/components/ui/navigation-menu.tsx`:

```tsx
import * as React from "react";
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu";
import { cva } from "class-variance-authority";
import { ChevronDownIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function NavigationMenu({
  className,
  children,
  viewport = true,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Root> & {
  viewport?: boolean;
}) {
  return (
    <NavigationMenuPrimitive.Root
      data-slot="navigation-menu"
      data-viewport={viewport}
      className={cn(
        "group/navigation-menu relative flex max-w-max flex-1 items-center justify-center",
        className,
      )}
      {...props}
    >
      {children}
      {viewport && <NavigationMenuViewport />}
    </NavigationMenuPrimitive.Root>
  );
}

function NavigationMenuList({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.List>) {
  return (
    <NavigationMenuPrimitive.List
      data-slot="navigation-menu-list"
      className={cn(
        "group flex flex-1 list-none items-center justify-center gap-1",
        className,
      )}
      {...props}
    />
  );
}

function NavigationMenuItem({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Item>) {
  return (
    <NavigationMenuPrimitive.Item
      data-slot="navigation-menu-item"
      className={cn("relative", className)}
      {...props}
    />
  );
}

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=open]:hover:bg-accent data-[state=open]:text-accent-foreground data-[state=open]:focus:bg-accent data-[state=open]:bg-accent/50 focus-visible:ring-ring/50 outline-none transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1",
);

function NavigationMenuTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Trigger>) {
  return (
    <NavigationMenuPrimitive.Trigger
      data-slot="navigation-menu-trigger"
      className={cn(navigationMenuTriggerStyle(), "group", className)}
      {...props}
    >
      {children}{" "}
      <ChevronDownIcon
        className="relative top-[1px] ml-1 size-3 transition duration-300 group-data-[state=open]:rotate-180"
        aria-hidden="true"
      />
    </NavigationMenuPrimitive.Trigger>
  );
}

function NavigationMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Content>) {
  return (
    <NavigationMenuPrimitive.Content
      data-slot="navigation-menu-content"
      className={cn(
        "data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 top-0 left-0 w-full p-2 pr-2.5 md:absolute md:w-auto",
        "group-data-[viewport=false]/navigation-menu:bg-popover group-data-[viewport=false]/navigation-menu:text-popover-foreground group-data-[viewport=false]/navigation-menu:data-[state=open]:animate-in group-data-[viewport=false]/navigation-menu:data-[state=closed]:animate-out group-data-[viewport=false]/navigation-menu:data-[state=closed]:zoom-out-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:zoom-in-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:fade-in-0 group-data-[viewport=false]/navigation-menu:data-[state=closed]:fade-out-0 group-data-[viewport=false]/navigation-menu:top-full group-data-[viewport=false]/navigation-menu:mt-1.5 group-data-[viewport=false]/navigation-menu:overflow-hidden group-data-[viewport=false]/navigation-menu:rounded-md group-data-[viewport=false]/navigation-menu:border group-data-[viewport=false]/navigation-menu:shadow group-data-[viewport=false]/navigation-menu:duration-200 **:data-[slot=navigation-menu-link]:focus:ring-0 **:data-[slot=navigation-menu-link]:focus:outline-none",
        className,
      )}
      {...props}
    />
  );
}

function NavigationMenuViewport({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Viewport>) {
  return (
    <div
      className={cn(
        "absolute top-full left-0 isolate z-50 flex justify-center",
      )}
    >
      <NavigationMenuPrimitive.Viewport
        data-slot="navigation-menu-viewport"
        className={cn(
          "origin-top-center bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border shadow md:w-[var(--radix-navigation-menu-viewport-width)]",
          className,
        )}
        {...props}
      />
    </div>
  );
}

function NavigationMenuLink({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Link>) {
  return (
    <NavigationMenuPrimitive.Link
      data-slot="navigation-menu-link"
      className={cn(
        "data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus-visible:ring-ring/50 [&_svg:not([class*='text-'])]:text-muted-foreground flex flex-col gap-1 rounded-sm p-2 text-sm transition-all outline-none focus-visible:ring-[3px] focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function NavigationMenuIndicator({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Indicator>) {
  return (
    <NavigationMenuPrimitive.Indicator
      data-slot="navigation-menu-indicator"
      className={cn(
        "data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden",
        className,
      )}
      {...props}
    >
      <div className="bg-border relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm shadow-md" />
    </NavigationMenuPrimitive.Indicator>
  );
}

export {
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
  navigationMenuTriggerStyle,
};

```

`shared/components/ui/pagination.tsx`:

```tsx
import * as React from "react";
import {
  ChevronLeftIcon,
  ChevronRightIcon,
  MoreHorizontalIcon,
} from "lucide-react";

import { cn } from "@/shared/utils/utils";
import { Button, buttonVariants } from "./button";

function Pagination({ className, ...props }: React.ComponentProps<"nav">) {
  return (
    <nav
      role="navigation"
      aria-label="pagination"
      data-slot="pagination"
      className={cn("mx-auto flex w-full justify-center", className)}
      {...props}
    />
  );
}

function PaginationContent({
  className,
  ...props
}: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="pagination-content"
      className={cn("flex flex-row items-center gap-1", className)}
      {...props}
    />
  );
}

function PaginationItem({ ...props }: React.ComponentProps<"li">) {
  return <li data-slot="pagination-item" {...props} />;
}

type PaginationLinkProps = {
  isActive?: boolean;
} & Pick<React.ComponentProps<typeof Button>, "size"> &
  React.ComponentProps<"a">;

function PaginationLink({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) {
  return (
    <a
      aria-current={isActive ? "page" : undefined}
      data-slot="pagination-link"
      data-active={isActive}
      className={cn(
        buttonVariants({
          variant: isActive ? "outline" : "ghost",
          size,
        }),
        className,
      )}
      {...props}
    />
  );
}

function PaginationPrevious({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to previous page"
      size="default"
      className={cn("gap-1 px-2.5 sm:pl-2.5", className)}
      {...props}
    >
      <ChevronLeftIcon />
      <span className="hidden sm:block">Previous</span>
    </PaginationLink>
  );
}

function PaginationNext({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to next page"
      size="default"
      className={cn("gap-1 px-2.5 sm:pr-2.5", className)}
      {...props}
    >
      <span className="hidden sm:block">Next</span>
      <ChevronRightIcon />
    </PaginationLink>
  );
}

function PaginationEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      aria-hidden
      data-slot="pagination-ellipsis"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontalIcon className="size-4" />
      <span className="sr-only">More pages</span>
    </span>
  );
}

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
};

```

`shared/components/ui/popover.tsx`:

```tsx
"use client";

import * as React from "react";
import * as PopoverPrimitive from "@radix-ui/react-popover";

import { cn } from "@/shared/utils/utils";

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />;
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />;
}

function PopoverContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className,
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  );
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />;
}

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };

```

`shared/components/ui/progress.tsx`:

```tsx
"use client";

import * as React from "react";
import * as ProgressPrimitive from "@radix-ui/react-progress";

import { cn } from "@/shared/utils/utils";

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className,
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  );
}

export { Progress };

```

`shared/components/ui/pull-to-refresh.tsx`:

```tsx
import React, { useState, useRef, useCallback } from 'react';
import { RefreshCw } from 'lucide-react';

interface PullToRefreshProps {
  onRefresh: () => Promise<void>;
  children: React.ReactNode;
  threshold?: number;
  disabled?: boolean;
}

export function PullToRefresh({ 
  onRefresh, 
  children, 
  threshold = 80,
  disabled = false 
}: PullToRefreshProps) {
  const [isPulling, setIsPulling] = useState(false);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [pullDistance, setPullDistance] = useState(0);
  const startYRef = useRef<number | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  const handleTouchStart = useCallback((e: React.TouchEvent) => {
    if (disabled || isRefreshing) return;
    
    const container = containerRef.current;
    if (!container || container.scrollTop > 0) return;
    
    startYRef.current = e.touches[0].clientY;
  }, [disabled, isRefreshing]);

  const handleTouchMove = useCallback((e: React.TouchEvent) => {
    if (disabled || isRefreshing || startYRef.current === null) return;
    
    const container = containerRef.current;
    if (!container || container.scrollTop > 0) return;
    
    const currentY = e.touches[0].clientY;
    const diff = currentY - startYRef.current;
    
    if (diff > 0) {
      e.preventDefault();
      const distance = Math.min(diff * 0.5, threshold * 1.5);
      setPullDistance(distance);
      setIsPulling(distance > threshold);
    }
  }, [disabled, isRefreshing, threshold]);

  const handleTouchEnd = useCallback(async () => {
    if (disabled || isRefreshing) return;
    
    if (isPulling && pullDistance > threshold) {
      setIsRefreshing(true);
      try {
        await onRefresh();
      } catch (error) {
        console.error('Refresh failed:', error);
      } finally {
        setIsRefreshing(false);
      }
    }
    
    startYRef.current = null;
    setPullDistance(0);
    setIsPulling(false);
  }, [disabled, isRefreshing, isPulling, pullDistance, threshold, onRefresh]);

  const refreshProgress = Math.min(pullDistance / threshold, 1);
  const shouldShowIndicator = pullDistance > 10 || isRefreshing;

  return (
    <div 
      ref={containerRef}
      className="relative overflow-hidden h-full"
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
    >
      {/* Pull indicator */}
      <div
        className="absolute top-0 left-0 right-0 z-10 flex items-center justify-center bg-background/95 backdrop-blur-sm border-b border-border transition-all duration-200"
        style={{
          transform: `translateY(${shouldShowIndicator ? pullDistance - 60 : -60}px)`,
          opacity: shouldShowIndicator ? 1 : 0
        }}
      >
        <div className="flex items-center gap-3 py-4">
          <div
            className="transition-all duration-200"
            style={{
              transform: `rotate(${isRefreshing ? 360 : refreshProgress * 360}deg) scale(${isRefreshing ? 1 : Math.max(0.5, refreshProgress)})`
            }}
          >
            <RefreshCw className={`w-5 h-5 ${isPulling || isRefreshing ? 'text-primary' : 'text-muted-foreground'}`} />
          </div>
          <span className="text-sm text-muted-foreground">
            {isRefreshing ? 'Refreshing...' : isPulling ? 'Release to refresh' : 'Pull to refresh'}
          </span>
        </div>
      </div>

      {/* Content */}
      <div
        className="h-full transition-transform duration-200"
        style={{
          transform: `translateY(${pullDistance}px)`
        }}
      >
        {children}
      </div>
    </div>
  );
}
```

`shared/components/ui/radio-group.tsx`:

```tsx
"use client";

import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group";
import { CircleIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function RadioGroup({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Root>) {
  return (
    <RadioGroupPrimitive.Root
      data-slot="radio-group"
      className={cn("grid gap-3", className)}
      {...props}
    />
  );
}

function RadioGroupItem({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Item>) {
  return (
    <RadioGroupPrimitive.Item
      data-slot="radio-group-item"
      className={cn(
        "border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator
        data-slot="radio-group-indicator"
        className="relative flex items-center justify-center"
      >
        <CircleIcon className="fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  );
}

export { RadioGroup, RadioGroupItem };

```

`shared/components/ui/resizable.tsx`:

```tsx
"use client";

import * as React from "react";
import { GripVerticalIcon } from "lucide-react";
import * as ResizablePrimitive from "react-resizable-panels";

import { cn } from "@/shared/utils/utils";

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className,
      )}
      {...props}
    />
  );
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />;
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean;
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        "bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
        className,
      )}
      {...props}
    >
      {withHandle && (
        <div className="bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border">
          <GripVerticalIcon className="size-2.5" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  );
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle };

```

`shared/components/ui/scroll-area.tsx`:

```tsx
"use client";

import * as React from "react";
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area";

import { cn } from "@/shared/utils/utils";

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  );
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className,
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  );
}

export { ScrollArea, ScrollBar };

```

`shared/components/ui/select.tsx`:

```tsx
"use client";

import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import {
  CheckIcon,
  ChevronDownIcon,
  ChevronUpIcon,
} from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />;
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />;
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />;
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default";
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-full items-center justify-between gap-2 rounded-md border bg-input-background px-3 py-2 text-sm whitespace-nowrap transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  );
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className,
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1",
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  );
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  );
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className,
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  );
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className,
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  );
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className,
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  );
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
};

```

`shared/components/ui/separator.tsx`:

```tsx
"use client";

import * as React from "react";
import * as SeparatorPrimitive from "@radix-ui/react-separator";

import { cn } from "@/shared/utils/utils";

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className,
      )}
      {...props}
    />
  );
}

export { Separator };

```

`shared/components/ui/sheet.tsx`:

```tsx
"use client";

import * as React from "react";
import * as SheetPrimitive from "@radix-ui/react-dialog";
import { XIcon } from "lucide-react";

import { cn } from "@/shared/utils/utils";

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />;
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />;
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />;
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />;
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function SheetContent({
  className,
  children,
  side = "right",
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left";
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className,
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  );
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  );
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  );
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  );
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
};

```

`shared/components/ui/sidebar.tsx`:

```tsx
"use client";

import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { VariantProps, cva } from "class-variance-authority";
import { PanelLeftIcon } from "lucide-react";

import { useIsMobile } from "./use-mobile";
import { cn } from "@/shared/utils/utils";
import { Button } from "./button";
import { Input } from "./input";
import { Separator } from "./separator";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "./sheet";
import { Skeleton } from "./skeleton";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "./tooltip";

const SIDEBAR_COOKIE_NAME = "sidebar_state";
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7;
const SIDEBAR_WIDTH = "16rem";
const SIDEBAR_WIDTH_MOBILE = "18rem";
const SIDEBAR_WIDTH_ICON = "3rem";
const SIDEBAR_KEYBOARD_SHORTCUT = "b";

type SidebarContextProps = {
  state: "expanded" | "collapsed";
  open: boolean;
  setOpen: (open: boolean) => void;
  openMobile: boolean;
  setOpenMobile: (open: boolean) => void;
  isMobile: boolean;
  toggleSidebar: () => void;
};

const SidebarContext = React.createContext<SidebarContextProps | null>(null);

function useSidebar() {
  const context = React.useContext(SidebarContext);
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.");
  }

  return context;
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  defaultOpen?: boolean;
  open?: boolean;
  onOpenChange?: (open: boolean) => void;
}) {
  const isMobile = useIsMobile();
  const [openMobile, setOpenMobile] = React.useState(false);

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen);
  const open = openProp ?? _open;
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value;
      if (setOpenProp) {
        setOpenProp(openState);
      } else {
        _setOpen(openState);
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`;
    },
    [setOpenProp, open],
  );

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open);
  }, [isMobile, setOpen, setOpenMobile]);

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault();
        toggleSidebar();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [toggleSidebar]);

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed";

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],
  );

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            "group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",
            className,
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  );
}

function Sidebar({
  side = "left",
  variant = "sidebar",
  collapsible = "offcanvas",
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  side?: "left" | "right";
  variant?: "sidebar" | "floating" | "inset";
  collapsible?: "offcanvas" | "icon" | "none";
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar();

  if (collapsible === "none") {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          "bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col",
          className,
        )}
        {...props}
      >
        {children}
      </div>
    );
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    );
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          "relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon)",
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className,
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  );
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar();

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn("size-7", className)}
      onClick={(event) => {
        onClick?.(event);
        toggleSidebar();
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  );
}

function SidebarRail({ className, ...props }: React.ComponentProps<"button">) {
  const { toggleSidebar } = useSidebar();

  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex",
        "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className,
      )}
      {...props}
    />
  );
}

function SidebarInset({ className, ...props }: React.ComponentProps<"main">) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        "bg-background relative flex w-full flex-1 flex-col",
        "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2",
        className,
      )}
      {...props}
    />
  );
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn("bg-background h-8 w-full shadow-none", className)}
      {...props}
    />
  );
}

function SidebarHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  );
}

function SidebarFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  );
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn("bg-sidebar-border mx-2 w-auto", className)}
      {...props}
    />
  );
}

function SidebarContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  );
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div";

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        "text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className,
      )}
      {...props}
    />
  );
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn("w-full text-sm", className)}
      {...props}
    />
  );
}

function SidebarMenu({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn("flex w-full min-w-0 flex-col gap-1", className)}
      {...props}
    />
  );
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn("group/menu-item relative", className)}
      {...props}
    />
  );
}

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:p-0!",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = "default",
  size = "default",
  tooltip,
  className,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean;
  isActive?: boolean;
  tooltip?: string | React.ComponentProps<typeof TooltipContent>;
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : "button";
  const { isMobile, state } = useSidebar();

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  );

  if (!tooltip) {
    return button;
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    };
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== "collapsed" || isMobile}
        {...tooltip}
      />
    </Tooltip>
  );
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean;
  showOnHover?: boolean;
}) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0",
        className,
      )}
      {...props}
    />
  );
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        "text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<"div"> & {
  showIcon?: boolean;
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`;
  }, []);

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-(--skeleton-width) flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  );
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        "border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn("group/menu-sub-item relative", className)}
      {...props}
    />
  );
}

function SidebarMenuSubButton({
  asChild = false,
  size = "md",
  isActive = false,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean;
  size?: "sm" | "md";
  isActive?: boolean;
}) {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
};

```

`shared/components/ui/skeleton.tsx`:

```tsx
import { cn } from "@/shared/utils/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }
```

`shared/components/ui/slider.tsx`:

```tsx
"use client";

import * as React from "react";
import * as SliderPrimitive from "@radix-ui/react-slider";

import { cn } from "@/shared/utils/utils";

function Slider({
  className,
  defaultValue,
  value,
  min = 0,
  max = 100,
  ...props
}: React.ComponentProps<typeof SliderPrimitive.Root>) {
  const _values = React.useMemo(
    () =>
      Array.isArray(value)
        ? value
        : Array.isArray(defaultValue)
          ? defaultValue
          : [min, max],
    [value, defaultValue, min, max],
  );

  return (
    <SliderPrimitive.Root
      data-slot="slider"
      defaultValue={defaultValue}
      value={value}
      min={min}
      max={max}
      className={cn(
        "relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col",
        className,
      )}
      {...props}
    >
      <SliderPrimitive.Track
        data-slot="slider-track"
        className={cn(
          "bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-4 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5",
        )}
      >
        <SliderPrimitive.Range
          data-slot="slider-range"
          className={cn(
            "bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full",
          )}
        />
      </SliderPrimitive.Track>
      {Array.from({ length: _values.length }, (_, index) => (
        <SliderPrimitive.Thumb
          data-slot="slider-thumb"
          key={index}
          className="border-primary bg-background ring-ring/50 block size-4 shrink-0 rounded-full border shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50"
        />
      ))}
    </SliderPrimitive.Root>
  );
}

export { Slider };

```

`shared/components/ui/sonner.tsx`:

```tsx
"use client";

import { Toaster as Sonner, ToasterProps } from "sonner";

const Toaster = ({ ...props }: ToasterProps) => {
  return (
    <Sonner
      theme="system"
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
          zIndex: 50,
        } as React.CSSProperties
      }
      {...props}
    />
  );
};

export { Toaster };

```

`shared/components/ui/stats/ProgressCard.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Progress } from '@/shared/components/ui/progress';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/shared/components/ui/tooltip';
import { Info } from 'lucide-react';

export interface ProgressCardProps extends React.HTMLAttributes<HTMLDivElement> {
  label: string;
  value: number;
  max: number;
  icon?: React.ReactNode;
  color?: 'default' | 'primary' | 'success' | 'warning' | 'destructive';
  showValue?: boolean;
  showPercentage?: boolean;
  tooltip?: string;
  unit?: string;
  size?: 'sm' | 'md' | 'lg';
}

/**
 * Progress Card Component
 * 
 * Displays a progress bar with label, value, and optional icon.
 * 
 * @example
 * ```tsx
 * <ProgressCard
 *   label="Win Rate"
 *   value={35}
 *   max={50}
 *   icon={<Trophy />}
 *   showPercentage
 *   color="success"
 * />
 * ```
 */
export function ProgressCard({
  label,
  value,
  max,
  icon,
  color = 'default',
  showValue = true,
  showPercentage = false,
  tooltip,
  unit,
  size = 'md',
  className,
  ...props
}: ProgressCardProps) {
  const percentage = max > 0 ? Math.min((value / max) * 100, 100) : 0;

  const colorClasses = {
    default: 'bg-primary',
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    destructive: 'bg-destructive',
  }[color];

  const sizeClasses = {
    sm: 'p-3',
    md: 'p-4',
    lg: 'p-6',
  }[size];

  return (
    <Card className={cn(sizeClasses, className)} {...props}>
      <CardContent className="p-0 space-y-3">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            {icon && (
              <div className="flex items-center justify-center text-muted-foreground">
                {icon}
              </div>
            )}
            <span className="text-sm font-medium text-muted-foreground">
              {label}
            </span>
            {tooltip && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="size-3 text-muted-foreground cursor-help" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{tooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}
          </div>
          {showValue && (
            <span className="text-sm font-semibold">
              {value.toLocaleString()}
              {unit && ` ${unit}`}
              {showPercentage && ` (${percentage.toFixed(0)}%)`}
            </span>
          )}
        </div>

        {/* Progress Bar */}
        <div className="space-y-1">
          <Progress value={percentage} className="h-2" />
          {showPercentage && (
            <div className="flex items-center justify-between text-xs text-muted-foreground">
              <span>0%</span>
              <span>{percentage.toFixed(0)}%</span>
              <span>100%</span>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}


```

`shared/components/ui/stats/StatCard.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Card, CardContent } from '@/shared/components/ui/card';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/shared/components/ui/tooltip';
import { ArrowUp, ArrowDown, Minus, Info } from 'lucide-react';
import { cva, type VariantProps } from 'class-variance-authority';

const statCardVariants = cva('', {
  variants: {
    size: {
      sm: 'p-3',
      md: 'p-4',
      lg: 'p-6',
    },
  },
  defaultVariants: {
    size: 'md',
  },
});

export interface StatCardProps extends React.HTMLAttributes<HTMLDivElement>, VariantProps<typeof statCardVariants> {
  label: string;
  value: string | number;
  icon?: React.ReactNode;
  trend?: {
    value: number;
    label?: string;
    isPositive?: boolean;
  };
  color?: 'default' | 'primary' | 'success' | 'warning' | 'destructive';
  tooltip?: string;
  onClick?: () => void;
}

/**
 * Stat Card Component
 * 
 * Displays a single statistic with icon, label, value, and optional trend indicator.
 * 
 * @example
 * ```tsx
 * <StatCard
 *   label="Games Played"
 *   value={50}
 *   icon={<Activity />}
 *   trend={{ value: 12, isPositive: true, label: "vs last month" }}
 * />
 * ```
 */
export function StatCard({
  label,
  value,
  icon,
  trend,
  color = 'default',
  tooltip,
  onClick,
  size = 'md',
  className,
  ...props
}: StatCardProps) {
  const colorClasses = {
    default: 'text-foreground',
    primary: 'text-primary',
    success: 'text-success',
    warning: 'text-warning',
    destructive: 'text-destructive',
  }[color];

  const getTrendIcon = () => {
    if (!trend) return null;
    if (trend.value > 0) {
      return <ArrowUp className="size-3 text-success" />;
    }
    if (trend.value < 0) {
      return <ArrowDown className="size-3 text-destructive" />;
    }
    return <Minus className="size-3 text-muted-foreground" />;
  };

  const content = (
    <Card
      className={cn(
        statCardVariants({ size }),
        onClick && 'cursor-pointer hover:shadow-medium transition-all duration-200',
        className
      )}
      onClick={onClick}
      {...props}
    >
      <CardContent className="p-0 space-y-2">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            {icon && (
              <div className={cn('flex items-center justify-center', colorClasses)}>
                {icon}
              </div>
            )}
            <span className="text-sm font-medium text-muted-foreground">
              {label}
            </span>
            {tooltip && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Info className="size-3 text-muted-foreground cursor-help" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{tooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}
          </div>
        </div>

        {/* Value */}
        <div className="flex items-baseline gap-2">
          <span className={cn('text-2xl font-bold', colorClasses)}>
            {typeof value === 'number' ? value.toLocaleString() : value}
          </span>
        </div>

        {/* Trend */}
        {trend && (
          <div className="flex items-center gap-1 text-xs">
            {getTrendIcon()}
            <span
              className={cn(
                trend.value > 0
                  ? 'text-success'
                  : trend.value < 0
                  ? 'text-destructive'
                  : 'text-muted-foreground'
              )}
            >
              {Math.abs(trend.value)}%
              {trend.label && ` ${trend.label}`}
            </span>
          </div>
        )}
      </CardContent>
    </Card>
  );

  return content;
}


```

`shared/components/ui/stats/StatGroup.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { StatCard, StatCardProps } from './StatCard';

export interface StatGroupProps extends React.HTMLAttributes<HTMLDivElement> {
  stats: Omit<StatCardProps, 'size'>[];
  columns?: 2 | 3 | 4;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

/**
 * Stat Group Component
 * 
 * Displays multiple stat cards in a grid layout.
 * 
 * @example
 * ```tsx
 * <StatGroup
 *   stats={[
 *     { label: 'Games', value: 50, icon: <Activity /> },
 *     { label: 'Wins', value: 35, icon: <Trophy /> },
 *     { label: 'Rating', value: 4.8, icon: <Star /> },
 *   ]}
 *   columns={3}
 * />
 * ```
 */
export function StatGroup({
  stats,
  columns = 3,
  size = 'md',
  className,
  ...props
}: StatGroupProps) {
  const gridCols = {
    2: 'grid-cols-2',
    3: 'grid-cols-3',
    4: 'grid-cols-4',
  }[columns];

  return (
    <div
      className={cn('grid gap-4', gridCols, className)}
      {...props}
    >
      {stats.map((stat, index) => (
        <StatCard key={index} {...stat} size={size} />
      ))}
    </div>
  );
}


```

`shared/components/ui/switch.tsx`:

```tsx
"use client";

import * as React from "react";
import * as SwitchPrimitive from "@radix-ui/react-switch";

import { cn } from "@/shared/utils/utils";

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-switch-background focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-card dark:data-[state=unchecked]:bg-card-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0",
        )}
      />
    </SwitchPrimitive.Root>
  );
}

export { Switch };

```

`shared/components/ui/table.tsx`:

```tsx
"use client";

import * as React from "react";

import { cn } from "@/shared/utils/utils";

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  );
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  );
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  );
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className,
      )}
      {...props}
    />
  );
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className,
      )}
      {...props}
    />
  );
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className,
      )}
      {...props}
    />
  );
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className,
      )}
      {...props}
    />
  );
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  );
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
};

```

`shared/components/ui/tabs.tsx`:

```tsx
"use client";

import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";

import { cn } from "@/shared/utils/utils";

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  );
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-gradient-to-r from-muted/50 to-muted/80 text-foreground inline-flex h-12 w-fit items-center justify-center rounded-2xl p-1 flex shadow-inner border border-border/50",
        className,
      )}
      {...props}
    />
  );
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-gradient-to-r data-[state=active]:from-primary data-[state=active]:to-primary/90 data-[state=active]:text-primary-foreground data-[state=active]:shadow-lg data-[state=active]:shadow-primary/25 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring text-foreground dark:text-muted-foreground inline-flex h-10 flex-1 items-center justify-center gap-2 rounded-xl border border-transparent px-4 py-2 text-sm font-semibold whitespace-nowrap transition-all duration-200 focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 hover:bg-accent/50 hover:text-accent-foreground data-[state=active]:hover:from-primary/90 data-[state=active]:hover:to-primary/80 active:scale-[0.98] transform",
        className,
      )}
      {...props}
    />
  );
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  );
}

export { Tabs, TabsList, TabsTrigger, TabsContent };

```

`shared/components/ui/textarea.tsx`:

```tsx
import * as React from "react";

import { cn } from "@/shared/utils/utils";

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "resize-none border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-input-background px-3 py-2 text-base transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className,
      )}
      {...props}
    />
  );
}

export { Textarea };

```

`shared/components/ui/theme-toggle.tsx`:

```tsx
import { useThemeStore } from '@/store/themeStore';
import { Button } from '@/shared/components/ui/button';
import { Moon, Sun } from 'lucide-react';
import React from 'react';

export function ThemeToggle({ className }: { className?: string }) {
  const { theme, toggleTheme } = useThemeStore();
  return (
    <Button
      type="button"
      variant="ghost"
      size="icon"
      aria-label={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}
      onClick={toggleTheme}
      className={className}
    >
      {theme === 'dark' ? (
        <Sun className="size-5" />
      ) : (
        <Moon className="size-5" />
      )}
    </Button>
  );
}

```

`shared/components/ui/toggle-group.tsx`:

```tsx
"use client";

import * as React from "react";
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group";
import { type VariantProps } from "class-variance-authority";

import { cn } from "@/shared/utils/utils";
import { toggleVariants } from "./toggle";

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
});

function ToggleGroup({
  className,
  variant,
  size,
  children,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <ToggleGroupPrimitive.Root
      data-slot="toggle-group"
      data-variant={variant}
      data-size={size}
      className={cn(
        "group/toggle-group flex w-fit items-center rounded-md data-[variant=outline]:shadow-xs",
        className,
      )}
      {...props}
    >
      <ToggleGroupContext.Provider value={{ variant, size }}>
        {children}
      </ToggleGroupContext.Provider>
    </ToggleGroupPrimitive.Root>
  );
}

function ToggleGroupItem({
  className,
  children,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Item> &
  VariantProps<typeof toggleVariants>) {
  const context = React.useContext(ToggleGroupContext);

  return (
    <ToggleGroupPrimitive.Item
      data-slot="toggle-group-item"
      data-variant={context.variant || variant}
      data-size={context.size || size}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        "min-w-0 flex-1 shrink-0 rounded-none shadow-none first:rounded-l-md last:rounded-r-md focus:z-10 focus-visible:z-10 data-[variant=outline]:border-l-0 data-[variant=outline]:first:border-l",
        className,
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  );
}

export { ToggleGroup, ToggleGroupItem };

```

`shared/components/ui/toggle.tsx`:

```tsx
"use client";

import * as React from "react";
import * as TogglePrimitive from "@radix-ui/react-toggle";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/shared/utils/utils";

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function Toggle({
  className,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof TogglePrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <TogglePrimitive.Root
      data-slot="toggle"
      className={cn(toggleVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Toggle, toggleVariants };

```

`shared/components/ui/tooltip.tsx`:

```tsx
"use client";

import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";

import { cn } from "@/shared/utils/utils";

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      data-slot="tooltip-provider"
      delayDuration={delayDuration}
      {...props}
    />
  );
}

function Tooltip({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return (
    <TooltipProvider>
      <TooltipPrimitive.Root data-slot="tooltip" {...props} />
    </TooltipProvider>
  );
}

function TooltipTrigger({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />;
}

function TooltipContent({
  className,
  sideOffset = 0,
  children,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",
          className,
        )}
        {...props}
      >
        {children}
        <TooltipPrimitive.Arrow className="bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  );
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };

```

`shared/components/ui/wizard/Wizard.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Button } from '@/shared/components/ui/button';
import { ChevronLeft, ChevronRight } from 'lucide-react';

export interface WizardStep {
  id: string;
  title: string;
  description?: string;
  component: React.ReactNode;
  isValid?: boolean;
  isOptional?: boolean;
}

export interface WizardProps extends React.HTMLAttributes<HTMLDivElement> {
  steps: WizardStep[];
  currentStep: number;
  onStepChange: (step: number) => void;
  onComplete?: () => void;
  onCancel?: () => void;
  showProgress?: boolean;
  showNavigation?: boolean;
  allowSkip?: boolean;
  className?: string;
}

/**
 * Wizard Component
 * 
 * Multi-step form wizard with validation, progress indicator, and navigation.
 * 
 * @example
 * ```tsx
 * <Wizard
 *   steps={steps}
 *   currentStep={currentStep}
 *   onStepChange={setCurrentStep}
 *   onComplete={() => handleSubmit()}
 * />
 * ```
 */
export function Wizard({
  steps,
  currentStep,
  onStepChange,
  onComplete,
  onCancel,
  showProgress = true,
  showNavigation = true,
  allowSkip = false,
  className,
  ...props
}: WizardProps) {
  const currentStepData = steps[currentStep];
  const isFirstStep = currentStep === 0;
  const isLastStep = currentStep === steps.length - 1;
  const progress = ((currentStep + 1) / steps.length) * 100;

  const handleNext = () => {
    if (isLastStep) {
      if (onComplete) {
        onComplete();
      }
    } else {
      onStepChange(currentStep + 1);
    }
  };

  const handlePrevious = () => {
    if (!isFirstStep) {
      onStepChange(currentStep - 1);
    }
  };

  const canProceed = currentStepData?.isValid !== false || currentStepData?.isOptional || allowSkip;

  return (
    <div className={cn('flex flex-col h-full', className)} {...props}>
      {/* Progress Indicator */}
      {showProgress && (
        <div className="mb-6">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-muted-foreground">
              Step {currentStep + 1} of {steps.length}
            </span>
            <span className="text-sm font-medium text-muted-foreground">
              {Math.round(progress)}%
            </span>
          </div>
          <div className="w-full h-2 bg-muted rounded-full overflow-hidden">
            <div
              className="h-full bg-primary transition-all duration-300"
              style={{ width: `${progress}%` }}
            />
          </div>
          <div className="flex items-center justify-between mt-2">
            {steps.map((step, index) => (
              <div
                key={step.id}
                className={cn(
                  'flex flex-col items-center flex-1',
                  index < currentStep && 'text-primary',
                  index === currentStep && 'text-primary font-semibold',
                  index > currentStep && 'text-muted-foreground'
                )}
              >
                <div
                  className={cn(
                    'size-2 rounded-full mb-1 transition-colors',
                    index <= currentStep ? 'bg-primary' : 'bg-muted'
                  )}
                />
                <span className="text-xs text-center truncate w-full">
                  {step.title}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Step Content */}
      <div className="flex-1 overflow-auto">
        {currentStepData?.component}
      </div>

      {/* Navigation */}
      {showNavigation && (
        <div className="flex items-center justify-between mt-6 pt-6 border-t border-border">
          <div>
            {onCancel && (
              <Button
                type="button"
                variant="ghost"
                onClick={onCancel}
              >
                Cancel
              </Button>
            )}
          </div>
          <div className="flex items-center gap-2">
            {!isFirstStep && (
              <Button
                type="button"
                variant="outline"
                onClick={handlePrevious}
              >
                <ChevronLeft className="size-4 mr-1" />
                Previous
              </Button>
            )}
            <Button
              type="button"
              onClick={handleNext}
              disabled={!canProceed}
            >
              {isLastStep ? 'Complete' : 'Next'}
              {!isLastStep && <ChevronRight className="size-4 ml-1" />}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}


```

`shared/components/ui/wizard/WizardProgress.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';
import { Check } from 'lucide-react';

export interface WizardProgressProps extends React.HTMLAttributes<HTMLDivElement> {
  steps: Array<{ id: string; title: string }>;
  currentStep: number;
  completedSteps?: number[];
  variant?: 'dots' | 'bar' | 'steps';
  className?: string;
}

/**
 * Wizard Progress Component
 * 
 * Standalone progress indicator for wizard steps.
 * 
 * @example
 * ```tsx
 * <WizardProgress
 *   steps={steps}
 *   currentStep={2}
 *   completedSteps={[0, 1]}
 *   variant="steps"
 * />
 * ```
 */
export function WizardProgress({
  steps,
  currentStep,
  completedSteps = [],
  variant = 'bar',
  className,
  ...props
}: WizardProgressProps) {
  const progress = ((currentStep + 1) / steps.length) * 100;

  if (variant === 'dots') {
    return (
      <div className={cn('flex items-center justify-center gap-2', className)} {...props}>
        {steps.map((step, index) => (
          <div
            key={step.id}
            className={cn(
              'size-2 rounded-full transition-all',
              index < currentStep || completedSteps.includes(index)
                ? 'bg-primary'
                : index === currentStep
                ? 'bg-primary size-3'
                : 'bg-muted'
            )}
            aria-label={`Step ${index + 1}: ${step.title}`}
          />
        ))}
      </div>
    );
  }

  if (variant === 'steps') {
    return (
      <div className={cn('flex items-center justify-between', className)} {...props}>
        {steps.map((step, index) => {
          const isCompleted = index < currentStep || completedSteps.includes(index);
          const isCurrent = index === currentStep;
          const isUpcoming = index > currentStep;

          return (
            <div key={step.id} className="flex items-center flex-1">
              <div className="flex flex-col items-center flex-1">
                <div
                  className={cn(
                    'size-8 rounded-full flex items-center justify-center border-2 transition-all',
                    isCompleted
                      ? 'bg-primary border-primary text-primary-foreground'
                      : isCurrent
                      ? 'bg-primary border-primary text-primary-foreground ring-4 ring-primary/20'
                      : 'bg-background border-muted text-muted-foreground'
                  )}
                >
                  {isCompleted ? (
                    <Check className="size-4" />
                  ) : (
                    <span className="text-sm font-semibold">{index + 1}</span>
                  )}
                </div>
                <span
                  className={cn(
                    'mt-2 text-xs text-center truncate w-full',
                    isCurrent ? 'font-semibold text-primary' : 'text-muted-foreground'
                  )}
                >
                  {step.title}
                </span>
              </div>
              {index < steps.length - 1 && (
                <div
                  className={cn(
                    'h-0.5 flex-1 mx-2 transition-colors',
                    isCompleted ? 'bg-primary' : 'bg-muted'
                  )}
                />
              )}
            </div>
          );
        })}
      </div>
    );
  }

  // Bar variant (default)
  return (
    <div className={cn('space-y-2', className)} {...props}>
      <div className="flex items-center justify-between text-sm">
        <span className="font-medium text-muted-foreground">
          Step {currentStep + 1} of {steps.length}
        </span>
        <span className="font-medium text-muted-foreground">
          {Math.round(progress)}%
        </span>
      </div>
      <div className="w-full h-2 bg-muted rounded-full overflow-hidden">
        <div
          className="h-full bg-primary transition-all duration-300"
          style={{ width: `${progress}%` }}
        />
      </div>
    </div>
  );
}


```

`shared/components/ui/wizard/WizardStep.tsx`:

```tsx
import * as React from 'react';
import { cn } from '@/shared/utils/utils';

export interface WizardStepProps extends React.HTMLAttributes<HTMLDivElement> {
  title?: string;
  description?: string;
  children: React.ReactNode;
  className?: string;
}

/**
 * Wizard Step Component
 * 
 * Container for individual wizard step content.
 * 
 * @example
 * ```tsx
 * <WizardStep
 *   title="Step 1"
 *   description="Enter your information"
 * >
 *   <FormContent />
 * </WizardStep>
 * ```
 */
export function WizardStep({
  title,
  description,
  children,
  className,
  ...props
}: WizardStepProps) {
  return (
    <div className={cn('space-y-4', className)} {...props}>
      {title && (
        <div className="space-y-2">
          <h2 className="text-2xl font-semibold">{title}</h2>
          {description && (
            <p className="text-muted-foreground">{description}</p>
          )}
        </div>
      )}
      <div>{children}</div>
    </div>
  );
}


```