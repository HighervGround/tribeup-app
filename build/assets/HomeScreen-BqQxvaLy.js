import{j as e}from"./ui-Ca5AhCQM.js";import{r as h}from"./vendor-IUqyc6Bg.js";import{s as y,C as L,a as T,u as I,b as R,B as k,R as C}from"./index-nQGa32TO.js";import{f as M}from"./dateUtils-But3d3jk.js";import{u as W,a as A,b as E}from"./useGames-DMHgc7gm.js";import{S as i}from"./skeleton-Cuu4NrjZ.js";import{P}from"./plus-jm0a8V66.js";import{M as B}from"./map-pin-Bu8GIzJf.js";import{U as $}from"./users-DfXAd2LY.js";import{C as z}from"./clock-BmXmx832.js";function H(){const[s,m]=h.useState([]),[N,l]=h.useState(!0);return h.useEffect(()=>{let x,c;const u=async()=>{try{const{data:{user:r}}=await y.auth.getUser();if(!r)return;await y.from("user_presence").upsert({user_id:r.id,last_seen:new Date().toISOString(),is_online:!0});const n=new Date(Date.now()-5*60*1e3).toISOString(),{data:d,error:f}=await y.from("user_presence").select("user_id, last_seen, is_online").gte("last_seen",n).eq("is_online",!0);if(f){console.error("Error fetching user presence:",f);return}const D=(d||[]).map(j=>({userId:j.user_id,lastSeen:new Date(j.last_seen),isOnline:j.is_online}));m(D),l(!1)}catch(r){console.error("Error updating presence:",r),l(!1)}};return(async()=>{const{data:{user:r}}=await y.auth.getUser();if(!r){l(!1);return}c=y.channel("user-presence",{config:{presence:{key:r.id}}}),c.on("presence",{event:"sync"},()=>{const n=c.presenceState(),d=Object.values(n).flat().map(f=>({userId:f.user_id,lastSeen:new Date,isOnline:!0}));m(d),l(!1)}).on("presence",{event:"join"},({key:n,newPresences:d})=>{console.log("User joined:",n,d)}).on("presence",{event:"leave"},({key:n,leftPresences:d})=>{console.log("User left:",n,d)}).subscribe(async n=>{n==="SUBSCRIBED"&&await c.track({user_id:r.id,online_at:new Date().toISOString()})}),x=setInterval(u,3e4),u()})(),()=>{x&&clearInterval(x),c&&c.unsubscribe()}},[]),{onlineUsers:s,onlineCount:s.length,isLoading:N}}function q(){return e.jsx(L,{className:"w-full",children:e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(i,{className:"h-5 w-3/4"}),e.jsx(i,{className:"h-4 w-1/2"})]}),e.jsx(i,{className:"h-8 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{className:"h-4 w-4"}),e.jsx(i,{className:"h-4 w-2/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{className:"h-4 w-4"}),e.jsx(i,{className:"h-4 w-1/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{className:"h-4 w-4"}),e.jsx(i,{className:"h-4 w-1/4"})]})]}),e.jsx(i,{className:"h-4 w-full"}),e.jsx(i,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx(i,{className:"h-6 w-20"}),e.jsx(i,{className:"h-8 w-16"})]})]})})})}function F({game:s,onSelect:m,onJoinLeave:N,isLoading:l}){const x=v=>{v.stopPropagation(),N(s.id)},c=()=>{m()},u=()=>s.category==="today"?e.jsx("span",{className:"inline-block bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300 text-xs px-2 py-1 rounded-full font-medium",children:"Today"}):s.category==="tomorrow"?e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 text-xs px-2 py-1 rounded-full font-medium",children:"Tomorrow"}):null;return e.jsxs("div",{className:"bg-card rounded-lg p-4 border border-border cursor-pointer hover:shadow-md transition-shadow",onClick:c,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1 pr-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.title}),u()]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.sport})]}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsx("div",{className:"text-sm font-medium",children:s.cost}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.currentPlayers,"/",s.maxPlayers," players"]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{children:s.location})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:[s.currentPlayers,"/",s.maxPlayers," players"]})]}),s.distance&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"ðŸ“"}),e.jsx("span",{children:s.distance})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:[s.date," at ",M(s.time)]})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-3",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[s.isJoined?e.jsx("span",{className:"inline-block bg-success/20 text-success dark:bg-success/30 dark:text-success text-xs px-2 py-1 rounded",children:"Joined âœ“"}):e.jsx("div",{}),e.jsx("button",{onClick:x,disabled:l,className:`px-3 py-1 rounded text-sm font-medium transition-colors ${l?"opacity-50 cursor-not-allowed":s.isJoined?"bg-destructive/20 text-destructive dark:bg-destructive/30 dark:text-destructive hover:bg-destructive/30 dark:hover:bg-destructive/40":"bg-primary text-primary-foreground hover:bg-primary/90"}`,children:l?"...":s.isJoined?"Leave":"Join"})]})]})}function re(){const s=I(),{user:m}=R(),[N,l]=h.useState(!1),[x,c]=h.useState(!1);h.useMemo(()=>m?.preferences?.sports??[],[m]);const{onlineCount:u,isLoading:v}=H(),{data:r=[],isLoading:n,error:d,refetch:f}=W(),D=A(),j=E(),O=t=>{r.find(o=>o.id===t)?.isJoined?j.mutate(t):D.mutate(t)},_=D.isPending||j.isPending,g=h.useMemo(()=>{const t=new Date,a=new Date(t);a.setDate(t.getDate()-t.getDay()),a.setHours(0,0,0,0);const o=new Date(a);o.setDate(a.getDate()+6),o.setHours(23,59,59,999);const b=r.filter(w=>{const p=new Date(w.date);return p>=a&&p<=o}).length;return{totalGames:r.length,thisWeekGames:b,onlinePlayers:u}},[r,u]),S=async()=>{if(!N){c(!1),l(!0);try{await f()}finally{l(!1)}}},U=t=>{s(`/game/${t}`)},G=()=>{s("/create")},J=r.map(t=>{const a=new Date(t.date),o=new Date,b=new Date(o);b.setDate(b.getDate()+1);let w="future",p=a.getTime();return a.toDateString()===o.toDateString()?(w="today",p=0):a.toDateString()===b.toDateString()&&(w="tomorrow",p=1),{...t,category:w,sortOrder:p,gameDate:a}}).sort((t,a)=>t.sortOrder!==a.sortOrder?t.sortOrder-a.sortOrder:t.gameDate.getTime()-a.gameDate.getTime());return n&&r.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading games..."})]})}):x&&r.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Connection issues detected. Showing sample games."}),e.jsxs(k,{onClick:S,variant:"outline",children:[e.jsx(C,{className:"w-4 h-4 mr-2"})," Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"TribeUp"}),e.jsx("p",{className:"text-muted-foreground",children:"Find your next game"})]}),e.jsxs(k,{onClick:G,className:"hidden md:flex",children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Create Game"]}),e.jsx(k,{onClick:G,size:"icon",className:"md:hidden","aria-label":"Create new game",children:e.jsx(P,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6 lg:hidden",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:g.totalGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Active Games"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:v?"...":g.onlinePlayers}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Players Online"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:g.thisWeekGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"This Week"})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Upcoming Games"}),e.jsxs(k,{variant:"outline",size:"sm",onClick:S,disabled:n,className:"hidden md:flex",children:[e.jsx(C,{className:`w-4 h-4 mr-2 ${n?"animate-spin":""}`}),"Refresh"]}),e.jsx(k,{variant:"ghost",size:"sm",onClick:S,disabled:n,className:"md:hidden","aria-label":"Refresh games",children:e.jsx(C,{className:`w-4 h-4 ${n?"animate-spin":""}`})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:n?Array.from({length:6}).map((t,a)=>e.jsx(q,{},a)):J.map(t=>e.jsx("div",{children:e.jsx(F,{game:t,onSelect:()=>U(t.id),onJoinLeave:O,isLoading:_})},t.id))})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-4",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 sticky top-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Quick Stats"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Games"}),e.jsx("span",{className:"font-semibold",children:g.totalGames})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Players Online"}),e.jsx("span",{className:"font-semibold",children:v?"...":g.onlinePlayers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"This Week"}),e.jsx("span",{className:"font-semibold",children:g.thisWeekGames})]})]})]})})]})})})}export{re as HomeScreen};
//# sourceMappingURL=HomeScreen-BqQxvaLy.js.map
