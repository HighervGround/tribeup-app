import{j as e}from"./ui-Ca5AhCQM.js";import{r as m}from"./vendor-IUqyc6Bg.js";import{s as y,u as _,a as G,S as T,B as w,R as D}from"./index-B9--UOQC.js";import{f as U}from"./dateUtils-But3d3jk.js";import{P as C}from"./plus-DvWvh618.js";import{M as E}from"./map-pin-CK2rpkXa.js";import{U as I}from"./users-ybACdZ1W.js";import{C as L}from"./clock-DIhAXd_H.js";function R(){const[s,n]=m.useState([]),[h,r]=m.useState(!0);return m.useEffect(()=>{let l,c;const f=async()=>{try{const{data:{user:d}}=await y.auth.getUser();if(!d)return;await y.from("user_presence").upsert({user_id:d.id,last_seen:new Date().toISOString(),is_online:!0});const a=new Date(Date.now()-5*60*1e3).toISOString(),{data:o,error:x}=await y.from("user_presence").select("user_id, last_seen, is_online").gte("last_seen",a).eq("is_online",!0);if(x){console.error("Error fetching user presence:",x);return}const u=(o||[]).map(g=>({userId:g.user_id,lastSeen:new Date(g.last_seen),isOnline:g.is_online}));n(u),r(!1)}catch(d){console.error("Error updating presence:",d),r(!1)}};return(async()=>{const{data:{user:d}}=await y.auth.getUser();if(!d){r(!1);return}c=y.channel("user-presence",{config:{presence:{key:d.id}}}),c.on("presence",{event:"sync"},()=>{const a=c.presenceState(),o=Object.values(a).flat().map(x=>({userId:x.user_id,lastSeen:new Date,isOnline:!0}));n(o),r(!1)}).on("presence",{event:"join"},({key:a,newPresences:o})=>{console.log("User joined:",a,o)}).on("presence",{event:"leave"},({key:a,leftPresences:o})=>{console.log("User left:",a,o)}).subscribe(async a=>{a==="SUBSCRIBED"&&await c.track({user_id:d.id,online_at:new Date().toISOString()})}),l=setInterval(f,3e4),f()})(),()=>{l&&clearInterval(l),c&&c.unsubscribe()}},[]),{onlineUsers:s,onlineCount:s.length,isLoading:h}}function J({game:s,onSelect:n}){const{joinGame:h,leaveGame:r}=G(),l=N=>{N.stopPropagation(),s.isJoined?r(s.id):h(s.id)},c=()=>{n()},f=()=>s.category==="today"?e.jsx("span",{className:"inline-block bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300 text-xs px-2 py-1 rounded-full font-medium",children:"Today"}):s.category==="tomorrow"?e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 text-xs px-2 py-1 rounded-full font-medium",children:"Tomorrow"}):null;return e.jsxs("div",{className:"bg-card rounded-lg p-4 border border-border cursor-pointer hover:shadow-md transition-shadow",onClick:c,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1 pr-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.title}),f()]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.sport})]}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsx("div",{className:"text-sm font-medium",children:s.cost}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.currentPlayers,"/",s.maxPlayers," players"]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{children:s.location})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:[s.currentPlayers,"/",s.maxPlayers," players"]})]}),s.distance&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"ðŸ“"}),e.jsx("span",{children:s.distance})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:[s.date," at ",U(s.time)]})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-3",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[s.isJoined?e.jsx("span",{className:"inline-block bg-success/20 text-success dark:bg-success/30 dark:text-success text-xs px-2 py-1 rounded",children:"Joined âœ“"}):e.jsx("div",{}),e.jsx("button",{onClick:l,className:`px-3 py-1 rounded text-sm font-medium transition-colors ${s.isJoined?"bg-destructive/20 text-destructive dark:bg-destructive/30 dark:text-destructive hover:bg-destructive/30 dark:hover:bg-destructive/40":"bg-primary text-primary-foreground hover:bg-primary/90"}`,children:s.isJoined?"Leave":"Join"})]})]})}function F(){const s=_(),{games:n,setGames:h,isLoading:r,setLoading:l,user:c}=G(),[f,N]=m.useState(!1),[d,a]=m.useState(!1);m.useMemo(()=>c?.preferences?.sports??[],[c]);const{onlineCount:o,isLoading:x}=R(),u=m.useMemo(()=>{const t=new Date,i=new Date(t);i.setDate(t.getDate()-t.getDay()),i.setHours(0,0,0,0);const p=new Date(i);p.setDate(i.getDate()+6),p.setHours(23,59,59,999);const v=n.filter(b=>{const j=new Date(b.date);return j>=i&&j<=p}).length;return{totalGames:n.length,thisWeekGames:v,onlinePlayers:o}},[n,o]);m.useEffect(()=>{n.length===0&&!r&&g()},[]),m.useEffect(()=>{if(r&&n.length===0){const t=setTimeout(()=>{console.warn("Loading timeout - clearing loading state"),l(!1),a(!0)},1e4);return()=>clearTimeout(t)}},[r,n.length,l]),m.useEffect(()=>()=>{l(!1)},[l]);const g=async()=>{if(r){console.log("Already loading games, skipping duplicate call");return}a(!1),l(!0);try{const t=await T.getGames();h(t)}catch(t){console.error("Error loading games:",t),a(!0),h([])}finally{l(!1)}},k=async()=>{if(!f){a(!1),N(!0);try{await g()}finally{N(!1)}}},O=t=>{s(`/game/${t}`)},S=()=>{s("/create")},P=n.map(t=>{const i=new Date(t.date),p=new Date,v=new Date(p);v.setDate(v.getDate()+1);let b="future",j=i.getTime();return i.toDateString()===p.toDateString()?(b="today",j=0):i.toDateString()===v.toDateString()&&(b="tomorrow",j=1),{...t,category:b,sortOrder:j,gameDate:i}}).sort((t,i)=>t.sortOrder!==i.sortOrder?t.sortOrder-i.sortOrder:t.gameDate.getTime()-i.gameDate.getTime());return r&&n.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading games..."})]})}):d&&n.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Connection issues detected. Showing sample games."}),e.jsxs(w,{onClick:k,variant:"outline",children:[e.jsx(D,{className:"w-4 h-4 mr-2"})," Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"TribeUp"}),e.jsx("p",{className:"text-muted-foreground",children:"Find your next game"})]}),e.jsxs(w,{onClick:S,className:"hidden md:flex",children:[e.jsx(C,{className:"w-4 h-4 mr-2"}),"Create Game"]}),e.jsx(w,{onClick:S,size:"icon",className:"md:hidden","aria-label":"Create new game",children:e.jsx(C,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6 lg:hidden",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:u.totalGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Active Games"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:x?"...":u.onlinePlayers}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Players Online"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:u.thisWeekGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"This Week"})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Upcoming Games"}),e.jsxs(w,{variant:"outline",size:"sm",onClick:k,disabled:r,className:"hidden md:flex",children:[e.jsx(D,{className:`w-4 h-4 mr-2 ${r?"animate-spin":""}`}),"Refresh"]}),e.jsx(w,{variant:"ghost",size:"sm",onClick:k,disabled:r,className:"md:hidden","aria-label":"Refresh games",children:e.jsx(D,{className:`w-4 h-4 ${r?"animate-spin":""}`})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:P.map(t=>e.jsx("div",{children:e.jsx(J,{game:t,onSelect:()=>O(t.id)})},t.id))})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-4",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 sticky top-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Quick Stats"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Games"}),e.jsx("span",{className:"font-semibold",children:u.totalGames})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Players Online"}),e.jsx("span",{className:"font-semibold",children:x?"...":u.onlinePlayers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"This Week"}),e.jsx("span",{className:"font-semibold",children:u.thisWeekGames})]})]})]})})]})})})}export{F as HomeScreen};
//# sourceMappingURL=HomeScreen-CKLn9ljY.js.map
