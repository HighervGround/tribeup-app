{"version":3,"file":"useAchievements-Bf6AnO3N.js","sources":["../../src/hooks/useAchievements.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { toast } from 'sonner';\nimport { SupabaseService } from '../lib/supabaseService';\nimport { useAppStore } from '../store/appStore';\n\ninterface Achievement {\n  id: string;\n  name: string;\n  description: string;\n  icon: string;\n  category: string;\n  criteria: any;\n  points: number;\n  is_active: boolean;\n  created_at: string;\n}\n\ninterface UserAchievement {\n  id: string;\n  user_id: string;\n  achievement_id: string;\n  earned_at: string;\n  progress?: any;\n  achievement: Achievement;\n}\n\ninterface UserStats {\n  user_id: string;\n  games_played: number;\n  games_hosted: number;\n  total_play_time_minutes: number;\n  favorite_sport?: string;\n  last_activity: string;\n}\n\nexport function useAchievements() {\n  const { user } = useAppStore();\n  const [achievements, setAchievements] = useState<UserAchievement[]>([]);\n  const [userStats, setUserStats] = useState<UserStats | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Load user achievements and stats\n  useEffect(() => {\n    if (!user?.id) return;\n\n    const loadAchievements = async () => {\n      try {\n        setIsLoading(true);\n        const [achievementsData, statsData] = await Promise.all([\n          SupabaseService.getUserAchievements(user.id),\n          SupabaseService.getUserStats(user.id)\n        ]);\n        \n        setAchievements(achievementsData);\n        setUserStats(statsData);\n      } catch (error) {\n        console.error('Failed to load achievements:', error);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    loadAchievements();\n  }, [user?.id]);\n\n  // Check for new achievements after game participation\n  const checkForNewAchievements = async () => {\n    if (!user?.id) return;\n\n    try {\n      const newAchievements = await SupabaseService.checkAndAwardAchievements(user.id);\n      \n      if (newAchievements.length > 0) {\n        // Show achievement toast notifications\n        newAchievements.forEach((achievement: Achievement) => {\n          showAchievementToast(achievement);\n        });\n\n        // Refresh achievements list\n        const updatedAchievements = await SupabaseService.getUserAchievements(user.id);\n        setAchievements(updatedAchievements);\n      }\n    } catch (error) {\n      console.error('Failed to check achievements:', error);\n    }\n  };\n\n  // Show achievement toast notification\n  const showAchievementToast = (achievement: Achievement) => {\n    toast.success(\n      `ðŸŽ‰ Achievement Unlocked!`,\n      {\n        description: `${achievement.icon} ${achievement.name} - ${achievement.description} (+${achievement.points} points)`,\n        duration: 6000,\n        action: {\n          label: 'View All',\n          onClick: () => {\n            // Navigate to achievements page\n            window.location.href = '/profile?tab=achievements';\n          }\n        }\n      }\n    );\n  };\n\n  // Calculate achievement progress based on criteria\n  const getAchievementProgress = (achievement: Achievement, stats: UserStats) => {\n    const criteria = typeof achievement.criteria === 'string' \n      ? JSON.parse(achievement.criteria) \n      : achievement.criteria;\n    \n    let progress = 0;\n    let total = 1;\n\n    switch (criteria.type) {\n      case 'game_count':\n        total = criteria.count;\n        progress = Math.min(stats.games_played, total);\n        break;\n      case 'host_count':\n        total = criteria.count;\n        progress = Math.min(stats.games_hosted, total);\n        break;\n      case 'play_time_minutes':\n        total = criteria.count;\n        progress = Math.min(stats.total_play_time_minutes, total);\n        break;\n      case 'first_login':\n        // First login is binary - either achieved or not\n        total = 1;\n        progress = stats.last_activity ? 1 : 0;\n        break;\n      default:\n        total = 1;\n        progress = 0;\n    }\n\n    return { progress, total, percentage: Math.round((progress / total) * 100) };\n  };\n\n  // Calculate total achievement score\n  const getTotalScore = () => {\n    return achievements.reduce((total, userAchievement) => {\n      // Handle both nested and flat achievement structures\n      const achievement = userAchievement.achievement || userAchievement;\n      return total + (achievement?.points || 0);\n    }, 0);\n  };\n\n  // Get achievement rank based on total score\n  const getAchievementRank = (score: number) => {\n    if (score >= 200) return { title: 'Legend', icon: 'ðŸ‘‘', color: 'text-yellow-600', level: 6 };\n    if (score >= 150) return { title: 'Champion', icon: 'ðŸ†', color: 'text-purple-600', level: 5 };\n    if (score >= 100) return { title: 'Expert', icon: 'â­', color: 'text-blue-600', level: 4 };\n    if (score >= 50) return { title: 'Rising Star', icon: 'ðŸŒŸ', color: 'text-green-600', level: 3 };\n    if (score >= 25) return { title: 'Rookie', icon: 'ðŸŽ¯', color: 'text-orange-600', level: 2 };\n    return { title: 'Beginner', icon: 'ðŸ”°', color: 'text-gray-600', level: 1 };\n  };\n\n  // Get next achievements to unlock\n  const getNextAchievements = async () => {\n    if (!user?.id || !userStats) return [];\n\n    try {\n      const allAchievements = await SupabaseService.getAllAchievements();\n      const earnedIds = new Set(achievements.map(ua => ua.achievement_id));\n      \n      return allAchievements\n        .filter(achievement => !earnedIds.has(achievement.id) && achievement.is_active)\n        .map(achievement => ({\n          ...achievement,\n          progress: getAchievementProgress(achievement, userStats)\n        }))\n        .sort((a, b) => b.progress.percentage - a.progress.percentage)\n        .slice(0, 3); // Show top 3 closest achievements\n    } catch (error) {\n      console.error('Failed to get next achievements:', error);\n      return [];\n    }\n  };\n\n  const totalScore = getTotalScore();\n  const currentRank = getAchievementRank(totalScore);\n\n  return {\n    achievements,\n    userStats,\n    isLoading,\n    totalScore,\n    currentRank,\n    checkForNewAchievements,\n    showAchievementToast,\n    getAchievementProgress,\n    getAchievementRank,\n    getNextAchievements\n  };\n}\n"],"names":["useAchievements","user","useAppStore","achievements","setAchievements","useState","userStats","setUserStats","isLoading","setIsLoading","useEffect","id","async","achievementsData","statsData","Promise","all","SupabaseService","getUserAchievements","getUserStats","error","loadAchievements","showAchievementToast","achievement","toast","success","description","icon","name","points","duration","action","label","onClick","window","location","href","getAchievementProgress","stats","criteria","JSON","parse","progress","total","type","count","Math","min","games_played","games_hosted","total_play_time_minutes","last_activity","percentage","round","getAchievementRank","score","title","color","level","totalScore","reduce","userAchievement","currentRank","checkForNewAchievements","newAchievements","checkAndAwardAchievements","length","forEach","updatedAchievements","getNextAchievements","allAchievements","getAllAchievements","earnedIds","Set","map","ua","achievement_id","filter","has","is_active","sort","a","b","slice"],"mappings":"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"}