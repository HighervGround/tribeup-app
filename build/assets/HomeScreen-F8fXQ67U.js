import{j as e}from"./ui-UCUxpkFH.js";import{r as o}from"./vendor-IUqyc6Bg.js";import{s as v,C as G,a as U,u as P,b as I,B as w,R as k}from"./index-B8K4da9u.js";import{u as R}from"./useGameJoinToggle-DsFmobOk.js";import{U as T}from"./UnifiedGameCard-q4Aqr1og.js";import{S as r}from"./skeleton-DE2be-gs.js";import{P as O}from"./plus-2pcn-DLI.js";import"./useQuery-CBrP0Umh.js";import"./badge-B1q9YN5V.js";import"./ImageWithFallback-DJcWHpkb.js";import"./dateUtils-But3d3jk.js";import"./calendar-ppjY-GzZ.js";import"./map-pin-Dx_7aI26.js";import"./users-CQpKKj-M.js";function W(){const[h,f]=o.useState([]),[b,d]=o.useState(!0);return o.useEffect(()=>{let g,l;const j=async()=>{try{const{data:{user:n}}=await v.auth.getUser();if(!n)return;await v.from("user_presence").upsert({user_id:n.id,last_seen:new Date().toISOString(),is_online:!0});const t=new Date(Date.now()-5*60*1e3).toISOString(),{data:c,error:m}=await v.from("user_presence").select("user_id, last_seen, is_online").gte("last_seen",t).eq("is_online",!0);if(m){console.error("Error fetching user presence:",m);return}const D=(c||[]).map(i=>({userId:i.user_id,lastSeen:new Date(i.last_seen),isOnline:i.is_online}));f(D),d(!1)}catch(n){console.error("Error updating presence:",n),d(!1)}};return(async()=>{const{data:{user:n}}=await v.auth.getUser();if(!n){d(!1);return}l=v.channel("user-presence",{config:{presence:{key:n.id}}}),l.on("presence",{event:"sync"},()=>{const t=l.presenceState(),c=Object.values(t).flat().map(m=>({userId:m.user_id,lastSeen:new Date,isOnline:!0}));f(c),d(!1)}).on("presence",{event:"join"},({key:t,newPresences:c})=>{console.log("User joined:",t,c)}).on("presence",{event:"leave"},({key:t,leftPresences:c})=>{console.log("User left:",t,c)}).subscribe(async t=>{t==="SUBSCRIBED"&&await l.track({user_id:n.id,online_at:new Date().toISOString()})}),g=setInterval(j,3e4),j()})(),()=>{g&&clearInterval(g),l&&l.unsubscribe()}},[]),{onlineUsers:h,onlineCount:h.length,isLoading:b}}function A(){return e.jsx(G,{className:"w-full",children:e.jsx(U,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(r,{className:"h-5 w-3/4"}),e.jsx(r,{className:"h-4 w-1/2"})]}),e.jsx(r,{className:"h-8 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4"}),e.jsx(r,{className:"h-4 w-2/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4"}),e.jsx(r,{className:"h-4 w-1/3"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4"}),e.jsx(r,{className:"h-4 w-1/4"})]})]}),e.jsx(r,{className:"h-4 w-full"}),e.jsx(r,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx(r,{className:"h-6 w-20"}),e.jsx(r,{className:"h-8 w-16"})]})]})})})}function Y(){const h=P(),{user:f}=I(),[b,d]=o.useState(!1),[g,l]=o.useState(!1);o.useMemo(()=>f?.preferences?.sports??[],[f]);const{onlineCount:j,isLoading:y}=W(),{data:n=[],isLoading:t,error:c,refetch:m}=R(),D=s=>{h(`/game/${s}`)},i=o.useMemo(()=>{const s=new Date,a=new Date(s);a.setDate(s.getDate()-s.getDay()),a.setHours(0,0,0,0);const x=new Date(a);x.setDate(a.getDate()+6),x.setHours(23,59,59,999);const p=n.filter(N=>{const u=new Date(N.date);return u>=a&&u<=x}).length;return{totalGames:n.length,thisWeekGames:p,onlinePlayers:j}},[n,j]),S=async()=>{if(!b){l(!1),d(!0);try{await m()}finally{d(!1)}}},C=()=>{h("/create")},_=n.map(s=>{const a=new Date(s.date),x=new Date,p=new Date(x);p.setDate(p.getDate()+1);let N="future",u=a.getTime();return a.toDateString()===x.toDateString()?(N="today",u=0):a.toDateString()===p.toDateString()&&(N="tomorrow",u=1),{...s,category:N,sortOrder:u,gameDate:a}}).sort((s,a)=>s.sortOrder!==a.sortOrder?s.sortOrder-a.sortOrder:s.gameDate.getTime()-a.gameDate.getTime());return t&&n.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading games..."})]})}):g&&n.length===0?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Connection issues detected. Showing sample games."}),e.jsxs(w,{onClick:S,variant:"outline",children:[e.jsx(k,{className:"w-4 h-4 mr-2"})," Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"TribeUp"}),e.jsx("p",{className:"text-muted-foreground",children:"Find your next game"})]}),e.jsxs(w,{onClick:C,className:"hidden md:flex",children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"Create Game"]}),e.jsx(w,{onClick:C,size:"icon",className:"md:hidden","aria-label":"Create new game",children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6 lg:hidden",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:i.totalGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Active Games"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:y?"...":i.onlinePlayers}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Players Online"})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:i.thisWeekGames}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"This Week"})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Upcoming Games"}),e.jsxs(w,{variant:"outline",size:"sm",onClick:S,disabled:t,className:"hidden md:flex",children:[e.jsx(k,{className:`w-4 h-4 mr-2 ${t?"animate-spin":""}`}),"Refresh"]}),e.jsx(w,{variant:"ghost",size:"sm",onClick:S,disabled:t,className:"md:hidden","aria-label":"Refresh games",children:e.jsx(k,{className:`w-4 h-4 ${t?"animate-spin":""}`})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t?Array.from({length:6}).map((s,a)=>e.jsx(A,{},a)):_.map(s=>e.jsx("div",{children:e.jsx(T,{game:s,variant:"simple",onSelect:()=>D(s.id)})},s.id))})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-4",children:e.jsxs("div",{className:"bg-card rounded-lg p-6 sticky top-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Quick Stats"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Active Games"}),e.jsx("span",{className:"font-semibold",children:i.totalGames})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Players Online"}),e.jsx("span",{className:"font-semibold",children:y?"...":i.onlinePlayers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"This Week"}),e.jsx("span",{className:"font-semibold",children:i.thisWeekGames})]})]})]})})]})})})}export{Y as default};
//# sourceMappingURL=HomeScreen-F8fXQ67U.js.map
